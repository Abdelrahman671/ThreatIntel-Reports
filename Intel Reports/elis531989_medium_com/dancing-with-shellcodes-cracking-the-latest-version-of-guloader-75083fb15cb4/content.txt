<!doctype html><html lang="en"><head><title data-rh="true">Dancing With Shellcodes: Cracking the latest version of Guloader | by Eli Salem | Medium</title><meta data-rh="true" charset="utf-8"/><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"/><meta data-rh="true" name="theme-color" content="#000000"/><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"/><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"/><meta data-rh="true" property="al:ios:app_name" content="Medium"/><meta data-rh="true" property="al:ios:app_store_id" content="828256236"/><meta data-rh="true" property="al:android:package" content="com.medium.reader"/><meta data-rh="true" property="fb:app_id" content="542599432471018"/><meta data-rh="true" property="og:site_name" content="Medium"/><meta data-rh="true" property="og:type" content="article"/><meta data-rh="true" property="article:published_time" content="2021-04-19T08:27:46.240Z"/><meta data-rh="true" name="title" content="Dancing With Shellcodes: Cracking the latest version of Guloader | by Eli Salem | Medium"/><meta data-rh="true" property="og:title" content="Dancing With Shellcodes: Cracking the latest version of Guloader"/><meta data-rh="true" property="al:android:url" content="medium://p/75083fb15cb4"/><meta data-rh="true" property="al:ios:url" content="medium://p/75083fb15cb4"/><meta data-rh="true" property="al:android:app_name" content="Medium"/><meta data-rh="true" name="description" content="Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire, FormBook, Nanocore, and Parallax RAT. The malware architecture…"/><meta data-rh="true" property="og:description" content="Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire…"/><meta data-rh="true" property="og:url" content="https://elis531989.medium.com/dancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4"/><meta data-rh="true" property="al:web:url" content="https://elis531989.medium.com/dancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4"/><meta data-rh="true" property="og:image" content="https://miro.medium.com/v2/resize:fit:574/1*AGnUYCr0wHlKClBD5EpK-g.png"/><meta data-rh="true" property="article:author" content="https://elis531989.medium.com"/><meta data-rh="true" name="author" content="Eli Salem"/><meta data-rh="true" name="robots" content="index,noarchive,follow,max-image-preview:large"/><meta data-rh="true" name="referrer" content="unsafe-url"/><meta data-rh="true" property="twitter:title" content="Dancing With Shellcodes: Cracking the latest version of Guloader"/><meta data-rh="true" name="twitter:site" content="@Medium"/><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/75083fb15cb4"/><meta data-rh="true" property="twitter:description" content="Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire…"/><meta data-rh="true" name="twitter:image:src" content="https://miro.medium.com/v2/resize:fit:574/1*AGnUYCr0wHlKClBD5EpK-g.png"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta data-rh="true" name="twitter:creator" content="@elisalem9"/><meta data-rh="true" name="twitter:label1" content="Reading time"/><meta data-rh="true" name="twitter:data1" content="14 min read"/><link data-rh="true" rel="icon" href="https://miro.medium.com/v2/5d8de952517e8160e40ef9841c781cdc14a5db313057fa3c3de41c6f5b494b19"/><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml"/><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="https://miro.medium.com/v2/resize:fill:304:304/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="https://miro.medium.com/v2/resize:fill:240:240/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="https://miro.medium.com/v2/resize:fill:152:152/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="https://miro.medium.com/v2/resize:fill:120:120/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="mask-icon" href="https://miro.medium.com/v2/resize:fill:1000:1000/7*GAOKVe--MXbEJmV9230oOQ.png" color="#171717"/><link data-rh="true" rel="preconnect" href="https://glyph.medium.com" crossOrigin=""/><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" rel="author" href="https://elis531989.medium.com"/><link data-rh="true" rel="canonical" href="https://elis531989.medium.com/dancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4"/><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/75083fb15cb4"/><script data-rh="true" type="application/ld+json">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:1200\u002F1*AGnUYCr0wHlKClBD5EpK-g.png"],"url":"https:\u002F\u002Felis531989.medium.com\u002Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4","dateCreated":"2021-04-19T08:27:46.240Z","datePublished":"2021-04-19T08:27:46.240Z","dateModified":"2022-01-07T00:38:42.598Z","headline":"Dancing With Shellcodes: Cracking the latest version of Guloader","name":"Dancing With Shellcodes: Cracking the latest version of Guloader","description":"Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire, FormBook, Nanocore, and Parallax RAT. The malware architecture…","identifier":"75083fb15cb4","author":{"@type":"Person","name":"Eli Salem","url":"https:\u002F\u002Felis531989.medium.com"},"creator":["Eli Salem"],"publisher":{"@type":"Organization","name":"Medium","url":"https:\u002F\u002Felis531989.medium.com\u002F","logo":{"@type":"ImageObject","width":272,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:544\u002F7*V1_7XP4snlmqrc_0Njontw.png"}},"mainEntityOfPage":"https:\u002F\u002Felis531989.medium.com\u002Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4"}</script><style type="text/css" data-fela-rehydration="542" data-fela-type="STATIC">html{box-sizing:border-box;-webkit-text-size-adjust:100%}*, *:before, *:after{box-sizing:inherit}body{margin:0;padding:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);position:relative;min-height:100vh}h1, h2, h3, h4, h5, h6, dl, dd, ol, ul, menu, figure, blockquote, p, pre, form{margin:0}menu, ol, ul{padding:0;list-style:none;list-style-image:none}main{display:block}a{color:inherit;text-decoration:none}a, button, input{-webkit-tap-highlight-color:transparent}img, svg{vertical-align:middle}button{background:transparent;overflow:visible}button, input, optgroup, select, textarea{margin:0}:root{--reach-tabs:1;--reach-menu-button:1}#speechify-root{font-family:Sohne, sans-serif}div[data-popper-reference-hidden="true"]{visibility:hidden;pointer-events:none}.grecaptcha-badge{visibility:hidden}
/*XCode style (c) Angel Garcia <angelgarcia.mail@gmail.com>*/.hljs {background: #fff;color: black;
}/* Gray DOCTYPE selectors like WebKit */
.xml .hljs-meta {color: #c0c0c0;
}.hljs-comment,
.hljs-quote {color: #007400;
}.hljs-tag,
.hljs-attribute,
.hljs-keyword,
.hljs-selector-tag,
.hljs-literal,
.hljs-name {color: #aa0d91;
}.hljs-variable,
.hljs-template-variable {color: #3F6E74;
}.hljs-code,
.hljs-string,
.hljs-meta .hljs-string {color: #c41a16;
}.hljs-regexp,
.hljs-link {color: #0E0EFF;
}.hljs-title,
.hljs-symbol,
.hljs-bullet,
.hljs-number {color: #1c00cf;
}.hljs-section,
.hljs-meta {color: #643820;
}.hljs-title.class_,
.hljs-class .hljs-title,
.hljs-type,
.hljs-built_in,
.hljs-params {color: #5c2699;
}.hljs-attr {color: #836C28;
}.hljs-subst {color: #000;
}.hljs-formula {background-color: #eee;font-style: italic;
}.hljs-addition {background-color: #baeeba;
}.hljs-deletion {background-color: #ffc8bd;
}.hljs-selector-id,
.hljs-selector-class {color: #9b703f;
}.hljs-doctag,
.hljs-strong {font-weight: bold;
}.hljs-emphasis {font-style: italic;
}
</style><style type="text/css" data-fela-rehydration="542" data-fela-type="KEYFRAME">@-webkit-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@-moz-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE">.a{font-family:medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif}.b{font-weight:400}.c{background-color:rgba(255, 255, 255, 1)}.l{display:block}.m{position:sticky}.n{top:0}.o{z-index:500}.p{padding:0 24px}.q{align-items:center}.r{border-bottom:solid 1px #F2F2F2}.y{height:41px}.z{line-height:20px}.ab{display:flex}.ac{height:57px}.ae{flex:1 0 auto}.af{color:inherit}.ag{fill:inherit}.ah{font-size:inherit}.ai{border:inherit}.aj{font-family:inherit}.ak{letter-spacing:inherit}.al{font-weight:inherit}.am{padding:0}.an{margin:0}.ao{cursor:pointer}.ap:disabled{cursor:not-allowed}.aq:disabled{color:#6B6B6B}.ar:disabled{fill:#6B6B6B}.au{width:auto}.av path{fill:#242424}.aw{height:25px}.ax{margin-left:16px}.ay{border:none}.az{border-radius:20px}.ba{width:240px}.bb{background:#F9F9F9}.bc path{fill:#6B6B6B}.be{outline:none}.bf{font-family:sohne, "Helvetica Neue", Helvetica, Arial, sans-serif}.bg{font-size:14px}.bh{width:100%}.bi{padding:10px 20px 10px 0}.bj{background-color:transparent}.bk{color:#242424}.bl::placeholder{color:#6B6B6B}.bm{display:inline-block}.bn{margin-left:12px}.bo{margin-right:12px}.bp{border-radius:4px}.bq{margin-left:24px}.br{height:24px}.bx{background-color:#F9F9F9}.by{border-radius:50%}.bz{height:32px}.ca{width:32px}.cb{justify-content:center}.ch{max-width:680px}.ci{min-width:0}.cj{animation:k1 1.2s ease-in-out infinite}.ck{height:100vh}.cl{margin-bottom:16px}.cm{margin-top:48px}.cn{align-items:flex-start}.co{flex-direction:column}.cp{justify-content:space-between}.cq{margin-bottom:24px}.cw{width:80%}.cx{background-color:#F2F2F2}.dd{height:44px}.de{width:44px}.df{margin:auto 0}.dg{margin-bottom:4px}.dh{height:16px}.di{width:120px}.dj{width:80px}.dp{margin-bottom:8px}.dq{width:96%}.dr{width:98%}.ds{width:81%}.dt{margin-left:8px}.du{color:#6B6B6B}.dv{font-size:13px}.dw{height:100%}.ep{color:#FFFFFF}.eq{fill:#FFFFFF}.er{background:#1A8917}.es{border-color:#1A8917}.ew:disabled{cursor:inherit !important}.ex:disabled{opacity:0.3}.ey:disabled:hover{background:#1A8917}.ez:disabled:hover{border-color:#1A8917}.fa{border-radius:99em}.fb{border-width:1px}.fc{border-style:solid}.fd{box-sizing:border-box}.fe{text-decoration:none}.ff{text-align:center}.fi{margin-right:32px}.fj{position:relative}.fk{fill:#6B6B6B}.fn{background:transparent}.fo svg{margin-left:4px}.fp svg{fill:#6B6B6B}.fr{box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.05)}.fs{position:absolute}.fz{margin:0 24px}.gd{background:rgba(255, 255, 255, 1)}.ge{border:1px solid #F2F2F2}.gf{box-shadow:0 1px 4px #F2F2F2}.gg{max-height:100vh}.gh{overflow-y:auto}.gi{left:0}.gj{top:calc(100vh + 100px)}.gk{bottom:calc(100vh + 100px)}.gl{width:10px}.gm{pointer-events:none}.gn{word-break:break-word}.go{word-wrap:break-word}.gp:after{display:block}.gq:after{content:""}.gr:after{clear:both}.gs{line-height:1.23}.gt{letter-spacing:0}.gu{font-style:normal}.gv{font-weight:700}.ia{align-items:baseline}.ib{width:48px}.ic{height:48px}.id{border:2px solid rgba(255, 255, 255, 1)}.ie{z-index:0}.if{box-shadow:none}.ig{border:1px solid rgba(0, 0, 0, 0.05)}.ih{margin-bottom:2px}.ii{flex-wrap:nowrap}.ij{font-size:16px}.ik{line-height:24px}.im{margin:0 8px}.in{display:inline}.io{color:#1A8917}.ip{fill:#1A8917}.is{flex:0 0 auto}.iv{flex-wrap:wrap}.iw{padding-left:8px}.ix{padding-right:8px}.jy> *{flex-shrink:0}.jz{overflow-x:scroll}.ka::-webkit-scrollbar{display:none}.kb{scrollbar-width:none}.kc{-ms-overflow-style:none}.kd{width:74px}.ke{flex-direction:row}.kf{z-index:2}.kg{margin-right:4px}.kj{-webkit-user-select:none}.kk{border:0}.kl{fill:rgba(117, 117, 117, 1)}.ko{outline:0}.kp{user-select:none}.kq> svg{pointer-events:none}.kz{cursor:progress}.la{opacity:1}.lb{padding:4px 0}.le{margin-top:0px}.lf{width:16px}.lh{display:inline-flex}.ln{max-width:100%}.lo{padding:8px 2px}.lp svg{color:#6B6B6B}.mg{margin-left:auto}.mh{margin-right:auto}.mi{max-width:574px}.mo{clear:both}.mp{height:auto}.mq{line-height:1.58}.mr{letter-spacing:-0.004em}.ms{font-family:source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif}.nn{margin-bottom:-0.46em}.no{line-height:1.12}.np{letter-spacing:-0.022em}.nq{font-weight:600}.ol{margin-bottom:-0.28em}.or{max-width:1121px}.oy{cursor:zoom-in}.oz{z-index:auto}.pb{margin-top:10px}.pc{max-width:728px}.pf{max-width:689px}.pg{max-width:429px}.ph{max-width:580px}.pi{max-width:621px}.pj{max-width:499px}.pk{max-width:548px}.pl{line-height:1.18}.pz{margin-bottom:-0.31em}.qa{max-width:521px}.qb{font-style:italic}.qc{max-width:801px}.qd{max-width:434px}.qe{max-width:455px}.qf{max-width:408px}.qg{max-width:420px}.qh{max-width:450px}.qi{max-width:821px}.qj{max-width:544px}.qk{max-width:938px}.ql{max-width:487px}.qm{max-width:1007px}.qn{max-width:565px}.qo{max-width:601px}.qp{max-width:395px}.qq{max-width:418px}.qr{max-width:634px}.qs{max-width:564px}.qt{max-width:1018px}.qu{font-style:inherit}.qv{max-width:886px}.qw{max-width:566px}.qx{max-width:459px}.qy{text-decoration:underline}.qz{max-width:835px}.ra{max-width:798px}.rb{max-width:786px}.rc{max-width:893px}.rd{max-width:940px}.re{max-width:549px}.rf{max-width:758px}.rg{max-width:876px}.rh{max-width:231px}.ri{max-width:608px}.rj{max-width:804px}.rk{max-width:982px}.rl{max-width:920px}.rm{max-width:820px}.rn{margin-bottom:26px}.ro{margin-top:6px}.rp{margin-top:8px}.rq{margin-right:8px}.rr{padding:8px 16px}.rs{border-radius:100px}.rt{transition:background 300ms ease}.rv{white-space:nowrap}.rw{border-top:none}.sc{height:52px}.sd{max-height:52px}.se{box-sizing:content-box}.sf{position:static}.sg{z-index:1}.si{max-width:155px}.so{margin-right:20px}.su{align-items:flex-end}.sv{width:76px}.sw{height:76px}.sx{border:2px solid #F9F9F9}.sy{height:72px}.sz{width:72px}.ta{stroke:#F2F2F2}.tb{height:36px}.tc{width:36px}.td{color:#F2F2F2}.te{fill:#F2F2F2}.tf{background:#F2F2F2}.tg{border-color:#F2F2F2}.tm{font-weight:500}.tn{font-size:24px}.to{line-height:30px}.tp{letter-spacing:-0.016em}.tq{margin-top:16px}.tr{height:0px}.ts{border-bottom:solid 1px #E5E5E5}.tt{margin-top:72px}.tu{padding:24px 0}.tv{margin-bottom:0px}.tw{margin-right:16px}.as:hover:not(:disabled){color:rgba(25, 25, 25, 1)}.at:hover:not(:disabled){fill:rgba(25, 25, 25, 1)}.et:hover{background:#156D12}.eu:hover{border-color:#156D12}.ev:hover{cursor:pointer}.fl:hover{color:#242424}.fm:hover{fill:#242424}.fq:hover svg{fill:#242424}.ft:hover{background-color:rgba(0, 0, 0, 0.1)}.il:hover{text-decoration:underline}.iq:hover:not(:disabled){color:#156D12}.ir:hover:not(:disabled){fill:#156D12}.kn:hover{fill:rgba(8, 8, 8, 1)}.lc:hover{fill:#000000}.ld:hover p{color:#000000}.lg:hover{color:#000000}.lq:hover svg{color:#000000}.ru:hover{background-color:#F2F2F2}.th:hover{background:#F2F2F2}.ti:hover{border-color:#F2F2F2}.tj:hover{cursor:wait}.tk:hover{color:#F2F2F2}.tl:hover{fill:#F2F2F2}.bd:focus-within path{fill:#242424}.km:focus{fill:rgba(8, 8, 8, 1)}.lr:focus svg{color:#000000}.pa:focus{transform:scale(1.01)}.kr:active{border-style:none}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (min-width: 1080px)">.d{display:none}.bw{width:64px}.cg{margin:0 64px}.cv{height:48px}.dc{margin-bottom:52px}.do{margin-bottom:48px}.ef{font-size:14px}.eg{line-height:20px}.em{font-size:13px}.eo{padding:5px 12px}.fh{display:flex}.fy{margin-bottom:68px}.gc{max-width:680px}.hq{font-size:42px}.hr{margin-top:1.19em}.hs{margin-bottom:32px}.ht{line-height:52px}.hu{letter-spacing:-0.011em}.hz{align-items:center}.jk{border-top:solid 1px #F2F2F2}.jl{border-bottom:solid 1px #F2F2F2}.jm{margin:32px 0 0}.jn{padding:3px 8px}.jw> *{margin-right:24px}.jx> :last-child{margin-right:0}.ky{margin-top:0px}.lm{margin:0}.mn{margin-top:40px}.nj{font-size:20px}.nk{margin-top:2.14em}.nl{line-height:32px}.nm{letter-spacing:-0.003em}.oh{font-size:24px}.oi{margin-top:1.95em}.oj{line-height:30px}.ok{letter-spacing:-0.016em}.oq{margin-top:0.94em}.ow{margin-top:56px}.pw{margin-top:1.72em}.px{line-height:24px}.py{letter-spacing:0}.sb{margin-bottom:88px}.sn{display:inline-block}.st{padding-top:72px}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (max-width: 1079.98px)">.e{display:none}.kx{margin-top:0px}.pd{margin-left:auto}.pe{text-align:center}.sm{display:inline-block}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (max-width: 903.98px)">.f{display:none}.kw{margin-top:0px}.sl{display:inline-block}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (max-width: 727.98px)">.g{display:none}.ku{margin-top:0px}.kv{margin-right:0px}.sk{display:inline-block}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (max-width: 551.98px)">.h{display:none}.s{display:flex}.t{justify-content:space-between}.bs{width:24px}.cc{margin:0 24px}.cr{height:40px}.cy{margin-bottom:44px}.dk{margin-bottom:32px}.dx{font-size:13px}.dy{line-height:20px}.eh{padding:0px 8px 1px}.fu{margin-bottom:4px}.gw{font-size:32px}.gx{margin-top:1.01em}.gy{margin-bottom:24px}.gz{line-height:38px}.ha{letter-spacing:-0.014em}.hv{align-items:flex-start}.it{flex-direction:column}.iy{margin:24px -24px 0}.iz{padding:0}.jo> *{margin-right:8px}.jp> :last-child{margin-right:24px}.kh{margin-left:0px}.ks{margin-top:0px}.kt{margin-right:0px}.li{margin:0}.ls{border:1px solid #F2F2F2}.lt{border-radius:99em}.lu{padding:0px 16px 0px 12px}.lv{height:38px}.lw{align-items:center}.ly svg{margin-right:8px}.mj{margin-top:32px}.mt{font-size:18px}.mu{margin-top:1.56em}.mv{line-height:28px}.mw{letter-spacing:-0.003em}.nr{font-size:20px}.ns{margin-top:1.2em}.nt{line-height:24px}.nu{letter-spacing:0}.om{margin-top:0.67em}.os{margin-top:40px}.pm{font-size:16px}.pn{margin-top:1.23em}.rx{margin-bottom:80px}.sj{display:inline-block}.sp{padding-top:48px}.lx:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (min-width: 904px) and (max-width: 1079.98px)">.i{display:none}.bv{width:64px}.cf{margin:0 64px}.cu{height:48px}.db{margin-bottom:52px}.dn{margin-bottom:48px}.ed{font-size:14px}.ee{line-height:20px}.ek{font-size:13px}.el{padding:5px 12px}.fg{display:flex}.fx{margin-bottom:68px}.gb{max-width:680px}.hl{font-size:42px}.hm{margin-top:1.19em}.hn{margin-bottom:32px}.ho{line-height:52px}.hp{letter-spacing:-0.011em}.hy{align-items:center}.jg{border-top:solid 1px #F2F2F2}.jh{border-bottom:solid 1px #F2F2F2}.ji{margin:32px 0 0}.jj{padding:3px 8px}.ju> *{margin-right:24px}.jv> :last-child{margin-right:0}.ll{margin:0}.mm{margin-top:40px}.nf{font-size:20px}.ng{margin-top:2.14em}.nh{line-height:32px}.ni{letter-spacing:-0.003em}.od{font-size:24px}.oe{margin-top:1.95em}.of{line-height:30px}.og{letter-spacing:-0.016em}.op{margin-top:0.94em}.ov{margin-top:56px}.pt{margin-top:1.72em}.pu{line-height:24px}.pv{letter-spacing:0}.sa{margin-bottom:88px}.ss{padding-top:72px}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (min-width: 728px) and (max-width: 903.98px)">.j{display:none}.w{display:flex}.x{justify-content:space-between}.bu{width:64px}.ce{margin:0 48px}.ct{height:48px}.da{margin-bottom:52px}.dm{margin-bottom:48px}.eb{font-size:13px}.ec{line-height:20px}.ej{padding:0px 8px 1px}.fw{margin-bottom:68px}.ga{max-width:680px}.hg{font-size:42px}.hh{margin-top:1.19em}.hi{margin-bottom:32px}.hj{line-height:52px}.hk{letter-spacing:-0.011em}.hx{align-items:center}.jc{border-top:solid 1px #F2F2F2}.jd{border-bottom:solid 1px #F2F2F2}.je{margin:32px 0 0}.jf{padding:3px 8px}.js> *{margin-right:24px}.jt> :last-child{margin-right:0}.lk{margin:0}.ml{margin-top:40px}.nb{font-size:20px}.nc{margin-top:2.14em}.nd{line-height:32px}.ne{letter-spacing:-0.003em}.nz{font-size:24px}.oa{margin-top:1.95em}.ob{line-height:30px}.oc{letter-spacing:-0.016em}.oo{margin-top:0.94em}.ou{margin-top:56px}.pq{margin-top:1.72em}.pr{line-height:24px}.ps{letter-spacing:0}.rz{margin-bottom:88px}.sr{padding-top:72px}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="all and (min-width: 552px) and (max-width: 727.98px)">.k{display:none}.u{display:flex}.v{justify-content:space-between}.bt{width:24px}.cd{margin:0 24px}.cs{height:40px}.cz{margin-bottom:44px}.dl{margin-bottom:32px}.dz{font-size:13px}.ea{line-height:20px}.ei{padding:0px 8px 1px}.fv{margin-bottom:4px}.hb{font-size:32px}.hc{margin-top:1.01em}.hd{margin-bottom:24px}.he{line-height:38px}.hf{letter-spacing:-0.014em}.hw{align-items:flex-start}.iu{flex-direction:column}.ja{margin:24px 0 0}.jb{padding:0}.jq> *{margin-right:8px}.jr> :last-child{margin-right:8px}.ki{margin-left:0px}.lj{margin:0}.lz{border:1px solid #F2F2F2}.ma{border-radius:99em}.mb{padding:0px 16px 0px 12px}.mc{height:38px}.md{align-items:center}.mf svg{margin-right:8px}.mk{margin-top:32px}.mx{font-size:18px}.my{margin-top:1.56em}.mz{line-height:28px}.na{letter-spacing:-0.003em}.nv{font-size:20px}.nw{margin-top:1.2em}.nx{line-height:24px}.ny{letter-spacing:0}.on{margin-top:0.67em}.ot{margin-top:40px}.po{font-size:16px}.pp{margin-top:1.23em}.ry{margin-bottom:80px}.sq{padding-top:48px}.me:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="print">.sh{display:none}</style><style type="text/css" data-fela-rehydration="542" data-fela-type="RULE" media="(prefers-reduced-motion: no-preference)">.ox{transition:transform 300ms cubic-bezier(0.2, 0, 0.2, 1)}</style></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><script>document.domain = document.domain;</script><div class="l c"><div class="l m n o c"><div class="p q r s t u v w x i d y z"><a class="du ag dv bf ak b am an ao ap aq ar as at s u w i d q dw z" href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F75083fb15cb4&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderUser&amp;source=---top_nav_layout_nav----------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="dt"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ab q"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><button class="bf b dx dy eh dz ea ei eb ec ej ek ee el em eg eo ep eq er es et eu ev ew ex ey ez fa fb fc fd bm fe ff" data-testid="headerSignUpButton">Sign up</button></span></p><div class="ax l"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="p q r ab ac"><div class="ab q ae"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab" aria-label="Homepage" data-testid="headerMediumLogo" href="https://medium.com/?source=---top_nav_layout_nav----------------------------------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" viewBox="0 0 719 160" class="au av aw"><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="ax h"><div class="ab ay az ba bb q bc bd"><div class="bm" aria-hidden="false" aria-describedby="searchResults" aria-labelledby="searchResults"></div><div class="bn bo ab"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ay be bf bg z bh bi bj bk bl" placeholder="Search" value=""/></div></div></div><div class="h k w fg fh"><div class="fi ab"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerWriteButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav-----------" rel="noopener follow"><div class="bf b bg z du fj fk ab q fl fm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-label="Write"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg><div class="dt l">Write</div></div></a></span></div></div><div class="k j i d"><div class="fi ab"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSearchButton" href="https://medium.com/search?source=---top_nav_layout_nav----------------------------------" rel="noopener follow"><div class="bf b bg z du fj fk ab q fl fm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-label="Search"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div></a></div></div><div class="fi h k j"><div class="ab q"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><button class="bf b dx dy eh dz ea ei eb ec ej ek ee el em eg eo ep eq er es et eu ev ew ex ey ez fa fb fc fd bm fe ff" data-testid="headerSignUpButton">Sign up</button></span></p><div class="ax l"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="l" aria-hidden="false"><button class="ay fn am ab q ao fo fp fq" aria-label="user options menu" data-testid="headerUserIcon"><div class="l fj"><img alt="" class="l fd by bz ca cx" src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png" width="32" height="32" loading="lazy" role="presentation"/><div class="fr by l bz ca fs n ay ft"></div></div></button></div></div></div><div class="l"><div class="fu fv fw fx fy l"><div class="ab cb"><div class="ci bh fz ga gb gc"></div></div><article><div class="l"><div class="l"><span class="l"></span><section><div><div class="fs gi gj gk gl gm"></div><div class="gn go gp gq gr"><div class="ab cb"><div class="ci bh fz ga gb gc"><div><h1 id="70ab" class="pw-post-title gs gt gu bf gv gw gx gy gz ha hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht hu bk" data-testid="storyTitle">Dancing With Shellcodes: Cracking the latest version of Guloader</h1><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hv hw hx hy hz ab"><div><div class="ab ia"><a rel="noopener follow" href="/?source=post_page-----75083fb15cb4--------------------------------"><div><div class="bm" aria-hidden="false"><div class="l ib ic by id ie"><div class="l fj"><img alt="Eli Salem" class="l fd by dd de cx" src="https://miro.medium.com/v2/resize:fill:88:88/1*yYX7vWD9X65EM0PVIv9FOw.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/><div class="if by l dd de fs n ig ft"></div></div></div></div></div></a></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="ih ab q"><div class="ab q ii"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b ij ik bk"><a class="af ag ah ai aj ak al am an ao ap aq ar il" data-testid="authorName" rel="noopener follow" href="/?source=post_page-----75083fb15cb4--------------------------------">Eli Salem</a></p></div></div></div><span class="im in" aria-hidden="true"><span class="bf b bg z du">·</span></span><p class="bf b ij ik du"><span><a class="io ip ah ai aj ak al am an ao ap aq ar ex iq ir" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff375cbce3f63&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;user=Eli+Salem&amp;userId=f375cbce3f63&amp;source=post_page-f375cbce3f63----75083fb15cb4---------------------post_header-----------" rel="noopener follow">Follow</a></span></p></div></div></span></div></div><div class="l is"><span class="bf b bg z du"><div class="ab cn it iu iv"><span class="bf b bg z du"><div class="ab ae"><span data-testid="storyReadTime">14 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z du">·</span></span></div><span data-testid="storyPublishDate">Apr 19, 2021</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w fg fh q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon fj kg kh ki kj"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F75083fb15cb4&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;user=Eli+Salem&amp;userId=f375cbce3f63&amp;source=-----75083fb15cb4---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="kk ao kl km kn ko am kp kq kr kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l ks kt ku kv kw kx ky"><p class="bf b dv z du"><span class="kz">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kk la lb ab q fk lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"></div><div class="h k"><div><div class="bm" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F75083fb15cb4&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;source=-----75083fb15cb4---------------------bookmark_footer-----------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="du lg" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></a></span></div></div></div><div class="fd lh cn"><div class="l ae"><div class="ab cb"><div class="li lj lk ll lm ln ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af fk ah ai aj ak al lo an ao ap ex lp lq ld lr ls lt lu lv s lw lx ly lz ma mb mc u md me mf"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="j i d"><p class="bf b bg z du">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af fk ah ai aj ak al lo an ao ap ex lp lq ld lr ls lt lu lv s lw lx ly lz ma mb mc u md me mf"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="j i d"><p class="bf b bg z du">Share</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mj mk ml mm mn mo mg mh paragraph-image"><div class="mg mh mi"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 1100w, https://miro.medium.com/v2/resize:fit:1148/format:webp/1*AGnUYCr0wHlKClBD5EpK-g.png 1148w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 574px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*AGnUYCr0wHlKClBD5EpK-g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*AGnUYCr0wHlKClBD5EpK-g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*AGnUYCr0wHlKClBD5EpK-g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*AGnUYCr0wHlKClBD5EpK-g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*AGnUYCr0wHlKClBD5EpK-g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*AGnUYCr0wHlKClBD5EpK-g.png 1100w, https://miro.medium.com/v2/resize:fit:1148/1*AGnUYCr0wHlKClBD5EpK-g.png 1148w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 574px"/><img alt="" class="bh ln mp c" width="574" height="336" loading="eager" role="presentation"/></picture></div></figure><p id="b727" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire, FormBook, Nanocore, and Parallax RAT.</p><p id="3d7f" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">The malware architecture consists of a VB wrapper and a shellcode that does all the malicious activities of Guloader. Although many malware use crypters that have shellcode in their initial droppers, the Guloader shellcode is notorious for its anti-analysis capabilities; thus making the unpacking mechanism of Guloader much more challenging.</p><p id="b8f2" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">The majority of the anti-analysis functionality of Guloader is already published by several security researchers. However, for researchers who are not 100% familiar with the Guloader shellcode, it could be challenging to predict where these features are located, which might lead to failure in analysis.</p><p id="ba55" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">In this article, I will present a step-by-step dynamic analysis of Guloader. As well, the malware anti-analysis functions, and how to overcome them. <br/>Also, I will demonstrate the malware’s main objectives.</p><p id="a1ef" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk"><strong class="ms gv">Note</strong>- Guloader heavily uses time checks and other traditional anti-analysis techniques. Therefore, to save time, in this analysis I will use the ScyllaHide plugin.<br/>Also, several of the Guloader’s anti-analysis techniques are impossible to evade without manual intervention. So I will mainly (but not only) focus on them.</p><h1 id="5392" class="no np gu bf nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of og oh oi oj ok ol bk">File metadata</h1><p id="d264" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Hash: d55259bcf47af7e645ab7b003aa2cd4071cb36c6</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh or"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9acM_WLpDFHUt2WvTLhPkw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*9acM_WLpDFHUt2WvTLhPkw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9acM_WLpDFHUt2WvTLhPkw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9acM_WLpDFHUt2WvTLhPkw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9acM_WLpDFHUt2WvTLhPkw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9acM_WLpDFHUt2WvTLhPkw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9acM_WLpDFHUt2WvTLhPkw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*9acM_WLpDFHUt2WvTLhPkw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="453" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Sample metadata in Pestudio</figcaption></figure><h1 id="e55c" class="no np gu bf nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of og oh oi oj ok ol bk">Getting into the shellcode</h1><p id="dcca" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">In its initial state, Guloader is wrapped with a VB. To overcome it, we’ll first reach the entry point and then set a breakpoint on VirtualAlloc. Next, we will click Run 12 times (the VB wrapper calls several times to VirtualAlloc, but we only care about the 12th time).</p><p id="4031" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">As we return to user code from the 12th VirtualAlloc, we will see the next image</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh pf"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 1100w, https://miro.medium.com/v2/resize:fit:1378/format:webp/1*WMjYHiak2OWIjJ3sejx3gA.png 1378w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 689px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*WMjYHiak2OWIjJ3sejx3gA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*WMjYHiak2OWIjJ3sejx3gA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*WMjYHiak2OWIjJ3sejx3gA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*WMjYHiak2OWIjJ3sejx3gA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*WMjYHiak2OWIjJ3sejx3gA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*WMjYHiak2OWIjJ3sejx3gA.png 1100w, https://miro.medium.com/v2/resize:fit:1378/1*WMjYHiak2OWIjJ3sejx3gA.png 1378w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 689px"/><img alt="" class="bh ln mp c" width="689" height="460" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">12th VirtualAlloc</figcaption></figure><p id="910f" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Now, Guloader will write the shellcode to this newly allocated memory - The process consists of several JMP instructions. Scroll down until you’ll see a CALL to the register EDI (the place where the shellcode is eventually stored). Taking this CALL will lead us to the shellcode itself.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh pg"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 1100w, https://miro.medium.com/v2/resize:fit:858/format:webp/1*VKD_ZoqmjnF_LfpHo25rMg.png 858w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 429px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*VKD_ZoqmjnF_LfpHo25rMg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*VKD_ZoqmjnF_LfpHo25rMg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*VKD_ZoqmjnF_LfpHo25rMg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*VKD_ZoqmjnF_LfpHo25rMg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*VKD_ZoqmjnF_LfpHo25rMg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*VKD_ZoqmjnF_LfpHo25rMg.png 1100w, https://miro.medium.com/v2/resize:fit:858/1*VKD_ZoqmjnF_LfpHo25rMg.png 858w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 429px"/><img alt="" class="bh ln mp c" width="429" height="258" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Call the shellcode</figcaption></figure><p id="f19a" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Immediately after taking the CALL to EDI, we’ll see a jump to another location. Take this jump as well.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh ph"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 1100w, https://miro.medium.com/v2/resize:fit:1160/format:webp/1*9t-41mfeOkGdMT6bOAnZjQ.png 1160w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 580px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*9t-41mfeOkGdMT6bOAnZjQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9t-41mfeOkGdMT6bOAnZjQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9t-41mfeOkGdMT6bOAnZjQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9t-41mfeOkGdMT6bOAnZjQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9t-41mfeOkGdMT6bOAnZjQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9t-41mfeOkGdMT6bOAnZjQ.png 1100w, https://miro.medium.com/v2/resize:fit:1160/1*9t-41mfeOkGdMT6bOAnZjQ.png 1160w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 580px"/><img alt="" class="bh ln mp c" width="580" height="81" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Take the jump</figcaption></figure><h1 id="c083" class="no np gu bf nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of og oh oi oj ok ol bk">The shellcode</h1><p id="f16d" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">After taking the initial jump, we see three different functions. For our unpacking tutorial, we can skip them and go straight to the JMP 602766, located at the end.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh pi"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 1100w, https://miro.medium.com/v2/resize:fit:1242/format:webp/1*7W8jefz1-YyVgpozUdECyA.png 1242w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 621px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*7W8jefz1-YyVgpozUdECyA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*7W8jefz1-YyVgpozUdECyA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*7W8jefz1-YyVgpozUdECyA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*7W8jefz1-YyVgpozUdECyA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*7W8jefz1-YyVgpozUdECyA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*7W8jefz1-YyVgpozUdECyA.png 1100w, https://miro.medium.com/v2/resize:fit:1242/1*7W8jefz1-YyVgpozUdECyA.png 1242w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 621px"/><img alt="" class="bh ln mp c" width="621" height="409" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Take the jump</figcaption></figure><p id="b037" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After taking the jump, we see an immediate CALL to 600144, step into it.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh pj"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 1100w, https://miro.medium.com/v2/resize:fit:998/format:webp/1*07spnsuASSkXUqIi42ht2Q.png 998w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 499px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*07spnsuASSkXUqIi42ht2Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*07spnsuASSkXUqIi42ht2Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*07spnsuASSkXUqIi42ht2Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*07spnsuASSkXUqIi42ht2Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*07spnsuASSkXUqIi42ht2Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*07spnsuASSkXUqIi42ht2Q.png 1100w, https://miro.medium.com/v2/resize:fit:998/1*07spnsuASSkXUqIi42ht2Q.png 998w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 499px"/><img alt="" class="bh ln mp c" width="499" height="94" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Step into</figcaption></figure><p id="4a5a" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Now, we see several functions and a JMP at the end. Also, we see that the first function is 6013A9.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh pk"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 1100w, https://miro.medium.com/v2/resize:fit:1096/format:webp/1*xDPD07ngDUsqGSjS9k4Qqw.png 1096w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 548px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*xDPD07ngDUsqGSjS9k4Qqw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*xDPD07ngDUsqGSjS9k4Qqw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*xDPD07ngDUsqGSjS9k4Qqw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*xDPD07ngDUsqGSjS9k4Qqw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*xDPD07ngDUsqGSjS9k4Qqw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*xDPD07ngDUsqGSjS9k4Qqw.png 1100w, https://miro.medium.com/v2/resize:fit:1096/1*xDPD07ngDUsqGSjS9k4Qqw.png 1096w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 548px"/><img alt="" class="bh ln mp c" width="548" height="489" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Anti VM function</figcaption></figure><h2 id="7d9e" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-Analysis 1: Anti-VM</h2><p id="c123" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">To our surprise, when we will try to step over the CALL to function 6031A9 we encounter the following message box.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qa"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 1100w, https://miro.medium.com/v2/resize:fit:1042/format:webp/1*d6INqrhRPwESE2h34-ur8w.png 1042w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 521px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*d6INqrhRPwESE2h34-ur8w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*d6INqrhRPwESE2h34-ur8w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*d6INqrhRPwESE2h34-ur8w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*d6INqrhRPwESE2h34-ur8w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*d6INqrhRPwESE2h34-ur8w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*d6INqrhRPwESE2h34-ur8w.png 1100w, https://miro.medium.com/v2/resize:fit:1042/1*d6INqrhRPwESE2h34-ur8w.png 1042w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 521px"/><img alt="" class="bh ln mp c" width="521" height="223" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Gotcha</figcaption></figure><h2 id="a728" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Why did it happen?</h2><p id="6fc0" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Without paying attention, the shellcode pushed 8 pre-computed hashes into the stack, in the following order:<br/><em class="qb">push 0xB314751D<br/>push 0xA7C53F01<br/>push 0x7F21185B<br/>push 0x3E17ADE6<br/>push 0xF21FD920<br/>push 0x27AA3188<br/>push 0xDFCB8F12<br/>push 0x2D9CC76C<br/></em>These hashes will be used by the function 6031A9 in the following manner:<br/><strong class="ms gv">1)</strong> The function will use the API call ZwQueryVirtualMemory (the kernel equivalent of VirtualQuery) to scan the process’s memory.</p><p id="5ca0" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk"><strong class="ms gv">2) </strong>The pre-computed hashes will be calculated using the djb2 algorithm. Each one of them will represent a string that is related to a Virtual Machine product (for example <em class="qb">0xB314751D </em>represents “vmtoolsdControlWndClass”).</p><p id="d3a7" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk"><strong class="ms gv">3)</strong> If one of these strings will be found by the ZwQueryVirtualMemory, the process will create the previously mentioned message box.</p><h2 id="c0a2" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this anti-VM technique?</h2><p id="18fa" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">There are three different approaches we can take: <br/><strong class="ms gv">1)</strong> The first approach is to change the pre-computed hashes on the stack before the call to 6031A9.<br/>2<strong class="ms gv">)</strong> Fill the CALL line with no operation (NOP)<br/><strong class="ms gv">3)</strong> Change the control flow by redirecting the EIP register to contain the address of the next instruction (after the CALL to 6031A9)</p><p id="8984" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">For this example, I took the first approach and changed the hashes suffix to “22”.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qc"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*luYG4mjK9sHa-TwO-H0pjA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*luYG4mjK9sHa-TwO-H0pjA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*luYG4mjK9sHa-TwO-H0pjA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*luYG4mjK9sHa-TwO-H0pjA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*luYG4mjK9sHa-TwO-H0pjA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*luYG4mjK9sHa-TwO-H0pjA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*luYG4mjK9sHa-TwO-H0pjA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*luYG4mjK9sHa-TwO-H0pjA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="298" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Changing the hashes on the stack</figcaption></figure><p id="f5c6" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">As we continue to step over to the next functions, we encounter the function 601F28, which is 2 functions below 6031A9 (the anti-VM function).</p><h2 id="9f2a" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-Analysis 2: Time checks &amp; CPUID</h2><p id="08c9" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">If we will try to step over this function, we’ll see that we are stuck and can&#x27;t move forward.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qd"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 1100w, https://miro.medium.com/v2/resize:fit:868/format:webp/1*LgNLYZq75ciCQTGpcCeMmA.png 868w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 434px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*LgNLYZq75ciCQTGpcCeMmA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*LgNLYZq75ciCQTGpcCeMmA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*LgNLYZq75ciCQTGpcCeMmA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*LgNLYZq75ciCQTGpcCeMmA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*LgNLYZq75ciCQTGpcCeMmA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*LgNLYZq75ciCQTGpcCeMmA.png 1100w, https://miro.medium.com/v2/resize:fit:868/1*LgNLYZq75ciCQTGpcCeMmA.png 868w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 434px"/><img alt="" class="bh ln mp c" width="434" height="132" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Anti-Analysis function</figcaption></figure><h2 id="3106" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Why did it happen?</h2><p id="91c0" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Inside the function 601F28, there is another routine that consists of two anti-analysis mechanisms. Time cheks using RDTSC (Read Time-Stamp Counter), and anti-VM using CPUID.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qe"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 1100w, https://miro.medium.com/v2/resize:fit:910/format:webp/1*_OmHR2S5iezODRypbKq_mw.png 910w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 455px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*_OmHR2S5iezODRypbKq_mw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*_OmHR2S5iezODRypbKq_mw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*_OmHR2S5iezODRypbKq_mw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*_OmHR2S5iezODRypbKq_mw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*_OmHR2S5iezODRypbKq_mw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*_OmHR2S5iezODRypbKq_mw.png 1100w, https://miro.medium.com/v2/resize:fit:910/1*_OmHR2S5iezODRypbKq_mw.png 910w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 455px"/><img alt="" class="bh ln mp c" width="455" height="357" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Anti-Analysis function</figcaption></figure><h2 id="484e" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this anti-analysis?</h2><p id="c525" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Similar to the first anti-VM, we can change the control flow with the EIP register, or fill the line of the CALL to 601F28 with NOPS.</p><p id="26e2" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After choosing our preferred method, we can go to the next JMP instruction.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qf"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 1100w, https://miro.medium.com/v2/resize:fit:816/format:webp/1*3HNfnqX74p64ABhFRJDRhA.png 816w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 408px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*3HNfnqX74p64ABhFRJDRhA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*3HNfnqX74p64ABhFRJDRhA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*3HNfnqX74p64ABhFRJDRhA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*3HNfnqX74p64ABhFRJDRhA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*3HNfnqX74p64ABhFRJDRhA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*3HNfnqX74p64ABhFRJDRhA.png 1100w, https://miro.medium.com/v2/resize:fit:816/1*3HNfnqX74p64ABhFRJDRhA.png 816w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 408px"/><img alt="" class="bh ln mp c" width="408" height="227" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">NOP the function</figcaption></figure><p id="cffe" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After taking the jump, we immediately find ourselves in another CALL to a function called 6001C2, step into it.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qg"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 1100w, https://miro.medium.com/v2/resize:fit:840/format:webp/1*2zBgeeD-RUqtu3Pvnr1DBA.png 840w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 420px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*2zBgeeD-RUqtu3Pvnr1DBA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*2zBgeeD-RUqtu3Pvnr1DBA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*2zBgeeD-RUqtu3Pvnr1DBA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*2zBgeeD-RUqtu3Pvnr1DBA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*2zBgeeD-RUqtu3Pvnr1DBA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*2zBgeeD-RUqtu3Pvnr1DBA.png 1100w, https://miro.medium.com/v2/resize:fit:840/1*2zBgeeD-RUqtu3Pvnr1DBA.png 840w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 420px"/><img alt="" class="bh ln mp c" width="420" height="62" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Step Into</figcaption></figure><p id="7269" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Next, we see a function named 602F54 that will take a big role in the main functionality of the shellcode. <br/>This function is responsible for accessing the process environment block (PEB) and returning an API call.<br/>We also see a direct call to the register EAX - something that is always interesting to inspect when we are dealing with shellcodes.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qh"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 1100w, https://miro.medium.com/v2/resize:fit:900/format:webp/1*bKJKrrlHcG5sb2KIp-Bf9w.png 900w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 450px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*bKJKrrlHcG5sb2KIp-Bf9w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*bKJKrrlHcG5sb2KIp-Bf9w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*bKJKrrlHcG5sb2KIp-Bf9w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*bKJKrrlHcG5sb2KIp-Bf9w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*bKJKrrlHcG5sb2KIp-Bf9w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*bKJKrrlHcG5sb2KIp-Bf9w.png 1100w, https://miro.medium.com/v2/resize:fit:900/1*bKJKrrlHcG5sb2KIp-Bf9w.png 900w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 450px"/><img alt="" class="bh ln mp c" width="450" height="555" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Resolving API Calls</figcaption></figure><p id="58cf" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">When we step over 602F54, we see that it returns the API call TerminateProcess. Then, we’ll take a jump to 6027A0.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qi"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7HdJSrHkCbxdUh7r6MwuIQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*7HdJSrHkCbxdUh7r6MwuIQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*7HdJSrHkCbxdUh7r6MwuIQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*7HdJSrHkCbxdUh7r6MwuIQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*7HdJSrHkCbxdUh7r6MwuIQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*7HdJSrHkCbxdUh7r6MwuIQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*7HdJSrHkCbxdUh7r6MwuIQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*7HdJSrHkCbxdUh7r6MwuIQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="104" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Take the jump</figcaption></figure><p id="9602" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After taking the jump, we find ourselves in a call to the function 6001ED.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qj"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 1100w, https://miro.medium.com/v2/resize:fit:1088/format:webp/1*SYf0wy0mmsMX6-lqOG-BLg.png 1088w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 544px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*SYf0wy0mmsMX6-lqOG-BLg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*SYf0wy0mmsMX6-lqOG-BLg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*SYf0wy0mmsMX6-lqOG-BLg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*SYf0wy0mmsMX6-lqOG-BLg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*SYf0wy0mmsMX6-lqOG-BLg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*SYf0wy0mmsMX6-lqOG-BLg.png 1100w, https://miro.medium.com/v2/resize:fit:1088/1*SYf0wy0mmsMX6-lqOG-BLg.png 1088w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 544px"/><img alt="" class="bh ln mp c" width="544" height="60" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Step Into</figcaption></figure><p id="d1e8" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After stepping into this function, we see that we in a location that will call directly to the register EAX.<br/>Now, this register holds the API call EnumWindows (Enumerates all top-level windows on the screen).</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qk"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cEhwAF-MA7vNMmwFbZdCZg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*cEhwAF-MA7vNMmwFbZdCZg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*cEhwAF-MA7vNMmwFbZdCZg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*cEhwAF-MA7vNMmwFbZdCZg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*cEhwAF-MA7vNMmwFbZdCZg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*cEhwAF-MA7vNMmwFbZdCZg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*cEhwAF-MA7vNMmwFbZdCZg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*cEhwAF-MA7vNMmwFbZdCZg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="256" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">EnumWindows</figcaption></figure><h2 id="eb2c" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-Analysis 3: Anti-VM\Anti-Sandbox</h2><p id="9b10" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">After we step over the call to <em class="qb">EnumWindows</em>, we see the line: <em class="qb">cmp eax,c.<br/></em>Using this line the shellcode determines if there are at least 12 (C in hexadecimal) windows in the machine. If not, the process will be terminated using the previously mentioned API call - TerminateProcess.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh ql"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 1100w, https://miro.medium.com/v2/resize:fit:974/format:webp/1*-tEf4LMPYJsVaA-EfByujw.png 974w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 487px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*-tEf4LMPYJsVaA-EfByujw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*-tEf4LMPYJsVaA-EfByujw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*-tEf4LMPYJsVaA-EfByujw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*-tEf4LMPYJsVaA-EfByujw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*-tEf4LMPYJsVaA-EfByujw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*-tEf4LMPYJsVaA-EfByujw.png 1100w, https://miro.medium.com/v2/resize:fit:974/1*-tEf4LMPYJsVaA-EfByujw.png 974w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 487px"/><img alt="" class="bh ln mp c" width="487" height="229" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Check for at least 12 windows</figcaption></figure><h2 id="052e" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this anti-sandbox?</h2><p id="c908" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Switch the flag in the JGE jump if necessary, however, I did not have any issues with it.</p><p id="d878" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">As we continue with the normal execution of the shellcode, we see more instances of the function 602F54, one of these instances resolves the function <em class="qb">ZwProtectVirtualMemory </em>(the kernel equivalent of <em class="qb">VirtualProtect</em>).<br/>Right after, we’ll see multiple Push 0 instructions and a CALL to the function 6034F4.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qm"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xvq4_9XuSbW4SGwbsdXGTg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*Xvq4_9XuSbW4SGwbsdXGTg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Xvq4_9XuSbW4SGwbsdXGTg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Xvq4_9XuSbW4SGwbsdXGTg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Xvq4_9XuSbW4SGwbsdXGTg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Xvq4_9XuSbW4SGwbsdXGTg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Xvq4_9XuSbW4SGwbsdXGTg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*Xvq4_9XuSbW4SGwbsdXGTg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="264" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Getting into the Anti-breakpoint function</figcaption></figure><h2 id="b03b" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-Analysis 4: Anti breakpoints</h2><p id="8d65" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">When we step into this function, we observe an interesting anti-debugging technique. In its first lines, the shellcode gets the function DbgBreakPoint and store it on esp+18.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qn"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 1100w, https://miro.medium.com/v2/resize:fit:1130/format:webp/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 1130w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 565px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 640w, https://miro.medium.com/v2/resize:fit:720/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 720w, https://miro.medium.com/v2/resize:fit:750/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 750w, https://miro.medium.com/v2/resize:fit:786/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 786w, https://miro.medium.com/v2/resize:fit:828/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 1100w, https://miro.medium.com/v2/resize:fit:1130/1*YYuR91Eq9ZrJyKSVyF_1Ag.png 1130w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 565px"/><img alt="" class="bh ln mp c" width="565" height="81" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Getting DbgBreakPoint</figcaption></figure><p id="1b4f" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Then, it gets the function DbgUiRemoteBreaking, and store its address in esp+1C</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qo"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 1100w, https://miro.medium.com/v2/resize:fit:1202/format:webp/1*T9bWbQnq8026vEQOmONf7Q.png 1202w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 601px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*T9bWbQnq8026vEQOmONf7Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*T9bWbQnq8026vEQOmONf7Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*T9bWbQnq8026vEQOmONf7Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*T9bWbQnq8026vEQOmONf7Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*T9bWbQnq8026vEQOmONf7Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*T9bWbQnq8026vEQOmONf7Q.png 1100w, https://miro.medium.com/v2/resize:fit:1202/1*T9bWbQnq8026vEQOmONf7Q.png 1202w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 601px"/><img alt="" class="bh ln mp c" width="601" height="66" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Getting DbgUiRemoteBreakin</figcaption></figure><p id="8777" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Next, the shellcode gets the address of DbgBreakingPoint (esp+18) moves it to the EAX register, and writes the byte 90 into it. <br/>As we remember, 90 represent NOP, which means that each time a breakpoint will occur it will not break because of the NOP.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 1100w, https://miro.medium.com/v2/resize:fit:790/format:webp/1*QbHMnWKMJcvd-cFzc3zA-Q.png 790w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 395px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*QbHMnWKMJcvd-cFzc3zA-Q.png 640w, https://miro.medium.com/v2/resize:fit:720/1*QbHMnWKMJcvd-cFzc3zA-Q.png 720w, https://miro.medium.com/v2/resize:fit:750/1*QbHMnWKMJcvd-cFzc3zA-Q.png 750w, https://miro.medium.com/v2/resize:fit:786/1*QbHMnWKMJcvd-cFzc3zA-Q.png 786w, https://miro.medium.com/v2/resize:fit:828/1*QbHMnWKMJcvd-cFzc3zA-Q.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*QbHMnWKMJcvd-cFzc3zA-Q.png 1100w, https://miro.medium.com/v2/resize:fit:790/1*QbHMnWKMJcvd-cFzc3zA-Q.png 790w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 395px"/><img alt="" class="bh ln mp c" width="395" height="202" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Patching DbgBreakPoint</figcaption></figure><p id="30cc" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Then, the shellcode will do the same with DbgUiRemoteBreaking. However, it will patch its beginning with 6A, 0, B8, and then add the function ExitProcess after. So every time a breakpoint will be happening the process will be terminated.<br/>Funny enough, this anti-breakpoint mechanism is under another Anti-analysis mechanism using the RDTSC time checks.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qq"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 1100w, https://miro.medium.com/v2/resize:fit:836/format:webp/1*FtyXmZlE3KYaPFHKswh0tw.png 836w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 418px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*FtyXmZlE3KYaPFHKswh0tw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*FtyXmZlE3KYaPFHKswh0tw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*FtyXmZlE3KYaPFHKswh0tw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*FtyXmZlE3KYaPFHKswh0tw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*FtyXmZlE3KYaPFHKswh0tw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*FtyXmZlE3KYaPFHKswh0tw.png 1100w, https://miro.medium.com/v2/resize:fit:836/1*FtyXmZlE3KYaPFHKswh0tw.png 836w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 418px"/><img alt="" class="bh ln mp c" width="418" height="371" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Patching DbgUiRemoteBreakin</figcaption></figure><p id="ed7e" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">In the end, from the disassembler point of view, the changes will look like this:</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qr"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 1100w, https://miro.medium.com/v2/resize:fit:1268/format:webp/1*mvmDt9eMi0SkL3YRQpjrPg.png 1268w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 634px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*mvmDt9eMi0SkL3YRQpjrPg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*mvmDt9eMi0SkL3YRQpjrPg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*mvmDt9eMi0SkL3YRQpjrPg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*mvmDt9eMi0SkL3YRQpjrPg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*mvmDt9eMi0SkL3YRQpjrPg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*mvmDt9eMi0SkL3YRQpjrPg.png 1100w, https://miro.medium.com/v2/resize:fit:1268/1*mvmDt9eMi0SkL3YRQpjrPg.png 1268w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 634px"/><img alt="" class="bh ln mp c" width="634" height="432" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Before and after patch</figcaption></figure><h2 id="ed3b" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this anti-breakpoint?</h2><p id="9160" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">The best way is to bypass the function that responsible for this anti-analysis mechanism, which is 6034F4. Either NOP or Control flow solutions are fine here.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qs"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 1100w, https://miro.medium.com/v2/resize:fit:1128/format:webp/1*n-sEFrQxobaU9Okz1UMvWw.png 1128w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 564px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*n-sEFrQxobaU9Okz1UMvWw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*n-sEFrQxobaU9Okz1UMvWw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*n-sEFrQxobaU9Okz1UMvWw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*n-sEFrQxobaU9Okz1UMvWw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*n-sEFrQxobaU9Okz1UMvWw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*n-sEFrQxobaU9Okz1UMvWw.png 1100w, https://miro.medium.com/v2/resize:fit:1128/1*n-sEFrQxobaU9Okz1UMvWw.png 1128w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 564px"/><img alt="" class="bh ln mp c" width="564" height="174" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">NOP Anti-Analysis function</figcaption></figure><h2 id="a450" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-Analysis 5: Anti-VM</h2><p id="bf94" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Next, we see the function 602038, if we step over it and we’ll see the string “<em class="qb">C:\Program Files\qqa\qqa.exe</em>”. This is because 602038 functionality is to search whether the Qemu gues agent is located on the machine. This is another anti-VM feature of Guloader.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qt"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kBpT2Nog4wYRGQ0GTsdJNg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*kBpT2Nog4wYRGQ0GTsdJNg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*kBpT2Nog4wYRGQ0GTsdJNg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*kBpT2Nog4wYRGQ0GTsdJNg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*kBpT2Nog4wYRGQ0GTsdJNg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*kBpT2Nog4wYRGQ0GTsdJNg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*kBpT2Nog4wYRGQ0GTsdJNg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*kBpT2Nog4wYRGQ0GTsdJNg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="276" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Qemu gues agent</figcaption></figure><p id="23f1" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">—</p><p id="8ade" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">In the next two calls, we see a call to 602F54 which resolves <em class="qb">NtSetInformationThread.</em> This API call will be stored in the EAX register and will be executed several instructions later. However, in this case, we need to pay attention to the argument <em class="qb">NtSetInformationThread </em>gets.</p><h2 id="2a47" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-Analysis 6: <em class="qu">NtSetInformationThread</em></h2><p id="d7ee" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">The second argument is ThreadHideFromDebugger (11), which in this case will cause the process to crash if it&#x27;s working under a debugger.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*Ypr0MxlMtUpvw_Ug6h-jaQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="320" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du"><em class="qu">NtSetInformationThread Anti-Analysis</em></figcaption></figure><h2 id="1aa4" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this anti-debugger technique?</h2><p id="8a3a" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">ScyllaHide covers this technique, however, we can just change the control flow or insert NOPs.</p><p id="f506" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After bypassing <em class="qb">NtSetInformationThread, w</em>e will keep step-over until we will reach a JMP at the end of this large routine, In my case, it is 602773</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qw"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 1100w, https://miro.medium.com/v2/resize:fit:1132/format:webp/1*WE1761qXBvtpgl3GTye-vA.png 1132w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 566px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*WE1761qXBvtpgl3GTye-vA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*WE1761qXBvtpgl3GTye-vA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*WE1761qXBvtpgl3GTye-vA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*WE1761qXBvtpgl3GTye-vA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*WE1761qXBvtpgl3GTye-vA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*WE1761qXBvtpgl3GTye-vA.png 1100w, https://miro.medium.com/v2/resize:fit:1132/1*WE1761qXBvtpgl3GTye-vA.png 1132w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 566px"/><img alt="" class="bh ln mp c" width="566" height="145" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Take the jump</figcaption></figure><p id="aa37" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Right after we took the jump, we see a call to another function, step into it.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh qx"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*37tMlovW0LTicCwzR0DofA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*37tMlovW0LTicCwzR0DofA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*37tMlovW0LTicCwzR0DofA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*37tMlovW0LTicCwzR0DofA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*37tMlovW0LTicCwzR0DofA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*37tMlovW0LTicCwzR0DofA.png 1100w, https://miro.medium.com/v2/resize:fit:918/format:webp/1*37tMlovW0LTicCwzR0DofA.png 918w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 459px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*37tMlovW0LTicCwzR0DofA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*37tMlovW0LTicCwzR0DofA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*37tMlovW0LTicCwzR0DofA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*37tMlovW0LTicCwzR0DofA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*37tMlovW0LTicCwzR0DofA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*37tMlovW0LTicCwzR0DofA.png 1100w, https://miro.medium.com/v2/resize:fit:918/1*37tMlovW0LTicCwzR0DofA.png 918w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 459px"/><img alt="" class="bh ln mp c" width="459" height="74" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Step into</figcaption></figure><p id="7063" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After stepping into the function, we found ourselves in a unique location. Using other pre-computed hashes, the shellcode searches for installed products with the API <em class="qb">MsiEnumProducA </em>and <em class="qb">MsiGetProductInfo </em>(again with the djb2 algorithm).<br/>I will not focus on this technique, but it is explained in detail <a class="af qy" href="https://labs.k7computing.com/?p=21725" rel="noopener ugc nofollow" target="_blank">here</a>.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh qz"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kAulo-PWfBuLRxDBGrvNnw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*kAulo-PWfBuLRxDBGrvNnw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*kAulo-PWfBuLRxDBGrvNnw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*kAulo-PWfBuLRxDBGrvNnw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*kAulo-PWfBuLRxDBGrvNnw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*kAulo-PWfBuLRxDBGrvNnw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*kAulo-PWfBuLRxDBGrvNnw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*kAulo-PWfBuLRxDBGrvNnw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="428" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du"><em class="qu">MsiEnumProducA and MsiGetProductInfo</em></figcaption></figure><p id="5baf" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">After the execution of MsiEnumProductsA, we see the instruction JNE 6004C8, by default we will not take this jump, but for the sake of bypassing this anti-analysis, we will change the ZF (zero flag) from 1 to 0, and take the jump.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh ra"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9fGlETvbCXH4V048_G1iYw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*9fGlETvbCXH4V048_G1iYw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9fGlETvbCXH4V048_G1iYw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9fGlETvbCXH4V048_G1iYw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9fGlETvbCXH4V048_G1iYw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9fGlETvbCXH4V048_G1iYw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9fGlETvbCXH4V048_G1iYw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*9fGlETvbCXH4V048_G1iYw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="264" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Change the flag</figcaption></figure><h1 id="24c4" class="no np gu bf nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of og oh oi oj ok ol bk">Shellcode main function</h1><p id="d347" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Once we took the jump, we will reach one of the most important functions in the shellcode. This function will mainly consist of two important functions.<br/>The first one is the already mentioned 602F54 which will resolve API calls. The second one is 603B93 which will be responsible to execute them (except few cases). This function will be the main execution function, where the most important API calls will be executed.<br/>These two functions will be used multiple times during the final stages of the shellcode. Set a breakpoint on 603B93 and step into it.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rb"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EP7nZAYOPIULo6rRA63tOA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*EP7nZAYOPIULo6rRA63tOA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*EP7nZAYOPIULo6rRA63tOA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*EP7nZAYOPIULo6rRA63tOA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*EP7nZAYOPIULo6rRA63tOA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*EP7nZAYOPIULo6rRA63tOA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*EP7nZAYOPIULo6rRA63tOA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*EP7nZAYOPIULo6rRA63tOA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="398" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Two important functions</figcaption></figure><p id="347f" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Because of the fact that this function will be responsible for the majority of the API calls execution, we’ll want to set a breakpoint in strategic locations so we’ll have the option to hit Run and speed things up.<br/>My preferred locations are the call to EAX, which is the location when the API call will be executed, and JMP ECX, which is the location where the function will return to the core parent function.<br/>However, before we’ll reach these important functions we need to bypass multiple anti-analysis checks that happened right before.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rc"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zqjgh2u2ZIURiqCUObDpRQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*Zqjgh2u2ZIURiqCUObDpRQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Zqjgh2u2ZIURiqCUObDpRQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Zqjgh2u2ZIURiqCUObDpRQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Zqjgh2u2ZIURiqCUObDpRQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Zqjgh2u2ZIURiqCUObDpRQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Zqjgh2u2ZIURiqCUObDpRQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*Zqjgh2u2ZIURiqCUObDpRQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="502" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Execution function architecture</figcaption></figure><h2 id="d61a" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-analysis 7: Hardware breakpoints</h2><p id="7ffc" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">The DR (debug registers) are located in the following locations:<br/>[eax+4] = DR 0<br/>[eax+8] = DR 1<br/>[eax+C] = DR 2<br/>[eax+10] = DR 3<br/>[eax+14] = DR 4<br/>[eax+18] = DR 5<br/>The shellcode will compare any of these registers to the number 0, if one of them is not 0 that means there is a hardware breakpoint. In this case, the shellcode will jump using the JNE 603C97 and the process will be terminated.</p><p id="e420" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">If we want to observe how this anti-analysis mechanism works, we can click “follow in dump” on one of these DR locations (for example eax+4), and see it has the same address of the chronological number we set the hardware breakpoint.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rd"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pMIKOxbJOShDtY9u2s-z3g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*pMIKOxbJOShDtY9u2s-z3g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*pMIKOxbJOShDtY9u2s-z3g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*pMIKOxbJOShDtY9u2s-z3g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*pMIKOxbJOShDtY9u2s-z3g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*pMIKOxbJOShDtY9u2s-z3g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*pMIKOxbJOShDtY9u2s-z3g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*pMIKOxbJOShDtY9u2s-z3g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="444" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Hardware breakpoint example</figcaption></figure><h2 id="55a7" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this technique?</h2><p id="14df" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">If you set a hardware breakpoint, you can change the flag so the JNE jump will not be taken.<br/>The easiest solution will be to use the ScyllaHide plugin.</p><h2 id="c1ab" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Anti-analysis 8: Software breakpoints</h2><p id="3ec5" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">In this technique, the shellcode will get the API call to be executed from the EAX register, move one byte to the bl portion of the EBX register, and will inspect if any software breakpoints assign to it.<br/>If it has any software breakpoint, it will have one of the breakpoint opcodes(for example, 0xCC which means INT 3, and as we know, the INT 3 opcode represents a software breakpoint).</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh re"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 1100w, https://miro.medium.com/v2/resize:fit:1098/format:webp/1*V9M--EfIp-l7EFd8pEEL2w.png 1098w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 549px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*V9M--EfIp-l7EFd8pEEL2w.png 640w, https://miro.medium.com/v2/resize:fit:720/1*V9M--EfIp-l7EFd8pEEL2w.png 720w, https://miro.medium.com/v2/resize:fit:750/1*V9M--EfIp-l7EFd8pEEL2w.png 750w, https://miro.medium.com/v2/resize:fit:786/1*V9M--EfIp-l7EFd8pEEL2w.png 786w, https://miro.medium.com/v2/resize:fit:828/1*V9M--EfIp-l7EFd8pEEL2w.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*V9M--EfIp-l7EFd8pEEL2w.png 1100w, https://miro.medium.com/v2/resize:fit:1098/1*V9M--EfIp-l7EFd8pEEL2w.png 1098w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 549px"/><img alt="" class="bh ln mp c" width="549" height="404" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Software breakpoint example</figcaption></figure><p id="a49b" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">As expected, if a software breakpoint is present, the shellcode will go to the location that will terminate the process.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rf"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PC8QaN6GUW-spRicYi9NmA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*PC8QaN6GUW-spRicYi9NmA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*PC8QaN6GUW-spRicYi9NmA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*PC8QaN6GUW-spRicYi9NmA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*PC8QaN6GUW-spRicYi9NmA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*PC8QaN6GUW-spRicYi9NmA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*PC8QaN6GUW-spRicYi9NmA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*PC8QaN6GUW-spRicYi9NmA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="348" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Software breakpoint example</figcaption></figure><h2 id="3542" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">How we overcome this technique?</h2><p id="4c01" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">Change the ZF to be 0, or change the instruction to be NOP. As mentioned before, the easiest solution is the ScyllaHide plugin.</p><p id="5b32" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Finally, we bypass all of the anti-analysis mechanisms and we can focus on Guloader’s main goal. Because we already set a breakpoint on the call to EAX, and JMP ECX we can click Run, and observe the functions that bein executed.</p><p id="aed2" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">The first API call that is interesting for us is <em class="qb">CreateProcessInternalW </em>(which is the kernel equivalent to <em class="qb">CreateProcessA</em>). In this case, the process to be created is RegAsm.exe, this is also a hint for us that the malware to be downloaded will probably be written in .NET (In this case, it’s Agent-Tesla).</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rg"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UK0ycJYGQIW9VrxCuGhixA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*UK0ycJYGQIW9VrxCuGhixA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*UK0ycJYGQIW9VrxCuGhixA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*UK0ycJYGQIW9VrxCuGhixA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*UK0ycJYGQIW9VrxCuGhixA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*UK0ycJYGQIW9VrxCuGhixA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*UK0ycJYGQIW9VrxCuGhixA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*UK0ycJYGQIW9VrxCuGhixA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="469" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Creating process</figcaption></figure><p id="bcf0" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">The RegAsm process will be spawned in a suspend mode which indicates process hollowing injection, this variation of process hollowing is a bit unique, but because we only care about unpacking the final payload I will not cover it here, however, you can read <a class="af qy" href="https://blog.vincss.net/2020/05/re014-guloader-antivm-techniques.html" rel="noopener ugc nofollow" target="_blank">here </a>for more details.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh rh"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 1100w, https://miro.medium.com/v2/resize:fit:462/format:webp/1*kAF01jMCJkNKs0_p7tTqTQ.png 462w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 231px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*kAF01jMCJkNKs0_p7tTqTQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*kAF01jMCJkNKs0_p7tTqTQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*kAF01jMCJkNKs0_p7tTqTQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*kAF01jMCJkNKs0_p7tTqTQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*kAF01jMCJkNKs0_p7tTqTQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*kAF01jMCJkNKs0_p7tTqTQ.png 1100w, https://miro.medium.com/v2/resize:fit:462/1*kAF01jMCJkNKs0_p7tTqTQ.png 462w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 231px"/><img alt="" class="bh ln mp c" width="231" height="67" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">RegAsm in suspend state</figcaption></figure><p id="3b9a" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">As we continue to observe the API calls that being executed, we see <em class="qb">NtMapViewOfSection.</em> When we encounter this function, click step over on JMP ECX, to return to the parent function. Then, continue to step over instructions manually until you see an instruction that calls for a function stored in the location [ebp+30]. This line will execute the API call <em class="qb">NtWriteVirtualMemory</em> (which is the kernel equivalent to <em class="qb">WriteProcessMemory</em>).<br/>This instruction will write a second shellcode to the RegAsm process.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div class="mg mh ri"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 1100w, https://miro.medium.com/v2/resize:fit:1216/format:webp/1*C5IKWIvjlYF1haJ7qQsoTQ.png 1216w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 608px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*C5IKWIvjlYF1haJ7qQsoTQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*C5IKWIvjlYF1haJ7qQsoTQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*C5IKWIvjlYF1haJ7qQsoTQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*C5IKWIvjlYF1haJ7qQsoTQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*C5IKWIvjlYF1haJ7qQsoTQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*C5IKWIvjlYF1haJ7qQsoTQ.png 1100w, https://miro.medium.com/v2/resize:fit:1216/1*C5IKWIvjlYF1haJ7qQsoTQ.png 1216w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 608px"/><img alt="" class="bh ln mp c" width="608" height="202" loading="lazy" role="presentation"/></picture></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Write the second shellcode</figcaption></figure><p id="b364" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Now, we can go to the third argument of <em class="qb">NtWriteVirtualMemory </em>and click “follow in dump” to observe the new shellcode that will be written.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rj"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wuxjmiO8DIxnf2VppZjz0g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*wuxjmiO8DIxnf2VppZjz0g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*wuxjmiO8DIxnf2VppZjz0g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*wuxjmiO8DIxnf2VppZjz0g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*wuxjmiO8DIxnf2VppZjz0g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*wuxjmiO8DIxnf2VppZjz0g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*wuxjmiO8DIxnf2VppZjz0g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*wuxjmiO8DIxnf2VppZjz0g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="425" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Observing the second shellcode</figcaption></figure><p id="e4a8" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Next, we can copy and dump the entire buffer that contains the second shellcode. In this way, we can debug it without any dependency on RegAsm.</p><h2 id="3e94" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Wrap the first shellcode</h2><p id="50d4" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">After the first shellcode creates the RegAsm process and injects a second shellcode into it, it will execute the API call <em class="qb">NtResumeThread </em>to activate the second shellcode within the RegAsm memory.</p><p id="d33c" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Now, we basically have two options, we can open a new debugger and attach it to RegAsm, or, we can debug the dumped second shellcode as a stand-alone shellcode using tools such as BlobRunner. <br/>My preferred option is to debug it using the BlobRunner tool because I don&#x27;t want to be dependent on RegAsm. Also, I want to have the option to debug it over and over again as quickly as possible.</p><p id="0d63" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">For those of you who are not familiar with the BlobRunner tool, please look at the following <a class="af qy" href="https://www.youtube.com/watch?v=q9q8dy-2Jeg" rel="noopener ugc nofollow" target="_blank">video</a>.</p><h1 id="065e" class="no np gu bf nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of og oh oi oj ok ol bk">Debugging the second shellcode</h1><p id="b0b3" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">When we start to debug the second shellcode, we notice that to our surprise this shellcode starts the same as the first one, In fact, this is the almost same shellcode. This resembles give us the advantage to bypass all the anti-analysis mechanism that we already see in the first shellcode.</p><h2 id="6552" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Differences from the first shellcode</h2><p id="2443" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">After we reach the main function we saw in the first shellcode, we will set the same breakpoints. Then, as we click Run and step over functions, we start to see indications of additional capabilities that we have not seen in the first shellcode.</p><p id="b2e9" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">First, we see a call to a location in the stack (in this case, [ebp+D8]), that will execute the function <em class="qb">InternetOpenUrlA</em>, we also see the C2 it will use.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rk"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c4FQvzSohMTv0J5VreCLlg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*c4FQvzSohMTv0J5VreCLlg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*c4FQvzSohMTv0J5VreCLlg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*c4FQvzSohMTv0J5VreCLlg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*c4FQvzSohMTv0J5VreCLlg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*c4FQvzSohMTv0J5VreCLlg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*c4FQvzSohMTv0J5VreCLlg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*c4FQvzSohMTv0J5VreCLlg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="348" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Observing the C2</figcaption></figure><p id="3295" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">Then, in the function that executes API calls, we see other wininet API calls being executed.</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rl"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sKM-JUJaymjo9GhRIRNujg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*sKM-JUJaymjo9GhRIRNujg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*sKM-JUJaymjo9GhRIRNujg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*sKM-JUJaymjo9GhRIRNujg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*sKM-JUJaymjo9GhRIRNujg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*sKM-JUJaymjo9GhRIRNujg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*sKM-JUJaymjo9GhRIRNujg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*sKM-JUJaymjo9GhRIRNujg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="366" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Observing the C2</figcaption></figure><p id="1847" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">At this point I decided to finalize my analysis because we achieve the two goals of this article:<br/><strong class="ms gv">1)</strong> We learn how to crack the two shellcode stages of the Guloader malware.<br/><strong class="ms gv">2)</strong> We observe how to find the C2 that will be responsible for downloading the additional malware.</p><h2 id="818d" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">Recap</h2><p id="7716" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">When we sum up the entire architecture of Guloader, we observe several stages and key features:<br/><strong class="ms gv">1)</strong> The malware initially come wrapped with a VB layer<br/><strong class="ms gv">2)</strong> After the VB part ends, the entire malware activity is executed by a shellcode.<br/><strong class="ms gv">3)</strong> The shellcode contains multiple anti-analysis mechanisms, some of them are inescapable without manual intervention.<br/><strong class="ms gv">4)</strong> The shellcode creates the process RegAsm and injects a second shellcode into it with a unique variation of the Process Hollowing injection.<br/><strong class="ms gv">5)</strong> The second shellcode downloads further malware</p><p id="57a9" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">The Guloader mechanism is depicted in the following diagram:</p><figure class="os ot ou ov ow mo mg mh paragraph-image"><div role="button" tabindex="0" class="ox oy fj oz bh pa"><div class="mg mh rm"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zzpH_php7zqqRBF8Vi2LtA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*zzpH_php7zqqRBF8Vi2LtA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*zzpH_php7zqqRBF8Vi2LtA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*zzpH_php7zqqRBF8Vi2LtA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*zzpH_php7zqqRBF8Vi2LtA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*zzpH_php7zqqRBF8Vi2LtA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*zzpH_php7zqqRBF8Vi2LtA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*zzpH_php7zqqRBF8Vi2LtA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh ln mp c" width="700" height="197" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pb ff pc mg mh pd pe bf b bg z du">Guloader architecture</figcaption></figure><h1 id="2306" class="no np gu bf nq nr ns nt nu nv nw nx ny nz oa ob oc od oe of og oh oi oj ok ol bk">Conclusion</h1><p id="3dbf" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk">In this article, I covered the entire process of the Guloader malware and presented several anti-analysis mechanisms from this shellcode-based downloader.</p><p id="de23" class="pw-post-body-paragraph mq mr gu ms b mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn gn bk">During this step-by-step observation, we saw how this malware&#x27;s unique characteristic challenges security researches, and also how untraditional is Guloader in the current cybercrime landscape.</p><h2 id="4038" class="pl np gu bf nq pm pn dy nu po pp ea ny nb pq pr ps nf pt pu pv nj pw px py pz bk">References:</h2><p id="0381" class="pw-post-body-paragraph mq mr gu ms b mt om mv mw mx on mz na nb oo nd ne nf op nh ni nj oq nl nm nn gn bk"><a class="af qy" href="https://kienmanowar.wordpress.com/2020/06/27/quick-analysis-note-about-guloader-or-cloudeye/" rel="noopener ugc nofollow" target="_blank">https://kienmanowar.wordpress.com/2020/06/27/quick-analysis-note-about-guloader-or-cloudeye/</a><br/><a class="af qy" href="https://www.crowdstrike.com/blog/guloader-malware-analysis/" rel="noopener ugc nofollow" target="_blank">https://www.crowdstrike.com/blog/guloader-malware-analysis/</a><br/><a class="af qy" href="https://www.blueliv.com/cyber-security-and-cyber-threat-intelligence-blog-blueliv/research/playing-with-guloader-anti-vm-techniques-malware/" rel="noopener ugc nofollow" target="_blank">https://www.blueliv.com/cyber-security-and-cyber-threat-intelligence-blog-<br/>blueliv/research/playing-with-guloader-anti-vm-techniques-malware/</a><br/><a class="af qy" href="https://blog.vincss.net/2020/05/re014-guloader-antivm-techniques.html" rel="noopener ugc nofollow" target="_blank">https://blog.vincss.net/2020/05/re014-guloader-antivm-techniques.html</a><br/><a class="af qy" href="https://labs.k7computing.com/?p=21725" rel="noopener ugc nofollow" target="_blank">https://labs.k7computing.com/?p=21725</a><br/><a class="af qy" href="https://github.com/OALabs/BlobRunner" rel="noopener ugc nofollow" target="_blank">https://github.com/OALabs/BlobRunner</a></p></div></div></div></div></section></div></div></article></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="rn ro ab iv"><div class="rp ab"><a class="rq ay am ao" href="https://medium.com/tag/shellcode?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><div class="rr fj cx rs ge rt ru bf b bg z bk rv">Shellcode</div></a></div><div class="rp ab"><a class="rq ay am ao" href="https://medium.com/tag/malware?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><div class="rr fj cx rs ge rt ru bf b bg z bk rv">Malware</div></a></div><div class="rp ab"><a class="rq ay am ao" href="https://medium.com/tag/reverse-engineering?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><div class="rr fj cx rs ge rt ru bf b bg z bk rv">Reverse Engineering</div></a></div><div class="rp ab"><a class="rq ay am ao" href="https://medium.com/tag/debugging?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><div class="rr fj cx rs ge rt ru bf b bg z bk rv">Debugging</div></a></div></div></div></div><div class="l"></div><footer class="rw rx ry rz sa sb sc sd se ab q sf sg c"><div class="l ae"><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="ab cp sh"><div class="ab q ke"><div class="si l"><span class="l sj sk sl e d"><div class="ab q ke kf"><div class="pw-multi-vote-icon fj kg kh ki kj"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F75083fb15cb4&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;user=Eli+Salem&amp;userId=f375cbce3f63&amp;source=-----75083fb15cb4---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="kk ao kl km kn ko am kp kq kr kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l ks kt ku kv kw kx ky"><p class="bf b dv z du"><span class="kz">--</span></p></div></div></span><span class="l h g f sm sn"><div class="ab q ke kf"><div class="pw-multi-vote-icon fj kg kh ki kj"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2F75083fb15cb4&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;user=Eli+Salem&amp;userId=f375cbce3f63&amp;source=-----75083fb15cb4---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="kk ao kl km kn ko am kp kq kr kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l ks kt ku kv kw kx ky"><p class="bf b dv z du"><span class="kz">--</span></p></div></div></span></div><div class="bq ab"><div><div class="bm" aria-hidden="false"><button class="ao kk la lb ab q fk lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div></div><div class="ab q"><div class="so l is"><div><div class="bm" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F75083fb15cb4&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;source=--------------------------bookmark_footer-----------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="du lg" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></a></span></div></div></div><div class="so l is"><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="footerSocialShareButton" class="af fk ah ai aj ak al lo an ao ap ex lp lq ld lr"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg></button></div></div></div></div></div></div></div></div></div></footer><div class="sp sq sr ss st l bx"><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="cl ab su cp"><div class="ab ia"><a rel="noopener follow" href="/?source=post_page-----75083fb15cb4--------------------------------"><div class="l sv sw by sx ie"><div class="l fj"><img alt="Eli Salem" class="l fd by sy sz cx" src="https://miro.medium.com/v2/resize:fill:144:144/1*yYX7vWD9X65EM0PVIv9FOw.jpeg" width="72" height="72" loading="lazy"/><div class="if by l sy sz fs n ig ft"></div></div></div></a></div><div class="j i d"><div class="ab"><span><button class="bf b bg z ep rr eq er es et eu ev ew ex ey ez fa au fb fc fd bm fe ff">Follow</button></span><div class="dt l"><div><div><div class="bm" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Ffbeec447373f&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;newsletterV3=f375cbce3f63&amp;newsletterV3Id=fbeec447373f&amp;user=Eli+Salem&amp;userId=f375cbce3f63&amp;source=-----75083fb15cb4---------------------subscribe_user-----------" rel="noopener follow"><button class="bf b bg z td am te tf tg th ti tj tk tl ew ex ey ez fa fb fc fd bm fe ff" aria-label="Subscribe"><svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" fill="none" viewBox="0 0 38 38" class="ta tb tc"><rect width="0.5" height="6.5" x="26.25" y="9.25" rx="0.25"></rect><rect width="0.5" height="6.5" x="29.75" y="12.25" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5 19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="ab cn cp"><div class="l"><div class="ab q"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab q" rel="noopener follow" href="/?source=post_page-----75083fb15cb4--------------------------------"><h2 class="pw-author-name bf tm tn to tp bk"><span class="gn ix">Written by <!-- -->Eli Salem</span></h2></a></div><div class="rp ab"><div class="l is"><span class="pw-follower-count bf b bg z bk"><a class="af ag ah ai aj ak al am an ao ap aq ar il" rel="noopener follow" href="/followers?source=post_page-----75083fb15cb4--------------------------------">173 Followers</a></span></div></div><div class="tq l"><p class="bf b bg z bk"><span class="gn">Malware Researcher &amp; Threat Hunter</span></p></div></div><div class="h k"><div class="ab"><span><button class="bf b bg z ep rr eq er es et eu ev ew ex ey ez fa au fb fc fd bm fe ff">Follow</button></span><div class="dt l"><div><div><div class="bm" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Ffbeec447373f&amp;operation=register&amp;redirect=https%3A%2F%2Felis531989.medium.com%2Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4&amp;newsletterV3=f375cbce3f63&amp;newsletterV3Id=fbeec447373f&amp;user=Eli+Salem&amp;userId=f375cbce3f63&amp;source=-----75083fb15cb4---------------------subscribe_user-----------" rel="noopener follow"><button class="bf b bg z td am te tf tg th ti tj tk tl ew ex ey ez fa fb fc fd bm fe ff" aria-label="Subscribe"><svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" fill="none" viewBox="0 0 38 38" class="ta tb tc"><rect width="0.5" height="6.5" x="26.25" y="9.25" rx="0.25"></rect><rect width="0.5" height="6.5" x="29.75" y="12.25" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5 19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="tr bh ts mj mk ml mm mn"></div></div></div><div class="h k j"><div class="tr bh ts tt"></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="tu ab ke iv"><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://help.medium.com/hc/en-us?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Help</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.statuspage.io/?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Status</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/about?autoplay=1&amp;source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">About</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Careers</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="pressinquiries@medium.com?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Press</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://blog.medium.com/?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Blog</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Privacy</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Terms</p></a></div><div class="tv tw l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://speechify.com/medium?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Text to speech</p></a></div><div class="tv l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/business?source=post_page-----75083fb15cb4--------------------------------" rel="noopener follow"><p class="bf b dv z du">Teams</p></a></div></div></div></div></div></div></div></div></div></div><script>window.__BUILD_ID__="main-20241017-182126-a0128a89d2"</script><script>window.__GRAPHQL_URI__ = "https://elis531989.medium.com/_/graphql"</script><script>window.__PRELOADED_STATE__ = {"algolia":{"queries":{}},"cache":{"experimentGroupSet":true,"reason":"","group":"enabled","tags":["group-edgeCachePosts","post-75083fb15cb4","user-f375cbce3f63"],"serverVariantState":"44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a","middlewareEnabled":true,"cacheStatus":"DYNAMIC","shouldUseCache":true,"vary":[],"lohpSummerUpsellEnabled":false,"publicationHierarchyEnabled":false},"client":{"hydrated":false,"isUs":false,"isNativeMedium":false,"isSafariMobile":false,"isSafari":false,"isFirefox":false,"routingEntity":{"type":"USER","id":"f375cbce3f63","explicit":true},"viewerIsBot":false},"debug":{"requestId":"c28bfc55-c64d-4a2d-b409-2f748b0bbaf4","hybridDevServices":[],"originalSpanCarrier":{"traceparent":"00-7898a9c9f7a561a34225cbc1ae3119a9-998603d5262e2b02-01"}},"multiVote":{"clapsPerPost":{}},"navigation":{"branch":{"show":null,"hasRendered":null,"blockedByCTA":false},"hideGoogleOneTap":false,"hasRenderedAlternateUserBanner":null,"currentLocation":"https:\u002F\u002Felis531989.medium.com\u002Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4","host":"elis531989.medium.com","hostname":"elis531989.medium.com","referrer":"","hasSetReferrer":false,"susiModal":{"step":null,"operation":"register"},"postRead":false,"partnerProgram":{"selectedCountryCode":null},"queryString":"","currentHash":""},"config":{"nodeEnv":"production","version":"main-20241017-182126-a0128a89d2","target":"production","productName":"Medium","publicUrl":"https:\u002F\u002Fcdn-client.medium.com\u002Flite","authDomain":"medium.com","authGoogleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","favicon":"production","glyphUrl":"https:\u002F\u002Fglyph.medium.com","branchKey":"key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm","algolia":{"appId":"MQ57UUUQZ2","apiKeySearch":"394474ced050e3911ae2249ecc774921","indexPrefix":"medium_","host":"-dsn.algolia.net"},"recaptchaKey":"6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk","recaptcha3Key":"6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5","recaptchaEnterpriseKeyId":"6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp","datadog":{"applicationId":"6702d87d-a7e0-42fe-bbcb-95b469547ea0","clientToken":"pub853ea8d17ad6821d9f8f11861d23dfed","rumToken":"pubf9cc52896502b9413b68ba36fc0c7162","context":{"deployment":{"target":"production","tag":"main-20241017-182126-a0128a89d2","commit":"a0128a89d2d76bfa55b25492370b0bae4050224f"}},"datacenter":"us"},"googleAnalyticsCode":"G-7JY7T788PK","googlePay":{"apiVersion":"2","apiVersionMinor":"0","merchantId":"BCR2DN6TV7EMTGBM","merchantName":"Medium","instanceMerchantId":"13685562959212738550"},"applePay":{"version":3},"signInWallCustomDomainCollectionIds":["3a8144eabfe3","336d898217ee","61061eb0c96b","138adf9c44c","819cc2aaeee0"],"mediumMastodonDomainName":"me.dm","mediumOwnedAndOperatedCollectionIds":["8a9336e5bb4","b7e45b22fec3","193b68bd4fba","8d6b8a439e32","54c98c43354d","3f6ecf56618","d944778ce714","92d2092dc598","ae2a65f35510","1285ba81cada","544c7006046e","fc8964313712","40187e704f1c","88d9857e584e","7b6769f2748b","bcc38c8f6edf","cef6983b292","cb8577c9149e","444d13b52878","713d7dbc99b0","ef8e90590e66","191186aaafa0","55760f21cdc5","9dc80918cc93","bdc4052bbdba","8ccfed20cbb2"],"tierOneDomains":["medium.com","thebolditalic.com","arcdigital.media","towardsdatascience.com","uxdesign.cc","codeburst.io","psiloveyou.xyz","writingcooperative.com","entrepreneurshandbook.co","prototypr.io","betterhumans.coach.me","theascent.pub"],"topicsToFollow":["d61cf867d93f","8a146bc21b28","1eca0103fff3","4d562ee63426","aef1078a3ef5","e15e46793f8d","6158eb913466","55f1c20aba7a","3d18b94f6858","4861fee224fd","63c6f1f93ee","1d98b3a9a871","decb52b64abf","ae5d4995e225","830cded25262"],"topicToTagMappings":{"accessibility":"accessibility","addiction":"addiction","android-development":"android-development","art":"art","artificial-intelligence":"artificial-intelligence","astrology":"astrology","basic-income":"basic-income","beauty":"beauty","biotech":"biotech","blockchain":"blockchain","books":"books","business":"business","cannabis":"cannabis","cities":"cities","climate-change":"climate-change","comics":"comics","coronavirus":"coronavirus","creativity":"creativity","cryptocurrency":"cryptocurrency","culture":"culture","cybersecurity":"cybersecurity","data-science":"data-science","design":"design","digital-life":"digital-life","disability":"disability","economy":"economy","education":"education","equality":"equality","family":"family","feminism":"feminism","fiction":"fiction","film":"film","fitness":"fitness","food":"food","freelancing":"freelancing","future":"future","gadgets":"gadgets","gaming":"gaming","gun-control":"gun-control","health":"health","history":"history","humor":"humor","immigration":"immigration","ios-development":"ios-development","javascript":"javascript","justice":"justice","language":"language","leadership":"leadership","lgbtqia":"lgbtqia","lifestyle":"lifestyle","machine-learning":"machine-learning","makers":"makers","marketing":"marketing","math":"math","media":"media","mental-health":"mental-health","mindfulness":"mindfulness","money":"money","music":"music","neuroscience":"neuroscience","nonfiction":"nonfiction","outdoors":"outdoors","parenting":"parenting","pets":"pets","philosophy":"philosophy","photography":"photography","podcasts":"podcast","poetry":"poetry","politics":"politics","privacy":"privacy","product-management":"product-management","productivity":"productivity","programming":"programming","psychedelics":"psychedelics","psychology":"psychology","race":"race","relationships":"relationships","religion":"religion","remote-work":"remote-work","san-francisco":"san-francisco","science":"science","self":"self","self-driving-cars":"self-driving-cars","sexuality":"sexuality","social-media":"social-media","society":"society","software-engineering":"software-engineering","space":"space","spirituality":"spirituality","sports":"sports","startups":"startup","style":"style","technology":"technology","transportation":"transportation","travel":"travel","true-crime":"true-crime","tv":"tv","ux":"ux","venture-capital":"venture-capital","visual-design":"visual-design","work":"work","world":"world","writing":"writing"},"defaultImages":{"avatar":{"imageId":"1*dmbNkD5D-u45r44go_cf0g.png","height":150,"width":150},"orgLogo":{"imageId":"7*V1_7XP4snlmqrc_0Njontw.png","height":110,"width":500},"postLogo":{"imageId":"bd978bb536350a710e8efb012513429cabdc4c28700604261aeda246d0f980b7","height":810,"width":1440},"postPreviewImage":{"imageId":"1*hn4v1tCaJy7cWMyb0bpNpQ.png","height":386,"width":579}},"collectionStructuredData":{"8d6b8a439e32":{"name":"Elemental","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png","width":980,"height":159}}},"3f6ecf56618":{"name":"Forge","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png","width":596,"height":183}}},"ae2a65f35510":{"name":"GEN","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png","width":264,"height":140}}},"88d9857e584e":{"name":"LEVEL","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png","width":540,"height":108}}},"7b6769f2748b":{"name":"Marker","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png","width":383,"height":92}}},"444d13b52878":{"name":"OneZero","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png","width":540,"height":123}}},"8ccfed20cbb2":{"name":"Zora","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png","width":540,"height":106}}}},"embeddedPostIds":{"coronavirus":"cd3010f9d81f"},"sharedCdcMessaging":{"COVID_APPLICABLE_TAG_SLUGS":[],"COVID_APPLICABLE_TOPIC_NAMES":[],"COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE":[],"COVID_MESSAGES":{"tierA":{"text":"For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":66,"end":73,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"tierB":{"text":"Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.","markups":[{"start":37,"end":45,"href":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety"},{"start":125,"end":132,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"paywall":{"text":"This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":56,"end":70,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":138,"end":145,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"unbound":{"text":"This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":45,"end":59,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":127,"end":134,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]}},"COVID_BANNER_POST_ID_OVERRIDE_WHITELIST":["3b31a67bff4a"]},"sharedVoteMessaging":{"TAGS":["politics","election-2020","government","us-politics","election","2020-presidential-race","trump","donald-trump","democrats","republicans","congress","republican-party","democratic-party","biden","joe-biden","maga"],"TOPICS":["politics","election"],"MESSAGE":{"text":"Find out more about the U.S. election results here.","markups":[{"start":46,"end":50,"href":"https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker"}]},"EXCLUDE_POSTS":["397ef29e3ca5"]},"embedPostRules":[],"recircOptions":{"v1":{"limit":3},"v2":{"limit":8}},"braintreeClientKey":"production_zjkj96jm_m56f8fqpf7ngnrd4","braintree":{"enabled":true,"merchantId":"m56f8fqpf7ngnrd4","merchantAccountId":{"usd":"AMediumCorporation_instant","eur":"amediumcorporation_EUR","cad":"amediumcorporation_CAD"},"publicKey":"ds2nn34bg2z7j5gd","braintreeEnvironment":"production","dashboardUrl":"https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants","gracePeriodDurationInDays":14,"mediumMembershipPlanId":{"monthly":"ce105f8c57a3","monthlyV2":"e8a5e126-792b-4ee6-8fba-d574c1b02fc5","monthlyWithTrial":"d5ee3dbe3db8","monthlyPremium":"fa741a9b47a2","yearly":"a40ad4a43185","yearlyV2":"3815d7d6-b8ca-4224-9b8c-182f9047866e","yearlyStaff":"d74fb811198a","yearlyWithTrial":"b3bc7350e5c7","yearlyPremium":"e21bd2c12166","monthlyOneYearFree":"e6c0637a-2bad-4171-ab4f-3c268633d83c","monthly25PercentOffFirstYear":"235ecc62-0cdb-49ae-9378-726cd21c504b","monthly20PercentOffFirstYear":"ba518864-9c13-4a99-91ca-411bf0cac756","monthly15PercentOffFirstYear":"594c029b-9f89-43d5-88f8-8173af4e070e","monthly10PercentOffFirstYear":"c6c7bc9a-40f2-4b51-8126-e28511d5bdb0","monthlyForStudents":"629ebe51-da7d-41fd-8293-34cd2f2030a8","yearlyOneYearFree":"78ba7be9-0d9f-4ece-aa3e-b54b826f2bf1","yearly25PercentOffFirstYear":"2dbb010d-bb8f-4eeb-ad5c-a08509f42d34","yearly20PercentOffFirstYear":"47565488-435b-47f8-bf93-40d5fbe0ebc8","yearly15PercentOffFirstYear":"8259809b-0881-47d9-acf7-6c001c7f720f","yearly10PercentOffFirstYear":"9dd694fb-96e1-472c-8d9e-3c868d5c1506","yearlyForStudents":"e29345ef-ab1c-4234-95c5-70e50fe6bc23","monthlyCad":"p52orjkaceei","yearlyCad":"h4q9g2up9ktt"},"braintreeDiscountId":{"oneMonthFree":"MONTHS_FREE_01","threeMonthsFree":"MONTHS_FREE_03","sixMonthsFree":"MONTHS_FREE_06","fiftyPercentOffOneYear":"FIFTY_PERCENT_OFF_ONE_YEAR"},"3DSecureVersion":"2","defaultCurrency":"usd","providerPlanIdCurrency":{"4ycw":"usd","rz3b":"usd","3kqm":"usd","jzw6":"usd","c2q2":"usd","nnsw":"usd","q8qw":"usd","d9y6":"usd","fx7w":"cad","nwf2":"cad"}},"paypalClientId":"AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v","paypal":{"host":"https:\u002F\u002Fapi.paypal.com:443","clientMode":"production","serverMode":"live","webhookId":"4G466076A0294510S","monthlyPlan":{"planId":"P-9WR0658853113943TMU5FDQA","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlan":{"planId":"P-7N8963881P8875835MU5JOPQ","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oneYearGift":{"name":"Medium Membership (1 Year, Digital Gift Code)","description":"Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.","price":"50.00","currency":"USD","sku":"membership-gift-1-yr"},"oldMonthlyPlan":{"planId":"P-96U02458LM656772MJZUVH2Y","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlan":{"planId":"P-59P80963JF186412JJZU3SMI","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"monthlyPlanWithTrial":{"planId":"P-66C21969LR178604GJPVKUKY","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlanWithTrial":{"planId":"P-6XW32684EX226940VKCT2MFA","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oldMonthlyPlanNoSetupFee":{"planId":"P-4N046520HR188054PCJC7LJI","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlanNoSetupFee":{"planId":"P-7A4913502Y5181304CJEJMXQ","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"sdkUrl":"https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs"},"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","log":{"json":true,"level":"info"},"imageUploadMaxSizeMb":25,"staffPicks":{"title":"Staff Picks","catalogId":"c7bc6e1ee00f"}},"session":{"xsrf":""}}</script><script>window.__APOLLO_STATE__ = {"ROOT_QUERY":{"__typename":"Query","viewer":null,"collectionByDomainOrSlug({\"domainOrSlug\":\"elis531989.medium.com\"})":null,"postResult({\"id\":\"75083fb15cb4\"})":{"__ref":"Post:75083fb15cb4"}},"LinkedAccounts:f375cbce3f63":{"__typename":"LinkedAccounts","mastodon":null,"id":"f375cbce3f63"},"UserViewerEdge:userId:f375cbce3f63-viewerId:lo_1a6531903e22":{"__typename":"UserViewerEdge","id":"userId:f375cbce3f63-viewerId:lo_1a6531903e22","isFollowing":false,"isUser":false,"isMuting":false},"NewsletterV3:fbeec447373f":{"__typename":"NewsletterV3","id":"fbeec447373f","type":"NEWSLETTER_TYPE_AUTHOR","slug":"f375cbce3f63","name":"f375cbce3f63","collection":null,"user":{"__ref":"User:f375cbce3f63"}},"User:f375cbce3f63":{"__typename":"User","id":"f375cbce3f63","name":"Eli Salem","username":"elis531989","newsletterV3":{"__ref":"NewsletterV3:fbeec447373f"},"linkedAccounts":{"__ref":"LinkedAccounts:f375cbce3f63"},"isSuspended":false,"imageId":"1*yYX7vWD9X65EM0PVIv9FOw.jpeg","mediumMemberAt":0,"verifications":{"__typename":"VerifiedInfo","isBookAuthor":false},"socialStats":{"__typename":"SocialStats","followerCount":173},"customDomainState":{"__typename":"CustomDomainState","live":{"__typename":"CustomDomain","domain":"elis531989.medium.com"}},"hasSubdomain":true,"bio":"Malware Researcher & Threat Hunter","isPartnerProgramEnrolled":false,"viewerEdge":{"__ref":"UserViewerEdge:userId:f375cbce3f63-viewerId:lo_1a6531903e22"},"viewerIsUser":false,"postSubscribeMembershipUpsellShownAt":0,"userPostCounts({\"includeResponsesCount\":true})":null,"membership":null,"allowNotes":true,"twitterScreenName":"elisalem9"},"Topic:decb52b64abf":{"__typename":"Topic","slug":"programming","id":"decb52b64abf","name":"Programming"},"Paragraph:d31608dd9b56_0":{"__typename":"Paragraph","id":"d31608dd9b56_0","name":"70ab","type":"H3","href":null,"layout":null,"metadata":null,"text":"Dancing With Shellcodes: Cracking the latest version of Guloader","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*AGnUYCr0wHlKClBD5EpK-g.png":{"__typename":"ImageMetadata","id":"1*AGnUYCr0wHlKClBD5EpK-g.png","originalHeight":336,"originalWidth":574,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_1":{"__typename":"Paragraph","id":"d31608dd9b56_1","name":"4a62","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*AGnUYCr0wHlKClBD5EpK-g.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_2":{"__typename":"Paragraph","id":"d31608dd9b56_2","name":"b727","type":"P","href":null,"layout":null,"metadata":null,"text":"Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire, FormBook, Nanocore, and Parallax RAT.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_3":{"__typename":"Paragraph","id":"d31608dd9b56_3","name":"3d7f","type":"P","href":null,"layout":null,"metadata":null,"text":"The malware architecture consists of a VB wrapper and a shellcode that does all the malicious activities of Guloader. Although many malware use crypters that have shellcode in their initial droppers, the Guloader shellcode is notorious for its anti-analysis capabilities; thus making the unpacking mechanism of Guloader much more challenging.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_4":{"__typename":"Paragraph","id":"d31608dd9b56_4","name":"b8f2","type":"P","href":null,"layout":null,"metadata":null,"text":"The majority of the anti-analysis functionality of Guloader is already published by several security researchers. However, for researchers who are not 100% familiar with the Guloader shellcode, it could be challenging to predict where these features are located, which might lead to failure in analysis.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_5":{"__typename":"Paragraph","id":"d31608dd9b56_5","name":"ba55","type":"P","href":null,"layout":null,"metadata":null,"text":"In this article, I will present a step-by-step dynamic analysis of Guloader. As well, the malware anti-analysis functions, and how to overcome them. \nAlso, I will demonstrate the malware’s main objectives.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_6":{"__typename":"Paragraph","id":"d31608dd9b56_6","name":"a1ef","type":"P","href":null,"layout":null,"metadata":null,"text":"Note- Guloader heavily uses time checks and other traditional anti-analysis techniques. Therefore, to save time, in this analysis I will use the ScyllaHide plugin.\nAlso, several of the Guloader’s anti-analysis techniques are impossible to evade without manual intervention. So I will mainly (but not only) focus on them.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":4,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_7":{"__typename":"Paragraph","id":"d31608dd9b56_7","name":"5392","type":"H3","href":null,"layout":null,"metadata":null,"text":"File metadata","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_8":{"__typename":"Paragraph","id":"d31608dd9b56_8","name":"d264","type":"P","href":null,"layout":null,"metadata":null,"text":"Hash: d55259bcf47af7e645ab7b003aa2cd4071cb36c6","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*9acM_WLpDFHUt2WvTLhPkw.png":{"__typename":"ImageMetadata","id":"1*9acM_WLpDFHUt2WvTLhPkw.png","originalHeight":725,"originalWidth":1121,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_9":{"__typename":"Paragraph","id":"d31608dd9b56_9","name":"eb48","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*9acM_WLpDFHUt2WvTLhPkw.png"},"text":"Sample metadata in Pestudio","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_10":{"__typename":"Paragraph","id":"d31608dd9b56_10","name":"e55c","type":"H3","href":null,"layout":null,"metadata":null,"text":"Getting into the shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_11":{"__typename":"Paragraph","id":"d31608dd9b56_11","name":"dcca","type":"P","href":null,"layout":null,"metadata":null,"text":"In its initial state, Guloader is wrapped with a VB. To overcome it, we’ll first reach the entry point and then set a breakpoint on VirtualAlloc. Next, we will click Run 12 times (the VB wrapper calls several times to VirtualAlloc, but we only care about the 12th time).","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_12":{"__typename":"Paragraph","id":"d31608dd9b56_12","name":"4031","type":"P","href":null,"layout":null,"metadata":null,"text":"As we return to user code from the 12th VirtualAlloc, we will see the next image","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*WMjYHiak2OWIjJ3sejx3gA.png":{"__typename":"ImageMetadata","id":"1*WMjYHiak2OWIjJ3sejx3gA.png","originalHeight":459,"originalWidth":689,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_13":{"__typename":"Paragraph","id":"d31608dd9b56_13","name":"02ab","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*WMjYHiak2OWIjJ3sejx3gA.png"},"text":"12th VirtualAlloc","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_14":{"__typename":"Paragraph","id":"d31608dd9b56_14","name":"910f","type":"P","href":null,"layout":null,"metadata":null,"text":"Now, Guloader will write the shellcode to this newly allocated memory - The process consists of several JMP instructions. Scroll down until you’ll see a CALL to the register EDI (the place where the shellcode is eventually stored). Taking this CALL will lead us to the shellcode itself.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*VKD_ZoqmjnF_LfpHo25rMg.png":{"__typename":"ImageMetadata","id":"1*VKD_ZoqmjnF_LfpHo25rMg.png","originalHeight":258,"originalWidth":429,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_15":{"__typename":"Paragraph","id":"d31608dd9b56_15","name":"baf6","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*VKD_ZoqmjnF_LfpHo25rMg.png"},"text":"Call the shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_16":{"__typename":"Paragraph","id":"d31608dd9b56_16","name":"f19a","type":"P","href":null,"layout":null,"metadata":null,"text":"Immediately after taking the CALL to EDI, we’ll see a jump to another location. Take this jump as well.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*9t-41mfeOkGdMT6bOAnZjQ.png":{"__typename":"ImageMetadata","id":"1*9t-41mfeOkGdMT6bOAnZjQ.png","originalHeight":81,"originalWidth":580,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_17":{"__typename":"Paragraph","id":"d31608dd9b56_17","name":"5285","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*9t-41mfeOkGdMT6bOAnZjQ.png"},"text":"Take the jump","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_18":{"__typename":"Paragraph","id":"d31608dd9b56_18","name":"c083","type":"H3","href":null,"layout":null,"metadata":null,"text":"The shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_19":{"__typename":"Paragraph","id":"d31608dd9b56_19","name":"f16d","type":"P","href":null,"layout":null,"metadata":null,"text":"After taking the initial jump, we see three different functions. For our unpacking tutorial, we can skip them and go straight to the JMP 602766, located at the end.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*7W8jefz1-YyVgpozUdECyA.png":{"__typename":"ImageMetadata","id":"1*7W8jefz1-YyVgpozUdECyA.png","originalHeight":409,"originalWidth":621,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_20":{"__typename":"Paragraph","id":"d31608dd9b56_20","name":"eb78","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*7W8jefz1-YyVgpozUdECyA.png"},"text":"Take the jump","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_21":{"__typename":"Paragraph","id":"d31608dd9b56_21","name":"b037","type":"P","href":null,"layout":null,"metadata":null,"text":"After taking the jump, we see an immediate CALL to 600144, step into it.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*07spnsuASSkXUqIi42ht2Q.png":{"__typename":"ImageMetadata","id":"1*07spnsuASSkXUqIi42ht2Q.png","originalHeight":94,"originalWidth":499,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_22":{"__typename":"Paragraph","id":"d31608dd9b56_22","name":"d434","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*07spnsuASSkXUqIi42ht2Q.png"},"text":"Step into","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_23":{"__typename":"Paragraph","id":"d31608dd9b56_23","name":"4a5a","type":"P","href":null,"layout":null,"metadata":null,"text":"Now, we see several functions and a JMP at the end. Also, we see that the first function is 6013A9.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*xDPD07ngDUsqGSjS9k4Qqw.png":{"__typename":"ImageMetadata","id":"1*xDPD07ngDUsqGSjS9k4Qqw.png","originalHeight":489,"originalWidth":548,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_24":{"__typename":"Paragraph","id":"d31608dd9b56_24","name":"3814","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*xDPD07ngDUsqGSjS9k4Qqw.png"},"text":"Anti VM function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_25":{"__typename":"Paragraph","id":"d31608dd9b56_25","name":"7d9e","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-Analysis 1: Anti-VM","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_26":{"__typename":"Paragraph","id":"d31608dd9b56_26","name":"c123","type":"P","href":null,"layout":null,"metadata":null,"text":"To our surprise, when we will try to step over the CALL to function 6031A9 we encounter the following message box.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*d6INqrhRPwESE2h34-ur8w.png":{"__typename":"ImageMetadata","id":"1*d6INqrhRPwESE2h34-ur8w.png","originalHeight":223,"originalWidth":521,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_27":{"__typename":"Paragraph","id":"d31608dd9b56_27","name":"05db","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*d6INqrhRPwESE2h34-ur8w.png"},"text":"Gotcha","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_28":{"__typename":"Paragraph","id":"d31608dd9b56_28","name":"a728","type":"H4","href":null,"layout":null,"metadata":null,"text":"Why did it happen?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_29":{"__typename":"Paragraph","id":"d31608dd9b56_29","name":"6fc0","type":"P","href":null,"layout":null,"metadata":null,"text":"Without paying attention, the shellcode pushed 8 pre-computed hashes into the stack, in the following order:\npush 0xB314751D\npush 0xA7C53F01\npush 0x7F21185B\npush 0x3E17ADE6\npush 0xF21FD920\npush 0x27AA3188\npush 0xDFCB8F12\npush 0x2D9CC76C\nThese hashes will be used by the function 6031A9 in the following manner:\n1) The function will use the API call ZwQueryVirtualMemory (the kernel equivalent of VirtualQuery) to scan the process’s memory.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":311,"end":313,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":109,"end":237,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_30":{"__typename":"Paragraph","id":"d31608dd9b56_30","name":"5ca0","type":"P","href":null,"layout":null,"metadata":null,"text":"2) The pre-computed hashes will be calculated using the djb2 algorithm. Each one of them will represent a string that is related to a Virtual Machine product (for example 0xB314751D represents “vmtoolsdControlWndClass”).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":3,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":171,"end":182,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_31":{"__typename":"Paragraph","id":"d31608dd9b56_31","name":"d3a7","type":"P","href":null,"layout":null,"metadata":null,"text":"3) If one of these strings will be found by the ZwQueryVirtualMemory, the process will create the previously mentioned message box.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":2,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_32":{"__typename":"Paragraph","id":"d31608dd9b56_32","name":"c0a2","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this anti-VM technique?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_33":{"__typename":"Paragraph","id":"d31608dd9b56_33","name":"18fa","type":"P","href":null,"layout":null,"metadata":null,"text":"There are three different approaches we can take: \n1) The first approach is to change the pre-computed hashes on the stack before the call to 6031A9.\n2) Fill the CALL line with no operation (NOP)\n3) Change the control flow by redirecting the EIP register to contain the address of the next instruction (after the CALL to 6031A9)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":51,"end":53,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":151,"end":152,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":196,"end":198,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_34":{"__typename":"Paragraph","id":"d31608dd9b56_34","name":"8984","type":"P","href":null,"layout":null,"metadata":null,"text":"For this example, I took the first approach and changed the hashes suffix to “22”.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*luYG4mjK9sHa-TwO-H0pjA.png":{"__typename":"ImageMetadata","id":"1*luYG4mjK9sHa-TwO-H0pjA.png","originalHeight":340,"originalWidth":801,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_35":{"__typename":"Paragraph","id":"d31608dd9b56_35","name":"84a1","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*luYG4mjK9sHa-TwO-H0pjA.png"},"text":"Changing the hashes on the stack","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_36":{"__typename":"Paragraph","id":"d31608dd9b56_36","name":"f5c6","type":"P","href":null,"layout":null,"metadata":null,"text":"As we continue to step over to the next functions, we encounter the function 601F28, which is 2 functions below 6031A9 (the anti-VM function).","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_37":{"__typename":"Paragraph","id":"d31608dd9b56_37","name":"9f2a","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-Analysis 2: Time checks & CPUID","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_38":{"__typename":"Paragraph","id":"d31608dd9b56_38","name":"08c9","type":"P","href":null,"layout":null,"metadata":null,"text":"If we will try to step over this function, we’ll see that we are stuck and can't move forward.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*LgNLYZq75ciCQTGpcCeMmA.png":{"__typename":"ImageMetadata","id":"1*LgNLYZq75ciCQTGpcCeMmA.png","originalHeight":132,"originalWidth":434,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_39":{"__typename":"Paragraph","id":"d31608dd9b56_39","name":"8f4a","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*LgNLYZq75ciCQTGpcCeMmA.png"},"text":"Anti-Analysis function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_40":{"__typename":"Paragraph","id":"d31608dd9b56_40","name":"3106","type":"H4","href":null,"layout":null,"metadata":null,"text":"Why did it happen?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_41":{"__typename":"Paragraph","id":"d31608dd9b56_41","name":"91c0","type":"P","href":null,"layout":null,"metadata":null,"text":"Inside the function 601F28, there is another routine that consists of two anti-analysis mechanisms. Time cheks using RDTSC (Read Time-Stamp Counter), and anti-VM using CPUID.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*_OmHR2S5iezODRypbKq_mw.png":{"__typename":"ImageMetadata","id":"1*_OmHR2S5iezODRypbKq_mw.png","originalHeight":357,"originalWidth":455,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_42":{"__typename":"Paragraph","id":"d31608dd9b56_42","name":"1a15","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*_OmHR2S5iezODRypbKq_mw.png"},"text":"Anti-Analysis function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_43":{"__typename":"Paragraph","id":"d31608dd9b56_43","name":"484e","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this anti-analysis?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_44":{"__typename":"Paragraph","id":"d31608dd9b56_44","name":"c525","type":"P","href":null,"layout":null,"metadata":null,"text":"Similar to the first anti-VM, we can change the control flow with the EIP register, or fill the line of the CALL to 601F28 with NOPS.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_45":{"__typename":"Paragraph","id":"d31608dd9b56_45","name":"26e2","type":"P","href":null,"layout":null,"metadata":null,"text":"After choosing our preferred method, we can go to the next JMP instruction.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*3HNfnqX74p64ABhFRJDRhA.png":{"__typename":"ImageMetadata","id":"1*3HNfnqX74p64ABhFRJDRhA.png","originalHeight":227,"originalWidth":408,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_46":{"__typename":"Paragraph","id":"d31608dd9b56_46","name":"1bae","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*3HNfnqX74p64ABhFRJDRhA.png"},"text":"NOP the function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_47":{"__typename":"Paragraph","id":"d31608dd9b56_47","name":"cffe","type":"P","href":null,"layout":null,"metadata":null,"text":"After taking the jump, we immediately find ourselves in another CALL to a function called 6001C2, step into it.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*2zBgeeD-RUqtu3Pvnr1DBA.png":{"__typename":"ImageMetadata","id":"1*2zBgeeD-RUqtu3Pvnr1DBA.png","originalHeight":62,"originalWidth":420,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_48":{"__typename":"Paragraph","id":"d31608dd9b56_48","name":"b632","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*2zBgeeD-RUqtu3Pvnr1DBA.png"},"text":"Step Into","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_49":{"__typename":"Paragraph","id":"d31608dd9b56_49","name":"7269","type":"P","href":null,"layout":null,"metadata":null,"text":"Next, we see a function named 602F54 that will take a big role in the main functionality of the shellcode. \nThis function is responsible for accessing the process environment block (PEB) and returning an API call.\nWe also see a direct call to the register EAX - something that is always interesting to inspect when we are dealing with shellcodes.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*bKJKrrlHcG5sb2KIp-Bf9w.png":{"__typename":"ImageMetadata","id":"1*bKJKrrlHcG5sb2KIp-Bf9w.png","originalHeight":555,"originalWidth":450,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_50":{"__typename":"Paragraph","id":"d31608dd9b56_50","name":"853a","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*bKJKrrlHcG5sb2KIp-Bf9w.png"},"text":"Resolving API Calls","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_51":{"__typename":"Paragraph","id":"d31608dd9b56_51","name":"58cf","type":"P","href":null,"layout":null,"metadata":null,"text":"When we step over 602F54, we see that it returns the API call TerminateProcess. Then, we’ll take a jump to 6027A0.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*7HdJSrHkCbxdUh7r6MwuIQ.png":{"__typename":"ImageMetadata","id":"1*7HdJSrHkCbxdUh7r6MwuIQ.png","originalHeight":121,"originalWidth":821,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_52":{"__typename":"Paragraph","id":"d31608dd9b56_52","name":"dbc9","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*7HdJSrHkCbxdUh7r6MwuIQ.png"},"text":"Take the jump","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_53":{"__typename":"Paragraph","id":"d31608dd9b56_53","name":"9602","type":"P","href":null,"layout":null,"metadata":null,"text":"After taking the jump, we find ourselves in a call to the function 6001ED.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*SYf0wy0mmsMX6-lqOG-BLg.png":{"__typename":"ImageMetadata","id":"1*SYf0wy0mmsMX6-lqOG-BLg.png","originalHeight":60,"originalWidth":544,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_54":{"__typename":"Paragraph","id":"d31608dd9b56_54","name":"32b2","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*SYf0wy0mmsMX6-lqOG-BLg.png"},"text":"Step Into","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_55":{"__typename":"Paragraph","id":"d31608dd9b56_55","name":"d1e8","type":"P","href":null,"layout":null,"metadata":null,"text":"After stepping into this function, we see that we in a location that will call directly to the register EAX.\nNow, this register holds the API call EnumWindows (Enumerates all top-level windows on the screen).","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*cEhwAF-MA7vNMmwFbZdCZg.png":{"__typename":"ImageMetadata","id":"1*cEhwAF-MA7vNMmwFbZdCZg.png","originalHeight":343,"originalWidth":938,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_56":{"__typename":"Paragraph","id":"d31608dd9b56_56","name":"7ab8","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*cEhwAF-MA7vNMmwFbZdCZg.png"},"text":"EnumWindows","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_57":{"__typename":"Paragraph","id":"d31608dd9b56_57","name":"eb2c","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-Analysis 3: Anti-VM\\Anti-Sandbox","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_58":{"__typename":"Paragraph","id":"d31608dd9b56_58","name":"9b10","type":"P","href":null,"layout":null,"metadata":null,"text":"After we step over the call to EnumWindows, we see the line: cmp eax,c.\nUsing this line the shellcode determines if there are at least 12 (C in hexadecimal) windows in the machine. If not, the process will be terminated using the previously mentioned API call - TerminateProcess.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":31,"end":42,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":61,"end":72,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*-tEf4LMPYJsVaA-EfByujw.png":{"__typename":"ImageMetadata","id":"1*-tEf4LMPYJsVaA-EfByujw.png","originalHeight":229,"originalWidth":487,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_59":{"__typename":"Paragraph","id":"d31608dd9b56_59","name":"5b51","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*-tEf4LMPYJsVaA-EfByujw.png"},"text":"Check for at least 12 windows","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_60":{"__typename":"Paragraph","id":"d31608dd9b56_60","name":"052e","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this anti-sandbox?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_61":{"__typename":"Paragraph","id":"d31608dd9b56_61","name":"c908","type":"P","href":null,"layout":null,"metadata":null,"text":"Switch the flag in the JGE jump if necessary, however, I did not have any issues with it.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_62":{"__typename":"Paragraph","id":"d31608dd9b56_62","name":"d878","type":"P","href":null,"layout":null,"metadata":null,"text":"As we continue with the normal execution of the shellcode, we see more instances of the function 602F54, one of these instances resolves the function ZwProtectVirtualMemory (the kernel equivalent of VirtualProtect).\nRight after, we’ll see multiple Push 0 instructions and a CALL to the function 6034F4.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":150,"end":173,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":199,"end":213,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*Xvq4_9XuSbW4SGwbsdXGTg.png":{"__typename":"ImageMetadata","id":"1*Xvq4_9XuSbW4SGwbsdXGTg.png","originalHeight":379,"originalWidth":1007,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_63":{"__typename":"Paragraph","id":"d31608dd9b56_63","name":"1a71","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*Xvq4_9XuSbW4SGwbsdXGTg.png"},"text":"Getting into the Anti-breakpoint function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_64":{"__typename":"Paragraph","id":"d31608dd9b56_64","name":"b03b","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-Analysis 4: Anti breakpoints","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_65":{"__typename":"Paragraph","id":"d31608dd9b56_65","name":"8d65","type":"P","href":null,"layout":null,"metadata":null,"text":"When we step into this function, we observe an interesting anti-debugging technique. In its first lines, the shellcode gets the function DbgBreakPoint and store it on esp+18.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*YYuR91Eq9ZrJyKSVyF_1Ag.png":{"__typename":"ImageMetadata","id":"1*YYuR91Eq9ZrJyKSVyF_1Ag.png","originalHeight":81,"originalWidth":565,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_66":{"__typename":"Paragraph","id":"d31608dd9b56_66","name":"2d2c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*YYuR91Eq9ZrJyKSVyF_1Ag.png"},"text":"Getting DbgBreakPoint","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_67":{"__typename":"Paragraph","id":"d31608dd9b56_67","name":"1b4f","type":"P","href":null,"layout":null,"metadata":null,"text":"Then, it gets the function DbgUiRemoteBreaking, and store its address in esp+1C","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*T9bWbQnq8026vEQOmONf7Q.png":{"__typename":"ImageMetadata","id":"1*T9bWbQnq8026vEQOmONf7Q.png","originalHeight":66,"originalWidth":601,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_68":{"__typename":"Paragraph","id":"d31608dd9b56_68","name":"3894","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*T9bWbQnq8026vEQOmONf7Q.png"},"text":"Getting DbgUiRemoteBreakin","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_69":{"__typename":"Paragraph","id":"d31608dd9b56_69","name":"8777","type":"P","href":null,"layout":null,"metadata":null,"text":"Next, the shellcode gets the address of DbgBreakingPoint (esp+18) moves it to the EAX register, and writes the byte 90 into it. \nAs we remember, 90 represent NOP, which means that each time a breakpoint will occur it will not break because of the NOP.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*QbHMnWKMJcvd-cFzc3zA-Q.png":{"__typename":"ImageMetadata","id":"1*QbHMnWKMJcvd-cFzc3zA-Q.png","originalHeight":201,"originalWidth":395,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_70":{"__typename":"Paragraph","id":"d31608dd9b56_70","name":"1354","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*QbHMnWKMJcvd-cFzc3zA-Q.png"},"text":"Patching DbgBreakPoint","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_71":{"__typename":"Paragraph","id":"d31608dd9b56_71","name":"30cc","type":"P","href":null,"layout":null,"metadata":null,"text":"Then, the shellcode will do the same with DbgUiRemoteBreaking. However, it will patch its beginning with 6A, 0, B8, and then add the function ExitProcess after. So every time a breakpoint will be happening the process will be terminated.\nFunny enough, this anti-breakpoint mechanism is under another Anti-analysis mechanism using the RDTSC time checks.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*FtyXmZlE3KYaPFHKswh0tw.png":{"__typename":"ImageMetadata","id":"1*FtyXmZlE3KYaPFHKswh0tw.png","originalHeight":371,"originalWidth":418,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_72":{"__typename":"Paragraph","id":"d31608dd9b56_72","name":"6719","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*FtyXmZlE3KYaPFHKswh0tw.png"},"text":"Patching DbgUiRemoteBreakin","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_73":{"__typename":"Paragraph","id":"d31608dd9b56_73","name":"ed7e","type":"P","href":null,"layout":null,"metadata":null,"text":"In the end, from the disassembler point of view, the changes will look like this:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*mvmDt9eMi0SkL3YRQpjrPg.png":{"__typename":"ImageMetadata","id":"1*mvmDt9eMi0SkL3YRQpjrPg.png","originalHeight":432,"originalWidth":634,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_74":{"__typename":"Paragraph","id":"d31608dd9b56_74","name":"0aee","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*mvmDt9eMi0SkL3YRQpjrPg.png"},"text":"Before and after patch","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_75":{"__typename":"Paragraph","id":"d31608dd9b56_75","name":"ed3b","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this anti-breakpoint?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_76":{"__typename":"Paragraph","id":"d31608dd9b56_76","name":"9160","type":"P","href":null,"layout":null,"metadata":null,"text":"The best way is to bypass the function that responsible for this anti-analysis mechanism, which is 6034F4. Either NOP or Control flow solutions are fine here.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*n-sEFrQxobaU9Okz1UMvWw.png":{"__typename":"ImageMetadata","id":"1*n-sEFrQxobaU9Okz1UMvWw.png","originalHeight":173,"originalWidth":564,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_77":{"__typename":"Paragraph","id":"d31608dd9b56_77","name":"9a4a","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*n-sEFrQxobaU9Okz1UMvWw.png"},"text":"NOP Anti-Analysis function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_78":{"__typename":"Paragraph","id":"d31608dd9b56_78","name":"a450","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-Analysis 5: Anti-VM","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_79":{"__typename":"Paragraph","id":"d31608dd9b56_79","name":"bf94","type":"P","href":null,"layout":null,"metadata":null,"text":"Next, we see the function 602038, if we step over it and we’ll see the string “C:\\Program Files\\qqa\\qqa.exe”. This is because 602038 functionality is to search whether the Qemu gues agent is located on the machine. This is another anti-VM feature of Guloader.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":79,"end":107,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*kBpT2Nog4wYRGQ0GTsdJNg.png":{"__typename":"ImageMetadata","id":"1*kBpT2Nog4wYRGQ0GTsdJNg.png","originalHeight":400,"originalWidth":1018,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_80":{"__typename":"Paragraph","id":"d31608dd9b56_80","name":"f979","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*kBpT2Nog4wYRGQ0GTsdJNg.png"},"text":"Qemu gues agent","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_81":{"__typename":"Paragraph","id":"d31608dd9b56_81","name":"23f1","type":"P","href":null,"layout":null,"metadata":null,"text":"—","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_82":{"__typename":"Paragraph","id":"d31608dd9b56_82","name":"8ade","type":"P","href":null,"layout":null,"metadata":null,"text":"In the next two calls, we see a call to 602F54 which resolves NtSetInformationThread. This API call will be stored in the EAX register and will be executed several instructions later. However, in this case, we need to pay attention to the argument NtSetInformationThread gets.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":62,"end":85,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":248,"end":271,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_83":{"__typename":"Paragraph","id":"d31608dd9b56_83","name":"2a47","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-Analysis 6: NtSetInformationThread","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":17,"end":39,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_84":{"__typename":"Paragraph","id":"d31608dd9b56_84","name":"d7ee","type":"P","href":null,"layout":null,"metadata":null,"text":"The second argument is ThreadHideFromDebugger (11), which in this case will cause the process to crash if it's working under a debugger.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*Ypr0MxlMtUpvw_Ug6h-jaQ.png":{"__typename":"ImageMetadata","id":"1*Ypr0MxlMtUpvw_Ug6h-jaQ.png","originalHeight":404,"originalWidth":886,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_85":{"__typename":"Paragraph","id":"d31608dd9b56_85","name":"1093","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*Ypr0MxlMtUpvw_Ug6h-jaQ.png"},"text":"NtSetInformationThread Anti-Analysis","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":0,"end":36,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_86":{"__typename":"Paragraph","id":"d31608dd9b56_86","name":"1aa4","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this anti-debugger technique?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_87":{"__typename":"Paragraph","id":"d31608dd9b56_87","name":"8a3a","type":"P","href":null,"layout":null,"metadata":null,"text":"ScyllaHide covers this technique, however, we can just change the control flow or insert NOPs.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_88":{"__typename":"Paragraph","id":"d31608dd9b56_88","name":"f506","type":"P","href":null,"layout":null,"metadata":null,"text":"After bypassing NtSetInformationThread, we will keep step-over until we will reach a JMP at the end of this large routine, In my case, it is 602773","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":16,"end":41,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*WE1761qXBvtpgl3GTye-vA.png":{"__typename":"ImageMetadata","id":"1*WE1761qXBvtpgl3GTye-vA.png","originalHeight":145,"originalWidth":566,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_89":{"__typename":"Paragraph","id":"d31608dd9b56_89","name":"cad3","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*WE1761qXBvtpgl3GTye-vA.png"},"text":"Take the jump","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_90":{"__typename":"Paragraph","id":"d31608dd9b56_90","name":"aa37","type":"P","href":null,"layout":null,"metadata":null,"text":"Right after we took the jump, we see a call to another function, step into it.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*37tMlovW0LTicCwzR0DofA.png":{"__typename":"ImageMetadata","id":"1*37tMlovW0LTicCwzR0DofA.png","originalHeight":74,"originalWidth":459,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_91":{"__typename":"Paragraph","id":"d31608dd9b56_91","name":"54f2","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*37tMlovW0LTicCwzR0DofA.png"},"text":"Step into","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_92":{"__typename":"Paragraph","id":"d31608dd9b56_92","name":"7063","type":"P","href":null,"layout":null,"metadata":null,"text":"After stepping into the function, we found ourselves in a unique location. Using other pre-computed hashes, the shellcode searches for installed products with the API MsiEnumProducA and MsiGetProductInfo (again with the djb2 algorithm).\nI will not focus on this technique, but it is explained in detail here.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":303,"end":307,"href":"https:\u002F\u002Flabs.k7computing.com\u002F?p=21725","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":167,"end":182,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":186,"end":204,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*kAulo-PWfBuLRxDBGrvNnw.png":{"__typename":"ImageMetadata","id":"1*kAulo-PWfBuLRxDBGrvNnw.png","originalHeight":510,"originalWidth":835,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_93":{"__typename":"Paragraph","id":"d31608dd9b56_93","name":"9558","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*kAulo-PWfBuLRxDBGrvNnw.png"},"text":"MsiEnumProducA and MsiGetProductInfo","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":0,"end":36,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_94":{"__typename":"Paragraph","id":"d31608dd9b56_94","name":"5baf","type":"P","href":null,"layout":null,"metadata":null,"text":"After the execution of MsiEnumProductsA, we see the instruction JNE 6004C8, by default we will not take this jump, but for the sake of bypassing this anti-analysis, we will change the ZF (zero flag) from 1 to 0, and take the jump.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*9fGlETvbCXH4V048_G1iYw.png":{"__typename":"ImageMetadata","id":"1*9fGlETvbCXH4V048_G1iYw.png","originalHeight":300,"originalWidth":798,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_95":{"__typename":"Paragraph","id":"d31608dd9b56_95","name":"d70c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*9fGlETvbCXH4V048_G1iYw.png"},"text":"Change the flag","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_96":{"__typename":"Paragraph","id":"d31608dd9b56_96","name":"24c4","type":"H3","href":null,"layout":null,"metadata":null,"text":"Shellcode main function","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_97":{"__typename":"Paragraph","id":"d31608dd9b56_97","name":"d347","type":"P","href":null,"layout":null,"metadata":null,"text":"Once we took the jump, we will reach one of the most important functions in the shellcode. This function will mainly consist of two important functions.\nThe first one is the already mentioned 602F54 which will resolve API calls. The second one is 603B93 which will be responsible to execute them (except few cases). This function will be the main execution function, where the most important API calls will be executed.\nThese two functions will be used multiple times during the final stages of the shellcode. Set a breakpoint on 603B93 and step into it.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*EP7nZAYOPIULo6rRA63tOA.png":{"__typename":"ImageMetadata","id":"1*EP7nZAYOPIULo6rRA63tOA.png","originalHeight":446,"originalWidth":786,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_98":{"__typename":"Paragraph","id":"d31608dd9b56_98","name":"d192","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*EP7nZAYOPIULo6rRA63tOA.png"},"text":"Two important functions","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_99":{"__typename":"Paragraph","id":"d31608dd9b56_99","name":"347f","type":"P","href":null,"layout":null,"metadata":null,"text":"Because of the fact that this function will be responsible for the majority of the API calls execution, we’ll want to set a breakpoint in strategic locations so we’ll have the option to hit Run and speed things up.\nMy preferred locations are the call to EAX, which is the location when the API call will be executed, and JMP ECX, which is the location where the function will return to the core parent function.\nHowever, before we’ll reach these important functions we need to bypass multiple anti-analysis checks that happened right before.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*Zqjgh2u2ZIURiqCUObDpRQ.png":{"__typename":"ImageMetadata","id":"1*Zqjgh2u2ZIURiqCUObDpRQ.png","originalHeight":640,"originalWidth":893,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_100":{"__typename":"Paragraph","id":"d31608dd9b56_100","name":"1347","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*Zqjgh2u2ZIURiqCUObDpRQ.png"},"text":"Execution function architecture","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_101":{"__typename":"Paragraph","id":"d31608dd9b56_101","name":"d61a","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-analysis 7: Hardware breakpoints","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_102":{"__typename":"Paragraph","id":"d31608dd9b56_102","name":"7ffc","type":"P","href":null,"layout":null,"metadata":null,"text":"The DR (debug registers) are located in the following locations:\n[eax+4] = DR 0\n[eax+8] = DR 1\n[eax+C] = DR 2\n[eax+10] = DR 3\n[eax+14] = DR 4\n[eax+18] = DR 5\nThe shellcode will compare any of these registers to the number 0, if one of them is not 0 that means there is a hardware breakpoint. In this case, the shellcode will jump using the JNE 603C97 and the process will be terminated.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_103":{"__typename":"Paragraph","id":"d31608dd9b56_103","name":"e420","type":"P","href":null,"layout":null,"metadata":null,"text":"If we want to observe how this anti-analysis mechanism works, we can click “follow in dump” on one of these DR locations (for example eax+4), and see it has the same address of the chronological number we set the hardware breakpoint.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*pMIKOxbJOShDtY9u2s-z3g.png":{"__typename":"ImageMetadata","id":"1*pMIKOxbJOShDtY9u2s-z3g.png","originalHeight":596,"originalWidth":940,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_104":{"__typename":"Paragraph","id":"d31608dd9b56_104","name":"4c25","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*pMIKOxbJOShDtY9u2s-z3g.png"},"text":"Hardware breakpoint example","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_105":{"__typename":"Paragraph","id":"d31608dd9b56_105","name":"55a7","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this technique?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_106":{"__typename":"Paragraph","id":"d31608dd9b56_106","name":"14df","type":"P","href":null,"layout":null,"metadata":null,"text":"If you set a hardware breakpoint, you can change the flag so the JNE jump will not be taken.\nThe easiest solution will be to use the ScyllaHide plugin.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_107":{"__typename":"Paragraph","id":"d31608dd9b56_107","name":"c1ab","type":"H4","href":null,"layout":null,"metadata":null,"text":"Anti-analysis 8: Software breakpoints","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_108":{"__typename":"Paragraph","id":"d31608dd9b56_108","name":"3ec5","type":"P","href":null,"layout":null,"metadata":null,"text":"In this technique, the shellcode will get the API call to be executed from the EAX register, move one byte to the bl portion of the EBX register, and will inspect if any software breakpoints assign to it.\nIf it has any software breakpoint, it will have one of the breakpoint opcodes(for example, 0xCC which means INT 3, and as we know, the INT 3 opcode represents a software breakpoint).","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*V9M--EfIp-l7EFd8pEEL2w.png":{"__typename":"ImageMetadata","id":"1*V9M--EfIp-l7EFd8pEEL2w.png","originalHeight":404,"originalWidth":549,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_109":{"__typename":"Paragraph","id":"d31608dd9b56_109","name":"fe13","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*V9M--EfIp-l7EFd8pEEL2w.png"},"text":"Software breakpoint example","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_110":{"__typename":"Paragraph","id":"d31608dd9b56_110","name":"a49b","type":"P","href":null,"layout":null,"metadata":null,"text":"As expected, if a software breakpoint is present, the shellcode will go to the location that will terminate the process.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*PC8QaN6GUW-spRicYi9NmA.png":{"__typename":"ImageMetadata","id":"1*PC8QaN6GUW-spRicYi9NmA.png","originalHeight":376,"originalWidth":758,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_111":{"__typename":"Paragraph","id":"d31608dd9b56_111","name":"62b8","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*PC8QaN6GUW-spRicYi9NmA.png"},"text":"Software breakpoint example","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_112":{"__typename":"Paragraph","id":"d31608dd9b56_112","name":"3542","type":"H4","href":null,"layout":null,"metadata":null,"text":"How we overcome this technique?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_113":{"__typename":"Paragraph","id":"d31608dd9b56_113","name":"4c01","type":"P","href":null,"layout":null,"metadata":null,"text":"Change the ZF to be 0, or change the instruction to be NOP. As mentioned before, the easiest solution is the ScyllaHide plugin.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_114":{"__typename":"Paragraph","id":"d31608dd9b56_114","name":"5b32","type":"P","href":null,"layout":null,"metadata":null,"text":"Finally, we bypass all of the anti-analysis mechanisms and we can focus on Guloader’s main goal. Because we already set a breakpoint on the call to EAX, and JMP ECX we can click Run, and observe the functions that bein executed.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_115":{"__typename":"Paragraph","id":"d31608dd9b56_115","name":"aed2","type":"P","href":null,"layout":null,"metadata":null,"text":"The first API call that is interesting for us is CreateProcessInternalW (which is the kernel equivalent to CreateProcessA). In this case, the process to be created is RegAsm.exe, this is also a hint for us that the malware to be downloaded will probably be written in .NET (In this case, it’s Agent-Tesla).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":49,"end":72,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":107,"end":121,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*UK0ycJYGQIW9VrxCuGhixA.png":{"__typename":"ImageMetadata","id":"1*UK0ycJYGQIW9VrxCuGhixA.png","originalHeight":586,"originalWidth":876,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_116":{"__typename":"Paragraph","id":"d31608dd9b56_116","name":"3712","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*UK0ycJYGQIW9VrxCuGhixA.png"},"text":"Creating process","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_117":{"__typename":"Paragraph","id":"d31608dd9b56_117","name":"bcf0","type":"P","href":null,"layout":null,"metadata":null,"text":"The RegAsm process will be spawned in a suspend mode which indicates process hollowing injection, this variation of process hollowing is a bit unique, but because we only care about unpacking the final payload I will not cover it here, however, you can read here for more details.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":258,"end":263,"href":"https:\u002F\u002Fblog.vincss.net\u002F2020\u002F05\u002Fre014-guloader-antivm-techniques.html","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*kAF01jMCJkNKs0_p7tTqTQ.png":{"__typename":"ImageMetadata","id":"1*kAF01jMCJkNKs0_p7tTqTQ.png","originalHeight":67,"originalWidth":231,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_118":{"__typename":"Paragraph","id":"d31608dd9b56_118","name":"bc92","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*kAF01jMCJkNKs0_p7tTqTQ.png"},"text":"RegAsm in suspend state","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_119":{"__typename":"Paragraph","id":"d31608dd9b56_119","name":"3b9a","type":"P","href":null,"layout":null,"metadata":null,"text":"As we continue to observe the API calls that being executed, we see NtMapViewOfSection. When we encounter this function, click step over on JMP ECX, to return to the parent function. Then, continue to step over instructions manually until you see an instruction that calls for a function stored in the location [ebp+30]. This line will execute the API call NtWriteVirtualMemory (which is the kernel equivalent to WriteProcessMemory).\nThis instruction will write a second shellcode to the RegAsm process.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":68,"end":87,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":357,"end":377,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":413,"end":431,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*C5IKWIvjlYF1haJ7qQsoTQ.png":{"__typename":"ImageMetadata","id":"1*C5IKWIvjlYF1haJ7qQsoTQ.png","originalHeight":202,"originalWidth":608,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_120":{"__typename":"Paragraph","id":"d31608dd9b56_120","name":"2657","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*C5IKWIvjlYF1haJ7qQsoTQ.png"},"text":"Write the second shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_121":{"__typename":"Paragraph","id":"d31608dd9b56_121","name":"b364","type":"P","href":null,"layout":null,"metadata":null,"text":"Now, we can go to the third argument of NtWriteVirtualMemory and click “follow in dump” to observe the new shellcode that will be written.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":40,"end":61,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*wuxjmiO8DIxnf2VppZjz0g.png":{"__typename":"ImageMetadata","id":"1*wuxjmiO8DIxnf2VppZjz0g.png","originalHeight":488,"originalWidth":804,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_122":{"__typename":"Paragraph","id":"d31608dd9b56_122","name":"786f","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*wuxjmiO8DIxnf2VppZjz0g.png"},"text":"Observing the second shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_123":{"__typename":"Paragraph","id":"d31608dd9b56_123","name":"e4a8","type":"P","href":null,"layout":null,"metadata":null,"text":"Next, we can copy and dump the entire buffer that contains the second shellcode. In this way, we can debug it without any dependency on RegAsm.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_124":{"__typename":"Paragraph","id":"d31608dd9b56_124","name":"3e94","type":"H4","href":null,"layout":null,"metadata":null,"text":"Wrap the first shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_125":{"__typename":"Paragraph","id":"d31608dd9b56_125","name":"50d4","type":"P","href":null,"layout":null,"metadata":null,"text":"After the first shellcode creates the RegAsm process and injects a second shellcode into it, it will execute the API call NtResumeThread to activate the second shellcode within the RegAsm memory.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":122,"end":137,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_126":{"__typename":"Paragraph","id":"d31608dd9b56_126","name":"d33c","type":"P","href":null,"layout":null,"metadata":null,"text":"Now, we basically have two options, we can open a new debugger and attach it to RegAsm, or, we can debug the dumped second shellcode as a stand-alone shellcode using tools such as BlobRunner. \nMy preferred option is to debug it using the BlobRunner tool because I don't want to be dependent on RegAsm. Also, I want to have the option to debug it over and over again as quickly as possible.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_127":{"__typename":"Paragraph","id":"d31608dd9b56_127","name":"0d63","type":"P","href":null,"layout":null,"metadata":null,"text":"For those of you who are not familiar with the BlobRunner tool, please look at the following video.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":93,"end":98,"href":"https:\u002F\u002Fwww.youtube.com\u002Fwatch?v=q9q8dy-2Jeg","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_128":{"__typename":"Paragraph","id":"d31608dd9b56_128","name":"065e","type":"H3","href":null,"layout":null,"metadata":null,"text":"Debugging the second shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_129":{"__typename":"Paragraph","id":"d31608dd9b56_129","name":"b0b3","type":"P","href":null,"layout":null,"metadata":null,"text":"When we start to debug the second shellcode, we notice that to our surprise this shellcode starts the same as the first one, In fact, this is the almost same shellcode. This resembles give us the advantage to bypass all the anti-analysis mechanism that we already see in the first shellcode.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_130":{"__typename":"Paragraph","id":"d31608dd9b56_130","name":"6552","type":"H4","href":null,"layout":null,"metadata":null,"text":"Differences from the first shellcode","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_131":{"__typename":"Paragraph","id":"d31608dd9b56_131","name":"2443","type":"P","href":null,"layout":null,"metadata":null,"text":"After we reach the main function we saw in the first shellcode, we will set the same breakpoints. Then, as we click Run and step over functions, we start to see indications of additional capabilities that we have not seen in the first shellcode.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_132":{"__typename":"Paragraph","id":"d31608dd9b56_132","name":"b2e9","type":"P","href":null,"layout":null,"metadata":null,"text":"First, we see a call to a location in the stack (in this case, [ebp+D8]), that will execute the function InternetOpenUrlA, we also see the C2 it will use.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":105,"end":121,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*c4FQvzSohMTv0J5VreCLlg.png":{"__typename":"ImageMetadata","id":"1*c4FQvzSohMTv0J5VreCLlg.png","originalHeight":488,"originalWidth":982,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_133":{"__typename":"Paragraph","id":"d31608dd9b56_133","name":"116c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*c4FQvzSohMTv0J5VreCLlg.png"},"text":"Observing the C2","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_134":{"__typename":"Paragraph","id":"d31608dd9b56_134","name":"3295","type":"P","href":null,"layout":null,"metadata":null,"text":"Then, in the function that executes API calls, we see other wininet API calls being executed.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*sKM-JUJaymjo9GhRIRNujg.png":{"__typename":"ImageMetadata","id":"1*sKM-JUJaymjo9GhRIRNujg.png","originalHeight":481,"originalWidth":920,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_135":{"__typename":"Paragraph","id":"d31608dd9b56_135","name":"f530","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*sKM-JUJaymjo9GhRIRNujg.png"},"text":"Observing the C2","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_136":{"__typename":"Paragraph","id":"d31608dd9b56_136","name":"1847","type":"P","href":null,"layout":null,"metadata":null,"text":"At this point I decided to finalize my analysis because we achieve the two goals of this article:\n1) We learn how to crack the two shellcode stages of the Guloader malware.\n2) We observe how to find the C2 that will be responsible for downloading the additional malware.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":98,"end":100,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":173,"end":175,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_137":{"__typename":"Paragraph","id":"d31608dd9b56_137","name":"818d","type":"H4","href":null,"layout":null,"metadata":null,"text":"Recap","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_138":{"__typename":"Paragraph","id":"d31608dd9b56_138","name":"7716","type":"P","href":null,"layout":null,"metadata":null,"text":"When we sum up the entire architecture of Guloader, we observe several stages and key features:\n1) The malware initially come wrapped with a VB layer\n2) After the VB part ends, the entire malware activity is executed by a shellcode.\n3) The shellcode contains multiple anti-analysis mechanisms, some of them are inescapable without manual intervention.\n4) The shellcode creates the process RegAsm and injects a second shellcode into it with a unique variation of the Process Hollowing injection.\n5) The second shellcode downloads further malware","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":96,"end":98,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":150,"end":152,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":233,"end":235,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":352,"end":354,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":495,"end":497,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_139":{"__typename":"Paragraph","id":"d31608dd9b56_139","name":"57a9","type":"P","href":null,"layout":null,"metadata":null,"text":"The Guloader mechanism is depicted in the following diagram:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*zzpH_php7zqqRBF8Vi2LtA.png":{"__typename":"ImageMetadata","id":"1*zzpH_php7zqqRBF8Vi2LtA.png","originalHeight":230,"originalWidth":820,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:d31608dd9b56_140":{"__typename":"Paragraph","id":"d31608dd9b56_140","name":"c10e","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*zzpH_php7zqqRBF8Vi2LtA.png"},"text":"Guloader architecture","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_141":{"__typename":"Paragraph","id":"d31608dd9b56_141","name":"2306","type":"H3","href":null,"layout":null,"metadata":null,"text":"Conclusion","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_142":{"__typename":"Paragraph","id":"d31608dd9b56_142","name":"3dbf","type":"P","href":null,"layout":null,"metadata":null,"text":"In this article, I covered the entire process of the Guloader malware and presented several anti-analysis mechanisms from this shellcode-based downloader.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_143":{"__typename":"Paragraph","id":"d31608dd9b56_143","name":"de23","type":"P","href":null,"layout":null,"metadata":null,"text":"During this step-by-step observation, we saw how this malware's unique characteristic challenges security researches, and also how untraditional is Guloader in the current cybercrime landscape.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_144":{"__typename":"Paragraph","id":"d31608dd9b56_144","name":"4038","type":"H4","href":null,"layout":null,"metadata":null,"text":"References:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:d31608dd9b56_145":{"__typename":"Paragraph","id":"d31608dd9b56_145","name":"0381","type":"P","href":null,"layout":null,"metadata":null,"text":"https:\u002F\u002Fkienmanowar.wordpress.com\u002F2020\u002F06\u002F27\u002Fquick-analysis-note-about-guloader-or-cloudeye\u002F\nhttps:\u002F\u002Fwww.crowdstrike.com\u002Fblog\u002Fguloader-malware-analysis\u002F\nhttps:\u002F\u002Fwww.blueliv.com\u002Fcyber-security-and-cyber-threat-intelligence-blog-\nblueliv\u002Fresearch\u002Fplaying-with-guloader-anti-vm-techniques-malware\u002F\nhttps:\u002F\u002Fblog.vincss.net\u002F2020\u002F05\u002Fre014-guloader-antivm-techniques.html\nhttps:\u002F\u002Flabs.k7computing.com\u002F?p=21725\nhttps:\u002F\u002Fgithub.com\u002FOALabs\u002FBlobRunner","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":92,"href":"https:\u002F\u002Fkienmanowar.wordpress.com\u002F2020\u002F06\u002F27\u002Fquick-analysis-note-about-guloader-or-cloudeye\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":93,"end":152,"href":"https:\u002F\u002Fwww.crowdstrike.com\u002Fblog\u002Fguloader-malware-analysis\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":153,"end":294,"href":"https:\u002F\u002Fwww.blueliv.com\u002Fcyber-security-and-cyber-threat-intelligence-blog-blueliv\u002Fresearch\u002Fplaying-with-guloader-anti-vm-techniques-malware\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":295,"end":364,"href":"https:\u002F\u002Fblog.vincss.net\u002F2020\u002F05\u002Fre014-guloader-antivm-techniques.html","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":365,"end":402,"href":"https:\u002F\u002Flabs.k7computing.com\u002F?p=21725","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":403,"end":439,"href":"https:\u002F\u002Fgithub.com\u002FOALabs\u002FBlobRunner","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"PostViewerEdge:postId:75083fb15cb4-viewerId:lo_1a6531903e22":{"__typename":"PostViewerEdge","shouldIndexPostForExternalSearch":true,"id":"postId:75083fb15cb4-viewerId:lo_1a6531903e22"},"Tag:shellcode":{"__typename":"Tag","id":"shellcode","displayTitle":"Shellcode","normalizedTagSlug":"shellcode"},"Tag:malware":{"__typename":"Tag","id":"malware","displayTitle":"Malware","normalizedTagSlug":"malware"},"Tag:reverse-engineering":{"__typename":"Tag","id":"reverse-engineering","displayTitle":"Reverse Engineering","normalizedTagSlug":"reverse-engineering"},"Tag:debugging":{"__typename":"Tag","id":"debugging","displayTitle":"Debugging","normalizedTagSlug":"debugging"},"Post:75083fb15cb4":{"__typename":"Post","id":"75083fb15cb4","collection":null,"content({\"postMeteringOptions\":{}})":{"__typename":"PostContent","isLockedPreviewOnly":false,"bodyModel":{"__typename":"RichText","sections":[{"__typename":"Section","name":"1248","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}],"paragraphs":[{"__ref":"Paragraph:d31608dd9b56_0"},{"__ref":"Paragraph:d31608dd9b56_1"},{"__ref":"Paragraph:d31608dd9b56_2"},{"__ref":"Paragraph:d31608dd9b56_3"},{"__ref":"Paragraph:d31608dd9b56_4"},{"__ref":"Paragraph:d31608dd9b56_5"},{"__ref":"Paragraph:d31608dd9b56_6"},{"__ref":"Paragraph:d31608dd9b56_7"},{"__ref":"Paragraph:d31608dd9b56_8"},{"__ref":"Paragraph:d31608dd9b56_9"},{"__ref":"Paragraph:d31608dd9b56_10"},{"__ref":"Paragraph:d31608dd9b56_11"},{"__ref":"Paragraph:d31608dd9b56_12"},{"__ref":"Paragraph:d31608dd9b56_13"},{"__ref":"Paragraph:d31608dd9b56_14"},{"__ref":"Paragraph:d31608dd9b56_15"},{"__ref":"Paragraph:d31608dd9b56_16"},{"__ref":"Paragraph:d31608dd9b56_17"},{"__ref":"Paragraph:d31608dd9b56_18"},{"__ref":"Paragraph:d31608dd9b56_19"},{"__ref":"Paragraph:d31608dd9b56_20"},{"__ref":"Paragraph:d31608dd9b56_21"},{"__ref":"Paragraph:d31608dd9b56_22"},{"__ref":"Paragraph:d31608dd9b56_23"},{"__ref":"Paragraph:d31608dd9b56_24"},{"__ref":"Paragraph:d31608dd9b56_25"},{"__ref":"Paragraph:d31608dd9b56_26"},{"__ref":"Paragraph:d31608dd9b56_27"},{"__ref":"Paragraph:d31608dd9b56_28"},{"__ref":"Paragraph:d31608dd9b56_29"},{"__ref":"Paragraph:d31608dd9b56_30"},{"__ref":"Paragraph:d31608dd9b56_31"},{"__ref":"Paragraph:d31608dd9b56_32"},{"__ref":"Paragraph:d31608dd9b56_33"},{"__ref":"Paragraph:d31608dd9b56_34"},{"__ref":"Paragraph:d31608dd9b56_35"},{"__ref":"Paragraph:d31608dd9b56_36"},{"__ref":"Paragraph:d31608dd9b56_37"},{"__ref":"Paragraph:d31608dd9b56_38"},{"__ref":"Paragraph:d31608dd9b56_39"},{"__ref":"Paragraph:d31608dd9b56_40"},{"__ref":"Paragraph:d31608dd9b56_41"},{"__ref":"Paragraph:d31608dd9b56_42"},{"__ref":"Paragraph:d31608dd9b56_43"},{"__ref":"Paragraph:d31608dd9b56_44"},{"__ref":"Paragraph:d31608dd9b56_45"},{"__ref":"Paragraph:d31608dd9b56_46"},{"__ref":"Paragraph:d31608dd9b56_47"},{"__ref":"Paragraph:d31608dd9b56_48"},{"__ref":"Paragraph:d31608dd9b56_49"},{"__ref":"Paragraph:d31608dd9b56_50"},{"__ref":"Paragraph:d31608dd9b56_51"},{"__ref":"Paragraph:d31608dd9b56_52"},{"__ref":"Paragraph:d31608dd9b56_53"},{"__ref":"Paragraph:d31608dd9b56_54"},{"__ref":"Paragraph:d31608dd9b56_55"},{"__ref":"Paragraph:d31608dd9b56_56"},{"__ref":"Paragraph:d31608dd9b56_57"},{"__ref":"Paragraph:d31608dd9b56_58"},{"__ref":"Paragraph:d31608dd9b56_59"},{"__ref":"Paragraph:d31608dd9b56_60"},{"__ref":"Paragraph:d31608dd9b56_61"},{"__ref":"Paragraph:d31608dd9b56_62"},{"__ref":"Paragraph:d31608dd9b56_63"},{"__ref":"Paragraph:d31608dd9b56_64"},{"__ref":"Paragraph:d31608dd9b56_65"},{"__ref":"Paragraph:d31608dd9b56_66"},{"__ref":"Paragraph:d31608dd9b56_67"},{"__ref":"Paragraph:d31608dd9b56_68"},{"__ref":"Paragraph:d31608dd9b56_69"},{"__ref":"Paragraph:d31608dd9b56_70"},{"__ref":"Paragraph:d31608dd9b56_71"},{"__ref":"Paragraph:d31608dd9b56_72"},{"__ref":"Paragraph:d31608dd9b56_73"},{"__ref":"Paragraph:d31608dd9b56_74"},{"__ref":"Paragraph:d31608dd9b56_75"},{"__ref":"Paragraph:d31608dd9b56_76"},{"__ref":"Paragraph:d31608dd9b56_77"},{"__ref":"Paragraph:d31608dd9b56_78"},{"__ref":"Paragraph:d31608dd9b56_79"},{"__ref":"Paragraph:d31608dd9b56_80"},{"__ref":"Paragraph:d31608dd9b56_81"},{"__ref":"Paragraph:d31608dd9b56_82"},{"__ref":"Paragraph:d31608dd9b56_83"},{"__ref":"Paragraph:d31608dd9b56_84"},{"__ref":"Paragraph:d31608dd9b56_85"},{"__ref":"Paragraph:d31608dd9b56_86"},{"__ref":"Paragraph:d31608dd9b56_87"},{"__ref":"Paragraph:d31608dd9b56_88"},{"__ref":"Paragraph:d31608dd9b56_89"},{"__ref":"Paragraph:d31608dd9b56_90"},{"__ref":"Paragraph:d31608dd9b56_91"},{"__ref":"Paragraph:d31608dd9b56_92"},{"__ref":"Paragraph:d31608dd9b56_93"},{"__ref":"Paragraph:d31608dd9b56_94"},{"__ref":"Paragraph:d31608dd9b56_95"},{"__ref":"Paragraph:d31608dd9b56_96"},{"__ref":"Paragraph:d31608dd9b56_97"},{"__ref":"Paragraph:d31608dd9b56_98"},{"__ref":"Paragraph:d31608dd9b56_99"},{"__ref":"Paragraph:d31608dd9b56_100"},{"__ref":"Paragraph:d31608dd9b56_101"},{"__ref":"Paragraph:d31608dd9b56_102"},{"__ref":"Paragraph:d31608dd9b56_103"},{"__ref":"Paragraph:d31608dd9b56_104"},{"__ref":"Paragraph:d31608dd9b56_105"},{"__ref":"Paragraph:d31608dd9b56_106"},{"__ref":"Paragraph:d31608dd9b56_107"},{"__ref":"Paragraph:d31608dd9b56_108"},{"__ref":"Paragraph:d31608dd9b56_109"},{"__ref":"Paragraph:d31608dd9b56_110"},{"__ref":"Paragraph:d31608dd9b56_111"},{"__ref":"Paragraph:d31608dd9b56_112"},{"__ref":"Paragraph:d31608dd9b56_113"},{"__ref":"Paragraph:d31608dd9b56_114"},{"__ref":"Paragraph:d31608dd9b56_115"},{"__ref":"Paragraph:d31608dd9b56_116"},{"__ref":"Paragraph:d31608dd9b56_117"},{"__ref":"Paragraph:d31608dd9b56_118"},{"__ref":"Paragraph:d31608dd9b56_119"},{"__ref":"Paragraph:d31608dd9b56_120"},{"__ref":"Paragraph:d31608dd9b56_121"},{"__ref":"Paragraph:d31608dd9b56_122"},{"__ref":"Paragraph:d31608dd9b56_123"},{"__ref":"Paragraph:d31608dd9b56_124"},{"__ref":"Paragraph:d31608dd9b56_125"},{"__ref":"Paragraph:d31608dd9b56_126"},{"__ref":"Paragraph:d31608dd9b56_127"},{"__ref":"Paragraph:d31608dd9b56_128"},{"__ref":"Paragraph:d31608dd9b56_129"},{"__ref":"Paragraph:d31608dd9b56_130"},{"__ref":"Paragraph:d31608dd9b56_131"},{"__ref":"Paragraph:d31608dd9b56_132"},{"__ref":"Paragraph:d31608dd9b56_133"},{"__ref":"Paragraph:d31608dd9b56_134"},{"__ref":"Paragraph:d31608dd9b56_135"},{"__ref":"Paragraph:d31608dd9b56_136"},{"__ref":"Paragraph:d31608dd9b56_137"},{"__ref":"Paragraph:d31608dd9b56_138"},{"__ref":"Paragraph:d31608dd9b56_139"},{"__ref":"Paragraph:d31608dd9b56_140"},{"__ref":"Paragraph:d31608dd9b56_141"},{"__ref":"Paragraph:d31608dd9b56_142"},{"__ref":"Paragraph:d31608dd9b56_143"},{"__ref":"Paragraph:d31608dd9b56_144"},{"__ref":"Paragraph:d31608dd9b56_145"}]},"validatedShareKey":"","shareKeyCreator":null},"creator":{"__ref":"User:f375cbce3f63"},"inResponseToEntityType":null,"isLocked":false,"isMarkedPaywallOnly":false,"lockedSource":"LOCKED_POST_SOURCE_NONE","mediumUrl":"https:\u002F\u002Felis531989.medium.com\u002Fdancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4","primaryTopic":{"__ref":"Topic:decb52b64abf"},"topics":[{"__typename":"Topic","slug":"programming"}],"isPublished":true,"latestPublishedVersion":"d31608dd9b56","visibility":"PUBLIC","postResponses":{"__typename":"PostResponses","count":0},"clapCount":21,"allowResponses":true,"isLimitedState":false,"title":"Dancing With Shellcodes: Cracking the latest version of Guloader","isSeries":false,"sequence":null,"uniqueSlug":"dancing-with-shellcodes-cracking-the-latest-version-of-guloader-75083fb15cb4","socialTitle":"","socialDek":"","canonicalUrl":"","metaDescription":"","latestPublishedAt":1618820866240,"readingTime":13.410377358490567,"previewContent":{"__typename":"PreviewContent","subtitle":"Guloader is a downloader that has been active since 2019. It is known to deliver various malware, more notably: Agent-Tesla, Netwire…"},"previewImage":{"__ref":"ImageMetadata:1*AGnUYCr0wHlKClBD5EpK-g.png"},"isShortform":false,"seoTitle":"","firstPublishedAt":1618820866240,"updatedAt":1641515922598,"shortformType":"SHORTFORM_TYPE_LINK","seoDescription":"","viewerEdge":{"__ref":"PostViewerEdge:postId:75083fb15cb4-viewerId:lo_1a6531903e22"},"isSuspended":false,"license":"ALL_RIGHTS_RESERVED","tags":[{"__ref":"Tag:shellcode"},{"__ref":"Tag:malware"},{"__ref":"Tag:reverse-engineering"},{"__ref":"Tag:debugging"}],"isNewsletter":false,"statusForCollection":null,"pendingCollection":null,"detectedLanguage":"en","wordCount":2772,"layerCake":3}}</script><script>window.__MIDDLEWARE_STATE__={"session":{"xsrf":""},"cache":{"cacheStatus":"MISS"}}</script><script src="https://cdn-client.medium.com/lite/static/js/manifest.7e50e797.js"></script><script src="https://cdn-client.medium.com/lite/static/js/9865.1496d74a.js"></script><script src="https://cdn-client.medium.com/lite/static/js/main.018e7ca9.js"></script><script src="https://cdn-client.medium.com/lite/static/js/instrumentation.d9108df7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/reporting.ff22a7a5.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5049.d1ead72d.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4810.6318add7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6618.db187378.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1386.6a7a21a1.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9977.84e4bd5c.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/719.ae4dd3e0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5250.9f9e01d2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6349.b071a958.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2648.26563adf.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8393.826a25fb.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1443.598cb8b2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/3735.8c38ede2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5642.d10c9ba0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6546.cd03f950.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6834.08de95de.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1781.db373833.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2420.0330d157.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/839.ca7937c2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7975.d195c6f1.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2106.21ff89d3.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7394.55c925ce.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2961.00a48598.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/230.4d7a2738.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4391.59acaed3.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/PostPage.MainContent.563d0db5.chunk.js"></script><script>window.main();</script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'8d7627dd1c59cb60',t:'MTcyOTczMjk0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body></html>