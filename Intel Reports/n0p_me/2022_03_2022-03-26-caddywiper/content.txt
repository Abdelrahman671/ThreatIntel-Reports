<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'self'; font-src 'self' disqus.com disquscdn.com *.disqus.com *.disquscdn.com; form-action 'self' https://syndication.twitter.com/ https://platform.twitter.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; frame-src 'self' https://cse.google.com https://player.vimeo.com www.youtube.com www.youtube-nocookie.com https://platform.twitter.com https://syndication.twitter.com  jsfiddle.net www.instagram.com https://kuula.co https://www.slideshare.net https://www.google.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; img-src 'self' https://www.google-analytics.com *.gstatic.com *.amazon-adsystem.com https://www.googleapis.com https://images-na.ssl-images-amazon.com https://platform.twitter.com *.twimg.com https://syndication.twitter.com data: https://files.kuula.io disqus.com disquscdn.com *.disqus.com *.disquscdn.com; object-src 'none'; style-src 'self' https://use.fontawesome.com https://fonts.googleapis.com https://www.google.com https://platform.twitter.com *.twimg.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; script-src 'self' 'nonce-2726c7f26c' https://www.google-analytics.com https://www.googletagmanager.com https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; prefetch-src 'self' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; connect-src 'self'  https://www.google-analytics.com https://platform.twitter.com https://static.cloudflareinsights.com https://geo.privacymanager.io/ disqus.com disquscdn.com *.disqus.com *.disquscdn.com; script-src-elem 'self' 'nonce-2726c7f26c' *.disqus.com https://static.cloudflareinsights.com/; style-src-attr 'self' 'unsafe-inline'">
        <meta http-equiv="X-XSS-Protection" content="1; mode=block">
        <meta name="keywords" content="[Infosec Blue Team Linux]"/>
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Analysis of a Caddy Wiper Sample Targeting Ukraine - n0p Blog</title><meta name="Description" content="Reverse Engineering of a Caddy Wiper Sample targeting Ukraine"><meta property="og:title" content="Analysis of a Caddy Wiper Sample Targeting Ukraine" />
<meta property="og:description" content="Reverse Engineering of a Caddy Wiper Sample targeting Ukraine" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.n0p.me/2022/03/2022-03-26-caddywiper/" /><meta property="og:image" content="https://blog.n0p.me/img/caddywiper/wiper-ghidra-2.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-03-26T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.n0p.me/img/caddywiper/wiper-ghidra-2.png"/>

<meta name="twitter:title" content="Analysis of a Caddy Wiper Sample Targeting Ukraine"/>
<meta name="twitter:description" content="Reverse Engineering of a Caddy Wiper Sample targeting Ukraine"/>
<meta name="application-name" content="n0p Blog">
<meta name="apple-mobile-web-app-title" content="n0p Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.n0p.me/2022/03/2022-03-26-caddywiper/" /><link rel="prev" href="https://blog.n0p.me/2022/03/2022-03-03-tcpshark/" /><link rel="next" href="https://blog.n0p.me/2022/12/2022-12-29-books-i-read/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script nonce="2726c7f26c" type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Analysis of a Caddy Wiper Sample Targeting Ukraine",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.n0p.me\/2022\/03\/2022-03-26-caddywiper\/"
        },"genre": "posts","keywords": "malware, windows, yara","wordcount":  2159 ,
        "url": "https:\/\/blog.n0p.me\/2022\/03\/2022-03-26-caddywiper\/","datePublished": "2022-03-26T00:00:00+00:00","dateModified": "2022-03-26T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Ali Mosajjal"},"author": {
                "@type": "Person",
                "name": "Ali Mosajjal"
            },"description": "Reverse Engineering of a Caddy Wiper Sample targeting Ukraine"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script nonce="2726c7f26c" type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="n0p Blog">n0p Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts"> Posts </a><a class="menu-item" href="/tags"> Tags </a><a class="menu-item" href="/categories"> Categories </a><a class="menu-item" href="/projects"> Projects </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="n0p Blog">n0p Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts" title="">Posts</a><a class="menu-item" href="/tags" title="">Tags</a><a class="menu-item" href="/categories" title="">Categories</a><a class="menu-item" href="/projects" title="">Projects</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Analysis of a Caddy Wiper Sample Targeting Ukraine</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Ali Mosajjal</a></span>&nbsp;<span class="post-category">included in <a href="/categories/windows/"><i class="far fa-folder fa-fw"></i>Windows</a>&nbsp;<a href="/categories/malware/"><i class="far fa-folder fa-fw"></i>Malware</a>&nbsp;<a href="/categories/security/"><i class="far fa-folder fa-fw"></i>security</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-26">2022-03-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2159 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;11 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#main-function-analysis">Main function Analysis</a></li>
    <li><a href="#the-wiper-function">The wiper function</a>
      <ul>
        <li><a href="#subfunction-fun_00402a80">Subfunction <code>FUN_00402a80</code></a></li>
        <li><a href="#subfunction-fun_00401530">subfunction <code>FUN_00401530</code></a></li>
      </ul>
    </li>
    <li><a href="#other-interesting-functions">Other Interesting Functions</a>
      <ul>
        <li><a href="#fun_00401a10"><code>FUN_00401a10</code></a></li>
      </ul>
    </li>
    <li><a href="#putting-it-all-together">Putting it all together</a></li>
    <li><a href="#detection">Detection</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="analysis-of-a-caddy-wiper-sample">Analysis of a Caddy Wiper Sample</h1>
<h2 id="introduction">Introduction</h2>
<p>CaddyWiper was first <a href="https://www.welivesecurity.com/2022/03/15/caddywiper-new-wiper-malware-discovered-ukraine/" target="_blank" rel="noopener noreffer">reported</a> by ESET as below:</p>
<blockquote>
<p>Dubbed CaddyWiper by ESET analysts, the malware was first detected at 11.38 a.m. local time (9.38 a.m. UTC) on Monday. The wiper, which destroys user data and partition information from attached drives, was spotted on several dozen systems in a limited number of organizations. It is detected by ESET products as Win32/KillDisk.NCX.</p>
</blockquote>
<p>One of my friends pinged me a few days later with <a href="https://bazaar.abuse.ch/download/a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea/" target="_blank" rel="noopener noreffer">a link</a> to a CaddyWiper sample. Since this sample was a particularly small one, I decided to write a blog post going through each function from scratch and introducing the tools I used to make my life easier. Hopefully, this can serve as a reference to junior malware analysts who want to get started with this craft.</p>
<p>First off, I&rsquo;m a Linux user myself and I use mainly Linux tools to analyse malware. <code>pev</code> is a set command-line utilities providing a high level analysis of a <code>PE</code> binary. It consists of the following tools</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ofs2rva
</span></span><span class="line"><span class="cl">pedis
</span></span><span class="line"><span class="cl">pehash
</span></span><span class="line"><span class="cl">peldd
</span></span><span class="line"><span class="cl">pepack
</span></span><span class="line"><span class="cl">peres
</span></span><span class="line"><span class="cl">pescan
</span></span><span class="line"><span class="cl">pesec
</span></span><span class="line"><span class="cl">pestr
</span></span><span class="line"><span class="cl">readpe
</span></span><span class="line"><span class="cl">rva2ofs
</span></span></code></pre></td></tr></table>
</div>
</div><p>running <code>pehash</code> on the sample offers the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">filepath:                        a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea.exe
</span></span><span class="line"><span class="cl">md5:                             42e52b8daf63e6e26c3aa91e7e971492
</span></span><span class="line"><span class="cl">sha1:                            98b3fb74b3e8b3f9b05a82473551c5a77b576d54
</span></span><span class="line"><span class="cl">sha256:                          a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea
</span></span><span class="line"><span class="cl">ssdeep:                          192:76f0CW5P2Io4evFrDv2ZRJzCn7URRsjVJaZF:76fPWl24evFrT2ZR5Cn7UR0VJo
</span></span><span class="line"><span class="cl">imphash:                         ea8609d4dad999f73ec4b6f8e7b28e55
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>readpe</code> result:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DOS Header
</span></span><span class="line"><span class="cl">    Magic number:                    0x5a4d (MZ)
</span></span><span class="line"><span class="cl">    Bytes in last page:              144
</span></span><span class="line"><span class="cl">    Pages in file:                   3
</span></span><span class="line"><span class="cl">    Relocations:                     0
</span></span><span class="line"><span class="cl">    Size of header in paragraphs:    4
</span></span><span class="line"><span class="cl">    Minimum extra paragraphs:        0
</span></span><span class="line"><span class="cl">    Maximum extra paragraphs:        65535
</span></span><span class="line"><span class="cl">    Initial (relative) SS value:     0
</span></span><span class="line"><span class="cl">    Initial SP value:                0xb8
</span></span><span class="line"><span class="cl">    Initial IP value:                0
</span></span><span class="line"><span class="cl">    Initial (relative) CS value:     0
</span></span><span class="line"><span class="cl">    Address of relocation table:     0x40
</span></span><span class="line"><span class="cl">    Overlay number:                  0
</span></span><span class="line"><span class="cl">    OEM identifier:                  0
</span></span><span class="line"><span class="cl">    OEM information:                 0
</span></span><span class="line"><span class="cl">    PE header offset:                0xc8
</span></span><span class="line"><span class="cl">COFF/File header
</span></span><span class="line"><span class="cl">    Machine:                         0x14c IMAGE_FILE_MACHINE_I386
</span></span><span class="line"><span class="cl">    Number of sections:              3
</span></span><span class="line"><span class="cl">    Date/time stamp:                 1647242376 (Mon, 14 Mar 2022 07:19:36 UTC)
</span></span><span class="line"><span class="cl">    Symbol Table offset:             0
</span></span><span class="line"><span class="cl">    Number of symbols:               0
</span></span><span class="line"><span class="cl">    Size of optional header:         0xe0
</span></span><span class="line"><span class="cl">    Characteristics:                 0x102
</span></span><span class="line"><span class="cl">    Characteristics names
</span></span><span class="line"><span class="cl">                                         IMAGE_FILE_EXECUTABLE_IMAGE
</span></span><span class="line"><span class="cl">                                         IMAGE_FILE_32BIT_MACHINE
</span></span><span class="line"><span class="cl">Optional/Image header
</span></span><span class="line"><span class="cl">    Magic number:                    0x10b (PE32)
</span></span><span class="line"><span class="cl">    Linker major version:            10
</span></span><span class="line"><span class="cl">    Linker minor version:            0
</span></span><span class="line"><span class="cl">    Size of .text section:           0x1c00
</span></span><span class="line"><span class="cl">    Size of .data section:           0x400
</span></span><span class="line"><span class="cl">    Size of .bss section:            0
</span></span><span class="line"><span class="cl">    Entrypoint:                      0x1000
</span></span><span class="line"><span class="cl">    Address of .text section:        0x1000
</span></span><span class="line"><span class="cl">    Address of .data section:        0x3000
</span></span><span class="line"><span class="cl">    ImageBase:                       0x400000
</span></span><span class="line"><span class="cl">    Alignment of sections:           0x1000
</span></span><span class="line"><span class="cl">    Alignment factor:                0x200
</span></span><span class="line"><span class="cl">    Major version of required OS:    5
</span></span><span class="line"><span class="cl">    Minor version of required OS:    1
</span></span><span class="line"><span class="cl">    Major version of image:          0
</span></span><span class="line"><span class="cl">    Minor version of image:          0
</span></span><span class="line"><span class="cl">    Major version of subsystem:      5
</span></span><span class="line"><span class="cl">    Minor version of subsystem:      1
</span></span><span class="line"><span class="cl">    Size of image:                   0x5000
</span></span><span class="line"><span class="cl">    Size of headers:                 0x400
</span></span><span class="line"><span class="cl">    Checksum:                        0
</span></span><span class="line"><span class="cl">    Subsystem required:              0x2 (IMAGE_SUBSYSTEM_WINDOWS_GUI)
</span></span><span class="line"><span class="cl">    DLL characteristics:             0x8140
</span></span><span class="line"><span class="cl">    DLL characteristics names
</span></span><span class="line"><span class="cl">                                         IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE
</span></span><span class="line"><span class="cl">                                         IMAGE_DLLCHARACTERISTICS_NX_COMPAT
</span></span><span class="line"><span class="cl">                                         IMAGE_DLLCHARACTERISTICS_TERMINAL_SERVER_AWARE
</span></span><span class="line"><span class="cl">    Size of stack to reserve:        0x100000
</span></span><span class="line"><span class="cl">    Size of stack to commit:         0x1000
</span></span><span class="line"><span class="cl">    Size of heap space to reserve:   0x100000
</span></span><span class="line"><span class="cl">    Size of heap space to commit:    0x1000
</span></span><span class="line"><span class="cl">Data directories
</span></span><span class="line"><span class="cl">    Directory
</span></span><span class="line"><span class="cl">        IMAGE_DIRECTORY_ENTRY_IMPORT:    0x3008 (40 bytes)
</span></span><span class="line"><span class="cl">    Directory
</span></span><span class="line"><span class="cl">        IMAGE_DIRECTORY_ENTRY_BASERELOC: 0x4000 (12 bytes)
</span></span><span class="line"><span class="cl">    Directory
</span></span><span class="line"><span class="cl">        IMAGE_DIRECTORY_ENTRY_IAT:       0x3000 (8 bytes)
</span></span><span class="line"><span class="cl">Imported functions
</span></span><span class="line"><span class="cl">    Library
</span></span><span class="line"><span class="cl">        Name:                            NETAPI32.dll
</span></span><span class="line"><span class="cl">        Functions
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            39
</span></span><span class="line"><span class="cl">                Name:                            DsRoleGetPrimaryDomainInformation
</span></span><span class="line"><span class="cl">Exported functions
</span></span><span class="line"><span class="cl">Sections
</span></span><span class="line"><span class="cl">    Section
</span></span><span class="line"><span class="cl">        Name:                            .text
</span></span><span class="line"><span class="cl">        Virtual Size:                    0x1b4a (6986 bytes)
</span></span><span class="line"><span class="cl">        Virtual Address:                 0x1000
</span></span><span class="line"><span class="cl">        Size Of Raw Data:                0x1c00 (7168 bytes)
</span></span><span class="line"><span class="cl">        Pointer To Raw Data:             0x400
</span></span><span class="line"><span class="cl">        Number Of Relocations:           0
</span></span><span class="line"><span class="cl">        Characteristics:                 0x60000020
</span></span><span class="line"><span class="cl">        Characteristic Names
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_CNT_CODE
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_MEM_EXECUTE
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_MEM_READ
</span></span><span class="line"><span class="cl">    Section
</span></span><span class="line"><span class="cl">        Name:                            .rdata
</span></span><span class="line"><span class="cl">        Virtual Size:                    0x6a (106 bytes)
</span></span><span class="line"><span class="cl">        Virtual Address:                 0x3000
</span></span><span class="line"><span class="cl">        Size Of Raw Data:                0x200 (512 bytes)
</span></span><span class="line"><span class="cl">        Pointer To Raw Data:             0x2000
</span></span><span class="line"><span class="cl">        Number Of Relocations:           0
</span></span><span class="line"><span class="cl">        Characteristics:                 0x40000040
</span></span><span class="line"><span class="cl">        Characteristic Names
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_CNT_INITIALIZED_DATA
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_MEM_READ
</span></span><span class="line"><span class="cl">    Section
</span></span><span class="line"><span class="cl">        Name:                            .reloc
</span></span><span class="line"><span class="cl">        Virtual Size:                    0x18 (24 bytes)
</span></span><span class="line"><span class="cl">        Virtual Address:                 0x4000
</span></span><span class="line"><span class="cl">        Size Of Raw Data:                0x200 (512 bytes)
</span></span><span class="line"><span class="cl">        Pointer To Raw Data:             0x2200
</span></span><span class="line"><span class="cl">        Number Of Relocations:           0
</span></span><span class="line"><span class="cl">        Characteristics:                 0x42000040
</span></span><span class="line"><span class="cl">        Characteristic Names
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_CNT_INITIALIZED_DATA
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_MEM_DISCARDABLE
</span></span><span class="line"><span class="cl">                                             IMAGE_SCN_MEM_READ
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you&rsquo;re new to analyzing a PE, I highly recommend looking at <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-**format**" target="_blank" rel="noopener noreffer">the official Microsoft documents for PE Format</a>. Some notes from the link:</p>
<blockquote>
<p>At location 0x3c, the stub has the file offset to the PE signature. This information enables Windows to properly execute the image file, even though it has an MS-DOS stub. This file offset is placed at location 0x3c during linking.
After the MS-DOS stub, at the file offset specified at offset 0x3c, is a 4-byte signature that identifies the file as a PE format image file. This signature is &ldquo;PE\0\0&rdquo; (the letters &ldquo;P&rdquo; and &ldquo;E&rdquo; followed by two null bytes).</p>
</blockquote>
<h2 id="main-function-analysis">Main function Analysis</h2>
<p>the main function starts at <code>00401000</code> and it looks like it doesn&rsquo;t return a status code. in <code>c</code> terms, it means the <code>main</code> function is written like so:
<code>void main(...)</code>.</p>
<p>In the main function, we can see a call to the external function <a href="https://docs.microsoft.com/en-us/windows/win32/api/dsrole/nf-dsrole-dsrolegetprimarydomaininformation" target="_blank" rel="noopener noreffer"><code>DsRoleGetPrimaryDomainInformation</code></a> at <code>0040113a</code>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-1.png"
        data-srcset="/img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-1.png, /img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-1.png 1.5x, /img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-1.png 2x"
        data-sizes="auto"
        alt="/img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-1.png"
        title="ghidra-1" /></p>
<p>according to Microsoft documentation, The <code>DsRoleGetPrimaryDomainInformation</code> function retrieves state data for the computer. This data includes the state of the directory service installation and domain data.</p>
<p>If we take a closer look at the function call, we can see that the function has been called with 3 parameters: <code>DsRoleGetPrimaryDomainInformation(0,1,&amp;empty_int_pointer);</code>. the 0 refers to the <code>lpServer</code> parameter, meaning the function will be called on the local computer (refer to the link above for more info on that). The <code>1</code> is the <code>InfoLevel</code> parameter, which specifies the level of output needed, as well as the type of output being pushed to our <code>empty_int_pointer</code>. referring to <a href="https://docs.microsoft.com/en-us/windows/win32/api/dsrole/ne-dsrole-dsrole_primary_domain_info_level" target="_blank" rel="noopener noreffer">Microsoft Documentation</a>, we can see <code>1</code> refers to the first item in the C++ enum, which is <code>DsRolePrimaryDomainInfoBasic</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">enum</span> <span class="nc">_DSROLE_PRIMARY_DOMAIN_INFO_LEVEL</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRolePrimaryDomainInfoBasic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRoleUpgradeStatus</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRoleOperationState</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DSROLE_PRIMARY_DOMAIN_INFO_LEVEL</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we follow the docs, it&rsquo;ll mention our output type as <code>DSROLE_PRIMARY_DOMAIN_INFO_BASIC</code>, and refers to <a href="https://docs.microsoft.com/en-us/windows/win32/api/dsrole/ns-dsrole-dsrole_primary_domain_info_basic" target="_blank" rel="noopener noreffer">this page</a>. Looks like our return value will be in this struct:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_DSROLE_PRIMARY_DOMAIN_INFO_BASIC</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">DSROLE_MACHINE_ROLE</span> <span class="n">MachineRole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ULONG</span>               <span class="n">Flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LPWSTR</span>              <span class="n">DomainNameFlat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LPWSTR</span>              <span class="n">DomainNameDns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">LPWSTR</span>              <span class="n">DomainForestName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">GUID</span>                <span class="n">DomainGuid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DSROLE_PRIMARY_DOMAIN_INFO_BASIC</span><span class="p">,</span> <span class="o">*</span><span class="n">PDSROLE_PRIMARY_DOMAIN_INFO_BASIC</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>clearly the attack is interested in <code>MachineRole</code>, and compares it with value <code>5</code>. Let&rsquo;s dig deeper to see what <code>5</code> means. If we go to <a href="https://docs.microsoft.com/en-us/windows/win32/api/dsrole/ne-dsrole-dsrole_machine_role" target="_blank" rel="noopener noreffer">this doc</a>, we&rsquo;ll see the following <code>enum</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">enum</span> <span class="nc">_DSROLE_MACHINE_ROLE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRole_RoleStandaloneWorkstation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRole_RoleMemberWorkstation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRole_RoleStandaloneServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRole_RoleMemberServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRole_RoleBackupDomainController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DsRole_RolePrimaryDomainController</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DSROLE_MACHINE_ROLE</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>5</code> is the primary Domain Controller. Looking at the code, you can see the attacker does not intend to attack the primary DC, and will skip them.</p>
<p>After getting all the info, I started to rename the functions and add a bit of comment, as well as converting types in Ghidra to make sure it&rsquo;s readable:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-2.png"
        data-srcset="/img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-2.png, /img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-2.png 1.5x, /img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-2.png 2x"
        data-sizes="auto"
        alt="/img/caddywiper/DsRoleGetPrimaryDomainInformation-ghidra-2.png"
        title="ghidra-1" /></p>
<p>Now we can see there&rsquo;s a <code>wiper</code> function, which runs on <code>C:\\Users</code> as well as <code>D:\\</code> for 24 chars (<code>E:\\, F:\\, ...</code>), which means basically all drive letters.</p>
<p>let&rsquo;s go take a look at the <code>wiper</code> function. That&rsquo;s where the attacker&rsquo;s malicious code is located.</p>
<h2 id="the-wiper-function">The wiper function</h2>
<p>The function itself is a <code>void</code> one. Meaning the attacker didn&rsquo;t really care if the wiping is successful or not. Reading a bit of the function itself, the first bit of interesting information is seen at line ~180. There seems to be another function, that gets called with both <code>*</code> and <code>\\</code> values.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/caddywiper/wiper-ghidra-1.png"
        data-srcset="/img/caddywiper/wiper-ghidra-1.png, /img/caddywiper/wiper-ghidra-1.png 1.5x, /img/caddywiper/wiper-ghidra-1.png 2x"
        data-sizes="auto"
        alt="/img/caddywiper/wiper-ghidra-1.png"
        title="ghidra-wiper-1" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FUN_00402a80</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">local_ccc</span><span class="p">,</span><span class="n">param_1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_e44</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">FUN_00402a80</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">local_89c</span><span class="p">,</span><span class="n">local_ccc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_e20</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After digging around the <code>wipe</code> function, you can see <code>kernel32.dll</code> as a stack string with these functions being called from it (in order):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FindFirstFileA
</span></span><span class="line"><span class="cl">FindNextFileA
</span></span><span class="line"><span class="cl">CreateFileA
</span></span><span class="line"><span class="cl">GetFileSize
</span></span><span class="line"><span class="cl">LocalAlloc
</span></span><span class="line"><span class="cl">SetFilePointer
</span></span><span class="line"><span class="cl">WriteFile
</span></span><span class="line"><span class="cl">LocalFree
</span></span><span class="line"><span class="cl">CloseHandle
</span></span><span class="line"><span class="cl">FindClose
</span></span></code></pre></td></tr></table>
</div>
</div><p>All above functions are thoroughly documented in <a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/" target="_blank" rel="noopener noreffer">Microsoft&rsquo;s official Win32 API Docs</a></p>
<p>Essentially, the wiper is looking for all the files under <code>C:\Users</code> and <code>D:</code> through <code>Z:</code> and tries to enumerate the first file within those directories (with <code>FindFirstFileA</code>), then enumerates through the folders with <code>FindNextFileA</code>, opens the file, scrambles the header of each file, and does it across all folder recursively. Here&rsquo;s the main <code>wiper</code> function with function names and syscalls somewhat renamed to a more readable format</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/caddywiper/wiper-ghidra-2.png"
        data-srcset="/img/caddywiper/wiper-ghidra-2.png, /img/caddywiper/wiper-ghidra-2.png 1.5x, /img/caddywiper/wiper-ghidra-2.png 2x"
        data-sizes="auto"
        alt="/img/caddywiper/wiper-ghidra-2.png"
        title="ghidra-Wiper-2" /></p>
<h3 id="subfunction-fun_00402a80">Subfunction <code>FUN_00402a80</code></h3>
<p>Before we rename this function to something human-readable, we should know what it does. Here&rsquo;s the pseudo-code of the function itself:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/caddywiper/wiper-subfunction-1.png"
        data-srcset="/img/caddywiper/wiper-subfunction-1.png, /img/caddywiper/wiper-subfunction-1.png 1.5x, /img/caddywiper/wiper-subfunction-1.png 2x"
        data-sizes="auto"
        alt="/img/caddywiper/wiper-subfunction-1.png"
        title="wiper-subfunction-1" /></p>
<p>The function appears to concat two strings together with a couple of <code>while</code> loops and put them in the first parameter&rsquo;s pointer. in <code>python</code> terms, it basically means <code>param_1 = param_2 + param_3</code>. From now on, I&rsquo;ll refer to <code>FUN_00402a80</code> as <code>concat</code></p>
<h3 id="subfunction-fun_00401530">subfunction <code>FUN_00401530</code></h3>
<p>After concatenating the paths with <code>*</code> and <code>\\</code>, <code>FUN_00401530</code> gets called with two parameters: <code>findFirstFileA</code> and <code>kernel32.dll</code>, as specified in lines directly after calling the two concat functions (line 190 to 200 inside the <code>wipe</code> function in Ghidra).</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/img/caddywiper/wiper-subfunction-2.png"
        data-srcset="/img/caddywiper/wiper-subfunction-2.png, /img/caddywiper/wiper-subfunction-2.png 1.5x, /img/caddywiper/wiper-subfunction-2.png 2x"
        data-sizes="auto"
        alt="/img/caddywiper/wiper-subfunction-2.png"
        title="wiper-subfunction-2" /></p>
<p>Even though the logic of the function seems complicated, from what it gets and produces as an output, it&rsquo;s safe to assume the function is a Win32 API client. The DLL filename as well as the specific functionality is pushed to the function and the result is an integer that corresponds to the API response code. From now on, I&rsquo;ll refer to <code>FUN_00401530</code> as <code>syscall_wrapper</code></p>
<h2 id="other-interesting-functions">Other Interesting Functions</h2>
<h3 id="fun_00401a10"><code>FUN_00401a10</code></h3>
<p>Using the same trick we did before, it&rsquo;s easy to see this function using the same <code>syscall_wrapper</code> to invoke multiple functions from <code>advapi32.dll</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SetEntriesInAclA
</span></span><span class="line"><span class="cl">AllocateAndInitializeSid
</span></span><span class="line"><span class="cl">SetNamedSecurityInfoA
</span></span><span class="line"><span class="cl">GetCurrentProcess
</span></span><span class="line"><span class="cl">OpenProcessToken
</span></span><span class="line"><span class="cl">SeTakeOwnershipPrivilege
</span></span><span class="line"><span class="cl">FreeSid
</span></span><span class="line"><span class="cl">LocalFree
</span></span><span class="line"><span class="cl">CloseHandle
</span></span></code></pre></td></tr></table>
</div>
</div><p>This function looks to be looking into each particular file&rsquo;s ownership and tries to get around some ACLs and &ldquo;access denied&rdquo; errors that it comes across. I would describe it as a basic way to try to make a file writable enough so it can destroy it. Although I didn&rsquo;t read each individual syscall to back that claim. <code>FUN_00401750</code> is the main carrier of this operation. In <code>FUN_00401750</code>, we can see the following functions:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">LookupPrivilegeValueA
</span></span><span class="line"><span class="cl">AdjustTokenPrivileges
</span></span><span class="line"><span class="cl">GetLastError
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>FUN_00401750</code> simply tries to see if the malware has enough permission to change permissions on a file. I&rsquo;ll rename it to <code>priv_check</code>.</p>
<p>As a result, based on my guess, <code>FUN_00401a10</code> is renamed to <code>priv_set</code></p>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>This is a small Malware sample, and it&rsquo;s effective and fast. In a nutshell, this is what the attack vector had in mind</p>
<ul>
<li>Checks if the Computer is a primary domain controller or not. If not, it leaves it behind and doesn&rsquo;t wipe it.</li>
<li>It identifies C:\Users and D: through Z: as primary attack targets</li>
<li>Recursively:
<ul>
<li>Finds the first file in the folder</li>
<li>Tries to see the permission it has to write to the file</li>
<li>Tries elevating privileges to gain permission to write to the file</li>
<li>Opens the file in write mode</li>
<li>rewrites the file header with gibberish</li>
<li>Close the file</li>
</ul>
</li>
</ul>
<p>Interestingly, If you run the binary through something like the <code>strings</code> command, you&rsquo;ll only see a few strings, like so</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">strings a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea.exe
</span></span><span class="line"><span class="cl">!This program cannot be run in DOS mode.
</span></span><span class="line"><span class="cl">Rich%
</span></span><span class="line"><span class="cl">.text
</span></span><span class="line"><span class="cl">`.rdata
</span></span><span class="line"><span class="cl">@.reloc
</span></span><span class="line"><span class="cl">DsRoleGetPrimaryDomainInformation
</span></span><span class="line"><span class="cl">NETAPI32.dll
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is because the attacker is making use of <code>stack strings</code>. <a href="https://rioasmara.com/2020/10/20/evade-strings-detection-with-stack-based/" target="_blank" rel="noopener noreffer">This link</a> has a good explanation of what are stack strings and how are they used to avoid detection.</p>
<h2 id="detection">Detection</h2>
<p>The easiest detection for this particular sample could be a hash value. But since this malware is small, hashes, even <code>ssdeep</code> are not a very good idea. Let&rsquo;s try to build a YARA rule that defines what we learned from the malware.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">rule</span> <span class="n">caddywiper</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nl">meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">author</span> <span class="o">=</span> <span class="s">&#34;Ali Mosajjal&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">email</span> <span class="o">=</span> <span class="s">&#34;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="147c7d547a24643a7971">[email&#160;protected]</a>&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">license</span> <span class="o">=</span> <span class="s">&#34;Apache 2.0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">description</span> <span class="o">=</span> <span class="s">&#34;Caddy Wiper Stack String Detection&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nl">strings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="err">$</span><span class="n">s1</span> <span class="o">=</span> <span class="o">/</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">n</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">d</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">r</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">s</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">A</span><span class="o">/</span>      <span class="c1">// FindFirstFileA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s2</span> <span class="o">=</span> <span class="o">/</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">n</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">d</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">N</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">x</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">A</span><span class="o">/</span>           <span class="c1">// FindNextFileA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s3</span> <span class="o">=</span> <span class="o">/</span><span class="n">C</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">r</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">a</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">A</span><span class="o">/</span>                     <span class="c1">// CreateFileA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s4</span> <span class="o">=</span> <span class="o">/</span><span class="n">G</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">S</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">z</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="o">/</span>                     <span class="c1">// GetFileSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s5</span> <span class="o">=</span> <span class="o">/</span><span class="n">L</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">o</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">c</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">a</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">A</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">o</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">c</span><span class="o">/</span>                          <span class="c1">// LocalAlloc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s6</span> <span class="o">=</span> <span class="o">/</span><span class="n">S</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">P</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">o</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">n</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">r</span><span class="o">/</span>      <span class="c1">// SetFilePointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s7</span> <span class="o">=</span> <span class="o">/</span><span class="n">W</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">r</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">t</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">e</span><span class="o">/</span>                               <span class="c1">// WriteFile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s8</span> <span class="o">=</span> <span class="o">/</span><span class="n">L</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">o</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">c</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">a</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">F</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">r</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="o">/</span>                               <span class="c1">// LocalFree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s9</span> <span class="o">=</span> <span class="o">/</span><span class="n">C</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">o</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">s</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">H</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">a</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">n</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">d</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">6</span><span class="p">}</span><span class="n">e</span><span class="o">/</span>                     <span class="c1">// CloseHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">$</span><span class="n">s10</span> <span class="o">=</span> <span class="o">/</span><span class="n">F</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">i</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">n</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">d</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">C</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">l</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">o</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">s</span><span class="p">.{</span><span class="mi">3</span><span class="p">}</span><span class="n">e</span><span class="o">/</span>                              <span class="c1">// FindClose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nl">condition</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">all</span> <span class="n">of</span> <span class="p">(</span><span class="err">$</span><span class="n">s</span><span class="o">*</span><span class="p">)</span> <span class="n">and</span> <span class="n">filesize</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="n">KB</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we saw, since the attacker was clever enough to use Stack String, our YARA rule is going to be slow and regex-y but it still works. Interestingly, for <code>WriteFile</code> and <code>FindClose</code> I had to adjust my regex to factor in the slightly smaller <code>MOV</code> assembly code. I&rsquo;ve also put a file size cap on the sample to ignore potentially different variants of this malware.</p>
<p>As an exercise, you can create similar detection for the <code>dll</code> files, which are a bit trickier considering they&rsquo;re both <code>wide</code> strings and Stack Strings.</p>
<p>Hope you enjoyed this brief analysis. I&rsquo;ll put the Ghidra zipped file alongside the scripts, comments etc in a Github Repo if anyone is interested. Let me know what Malware should I dissect next :)</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-03-26</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/malware/">malware</a>,&nbsp;<a href="/tags/windows/">windows</a>,&nbsp;<a href="/tags/yara/">yara</a></section>
        <section>
            <span><a href="javascript:void(0);">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022/03/2022-03-03-tcpshark/" class="prev" rel="prev" title="tcpshark - process-aware tcpdump"><i class="fas fa-angle-left fa-fw"></i>tcpshark - process-aware tcpdump</a>
            <a href="/2022/12/2022-12-29-books-i-read/" class="next" rel="next" title="The books I read in 2022">The books I read in 2022<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.106.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Ali Mosajjal</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script nonce="2726c7f26c" type="text/javascript" src="https://n0p-me.disqus.com/embed.js" defer></script><script nonce="2726c7f26c" type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script nonce="2726c7f26c" type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script nonce="2726c7f26c" type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script nonce="2726c7f26c" type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script nonce="2726c7f26c" type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script nonce="2726c7f26c" type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30}};</script><script nonce="2726c7f26c" type="text/javascript" src="/js/theme.min.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"8f3cd3eaca6064ed","version":"2024.10.5","r":1,"serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"token":"5c2225c356284dc6989dbbc09001789b","b":1}' crossorigin="anonymous"></script>
</body>
</html>
