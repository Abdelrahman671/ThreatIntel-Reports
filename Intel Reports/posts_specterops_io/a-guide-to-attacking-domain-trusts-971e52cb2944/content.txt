<!doctype html><html lang="en"><head><title data-rh="true">A Guide to Attacking Domain Trusts | by Will Schroeder | Posts By SpecterOps Team Members</title><meta data-rh="true" charset="utf-8"/><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"/><meta data-rh="true" name="theme-color" content="#000000"/><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"/><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"/><meta data-rh="true" property="al:ios:app_name" content="Medium"/><meta data-rh="true" property="al:ios:app_store_id" content="828256236"/><meta data-rh="true" property="al:android:package" content="com.medium.reader"/><meta data-rh="true" property="fb:app_id" content="542599432471018"/><meta data-rh="true" property="og:site_name" content="Medium"/><meta data-rh="true" property="og:type" content="article"/><meta data-rh="true" property="article:published_time" content="2017-10-30T19:38:02.257Z"/><meta data-rh="true" name="title" content="A Guide to Attacking Domain Trusts | by Will Schroeder | Posts By SpecterOps Team Members"/><meta data-rh="true" property="og:title" content="A Guide to Attacking Domain Trusts"/><meta data-rh="true" property="al:android:url" content="medium://p/971e52cb2944"/><meta data-rh="true" property="al:ios:url" content="medium://p/971e52cb2944"/><meta data-rh="true" property="al:android:app_name" content="Medium"/><meta data-rh="true" name="description" content="It’s been a while (nearly 2 years) since I wrote a post purely on Active Directory domain trusts. After diving into group scoping, I realized a few subtle misconceptions I previously had concerning…"/><meta data-rh="true" property="og:description" content="It’s been a while (nearly 2 years) since I wrote a post purely on Active Directory domain trusts. After diving into group scoping, I realized a few subtle misconceptions I previously had concerning…"/><meta data-rh="true" property="og:url" content="https://posts.specterops.io/a-guide-to-attacking-domain-trusts-971e52cb2944"/><meta data-rh="true" property="al:web:url" content="https://posts.specterops.io/a-guide-to-attacking-domain-trusts-971e52cb2944"/><meta data-rh="true" property="og:image" content="https://miro.medium.com/v2/resize:fit:1024/0*Hfo-BgoCQjoc1G1H.png"/><meta data-rh="true" property="article:author" content="https://harmj0y.medium.com"/><meta data-rh="true" name="author" content="Will Schroeder"/><meta data-rh="true" name="robots" content="index,noarchive,follow,max-image-preview:large"/><meta data-rh="true" name="referrer" content="unsafe-url"/><meta data-rh="true" property="twitter:title" content="A Guide to Attacking Domain Trusts"/><meta data-rh="true" name="twitter:site" content="@specterops"/><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/971e52cb2944"/><meta data-rh="true" property="twitter:description" content="It’s been a while (nearly 2 years) since I wrote a post purely on Active Directory domain trusts. After diving into group scoping, I realized a few subtle misconceptions I previously had concerning…"/><meta data-rh="true" name="twitter:image:src" content="https://miro.medium.com/v2/resize:fit:1024/0*Hfo-BgoCQjoc1G1H.png"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta data-rh="true" name="twitter:creator" content="@harmj0y"/><meta data-rh="true" name="twitter:label1" content="Reading time"/><meta data-rh="true" name="twitter:data1" content="36 min read"/><link data-rh="true" rel="icon" href="https://miro.medium.com/v2/resize:fill:256:256/1*D-FDlfkqivRBQZoESrwtqw.png"/><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml"/><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="https://miro.medium.com/v2/resize:fill:304:304/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="https://miro.medium.com/v2/resize:fill:240:240/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="https://miro.medium.com/v2/resize:fill:152:152/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="https://miro.medium.com/v2/resize:fill:120:120/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="mask-icon" href="https://miro.medium.com/v2/resize:fill:1000:1000/7*GAOKVe--MXbEJmV9230oOQ.png" color="#171717"/><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" rel="author" href="https://harmj0y.medium.com"/><link data-rh="true" rel="canonical" href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/"/><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/971e52cb2944"/><script data-rh="true" type="application/ld+json">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:1200\u002F0*Hfo-BgoCQjoc1G1H.png"],"url":"https:\u002F\u002Fposts.specterops.io\u002Fa-guide-to-attacking-domain-trusts-971e52cb2944","dateCreated":"2017-10-30T19:25:19.000Z","datePublished":"2017-10-30T19:25:19.000Z","dateModified":"2018-04-20T23:39:23.490Z","headline":"A Guide to Attacking Domain Trusts - Posts By SpecterOps Team Members","name":"A Guide to Attacking Domain Trusts - Posts By SpecterOps Team Members","description":"It’s been a while (nearly 2 years) since I wrote a post purely on Active Directory domain trusts. After diving into group scoping, I realized a few subtle misconceptions I previously had concerning…","identifier":"971e52cb2944","author":{"@type":"Person","name":"Will Schroeder","url":"https:\u002F\u002Fharmj0y.medium.com"},"creator":["Will Schroeder"],"publisher":{"@type":"Organization","name":"Posts By SpecterOps Team Members","url":"posts.specterops.io","logo":{"@type":"ImageObject","width":149,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:298\u002F1*s-5BWBr8XsgtIU5azKNhZQ.jpeg"}},"mainEntityOfPage":"https:\u002F\u002Fposts.specterops.io\u002Fa-guide-to-attacking-domain-trusts-971e52cb2944"}</script><style type="text/css" data-fela-rehydration="522" data-fela-type="STATIC">html{box-sizing:border-box;-webkit-text-size-adjust:100%}*, *:before, *:after{box-sizing:inherit}body{margin:0;padding:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);position:relative;min-height:100vh}h1, h2, h3, h4, h5, h6, dl, dd, ol, ul, menu, figure, blockquote, p, pre, form{margin:0}menu, ol, ul{padding:0;list-style:none;list-style-image:none}main{display:block}a{color:inherit;text-decoration:none}a, button, input{-webkit-tap-highlight-color:transparent}img, svg{vertical-align:middle}button{background:transparent;overflow:visible}button, input, optgroup, select, textarea{margin:0}:root{--reach-tabs:1;--reach-menu-button:1}#speechify-root{font-family:Sohne, sans-serif}div[data-popper-reference-hidden="true"]{visibility:hidden;pointer-events:none}.grecaptcha-badge{visibility:hidden}
/*XCode style (c) Angel Garcia <angelgarcia.mail@gmail.com>*/.hljs {background: #fff;color: black;
}/* Gray DOCTYPE selectors like WebKit */
.xml .hljs-meta {color: #c0c0c0;
}.hljs-comment,
.hljs-quote {color: #007400;
}.hljs-tag,
.hljs-attribute,
.hljs-keyword,
.hljs-selector-tag,
.hljs-literal,
.hljs-name {color: #aa0d91;
}.hljs-variable,
.hljs-template-variable {color: #3F6E74;
}.hljs-code,
.hljs-string,
.hljs-meta .hljs-string {color: #c41a16;
}.hljs-regexp,
.hljs-link {color: #0E0EFF;
}.hljs-title,
.hljs-symbol,
.hljs-bullet,
.hljs-number {color: #1c00cf;
}.hljs-section,
.hljs-meta {color: #643820;
}.hljs-title.class_,
.hljs-class .hljs-title,
.hljs-type,
.hljs-built_in,
.hljs-params {color: #5c2699;
}.hljs-attr {color: #836C28;
}.hljs-subst {color: #000;
}.hljs-formula {background-color: #eee;font-style: italic;
}.hljs-addition {background-color: #baeeba;
}.hljs-deletion {background-color: #ffc8bd;
}.hljs-selector-id,
.hljs-selector-class {color: #9b703f;
}.hljs-doctag,
.hljs-strong {font-weight: bold;
}.hljs-emphasis {font-style: italic;
}
</style><style type="text/css" data-fela-rehydration="522" data-fela-type="KEYFRAME">@-webkit-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@-moz-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE">.a{font-family:medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif}.b{font-weight:400}.c{background-color:rgba(255, 255, 255, 1)}.l{display:block}.m{position:sticky}.n{top:0}.o{z-index:500}.p{padding:0 24px}.q{align-items:center}.r{border-bottom:solid 1px #F2F2F2}.y{height:41px}.z{line-height:20px}.ab{display:flex}.ac{height:57px}.ae{flex:1 0 auto}.af{color:inherit}.ag{fill:inherit}.ah{font-size:inherit}.ai{border:inherit}.aj{font-family:inherit}.ak{letter-spacing:inherit}.al{font-weight:inherit}.am{padding:0}.an{margin:0}.ao{cursor:pointer}.ap:disabled{cursor:not-allowed}.aq:disabled{color:#6B6B6B}.ar:disabled{fill:#6B6B6B}.au{width:auto}.av path{fill:#242424}.aw{height:25px}.ax{margin-left:16px}.ay{border:none}.az{border-radius:20px}.ba{width:240px}.bb{background:#F9F9F9}.bc path{fill:#6B6B6B}.be{outline:none}.bf{font-family:sohne, "Helvetica Neue", Helvetica, Arial, sans-serif}.bg{font-size:14px}.bh{width:100%}.bi{padding:10px 20px 10px 0}.bj{background-color:transparent}.bk{color:#242424}.bl::placeholder{color:#6B6B6B}.bm{display:inline-block}.bn{margin-left:12px}.bo{margin-right:12px}.bp{border-radius:4px}.bq{margin-left:24px}.br{height:24px}.bx{background-color:#F9F9F9}.by{border-radius:50%}.bz{height:32px}.ca{width:32px}.cb{justify-content:center}.ch{max-width:680px}.ci{min-width:0}.cj{animation:k1 1.2s ease-in-out infinite}.ck{height:100vh}.cl{margin-bottom:16px}.cm{margin-top:48px}.cn{align-items:flex-start}.co{flex-direction:column}.cp{justify-content:space-between}.cq{margin-bottom:24px}.cw{width:80%}.cx{background-color:#F2F2F2}.dd{height:44px}.de{width:44px}.df{margin:auto 0}.dg{margin-bottom:4px}.dh{height:16px}.di{width:120px}.dj{width:80px}.dp{margin-bottom:8px}.dq{width:96%}.dr{width:98%}.ds{width:81%}.dt{margin-left:8px}.du{color:#6B6B6B}.dv{font-size:13px}.dw{height:100%}.ep{color:#FFFFFF}.eq{fill:#FFFFFF}.er{background:rgba(128, 128, 183, 1)}.es{border-color:rgba(128, 128, 183, 1)}.ew:disabled{cursor:inherit !important}.ex:disabled{opacity:0.3}.ey:disabled:hover{background:rgba(128, 128, 183, 1)}.ez:disabled:hover{border-color:rgba(128, 128, 183, 1)}.fa{border-radius:99em}.fb{border-width:1px}.fc{border-style:solid}.fd{box-sizing:border-box}.fe{text-decoration:none}.ff{text-align:center}.fi{margin-right:32px}.fj{position:relative}.fk{fill:#6B6B6B}.fn{background:transparent}.fo svg{margin-left:4px}.fp svg{fill:#6B6B6B}.fr{box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.05)}.fs{position:absolute}.fz{margin:0 24px}.gd{background:rgba(255, 255, 255, 1)}.ge{border:1px solid #F2F2F2}.gf{box-shadow:0 1px 4px #F2F2F2}.gg{max-height:100vh}.gh{overflow-y:auto}.gi{left:0}.gj{top:calc(100vh + 100px)}.gk{bottom:calc(100vh + 100px)}.gl{width:10px}.gm{pointer-events:none}.gn{word-break:break-word}.go{word-wrap:break-word}.gp:after{display:block}.gq:after{content:""}.gr:after{clear:both}.gs{line-height:1.23}.gt{letter-spacing:0}.gu{font-style:normal}.gv{font-weight:700}.ia{align-items:baseline}.ib{width:48px}.ic{height:48px}.id{border:2px solid rgba(255, 255, 255, 1)}.ie{z-index:0}.if{box-shadow:none}.ig{border:1px solid rgba(0, 0, 0, 0.05)}.ih{margin-left:-12px}.ii{width:28px}.ij{height:28px}.ik{z-index:1}.il{width:24px}.im{margin-bottom:2px}.in{flex-wrap:nowrap}.io{font-size:16px}.ip{line-height:24px}.ir{margin:0 8px}.is{display:inline}.it{color:rgba(128, 128, 183, 1)}.iu{fill:rgba(128, 128, 183, 1)}.ix{flex:0 0 auto}.ja{flex-wrap:wrap}.jd{white-space:pre-wrap}.je{margin-right:4px}.jf{overflow:hidden}.jg{max-height:20px}.jh{text-overflow:ellipsis}.ji{display:-webkit-box}.jj{-webkit-line-clamp:1}.jk{-webkit-box-orient:vertical}.jl{word-break:break-all}.jn{padding-left:8px}.jo{padding-right:8px}.kp> *{flex-shrink:0}.kq{overflow-x:scroll}.kr::-webkit-scrollbar{display:none}.ks{scrollbar-width:none}.kt{-ms-overflow-style:none}.ku{width:74px}.kv{flex-direction:row}.kw{z-index:2}.kz{-webkit-user-select:none}.la{border:0}.lb{fill:rgba(117, 117, 117, 1)}.le{outline:0}.lf{user-select:none}.lg> svg{pointer-events:none}.lp{cursor:progress}.lq{opacity:1}.lr{padding:4px 0}.lu{margin-top:0px}.lv{width:16px}.lx{display:inline-flex}.md{max-width:100%}.me{padding:8px 2px}.mf svg{color:#6B6B6B}.mw{line-height:1.58}.mx{letter-spacing:-0.004em}.my{font-family:source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif}.nt{margin-bottom:-0.46em}.nu{text-decoration:underline}.nv{font-style:italic}.nw{line-height:1.18}.nx{letter-spacing:-0.022em}.ny{font-weight:600}.oo{margin-bottom:-0.31em}.ou{margin-left:auto}.ov{margin-right:auto}.ow{max-width:1024px}.pc{clear:both}.pe{cursor:zoom-in}.pf{z-index:auto}.ph{height:auto}.pi{list-style-type:disc}.pj{margin-left:30px}.pk{padding-left:0px}.pq{max-width:500px}.pr{margin-top:10px}.ps{max-width:728px}.pv{max-width:342px}.pw{box-shadow:inset 3px 0 0 0 #242424}.px{padding-left:23px}.py{margin-left:-20px}.pz{max-width:894px}.qa{max-width:825px}.qb{margin:auto}.qc{padding-bottom:100%}.qd{height:0}.qe{max-width:988px}.qf{max-width:480px}.qg{max-width:600px}.qh{margin-top:32px}.qi{margin-bottom:14px}.qj{padding-top:24px}.qk{padding-bottom:10px}.ql{background-color:#000000}.qm{height:3px}.qn{width:3px}.qo{margin-right:20px}.qp{margin-bottom:26px}.qq{margin-top:6px}.qr{margin-top:8px}.qs{margin-right:8px}.qt{padding:8px 16px}.qu{border-radius:100px}.qv{transition:background 300ms ease}.qx{white-space:nowrap}.qy{border-top:none}.re{height:52px}.rf{max-height:52px}.rg{box-sizing:content-box}.rh{position:static}.rj{max-width:155px}.ru{align-items:flex-end}.rv{width:76px}.rw{height:76px}.rx{border:2px solid #F9F9F9}.ry{height:72px}.rz{width:72px}.sa{margin-left:-16px}.sb{width:36px}.sc{height:36px}.sd{stroke:#F2F2F2}.se{color:#F2F2F2}.sf{fill:#F2F2F2}.sg{background:#F2F2F2}.sh{border-color:#F2F2F2}.sn{font-weight:500}.so{font-size:24px}.sp{line-height:30px}.sq{letter-spacing:-0.016em}.sr{margin-top:16px}.ss{height:0px}.st{border-bottom:solid 1px #E5E5E5}.sz{margin-top:72px}.ta{padding:24px 0}.tb{margin-bottom:0px}.tc{margin-right:16px}.as:hover:not(:disabled){color:rgba(25, 25, 25, 1)}.at:hover:not(:disabled){fill:rgba(25, 25, 25, 1)}.et:hover{background:rgba(110, 110, 154, 1)}.eu:hover{border-color:rgba(110, 110, 154, 1)}.ev:hover{cursor:pointer}.fl:hover{color:#242424}.fm:hover{fill:#242424}.fq:hover svg{fill:#242424}.ft:hover{background-color:rgba(0, 0, 0, 0.1)}.iq:hover{text-decoration:underline}.iv:hover:not(:disabled){color:rgba(110, 110, 154, 1)}.iw:hover:not(:disabled){fill:rgba(110, 110, 154, 1)}.ld:hover{fill:rgba(8, 8, 8, 1)}.ls:hover{fill:#000000}.lt:hover p{color:#000000}.lw:hover{color:#000000}.mg:hover svg{color:#000000}.qw:hover{background-color:#F2F2F2}.si:hover{background:#F2F2F2}.sj:hover{border-color:#F2F2F2}.sk:hover{cursor:wait}.sl:hover{color:#F2F2F2}.sm:hover{fill:#F2F2F2}.bd:focus-within path{fill:#242424}.lc:focus{fill:rgba(8, 8, 8, 1)}.mh:focus svg{color:#000000}.pg:focus{transform:scale(1.01)}.lh:active{border-style:none}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (min-width: 1080px)">.d{display:none}.bw{width:64px}.cg{margin:0 64px}.cv{height:48px}.dc{margin-bottom:52px}.do{margin-bottom:48px}.ef{font-size:14px}.eg{line-height:20px}.em{font-size:13px}.eo{padding:5px 12px}.fh{display:flex}.fy{margin-bottom:68px}.gc{max-width:680px}.hq{font-size:42px}.hr{margin-top:1.19em}.hs{margin-bottom:32px}.ht{line-height:52px}.hu{letter-spacing:-0.011em}.hz{align-items:center}.kb{border-top:solid 1px #F2F2F2}.kc{border-bottom:solid 1px #F2F2F2}.kd{margin:32px 0 0}.ke{padding:3px 8px}.kn> *{margin-right:24px}.ko> :last-child{margin-right:0}.lo{margin-top:0px}.mc{margin:0}.np{font-size:20px}.nq{margin-top:2.14em}.nr{line-height:32px}.ns{letter-spacing:-0.003em}.ol{margin-top:1.72em}.om{line-height:24px}.on{letter-spacing:0}.ot{margin-top:0.94em}.pb{margin-top:56px}.pp{margin-top:1.14em}.rd{margin-bottom:88px}.ro{display:inline-block}.rt{padding-top:72px}.sy{margin-top:40px}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (max-width: 1079.98px)">.e{display:none}.ln{margin-top:0px}.pt{margin-left:auto}.pu{text-align:center}.rn{display:inline-block}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (max-width: 903.98px)">.f{display:none}.lm{margin-top:0px}.rm{display:inline-block}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (max-width: 727.98px)">.g{display:none}.lk{margin-top:0px}.ll{margin-right:0px}.rl{display:inline-block}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (max-width: 551.98px)">.h{display:none}.s{display:flex}.t{justify-content:space-between}.bs{width:24px}.cc{margin:0 24px}.cr{height:40px}.cy{margin-bottom:44px}.dk{margin-bottom:32px}.dx{font-size:13px}.dy{line-height:20px}.eh{padding:0px 8px 1px}.fu{margin-bottom:4px}.gw{font-size:32px}.gx{margin-top:1.01em}.gy{margin-bottom:24px}.gz{line-height:38px}.ha{letter-spacing:-0.014em}.hv{align-items:flex-start}.iy{flex-direction:column}.jb{margin-bottom:2px}.jp{margin:24px -24px 0}.jq{padding:0}.kf> *{margin-right:8px}.kg> :last-child{margin-right:24px}.kx{margin-left:0px}.li{margin-top:0px}.lj{margin-right:0px}.ly{margin:0}.mi{border:1px solid #F2F2F2}.mj{border-radius:99em}.mk{padding:0px 16px 0px 12px}.ml{height:38px}.mm{align-items:center}.mo svg{margin-right:8px}.mz{font-size:18px}.na{margin-top:1.56em}.nb{line-height:28px}.nc{letter-spacing:-0.003em}.nz{font-size:16px}.oa{margin-top:1.23em}.ob{letter-spacing:0}.op{margin-top:0.67em}.ox{margin-top:40px}.pl{margin-top:1.34em}.qz{margin-bottom:80px}.rk{display:inline-block}.rp{padding-top:48px}.su{margin-top:32px}.mn:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (min-width: 904px) and (max-width: 1079.98px)">.i{display:none}.bv{width:64px}.cf{margin:0 64px}.cu{height:48px}.db{margin-bottom:52px}.dn{margin-bottom:48px}.ed{font-size:14px}.ee{line-height:20px}.ek{font-size:13px}.el{padding:5px 12px}.fg{display:flex}.fx{margin-bottom:68px}.gb{max-width:680px}.hl{font-size:42px}.hm{margin-top:1.19em}.hn{margin-bottom:32px}.ho{line-height:52px}.hp{letter-spacing:-0.011em}.hy{align-items:center}.jx{border-top:solid 1px #F2F2F2}.jy{border-bottom:solid 1px #F2F2F2}.jz{margin:32px 0 0}.ka{padding:3px 8px}.kl> *{margin-right:24px}.km> :last-child{margin-right:0}.mb{margin:0}.nl{font-size:20px}.nm{margin-top:2.14em}.nn{line-height:32px}.no{letter-spacing:-0.003em}.oi{margin-top:1.72em}.oj{line-height:24px}.ok{letter-spacing:0}.os{margin-top:0.94em}.pa{margin-top:56px}.po{margin-top:1.14em}.rc{margin-bottom:88px}.rs{padding-top:72px}.sx{margin-top:40px}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (min-width: 728px) and (max-width: 903.98px)">.j{display:none}.w{display:flex}.x{justify-content:space-between}.bu{width:64px}.ce{margin:0 48px}.ct{height:48px}.da{margin-bottom:52px}.dm{margin-bottom:48px}.eb{font-size:13px}.ec{line-height:20px}.ej{padding:0px 8px 1px}.fw{margin-bottom:68px}.ga{max-width:680px}.hg{font-size:42px}.hh{margin-top:1.19em}.hi{margin-bottom:32px}.hj{line-height:52px}.hk{letter-spacing:-0.011em}.hx{align-items:center}.jt{border-top:solid 1px #F2F2F2}.ju{border-bottom:solid 1px #F2F2F2}.jv{margin:32px 0 0}.jw{padding:3px 8px}.kj> *{margin-right:24px}.kk> :last-child{margin-right:0}.ma{margin:0}.nh{font-size:20px}.ni{margin-top:2.14em}.nj{line-height:32px}.nk{letter-spacing:-0.003em}.of{margin-top:1.72em}.og{line-height:24px}.oh{letter-spacing:0}.or{margin-top:0.94em}.oz{margin-top:56px}.pn{margin-top:1.14em}.rb{margin-bottom:88px}.rr{padding-top:72px}.sw{margin-top:40px}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="all and (min-width: 552px) and (max-width: 727.98px)">.k{display:none}.u{display:flex}.v{justify-content:space-between}.bt{width:24px}.cd{margin:0 24px}.cs{height:40px}.cz{margin-bottom:44px}.dl{margin-bottom:32px}.dz{font-size:13px}.ea{line-height:20px}.ei{padding:0px 8px 1px}.fv{margin-bottom:4px}.hb{font-size:32px}.hc{margin-top:1.01em}.hd{margin-bottom:24px}.he{line-height:38px}.hf{letter-spacing:-0.014em}.hw{align-items:flex-start}.iz{flex-direction:column}.jc{margin-bottom:2px}.jr{margin:24px 0 0}.js{padding:0}.kh> *{margin-right:8px}.ki> :last-child{margin-right:8px}.ky{margin-left:0px}.lz{margin:0}.mp{border:1px solid #F2F2F2}.mq{border-radius:99em}.mr{padding:0px 16px 0px 12px}.ms{height:38px}.mt{align-items:center}.mv svg{margin-right:8px}.nd{font-size:18px}.ne{margin-top:1.56em}.nf{line-height:28px}.ng{letter-spacing:-0.003em}.oc{font-size:16px}.od{margin-top:1.23em}.oe{letter-spacing:0}.oq{margin-top:0.67em}.oy{margin-top:40px}.pm{margin-top:1.34em}.ra{margin-bottom:80px}.rq{padding-top:48px}.sv{margin-top:32px}.mu:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="print">.ri{display:none}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="(orientation: landscape) and (max-width: 903.98px)">.jm{max-height:none}</style><style type="text/css" data-fela-rehydration="522" data-fela-type="RULE" media="(prefers-reduced-motion: no-preference)">.pd{transition:transform 300ms cubic-bezier(0.2, 0, 0.2, 1)}</style></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><script>document.domain = document.domain;</script><div class="l c"><div class="l m n o c"><div class="p q r s t u v w x i d y z"><a class="du ag dv bf ak b am an ao ap aq ar as at s u w i d q dw z" href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F971e52cb2944&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderCollection&amp;source=---top_nav_layout_nav----------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="dt"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ab q"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="bf b dx dy eh dz ea ei eb ec ej ek ee el em eg eo ep eq er es et eu ev ew ex ey ez fa fb fc fd bm fe ff" data-testid="headerSignUpButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign up</a></span></p><div class="ax l"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="p q r ab ac"><div class="ab q ae"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab" aria-label="Homepage" data-testid="headerMediumLogo" href="https://medium.com/?source=---top_nav_layout_nav----------------------------------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" viewBox="0 0 719 160" class="au av aw"><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="ax h"><div class="ab ay az ba bb q bc bd"><div class="bm" aria-hidden="false" aria-describedby="searchResults" aria-labelledby="searchResults"></div><div class="bn bo ab"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ay be bf bg z bh bi bj bk bl" placeholder="Search" value=""/></div></div></div><div class="h k w fg fh"><div class="fi ab"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerWriteButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav-----------" rel="noopener follow"><div class="bf b bg z du fj fk ab q fl fm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-label="Write"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg><div class="dt l">Write</div></div></a></span></div></div><div class="k j i d"><div class="fi ab"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSearchButton" href="https://medium.com/search?source=---top_nav_layout_nav----------------------------------" rel="noopener follow"><div class="bf b bg z du fj fk ab q fl fm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-label="Search"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div></a></div></div><div class="fi h k j"><div class="ab q"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="bf b dx dy eh dz ea ei eb ec ej ek ee el em eg eo ep eq er es et eu ev ew ex ey ez fa fb fc fd bm fe ff" data-testid="headerSignUpButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign up</a></span></p><div class="ax l"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="l" aria-hidden="false"><button class="ay fn am ab q ao fo fp fq" aria-label="user options menu" data-testid="headerUserIcon"><div class="l fj"><img alt="" class="l fd by bz ca cx" src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png" width="32" height="32" loading="lazy" role="presentation"/><div class="fr by l bz ca fs n ay ft"></div></div></button></div></div></div><div class="l"><div class="fu fv fw fx fy l"><div class="ab cb"><div class="ci bh fz ga gb gc"></div></div><article><div class="l"><div class="l"><span class="l"></span><section><div><div class="fs gi gj gk gl gm"></div><div class="gn go gp gq gr"><div class="ab cb"><div class="ci bh fz ga gb gc"><div><h1 id="0aa4" class="pw-post-title gs gt gu bf gv gw gx gy gz ha hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht hu bk" data-testid="storyTitle">A Guide to Attacking Domain Trusts</h1><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hv hw hx hy hz ab"><div><div class="ab ia"><a href="https://harmj0y.medium.com/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="l ib ic by id ie"><div class="l fj"><img alt="Will Schroeder" class="l fd by dd de cx" src="https://miro.medium.com/v2/resize:fill:88:88/1*idzSM22ouVWVRLUiU5Kpkg.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/><div class="if by l dd de fs n ig ft"></div></div></div></div></div></a><a href="https://posts.specterops.io/?source=post_page-----971e52cb2944--------------------------------" rel="noopener  ugc nofollow"><div class="ih ab fj"><div><div class="bm" aria-hidden="false"><div class="l ii ij by id ik"><div class="l fj"><img alt="Posts By SpecterOps Team Members" class="l fd by br il cx" src="https://miro.medium.com/v2/resize:fill:48:48/1*D-FDlfkqivRBQZoESrwtqw.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto"/><div class="if by l br il fs n ig ft"></div></div></div></div></div></div></a></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="im ab q"><div class="ab q in"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b io ip bk"><a class="af ag ah ai aj ak al am an ao ap aq ar iq" data-testid="authorName" href="https://harmj0y.medium.com/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow">Will Schroeder</a></p></div></div></div><span class="ir is" aria-hidden="true"><span class="bf b bg z du">·</span></span><p class="bf b io ip du"><span><a class="it iu ah ai aj ak al am an ao ap aq ar ex iv iw" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F74ad66811b78&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=post_page-74ad66811b78----971e52cb2944---------------------post_header-----------" rel="noopener follow">Follow</a></span></p></div></div></span></div></div><div class="l ix"><span class="bf b bg z du"><div class="ab cn iy iz ja"><div class="jb jc ab"><div class="bf b bg z du ab jd"><span class="je l ix">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar iq ab q" data-testid="publicationName" href="https://posts.specterops.io/?source=post_page-----971e52cb2944--------------------------------" rel="noopener  ugc nofollow"><p class="bf b bg z jf jg jh ji jj jk jl jm bk">Posts By SpecterOps Team Members</p></a></div></div></div><div class="h k"><span class="ir is" aria-hidden="true"><span class="bf b bg z du">·</span></span></div></div><span class="bf b bg z du"><div class="ab ae"><span data-testid="storyReadTime">36 min read</span><div class="jn jo l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z du">·</span></span></div><span data-testid="storyPublishDate">Oct 30, 2017</span></div></span></div></span></div></div></div><div class="ab cp jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke"><div class="h k w fg fh q"><div class="ku l"><div class="ab q kv kw"><div class="pw-multi-vote-icon fj je kx ky kz"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fspecter-ops-posts%2F971e52cb2944&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=-----971e52cb2944---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="la ao lb lc ld le am lf lg lh kz"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l li lj lk ll lm ln lo"><p class="bf b dv z du"><span class="lp">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao la lq lr ab q fk ls lt" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="lu"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div><div class="ab q kf kg kh ki kj kk kl km kn ko kp kq kr ks kt"><div class="lv k j i d"></div><div class="h k"><div><div class="bm" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F971e52cb2944&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;source=-----971e52cb2944---------------------bookmark_footer-----------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="du lw" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></a></span></div></div></div><div class="fd lx cn"><div class="l ae"><div class="ab cb"><div class="ly lz ma mb mc md ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af fk ah ai aj ak al me an ao ap ex mf mg lt mh mi mj mk ml s mm mn mo mp mq mr ms u mt mu mv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="j i d"><p class="bf b bg z du">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af fk ah ai aj ak al me an ao ap ex mf mg lt mh mi mj mk ml s mm mn mo mp mq mr ms u mt mu mv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="j i d"><p class="bf b bg z du">Share</p></div></button></div></div></div></div></div></div></div></div></div><p id="1059" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">It’s <a class="af nu" href="https://youtu.be/6T-Qt4ZlFB0?t=23" rel="noopener ugc nofollow" target="_blank">been a while</a> (nearly 2 years) since I wrote a post purely on Active Directory <a class="af nu" href="http://www.harmj0y.net/blog/tag/domain-trusts/" rel="noopener ugc nofollow" target="_blank">domain trusts</a>. After <a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/" rel="noopener ugc nofollow" target="_blank">diving into group scoping</a>, I realized a few subtle misconceptions I previously had concerning trusts and group memberships. That, combined with the <a class="af nu" href="http://www.harmj0y.net/blog/powershell/make-powerview-great-again/" rel="noopener ugc nofollow" target="_blank">changes made to PowerView last year</a>, convinced me to publish an up-to-date guide on enumerating and attacking domain trusts. This will likely be the last post focusing on domain trusts I publish for a while, and at over 8000 words, it’s not exactly a light read (not that anyone reads long posts <a class="af nu" href="https://xkcd.com/541/" rel="noopener ugc nofollow" target="_blank">;)</a> In general, I don’t just blog my operational notes — I try to write posts that function as complete guides for members of my team, with the hope that the information may be of use to others (whether from an offensive or defensive perspective.)</p><p id="de31" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">I want this to be as complete as possible, so I’ll cover every aspect of trusts as we currently understand them. Just as with my previous posts, I want to encapsulate my knowledge of the topic as best I can <em class="nv">at this point in time</em>. Emphasis on “this point in time.” Our knowledge and tradecraft are always evolving, and trusts are no different. I had a number of fuzzy misconceptions regarding domain trusts when I started writing about them. I was never a sysadmin or AD architect — I’ve learned my knowledge piecemeal, which (hopefully) explains the gaps that have surfaced in my past posts, and the ones that I’m sure will continue to arise.</p><p id="b34f" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So I am going to start fresh, in case you are not familiar with the previous posts I pushed out about trusts. As such, a few parts of this post will recycle certain elements and wording from previous work, integrated with updated knowledge and <a class="af nu" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" rel="noopener ugc nofollow" target="_blank">PowerView</a> syntax. And as this is a bit of a tome of an article, I’m sure there as mistakes somewhere and things that I’ve missed, so when you find them let me know and I’ll update appropriately!</p><p id="8568" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">PowerView’s most up-to-date version will always be on the <a class="af nu" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" rel="noopener ugc nofollow" target="_blank">dev branch of PowerSploit</a>.</p><h2 id="c9b0" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">WTF Are Domain Trusts?</h2><p id="8be8" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">At a high level, a <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc759554(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><strong class="my gv">domain trust</strong></a> establishes the ability for users in one domain to authenticate to resources or act as a <a class="af nu" href="https://technet.microsoft.com/en-us/library/cc780957(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">security principal</a> in another domain. Microsoft has <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc770299.aspx" rel="noopener ugc nofollow" target="_blank">a lot of information</a> out <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc759554(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">there</a> about <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc731335.aspx" rel="noopener ugc nofollow" target="_blank">domain trusts</a>, as well as “<a class="af nu" href="https://technet.microsoft.com/en-us/library/cc755321(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">Security Considerations for Trusts</a>”, and it can sometimes get a bit confusing. As Microsoft describes, “<a class="af nu" href="http://technet.microsoft.com/en-us/library/cc757352(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">Most organizations that have more than one domain have a legitimate need for users to access shared resources located in a different domain</em></a>“, and trusts allow organizations with multiple domains to grant users in separate domains access to shared resources. <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc759073(v=ws.10).aspx#w2k3tr_logic_what_ovkc" rel="noopener ugc nofollow" target="_blank"><strong class="my gv">Domain forests</strong></a> are collections of domain containers that trust each other. Forests themselves may also <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc755700(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">have trusts</a> between them. Microsoft has excellent post about <a class="af nu" href="http://technet.microsoft.com/en-us/library/cc773178(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">how domain and forest trusts work</a>. If you’re not familiar with this topic, I recommend that you check it out.</p><p id="9602" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Essentially, all a trust does is link up the authentication systems of two domains and allows authentication traffic to flow between them through a system of referrals. If a user requests access to a service principal name (SPN) of a resource that resides outside of the domain they’re current in, their domain controller will return a special referral ticket that points to the key distribution center (KDC, in the Windows case the domain controller) of the foreign domain.</p><p id="2093" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The user’s ticket-granting-ticket (TGT) is included in this TGS-REP (ticket-granting service reply) referral ticket, and this ticket encrypted/signed with the inter-realm trust key that the domains previously exchanged, instead of the first domain’s krbtgt account. This ticket is usually referred to as an “inter-realm ticket-granting-ticket/TGT.” The foreign domain then verifies/decrypts the TGT included in the referral by decrypting it with the previously negotiated inter-realm trust key, and goes about the rest of the normal Kerberos process.</p><p id="8f73" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><a class="af nu" href="https://twitter.com/pyrotek3" rel="noopener ugc nofollow" target="_blank">Sean Metcalf</a> has a great breakdown of this process in his “<a class="af nu" href="https://adsecurity.org/?p=1588" rel="noopener ugc nofollow" target="_blank">It’s All About Trust</a>” post, and he describes the process as, “<em class="nv">Once there is a trust between two domains … the ticket-granting service of each domain (“realm” in Kerberos speak) is registered as a security principal with the other domain’s Kerberos service (KDC). This enables the ticket-granting service in each domain to treat the one in the other domain as just another service providing cross-domain service access for resources in the other domain.</em>”</p><p id="2247" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So basically, when the foreign domain decrypts the referral ticket with the negotiated trust key, it sees the user’s TGT and says “<em class="nv">OK, the other domain already authenticated this user and said this is who they say they are/these are the groups the user is in, so I’ll trust this information as accurate because I trust the domain that issued the referral.</em>”</p><p id="4a9b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Here’s a picture to visualize the Kerberos process across trust boundaries:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*Hfo-BgoCQjoc1G1H.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*Hfo-BgoCQjoc1G1H.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*Hfo-BgoCQjoc1G1H.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*Hfo-BgoCQjoc1G1H.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*Hfo-BgoCQjoc1G1H.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*Hfo-BgoCQjoc1G1H.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Hfo-BgoCQjoc1G1H.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*Hfo-BgoCQjoc1G1H.png 640w, https://miro.medium.com/v2/resize:fit:720/0*Hfo-BgoCQjoc1G1H.png 720w, https://miro.medium.com/v2/resize:fit:750/0*Hfo-BgoCQjoc1G1H.png 750w, https://miro.medium.com/v2/resize:fit:786/0*Hfo-BgoCQjoc1G1H.png 786w, https://miro.medium.com/v2/resize:fit:828/0*Hfo-BgoCQjoc1G1H.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*Hfo-BgoCQjoc1G1H.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*Hfo-BgoCQjoc1G1H.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="453" loading="lazy" role="presentation"/></picture></div></div></figure><p id="debe" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The purpose of establishing a trust is to allow users from one domain to access resources (like the local Administrators group on a server), to be nested in groups, or to otherwise be used as security principals in another domain (e.g. for AD object ACLs). One exception to this is intra-forest trusts (domain trusts that exist within the same Active Directory forest)- any domain created within a forest retains an implicit two-way, transitive trust relationship with every other domain in the forest. This has numerous implications which will be covered later in this post.</p><p id="120b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">But before that, we have to cover a few more characteristics of trusts.</p><p id="1915" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">There are several types of trusts, some of which have various offensive implications, covered in a bit:</p><ul class=""><li id="f8bc" class="mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt pi pj pk bk"><strong class="my gv">Parent/Child</strong> — part of the same forest — a child domain retains an implicit two-way transitive trust with its parent. This is probably the most common type of trust that you’ll encounter.</li><li id="090c" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">Cross-link</strong> — aka a “shortcut trust” between child domains to improve referral times. Normally referrals in a complex forest have to filter up to the forest root and then back down to the target domain, so for a geographically spread out scenario, cross-links can make sense to cut down on authentication times.</li><li id="6ba2" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">External </strong>— an implicitly non-transitive trust created between disparate domains. “<a class="af nu" href="https://technet.microsoft.com/en-us/library/cc773178(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">External trusts provide access to resources in a domain outside of the forest that is not already joined by a forest trust.</em></a>” External trusts enforce SID filtering, a security protection covered later in this post.</li><li id="566f" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">Tree-root </strong>— an implicit two-way transitive trust between the forest root domain and the new tree root you’re adding. I haven’t encountered tree-root trusts too often, but from the <a class="af nu" href="https://technet.microsoft.com/en-us/library/cc773178(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">Microsoft documentation</a>, they’re created when you when you create a new domain tree in a forest. These are intra-forest trusts, and they <a class="af nu" href="https://technet.microsoft.com/en-us/library/cc757352(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">preserve two-way transitivity</a> while allowing the tree to have a separate domain name (instead of child.parent.com).</li><li id="bcc4" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">Forest</strong> — a transitive trust between one forest root domain and another forest root domain. Forest trusts also enforce SID filtering.</li><li id="52ea" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">MIT</strong> — a trust with a non-Windows <a class="af nu" href="https://tools.ietf.org/html/rfc4120" rel="noopener ugc nofollow" target="_blank">RFC4120-compliant</a> Kerberos domain. I hope to dive more into MIT trusts in the future.</li></ul><p id="b354" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Transitivity, huh? Another aspect of domain trusts is that they are transitive or non-transitive. To quote the MSDN documentation on transitivity: “<a class="af nu" href="http://technet.microsoft.com/en-us/library/cc759554(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">A transitive trust extends trust relationships to other domains; a nontransitive trust does not extend trust relationships to other domains.</em></a>” This means that transitive trusts can be chained, so users can potentially access resources in multiple domains. Meaning, if domain A trusts B, and B trusts C, then A implicitly trusts C. Under the hood, if a specific trust relationship is transitive, then the <em class="nv">trusting</em> domain can repack a user’s TGT into additional referral tickets and forward them onto domains <em class="nv">that</em> domain trusts.</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div class="ou ov pq"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*5TcceF20YM8lqARJ.jpg 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*5TcceF20YM8lqARJ.jpg 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*5TcceF20YM8lqARJ.jpg 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*5TcceF20YM8lqARJ.jpg 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*5TcceF20YM8lqARJ.jpg 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*5TcceF20YM8lqARJ.jpg 1100w, https://miro.medium.com/v2/resize:fit:1000/format:webp/0*5TcceF20YM8lqARJ.jpg 1000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 500px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*5TcceF20YM8lqARJ.jpg 640w, https://miro.medium.com/v2/resize:fit:720/0*5TcceF20YM8lqARJ.jpg 720w, https://miro.medium.com/v2/resize:fit:750/0*5TcceF20YM8lqARJ.jpg 750w, https://miro.medium.com/v2/resize:fit:786/0*5TcceF20YM8lqARJ.jpg 786w, https://miro.medium.com/v2/resize:fit:828/0*5TcceF20YM8lqARJ.jpg 828w, https://miro.medium.com/v2/resize:fit:1100/0*5TcceF20YM8lqARJ.jpg 1100w, https://miro.medium.com/v2/resize:fit:1000/0*5TcceF20YM8lqARJ.jpg 1000w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 500px"/><img alt="" class="bh md ph c" width="500" height="323" loading="lazy" role="presentation"/></picture></div></figure><p id="989c" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Also, trusts can be one-way or two-way. A bidirectional (two-way) trust is actually just two one-way trusts. A one-way trust means users and computers in a <em class="nv">trusted domain</em> can potentially access resources in another <em class="nv">trusting domain</em>. A one-way trust is in one direction only, hence the name. Users and computers in the <em class="nv">trusting</em> domain can not access resources in the <em class="nv">trusted</em> domain. Microsoft has a nice diagram to visualize this:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*xWw0ToUAHf8ScLR-.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*xWw0ToUAHf8ScLR-.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*xWw0ToUAHf8ScLR-.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*xWw0ToUAHf8ScLR-.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*xWw0ToUAHf8ScLR-.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*xWw0ToUAHf8ScLR-.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xWw0ToUAHf8ScLR-.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*xWw0ToUAHf8ScLR-.png 640w, https://miro.medium.com/v2/resize:fit:720/0*xWw0ToUAHf8ScLR-.png 720w, https://miro.medium.com/v2/resize:fit:750/0*xWw0ToUAHf8ScLR-.png 750w, https://miro.medium.com/v2/resize:fit:786/0*xWw0ToUAHf8ScLR-.png 786w, https://miro.medium.com/v2/resize:fit:828/0*xWw0ToUAHf8ScLR-.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*xWw0ToUAHf8ScLR-.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*xWw0ToUAHf8ScLR-.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="318" loading="lazy" role="presentation"/></picture></div></div><figcaption class="pr ff ps ou ov pt pu bf b bg z du"><a class="af nu" href="https://technet.microsoft.com/en-us/library/cc759554(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">https://technet.microsoft.com/en-us/library/cc759554(v=ws.10).aspx</a></figcaption></figure><p id="a35a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This was something that messed with my head when I started — from an offensive perspective, what we care about is the <em class="nv">direction of access</em>, not the <em class="nv">direction of the trust</em>. With a one-way trust where <strong class="my gv">A -trusts-&gt; B</strong>, if the trust is enumerated from A, the trust is marked as <em class="nv">outbound</em>, while if the same trust is enumerated from B the trust is marked as <em class="nv">inbound</em>, while the potential access is from <strong class="my gv">B</strong> to <strong class="my gv">A</strong>. This will make more sense in the <strong class="my gv">Foreign Relationship Enumeration</strong> section.</p><h2 id="6483" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Why Care?</h2><p id="33c0" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">But really, why care?</p><p id="9c25" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Domain trusts often introduce unintended access paths between environments. In many organizations, trusts were implemented years (sometimes 10+) ago without major considerations given to security. Some corporate entities that are focused on acquisitions often just “plug in” a new company’s Active Directory network either as a child domain or external trust, without fully considering the security implications.</p><p id="9a63" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Because historically there have not been many toolsets that allow you to easily map, enumerate, and visualize the risk associated with misconfigured trusts, many domain architects are unaware of the unintentional risk exposed by their Active Directory trust architectures. This links back to the idea of “misconfiguration debt” that <a class="af nu" href="https://twitter.com/_wald0" rel="noopener ugc nofollow" target="_blank">@wald0</a>, <a class="af nu" href="https://twitter.com/cptjesus" rel="noopener ugc nofollow" target="_blank">@cptjesus</a>, and I <a class="af nu" href="https://www.slideshare.net/AndyRobbins3/here-be-dragons-the-unexplored-land-of-active-directory-acls/11" rel="noopener ugc nofollow" target="_blank">spoke about at Derbycon this year</a>. Because of this, various red teams (and probably APTz, I’m assuming) have been abusing Active Directory trusts for years with great success.</p><p id="7fb1" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">A common scenario is compromising a development or subsidiary domain and leveraging that access to pivot into the secure root/enclave. This also introduces opportunities for persistence- why leave code running in a secured environment, when you can have implants running in the less-secured (but trusted) domain that can then be used to re-compromise your target at will?</p><p id="d6f3" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">An intra-forest trust (parent/child or tree-root) introduces an awesome attack vector that’s described in <strong class="my gv">The Trustpocalypse</strong> later in this post. External/inter-forest trusts <em class="nv">do not guarantee</em> any kind of privileged access, but at a minimum, a trust means that you can query any normal Active Directory information from a domain that trusts you (yes, this means in some cases you can Kerberoast across trusts, more on this at the end of post.) After all, Active Directory is meant as a queryable database of information, and trusts don’t change that!</p><h2 id="8df8" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">A Trust Attack Strategy</h2><p id="78d0" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Before we get into the technical details of how to enumerate and abuse trusts, I wanted to go over the high level strategy I use when auditing trust relationships. When I talk about a “trust attack strategy” what I mean is a way to laterally move from the domain in which your access currently resides into another domain you’re targeting.</p><p id="97f1" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><strong class="my gv">(1)</strong> The first step is to enumerate all trusts your current domain has, along with any trusts <em class="nv">those</em> domains have, and so on. Basically, you want to produce a mapping of all the domains you can reach from your current context through the linking of trust referrals. This will allow you to determine the domains you need to hop through to get to your target and what techniques you can execute to (possibly) achieve this. Any domains in the mapped “mesh” that are in the same forest (e.g. parent-&gt;child relationships) are of particular interest due to the SIDhistory-trust-hopping technique developed by <a class="af nu" href="https://twitter.com/pyrotek3" rel="noopener ugc nofollow" target="_blank">Sean Metcalf</a> and <a class="af nu" href="https://twitter.com/gentilkiwi" rel="noopener ugc nofollow" target="_blank">Benjamin Delpy</a>, also covered in the <strong class="my gv">The Trustpocalypse</strong> section.</p><p id="ab4e" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><strong class="my gv">(2)</strong> The next step is to enumerate any users/groups/computers (security principals) in one domain that either (1) have access to resources in another domain (i.e. membership in local administrator groups, or DACL ACE entries), or (2) are in groups or (if a group) have users from another domain. The point here is to find relationships that cross the mapped trust boundaries in some way, and therefore might provide a type of “access bridge” from one domain to another in the mesh. While a cross-domain nested relationship is not guaranteed to facilitate access, trusts are normally implemented for a reason, meaning more often than not some type of cross-domain user/group/resource “nesting” probably exists, and in many organizations these relationships are misconfigured. Another subnote- as mentioned, Kerberoasting across trusts <strong class="my gv">may</strong> be another vector to hop a trust boundary. Check out the <strong class="my gv">Another Sidenote: Kerberoasting Across Domain Trusts</strong> section for more information.</p><p id="0db2" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><strong class="my gv">(3)</strong> Now that you have mapped out the trust mesh, types, and cross-domain nested relationships, you have a map of what accounts you need to compromise to pivot from your current domain into your target. By performing targeted account compromise, and utilizing SID-history-hopping for domain trusts within a forest, we have been able to pivot through up to 7+ domains in the field to reach our objective.</p><p id="5217" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">At a minimum, remember that if a domain trusts you, i.e. if the trust is bidirectional or if one-way and inbound, then you can query any Active Directory information from the <em class="nv">trusting</em> domain. And remember that all parent-&gt;child (intra-forest domain trusts) retain an implicit two way transitive trust with each other. Also, due to how child domains are added, the “Enterprise Admins” group is automatically added to Administrators domain local group in each domain in the forest. This means that trust “flows down” from the forest root, making it our objective to move from child to forest root at any appropriate step in the attack chain.</p><h2 id="4c90" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">OK, How Do I Enumerate Trusts?</h2><p id="e92a" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">OK Will, you’ve piqued my interest. How do I go about figuring out what trust relationships exist in my environment?</p><p id="8bf9" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">As far as I know, there are three main methods to enumerate trusts: Win32 API calls, various .NET methods, and LDAP. Each one (frustratingly) returns a differing set of information, and each one has different execution methods. I’ll cover the old school ways and the new, from built-in (and external) binaries, to .NET, to Win32 API calls, to PowerShell/PowerView and <a class="af nu" href="https://github.com/BloodHoundAD/BloodHound/" rel="noopener ugc nofollow" target="_blank">BloodHound</a>.</p><p id="715b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The sample trust architecture I’ll be using for this post is:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div class="ou ov pv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*LCu9PRWQS3ryYRy2.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*LCu9PRWQS3ryYRy2.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*LCu9PRWQS3ryYRy2.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*LCu9PRWQS3ryYRy2.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*LCu9PRWQS3ryYRy2.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*LCu9PRWQS3ryYRy2.png 1100w, https://miro.medium.com/v2/resize:fit:684/format:webp/0*LCu9PRWQS3ryYRy2.png 684w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 342px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*LCu9PRWQS3ryYRy2.png 640w, https://miro.medium.com/v2/resize:fit:720/0*LCu9PRWQS3ryYRy2.png 720w, https://miro.medium.com/v2/resize:fit:750/0*LCu9PRWQS3ryYRy2.png 750w, https://miro.medium.com/v2/resize:fit:786/0*LCu9PRWQS3ryYRy2.png 786w, https://miro.medium.com/v2/resize:fit:828/0*LCu9PRWQS3ryYRy2.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*LCu9PRWQS3ryYRy2.png 1100w, https://miro.medium.com/v2/resize:fit:684/0*LCu9PRWQS3ryYRy2.png 684w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 342px"/><img alt="" class="bh md ph c" width="342" height="264" loading="lazy" role="presentation"/></picture></div></figure><p id="7b59" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This image was generated with the new <a class="af nu" href="https://github.com/HarmJ0y/TrustVisualizer" rel="noopener ugc nofollow" target="_blank">TrustVisualizer</a> output (described in the <strong class="my gv">Visualizing Domain Trusts</strong> section). With this new output, <strong class="my gv">green</strong> edges mean “within forest”, <strong class="my gv">red</strong> means external, and <strong class="my gv">blue</strong> means inter-forest trust relationships. As with <a class="af nu" href="https://twitter.com/sixdub" rel="noopener ugc nofollow" target="_blank">@sixdub’s</a> <a class="af nu" href="https://github.com/sixdub/DomainTrustExplorer" rel="noopener ugc nofollow" target="_blank">DomainTrustExplorer</a> the edge directions for one-way trust mean <em class="nv">direction of access</em>, not <em class="nv">direction of trust</em>.</p><h2 id="d5d8" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">.NET Methods</h2><p id="5359" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">.NET provides us with some nice method wrappers that can enumerate a good chunk of domain and forest trust information. This was the first method that PowerView implemented, before branching into Win32 API and LDAP methods.</p><p id="bd36" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The [System.DirectoryServices.ActiveDirectory.Domain] namespace has a <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.domain.getcurrentdomain(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">GetCurrentDomain()</a> static method that returns a <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.domain(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">System.DirectoryServices.ActiveDirectory.Domain</a> class instance. This class implements the <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.domain.getalltrustrelationships(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">GetAllTrustRelationships()</a> method which nicely, “<em class="nv">Retrieves all of the trust relationships for this domain.</em>” One advantage of this method is its simplicity — the information is laid out in a fashion that is easy to read and understand. One disadvantage is that it doesn’t contain some of the additional information that other enumeration methods produce.</p><blockquote class="pw px py"><p id="1a9c" class="mw mx nv my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</p></blockquote><p id="cf55" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This used to be PowerView’s default <strong class="my gv">Get-DomainTrust</strong> enumeration method. I recently changed the default method to be LDAP, as this .NET method does not return forest trusts by default, while LDAP enumeration does. So in order to execute this method, you now need to run <strong class="my gv">Get-DomainTrust -NET</strong>.</p><p id="612c" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Here’s how it looks for my sample domain setup, running the enumeration from <strong class="my gv">sub.dev.testlab.local</strong>:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*xyea9Y0sYsKL9HC1.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*xyea9Y0sYsKL9HC1.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*xyea9Y0sYsKL9HC1.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*xyea9Y0sYsKL9HC1.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*xyea9Y0sYsKL9HC1.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*xyea9Y0sYsKL9HC1.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xyea9Y0sYsKL9HC1.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*xyea9Y0sYsKL9HC1.png 640w, https://miro.medium.com/v2/resize:fit:720/0*xyea9Y0sYsKL9HC1.png 720w, https://miro.medium.com/v2/resize:fit:750/0*xyea9Y0sYsKL9HC1.png 750w, https://miro.medium.com/v2/resize:fit:786/0*xyea9Y0sYsKL9HC1.png 786w, https://miro.medium.com/v2/resize:fit:828/0*xyea9Y0sYsKL9HC1.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*xyea9Y0sYsKL9HC1.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*xyea9Y0sYsKL9HC1.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="148" loading="lazy" role="presentation"/></picture></div></div></figure><p id="bf5b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Forest trusts are functionally different than domain trusts. So if you want to enumerate any current forest-&gt;forest trusts, you need to call on <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.forest(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">[System.DirectoryServices.ActiveDirectory.Forest]</a> instead. Resulting forest objects also have their own <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.directoryservices.activedirectory.forest.getalltrustrelationships(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">GetAllTrustRelationships()</a> method which will return any current forest trusts:</p><blockquote class="pw px py"><p id="027f" class="mw mx nv my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()).GetAllTrustRelationships()</p></blockquote><p id="e8dc" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This is implemented as the default enumeration methods for PowerView’s <strong class="my gv">Get-ForestTrust</strong> function. Here’s how it looks for my sample domain setup, again from <strong class="my gv">sub.dev.testlab.local</strong>:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*ecIOhLJQtK6Lnqv3.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*ecIOhLJQtK6Lnqv3.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*ecIOhLJQtK6Lnqv3.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*ecIOhLJQtK6Lnqv3.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*ecIOhLJQtK6Lnqv3.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*ecIOhLJQtK6Lnqv3.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ecIOhLJQtK6Lnqv3.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*ecIOhLJQtK6Lnqv3.png 640w, https://miro.medium.com/v2/resize:fit:720/0*ecIOhLJQtK6Lnqv3.png 720w, https://miro.medium.com/v2/resize:fit:750/0*ecIOhLJQtK6Lnqv3.png 750w, https://miro.medium.com/v2/resize:fit:786/0*ecIOhLJQtK6Lnqv3.png 786w, https://miro.medium.com/v2/resize:fit:828/0*ecIOhLJQtK6Lnqv3.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*ecIOhLJQtK6Lnqv3.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*ecIOhLJQtK6Lnqv3.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="211" loading="lazy" role="presentation"/></picture></div></div></figure><h2 id="160e" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Win32API</h2><p id="169f" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">You can also enumerate domain trusts through the <a class="af nu" href="https://msdn.microsoft.com/en-us/library/ms675976(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank">DsEnumerateDomainTrusts()</a> Win32 API call which returns a <a class="af nu" href="https://msdn.microsoft.com/en-us/library/ms676059(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank">DS_DOMAIN_TRUSTS</a> structure. While the information is a bit more complex than the .NET methods, it returns the SID and GUID of the target domain, as well as some useful flags and attributes. The flags are <a class="af nu" href="https://msdn.microsoft.com/en-us/library/ms675976(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank">documented here</a> and will tell you the trust direction, whether the trust is within the same forest, etc. The attributes are <a class="af nu" href="https://msdn.microsoft.com/en-us/library/ms722477(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank">documented here</a> under the <strong class="my gv">TrustAttributes</strong> specification, and include things like WITHIN_FOREST, NON_TRANSITIVE, FILTER_SIDS, and more. FILTER_SIDS is the equivalent of QUARANTINED_DOMAIN if you ever see that nomenclature.</p><p id="2a02" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">You can invoke this method with <strong class="my gv">Get-DomainTrust -API</strong> (same sub.dev.testlab.local origination domain):</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*-XdEQOaPh69fc8RD.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*-XdEQOaPh69fc8RD.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*-XdEQOaPh69fc8RD.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*-XdEQOaPh69fc8RD.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*-XdEQOaPh69fc8RD.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*-XdEQOaPh69fc8RD.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-XdEQOaPh69fc8RD.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*-XdEQOaPh69fc8RD.png 640w, https://miro.medium.com/v2/resize:fit:720/0*-XdEQOaPh69fc8RD.png 720w, https://miro.medium.com/v2/resize:fit:750/0*-XdEQOaPh69fc8RD.png 750w, https://miro.medium.com/v2/resize:fit:786/0*-XdEQOaPh69fc8RD.png 786w, https://miro.medium.com/v2/resize:fit:828/0*-XdEQOaPh69fc8RD.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*-XdEQOaPh69fc8RD.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*-XdEQOaPh69fc8RD.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="660" loading="lazy" role="presentation"/></picture></div></div></figure><p id="c0b0" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Of note, this appears to be what <strong class="my gv">nltest.exe</strong> uses with its <strong class="my gv">/trusted_domains</strong> flag:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*JvduR4wVxiVzbq_0.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*JvduR4wVxiVzbq_0.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*JvduR4wVxiVzbq_0.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*JvduR4wVxiVzbq_0.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*JvduR4wVxiVzbq_0.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*JvduR4wVxiVzbq_0.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JvduR4wVxiVzbq_0.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*JvduR4wVxiVzbq_0.png 640w, https://miro.medium.com/v2/resize:fit:720/0*JvduR4wVxiVzbq_0.png 720w, https://miro.medium.com/v2/resize:fit:750/0*JvduR4wVxiVzbq_0.png 750w, https://miro.medium.com/v2/resize:fit:786/0*JvduR4wVxiVzbq_0.png 786w, https://miro.medium.com/v2/resize:fit:828/0*JvduR4wVxiVzbq_0.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*JvduR4wVxiVzbq_0.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*JvduR4wVxiVzbq_0.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="94" loading="lazy" role="presentation"/></picture></div></div></figure><p id="806e" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This is also the <a class="af nu" href="https://github.com/BloodHoundAD/SharpHound/blob/b2f98dc9e5675b5687964a7eaeeb3573fe6b676a/Sharphound2/Enumeration/DomainTrustEnumeration.cs#L140-L143" rel="noopener ugc nofollow" target="_blank">method that BloodHound uses</a> to enumerate domain trusts. You can execute this with the new <a class="af nu" href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1" rel="noopener ugc nofollow" target="_blank">SharpHound.ps1</a> ingestor by using the <strong class="my gv">Invoke-BloodHound -CollectionMethod trusts</strong> syntax. Note that this can also be combined with <strong class="my gv">-Domain &lt;foreign.domain.fqdn&gt;</strong> for foreign trust enumeration as well.</p><h2 id="08d7" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">LDAP</h2><p id="e873" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Domain trusts are stored in Active Directory as “trusted domain objects” with an objectClass of <a class="af nu" href="https://msdn.microsoft.com/en-us/library/ms683977(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank"><strong class="my gv">trustedDomain</strong></a>. This means you can use whatever LDAP querying method you would like to find out information about any domain trusts that are present by using the LDAP filter <strong class="my gv">(objectClass=trustedDomain)</strong>.</p><p id="6de6" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">For example, here’s dsquery (only available on Windows servers):</p><blockquote class="pw px py"><p id="c2ba" class="mw mx nv my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">dsquery * -filter “(objectClass=trustedDomain)” -attr *</p></blockquote><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*RcY7dWBg81Kqrrze.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*RcY7dWBg81Kqrrze.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*RcY7dWBg81Kqrrze.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*RcY7dWBg81Kqrrze.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*RcY7dWBg81Kqrrze.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*RcY7dWBg81Kqrrze.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RcY7dWBg81Kqrrze.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*RcY7dWBg81Kqrrze.png 640w, https://miro.medium.com/v2/resize:fit:720/0*RcY7dWBg81Kqrrze.png 720w, https://miro.medium.com/v2/resize:fit:750/0*RcY7dWBg81Kqrrze.png 750w, https://miro.medium.com/v2/resize:fit:786/0*RcY7dWBg81Kqrrze.png 786w, https://miro.medium.com/v2/resize:fit:828/0*RcY7dWBg81Kqrrze.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*RcY7dWBg81Kqrrze.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*RcY7dWBg81Kqrrze.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="394" loading="lazy" role="presentation"/></picture></div></div></figure><p id="8cb7" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The equivalent syntax with <a class="af nu" href="http://www.joeware.net/freetools/tools/adfind/" rel="noopener ugc nofollow" target="_blank">Joeware’s Adfind</a> is <strong class="my gv">.\adfind.exe -f objectclass=trusteddomain</strong>.</p><p id="8931" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">And finally PowerView, which again now uses this LDAP as the default enumeration method for <strong class="my gv">Get-DomainTrust</strong>:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*eQCc9ws32P6xvMPd.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*eQCc9ws32P6xvMPd.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*eQCc9ws32P6xvMPd.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*eQCc9ws32P6xvMPd.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*eQCc9ws32P6xvMPd.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*eQCc9ws32P6xvMPd.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eQCc9ws32P6xvMPd.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*eQCc9ws32P6xvMPd.png 640w, https://miro.medium.com/v2/resize:fit:720/0*eQCc9ws32P6xvMPd.png 720w, https://miro.medium.com/v2/resize:fit:750/0*eQCc9ws32P6xvMPd.png 750w, https://miro.medium.com/v2/resize:fit:786/0*eQCc9ws32P6xvMPd.png 786w, https://miro.medium.com/v2/resize:fit:828/0*eQCc9ws32P6xvMPd.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*eQCc9ws32P6xvMPd.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*eQCc9ws32P6xvMPd.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="399" loading="lazy" role="presentation"/></picture></div></div></figure><p id="1b6c" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Since this LDAP method is now the default for PowerView’s <strong class="my gv">Get-DomainTrust</strong>, I’m going to break down some of the result properties that might be a bit confusing.</p><p id="f3d6" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc223771.aspx" rel="noopener ugc nofollow" target="_blank">TrustType</a>:</p><ul class=""><li id="52fa" class="mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt pi pj pk bk"><strong class="my gv">DOWNLEVEL</strong> (0x00000001) — a trusted Windows domain that IS NOT running Active Directory. This is output as <strong class="my gv">WINDOWS_NON_ACTIVE_DIRECTORY</strong> in PowerView for those not as familiar with the terminology.</li><li id="dfcb" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">UPLEVEL</strong> (0x00000002) — a trusted Windows domain that IS running Active Directory.This is output as <strong class="my gv">WINDOWS_ACTIVE_DIRECTORY</strong> in PowerView for those not as familiar with the terminology.</li><li id="d073" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">MIT</strong> (0x00000003) — a trusted domain that is running a non-Windows (*nix), RFC4120-compliant Kerberos distribution. This is labeled as MIT due to, well, MIT publishing RFC4120.</li></ul><p id="61b7" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc223779.aspx" rel="noopener ugc nofollow" target="_blank">TrustAttributes</a>:</p><ul class=""><li id="2c18" class="mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt pi pj pk bk"><strong class="my gv">NON_TRANSITIVE</strong> (0x00000001) — the trust cannot be used transitively. That is, if DomainA trusts DomainB and DomainB trusts DomainC, then DomainA does not automatically trust DomainC. Also, if a trust is non-transitive, then you will not be able to query any Active Directory information from trusts up the chain from the non-transitive point. External trusts are implicitly non-transitive.</li><li id="242d" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">UPLEVEL_ONLY</strong> (0x00000002) — only Windows 2000 operating system and newer clients can use the trust.</li><li id="e1b0" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">QUARANTINED_DOMAIN </strong>(0x00000004) — SID filtering is enabled (more on this later). Output as <strong class="my gv">FILTER_SIDS</strong> with PowerView for simplicity.</li><li id="c221" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">FOREST_TRANSITIVE</strong> (0x00000008) — cross-forest trust between the root of two domain forests running at least domain functional level 2003 or above.</li><li id="b37b" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">CROSS_ORGANIZATION</strong> (0x00000010) — the trust is to a domain or forest that is not part of the organization, which adds the OTHER_ORGANIZATION SID. This is a bit of a weird one. I don’t remember encountering this flag in the field, but according <a class="af nu" href="https://imav8n.wordpress.com/2008/07/30/trust-attribute-cross_organization-and-selective-auth/" rel="noopener ugc nofollow" target="_blank">to this post</a> it means that the selective authentication security protection is enabled. For more information, check out <a class="af nu" href="https://technet.microsoft.com/en-us/library/cc755321(v=ws.10).aspx#w2k3tr_trust_security_zyzk" rel="noopener ugc nofollow" target="_blank">this MSDN doc</a>.</li><li id="8ed0" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">WITHIN_FOREST</strong> (0x00000020) — the trusted domain is within the same forest, meaning a parent-&gt;child or cross-link relationship</li><li id="fe25" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">TREAT_AS_EXTERNAL </strong>(0x00000040) — the trust is to be treated as external for trust boundary purposes. According <a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc223779.aspx" rel="noopener ugc nofollow" target="_blank">to the documentation</a>, “<em class="nv">If this bit is set, then a cross-forest trust to a domain is to be treated as an external trust for the purposes of SID Filtering. </em><strong class="my gv"><em class="nv">Cross-forest trusts are more stringently filtered than external trusts</em></strong><em class="nv">. This attribute relaxes those cross-forest trusts to be equivalent to external trusts.</em>” This sounds enticing, and I’m not 100% sure on the security implications of this statement ¯\_(ツ)_/¯ but I will update this post if anything new surfaces.</li><li id="7785" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">USES_RC4_ENCRYPTION </strong>(0x00000080) — if the TrustType is MIT, specifies that the trust that supports RC4 keys.</li><li id="ee20" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">USES_AES_KEYS</strong> (0x00000100) — not listed in the linked Microsoft documentation, but according to <a class="af nu" href="http://krbdev.mit.edu/rt/Ticket/Display.html?id=5477" rel="noopener ugc nofollow" target="_blank">some documentation</a> I’ve been able to <a class="af nu" href="https://retep998.github.io/doc/winapi/ntsecapi/constant.TRUST_ATTRIBUTE_TRUST_USES_AES_KEYS.html" rel="noopener ugc nofollow" target="_blank">find online</a>, it specifies that AES keys are used to encrypt KRB TGTs.</li><li id="68a4" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">CROSS_ORGANIZATION_NO_TGT_DELEGATION</strong> (0x00000200) — “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc223779.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">If this bit is set, tickets granted under this trust MUST NOT be trusted for delegation.</em></a>” This is described more in <a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc233949.aspx" rel="noopener ugc nofollow" target="_blank">[MS-KILE] 3.3.5.7.5</a> (Cross-Domain Trust and Referrals.)</li><li id="6b3e" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">PIM_TRUST</strong> (0x00000400) — “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc223779.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">If this bit and the TATE (treat as external) bit are set, then a cross-forest trust to a domain is to be treated as Privileged Identity Management trust for the purposes of SID Filtering.</em></a>” According to<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237940.aspx" rel="noopener ugc nofollow" target="_blank"> [MS-PAC] 4.1.2.2</a> (SID Filtering and Claims Transformation), “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237940.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">A domain can be externally managed by a domain that is outside the forest. The trusting domain allows SIDs that are local to its forest to come over a PrivilegedIdentityManagement trust.</em></a>” While I have not seen this in the field, and it’s only supported by domain functional level 2012R2 and above, it also warrants further investigation :)</li></ul><p id="1bc4" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">All of these methods can also be executed against a domain that currently trusts you. Meaning, if your current domain has a bidirectional trust with FOREIGN domain, or if the trust is one-way and inbound (meaning said domain trusts you and therefore you have some kind of access), you can execute these methods against said domain to find the trusts for THAT domain. If you want to do this with PowerView, just supply the <strong class="my gv">-Domain &lt;domain.fqdn&gt;</strong> parameter, described in more detail in the next section.</p><h2 id="ee62" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Data Enumeration Across Trusts With PowerView</h2><p id="fda5" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Last year I described my <a class="af nu" href="http://www.harmj0y.net/blog/powershell/make-powerview-great-again/" rel="noopener ugc nofollow" target="_blank">ground-up rewrite of PowerView</a>. One of the changes mentioned was that now, any <strong class="my gv">Get-Domain*</strong> function uses LDAP enumeration, meaning that we can pull said information from a domain that trusts us. This is done with the <strong class="my gv">-Domain &lt;domain.fqdn&gt;</strong> parameter:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*AvadO5OQYnwYQsji.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*AvadO5OQYnwYQsji.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*AvadO5OQYnwYQsji.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*AvadO5OQYnwYQsji.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*AvadO5OQYnwYQsji.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*AvadO5OQYnwYQsji.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AvadO5OQYnwYQsji.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*AvadO5OQYnwYQsji.png 640w, https://miro.medium.com/v2/resize:fit:720/0*AvadO5OQYnwYQsji.png 720w, https://miro.medium.com/v2/resize:fit:750/0*AvadO5OQYnwYQsji.png 750w, https://miro.medium.com/v2/resize:fit:786/0*AvadO5OQYnwYQsji.png 786w, https://miro.medium.com/v2/resize:fit:828/0*AvadO5OQYnwYQsji.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*AvadO5OQYnwYQsji.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*AvadO5OQYnwYQsji.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="363" loading="lazy" role="presentation"/></picture></div></div></figure><p id="403e" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So what’s actually happening under the hood?</p><p id="0ff2" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">For a long time, I thought that this would “reflect” LDAP queries through a domain controller in your current domain and onto domain controllers in the trusting domain. This would have been an awesome way to get around network boundaries, but sadly I was mistaken. What actually happens is that a referral is returned by the domain controller you are currently communicating with, which instructs your searching method to then bind to the foreign domain (i.e. the primary domain controller/PDC for that domain). If there is a trust with the foreign domain, an inter-realm TGT will be returned that can be used when communicating to the foreign domain.</p><p id="3a1a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This means that if there is network segmentation between the computer you’re currently querying from, and the PDC for the trusting domain, you won’t be able to retrieve any results &gt;_&lt;</p><p id="9e82" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">From the Kerberos side, “under the hood”, this means that a series of inter-realm referral tickets are automatically issued that allow our user to eventually request an LDAP service ticket from the target domain. If we use our sample domain architecture, and currently reside in <strong class="my gv">sub.dev.testlab.local</strong> while querying <strong class="my gv">prod.contoso.local</strong>, here’s how the klist output looks:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*7qGb-3BgXtMfizeS.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*7qGb-3BgXtMfizeS.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*7qGb-3BgXtMfizeS.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*7qGb-3BgXtMfizeS.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*7qGb-3BgXtMfizeS.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*7qGb-3BgXtMfizeS.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7qGb-3BgXtMfizeS.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*7qGb-3BgXtMfizeS.png 640w, https://miro.medium.com/v2/resize:fit:720/0*7qGb-3BgXtMfizeS.png 720w, https://miro.medium.com/v2/resize:fit:750/0*7qGb-3BgXtMfizeS.png 750w, https://miro.medium.com/v2/resize:fit:786/0*7qGb-3BgXtMfizeS.png 786w, https://miro.medium.com/v2/resize:fit:828/0*7qGb-3BgXtMfizeS.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*7qGb-3BgXtMfizeS.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*7qGb-3BgXtMfizeS.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="432" loading="lazy" role="presentation"/></picture></div></div></figure><p id="4d0a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">You can see the inter-realm tickets filtering up the trust chain to <strong class="my gv">testlab.local</strong>, and eventually to <strong class="my gv">contoso.local</strong> and eventually to <strong class="my gv">prod.contoso.local</strong>.</p><h2 id="b32c" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Mapping Domain Trusts</h2><p id="d853" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">There are few ways I know of to map the “mesh” of one or more trusts that exist in your environment. The first is through the global catalog. I talked about this a bit in my “<a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/" rel="noopener ugc nofollow" target="_blank">A Pentester’s Guide to Group Scoping</a>” post, but I’ll reiterate some of that information here.</p><p id="a2ec" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The <a class="af nu" href="https://technet.microsoft.com/en-us/library/cc728188(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">global catalog is a partial copy of all objects</a> in an Active Directory forest, meaning that some object properties (but not all) are contained within it. This data is replicated among all domain controllers marked as global catalogs for the forest. Trusted domain objects are replicated in the global catalog, so we can enumerate every single internal and external trust that all domains in our current forest have extremely quickly, and only with traffic to our current PDC by running <strong class="my gv">Get-DomainTrust -SearchBase “GC://$($ENV:USERDNSDOMAIN)”</strong> through PowerView. Here’s how that looks running that function from <strong class="my gv">sub.dev.testlab.local </strong>domain:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*vafvt2x7LZRp5_CB.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*vafvt2x7LZRp5_CB.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*vafvt2x7LZRp5_CB.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*vafvt2x7LZRp5_CB.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*vafvt2x7LZRp5_CB.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*vafvt2x7LZRp5_CB.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vafvt2x7LZRp5_CB.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*vafvt2x7LZRp5_CB.png 640w, https://miro.medium.com/v2/resize:fit:720/0*vafvt2x7LZRp5_CB.png 720w, https://miro.medium.com/v2/resize:fit:750/0*vafvt2x7LZRp5_CB.png 750w, https://miro.medium.com/v2/resize:fit:786/0*vafvt2x7LZRp5_CB.png 786w, https://miro.medium.com/v2/resize:fit:828/0*vafvt2x7LZRp5_CB.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*vafvt2x7LZRp5_CB.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*vafvt2x7LZRp5_CB.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="488" loading="lazy" role="presentation"/></picture></div></div></figure><p id="1cfd" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This is a lot more results than just <strong class="my gv">Get-DomainTrust</strong> !</p><p id="8da1" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The second method is slower, but will provide even more results. Since we can enumerate any trusts that our current domain context has, and by way of referrals through LDAP, we can query any <strong class="my gv">(objectClass=trustedDomain) </strong>objects from domains that currently trust our domain, then we can keep issuing these queries for any results and “crawl” any reachable domains. Any domains marked as non-transitive can mess these results up, but we can still get a good number of results.</p><p id="1f2f" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The PowerView function to do this is <strong class="my gv">Get-DomainTrustMapping</strong> (formerly Invoke-MapDomainTrust). These results can be exported to a CSV by piping <strong class="my gv">Get-DomainTrustMapping</strong> to <strong class="my gv">| Export-CSV -NoTypeInformation trusts.csv</strong>.</p><p id="ba63" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The last way is through BloodHound/SharpHound. Again, you can execute this with the new <a class="af nu" href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1" rel="noopener ugc nofollow" target="_blank">SharpHound.ps1</a> ingestor by using the <strong class="my gv">Invoke-BloodHound -CollectionMethod trusts</strong> syntax, and this can be combined with <strong class="my gv">-Domain &lt;foreign.domain.fqdn&gt;</strong> for foreign trust enumeration.</p><p id="de1f" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">A key thing to remember is that the exact trust mapping you’ll get will depend on the domain you’re currently in. Since the trust between <strong class="my gv">external.local</strong> and <strong class="my gv">sub.dev.testlab.local</strong> domain is a one-way <em class="nv">non-transitive</em> external trust, if you’re querying from <strong class="my gv">external.local</strong> you won’t be able to see the trusts that <strong class="my gv">contoso.local</strong> has, again because <strong class="my gv">sub.dev.testlab.local</strong> won’t repackage your TGT into an inter-realm TGT that can be forwarded onto any other domain. Also, if you’re trying to enumerate the trusts on a foreign domain, you need to be able to bind to a domain controller (usually the PDC/primary domain controller) in the foreign domain you’re querying. So, even if there is a transitive trust that would allow you to query the information, if network segmentation prevents you from talking to the target foreign domain, you’re out of luck.</p><h2 id="3fb6" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Visualizing Domain Trusts</h2><p id="e07d" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Data is one thing, visualizations are another. A few years ago, one of my former workmates, Justin Warner, saw all this raw data and build a tool called <a class="af nu" href="https://github.com/sixdub/DomainTrustExplorer" rel="noopener ugc nofollow" target="_blank">DomainTrustExplorer</a> that could perform some nodal analysis and visualization with PowerView’s mapped trust data.</p><p id="56f9" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">As the default trust output has changed, and with BloodHound taking care of nodal analysis for us, I rewrote Justin’s project into a simplified form that will take the updated trust .CSVs, <a class="af nu" href="https://github.com/HarmJ0y/TrustVisualizer" rel="noopener ugc nofollow" target="_blank">TrustVisualizer</a>:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*YzS_paZEo9QjsD5c.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*YzS_paZEo9QjsD5c.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*YzS_paZEo9QjsD5c.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*YzS_paZEo9QjsD5c.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*YzS_paZEo9QjsD5c.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*YzS_paZEo9QjsD5c.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YzS_paZEo9QjsD5c.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*YzS_paZEo9QjsD5c.png 640w, https://miro.medium.com/v2/resize:fit:720/0*YzS_paZEo9QjsD5c.png 720w, https://miro.medium.com/v2/resize:fit:750/0*YzS_paZEo9QjsD5c.png 750w, https://miro.medium.com/v2/resize:fit:786/0*YzS_paZEo9QjsD5c.png 786w, https://miro.medium.com/v2/resize:fit:828/0*YzS_paZEo9QjsD5c.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*YzS_paZEo9QjsD5c.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*YzS_paZEo9QjsD5c.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="116" loading="lazy" role="presentation"/></picture></div></div></figure><p id="077d" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The resulting graphml can be visualized with yEd, <a class="af nu" href="http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/" rel="noopener ugc nofollow" target="_blank">as described here</a>. This is how I produced the the previous visualization of the sample trust architecture:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div class="ou ov pv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*94EMQtGo-f_-LE3_.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*94EMQtGo-f_-LE3_.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*94EMQtGo-f_-LE3_.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*94EMQtGo-f_-LE3_.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*94EMQtGo-f_-LE3_.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*94EMQtGo-f_-LE3_.png 1100w, https://miro.medium.com/v2/resize:fit:684/format:webp/0*94EMQtGo-f_-LE3_.png 684w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 342px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*94EMQtGo-f_-LE3_.png 640w, https://miro.medium.com/v2/resize:fit:720/0*94EMQtGo-f_-LE3_.png 720w, https://miro.medium.com/v2/resize:fit:750/0*94EMQtGo-f_-LE3_.png 750w, https://miro.medium.com/v2/resize:fit:786/0*94EMQtGo-f_-LE3_.png 786w, https://miro.medium.com/v2/resize:fit:828/0*94EMQtGo-f_-LE3_.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*94EMQtGo-f_-LE3_.png 1100w, https://miro.medium.com/v2/resize:fit:684/0*94EMQtGo-f_-LE3_.png 684w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 342px"/><img alt="" class="bh md ph c" width="342" height="264" loading="lazy" role="presentation"/></picture></div></figure><p id="c7eb" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Again, with this new output, <strong class="my gv">green</strong> edges mean “within forest”, <strong class="my gv">red</strong> means external, and <strong class="my gv">blue</strong> means inter-forest trust relationships. As with <a class="af nu" href="https://twitter.com/sixdub" rel="noopener ugc nofollow" target="_blank">@sixdub</a>’s <a class="af nu" href="https://github.com/sixdub/DomainTrustExplorer" rel="noopener ugc nofollow" target="_blank">DomainTrustExplorer</a> the edge directions for one-way trust mean <em class="nv">direction of access</em>, not <em class="nv">direction of trust</em>.</p><p id="170a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">When using SharpHound to collect the trust data, and BloodHound to visualization it, here’s how the same above data looks:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov pz"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*32bW7GhBrrzciUTr.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*32bW7GhBrrzciUTr.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*32bW7GhBrrzciUTr.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*32bW7GhBrrzciUTr.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*32bW7GhBrrzciUTr.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*32bW7GhBrrzciUTr.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*32bW7GhBrrzciUTr.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*32bW7GhBrrzciUTr.png 640w, https://miro.medium.com/v2/resize:fit:720/0*32bW7GhBrrzciUTr.png 720w, https://miro.medium.com/v2/resize:fit:750/0*32bW7GhBrrzciUTr.png 750w, https://miro.medium.com/v2/resize:fit:786/0*32bW7GhBrrzciUTr.png 786w, https://miro.medium.com/v2/resize:fit:828/0*32bW7GhBrrzciUTr.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*32bW7GhBrrzciUTr.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*32bW7GhBrrzciUTr.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="392" loading="lazy" role="presentation"/></picture></div></div></figure><h2 id="39cb" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Foreign Relationship Enumeration</h2><p id="2757" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Now that we’ve mapped out all domain trusts reachable from the machine we’re querying from, the next step in the attack planning phase hits few branches, depending on the specific types of the trusts we’ve encountered. These next steps need to be executed for the hop from each each domain to another in the attack path.</p><p id="d095" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If the next domain hop is in the same forest as the domain we’re pivoting from/through, <strong class="my gv"><em class="nv">and</em></strong> we’re able to compromise the krbtgt hash of the child domain, then we can use the method described in the following <strong class="my gv">Trustpocalypse</strong> section to compromise the forest root.</p><p id="b577" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If we’re not able to compromise elevated access in the current/pivot child domain, or if the next step in the trust attack path is an external/forest trust, then we need to enumerate what users (if any) from the domain we’re a part of are in groups in the target domain (or the next step in the domain attack path.)</p><p id="9f7f" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Unfortunately, there are a lot of caveats with this step. The exact nature of the trust your current domain retains with the <em class="nv">trusting</em> domain you’re querying will affect what information you can retrieve, and the exact methods you can use. In general, again, this enumeration heavily depends on whether you’re querying a foreign domain in the same forest, or across an external/inter-forest trust. I’ll do my best to explain all the subtleties.</p><p id="dd52" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">There are three <strong class="my gv">main</strong> ways that security principals (users/groups) from one domain can have access into resources in another foreign/<em class="nv">trusting</em> domain:</p><ul class=""><li id="1c8f" class="mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt pi pj pk bk">They can be added to local groups on individual machines, i.e. the local “Administrators” group on a server.</li><li id="9d68" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk">They can be added to groups in the foreign domain. There are some caveats depending on trust type and group scope, described shortly.</li><li id="fcf4" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk">They can be added as principals in an access control list, most interesting for us as principals in ACEs in a DACL. For more background on ACLs/DACLs/ACEs, check out the “<a class="af nu" href="https://specterops.io/assets/resources/an_ace_up_the_sleeve.pdf" rel="noopener ugc nofollow" target="_blank">An ACE Up The Sleeve</a>” whitepaper.</li></ul><h2 id="ffde" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Case 1: Local Group Membership</h2><p id="c152" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">This involves enumerating the local memberships of one or more systems through remote SAM (SAMR) or <a class="af nu" href="http://www.harmj0y.net/blog/redteaming/where-my-admins-at-gpo-edition/" rel="noopener ugc nofollow" target="_blank">through GPO correlation</a>. I won’t cover this case heavily here, but will note that we have had success in the past with targeted SAMR enumeration of high value servers or domain controllers for trust-hopping. The PowerView function to do this manually is <strong class="my gv">Get-NetLocalGroupMember &lt;server&gt;</strong>, and BloodHound will do this all automatically for you.</p><h2 id="d31f" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Case 2: Foreign Group Membership</h2><p id="8c02" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">The group membership case gets a bit tricky. The <strong class="my gv">member</strong> property of an Active Directory group and the <strong class="my gv">memberOf</strong> property of a user/group object have a special type of relationship called <a class="af nu" href="https://msdn.microsoft.com/en-us/library/ms677270(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank">linked attributes</a>. I covered this <a class="af nu" href="http://www.harmj0y.net/blog/defense/hunting-with-active-directory-replication-metadata/" rel="noopener ugc nofollow" target="_blank">in more depth in a previous post</a>, but with linked attributes, Active Directory calculates the value of a given attribute, referred to as the back link (e.g. <strong class="my gv">memberOf</strong> with users/groups) from the value of another attribute, referred to as the forward link (e.g. <strong class="my gv">member</strong> with a group). The gist is that group membership is ultimately preserved within the target group itself in the <strong class="my gv">member</strong> property, and this all gets a bit complicated over trusts. Hopefully this will make more sense shortly. Whether or not the <strong class="my gv">memberOf</strong> property saved with a user/group object reflects their foreign group memberships depends on the nature of the trust and scoping of the foreign group they’re a member in.</p><p id="2632" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Here’s a breakdown of the three group scopings, and which can have what type of foreign members added:</p><ul class=""><li id="7b4a" class="mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt pi pj pk bk"><strong class="my gv">Domain Local Groups</strong> can have intra-forest cross-domain users (users in the same forest as the group) added as members, as well as inter-forest cross-domain users (foreign security principals.)</li><li id="7708" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">Global Groups</strong> can not have any cross-domain memberships, even within the same forest. So for our purposes we can ignore these.</li><li id="539c" class="mw mx gu my b mz pl nb nc nd pm nf ng nh pn nj nk nl po nn no np pp nr ns nt pi pj pk bk"><strong class="my gv">Universal Groups</strong> can have any user in the forest as a member, but “foreign security principals” (i.e. users from forest/external trusts) can not be a part of universal groups.</li></ul><p id="e06e" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If a user/group is nested into a group in another domain that’s in the same forest (so a “domain local” or “universal group”) then depending on <a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/" rel="noopener ugc nofollow" target="_blank">the target group’s scope</a> the membership <em class="nv">might</em> be updated in the user/group’s <strong class="my gv">memberOf</strong> property. Groups with a “universal” scope have their memberships replicated in the global catalog for the forest, meaning a user’s <strong class="my gv">memberOf</strong> will be updated. If the group’s scope the user is added to is “domain local”, then the user’s <strong class="my gv">memberOf</strong> will NOT be updated (in the global catalog), as a group with “domain local” scope does not have its memberships replicated in the forest. So the only way to tell what a user’s foreign group memberships are, by solely looking at the user object, is if they are added to a universal group in the same forest. However, this also means that if we can bind to the global catalog of a forest, we can enumerate all of these specific cross-domain relationships easily.</p><p id="e24e" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If the user is nested in a group in a domain over a forest/external trust, then things are treated a bit differently. Users that exist over external or forest trusts can still be added to <a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/" rel="noopener ugc nofollow" target="_blank"><strong class="my gv">domain local</strong></a> groups in the specified domain. These users show up as new entries in <strong class="my gv">CN=ForeignSecurityPrincipals,DC=domain,DC=com</strong> in the domain to which they’re being added, which are used as a kind of proxy that allows the foreign security identifiers to be added to resources in the domain.</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov qa"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*k6UHuikx0MRq8-Ga.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*k6UHuikx0MRq8-Ga.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*k6UHuikx0MRq8-Ga.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*k6UHuikx0MRq8-Ga.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*k6UHuikx0MRq8-Ga.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*k6UHuikx0MRq8-Ga.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k6UHuikx0MRq8-Ga.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*k6UHuikx0MRq8-Ga.png 640w, https://miro.medium.com/v2/resize:fit:720/0*k6UHuikx0MRq8-Ga.png 720w, https://miro.medium.com/v2/resize:fit:750/0*k6UHuikx0MRq8-Ga.png 750w, https://miro.medium.com/v2/resize:fit:786/0*k6UHuikx0MRq8-Ga.png 786w, https://miro.medium.com/v2/resize:fit:828/0*k6UHuikx0MRq8-Ga.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*k6UHuikx0MRq8-Ga.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*k6UHuikx0MRq8-Ga.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="455" loading="lazy" role="presentation"/></picture></div></div></figure><p id="aeff" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">As Microsoft explains it, “<a class="af nu" href="https://technet.microsoft.com/en-us/library/cc773178(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">When a trust is established between a domain in a forest and a domain outside of that forest, security principals from the external domain can access resources in the internal domain. Active Directory creates a foreign security principal object in the internal domain to represent each security principal from the trusted external domain. These foreign security principals </em><strong class="my gv"><em class="nv">can become members of domain local groups</em></strong><em class="nv"> in the internal domain</em></a>“. If “domain local” or “group scoping” are foreign to you, check out my <a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/" rel="noopener ugc nofollow" target="_blank">previous post on the subject</a>.</p><p id="0320" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Tl;dr, as I understand it, these ForeignSecurityPrincipals act as aliases for the “real” user that’s external to the domain/forest, and it’s the ForeignSecurityPrincipal that’s actually added to groups in the target domain. The SID of a given ForeignSecurityPrincipal is the same SID as the foreign user, which makes for easy filtering later.</p><h2 id="9cb3" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Case 3: Foreign ACL Principals</h2><p id="4ae2" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Luckily most of the <strong class="my gv">ntSecurityDescriptor</strong> property of Active Directory objects is (1) accessible to any domain authenticated user, and (2) replicated in the global catalog. This means that if from your current domain context, you can query the DACLs for all objects in a <em class="nv">trusting</em> domain, and filter any ACE entries where a foreign security principal has the given right on the object you’re enumerating.</p><p id="02f3" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">You can use PowerView’s <strong class="my gv">Get-DomainObjectACL -Domain &lt;domain.fqdn&gt;</strong> function to retrieve these ACEs, but in order to find cross-domain DACL relationships, you will need to filter out principals/SecurityIdentifiers that do not match the SID of the domain you’re querying. I’ll cover this in a future <a class="af nu" href="http://www.harmj0y.net/blog/powershell/the-powerview-powerusage-series-1/" rel="noopener ugc nofollow" target="_blank"><strong class="my gv">PowerView PowerUsage</strong></a> post.</p><h2 id="c39a" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Operational Guidance</h2><p id="04d1" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Note: I’ll also walk over all steps needed in the <strong class="my gv">Case Study</strong> section later in the post in case parts of this don’t make sense.</p><p id="80a0" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If you’re currently within a child domain within a forest, and <em class="nv">DO</em> have elevated access in said child domain, refer to the <strong class="my gv">Trustpocalypse</strong> section.</p><p id="db36" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If you’re currently within a child domain within a forest, and <em class="nv">DO NOT</em> have elevated access in said child domain, then you can run PowerView’s <strong class="my gv">Get-DomainForeignUser</strong> function to enumerate users who are in groups outside of the user’s current domain. This is a domain’s “outgoing” access, i.e. users/groups who may have some kind of access into other domain groups <em class="nv">within the same forest.</em> This function can be useful to also map other intra-forest domain user/group relationships:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*yaRp_hyfh1l3SVMW.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*yaRp_hyfh1l3SVMW.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*yaRp_hyfh1l3SVMW.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*yaRp_hyfh1l3SVMW.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*yaRp_hyfh1l3SVMW.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*yaRp_hyfh1l3SVMW.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yaRp_hyfh1l3SVMW.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*yaRp_hyfh1l3SVMW.png 640w, https://miro.medium.com/v2/resize:fit:720/0*yaRp_hyfh1l3SVMW.png 720w, https://miro.medium.com/v2/resize:fit:750/0*yaRp_hyfh1l3SVMW.png 750w, https://miro.medium.com/v2/resize:fit:786/0*yaRp_hyfh1l3SVMW.png 786w, https://miro.medium.com/v2/resize:fit:828/0*yaRp_hyfh1l3SVMW.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*yaRp_hyfh1l3SVMW.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*yaRp_hyfh1l3SVMW.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="183" loading="lazy" role="presentation"/></picture></div></div></figure><p id="4750" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If you’re targeting an external/forest domain, or a target domain within the same forest, you can use PowerView’s <strong class="my gv">Get-DomainForeignGroupMember -Domain &lt;target.domain.fqdn&gt;</strong> function. This enumerates <em class="nv">groups</em> in the target domain that contain <em class="nv">users/groups</em> who are not in the target domain. This is a domain’s “incoming” access, i.e. groups in target domain with inbound membership relationships:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*6BDToLnyxe92G40P.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*6BDToLnyxe92G40P.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*6BDToLnyxe92G40P.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*6BDToLnyxe92G40P.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*6BDToLnyxe92G40P.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*6BDToLnyxe92G40P.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6BDToLnyxe92G40P.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*6BDToLnyxe92G40P.png 640w, https://miro.medium.com/v2/resize:fit:720/0*6BDToLnyxe92G40P.png 720w, https://miro.medium.com/v2/resize:fit:750/0*6BDToLnyxe92G40P.png 750w, https://miro.medium.com/v2/resize:fit:786/0*6BDToLnyxe92G40P.png 786w, https://miro.medium.com/v2/resize:fit:828/0*6BDToLnyxe92G40P.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*6BDToLnyxe92G40P.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*6BDToLnyxe92G40P.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="435" loading="lazy" role="presentation"/></picture></div></div></figure><p id="6c5b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Also, luckily for us, ForeignSecurityPrincipals are replicated in the global catalog, just like trusted domain objects (mentioned in the <strong class="my gv">Mapping Domain Trusts</strong> section). So if you want to quickly enumerate all foreign security principals (i.e. any inbound foreign groups/users) that are members of groups within a domain within the current/target forest, you can query any global catalog with an LDAP filter of <strong class="my gv">‘(objectclass=foreignSecurityPrincipal)’</strong>. And since these foreign principals can only be added to groups with a <a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/" rel="noopener ugc nofollow" target="_blank">domain local scope</a>, we can extract the domain the foreign user was added to from the distinguishedname, query that domain directly for domain local-scoped groups with members, assuming we have some type of direct or transitive trust with that target domain. This allows us to compare the membership of these domain local groups each against the list of foreign users:</p><figure class="ox oy oz pa pb pc"><div class="qb jf l fj"><div class="qc qd l"></div></div></figure><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*yu4pUPRwc5KwYvye.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*yu4pUPRwc5KwYvye.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*yu4pUPRwc5KwYvye.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*yu4pUPRwc5KwYvye.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*yu4pUPRwc5KwYvye.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*yu4pUPRwc5KwYvye.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yu4pUPRwc5KwYvye.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*yu4pUPRwc5KwYvye.png 640w, https://miro.medium.com/v2/resize:fit:720/0*yu4pUPRwc5KwYvye.png 720w, https://miro.medium.com/v2/resize:fit:750/0*yu4pUPRwc5KwYvye.png 750w, https://miro.medium.com/v2/resize:fit:786/0*yu4pUPRwc5KwYvye.png 786w, https://miro.medium.com/v2/resize:fit:828/0*yu4pUPRwc5KwYvye.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*yu4pUPRwc5KwYvye.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*yu4pUPRwc5KwYvye.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="320" loading="lazy" role="presentation"/></picture></div></div></figure><p id="0eee" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This quickly gives us a mapping of all the foreign user/group nested relationships inbound into our current (or target) forest.</p><p id="1c16" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If you are using <a class="af nu" href="https://github.com/BloodHoundAD/BloodHound/" rel="noopener ugc nofollow" target="_blank">BloodHound</a> with its new <a class="af nu" href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1" rel="noopener ugc nofollow" target="_blank">SharpHound</a> ingestor, you can still use <strong class="my gv">-Domain &lt;domain.fqdn&gt;</strong> with the ingestor combined with the <strong class="my gv">-CollectionMethod</strong> options of ‘Group’, ‘LocalGroup’, and/or ‘ACL’. BloodHound models user/group nodes with the <strong class="my gv">name@&lt;domain.fqdn&gt;</strong> syntax in the schema. This removes the requirement of having to perform complex analytics to extract these relationships after the data has been collected. If <strong class="my gv">user@dev.testlab.local</strong> is a member of <strong class="my gv">group@testlab.local</strong>, that memberOf relationship is automatically modeled. If that nested group relationship shows up in any attack paths, it will be automatically included in your graph with no extra effort.</p><p id="db4f" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Makes perfect sense, right? :) This is a complex topic if you’re not familiar, so reread the previous section a few times until it makes sense how to tease out these cross-domain relationships. Check out the <strong class="my gv">Case Study </strong>section for a realistic walk through with the reference architecture I’ve used throughout this post.</p><h2 id="a066" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">The Trustpocalypse — SID Hopping Up Intra-Forest Trusts</h2><p id="2a17" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">This is one of my favorite things I’ve learned about in the last few years in security. Just as most people remember the first time they saw <a class="af nu" href="https://github.com/gentilkiwi/mimikatz" rel="noopener ugc nofollow" target="_blank">Mimikatz</a> extract a plaintext password out of memory, the memory of when I realized what this attack entailed is seared into my mind.</p><p id="c592" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">It started as many of my brain-blowing moments have, by viewing a <a class="af nu" href="https://twitter.com/gentilkiwi/status/615289503029305345" rel="noopener ugc nofollow" target="_blank">tweet from Benjamin Delpy</a> in June of 2015, and at first not understanding the implications:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov qe"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*XSo97Lc2aAN-7ein.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*XSo97Lc2aAN-7ein.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*XSo97Lc2aAN-7ein.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*XSo97Lc2aAN-7ein.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*XSo97Lc2aAN-7ein.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*XSo97Lc2aAN-7ein.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XSo97Lc2aAN-7ein.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*XSo97Lc2aAN-7ein.png 640w, https://miro.medium.com/v2/resize:fit:720/0*XSo97Lc2aAN-7ein.png 720w, https://miro.medium.com/v2/resize:fit:750/0*XSo97Lc2aAN-7ein.png 750w, https://miro.medium.com/v2/resize:fit:786/0*XSo97Lc2aAN-7ein.png 786w, https://miro.medium.com/v2/resize:fit:828/0*XSo97Lc2aAN-7ein.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*XSo97Lc2aAN-7ein.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*XSo97Lc2aAN-7ein.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="726" loading="lazy" role="presentation"/></picture></div></div></figure><p id="8340" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">After chatting with Benjamin to confirm what I thought the implications were, his response was “Sorry for your head :)”</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div class="ou ov qf"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*C3HcNhb_HuexXluT.gif 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*C3HcNhb_HuexXluT.gif 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*C3HcNhb_HuexXluT.gif 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*C3HcNhb_HuexXluT.gif 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*C3HcNhb_HuexXluT.gif 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*C3HcNhb_HuexXluT.gif 1100w, https://miro.medium.com/v2/resize:fit:960/format:webp/0*C3HcNhb_HuexXluT.gif 960w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 480px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*C3HcNhb_HuexXluT.gif 640w, https://miro.medium.com/v2/resize:fit:720/0*C3HcNhb_HuexXluT.gif 720w, https://miro.medium.com/v2/resize:fit:750/0*C3HcNhb_HuexXluT.gif 750w, https://miro.medium.com/v2/resize:fit:786/0*C3HcNhb_HuexXluT.gif 786w, https://miro.medium.com/v2/resize:fit:828/0*C3HcNhb_HuexXluT.gif 828w, https://miro.medium.com/v2/resize:fit:1100/0*C3HcNhb_HuexXluT.gif 1100w, https://miro.medium.com/v2/resize:fit:960/0*C3HcNhb_HuexXluT.gif 960w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 480px"/><img alt="" class="bh md ph c" width="480" height="360" loading="lazy" role="presentation"/></picture></div></figure><p id="96bb" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This is all thanks to work that <a class="af nu" href="https://twitter.com/gentilkiwi" rel="noopener ugc nofollow" target="_blank">Benjamin</a> and <a class="af nu" href="https://twitter.com/pyrotek3" rel="noopener ugc nofollow" target="_blank">Sean Metcalf</a> worked on to make Golden tickets even more “golden”. I blogged about this back in August of 2015 after their work was released in a post titled “<a class="af nu" href="http://www.harmj0y.net/blog/redteaming/the-trustpocalypse/" rel="noopener ugc nofollow" target="_blank">The Trustpocalypse.</a>”</p><p id="2b95" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Previous to this work, our strategy was to map out foreign user/group memberships and hop from child trust up to the forest root “by hand”, often a painstaking process in large environments with lots of domains. As described in the <strong class="my gv">Trust Attack Strategy</strong> section, we always interpreted trust as “flowing down” from the forest root to child domains due to the “Enterprise Admins” group. However, Microsoft has stated for years that “<a class="af nu" href="https://technet.microsoft.com/en-us/library/cc755979(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">the forest is the security boundary for Active Directory</em></a>“, and an attack against intra-forest domains <a class="af nu" href="http://windowsitpro.com/windows-server/exploiting-sidhistory-ad-attribute" rel="noopener ugc nofollow" target="_blank">has been known since (at least) 2005</a>.</p><p id="fef9" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">But first, in order for this to make complete sense, I have to explain <strong class="my gv">sidHistory</strong> and the SID filtering security mechanism, and what this all means for domains within a forest.</p><p id="d6b9" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><strong class="my gv">sidHistory</strong> was added with Windows 2000 Active Directory, and was meant to facilitate the migration of users from one domain to another. If a user is migrated, their old security identifier (SID), along with the SIDs of any group they were previously a part of, can optionally be added to the sidHistory attribute of their new user account. When the new user attempts to access a resource, “<a class="af nu" href="https://technet.microsoft.com/en-us/library/cc974408(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">if the SID or the SID history matches, access to the resource is granted or denied, according to the access specified in the ACL.</em></a>” Meaning, any group/old user SID that is set in a user’s sidHistory property grants them access <em class="nv">as if they were that user or a member of those groups</em>.</p><p id="df1e" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Due to how trusts work within an Active Directory forest, the <strong class="my gv">sidHistory</strong> property (“ExtraSids” in the PAC) is respected within the domains of a forest because those SIDs are not filtered out in cross-domain referrals by the “SID Filtering” protection. So any user in a child domain that has their <strong class="my gv">sidHistory</strong>/<strong class="my gv">ExtraSids</strong> set to, say, the “Enterprise Admins” SID (a group that exists only in the forest root) will effectively function <em class="nv">as if they are an enterprise administrator</em>. As Microsoft has known this is an issue, and the knowledge has been public since at least this <a class="af nu" href="http://windowsitpro.com/windows-server/exploiting-sidhistory-ad-attribute" rel="noopener ugc nofollow" target="_blank">2005 ITPro Windows article</a> and almost certainly before, <strong class="my gv">sidHistory</strong> is a protected attribute that is extremely difficult to modify.</p><p id="65dd" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Previously, abuse of this involved a pretty complex process, and included modifying the <strong class="my gv">sidHistory</strong> in the Active Directory database (ntds.dit) of the associated domain. There’s more detail about exactly why/how this works in the <strong class="my gv">Epilogue: SID Filtering</strong> section.</p><p id="9cf4" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><strong class="my gv">THIS IS WHY THE FOREST IS THE “TRUST BOUNDARY” IN ACTIVE DIRECTORY, NOT THE DOMAIN!</strong></p><p id="1aad" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Benjamin and Sean realized that with the introduction of Mimikatz’ Golden Tickets, an attacker could set the <strong class="my gv">ExtraSids</strong> section of the <a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237948.aspx" rel="noopener ugc nofollow" target="_blank">KERB_VALIDATION_INFO</a> structure created for the ticket (the structure that “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237948.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">defines the user’s logon and authorization information provided by the DC</em></a>“). The <strong class="my gv">ExtraSids </strong>section is described as “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237948.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">A pointer to a list of KERB_SID_AND_ATTRIBUTES structures that contain a list of SIDs corresponding to groups in domains other than the account domain to which the principal belongs</em></a>” (the KERB_SID_AND_ATTRIBUTES structure <a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237947.aspx" rel="noopener ugc nofollow" target="_blank">is defined here</a>.)</p><p id="524c" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This means that if an attacker compromises “Domain Administrator” rights (or equivalent, actually just any account that can DCSync ;) in ANY child domain in the forest for just 5 minutes, the krbtgt hash of the child domain can be retrieved, and <strong class="my gv">/sids:&lt;sid_of_enterprise_admins_in_forest_root&gt;</strong> can be added to the Mimikatz constructed ticket without modifying the Active Directory database. This gives the attacker the ability to “hop up” the forest trust relationship and compromise the forest root domain.</p><p id="542a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If this is your first time hearing about this technique, as Benjamin said, “Sorry for your head. :)”</p><p id="4049" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">For our operational attack strategy, this means that if we are currently in a child domain and can compromise DCSync/DA access, or if we can compromise this level of access in any child domain along our attack chain, we can forgo the burdensome foreign relationship enumeration to hop up the trust to instantly compromise the forest root. We have done this in the field, and yes, it is awesome. :) For operational advice/guidance, check out my <a class="af nu" href="http://www.harmj0y.net/blog/redteaming/the-trustpocalypse/" rel="noopener ugc nofollow" target="_blank">previous Trustpocalypse post from 2015</a>.</p><p id="506c" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This will only work for hopping between trusts <strong class="my gv"><em class="nv">within</em></strong> <strong class="my gv"><em class="nv">a forest</em></strong>. This will not work for external or inter-forest trusts due to SID filtering, described in more detail in the <strong class="my gv">Epilogue: SID Filtering</strong> section at the end of the post.</p><h2 id="c797" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">A Case Study</h2><p id="9294" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">So, consider again the sample trust diagram:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div class="ou ov pv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*_PmouZePAJKPiop6.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*_PmouZePAJKPiop6.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*_PmouZePAJKPiop6.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*_PmouZePAJKPiop6.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*_PmouZePAJKPiop6.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*_PmouZePAJKPiop6.png 1100w, https://miro.medium.com/v2/resize:fit:684/format:webp/0*_PmouZePAJKPiop6.png 684w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 342px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*_PmouZePAJKPiop6.png 640w, https://miro.medium.com/v2/resize:fit:720/0*_PmouZePAJKPiop6.png 720w, https://miro.medium.com/v2/resize:fit:750/0*_PmouZePAJKPiop6.png 750w, https://miro.medium.com/v2/resize:fit:786/0*_PmouZePAJKPiop6.png 786w, https://miro.medium.com/v2/resize:fit:828/0*_PmouZePAJKPiop6.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*_PmouZePAJKPiop6.png 1100w, https://miro.medium.com/v2/resize:fit:684/0*_PmouZePAJKPiop6.png 684w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 342px"/><img alt="" class="bh md ph c" width="342" height="264" loading="lazy" role="presentation"/></picture></div></figure><p id="42e8" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Say we land an account in <strong class="my gv">external.local</strong>. Since <strong class="my gv">sub.dev.testlab.local</strong> <em class="nv">trusts</em> <strong class="my gv">external.local</strong>, <strong class="my gv">external.local</strong> can query information from <strong class="my gv">sub.dev.testlab.local</strong>, while SUB cannot do the same to EXTERNAL. From the external context, we can query the trusts that SUB has:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*W3lptHy7oCOLuvLc.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*W3lptHy7oCOLuvLc.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*W3lptHy7oCOLuvLc.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*W3lptHy7oCOLuvLc.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*W3lptHy7oCOLuvLc.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*W3lptHy7oCOLuvLc.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W3lptHy7oCOLuvLc.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*W3lptHy7oCOLuvLc.png 640w, https://miro.medium.com/v2/resize:fit:720/0*W3lptHy7oCOLuvLc.png 720w, https://miro.medium.com/v2/resize:fit:750/0*W3lptHy7oCOLuvLc.png 750w, https://miro.medium.com/v2/resize:fit:786/0*W3lptHy7oCOLuvLc.png 786w, https://miro.medium.com/v2/resize:fit:828/0*W3lptHy7oCOLuvLc.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*W3lptHy7oCOLuvLc.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*W3lptHy7oCOLuvLc.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="489" loading="lazy" role="presentation"/></picture></div></div></figure><p id="fe2a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">But this only returns the direct trusts that <strong class="my gv">sub.dev.testlab</strong> has with other domains (<strong class="my gv">dev.testlab.local</strong> and <strong class="my gv">external.local</strong>). If we can query the global catalog (not always possible) from <strong class="my gv">sub.dev.testlab</strong> and return all domain trusts in the entire forest!</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*JsIZ5kPX6tydX3k-.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*JsIZ5kPX6tydX3k-.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*JsIZ5kPX6tydX3k-.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*JsIZ5kPX6tydX3k-.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*JsIZ5kPX6tydX3k-.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*JsIZ5kPX6tydX3k-.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JsIZ5kPX6tydX3k-.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*JsIZ5kPX6tydX3k-.png 640w, https://miro.medium.com/v2/resize:fit:720/0*JsIZ5kPX6tydX3k-.png 720w, https://miro.medium.com/v2/resize:fit:750/0*JsIZ5kPX6tydX3k-.png 750w, https://miro.medium.com/v2/resize:fit:786/0*JsIZ5kPX6tydX3k-.png 786w, https://miro.medium.com/v2/resize:fit:828/0*JsIZ5kPX6tydX3k-.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*JsIZ5kPX6tydX3k-.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*JsIZ5kPX6tydX3k-.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="493" loading="lazy" role="presentation"/></picture></div></div></figure><p id="71a5" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Note that because since this is a one-way, non-transitive external trust into <strong class="my gv">sub.dev.testlab.local</strong>, we can’t query the trusts that <strong class="my gv">contoso.local</strong> has from the EXTERNAL context, as our Kerberos traffic will not be properly referred. This is what this error usually means, in case you run across it:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*3AooS_5rbYv6Ml3R.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*3AooS_5rbYv6Ml3R.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*3AooS_5rbYv6Ml3R.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*3AooS_5rbYv6Ml3R.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*3AooS_5rbYv6Ml3R.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*3AooS_5rbYv6Ml3R.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3AooS_5rbYv6Ml3R.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*3AooS_5rbYv6Ml3R.png 640w, https://miro.medium.com/v2/resize:fit:720/0*3AooS_5rbYv6Ml3R.png 720w, https://miro.medium.com/v2/resize:fit:750/0*3AooS_5rbYv6Ml3R.png 750w, https://miro.medium.com/v2/resize:fit:786/0*3AooS_5rbYv6Ml3R.png 786w, https://miro.medium.com/v2/resize:fit:828/0*3AooS_5rbYv6Ml3R.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*3AooS_5rbYv6Ml3R.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*3AooS_5rbYv6Ml3R.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="134" loading="lazy" role="presentation"/></picture></div></div></figure><p id="ce44" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So, from here we would then run <strong class="my gv">Get-DomainForeignGroupMember -Domain sub.dev.testlab.local</strong> to see if any groups in SUB contained members in EXTERNAL:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*6Yzplo7M3BX5jb7o.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*6Yzplo7M3BX5jb7o.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*6Yzplo7M3BX5jb7o.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*6Yzplo7M3BX5jb7o.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*6Yzplo7M3BX5jb7o.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*6Yzplo7M3BX5jb7o.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6Yzplo7M3BX5jb7o.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*6Yzplo7M3BX5jb7o.png 640w, https://miro.medium.com/v2/resize:fit:720/0*6Yzplo7M3BX5jb7o.png 720w, https://miro.medium.com/v2/resize:fit:750/0*6Yzplo7M3BX5jb7o.png 750w, https://miro.medium.com/v2/resize:fit:786/0*6Yzplo7M3BX5jb7o.png 786w, https://miro.medium.com/v2/resize:fit:828/0*6Yzplo7M3BX5jb7o.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*6Yzplo7M3BX5jb7o.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*6Yzplo7M3BX5jb7o.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="474" loading="lazy" role="presentation"/></picture></div></div></figure><p id="8e62" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">From there, we would attempt targeted account compromise to hop the trust into <strong class="my gv">sub.dev.testlab.local</strong>. The <strong class="my gv">Get-DomainForeignUser</strong> command would be of no use here, due to the caveats about linked-value replication and trusted described in the <strong class="my gv">Foreign Relationship Enumeration </strong>section.</p><p id="83d0" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">However, because <strong class="my gv">external.local -&gt; sub.dev.testlab.local</strong> is an external trust relationships, it is implicitly non-transitive, so couldn’t query the domain local group memberships of <strong class="my gv">dev.testlab.local</strong> or <strong class="my gv">testlab.local</strong>.</p><p id="e74a" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If we were then able to compromise domain admin (or equivalent) credentials in <strong class="my gv">sub.dev.testlab.local</strong>, we could build a sidHistory-trust-hopping Golden Ticket as described in the “<strong class="my gv">Trustpocalypse</strong>” section to compromise the <strong class="my gv">testlab.local</strong> forest root domain. If we weren’t able to procure elevated access, we would run <strong class="my gv">Get-DomainForeignUser</strong> to see if any users from <strong class="my gv">sub.dev.testlab.local</strong> had access into other groups in the forest. Again, remember the previous information about scoping- only <em class="nv">universal</em> group memberships will be reflected here:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*ftX5ak4zlLyhHCz6.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*ftX5ak4zlLyhHCz6.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*ftX5ak4zlLyhHCz6.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*ftX5ak4zlLyhHCz6.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*ftX5ak4zlLyhHCz6.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*ftX5ak4zlLyhHCz6.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ftX5ak4zlLyhHCz6.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*ftX5ak4zlLyhHCz6.png 640w, https://miro.medium.com/v2/resize:fit:720/0*ftX5ak4zlLyhHCz6.png 720w, https://miro.medium.com/v2/resize:fit:750/0*ftX5ak4zlLyhHCz6.png 750w, https://miro.medium.com/v2/resize:fit:786/0*ftX5ak4zlLyhHCz6.png 786w, https://miro.medium.com/v2/resize:fit:828/0*ftX5ak4zlLyhHCz6.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*ftX5ak4zlLyhHCz6.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*ftX5ak4zlLyhHCz6.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="184" loading="lazy" role="presentation"/></picture></div></div></figure><p id="715d" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">We would also run <strong class="my gv">Get-DomainForeignGroupMember -Domain dev.testlab.local</strong> and <strong class="my gv">Get-DomainForeignGroupMember -Domain testlab.local</strong> to see that groups in those other forest domains had “incoming” access:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*0Lc9PmsPq0G9hbU1.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*0Lc9PmsPq0G9hbU1.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*0Lc9PmsPq0G9hbU1.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*0Lc9PmsPq0G9hbU1.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*0Lc9PmsPq0G9hbU1.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*0Lc9PmsPq0G9hbU1.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0Lc9PmsPq0G9hbU1.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*0Lc9PmsPq0G9hbU1.png 640w, https://miro.medium.com/v2/resize:fit:720/0*0Lc9PmsPq0G9hbU1.png 720w, https://miro.medium.com/v2/resize:fit:750/0*0Lc9PmsPq0G9hbU1.png 750w, https://miro.medium.com/v2/resize:fit:786/0*0Lc9PmsPq0G9hbU1.png 786w, https://miro.medium.com/v2/resize:fit:828/0*0Lc9PmsPq0G9hbU1.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*0Lc9PmsPq0G9hbU1.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*0Lc9PmsPq0G9hbU1.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="309" loading="lazy" role="presentation"/></picture></div></div></figure><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*jrtBMujzejCPor7F.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*jrtBMujzejCPor7F.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*jrtBMujzejCPor7F.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*jrtBMujzejCPor7F.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*jrtBMujzejCPor7F.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*jrtBMujzejCPor7F.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jrtBMujzejCPor7F.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*jrtBMujzejCPor7F.png 640w, https://miro.medium.com/v2/resize:fit:720/0*jrtBMujzejCPor7F.png 720w, https://miro.medium.com/v2/resize:fit:750/0*jrtBMujzejCPor7F.png 750w, https://miro.medium.com/v2/resize:fit:786/0*jrtBMujzejCPor7F.png 786w, https://miro.medium.com/v2/resize:fit:828/0*jrtBMujzejCPor7F.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*jrtBMujzejCPor7F.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*jrtBMujzejCPor7F.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="276" loading="lazy" role="presentation"/></picture></div></div></figure><p id="41ec" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Once/if we were able to compromise part or all of the <strong class="my gv">testlab.local</strong> forest root through either of the previous approaches, we would then run <strong class="my gv">Get-DomainForeignGroupMember -Domain contoso.local</strong> and <strong class="my gv">Get-DomainForeignGroupMember -Domain prod.contoso.local</strong> to see if there were any users in the TESTLAB forest that had foreign group membership in the CONTOSO forest.</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*9IrkH8BX2jZmSx9g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*9IrkH8BX2jZmSx9g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*9IrkH8BX2jZmSx9g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*9IrkH8BX2jZmSx9g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*9IrkH8BX2jZmSx9g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*9IrkH8BX2jZmSx9g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9IrkH8BX2jZmSx9g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*9IrkH8BX2jZmSx9g.png 640w, https://miro.medium.com/v2/resize:fit:720/0*9IrkH8BX2jZmSx9g.png 720w, https://miro.medium.com/v2/resize:fit:750/0*9IrkH8BX2jZmSx9g.png 750w, https://miro.medium.com/v2/resize:fit:786/0*9IrkH8BX2jZmSx9g.png 786w, https://miro.medium.com/v2/resize:fit:828/0*9IrkH8BX2jZmSx9g.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*9IrkH8BX2jZmSx9g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*9IrkH8BX2jZmSx9g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="312" loading="lazy" role="presentation"/></picture></div></div></figure><p id="48cf" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Along the way, we would could run <strong class="my gv">Get-NetLocalGroupMember &lt;foreign,server&gt;</strong> against a targeted selection of servers (including DCs) to see if any users crossed the boundary that way via machine local groups. We could also use targeted <strong class="my gv">Get-DomainObjectACL -Domain &lt;foreign.domain&gt;</strong> with various filters to check for foreign ACL memberships.</p><p id="6016" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Or we could just pull everything with BloodHound, and rely on the schema to model the cross-forest hops. :)</p><h2 id="7881" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Sidenote: Forging Inter-Realm Trust Tickets</h2><p id="a276" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">It is possible to forge inter-realm trust tickets to exploit trust relationships. As <a class="af nu" href="https://twitter.com/pyrotek3" rel="noopener ugc nofollow" target="_blank">Sean</a> covered this extremely well in his “<a class="af nu" href="https://adsecurity.org/?p=1588" rel="noopener ugc nofollow" target="_blank">It’s All About Trust</a>” post, I’ll refer you to his documentation for more operational details, and will just cover the implications of this technique and how it fits into our trust attack strategy.</p><p id="9588" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Recall the explanation of how Kerberos works across trusts:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*nOLyXQCdL7VLOxeW.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*nOLyXQCdL7VLOxeW.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*nOLyXQCdL7VLOxeW.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*nOLyXQCdL7VLOxeW.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*nOLyXQCdL7VLOxeW.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*nOLyXQCdL7VLOxeW.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nOLyXQCdL7VLOxeW.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*nOLyXQCdL7VLOxeW.png 640w, https://miro.medium.com/v2/resize:fit:720/0*nOLyXQCdL7VLOxeW.png 720w, https://miro.medium.com/v2/resize:fit:750/0*nOLyXQCdL7VLOxeW.png 750w, https://miro.medium.com/v2/resize:fit:786/0*nOLyXQCdL7VLOxeW.png 786w, https://miro.medium.com/v2/resize:fit:828/0*nOLyXQCdL7VLOxeW.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*nOLyXQCdL7VLOxeW.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*nOLyXQCdL7VLOxeW.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="453" loading="lazy" role="presentation"/></picture></div></div></figure><p id="e576" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So when the user presents this inter-realm ticket-granting-ticket referral to the foreign domain, again signed by the inter-realm trust key, the user’s TGT is included within it. And again, because the foreign domain trusts the domain that that issued the referral ticket, the foreign domain trusts the user’s TGT and all its included information to be accurate.</p><p id="6be5" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Again, in English, when the foreign domain decrypts the referral ticket with the negotiated trust key, it sees the user’s TGT and says “<em class="nv">OK, the other domain already authenticated this user and said this is who they say they are/these are the groups the user is in, so I’ll trust this is accurate because I trust this domain.</em>”</p><p id="baa5" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So, if we can retrieve the hash of the inter-realm trust key, a referral ticket can be forged (<a class="af nu" href="https://adsecurity.org/?p=1588" rel="noopener ugc nofollow" target="_blank">as Sean describes</a>) that allows us to pretend to be any user from the first domain when requesting access to the second domain. This hash retrieval can be done through normal password dumping or through DCSync, by querying the <strong class="my gv">FOREIGN_DOMAIN_SHORTNAME$</strong> account:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*t1apIzahwUxnToOf.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*t1apIzahwUxnToOf.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*t1apIzahwUxnToOf.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*t1apIzahwUxnToOf.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*t1apIzahwUxnToOf.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*t1apIzahwUxnToOf.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t1apIzahwUxnToOf.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*t1apIzahwUxnToOf.png 640w, https://miro.medium.com/v2/resize:fit:720/0*t1apIzahwUxnToOf.png 720w, https://miro.medium.com/v2/resize:fit:750/0*t1apIzahwUxnToOf.png 750w, https://miro.medium.com/v2/resize:fit:786/0*t1apIzahwUxnToOf.png 786w, https://miro.medium.com/v2/resize:fit:828/0*t1apIzahwUxnToOf.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*t1apIzahwUxnToOf.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*t1apIzahwUxnToOf.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="392" loading="lazy" role="presentation"/></picture></div></div></figure><p id="d074" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">However, if we can retrieve the inter-realm trust key, then in pretty much all cases we can pull the krbtgt hash of the referring domain. If we have this, we can construct a ticket for user referring domain, pretending to be any user we want to the foreign domain. This is why I haven’t had a need to forge inter-realm trust referrals in the field, but there is one specific instance where it gets interesting.</p><p id="5738" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Back in 2015, after everyone started to fully realize the implications of Golden Tickets, <a class="af nu" href="https://cloudblogs.microsoft.com/microsoftsecure/2015/02/11/krbtgt-account-password-reset-scripts-now-available-for-customers/" rel="noopener ugc nofollow" target="_blank">Microsoft released scripts</a> that allow organizations to change the password of the krbtgt account. In order for this to be effective for a single-domain forest, the password has to be changed twice. Now, because of the implementation of the sidHistory-hopping attack, the password for the krbtgt account in EVERY domain in the forest, twice.</p><p id="7d3b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">Say an organization does this, and rotates the passwords for <em class="nv">every</em> elevated account in <em class="nv">every</em> domain in the forest, are they safe? Well, while inter-realm trust keys automatically rotate every 30 days according to section <a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc223791.aspx" rel="noopener ugc nofollow" target="_blank">6.1.6.9.6.1 of the Active Directory Technical Specification</a>, they aren’t rotated when the krbtgt account changes. So if an attacker has the inter-realm keys in their possession, they can still use the sidHistory approach to hop up a trust, <a class="af nu" href="https://adsecurity.org/?p=1588" rel="noopener ugc nofollow" target="_blank">as Sean details</a>. Then again, there’s a <a class="af nu" href="https://adsecurity.org/?p=1929" rel="noopener ugc nofollow" target="_blank">million</a> and one other ways to <a class="af nu" href="https://specterops.io/assets/resources/an_ace_up_the_sleeve.pdf" rel="noopener ugc nofollow" target="_blank">backdoor Active Directory</a>. ¯\_(ツ)_/¯</p><p id="eb2b" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">So there’s only one solution if you want to be sure (thanks <a class="af nu" href="https://twitter.com/gentilkiwi" rel="noopener ugc nofollow" target="_blank">@gentilkiwi</a> :)</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div class="ou ov qg"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*-QdcD2RuB5s8HwM6.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*-QdcD2RuB5s8HwM6.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*-QdcD2RuB5s8HwM6.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*-QdcD2RuB5s8HwM6.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*-QdcD2RuB5s8HwM6.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*-QdcD2RuB5s8HwM6.png 1100w, https://miro.medium.com/v2/resize:fit:1200/format:webp/0*-QdcD2RuB5s8HwM6.png 1200w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 600px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*-QdcD2RuB5s8HwM6.png 640w, https://miro.medium.com/v2/resize:fit:720/0*-QdcD2RuB5s8HwM6.png 720w, https://miro.medium.com/v2/resize:fit:750/0*-QdcD2RuB5s8HwM6.png 750w, https://miro.medium.com/v2/resize:fit:786/0*-QdcD2RuB5s8HwM6.png 786w, https://miro.medium.com/v2/resize:fit:828/0*-QdcD2RuB5s8HwM6.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*-QdcD2RuB5s8HwM6.png 1100w, https://miro.medium.com/v2/resize:fit:1200/0*-QdcD2RuB5s8HwM6.png 1200w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 600px"/><img alt="" class="bh md ph c" width="600" height="700" loading="lazy" role="presentation"/></picture></div></figure><h2 id="6f66" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Another Sidenote: Kerberoasting Across Domain Trusts</h2><p id="7904" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk"><a class="af nu" href="http://www.harmj0y.net/blog/activedirectory/targeted-kerberoasting/" rel="noopener ugc nofollow" target="_blank">We</a> love <a class="af nu" href="http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" rel="noopener ugc nofollow" target="_blank">Kerberoasting</a>. Introduced by <a class="af nu" href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1).pdf" rel="noopener ugc nofollow" target="_blank">Tim Medin in 2014</a>, we ‘roast on a ton of our engagements. And if we have a domain that trusts us, we can roast across these trust boundaries, with one minor tweak in some situations.</p><p id="05aa" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">When using .NET’s <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.identitymodel.tokens.kerberosrequestorsecuritytoken(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">System.IdentityModel.Tokens.KerberosRequestorSecurityToken</a> class (and then its <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.identitymodel.tokens.kerberosrequestorsecuritytoken.getrequest(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">.GetRequest()</a> method), we specify a service principal name (SPN) to request a TGS-REP for, and subsequently use the <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.identitymodel.tokens.kerberosrequestorsecuritytoken.getrequest(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">GetRequest()</a> to retrieve the bytes for the AP-REQ that’s intended to be sent to the target service. This AP-REQ contains the service ticket that we then extract and use for offline Kerberoasting/password cracking.</p><p id="80b1" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">The documentation for the <a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.identitymodel.tokens.kerberosrequestorsecuritytoken.serviceprincipalname(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank">KerberosRequestorSecurityToken.ServicePrincipalName</a> nicely describes the format as “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/system.identitymodel.tokens.kerberosrequestorsecuritytoken.serviceprincipalname(v=vs.110).aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">host/&lt;hostname&gt;</em><strong class="my gv"><em class="nv">@&lt;domain&gt;</em></strong><em class="nv"> or &lt;hostname&gt;, where hostname is the name of the computer hosting the target Web service and domain is the fully-qualified domain name of the Kerberos realm in which the host computer resides.</em></a>” So if you have any issues with Kerberoasting across trusts (particularly external and forest trusts), try using the <strong class="my gv">SERVICE/host.domain.com@domain.com</strong> format and you may have more success. This is possible with PowerView’s <strong class="my gv">Get-DomainSPNTicket</strong>, the function that <strong class="my gv">Invoke-Kerberoast</strong> is built on.</p><h2 id="3381" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Epilogue: SID Filtering</h2><p id="71ea" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">So we previously talked about how/why the forest is the trust boundary in Active Directory, not the domain. A big part of this is the security protection I’ve alluded to several times previously called SID Filtering. The best reference for SID filtering is the [MS-PAC] “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237917.aspx" rel="noopener ugc nofollow" target="_blank">Privilege Attribute Certificate Data Structure</a>” documentation, specifically section <a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237940.aspx" rel="noopener ugc nofollow" target="_blank">4.1.2.2 “SID Filtering and Claims Transformation.”</a> I will do my best to explain a few salient points.</p><p id="d5bd" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">When a user’s TGT is presented to the new domain through a referral, that TGT contains a privileged attribute certificate (PAC) that contains, among other things, the user’s security identifier (SID), the security identifiers of groups they are in, and anything present in the previously discussed sidHistory field (i.e. the <strong class="my gv">ExtraSids</strong> PAC part described in the <strong class="my gv">Trustpocalypse</strong> section). This security identification information in the PAC is parsed and analyzed by a <em class="nv">trusting</em> domain, and various filters are executed depending on the type of the trust.</p><p id="3955" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">SIDs matching particular patterns are rejected by the trusting domain under various circumstances, as a security protection. SID filtering is meant to stop malicious users with elevated credentials in a <em class="nv">trusted</em> domain/forest from taking control of a <em class="nv">trusting</em> domain/forest. This is also described in Microsoft’s “<a class="af nu" href="https://technet.microsoft.com/en-us/library/cc755321(v=ws.10).aspx" rel="noopener ugc nofollow" target="_blank">Security Considerations for Trusts</a>” documentation.</p><p id="753c" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">There is a set of SIDs that are set to ‘AlwaysFilter’, meaning they are always filtered out by a trusting domain, no matter the trust type. The main SID we’re interested in, “Enterprise Admins” (S-1–5–21-&lt;Domain&gt;-519), the one that allows us to execute the sidHistory-hopping attack, is set to “ForestSpecific” for filtering. As Microsoft describes, “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237940.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">The ForestSpecific rule is for those SIDs that are never allowed in a PAC that originates from out of the forest or from a domain that has been marked as QuarantinedWithinForest, unless it belongs to that domain.</em></a>” Again, this explains why the forest is the trust boundary, not the domain, as this elevated SID (along with many others) can not be passed across a trust boundary except if the target domain is within the same forest.</p><p id="99c8" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">QuarantinedWithinForest, huh? It so happens that domains <em class="nv">within</em> a forest can be set as “quarantined”, which implements a version SID filtering for the domain, even though it is within the forest. However, as the documentation states, “<a class="af nu" href="https://msdn.microsoft.com/en-us/library/cc237940.aspx" rel="noopener ugc nofollow" target="_blank"><em class="nv">The only SIDs that are allowed to be passed from such a domain are the “Enterprise Domain Controllers” (S-1–5–9) SID and those described by the trusted domain object (TDO).</em></a>” So, since the “Enterprise Domain Controllers” SID is NOT filtered out for intra-forest quarantined domains, there is still a way to “hop up” the forest trust chain and compromise the forest root:</p><figure class="ox oy oz pa pb pc ou ov paragraph-image"><div role="button" tabindex="0" class="pd pe fj pf bh pg"><div class="ou ov ow"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/0*GkDz2Wj2tCRFvZgH.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/0*GkDz2Wj2tCRFvZgH.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/0*GkDz2Wj2tCRFvZgH.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/0*GkDz2Wj2tCRFvZgH.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/0*GkDz2Wj2tCRFvZgH.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/0*GkDz2Wj2tCRFvZgH.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GkDz2Wj2tCRFvZgH.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/0*GkDz2Wj2tCRFvZgH.png 640w, https://miro.medium.com/v2/resize:fit:720/0*GkDz2Wj2tCRFvZgH.png 720w, https://miro.medium.com/v2/resize:fit:750/0*GkDz2Wj2tCRFvZgH.png 750w, https://miro.medium.com/v2/resize:fit:786/0*GkDz2Wj2tCRFvZgH.png 786w, https://miro.medium.com/v2/resize:fit:828/0*GkDz2Wj2tCRFvZgH.png 828w, https://miro.medium.com/v2/resize:fit:1100/0*GkDz2Wj2tCRFvZgH.png 1100w, https://miro.medium.com/v2/resize:fit:1400/0*GkDz2Wj2tCRFvZgH.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh md ph c" width="700" height="538" loading="lazy" role="presentation"/></picture></div></div></figure><p id="9ff1" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">This is something <a class="af nu" href="http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/" rel="noopener ugc nofollow" target="_blank">I attempted to explain</a> a few years ago without properly understanding the problem, but it makes a bit more sense now after reading heaps of Microsoft documentation :)</p><h2 id="2ba1" class="nw nx gu bf ny nz oa dy ob oc od ea oe nh of og oh nl oi oj ok np ol om on oo bk">Wrapup</h2><p id="c2ce" class="pw-post-body-paragraph mw mx gu my b mz op nb nc nd oq nf ng nh or nj nk nl os nn no np ot nr ns nt gn bk">Trusts are not a simple topic. Most pentesters (and many sysadmins!) do not properly understand trusts and the risk exposed by various trust misconfigurations. Unfortunately for us, some bad guys do, and trusts have been abused since nearly the beginning of Active Directory to exploit access in one domain in order to pivot into another.</p><p id="6cca" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">If your domain trust architecture is setup incorrectly, then what’s the answer? Unfortunately, as with many major architectural flaws of this nature, there is not a simple fix. Rearchitecting a major Active Directory deployment can be a long, expensive, and painful process, but there is still a guiding light: the <a class="af nu" href="https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material#ESAE_BM" rel="noopener ugc nofollow" target="_blank">Enhanced Security Administrative Environment</a> (ESAE), commonly referred to as “Red Forest”, which is a secured Active Directory architecture that mitigates an enormous number of Active Directory vulnerabilities/misconfigurations. While Microsoft has <a class="af nu" href="https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material#ESAE_BM" rel="noopener ugc nofollow" target="_blank">published aspects of the architecture</a>, the only way that I currently know how have an ESAE/Red Forest is to pay Microsoft to implement it for you. ¯\_(ツ)_/¯</p><p id="4876" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk">I would love to eventually publish guidance on how organizations implement a “red-forest-esque” environment, that while not “officially” compliant with the reference architecture, would still be better than many organization’s current implementations. If anyone has documentation or guidance on how to do practically do this, please contact me (<a class="af nu" href="https://twitter.com/harmj0y/" rel="noopener ugc nofollow" target="_blank">@harmj0y</a> or will [at] harmj0y.net) and I will happily get that kind of information out there.</p></div></div></div><div class="ab cb qh qi qj qk" role="separator"><span class="ql by bm qm qn qo"></span><span class="ql by bm qm qn qo"></span><span class="ql by bm qm qn"></span></div><div class="gn go gp gq gr"><div class="ab cb"><div class="ci bh fz ga gb gc"><p id="3dc4" class="pw-post-body-paragraph mw mx gu my b mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt gn bk"><em class="nv">Originally published at </em><a class="af nu" href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/" rel="noopener ugc nofollow" target="_blank"><em class="nv">harmj0y</em></a><em class="nv">.</em></p></div></div></div></div></section></div></div></article></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="qp qq ab ja"><div class="qr ab"><a class="qs ay am ao" href="https://medium.com/tag/domain-trusts?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><div class="qt fj cx qu ge qv qw bf b bg z bk qx">Domain Trusts</div></a></div><div class="qr ab"><a class="qs ay am ao" href="https://medium.com/tag/powerview?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><div class="qt fj cx qu ge qv qw bf b bg z bk qx">Powerview</div></a></div><div class="qr ab"><a class="qs ay am ao" href="https://medium.com/tag/active-directory?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><div class="qt fj cx qu ge qv qw bf b bg z bk qx">Active Directory</div></a></div></div></div></div><div class="l"></div><footer class="qy qz ra rb rc rd re rf rg ab q rh ik c"><div class="l ae"><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="ab cp ri"><div class="ab q kv"><div class="rj l"><span class="l rk rl rm e d"><div class="ab q kv kw"><div class="pw-multi-vote-icon fj je kx ky kz"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fspecter-ops-posts%2F971e52cb2944&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=-----971e52cb2944---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="la ao lb lc ld le am lf lg lh kz"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l li lj lk ll lm ln lo"><p class="bf b dv z du"><span class="lp">--</span></p></div></div></span><span class="l h g f rn ro"><div class="ab q kv kw"><div class="pw-multi-vote-icon fj je kx ky kz"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fspecter-ops-posts%2F971e52cb2944&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=-----971e52cb2944---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="la ao lb lc ld le am lf lg lh kz"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l li lj lk ll lm ln lo"><p class="bf b dv z du"><span class="lp">--</span></p></div></div></span></div><div class="bq ab"><div><div class="bm" aria-hidden="false"><button class="ao la lq lr ab q fk ls lt" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="lu"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div></div><div class="ab q"><div class="qo l ix"><div><div class="bm" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F971e52cb2944&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;source=--------------------------bookmark_footer-----------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="du lw" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></a></span></div></div></div><div class="qo l ix"><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="footerSocialShareButton" class="af fk ah ai aj ak al me an ao ap ex mf mg lt mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg></button></div></div></div></div></div></div></div></div></div></footer><div class="rp rq rr rs rt l bx"><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="cl ab ru cp"><div class="ab ia"><a href="https://harmj0y.medium.com/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><div class="l rv rw by rx ie"><div class="l fj"><img alt="Will Schroeder" class="l fd by ry rz cx" src="https://miro.medium.com/v2/resize:fill:144:144/1*idzSM22ouVWVRLUiU5Kpkg.jpeg" width="72" height="72" loading="lazy"/><div class="if by l ry rz fs n ig ft"></div></div></div></a><a href="https://posts.specterops.io/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><div class="sa ab fj"><div><div class="bm" aria-hidden="false"><div class="l sb sc by rx ik"><div class="l fj"><img alt="Posts By SpecterOps Team Members" class="l fd by bz ca cx" src="https://miro.medium.com/v2/resize:fill:64:64/1*D-FDlfkqivRBQZoESrwtqw.png" width="32" height="32" loading="lazy"/><div class="if by l bz ca fs n ig ft"></div></div></div></div></div></div></a></div><div class="j i d"><div class="ab"><span><a class="bf b bg z ep qt eq er es et eu ev ew ex ey ez fa au fb fc fd bm fe ff" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F74ad66811b78&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=post_page-74ad66811b78----971e52cb2944---------------------follow_profile-----------" rel="noopener follow">Follow</a></span><div class="dt l"><div><div><div class="bm" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F26e438e64d00&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;newsletterV3=74ad66811b78&amp;newsletterV3Id=26e438e64d00&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=-----971e52cb2944---------------------subscribe_user-----------" rel="noopener follow"><button class="bf b bg z se am sf sg sh si sj sk sl sm ew ex ey ez fa fb fc fd bm fe ff" aria-label="Subscribe"><svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" fill="none" viewBox="0 0 38 38" class="sd sc sb"><rect width="0.5" height="6.5" x="26.25" y="9.25" rx="0.25"></rect><rect width="0.5" height="6.5" x="29.75" y="12.25" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5 19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="ab cn cp"><div class="l"><div class="ab q"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab q" href="https://harmj0y.medium.com/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><h2 class="pw-author-name bf sn so sp sq bk"><span class="gn jo">Written by <!-- -->Will Schroeder</span></h2></a></div><div class="qr ab"><div class="l ix"><span class="pw-follower-count bf b bg z bk"><a class="af ag ah ai aj ak al am an ao ap aq ar iq" href="https://harmj0y.medium.com/followers?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow">2.2K Followers</a></span></div><div class="bf b bg z jf jg jh ab jj jk jl jm du jd"><span class="ir l" aria-hidden="true"><span class="bf b bg z du">·</span></span><span class="l ix">Editor for </span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar iq ab q" href="https://posts.specterops.io/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b bg z jf jg jh ji jj jk jl jm bk">Posts By SpecterOps Team Members</p></a></div></div></div></div><div class="sr l"><p class="bf b bg z bk"><span class="gn">Researcher @SpecterOps . Coding towards chaotic good while living on the decision boundary.</span></p></div></div><div class="h k"><div class="ab"><span><a class="bf b bg z ep qt eq er es et eu ev ew ex ey ez fa au fb fc fd bm fe ff" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F74ad66811b78&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=post_page-74ad66811b78----971e52cb2944---------------------follow_profile-----------" rel="noopener follow">Follow</a></span><div class="dt l"><div><div><div class="bm" aria-hidden="false"><div class="l"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F26e438e64d00&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fa-guide-to-attacking-domain-trusts-971e52cb2944&amp;newsletterV3=74ad66811b78&amp;newsletterV3Id=26e438e64d00&amp;user=Will+Schroeder&amp;userId=74ad66811b78&amp;source=-----971e52cb2944---------------------subscribe_user-----------" rel="noopener follow"><button class="bf b bg z se am sf sg sh si sj sk sl sm ew ex ey ez fa fb fc fd bm fe ff" aria-label="Subscribe"><svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" fill="none" viewBox="0 0 38 38" class="sd sc sb"><rect width="0.5" height="6.5" x="26.25" y="9.25" rx="0.25"></rect><rect width="0.5" height="6.5" x="29.75" y="12.25" rx="0.25" transform="rotate(90 29.75 12.25)"></rect><path d="M19.5 12.5h-7a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h13a1 1 0 0 0 1-1v-5"></path><path d="M11.5 14.5 19 20l4-3"></path></svg></button></a></span></div></div></div></div></div></div></div></div><div class="ss bh st su sv sw sx sy"></div></div></div><div class="h k j"><div class="ss bh st sz"></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="ta ab kv ja"><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://help.medium.com/hc/en-us?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Help</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.statuspage.io/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Status</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/about?autoplay=1&amp;source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">About</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Careers</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="pressinquiries@medium.com?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Press</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://blog.medium.com/?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Blog</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Privacy</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Terms</p></a></div><div class="tb tc l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://speechify.com/medium?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Text to speech</p></a></div><div class="tb l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/business?source=post_page-----971e52cb2944--------------------------------" rel="noopener follow"><p class="bf b dv z du">Teams</p></a></div></div></div></div></div></div></div></div></div></div><script>window.__BUILD_ID__="main-20241017-182126-a0128a89d2"</script><script>window.__GRAPHQL_URI__ = "https://posts.specterops.io/_/graphql"</script><script>window.__PRELOADED_STATE__ = {"algolia":{"queries":{}},"cache":{"experimentGroupSet":true,"reason":"This request is not using the cache middleware worker","group":"disabled","tags":["group-edgeCachePosts","post-971e52cb2944","user-74ad66811b78","collection-f05f8696e3cc"],"serverVariantState":"","middlewareEnabled":false,"cacheStatus":"DYNAMIC","shouldUseCache":false,"vary":[],"lohpSummerUpsellEnabled":false,"publicationHierarchyEnabled":false},"client":{"hydrated":false,"isUs":false,"isNativeMedium":false,"isSafariMobile":false,"isSafari":false,"isFirefox":false,"routingEntity":{"type":"COLLECTION","id":"f05f8696e3cc","explicit":true},"viewerIsBot":false},"debug":{"requestId":"f0cdc352-dfb3-4697-9c42-e325a8f4fa61","hybridDevServices":[],"originalSpanCarrier":{"traceparent":"00-2a4440dd7bd177fc66a633638e71430e-b13477ce9e6e642c-01"}},"multiVote":{"clapsPerPost":{}},"navigation":{"branch":{"show":null,"hasRendered":null,"blockedByCTA":false},"hideGoogleOneTap":false,"hasRenderedAlternateUserBanner":null,"currentLocation":"https:\u002F\u002Fposts.specterops.io\u002Fa-guide-to-attacking-domain-trusts-971e52cb2944","host":"posts.specterops.io","hostname":"posts.specterops.io","referrer":"","hasSetReferrer":false,"susiModal":{"step":null,"operation":"register"},"postRead":false,"partnerProgram":{"selectedCountryCode":null}},"config":{"nodeEnv":"production","version":"main-20241017-182126-a0128a89d2","target":"production","productName":"Medium","publicUrl":"https:\u002F\u002Fcdn-client.medium.com\u002Flite","authDomain":"medium.com","authGoogleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","favicon":"production","glyphUrl":"https:\u002F\u002Fglyph.medium.com","branchKey":"key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm","algolia":{"appId":"MQ57UUUQZ2","apiKeySearch":"394474ced050e3911ae2249ecc774921","indexPrefix":"medium_","host":"-dsn.algolia.net"},"recaptchaKey":"6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk","recaptcha3Key":"6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5","recaptchaEnterpriseKeyId":"6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp","datadog":{"applicationId":"6702d87d-a7e0-42fe-bbcb-95b469547ea0","clientToken":"pub853ea8d17ad6821d9f8f11861d23dfed","rumToken":"pubf9cc52896502b9413b68ba36fc0c7162","context":{"deployment":{"target":"production","tag":"main-20241017-182126-a0128a89d2","commit":"a0128a89d2d76bfa55b25492370b0bae4050224f"}},"datacenter":"us"},"googleAnalyticsCode":"G-7JY7T788PK","googlePay":{"apiVersion":"2","apiVersionMinor":"0","merchantId":"BCR2DN6TV7EMTGBM","merchantName":"Medium","instanceMerchantId":"13685562959212738550"},"applePay":{"version":3},"signInWallCustomDomainCollectionIds":["3a8144eabfe3","336d898217ee","61061eb0c96b","138adf9c44c","819cc2aaeee0"],"mediumMastodonDomainName":"me.dm","mediumOwnedAndOperatedCollectionIds":["8a9336e5bb4","b7e45b22fec3","193b68bd4fba","8d6b8a439e32","54c98c43354d","3f6ecf56618","d944778ce714","92d2092dc598","ae2a65f35510","1285ba81cada","544c7006046e","fc8964313712","40187e704f1c","88d9857e584e","7b6769f2748b","bcc38c8f6edf","cef6983b292","cb8577c9149e","444d13b52878","713d7dbc99b0","ef8e90590e66","191186aaafa0","55760f21cdc5","9dc80918cc93","bdc4052bbdba","8ccfed20cbb2"],"tierOneDomains":["medium.com","thebolditalic.com","arcdigital.media","towardsdatascience.com","uxdesign.cc","codeburst.io","psiloveyou.xyz","writingcooperative.com","entrepreneurshandbook.co","prototypr.io","betterhumans.coach.me","theascent.pub"],"topicsToFollow":["d61cf867d93f","8a146bc21b28","1eca0103fff3","4d562ee63426","aef1078a3ef5","e15e46793f8d","6158eb913466","55f1c20aba7a","3d18b94f6858","4861fee224fd","63c6f1f93ee","1d98b3a9a871","decb52b64abf","ae5d4995e225","830cded25262"],"topicToTagMappings":{"accessibility":"accessibility","addiction":"addiction","android-development":"android-development","art":"art","artificial-intelligence":"artificial-intelligence","astrology":"astrology","basic-income":"basic-income","beauty":"beauty","biotech":"biotech","blockchain":"blockchain","books":"books","business":"business","cannabis":"cannabis","cities":"cities","climate-change":"climate-change","comics":"comics","coronavirus":"coronavirus","creativity":"creativity","cryptocurrency":"cryptocurrency","culture":"culture","cybersecurity":"cybersecurity","data-science":"data-science","design":"design","digital-life":"digital-life","disability":"disability","economy":"economy","education":"education","equality":"equality","family":"family","feminism":"feminism","fiction":"fiction","film":"film","fitness":"fitness","food":"food","freelancing":"freelancing","future":"future","gadgets":"gadgets","gaming":"gaming","gun-control":"gun-control","health":"health","history":"history","humor":"humor","immigration":"immigration","ios-development":"ios-development","javascript":"javascript","justice":"justice","language":"language","leadership":"leadership","lgbtqia":"lgbtqia","lifestyle":"lifestyle","machine-learning":"machine-learning","makers":"makers","marketing":"marketing","math":"math","media":"media","mental-health":"mental-health","mindfulness":"mindfulness","money":"money","music":"music","neuroscience":"neuroscience","nonfiction":"nonfiction","outdoors":"outdoors","parenting":"parenting","pets":"pets","philosophy":"philosophy","photography":"photography","podcasts":"podcast","poetry":"poetry","politics":"politics","privacy":"privacy","product-management":"product-management","productivity":"productivity","programming":"programming","psychedelics":"psychedelics","psychology":"psychology","race":"race","relationships":"relationships","religion":"religion","remote-work":"remote-work","san-francisco":"san-francisco","science":"science","self":"self","self-driving-cars":"self-driving-cars","sexuality":"sexuality","social-media":"social-media","society":"society","software-engineering":"software-engineering","space":"space","spirituality":"spirituality","sports":"sports","startups":"startup","style":"style","technology":"technology","transportation":"transportation","travel":"travel","true-crime":"true-crime","tv":"tv","ux":"ux","venture-capital":"venture-capital","visual-design":"visual-design","work":"work","world":"world","writing":"writing"},"defaultImages":{"avatar":{"imageId":"1*dmbNkD5D-u45r44go_cf0g.png","height":150,"width":150},"orgLogo":{"imageId":"7*V1_7XP4snlmqrc_0Njontw.png","height":110,"width":500},"postLogo":{"imageId":"bd978bb536350a710e8efb012513429cabdc4c28700604261aeda246d0f980b7","height":810,"width":1440},"postPreviewImage":{"imageId":"1*hn4v1tCaJy7cWMyb0bpNpQ.png","height":386,"width":579}},"collectionStructuredData":{"8d6b8a439e32":{"name":"Elemental","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png","width":980,"height":159}}},"3f6ecf56618":{"name":"Forge","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png","width":596,"height":183}}},"ae2a65f35510":{"name":"GEN","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png","width":264,"height":140}}},"88d9857e584e":{"name":"LEVEL","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png","width":540,"height":108}}},"7b6769f2748b":{"name":"Marker","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png","width":383,"height":92}}},"444d13b52878":{"name":"OneZero","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png","width":540,"height":123}}},"8ccfed20cbb2":{"name":"Zora","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png","width":540,"height":106}}}},"embeddedPostIds":{"coronavirus":"cd3010f9d81f"},"sharedCdcMessaging":{"COVID_APPLICABLE_TAG_SLUGS":[],"COVID_APPLICABLE_TOPIC_NAMES":[],"COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE":[],"COVID_MESSAGES":{"tierA":{"text":"For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":66,"end":73,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"tierB":{"text":"Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.","markups":[{"start":37,"end":45,"href":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety"},{"start":125,"end":132,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"paywall":{"text":"This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":56,"end":70,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":138,"end":145,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"unbound":{"text":"This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":45,"end":59,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":127,"end":134,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]}},"COVID_BANNER_POST_ID_OVERRIDE_WHITELIST":["3b31a67bff4a"]},"sharedVoteMessaging":{"TAGS":["politics","election-2020","government","us-politics","election","2020-presidential-race","trump","donald-trump","democrats","republicans","congress","republican-party","democratic-party","biden","joe-biden","maga"],"TOPICS":["politics","election"],"MESSAGE":{"text":"Find out more about the U.S. election results here.","markups":[{"start":46,"end":50,"href":"https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker"}]},"EXCLUDE_POSTS":["397ef29e3ca5"]},"embedPostRules":[],"recircOptions":{"v1":{"limit":3},"v2":{"limit":8}},"braintreeClientKey":"production_zjkj96jm_m56f8fqpf7ngnrd4","braintree":{"enabled":true,"merchantId":"m56f8fqpf7ngnrd4","merchantAccountId":{"usd":"AMediumCorporation_instant","eur":"amediumcorporation_EUR","cad":"amediumcorporation_CAD"},"publicKey":"ds2nn34bg2z7j5gd","braintreeEnvironment":"production","dashboardUrl":"https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants","gracePeriodDurationInDays":14,"mediumMembershipPlanId":{"monthly":"ce105f8c57a3","monthlyV2":"e8a5e126-792b-4ee6-8fba-d574c1b02fc5","monthlyWithTrial":"d5ee3dbe3db8","monthlyPremium":"fa741a9b47a2","yearly":"a40ad4a43185","yearlyV2":"3815d7d6-b8ca-4224-9b8c-182f9047866e","yearlyStaff":"d74fb811198a","yearlyWithTrial":"b3bc7350e5c7","yearlyPremium":"e21bd2c12166","monthlyOneYearFree":"e6c0637a-2bad-4171-ab4f-3c268633d83c","monthly25PercentOffFirstYear":"235ecc62-0cdb-49ae-9378-726cd21c504b","monthly20PercentOffFirstYear":"ba518864-9c13-4a99-91ca-411bf0cac756","monthly15PercentOffFirstYear":"594c029b-9f89-43d5-88f8-8173af4e070e","monthly10PercentOffFirstYear":"c6c7bc9a-40f2-4b51-8126-e28511d5bdb0","monthlyForStudents":"629ebe51-da7d-41fd-8293-34cd2f2030a8","yearlyOneYearFree":"78ba7be9-0d9f-4ece-aa3e-b54b826f2bf1","yearly25PercentOffFirstYear":"2dbb010d-bb8f-4eeb-ad5c-a08509f42d34","yearly20PercentOffFirstYear":"47565488-435b-47f8-bf93-40d5fbe0ebc8","yearly15PercentOffFirstYear":"8259809b-0881-47d9-acf7-6c001c7f720f","yearly10PercentOffFirstYear":"9dd694fb-96e1-472c-8d9e-3c868d5c1506","yearlyForStudents":"e29345ef-ab1c-4234-95c5-70e50fe6bc23","monthlyCad":"p52orjkaceei","yearlyCad":"h4q9g2up9ktt"},"braintreeDiscountId":{"oneMonthFree":"MONTHS_FREE_01","threeMonthsFree":"MONTHS_FREE_03","sixMonthsFree":"MONTHS_FREE_06","fiftyPercentOffOneYear":"FIFTY_PERCENT_OFF_ONE_YEAR"},"3DSecureVersion":"2","defaultCurrency":"usd","providerPlanIdCurrency":{"4ycw":"usd","rz3b":"usd","3kqm":"usd","jzw6":"usd","c2q2":"usd","nnsw":"usd","q8qw":"usd","d9y6":"usd","fx7w":"cad","nwf2":"cad"}},"paypalClientId":"AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v","paypal":{"host":"https:\u002F\u002Fapi.paypal.com:443","clientMode":"production","serverMode":"live","webhookId":"4G466076A0294510S","monthlyPlan":{"planId":"P-9WR0658853113943TMU5FDQA","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlan":{"planId":"P-7N8963881P8875835MU5JOPQ","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oneYearGift":{"name":"Medium Membership (1 Year, Digital Gift Code)","description":"Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.","price":"50.00","currency":"USD","sku":"membership-gift-1-yr"},"oldMonthlyPlan":{"planId":"P-96U02458LM656772MJZUVH2Y","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlan":{"planId":"P-59P80963JF186412JJZU3SMI","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"monthlyPlanWithTrial":{"planId":"P-66C21969LR178604GJPVKUKY","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlanWithTrial":{"planId":"P-6XW32684EX226940VKCT2MFA","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oldMonthlyPlanNoSetupFee":{"planId":"P-4N046520HR188054PCJC7LJI","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlanNoSetupFee":{"planId":"P-7A4913502Y5181304CJEJMXQ","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"sdkUrl":"https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs"},"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","log":{"json":true,"level":"info"},"imageUploadMaxSizeMb":25,"staffPicks":{"title":"Staff Picks","catalogId":"c7bc6e1ee00f"}},"session":{"xsrf":""}}</script><script>window.__APOLLO_STATE__ = {"ROOT_QUERY":{"__typename":"Query","variantFlags":[{"__typename":"VariantFlag","name":"android_enable_friend_links_creation","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_see_pronouns","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tipping_v0_android","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_seamless_social_sharing","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"signup_services","valueType":{"__typename":"VariantFlagString","value":"twitter,facebook,google,email,google-fastidv,google-one-tap,apple"}},{"__typename":"VariantFlag","name":"enable_google_webhook","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"coronavirus_topic_recirc","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_explicit_signals_updated_post_previews","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tag_recs","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_updated_pub_recs_ui","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_bg_post_post","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_apple_pay","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pre_pp_v4","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"can_receive_tips_v0","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_new_stripe_customers","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"can_send_tips_v0","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_boost_nia_v01","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_verified_author","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_autorefresh","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tick_landing_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"onboarding_tags_from_top_views","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"signin_services","valueType":{"__typename":"VariantFlagString","value":"twitter,facebook,google,email,google-fastidv,google-one-tap,apple"}},{"__typename":"VariantFlag","name":"limit_user_follows","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_update_explore_wtf","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_iceland_forced_android","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lite_homepage","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_entities_to_follow_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rex_new_push_notification_endpoint","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_in_app_free_trial","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_verifications_service","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_display_paywall_after_onboarding","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_syntax_highlight","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lite_response_markup","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rito_upstream_deadlines","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_starspace","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_recommended_publishers_query","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_editor_new_publishing_flow","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"glyph_font_set","valueType":{"__typename":"VariantFlagString","value":"m2-unbound-source-serif-pro"}},{"__typename":"VariantFlag","name":"allow_test_auth","valueType":{"__typename":"VariantFlagString","value":"disallow"}},{"__typename":"VariantFlag","name":"android_two_hour_refresh","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_configure_pronouns","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_legacy_feed_in_iceland","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_google_one_tap","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lite_server_upstream_deadlines","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_lock_responses","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"rex_generator_max_candidates","valueType":{"__typename":"VariantFlagNumber"}},{"__typename":"VariantFlag","name":"browsable_stream_config_bucket","valueType":{"__typename":"VariantFlagString","value":"curated-topics"}},{"__typename":"VariantFlag","name":"enable_sharer_validate_post_share_key","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_eventstats_event_processing","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_moc_load_processor_first_story","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_monthly_plan","valueType":{"__typename":"VariantFlagString","value":"60e220181034"}},{"__typename":"VariantFlag","name":"enable_apple_webhook","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pp_v4","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_switch_plan_premium_tier","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"redefined_top_posts","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_google_pay","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_recirc_model","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"reader_fair_distribution_non_qp","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_cache_less_following_feed","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rex_aggregator_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_premium_tier_badge","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tribute_landing_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_monthly_premium_plan","valueType":{"__typename":"VariantFlagString","value":"12a660186432"}},{"__typename":"VariantFlag","name":"enable_auto_follow_on_subscribe","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_conversion_model_v2","valueType":{"__typename":"VariantFlagString","value":"group_2"}},{"__typename":"VariantFlag","name":"enable_lite_archive_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_mastodon_for_members","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_miro_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_indexeddb","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"limit_post_referrers","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_verified_book_author","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_friend_links_postpage_banners","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pp_country_expansion","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_members_only_audio","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"reengagement_notification_duration","valueType":{"__typename":"VariantFlagNumber"}},{"__typename":"VariantFlag","name":"android_enable_lists_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_app_flirty_thirty","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_group_gifting","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_new_manage_membership_flow","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_iceland_nux","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_import","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_dynamic_paywall_aspiriational","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_maim_the_meter","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_webhook","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"mobile_custom_app_icon","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"price_smoke_test_monthly","valueType":{"__typename":"VariantFlagString","value":""}},{"__typename":"VariantFlag","name":"price_smoke_test_yearly","valueType":{"__typename":"VariantFlagString","value":""}},{"__typename":"VariantFlag","name":"enable_simplified_digest_v2_b","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_remove_twitter_onboarding_step","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lite_continue_this_thread","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_moc_load_processor_all_recs_surfaces","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_topic_portals","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_deprecate_legacy_providers_v3","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_susi_redesign_ios","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_paypal","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_friend_links_creation","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_explicit_signals","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_recaptcha_enterprise","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_aurora_pub_follower_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_dynamic_paywall_programming","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_mastodon_for_members_username_selection","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_rating_prompt_stories_read_threshold","valueType":{"__typename":"VariantFlagNumber"}},{"__typename":"VariantFlag","name":"enable_android_offline_reading","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_easy_resubscribe","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"allow_access","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_apple_sign_in","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_automod","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tipping_v0_ios","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ml_rank_rex_anno","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_sprig","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_author_cards_byline","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_integration","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_social_share_sheet","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_client","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_update_topic_portals_wtf","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"textshots_userid","valueType":{"__typename":"VariantFlagString","value":""}},{"__typename":"VariantFlag","name":"enable_author_cards","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_branch_io","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"disable_partner_program_enrollment","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_intrinsic_automatic_actions","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_dynamic_aspirational_paywall","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_dynamic_programming_paywall","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_annual_plan","valueType":{"__typename":"VariantFlagString","value":"2c754bcc2995"}},{"__typename":"VariantFlag","name":"ios_enable_home_post_menu","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_premium_tier","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_offline_reading","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_speechify_widget","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_annual_premium_plan","valueType":{"__typename":"VariantFlagString","value":"4a442ace1476"}},{"__typename":"VariantFlag","name":"enable_mastodon_avatar_upload","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"skip_fs_cache_user_vals","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_susi_redesign_android","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"allow_signup","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_medium2_kbfd","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rex_reading_history","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_speechify_ios","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_trial_membership","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_footer_app_buttons","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_marketing_emails","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_newsletter_lo_flow_custom_domains","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_image_sharer","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_diversification_rex","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_moc_load_processor_c","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_sharer_create_post_share_key","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_friend_links_postpage_banners","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_creator_welcome_email","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lo_homepage","valueType":{"__typename":"VariantFlagString","value":"control"}},{"__typename":"VariantFlag","name":"enable_pill_based_home_feed","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_conversion_ranker_v2","valueType":{"__typename":"VariantFlagString","value":"control"}}],"collectionByDomainOrSlug({\"domainOrSlug\":\"posts.specterops.io\"})":{"__ref":"Collection:f05f8696e3cc"},"viewer":null,"postResult({\"id\":\"971e52cb2944\"})":{"__ref":"Post:971e52cb2944"}},"ImageMetadata:1*D-FDlfkqivRBQZoESrwtqw.png":{"__typename":"ImageMetadata","id":"1*D-FDlfkqivRBQZoESrwtqw.png"},"Collection:f05f8696e3cc":{"__typename":"Collection","id":"f05f8696e3cc","favicon":{"__ref":"ImageMetadata:1*D-FDlfkqivRBQZoESrwtqw.png"},"customStyleSheet":null,"colorPalette":{"__typename":"ColorPalette","highlightSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FFF3F1FF","point":0},{"__typename":"ColorPoint","color":"#FFF1EFFF","point":0.1},{"__typename":"ColorPoint","color":"#FFEEEDFF","point":0.2},{"__typename":"ColorPoint","color":"#FFECEBFF","point":0.3},{"__typename":"ColorPoint","color":"#FFEAE9FF","point":0.4},{"__typename":"ColorPoint","color":"#FFE8E7FF","point":0.5},{"__typename":"ColorPoint","color":"#FFE5E4FF","point":0.6},{"__typename":"ColorPoint","color":"#FFE3E2FF","point":0.7},{"__typename":"ColorPoint","color":"#FFE1E0FF","point":0.8},{"__typename":"ColorPoint","color":"#FFDEDEFF","point":0.9},{"__typename":"ColorPoint","color":"#FFDCDCFF","point":1}]},"defaultBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FF8080B7","point":0},{"__typename":"ColorPoint","color":"#FF7777A8","point":0.1},{"__typename":"ColorPoint","color":"#FF6E6E9A","point":0.2},{"__typename":"ColorPoint","color":"#FF65658B","point":0.3},{"__typename":"ColorPoint","color":"#FF5C5B7D","point":0.4},{"__typename":"ColorPoint","color":"#FF52526E","point":0.5},{"__typename":"ColorPoint","color":"#FF484860","point":0.6},{"__typename":"ColorPoint","color":"#FF3D3D51","point":0.7},{"__typename":"ColorPoint","color":"#FF323241","point":0.8},{"__typename":"ColorPoint","color":"#FF262632","point":0.9},{"__typename":"ColorPoint","color":"#FF191921","point":1}]},"tintBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FF1E184B","colorPoints":[{"__typename":"ColorPoint","color":"#FF1E184B","point":0},{"__typename":"ColorPoint","color":"#FF3A3866","point":0.1},{"__typename":"ColorPoint","color":"#FF54537D","point":0.2},{"__typename":"ColorPoint","color":"#FF6C6C93","point":0.3},{"__typename":"ColorPoint","color":"#FF8383A6","point":0.4},{"__typename":"ColorPoint","color":"#FF9999B9","point":0.5},{"__typename":"ColorPoint","color":"#FFAEAECA","point":0.6},{"__typename":"ColorPoint","color":"#FFC3C2DB","point":0.7},{"__typename":"ColorPoint","color":"#FFD8D6EB","point":0.8},{"__typename":"ColorPoint","color":"#FFEBEAFA","point":0.9},{"__typename":"ColorPoint","color":"#FFFFFDFF","point":1}]}},"googleAnalyticsId":"UA-102239211-2","editors":[{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:74ad66811b78"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:70f84c574024"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:f4ab382d41"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:1bb43103a9a9"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:b9c2df322eaf"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:b206c297df42"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:d59f95c1ed1c"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:6e849bed7683"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:9bef3c9a8b49"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:10eca8f7a844"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:d248a36145f8"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:2562fc45d9a9"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:645ffcef8682"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:a041d7ac11fe"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:507d73de7b97"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:e7dfc7678b59"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:ff850017e32a"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:4d7214ceeaf8"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:760e415ea3c9"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:f95d89c4ba81"}},{"__typename":"CollectionMastheadUserItem","user":{"__ref":"User:59a56792287a"}}],"name":"Posts By SpecterOps Team Members","avatar":{"__ref":"ImageMetadata:1*D-FDlfkqivRBQZoESrwtqw.png"},"domain":"posts.specterops.io","slug":"specter-ops-posts","description":"Posts from SpecterOps team members on various topics relating information security","subscriberCount":4702,"latestPostsConnection({\"paging\":{\"limit\":1}})":{"__typename":"PostConnection","posts":[{"__typename":"Post","title":"Closing the Gaps: How Attack Path Management Improves Vulnerability Management Programs","latestPublishedAt":1727878988539}]},"viewerEdge":{"__ref":"CollectionViewerEdge:collectionId:f05f8696e3cc-viewerId:lo_57ff73e9b7e1"},"twitterUsername":"specterops","facebookPageId":null,"logo":{"__ref":"ImageMetadata:1*s-5BWBr8XsgtIU5azKNhZQ.jpeg"}},"User:74ad66811b78":{"__typename":"User","id":"74ad66811b78","name":"Will Schroeder","username":"harmj0y","newsletterV3":{"__ref":"NewsletterV3:26e438e64d00"},"linkedAccounts":{"__ref":"LinkedAccounts:74ad66811b78"},"isSuspended":false,"imageId":"1*idzSM22ouVWVRLUiU5Kpkg.jpeg","mediumMemberAt":1706634031026,"verifications":{"__typename":"VerifiedInfo","isBookAuthor":false},"socialStats":{"__typename":"SocialStats","followerCount":2269},"customDomainState":{"__typename":"CustomDomainState","live":{"__typename":"CustomDomain","domain":"harmj0y.medium.com"}},"hasSubdomain":true,"bio":"Researcher @SpecterOps . Coding towards chaotic good while living on the decision boundary.","isPartnerProgramEnrolled":false,"viewerEdge":{"__ref":"UserViewerEdge:userId:74ad66811b78-viewerId:lo_57ff73e9b7e1"},"viewerIsUser":false,"postSubscribeMembershipUpsellShownAt":0,"userPostCounts({\"includeResponsesCount\":true})":null,"membership":{"__ref":"Membership:1955bf140c5c"},"allowNotes":true,"twitterScreenName":"harmj0y"},"User:70f84c574024":{"__typename":"User","id":"70f84c574024"},"User:f4ab382d41":{"__typename":"User","id":"f4ab382d41"},"User:1bb43103a9a9":{"__typename":"User","id":"1bb43103a9a9"},"User:b9c2df322eaf":{"__typename":"User","id":"b9c2df322eaf"},"User:b206c297df42":{"__typename":"User","id":"b206c297df42"},"User:d59f95c1ed1c":{"__typename":"User","id":"d59f95c1ed1c"},"User:6e849bed7683":{"__typename":"User","id":"6e849bed7683"},"User:9bef3c9a8b49":{"__typename":"User","id":"9bef3c9a8b49"},"User:10eca8f7a844":{"__typename":"User","id":"10eca8f7a844"},"User:d248a36145f8":{"__typename":"User","id":"d248a36145f8"},"User:2562fc45d9a9":{"__typename":"User","id":"2562fc45d9a9"},"User:645ffcef8682":{"__typename":"User","id":"645ffcef8682"},"User:a041d7ac11fe":{"__typename":"User","id":"a041d7ac11fe"},"User:507d73de7b97":{"__typename":"User","id":"507d73de7b97"},"User:e7dfc7678b59":{"__typename":"User","id":"e7dfc7678b59"},"User:ff850017e32a":{"__typename":"User","id":"ff850017e32a"},"User:4d7214ceeaf8":{"__typename":"User","id":"4d7214ceeaf8"},"User:760e415ea3c9":{"__typename":"User","id":"760e415ea3c9"},"User:f95d89c4ba81":{"__typename":"User","id":"f95d89c4ba81"},"User:59a56792287a":{"__typename":"User","id":"59a56792287a"},"LinkedAccounts:74ad66811b78":{"__typename":"LinkedAccounts","mastodon":null,"id":"74ad66811b78"},"UserViewerEdge:userId:74ad66811b78-viewerId:lo_57ff73e9b7e1":{"__typename":"UserViewerEdge","id":"userId:74ad66811b78-viewerId:lo_57ff73e9b7e1","isFollowing":false,"isUser":false,"isMuting":false},"NewsletterV3:26e438e64d00":{"__typename":"NewsletterV3","id":"26e438e64d00","type":"NEWSLETTER_TYPE_AUTHOR","slug":"74ad66811b78","name":"74ad66811b78","collection":null,"user":{"__ref":"User:74ad66811b78"}},"Membership:1955bf140c5c":{"__typename":"Membership","tier":"MEMBER","id":"1955bf140c5c"},"Paragraph:e6189056e39c_0":{"__typename":"Paragraph","id":"e6189056e39c_0","name":"0aa4","type":"H3","href":null,"layout":null,"metadata":null,"text":"A Guide to Attacking Domain Trusts","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_1":{"__typename":"Paragraph","id":"e6189056e39c_1","name":"1059","type":"P","href":null,"layout":null,"metadata":null,"text":"It’s been a while (nearly 2 years) since I wrote a post purely on Active Directory domain trusts. After diving into group scoping, I realized a few subtle misconceptions I previously had concerning trusts and group memberships. That, combined with the changes made to PowerView last year, convinced me to publish an up-to-date guide on enumerating and attacking domain trusts. This will likely be the last post focusing on domain trusts I publish for a while, and at over 8000 words, it’s not exactly a light read (not that anyone reads long posts ;) In general, I don’t just blog my operational notes — I try to write posts that function as complete guides for members of my team, with the hope that the information may be of use to others (whether from an offensive or defensive perspective.)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":5,"end":17,"href":"https:\u002F\u002Fyoutu.be\u002F6T-Qt4ZlFB0?t=23","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":83,"end":96,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Ftag\u002Fdomain-trusts\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":104,"end":129,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Fa-pentesters-guide-to-group-scoping\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":252,"end":287,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fpowershell\u002Fmake-powerview-great-again\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":548,"end":550,"href":"https:\u002F\u002Fxkcd.com\u002F541\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_2":{"__typename":"Paragraph","id":"e6189056e39c_2","name":"de31","type":"P","href":null,"layout":null,"metadata":null,"text":"I want this to be as complete as possible, so I’ll cover every aspect of trusts as we currently understand them. Just as with my previous posts, I want to encapsulate my knowledge of the topic as best I can at this point in time. Emphasis on “this point in time.” Our knowledge and tradecraft are always evolving, and trusts are no different. I had a number of fuzzy misconceptions regarding domain trusts when I started writing about them. I was never a sysadmin or AD architect — I’ve learned my knowledge piecemeal, which (hopefully) explains the gaps that have surfaced in my past posts, and the ones that I’m sure will continue to arise.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":207,"end":228,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_3":{"__typename":"Paragraph","id":"e6189056e39c_3","name":"b34f","type":"P","href":null,"layout":null,"metadata":null,"text":"So I am going to start fresh, in case you are not familiar with the previous posts I pushed out about trusts. As such, a few parts of this post will recycle certain elements and wording from previous work, integrated with updated knowledge and PowerView syntax. And as this is a bit of a tome of an article, I’m sure there as mistakes somewhere and things that I’ve missed, so when you find them let me know and I’ll update appropriately!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":244,"end":253,"href":"https:\u002F\u002Fgithub.com\u002FPowerShellMafia\u002FPowerSploit\u002Fblob\u002Fdev\u002FRecon\u002FPowerView.ps1","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_4":{"__typename":"Paragraph","id":"e6189056e39c_4","name":"8568","type":"P","href":null,"layout":null,"metadata":null,"text":"PowerView’s most up-to-date version will always be on the dev branch of PowerSploit.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":58,"end":83,"href":"https:\u002F\u002Fgithub.com\u002FPowerShellMafia\u002FPowerSploit\u002Fblob\u002Fdev\u002FRecon\u002FPowerView.ps1","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_5":{"__typename":"Paragraph","id":"e6189056e39c_5","name":"c9b0","type":"H4","href":null,"layout":null,"metadata":null,"text":"WTF Are Domain Trusts?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_6":{"__typename":"Paragraph","id":"e6189056e39c_6","name":"8be8","type":"P","href":null,"layout":null,"metadata":null,"text":"At a high level, a domain trust establishes the ability for users in one domain to authenticate to resources or act as a security principal in another domain. Microsoft has a lot of information out there about domain trusts, as well as “Security Considerations for Trusts”, and it can sometimes get a bit confusing. As Microsoft describes, “Most organizations that have more than one domain have a legitimate need for users to access shared resources located in a different domain“, and trusts allow organizations with multiple domains to grant users in separate domains access to shared resources. Domain forests are collections of domain containers that trust each other. Forests themselves may also have trusts between them. Microsoft has excellent post about how domain and forest trusts work. If you’re not familiar with this topic, I recommend that you check it out.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":19,"end":31,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc759554(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":121,"end":139,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc780957(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":173,"end":193,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc770299.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":198,"end":203,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc759554(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":210,"end":223,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc731335.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":237,"end":271,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc755321(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":341,"end":480,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc757352(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":599,"end":613,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc759073(v=ws.10).aspx#w2k3tr_logic_what_ovkc","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":702,"end":713,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc755700(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":763,"end":796,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc773178(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":19,"end":31,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":599,"end":613,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":341,"end":480,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_7":{"__typename":"Paragraph","id":"e6189056e39c_7","name":"9602","type":"P","href":null,"layout":null,"metadata":null,"text":"Essentially, all a trust does is link up the authentication systems of two domains and allows authentication traffic to flow between them through a system of referrals. If a user requests access to a service principal name (SPN) of a resource that resides outside of the domain they’re current in, their domain controller will return a special referral ticket that points to the key distribution center (KDC, in the Windows case the domain controller) of the foreign domain.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_8":{"__typename":"Paragraph","id":"e6189056e39c_8","name":"2093","type":"P","href":null,"layout":null,"metadata":null,"text":"The user’s ticket-granting-ticket (TGT) is included in this TGS-REP (ticket-granting service reply) referral ticket, and this ticket encrypted\u002Fsigned with the inter-realm trust key that the domains previously exchanged, instead of the first domain’s krbtgt account. This ticket is usually referred to as an “inter-realm ticket-granting-ticket\u002FTGT.” The foreign domain then verifies\u002Fdecrypts the TGT included in the referral by decrypting it with the previously negotiated inter-realm trust key, and goes about the rest of the normal Kerberos process.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_9":{"__typename":"Paragraph","id":"e6189056e39c_9","name":"8f73","type":"P","href":null,"layout":null,"metadata":null,"text":"Sean Metcalf has a great breakdown of this process in his “It’s All About Trust” post, and he describes the process as, “Once there is a trust between two domains … the ticket-granting service of each domain (“realm” in Kerberos speak) is registered as a security principal with the other domain’s Kerberos service (KDC). This enables the ticket-granting service in each domain to treat the one in the other domain as just another service providing cross-domain service access for resources in the other domain.”","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":12,"href":"https:\u002F\u002Ftwitter.com\u002Fpyrotek3","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":59,"end":79,"href":"https:\u002F\u002Fadsecurity.org\u002F?p=1588","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":121,"end":511,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_10":{"__typename":"Paragraph","id":"e6189056e39c_10","name":"2247","type":"P","href":null,"layout":null,"metadata":null,"text":"So basically, when the foreign domain decrypts the referral ticket with the negotiated trust key, it sees the user’s TGT and says “OK, the other domain already authenticated this user and said this is who they say they are\u002Fthese are the groups the user is in, so I’ll trust this information as accurate because I trust the domain that issued the referral.”","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":131,"end":355,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_11":{"__typename":"Paragraph","id":"e6189056e39c_11","name":"4a9b","type":"P","href":null,"layout":null,"metadata":null,"text":"Here’s a picture to visualize the Kerberos process across trust boundaries:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*Hfo-BgoCQjoc1G1H.png":{"__typename":"ImageMetadata","id":"0*Hfo-BgoCQjoc1G1H.png","originalHeight":662,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_12":{"__typename":"Paragraph","id":"e6189056e39c_12","name":"3a0a","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*Hfo-BgoCQjoc1G1H.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_13":{"__typename":"Paragraph","id":"e6189056e39c_13","name":"debe","type":"P","href":null,"layout":null,"metadata":null,"text":"The purpose of establishing a trust is to allow users from one domain to access resources (like the local Administrators group on a server), to be nested in groups, or to otherwise be used as security principals in another domain (e.g. for AD object ACLs). One exception to this is intra-forest trusts (domain trusts that exist within the same Active Directory forest)- any domain created within a forest retains an implicit two-way, transitive trust relationship with every other domain in the forest. This has numerous implications which will be covered later in this post.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_14":{"__typename":"Paragraph","id":"e6189056e39c_14","name":"120b","type":"P","href":null,"layout":null,"metadata":null,"text":"But before that, we have to cover a few more characteristics of trusts.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_15":{"__typename":"Paragraph","id":"e6189056e39c_15","name":"1915","type":"P","href":null,"layout":null,"metadata":null,"text":"There are several types of trusts, some of which have various offensive implications, covered in a bit:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_16":{"__typename":"Paragraph","id":"e6189056e39c_16","name":"f8bc","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Parent\u002FChild — part of the same forest — a child domain retains an implicit two-way transitive trust with its parent. This is probably the most common type of trust that you’ll encounter.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":12,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_17":{"__typename":"Paragraph","id":"e6189056e39c_17","name":"090c","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Cross-link — aka a “shortcut trust” between child domains to improve referral times. Normally referrals in a complex forest have to filter up to the forest root and then back down to the target domain, so for a geographically spread out scenario, cross-links can make sense to cut down on authentication times.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":10,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_18":{"__typename":"Paragraph","id":"e6189056e39c_18","name":"6ba2","type":"ULI","href":null,"layout":null,"metadata":null,"text":"External — an implicitly non-transitive trust created between disparate domains. “External trusts provide access to resources in a domain outside of the forest that is not already joined by a forest trust.” External trusts enforce SID filtering, a security protection covered later in this post.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":82,"end":205,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc773178(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":9,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":82,"end":205,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_19":{"__typename":"Paragraph","id":"e6189056e39c_19","name":"566f","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Tree-root — an implicit two-way transitive trust between the forest root domain and the new tree root you’re adding. I haven’t encountered tree-root trusts too often, but from the Microsoft documentation, they’re created when you when you create a new domain tree in a forest. These are intra-forest trusts, and they preserve two-way transitivity while allowing the tree to have a separate domain name (instead of child.parent.com).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":180,"end":203,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc773178(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":317,"end":346,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc757352(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":10,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_20":{"__typename":"Paragraph","id":"e6189056e39c_20","name":"bcc4","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Forest — a transitive trust between one forest root domain and another forest root domain. Forest trusts also enforce SID filtering.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":6,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_21":{"__typename":"Paragraph","id":"e6189056e39c_21","name":"52ea","type":"ULI","href":null,"layout":null,"metadata":null,"text":"MIT — a trust with a non-Windows RFC4120-compliant Kerberos domain. I hope to dive more into MIT trusts in the future.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":33,"end":50,"href":"https:\u002F\u002Ftools.ietf.org\u002Fhtml\u002Frfc4120","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":3,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_22":{"__typename":"Paragraph","id":"e6189056e39c_22","name":"b354","type":"P","href":null,"layout":null,"metadata":null,"text":"Transitivity, huh? Another aspect of domain trusts is that they are transitive or non-transitive. To quote the MSDN documentation on transitivity: “A transitive trust extends trust relationships to other domains; a nontransitive trust does not extend trust relationships to other domains.” This means that transitive trusts can be chained, so users can potentially access resources in multiple domains. Meaning, if domain A trusts B, and B trusts C, then A implicitly trusts C. Under the hood, if a specific trust relationship is transitive, then the trusting domain can repack a user’s TGT into additional referral tickets and forward them onto domains that domain trusts.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":148,"end":288,"href":"http:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc759554(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":148,"end":288,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":551,"end":559,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":654,"end":658,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*5TcceF20YM8lqARJ.jpg":{"__typename":"ImageMetadata","id":"0*5TcceF20YM8lqARJ.jpg","originalHeight":323,"originalWidth":500,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_23":{"__typename":"Paragraph","id":"e6189056e39c_23","name":"f733","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*5TcceF20YM8lqARJ.jpg"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_24":{"__typename":"Paragraph","id":"e6189056e39c_24","name":"989c","type":"P","href":null,"layout":null,"metadata":null,"text":"Also, trusts can be one-way or two-way. A bidirectional (two-way) trust is actually just two one-way trusts. A one-way trust means users and computers in a trusted domain can potentially access resources in another trusting domain. A one-way trust is in one direction only, hence the name. Users and computers in the trusting domain can not access resources in the trusted domain. Microsoft has a nice diagram to visualize this:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":156,"end":170,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":215,"end":230,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":317,"end":325,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":365,"end":372,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*xWw0ToUAHf8ScLR-.png":{"__typename":"ImageMetadata","id":"0*xWw0ToUAHf8ScLR-.png","originalHeight":465,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_25":{"__typename":"Paragraph","id":"e6189056e39c_25","name":"06a5","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*xWw0ToUAHf8ScLR-.png"},"text":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc759554(v=ws.10).aspx","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":66,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc759554(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_26":{"__typename":"Paragraph","id":"e6189056e39c_26","name":"a35a","type":"P","href":null,"layout":null,"metadata":null,"text":"This was something that messed with my head when I started — from an offensive perspective, what we care about is the direction of access, not the direction of the trust. With a one-way trust where A -trusts-\u003E B, if the trust is enumerated from A, the trust is marked as outbound, while if the same trust is enumerated from B the trust is marked as inbound, while the potential access is from B to A. This will make more sense in the Foreign Relationship Enumeration section.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":198,"end":211,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":393,"end":394,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":398,"end":399,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":434,"end":466,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":118,"end":137,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":147,"end":169,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":271,"end":279,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":349,"end":356,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_27":{"__typename":"Paragraph","id":"e6189056e39c_27","name":"6483","type":"H4","href":null,"layout":null,"metadata":null,"text":"Why Care?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_28":{"__typename":"Paragraph","id":"e6189056e39c_28","name":"33c0","type":"P","href":null,"layout":null,"metadata":null,"text":"But really, why care?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_29":{"__typename":"Paragraph","id":"e6189056e39c_29","name":"9c25","type":"P","href":null,"layout":null,"metadata":null,"text":"Domain trusts often introduce unintended access paths between environments. In many organizations, trusts were implemented years (sometimes 10+) ago without major considerations given to security. Some corporate entities that are focused on acquisitions often just “plug in” a new company’s Active Directory network either as a child domain or external trust, without fully considering the security implications.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_30":{"__typename":"Paragraph","id":"e6189056e39c_30","name":"9a63","type":"P","href":null,"layout":null,"metadata":null,"text":"Because historically there have not been many toolsets that allow you to easily map, enumerate, and visualize the risk associated with misconfigured trusts, many domain architects are unaware of the unintentional risk exposed by their Active Directory trust architectures. This links back to the idea of “misconfiguration debt” that @wald0, @cptjesus, and I spoke about at Derbycon this year. Because of this, various red teams (and probably APTz, I’m assuming) have been abusing Active Directory trusts for years with great success.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":333,"end":339,"href":"https:\u002F\u002Ftwitter.com\u002F_wald0","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":341,"end":350,"href":"https:\u002F\u002Ftwitter.com\u002Fcptjesus","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":358,"end":391,"href":"https:\u002F\u002Fwww.slideshare.net\u002FAndyRobbins3\u002Fhere-be-dragons-the-unexplored-land-of-active-directory-acls\u002F11","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_31":{"__typename":"Paragraph","id":"e6189056e39c_31","name":"7fb1","type":"P","href":null,"layout":null,"metadata":null,"text":"A common scenario is compromising a development or subsidiary domain and leveraging that access to pivot into the secure root\u002Fenclave. This also introduces opportunities for persistence- why leave code running in a secured environment, when you can have implants running in the less-secured (but trusted) domain that can then be used to re-compromise your target at will?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_32":{"__typename":"Paragraph","id":"e6189056e39c_32","name":"d6f3","type":"P","href":null,"layout":null,"metadata":null,"text":"An intra-forest trust (parent\u002Fchild or tree-root) introduces an awesome attack vector that’s described in The Trustpocalypse later in this post. External\u002Finter-forest trusts do not guarantee any kind of privileged access, but at a minimum, a trust means that you can query any normal Active Directory information from a domain that trusts you (yes, this means in some cases you can Kerberoast across trusts, more on this at the end of post.) After all, Active Directory is meant as a queryable database of information, and trusts don’t change that!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":106,"end":124,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":174,"end":190,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_33":{"__typename":"Paragraph","id":"e6189056e39c_33","name":"8df8","type":"H4","href":null,"layout":null,"metadata":null,"text":"A Trust Attack Strategy","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_34":{"__typename":"Paragraph","id":"e6189056e39c_34","name":"78d0","type":"P","href":null,"layout":null,"metadata":null,"text":"Before we get into the technical details of how to enumerate and abuse trusts, I wanted to go over the high level strategy I use when auditing trust relationships. When I talk about a “trust attack strategy” what I mean is a way to laterally move from the domain in which your access currently resides into another domain you’re targeting.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_35":{"__typename":"Paragraph","id":"e6189056e39c_35","name":"97f1","type":"P","href":null,"layout":null,"metadata":null,"text":"(1) The first step is to enumerate all trusts your current domain has, along with any trusts those domains have, and so on. Basically, you want to produce a mapping of all the domains you can reach from your current context through the linking of trust referrals. This will allow you to determine the domains you need to hop through to get to your target and what techniques you can execute to (possibly) achieve this. Any domains in the mapped “mesh” that are in the same forest (e.g. parent-\u003Echild relationships) are of particular interest due to the SIDhistory-trust-hopping technique developed by Sean Metcalf and Benjamin Delpy, also covered in the The Trustpocalypse section.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":601,"end":613,"href":"https:\u002F\u002Ftwitter.com\u002Fpyrotek3","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":618,"end":632,"href":"https:\u002F\u002Ftwitter.com\u002Fgentilkiwi","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":3,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":654,"end":672,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":93,"end":98,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_36":{"__typename":"Paragraph","id":"e6189056e39c_36","name":"ab4e","type":"P","href":null,"layout":null,"metadata":null,"text":"(2) The next step is to enumerate any users\u002Fgroups\u002Fcomputers (security principals) in one domain that either (1) have access to resources in another domain (i.e. membership in local administrator groups, or DACL ACE entries), or (2) are in groups or (if a group) have users from another domain. The point here is to find relationships that cross the mapped trust boundaries in some way, and therefore might provide a type of “access bridge” from one domain to another in the mesh. While a cross-domain nested relationship is not guaranteed to facilitate access, trusts are normally implemented for a reason, meaning more often than not some type of cross-domain user\u002Fgroup\u002Fresource “nesting” probably exists, and in many organizations these relationships are misconfigured. Another subnote- as mentioned, Kerberoasting across trusts may be another vector to hop a trust boundary. Check out the Another Sidenote: Kerberoasting Across Domain Trusts section for more information.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":3,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":833,"end":836,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":894,"end":946,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_37":{"__typename":"Paragraph","id":"e6189056e39c_37","name":"0db2","type":"P","href":null,"layout":null,"metadata":null,"text":"(3) Now that you have mapped out the trust mesh, types, and cross-domain nested relationships, you have a map of what accounts you need to compromise to pivot from your current domain into your target. By performing targeted account compromise, and utilizing SID-history-hopping for domain trusts within a forest, we have been able to pivot through up to 7+ domains in the field to reach our objective.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":3,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_38":{"__typename":"Paragraph","id":"e6189056e39c_38","name":"5217","type":"P","href":null,"layout":null,"metadata":null,"text":"At a minimum, remember that if a domain trusts you, i.e. if the trust is bidirectional or if one-way and inbound, then you can query any Active Directory information from the trusting domain. And remember that all parent-\u003Echild (intra-forest domain trusts) retain an implicit two way transitive trust with each other. Also, due to how child domains are added, the “Enterprise Admins” group is automatically added to Administrators domain local group in each domain in the forest. This means that trust “flows down” from the forest root, making it our objective to move from child to forest root at any appropriate step in the attack chain.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":175,"end":183,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_39":{"__typename":"Paragraph","id":"e6189056e39c_39","name":"4c90","type":"H4","href":null,"layout":null,"metadata":null,"text":"OK, How Do I Enumerate Trusts?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_40":{"__typename":"Paragraph","id":"e6189056e39c_40","name":"e92a","type":"P","href":null,"layout":null,"metadata":null,"text":"OK Will, you’ve piqued my interest. How do I go about figuring out what trust relationships exist in my environment?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_41":{"__typename":"Paragraph","id":"e6189056e39c_41","name":"8bf9","type":"P","href":null,"layout":null,"metadata":null,"text":"As far as I know, there are three main methods to enumerate trusts: Win32 API calls, various .NET methods, and LDAP. Each one (frustratingly) returns a differing set of information, and each one has different execution methods. I’ll cover the old school ways and the new, from built-in (and external) binaries, to .NET, to Win32 API calls, to PowerShell\u002FPowerView and BloodHound.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":368,"end":378,"href":"https:\u002F\u002Fgithub.com\u002FBloodHoundAD\u002FBloodHound\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_42":{"__typename":"Paragraph","id":"e6189056e39c_42","name":"715b","type":"P","href":null,"layout":null,"metadata":null,"text":"The sample trust architecture I’ll be using for this post is:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*LCu9PRWQS3ryYRy2.png":{"__typename":"ImageMetadata","id":"0*LCu9PRWQS3ryYRy2.png","originalHeight":264,"originalWidth":342,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_43":{"__typename":"Paragraph","id":"e6189056e39c_43","name":"3a53","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*LCu9PRWQS3ryYRy2.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_44":{"__typename":"Paragraph","id":"e6189056e39c_44","name":"7b59","type":"P","href":null,"layout":null,"metadata":null,"text":"This image was generated with the new TrustVisualizer output (described in the Visualizing Domain Trusts section). With this new output, green edges mean “within forest”, red means external, and blue means inter-forest trust relationships. As with @sixdub’s DomainTrustExplorer the edge directions for one-way trust mean direction of access, not direction of trust.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":38,"end":53,"href":"https:\u002F\u002Fgithub.com\u002FHarmJ0y\u002FTrustVisualizer","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":248,"end":257,"href":"https:\u002F\u002Ftwitter.com\u002Fsixdub","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":258,"end":277,"href":"https:\u002F\u002Fgithub.com\u002Fsixdub\u002FDomainTrustExplorer","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":79,"end":104,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":137,"end":142,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":171,"end":174,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":195,"end":199,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":321,"end":340,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":346,"end":364,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_45":{"__typename":"Paragraph","id":"e6189056e39c_45","name":"d5d8","type":"H4","href":null,"layout":null,"metadata":null,"text":".NET Methods","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_46":{"__typename":"Paragraph","id":"e6189056e39c_46","name":"5359","type":"P","href":null,"layout":null,"metadata":null,"text":".NET provides us with some nice method wrappers that can enumerate a good chunk of domain and forest trust information. This was the first method that PowerView implemented, before branching into Win32 API and LDAP methods.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_47":{"__typename":"Paragraph","id":"e6189056e39c_47","name":"bd36","type":"P","href":null,"layout":null,"metadata":null,"text":"The [System.DirectoryServices.ActiveDirectory.Domain] namespace has a GetCurrentDomain() static method that returns a System.DirectoryServices.ActiveDirectory.Domain class instance. This class implements the GetAllTrustRelationships() method which nicely, “Retrieves all of the trust relationships for this domain.” One advantage of this method is its simplicity — the information is laid out in a fashion that is easy to read and understand. One disadvantage is that it doesn’t contain some of the additional information that other enumeration methods produce.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":70,"end":88,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.directoryservices.activedirectory.domain.getcurrentdomain(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":118,"end":165,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.directoryservices.activedirectory.domain(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":208,"end":234,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.directoryservices.activedirectory.domain.getalltrustrelationships(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":257,"end":314,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_48":{"__typename":"Paragraph","id":"e6189056e39c_48","name":"1a9c","type":"BQ","href":null,"layout":null,"metadata":null,"text":"([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_49":{"__typename":"Paragraph","id":"e6189056e39c_49","name":"cf55","type":"P","href":null,"layout":null,"metadata":null,"text":"This used to be PowerView’s default Get-DomainTrust enumeration method. I recently changed the default method to be LDAP, as this .NET method does not return forest trusts by default, while LDAP enumeration does. So in order to execute this method, you now need to run Get-DomainTrust -NET.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":36,"end":51,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":269,"end":289,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_50":{"__typename":"Paragraph","id":"e6189056e39c_50","name":"612c","type":"P","href":null,"layout":null,"metadata":null,"text":"Here’s how it looks for my sample domain setup, running the enumeration from sub.dev.testlab.local:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":77,"end":98,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*xyea9Y0sYsKL9HC1.png":{"__typename":"ImageMetadata","id":"0*xyea9Y0sYsKL9HC1.png","originalHeight":216,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_51":{"__typename":"Paragraph","id":"e6189056e39c_51","name":"32f8","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*xyea9Y0sYsKL9HC1.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_52":{"__typename":"Paragraph","id":"e6189056e39c_52","name":"bf5b","type":"P","href":null,"layout":null,"metadata":null,"text":"Forest trusts are functionally different than domain trusts. So if you want to enumerate any current forest-\u003Eforest trusts, you need to call on [System.DirectoryServices.ActiveDirectory.Forest] instead. Resulting forest objects also have their own GetAllTrustRelationships() method which will return any current forest trusts:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":144,"end":193,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.directoryservices.activedirectory.forest(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":248,"end":274,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.directoryservices.activedirectory.forest.getalltrustrelationships(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_53":{"__typename":"Paragraph","id":"e6189056e39c_53","name":"027f","type":"BQ","href":null,"layout":null,"metadata":null,"text":"([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()).GetAllTrustRelationships()","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_54":{"__typename":"Paragraph","id":"e6189056e39c_54","name":"e8dc","type":"P","href":null,"layout":null,"metadata":null,"text":"This is implemented as the default enumeration methods for PowerView’s Get-ForestTrust function. Here’s how it looks for my sample domain setup, again from sub.dev.testlab.local:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":71,"end":86,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":156,"end":177,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*ecIOhLJQtK6Lnqv3.png":{"__typename":"ImageMetadata","id":"0*ecIOhLJQtK6Lnqv3.png","originalHeight":308,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_55":{"__typename":"Paragraph","id":"e6189056e39c_55","name":"d036","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*ecIOhLJQtK6Lnqv3.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_56":{"__typename":"Paragraph","id":"e6189056e39c_56","name":"160e","type":"H4","href":null,"layout":null,"metadata":null,"text":"Win32API","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_57":{"__typename":"Paragraph","id":"e6189056e39c_57","name":"169f","type":"P","href":null,"layout":null,"metadata":null,"text":"You can also enumerate domain trusts through the DsEnumerateDomainTrusts() Win32 API call which returns a DS_DOMAIN_TRUSTS structure. While the information is a bit more complex than the .NET methods, it returns the SID and GUID of the target domain, as well as some useful flags and attributes. The flags are documented here and will tell you the trust direction, whether the trust is within the same forest, etc. The attributes are documented here under the TrustAttributes specification, and include things like WITHIN_FOREST, NON_TRANSITIVE, FILTER_SIDS, and more. FILTER_SIDS is the equivalent of QUARANTINED_DOMAIN if you ever see that nomenclature.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":49,"end":74,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fms675976(v=vs.85).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":106,"end":122,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fms676059(v=vs.85).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":310,"end":325,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fms675976(v=vs.85).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":434,"end":449,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fms722477(v=vs.85).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":460,"end":475,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_58":{"__typename":"Paragraph","id":"e6189056e39c_58","name":"2a02","type":"P","href":null,"layout":null,"metadata":null,"text":"You can invoke this method with Get-DomainTrust -API (same sub.dev.testlab.local origination domain):","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":32,"end":52,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*-XdEQOaPh69fc8RD.png":{"__typename":"ImageMetadata","id":"0*-XdEQOaPh69fc8RD.png","originalHeight":965,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_59":{"__typename":"Paragraph","id":"e6189056e39c_59","name":"40b7","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*-XdEQOaPh69fc8RD.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_60":{"__typename":"Paragraph","id":"e6189056e39c_60","name":"c0b0","type":"P","href":null,"layout":null,"metadata":null,"text":"Of note, this appears to be what nltest.exe uses with its \u002Ftrusted_domains flag:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":33,"end":43,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":58,"end":74,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*JvduR4wVxiVzbq_0.png":{"__typename":"ImageMetadata","id":"0*JvduR4wVxiVzbq_0.png","originalHeight":137,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_61":{"__typename":"Paragraph","id":"e6189056e39c_61","name":"c963","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*JvduR4wVxiVzbq_0.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_62":{"__typename":"Paragraph","id":"e6189056e39c_62","name":"806e","type":"P","href":null,"layout":null,"metadata":null,"text":"This is also the method that BloodHound uses to enumerate domain trusts. You can execute this with the new SharpHound.ps1 ingestor by using the Invoke-BloodHound -CollectionMethod trusts syntax. Note that this can also be combined with -Domain \u003Cforeign.domain.fqdn\u003E for foreign trust enumeration as well.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":17,"end":44,"href":"https:\u002F\u002Fgithub.com\u002FBloodHoundAD\u002FSharpHound\u002Fblob\u002Fb2f98dc9e5675b5687964a7eaeeb3573fe6b676a\u002FSharphound2\u002FEnumeration\u002FDomainTrustEnumeration.cs#L140-L143","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":107,"end":121,"href":"https:\u002F\u002Fgithub.com\u002FBloodHoundAD\u002FBloodHound\u002Fblob\u002Fmaster\u002FIngestors\u002FSharpHound.ps1","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":144,"end":186,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":236,"end":265,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_63":{"__typename":"Paragraph","id":"e6189056e39c_63","name":"08d7","type":"H4","href":null,"layout":null,"metadata":null,"text":"LDAP","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_64":{"__typename":"Paragraph","id":"e6189056e39c_64","name":"e873","type":"P","href":null,"layout":null,"metadata":null,"text":"Domain trusts are stored in Active Directory as “trusted domain objects” with an objectClass of trustedDomain. This means you can use whatever LDAP querying method you would like to find out information about any domain trusts that are present by using the LDAP filter (objectClass=trustedDomain).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":96,"end":109,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fms683977(v=vs.85).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":96,"end":109,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":269,"end":296,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_65":{"__typename":"Paragraph","id":"e6189056e39c_65","name":"6de6","type":"P","href":null,"layout":null,"metadata":null,"text":"For example, here’s dsquery (only available on Windows servers):","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_66":{"__typename":"Paragraph","id":"e6189056e39c_66","name":"c2ba","type":"BQ","href":null,"layout":null,"metadata":null,"text":"dsquery * -filter “(objectClass=trustedDomain)” -attr *","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*RcY7dWBg81Kqrrze.png":{"__typename":"ImageMetadata","id":"0*RcY7dWBg81Kqrrze.png","originalHeight":576,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_67":{"__typename":"Paragraph","id":"e6189056e39c_67","name":"1b1c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*RcY7dWBg81Kqrrze.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_68":{"__typename":"Paragraph","id":"e6189056e39c_68","name":"8cb7","type":"P","href":null,"layout":null,"metadata":null,"text":"The equivalent syntax with Joeware’s Adfind is .\\adfind.exe -f objectclass=trusteddomain.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":27,"end":43,"href":"http:\u002F\u002Fwww.joeware.net\u002Ffreetools\u002Ftools\u002Fadfind\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":47,"end":88,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_69":{"__typename":"Paragraph","id":"e6189056e39c_69","name":"8931","type":"P","href":null,"layout":null,"metadata":null,"text":"And finally PowerView, which again now uses this LDAP as the default enumeration method for Get-DomainTrust:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":92,"end":107,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*eQCc9ws32P6xvMPd.png":{"__typename":"ImageMetadata","id":"0*eQCc9ws32P6xvMPd.png","originalHeight":583,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_70":{"__typename":"Paragraph","id":"e6189056e39c_70","name":"daea","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*eQCc9ws32P6xvMPd.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_71":{"__typename":"Paragraph","id":"e6189056e39c_71","name":"1b6c","type":"P","href":null,"layout":null,"metadata":null,"text":"Since this LDAP method is now the default for PowerView’s Get-DomainTrust, I’m going to break down some of the result properties that might be a bit confusing.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":58,"end":73,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_72":{"__typename":"Paragraph","id":"e6189056e39c_72","name":"f3d6","type":"P","href":null,"layout":null,"metadata":null,"text":"TrustType:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":9,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc223771.aspx","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_73":{"__typename":"Paragraph","id":"e6189056e39c_73","name":"52fa","type":"ULI","href":null,"layout":null,"metadata":null,"text":"DOWNLEVEL (0x00000001) — a trusted Windows domain that IS NOT running Active Directory. This is output as WINDOWS_NON_ACTIVE_DIRECTORY in PowerView for those not as familiar with the terminology.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":9,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":106,"end":134,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_74":{"__typename":"Paragraph","id":"e6189056e39c_74","name":"dfcb","type":"ULI","href":null,"layout":null,"metadata":null,"text":"UPLEVEL (0x00000002) — a trusted Windows domain that IS running Active Directory.This is output as WINDOWS_ACTIVE_DIRECTORY in PowerView for those not as familiar with the terminology.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":7,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":99,"end":123,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_75":{"__typename":"Paragraph","id":"e6189056e39c_75","name":"d073","type":"ULI","href":null,"layout":null,"metadata":null,"text":"MIT (0x00000003) — a trusted domain that is running a non-Windows (*nix), RFC4120-compliant Kerberos distribution. This is labeled as MIT due to, well, MIT publishing RFC4120.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":3,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_76":{"__typename":"Paragraph","id":"e6189056e39c_76","name":"61b7","type":"P","href":null,"layout":null,"metadata":null,"text":"TrustAttributes:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":15,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc223779.aspx","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_77":{"__typename":"Paragraph","id":"e6189056e39c_77","name":"2c18","type":"ULI","href":null,"layout":null,"metadata":null,"text":"NON_TRANSITIVE (0x00000001) — the trust cannot be used transitively. That is, if DomainA trusts DomainB and DomainB trusts DomainC, then DomainA does not automatically trust DomainC. Also, if a trust is non-transitive, then you will not be able to query any Active Directory information from trusts up the chain from the non-transitive point. External trusts are implicitly non-transitive.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":14,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_78":{"__typename":"Paragraph","id":"e6189056e39c_78","name":"242d","type":"ULI","href":null,"layout":null,"metadata":null,"text":"UPLEVEL_ONLY (0x00000002) — only Windows 2000 operating system and newer clients can use the trust.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":12,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_79":{"__typename":"Paragraph","id":"e6189056e39c_79","name":"e1b0","type":"ULI","href":null,"layout":null,"metadata":null,"text":"QUARANTINED_DOMAIN (0x00000004) — SID filtering is enabled (more on this later). Output as FILTER_SIDS with PowerView for simplicity.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":19,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":91,"end":102,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_80":{"__typename":"Paragraph","id":"e6189056e39c_80","name":"c221","type":"ULI","href":null,"layout":null,"metadata":null,"text":"FOREST_TRANSITIVE (0x00000008) — cross-forest trust between the root of two domain forests running at least domain functional level 2003 or above.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":17,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_81":{"__typename":"Paragraph","id":"e6189056e39c_81","name":"b37b","type":"ULI","href":null,"layout":null,"metadata":null,"text":"CROSS_ORGANIZATION (0x00000010) — the trust is to a domain or forest that is not part of the organization, which adds the OTHER_ORGANIZATION SID. This is a bit of a weird one. I don’t remember encountering this flag in the field, but according to this post it means that the selective authentication security protection is enabled. For more information, check out this MSDN doc.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":244,"end":256,"href":"https:\u002F\u002Fimav8n.wordpress.com\u002F2008\u002F07\u002F30\u002Ftrust-attribute-cross_organization-and-selective-auth\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":364,"end":377,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc755321(v=ws.10).aspx#w2k3tr_trust_security_zyzk","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":18,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_82":{"__typename":"Paragraph","id":"e6189056e39c_82","name":"8ed0","type":"ULI","href":null,"layout":null,"metadata":null,"text":"WITHIN_FOREST (0x00000020) — the trusted domain is within the same forest, meaning a parent-\u003Echild or cross-link relationship","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":13,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_83":{"__typename":"Paragraph","id":"e6189056e39c_83","name":"fe25","type":"ULI","href":null,"layout":null,"metadata":null,"text":"TREAT_AS_EXTERNAL (0x00000040) — the trust is to be treated as external for trust boundary purposes. According to the documentation, “If this bit is set, then a cross-forest trust to a domain is to be treated as an external trust for the purposes of SID Filtering. Cross-forest trusts are more stringently filtered than external trusts. This attribute relaxes those cross-forest trusts to be equivalent to external trusts.” This sounds enticing, and I’m not 100% sure on the security implications of this statement ¯\\_(ツ)_\u002F¯ but I will update this post if anything new surfaces.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":111,"end":131,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc223779.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":18,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":265,"end":335,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":134,"end":422,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_84":{"__typename":"Paragraph","id":"e6189056e39c_84","name":"7785","type":"ULI","href":null,"layout":null,"metadata":null,"text":"USES_RC4_ENCRYPTION (0x00000080) — if the TrustType is MIT, specifies that the trust that supports RC4 keys.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":20,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_85":{"__typename":"Paragraph","id":"e6189056e39c_85","name":"ee20","type":"ULI","href":null,"layout":null,"metadata":null,"text":"USES_AES_KEYS (0x00000100) — not listed in the linked Microsoft documentation, but according to some documentation I’ve been able to find online, it specifies that AES keys are used to encrypt KRB TGTs.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":96,"end":114,"href":"http:\u002F\u002Fkrbdev.mit.edu\u002Frt\u002FTicket\u002FDisplay.html?id=5477","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":133,"end":144,"href":"https:\u002F\u002Fretep998.github.io\u002Fdoc\u002Fwinapi\u002Fntsecapi\u002Fconstant.TRUST_ATTRIBUTE_TRUST_USES_AES_KEYS.html","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":13,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_86":{"__typename":"Paragraph","id":"e6189056e39c_86","name":"68a4","type":"ULI","href":null,"layout":null,"metadata":null,"text":"CROSS_ORGANIZATION_NO_TGT_DELEGATION (0x00000200) — “If this bit is set, tickets granted under this trust MUST NOT be trusted for delegation.” This is described more in [MS-KILE] 3.3.5.7.5 (Cross-Domain Trust and Referrals.)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":53,"end":141,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc223779.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":169,"end":188,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc233949.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":36,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":53,"end":141,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_87":{"__typename":"Paragraph","id":"e6189056e39c_87","name":"6b3e","type":"ULI","href":null,"layout":null,"metadata":null,"text":"PIM_TRUST (0x00000400) — “If this bit and the TATE (treat as external) bit are set, then a cross-forest trust to a domain is to be treated as Privileged Identity Management trust for the purposes of SID Filtering.” According to [MS-PAC] 4.1.2.2 (SID Filtering and Claims Transformation), “A domain can be externally managed by a domain that is outside the forest. The trusting domain allows SIDs that are local to its forest to come over a PrivilegedIdentityManagement trust.” While I have not seen this in the field, and it’s only supported by domain functional level 2012R2 and above, it also warrants further investigation :)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":26,"end":213,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc223779.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":227,"end":244,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237940.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":289,"end":475,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237940.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":9,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":26,"end":213,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":289,"end":475,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_88":{"__typename":"Paragraph","id":"e6189056e39c_88","name":"1bc4","type":"P","href":null,"layout":null,"metadata":null,"text":"All of these methods can also be executed against a domain that currently trusts you. Meaning, if your current domain has a bidirectional trust with FOREIGN domain, or if the trust is one-way and inbound (meaning said domain trusts you and therefore you have some kind of access), you can execute these methods against said domain to find the trusts for THAT domain. If you want to do this with PowerView, just supply the -Domain \u003Cdomain.fqdn\u003E parameter, described in more detail in the next section.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":422,"end":443,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_89":{"__typename":"Paragraph","id":"e6189056e39c_89","name":"ee62","type":"H4","href":null,"layout":null,"metadata":null,"text":"Data Enumeration Across Trusts With PowerView","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_90":{"__typename":"Paragraph","id":"e6189056e39c_90","name":"fda5","type":"P","href":null,"layout":null,"metadata":null,"text":"Last year I described my ground-up rewrite of PowerView. One of the changes mentioned was that now, any Get-Domain* function uses LDAP enumeration, meaning that we can pull said information from a domain that trusts us. This is done with the -Domain \u003Cdomain.fqdn\u003E parameter:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":25,"end":55,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fpowershell\u002Fmake-powerview-great-again\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":104,"end":115,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":242,"end":263,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*AvadO5OQYnwYQsji.png":{"__typename":"ImageMetadata","id":"0*AvadO5OQYnwYQsji.png","originalHeight":530,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_91":{"__typename":"Paragraph","id":"e6189056e39c_91","name":"4486","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*AvadO5OQYnwYQsji.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_92":{"__typename":"Paragraph","id":"e6189056e39c_92","name":"403e","type":"P","href":null,"layout":null,"metadata":null,"text":"So what’s actually happening under the hood?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_93":{"__typename":"Paragraph","id":"e6189056e39c_93","name":"0ff2","type":"P","href":null,"layout":null,"metadata":null,"text":"For a long time, I thought that this would “reflect” LDAP queries through a domain controller in your current domain and onto domain controllers in the trusting domain. This would have been an awesome way to get around network boundaries, but sadly I was mistaken. What actually happens is that a referral is returned by the domain controller you are currently communicating with, which instructs your searching method to then bind to the foreign domain (i.e. the primary domain controller\u002FPDC for that domain). If there is a trust with the foreign domain, an inter-realm TGT will be returned that can be used when communicating to the foreign domain.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_94":{"__typename":"Paragraph","id":"e6189056e39c_94","name":"3a1a","type":"P","href":null,"layout":null,"metadata":null,"text":"This means that if there is network segmentation between the computer you’re currently querying from, and the PDC for the trusting domain, you won’t be able to retrieve any results \u003E_\u003C","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_95":{"__typename":"Paragraph","id":"e6189056e39c_95","name":"9e82","type":"P","href":null,"layout":null,"metadata":null,"text":"From the Kerberos side, “under the hood”, this means that a series of inter-realm referral tickets are automatically issued that allow our user to eventually request an LDAP service ticket from the target domain. If we use our sample domain architecture, and currently reside in sub.dev.testlab.local while querying prod.contoso.local, here’s how the klist output looks:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":279,"end":300,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":316,"end":334,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*7qGb-3BgXtMfizeS.png":{"__typename":"ImageMetadata","id":"0*7qGb-3BgXtMfizeS.png","originalHeight":631,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_96":{"__typename":"Paragraph","id":"e6189056e39c_96","name":"cb57","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*7qGb-3BgXtMfizeS.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_97":{"__typename":"Paragraph","id":"e6189056e39c_97","name":"4d0a","type":"P","href":null,"layout":null,"metadata":null,"text":"You can see the inter-realm tickets filtering up the trust chain to testlab.local, and eventually to contoso.local and eventually to prod.contoso.local.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":68,"end":81,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":101,"end":114,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":133,"end":151,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_98":{"__typename":"Paragraph","id":"e6189056e39c_98","name":"b32c","type":"H4","href":null,"layout":null,"metadata":null,"text":"Mapping Domain Trusts","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_99":{"__typename":"Paragraph","id":"e6189056e39c_99","name":"d853","type":"P","href":null,"layout":null,"metadata":null,"text":"There are few ways I know of to map the “mesh” of one or more trusts that exist in your environment. The first is through the global catalog. I talked about this a bit in my “A Pentester’s Guide to Group Scoping” post, but I’ll reiterate some of that information here.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":175,"end":211,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Fa-pentesters-guide-to-group-scoping\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_100":{"__typename":"Paragraph","id":"e6189056e39c_100","name":"a2ec","type":"P","href":null,"layout":null,"metadata":null,"text":"The global catalog is a partial copy of all objects in an Active Directory forest, meaning that some object properties (but not all) are contained within it. This data is replicated among all domain controllers marked as global catalogs for the forest. Trusted domain objects are replicated in the global catalog, so we can enumerate every single internal and external trust that all domains in our current forest have extremely quickly, and only with traffic to our current PDC by running Get-DomainTrust -SearchBase “GC:\u002F\u002F$($ENV:USERDNSDOMAIN)” through PowerView. Here’s how that looks running that function from sub.dev.testlab.local domain:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":4,"end":51,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc728188(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":490,"end":546,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":615,"end":637,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*vafvt2x7LZRp5_CB.png":{"__typename":"ImageMetadata","id":"0*vafvt2x7LZRp5_CB.png","originalHeight":713,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_101":{"__typename":"Paragraph","id":"e6189056e39c_101","name":"d213","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*vafvt2x7LZRp5_CB.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_102":{"__typename":"Paragraph","id":"e6189056e39c_102","name":"1cfd","type":"P","href":null,"layout":null,"metadata":null,"text":"This is a lot more results than just Get-DomainTrust !","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":37,"end":52,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_103":{"__typename":"Paragraph","id":"e6189056e39c_103","name":"8da1","type":"P","href":null,"layout":null,"metadata":null,"text":"The second method is slower, but will provide even more results. Since we can enumerate any trusts that our current domain context has, and by way of referrals through LDAP, we can query any (objectClass=trustedDomain) objects from domains that currently trust our domain, then we can keep issuing these queries for any results and “crawl” any reachable domains. Any domains marked as non-transitive can mess these results up, but we can still get a good number of results.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":191,"end":219,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_104":{"__typename":"Paragraph","id":"e6189056e39c_104","name":"1f2f","type":"P","href":null,"layout":null,"metadata":null,"text":"The PowerView function to do this is Get-DomainTrustMapping (formerly Invoke-MapDomainTrust). These results can be exported to a CSV by piping Get-DomainTrustMapping to | Export-CSV -NoTypeInformation trusts.csv.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":37,"end":59,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":143,"end":165,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":169,"end":211,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_105":{"__typename":"Paragraph","id":"e6189056e39c_105","name":"ba63","type":"P","href":null,"layout":null,"metadata":null,"text":"The last way is through BloodHound\u002FSharpHound. Again, you can execute this with the new SharpHound.ps1 ingestor by using the Invoke-BloodHound -CollectionMethod trusts syntax, and this can be combined with -Domain \u003Cforeign.domain.fqdn\u003E for foreign trust enumeration.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":88,"end":102,"href":"https:\u002F\u002Fgithub.com\u002FBloodHoundAD\u002FBloodHound\u002Fblob\u002Fmaster\u002FIngestors\u002FSharpHound.ps1","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":125,"end":167,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":206,"end":235,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_106":{"__typename":"Paragraph","id":"e6189056e39c_106","name":"de1f","type":"P","href":null,"layout":null,"metadata":null,"text":"A key thing to remember is that the exact trust mapping you’ll get will depend on the domain you’re currently in. Since the trust between external.local and sub.dev.testlab.local domain is a one-way non-transitive external trust, if you’re querying from external.local you won’t be able to see the trusts that contoso.local has, again because sub.dev.testlab.local won’t repackage your TGT into an inter-realm TGT that can be forwarded onto any other domain. Also, if you’re trying to enumerate the trusts on a foreign domain, you need to be able to bind to a domain controller (usually the PDC\u002Fprimary domain controller) in the foreign domain you’re querying. So, even if there is a transitive trust that would allow you to query the information, if network segmentation prevents you from talking to the target foreign domain, you’re out of luck.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":138,"end":152,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":157,"end":178,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":254,"end":268,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":310,"end":323,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":343,"end":364,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":199,"end":213,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_107":{"__typename":"Paragraph","id":"e6189056e39c_107","name":"3fb6","type":"H4","href":null,"layout":null,"metadata":null,"text":"Visualizing Domain Trusts","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_108":{"__typename":"Paragraph","id":"e6189056e39c_108","name":"e07d","type":"P","href":null,"layout":null,"metadata":null,"text":"Data is one thing, visualizations are another. A few years ago, one of my former workmates, Justin Warner, saw all this raw data and build a tool called DomainTrustExplorer that could perform some nodal analysis and visualization with PowerView’s mapped trust data.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":153,"end":172,"href":"https:\u002F\u002Fgithub.com\u002Fsixdub\u002FDomainTrustExplorer","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_109":{"__typename":"Paragraph","id":"e6189056e39c_109","name":"56f9","type":"P","href":null,"layout":null,"metadata":null,"text":"As the default trust output has changed, and with BloodHound taking care of nodal analysis for us, I rewrote Justin’s project into a simplified form that will take the updated trust .CSVs, TrustVisualizer:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":189,"end":204,"href":"https:\u002F\u002Fgithub.com\u002FHarmJ0y\u002FTrustVisualizer","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*YzS_paZEo9QjsD5c.png":{"__typename":"ImageMetadata","id":"0*YzS_paZEo9QjsD5c.png","originalHeight":169,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_110":{"__typename":"Paragraph","id":"e6189056e39c_110","name":"3ed0","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*YzS_paZEo9QjsD5c.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_111":{"__typename":"Paragraph","id":"e6189056e39c_111","name":"077d","type":"P","href":null,"layout":null,"metadata":null,"text":"The resulting graphml can be visualized with yEd, as described here. This is how I produced the the previous visualization of the sample trust architecture:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":50,"end":67,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fdomain-trusts-why-you-should-care\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*94EMQtGo-f_-LE3_.png":{"__typename":"ImageMetadata","id":"0*94EMQtGo-f_-LE3_.png","originalHeight":264,"originalWidth":342,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_112":{"__typename":"Paragraph","id":"e6189056e39c_112","name":"d2dd","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*94EMQtGo-f_-LE3_.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_113":{"__typename":"Paragraph","id":"e6189056e39c_113","name":"c7eb","type":"P","href":null,"layout":null,"metadata":null,"text":"Again, with this new output, green edges mean “within forest”, red means external, and blue means inter-forest trust relationships. As with @sixdub’s DomainTrustExplorer the edge directions for one-way trust mean direction of access, not direction of trust.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":140,"end":147,"href":"https:\u002F\u002Ftwitter.com\u002Fsixdub","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":150,"end":169,"href":"https:\u002F\u002Fgithub.com\u002Fsixdub\u002FDomainTrustExplorer","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":29,"end":34,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":63,"end":66,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":87,"end":91,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":213,"end":232,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":238,"end":256,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_114":{"__typename":"Paragraph","id":"e6189056e39c_114","name":"170a","type":"P","href":null,"layout":null,"metadata":null,"text":"When using SharpHound to collect the trust data, and BloodHound to visualization it, here’s how the same above data looks:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*32bW7GhBrrzciUTr.png":{"__typename":"ImageMetadata","id":"0*32bW7GhBrrzciUTr.png","originalHeight":500,"originalWidth":894,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_115":{"__typename":"Paragraph","id":"e6189056e39c_115","name":"8776","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*32bW7GhBrrzciUTr.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_116":{"__typename":"Paragraph","id":"e6189056e39c_116","name":"39cb","type":"H4","href":null,"layout":null,"metadata":null,"text":"Foreign Relationship Enumeration","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_117":{"__typename":"Paragraph","id":"e6189056e39c_117","name":"2757","type":"P","href":null,"layout":null,"metadata":null,"text":"Now that we’ve mapped out all domain trusts reachable from the machine we’re querying from, the next step in the attack planning phase hits few branches, depending on the specific types of the trusts we’ve encountered. These next steps need to be executed for the hop from each each domain to another in the attack path.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_118":{"__typename":"Paragraph","id":"e6189056e39c_118","name":"d095","type":"P","href":null,"layout":null,"metadata":null,"text":"If the next domain hop is in the same forest as the domain we’re pivoting from\u002Fthrough, and we’re able to compromise the krbtgt hash of the child domain, then we can use the method described in the following Trustpocalypse section to compromise the forest root.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":88,"end":91,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":208,"end":222,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":88,"end":91,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_119":{"__typename":"Paragraph","id":"e6189056e39c_119","name":"b577","type":"P","href":null,"layout":null,"metadata":null,"text":"If we’re not able to compromise elevated access in the current\u002Fpivot child domain, or if the next step in the trust attack path is an external\u002Fforest trust, then we need to enumerate what users (if any) from the domain we’re a part of are in groups in the target domain (or the next step in the domain attack path.)","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_120":{"__typename":"Paragraph","id":"e6189056e39c_120","name":"9f7f","type":"P","href":null,"layout":null,"metadata":null,"text":"Unfortunately, there are a lot of caveats with this step. The exact nature of the trust your current domain retains with the trusting domain you’re querying will affect what information you can retrieve, and the exact methods you can use. In general, again, this enumeration heavily depends on whether you’re querying a foreign domain in the same forest, or across an external\u002Finter-forest trust. I’ll do my best to explain all the subtleties.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":125,"end":133,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_121":{"__typename":"Paragraph","id":"e6189056e39c_121","name":"dd52","type":"P","href":null,"layout":null,"metadata":null,"text":"There are three main ways that security principals (users\u002Fgroups) from one domain can have access into resources in another foreign\u002Ftrusting domain:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":16,"end":20,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":132,"end":140,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_122":{"__typename":"Paragraph","id":"e6189056e39c_122","name":"1c8f","type":"ULI","href":null,"layout":null,"metadata":null,"text":"They can be added to local groups on individual machines, i.e. the local “Administrators” group on a server.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_123":{"__typename":"Paragraph","id":"e6189056e39c_123","name":"9d68","type":"ULI","href":null,"layout":null,"metadata":null,"text":"They can be added to groups in the foreign domain. There are some caveats depending on trust type and group scope, described shortly.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_124":{"__typename":"Paragraph","id":"e6189056e39c_124","name":"fcf4","type":"ULI","href":null,"layout":null,"metadata":null,"text":"They can be added as principals in an access control list, most interesting for us as principals in ACEs in a DACL. For more background on ACLs\u002FDACLs\u002FACEs, check out the “An ACE Up The Sleeve” whitepaper.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":171,"end":191,"href":"https:\u002F\u002Fspecterops.io\u002Fassets\u002Fresources\u002Fan_ace_up_the_sleeve.pdf","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_125":{"__typename":"Paragraph","id":"e6189056e39c_125","name":"ffde","type":"H4","href":null,"layout":null,"metadata":null,"text":"Case 1: Local Group Membership","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_126":{"__typename":"Paragraph","id":"e6189056e39c_126","name":"c152","type":"P","href":null,"layout":null,"metadata":null,"text":"This involves enumerating the local memberships of one or more systems through remote SAM (SAMR) or through GPO correlation. I won’t cover this case heavily here, but will note that we have had success in the past with targeted SAMR enumeration of high value servers or domain controllers for trust-hopping. The PowerView function to do this manually is Get-NetLocalGroupMember \u003Cserver\u003E, and BloodHound will do this all automatically for you.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":100,"end":123,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fwhere-my-admins-at-gpo-edition\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":354,"end":386,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_127":{"__typename":"Paragraph","id":"e6189056e39c_127","name":"d31f","type":"H4","href":null,"layout":null,"metadata":null,"text":"Case 2: Foreign Group Membership","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_128":{"__typename":"Paragraph","id":"e6189056e39c_128","name":"8c02","type":"P","href":null,"layout":null,"metadata":null,"text":"The group membership case gets a bit tricky. The member property of an Active Directory group and the memberOf property of a user\u002Fgroup object have a special type of relationship called linked attributes. I covered this in more depth in a previous post, but with linked attributes, Active Directory calculates the value of a given attribute, referred to as the back link (e.g. memberOf with users\u002Fgroups) from the value of another attribute, referred to as the forward link (e.g. member with a group). The gist is that group membership is ultimately preserved within the target group itself in the member property, and this all gets a bit complicated over trusts. Hopefully this will make more sense shortly. Whether or not the memberOf property saved with a user\u002Fgroup object reflects their foreign group memberships depends on the nature of the trust and scoping of the foreign group they’re a member in.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":186,"end":203,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fms677270(v=vs.85).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":220,"end":252,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fdefense\u002Fhunting-with-active-directory-replication-metadata\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":49,"end":55,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":102,"end":110,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":377,"end":385,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":480,"end":486,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":598,"end":604,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":728,"end":736,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_129":{"__typename":"Paragraph","id":"e6189056e39c_129","name":"2632","type":"P","href":null,"layout":null,"metadata":null,"text":"Here’s a breakdown of the three group scopings, and which can have what type of foreign members added:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_130":{"__typename":"Paragraph","id":"e6189056e39c_130","name":"7b4a","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Domain Local Groups can have intra-forest cross-domain users (users in the same forest as the group) added as members, as well as inter-forest cross-domain users (foreign security principals.)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":19,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_131":{"__typename":"Paragraph","id":"e6189056e39c_131","name":"7708","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Global Groups can not have any cross-domain memberships, even within the same forest. So for our purposes we can ignore these.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":13,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_132":{"__typename":"Paragraph","id":"e6189056e39c_132","name":"539c","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Universal Groups can have any user in the forest as a member, but “foreign security principals” (i.e. users from forest\u002Fexternal trusts) can not be a part of universal groups.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":16,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_133":{"__typename":"Paragraph","id":"e6189056e39c_133","name":"e06e","type":"P","href":null,"layout":null,"metadata":null,"text":"If a user\u002Fgroup is nested into a group in another domain that’s in the same forest (so a “domain local” or “universal group”) then depending on the target group’s scope the membership might be updated in the user\u002Fgroup’s memberOf property. Groups with a “universal” scope have their memberships replicated in the global catalog for the forest, meaning a user’s memberOf will be updated. If the group’s scope the user is added to is “domain local”, then the user’s memberOf will NOT be updated (in the global catalog), as a group with “domain local” scope does not have its memberships replicated in the forest. So the only way to tell what a user’s foreign group memberships are, by solely looking at the user object, is if they are added to a universal group in the same forest. However, this also means that if we can bind to the global catalog of a forest, we can enumerate all of these specific cross-domain relationships easily.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":144,"end":168,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Fa-pentesters-guide-to-group-scoping\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":221,"end":229,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":361,"end":369,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":464,"end":472,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":184,"end":189,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_134":{"__typename":"Paragraph","id":"e6189056e39c_134","name":"e24e","type":"P","href":null,"layout":null,"metadata":null,"text":"If the user is nested in a group in a domain over a forest\u002Fexternal trust, then things are treated a bit differently. Users that exist over external or forest trusts can still be added to domain local groups in the specified domain. These users show up as new entries in CN=ForeignSecurityPrincipals,DC=domain,DC=com in the domain to which they’re being added, which are used as a kind of proxy that allows the foreign security identifiers to be added to resources in the domain.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":188,"end":200,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Fa-pentesters-guide-to-group-scoping\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":188,"end":200,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":271,"end":316,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*k6UHuikx0MRq8-Ga.png":{"__typename":"ImageMetadata","id":"0*k6UHuikx0MRq8-Ga.png","originalHeight":536,"originalWidth":825,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_135":{"__typename":"Paragraph","id":"e6189056e39c_135","name":"f6bf","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*k6UHuikx0MRq8-Ga.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_136":{"__typename":"Paragraph","id":"e6189056e39c_136","name":"aeff","type":"P","href":null,"layout":null,"metadata":null,"text":"As Microsoft explains it, “When a trust is established between a domain in a forest and a domain outside of that forest, security principals from the external domain can access resources in the internal domain. Active Directory creates a foreign security principal object in the internal domain to represent each security principal from the trusted external domain. These foreign security principals can become members of domain local groups in the internal domain“. If “domain local” or “group scoping” are foreign to you, check out my previous post on the subject.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":27,"end":464,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc773178(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":537,"end":565,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Fa-pentesters-guide-to-group-scoping\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":400,"end":441,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":27,"end":464,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_137":{"__typename":"Paragraph","id":"e6189056e39c_137","name":"0320","type":"P","href":null,"layout":null,"metadata":null,"text":"Tl;dr, as I understand it, these ForeignSecurityPrincipals act as aliases for the “real” user that’s external to the domain\u002Fforest, and it’s the ForeignSecurityPrincipal that’s actually added to groups in the target domain. The SID of a given ForeignSecurityPrincipal is the same SID as the foreign user, which makes for easy filtering later.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_138":{"__typename":"Paragraph","id":"e6189056e39c_138","name":"9cb3","type":"H4","href":null,"layout":null,"metadata":null,"text":"Case 3: Foreign ACL Principals","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_139":{"__typename":"Paragraph","id":"e6189056e39c_139","name":"4ae2","type":"P","href":null,"layout":null,"metadata":null,"text":"Luckily most of the ntSecurityDescriptor property of Active Directory objects is (1) accessible to any domain authenticated user, and (2) replicated in the global catalog. This means that if from your current domain context, you can query the DACLs for all objects in a trusting domain, and filter any ACE entries where a foreign security principal has the given right on the object you’re enumerating.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":20,"end":40,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":270,"end":278,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_140":{"__typename":"Paragraph","id":"e6189056e39c_140","name":"02f3","type":"P","href":null,"layout":null,"metadata":null,"text":"You can use PowerView’s Get-DomainObjectACL -Domain \u003Cdomain.fqdn\u003E function to retrieve these ACEs, but in order to find cross-domain DACL relationships, you will need to filter out principals\u002FSecurityIdentifiers that do not match the SID of the domain you’re querying. I’ll cover this in a future PowerView PowerUsage post.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":297,"end":317,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fpowershell\u002Fthe-powerview-powerusage-series-1\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":24,"end":65,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":297,"end":317,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_141":{"__typename":"Paragraph","id":"e6189056e39c_141","name":"c39a","type":"H4","href":null,"layout":null,"metadata":null,"text":"Operational Guidance","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_142":{"__typename":"Paragraph","id":"e6189056e39c_142","name":"04d1","type":"P","href":null,"layout":null,"metadata":null,"text":"Note: I’ll also walk over all steps needed in the Case Study section later in the post in case parts of this don’t make sense.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":50,"end":60,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_143":{"__typename":"Paragraph","id":"e6189056e39c_143","name":"80a0","type":"P","href":null,"layout":null,"metadata":null,"text":"If you’re currently within a child domain within a forest, and DO have elevated access in said child domain, refer to the Trustpocalypse section.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":122,"end":136,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":63,"end":65,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_144":{"__typename":"Paragraph","id":"e6189056e39c_144","name":"db36","type":"P","href":null,"layout":null,"metadata":null,"text":"If you’re currently within a child domain within a forest, and DO NOT have elevated access in said child domain, then you can run PowerView’s Get-DomainForeignUser function to enumerate users who are in groups outside of the user’s current domain. This is a domain’s “outgoing” access, i.e. users\u002Fgroups who may have some kind of access into other domain groups within the same forest. This function can be useful to also map other intra-forest domain user\u002Fgroup relationships:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":142,"end":163,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":63,"end":69,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":362,"end":385,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*yaRp_hyfh1l3SVMW.png":{"__typename":"ImageMetadata","id":"0*yaRp_hyfh1l3SVMW.png","originalHeight":267,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_145":{"__typename":"Paragraph","id":"e6189056e39c_145","name":"a8ec","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*yaRp_hyfh1l3SVMW.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_146":{"__typename":"Paragraph","id":"e6189056e39c_146","name":"4750","type":"P","href":null,"layout":null,"metadata":null,"text":"If you’re targeting an external\u002Fforest domain, or a target domain within the same forest, you can use PowerView’s Get-DomainForeignGroupMember -Domain \u003Ctarget.domain.fqdn\u003E function. This enumerates groups in the target domain that contain users\u002Fgroups who are not in the target domain. This is a domain’s “incoming” access, i.e. groups in target domain with inbound membership relationships:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":114,"end":171,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":198,"end":204,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":239,"end":251,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*6BDToLnyxe92G40P.png":{"__typename":"ImageMetadata","id":"0*6BDToLnyxe92G40P.png","originalHeight":635,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_147":{"__typename":"Paragraph","id":"e6189056e39c_147","name":"e965","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*6BDToLnyxe92G40P.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_148":{"__typename":"Paragraph","id":"e6189056e39c_148","name":"6c5b","type":"P","href":null,"layout":null,"metadata":null,"text":"Also, luckily for us, ForeignSecurityPrincipals are replicated in the global catalog, just like trusted domain objects (mentioned in the Mapping Domain Trusts section). So if you want to quickly enumerate all foreign security principals (i.e. any inbound foreign groups\u002Fusers) that are members of groups within a domain within the current\u002Ftarget forest, you can query any global catalog with an LDAP filter of ‘(objectclass=foreignSecurityPrincipal)’. And since these foreign principals can only be added to groups with a domain local scope, we can extract the domain the foreign user was added to from the distinguishedname, query that domain directly for domain local-scoped groups with members, assuming we have some type of direct or transitive trust with that target domain. This allows us to compare the membership of these domain local groups each against the list of foreign users:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":522,"end":540,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Fa-pentesters-guide-to-group-scoping\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":137,"end":158,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":410,"end":450,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"MediaResource:bf182f9b3fd2fa54fca2fcd0a5e189e7":{"__typename":"MediaResource","id":"bf182f9b3fd2fa54fca2fcd0a5e189e7","iframeSrc":"","iframeHeight":0,"iframeWidth":0,"title":"gc_foreign_local_groups.ps1"},"Paragraph:e6189056e39c_149":{"__typename":"Paragraph","id":"e6189056e39c_149","name":"efea","type":"IFRAME","href":null,"layout":"INSET_CENTER","metadata":null,"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":{"__typename":"Iframe","mediaResource":{"__ref":"MediaResource:bf182f9b3fd2fa54fca2fcd0a5e189e7"}},"mixtapeMetadata":null},"ImageMetadata:0*yu4pUPRwc5KwYvye.png":{"__typename":"ImageMetadata","id":"0*yu4pUPRwc5KwYvye.png","originalHeight":467,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_150":{"__typename":"Paragraph","id":"e6189056e39c_150","name":"f7ef","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*yu4pUPRwc5KwYvye.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_151":{"__typename":"Paragraph","id":"e6189056e39c_151","name":"0eee","type":"P","href":null,"layout":null,"metadata":null,"text":"This quickly gives us a mapping of all the foreign user\u002Fgroup nested relationships inbound into our current (or target) forest.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_152":{"__typename":"Paragraph","id":"e6189056e39c_152","name":"1c16","type":"P","href":null,"layout":null,"metadata":null,"text":"If you are using BloodHound with its new SharpHound ingestor, you can still use -Domain \u003Cdomain.fqdn\u003E with the ingestor combined with the -CollectionMethod options of ‘Group’, ‘LocalGroup’, and\u002For ‘ACL’. BloodHound models user\u002Fgroup nodes with the name@\u003Cdomain.fqdn\u003E syntax in the schema. This removes the requirement of having to perform complex analytics to extract these relationships after the data has been collected. If user@dev.testlab.local is a member of group@testlab.local, that memberOf relationship is automatically modeled. If that nested group relationship shows up in any attack paths, it will be automatically included in your graph with no extra effort.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":17,"end":27,"href":"https:\u002F\u002Fgithub.com\u002FBloodHoundAD\u002FBloodHound\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":41,"end":51,"href":"https:\u002F\u002Fgithub.com\u002FBloodHoundAD\u002FBloodHound\u002Fblob\u002Fmaster\u002FIngestors\u002FSharpHound.ps1","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":80,"end":101,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":138,"end":155,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":248,"end":266,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":426,"end":448,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":464,"end":483,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_153":{"__typename":"Paragraph","id":"e6189056e39c_153","name":"db4f","type":"P","href":null,"layout":null,"metadata":null,"text":"Makes perfect sense, right? :) This is a complex topic if you’re not familiar, so reread the previous section a few times until it makes sense how to tease out these cross-domain relationships. Check out the Case Study section for a realistic walk through with the reference architecture I’ve used throughout this post.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":208,"end":219,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_154":{"__typename":"Paragraph","id":"e6189056e39c_154","name":"a066","type":"H4","href":null,"layout":null,"metadata":null,"text":"The Trustpocalypse — SID Hopping Up Intra-Forest Trusts","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_155":{"__typename":"Paragraph","id":"e6189056e39c_155","name":"2a17","type":"P","href":null,"layout":null,"metadata":null,"text":"This is one of my favorite things I’ve learned about in the last few years in security. Just as most people remember the first time they saw Mimikatz extract a plaintext password out of memory, the memory of when I realized what this attack entailed is seared into my mind.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":141,"end":149,"href":"https:\u002F\u002Fgithub.com\u002Fgentilkiwi\u002Fmimikatz","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_156":{"__typename":"Paragraph","id":"e6189056e39c_156","name":"c592","type":"P","href":null,"layout":null,"metadata":null,"text":"It started as many of my brain-blowing moments have, by viewing a tweet from Benjamin Delpy in June of 2015, and at first not understanding the implications:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":66,"end":91,"href":"https:\u002F\u002Ftwitter.com\u002Fgentilkiwi\u002Fstatus\u002F615289503029305345","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*XSo97Lc2aAN-7ein.png":{"__typename":"ImageMetadata","id":"0*XSo97Lc2aAN-7ein.png","originalHeight":1024,"originalWidth":988,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_157":{"__typename":"Paragraph","id":"e6189056e39c_157","name":"e1b3","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*XSo97Lc2aAN-7ein.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_158":{"__typename":"Paragraph","id":"e6189056e39c_158","name":"8340","type":"P","href":null,"layout":null,"metadata":null,"text":"After chatting with Benjamin to confirm what I thought the implications were, his response was “Sorry for your head :)”","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*C3HcNhb_HuexXluT.gif":{"__typename":"ImageMetadata","id":"0*C3HcNhb_HuexXluT.gif","originalHeight":360,"originalWidth":480,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_159":{"__typename":"Paragraph","id":"e6189056e39c_159","name":"5cc5","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*C3HcNhb_HuexXluT.gif"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_160":{"__typename":"Paragraph","id":"e6189056e39c_160","name":"96bb","type":"P","href":null,"layout":null,"metadata":null,"text":"This is all thanks to work that Benjamin and Sean Metcalf worked on to make Golden tickets even more “golden”. I blogged about this back in August of 2015 after their work was released in a post titled “The Trustpocalypse.”","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":32,"end":40,"href":"https:\u002F\u002Ftwitter.com\u002Fgentilkiwi","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":45,"end":57,"href":"https:\u002F\u002Ftwitter.com\u002Fpyrotek3","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":203,"end":222,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fthe-trustpocalypse\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_161":{"__typename":"Paragraph","id":"e6189056e39c_161","name":"2b95","type":"P","href":null,"layout":null,"metadata":null,"text":"Previous to this work, our strategy was to map out foreign user\u002Fgroup memberships and hop from child trust up to the forest root “by hand”, often a painstaking process in large environments with lots of domains. As described in the Trust Attack Strategy section, we always interpreted trust as “flowing down” from the forest root to child domains due to the “Enterprise Admins” group. However, Microsoft has stated for years that “the forest is the security boundary for Active Directory“, and an attack against intra-forest domains has been known since (at least) 2005.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":431,"end":487,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc755979(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":533,"end":569,"href":"http:\u002F\u002Fwindowsitpro.com\u002Fwindows-server\u002Fexploiting-sidhistory-ad-attribute","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":232,"end":253,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":431,"end":487,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_162":{"__typename":"Paragraph","id":"e6189056e39c_162","name":"fef9","type":"P","href":null,"layout":null,"metadata":null,"text":"But first, in order for this to make complete sense, I have to explain sidHistory and the SID filtering security mechanism, and what this all means for domains within a forest.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":71,"end":81,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_163":{"__typename":"Paragraph","id":"e6189056e39c_163","name":"d6b9","type":"P","href":null,"layout":null,"metadata":null,"text":"sidHistory was added with Windows 2000 Active Directory, and was meant to facilitate the migration of users from one domain to another. If a user is migrated, their old security identifier (SID), along with the SIDs of any group they were previously a part of, can optionally be added to the sidHistory attribute of their new user account. When the new user attempts to access a resource, “if the SID or the SID history matches, access to the resource is granted or denied, according to the access specified in the ACL.” Meaning, any group\u002Fold user SID that is set in a user’s sidHistory property grants them access as if they were that user or a member of those groups.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":390,"end":519,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc974408(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":0,"end":10,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":390,"end":519,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":616,"end":669,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_164":{"__typename":"Paragraph","id":"e6189056e39c_164","name":"df1e","type":"P","href":null,"layout":null,"metadata":null,"text":"Due to how trusts work within an Active Directory forest, the sidHistory property (“ExtraSids” in the PAC) is respected within the domains of a forest because those SIDs are not filtered out in cross-domain referrals by the “SID Filtering” protection. So any user in a child domain that has their sidHistory\u002FExtraSids set to, say, the “Enterprise Admins” SID (a group that exists only in the forest root) will effectively function as if they are an enterprise administrator. As Microsoft has known this is an issue, and the knowledge has been public since at least this 2005 ITPro Windows article and almost certainly before, sidHistory is a protected attribute that is extremely difficult to modify.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":570,"end":596,"href":"http:\u002F\u002Fwindowsitpro.com\u002Fwindows-server\u002Fexploiting-sidhistory-ad-attribute","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":62,"end":72,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":297,"end":307,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":308,"end":317,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":626,"end":636,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":431,"end":473,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_165":{"__typename":"Paragraph","id":"e6189056e39c_165","name":"65dd","type":"P","href":null,"layout":null,"metadata":null,"text":"Previously, abuse of this involved a pretty complex process, and included modifying the sidHistory in the Active Directory database (ntds.dit) of the associated domain. There’s more detail about exactly why\u002Fhow this works in the Epilogue: SID Filtering section.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":88,"end":98,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":229,"end":252,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_166":{"__typename":"Paragraph","id":"e6189056e39c_166","name":"9cf4","type":"P","href":null,"layout":null,"metadata":null,"text":"THIS IS WHY THE FOREST IS THE “TRUST BOUNDARY” IN ACTIVE DIRECTORY, NOT THE DOMAIN!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":0,"end":83,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_167":{"__typename":"Paragraph","id":"e6189056e39c_167","name":"1aad","type":"P","href":null,"layout":null,"metadata":null,"text":"Benjamin and Sean realized that with the introduction of Mimikatz’ Golden Tickets, an attacker could set the ExtraSids section of the KERB_VALIDATION_INFO structure created for the ticket (the structure that “defines the user’s logon and authorization information provided by the DC“). The ExtraSids section is described as “A pointer to a list of KERB_SID_AND_ATTRIBUTES structures that contain a list of SIDs corresponding to groups in domains other than the account domain to which the principal belongs” (the KERB_SID_AND_ATTRIBUTES structure is defined here.)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":134,"end":154,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237948.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":209,"end":282,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237948.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":325,"end":506,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237948.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":547,"end":562,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237947.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":109,"end":118,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":290,"end":300,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":209,"end":282,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":325,"end":506,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_168":{"__typename":"Paragraph","id":"e6189056e39c_168","name":"524c","type":"P","href":null,"layout":null,"metadata":null,"text":"This means that if an attacker compromises “Domain Administrator” rights (or equivalent, actually just any account that can DCSync ;) in ANY child domain in the forest for just 5 minutes, the krbtgt hash of the child domain can be retrieved, and \u002Fsids:\u003Csid_of_enterprise_admins_in_forest_root\u003E can be added to the Mimikatz constructed ticket without modifying the Active Directory database. This gives the attacker the ability to “hop up” the forest trust relationship and compromise the forest root domain.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":246,"end":293,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_169":{"__typename":"Paragraph","id":"e6189056e39c_169","name":"542a","type":"P","href":null,"layout":null,"metadata":null,"text":"If this is your first time hearing about this technique, as Benjamin said, “Sorry for your head. :)”","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_170":{"__typename":"Paragraph","id":"e6189056e39c_170","name":"4049","type":"P","href":null,"layout":null,"metadata":null,"text":"For our operational attack strategy, this means that if we are currently in a child domain and can compromise DCSync\u002FDA access, or if we can compromise this level of access in any child domain along our attack chain, we can forgo the burdensome foreign relationship enumeration to hop up the trust to instantly compromise the forest root. We have done this in the field, and yes, it is awesome. :) For operational advice\u002Fguidance, check out my previous Trustpocalypse post from 2015.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":444,"end":482,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fthe-trustpocalypse\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_171":{"__typename":"Paragraph","id":"e6189056e39c_171","name":"506c","type":"P","href":null,"layout":null,"metadata":null,"text":"This will only work for hopping between trusts within a forest. This will not work for external or inter-forest trusts due to SID filtering, described in more detail in the Epilogue: SID Filtering section at the end of the post.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":47,"end":53,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":54,"end":62,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":173,"end":196,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":47,"end":53,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":54,"end":62,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_172":{"__typename":"Paragraph","id":"e6189056e39c_172","name":"c797","type":"H4","href":null,"layout":null,"metadata":null,"text":"A Case Study","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_173":{"__typename":"Paragraph","id":"e6189056e39c_173","name":"9294","type":"P","href":null,"layout":null,"metadata":null,"text":"So, consider again the sample trust diagram:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*_PmouZePAJKPiop6.png":{"__typename":"ImageMetadata","id":"0*_PmouZePAJKPiop6.png","originalHeight":264,"originalWidth":342,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_174":{"__typename":"Paragraph","id":"e6189056e39c_174","name":"8dcc","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*_PmouZePAJKPiop6.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_175":{"__typename":"Paragraph","id":"e6189056e39c_175","name":"42e8","type":"P","href":null,"layout":null,"metadata":null,"text":"Say we land an account in external.local. Since sub.dev.testlab.local trusts external.local, external.local can query information from sub.dev.testlab.local, while SUB cannot do the same to EXTERNAL. From the external context, we can query the trusts that SUB has:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":26,"end":40,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":48,"end":69,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":77,"end":91,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":93,"end":107,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":135,"end":156,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":70,"end":76,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*W3lptHy7oCOLuvLc.png":{"__typename":"ImageMetadata","id":"0*W3lptHy7oCOLuvLc.png","originalHeight":715,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_176":{"__typename":"Paragraph","id":"e6189056e39c_176","name":"0c0c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*W3lptHy7oCOLuvLc.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_177":{"__typename":"Paragraph","id":"e6189056e39c_177","name":"fe2a","type":"P","href":null,"layout":null,"metadata":null,"text":"But this only returns the direct trusts that sub.dev.testlab has with other domains (dev.testlab.local and external.local). If we can query the global catalog (not always possible) from sub.dev.testlab and return all domain trusts in the entire forest!","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":45,"end":60,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":85,"end":102,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":107,"end":121,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":186,"end":201,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*JsIZ5kPX6tydX3k-.png":{"__typename":"ImageMetadata","id":"0*JsIZ5kPX6tydX3k-.png","originalHeight":720,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_178":{"__typename":"Paragraph","id":"e6189056e39c_178","name":"d6ac","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*JsIZ5kPX6tydX3k-.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_179":{"__typename":"Paragraph","id":"e6189056e39c_179","name":"71a5","type":"P","href":null,"layout":null,"metadata":null,"text":"Note that because since this is a one-way, non-transitive external trust into sub.dev.testlab.local, we can’t query the trusts that contoso.local has from the EXTERNAL context, as our Kerberos traffic will not be properly referred. This is what this error usually means, in case you run across it:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":78,"end":99,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":132,"end":145,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*3AooS_5rbYv6Ml3R.png":{"__typename":"ImageMetadata","id":"0*3AooS_5rbYv6Ml3R.png","originalHeight":196,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_180":{"__typename":"Paragraph","id":"e6189056e39c_180","name":"ae74","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*3AooS_5rbYv6Ml3R.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_181":{"__typename":"Paragraph","id":"e6189056e39c_181","name":"ce44","type":"P","href":null,"layout":null,"metadata":null,"text":"So, from here we would then run Get-DomainForeignGroupMember -Domain sub.dev.testlab.local to see if any groups in SUB contained members in EXTERNAL:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":32,"end":90,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*6Yzplo7M3BX5jb7o.png":{"__typename":"ImageMetadata","id":"0*6Yzplo7M3BX5jb7o.png","originalHeight":693,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_182":{"__typename":"Paragraph","id":"e6189056e39c_182","name":"130c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*6Yzplo7M3BX5jb7o.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_183":{"__typename":"Paragraph","id":"e6189056e39c_183","name":"8e62","type":"P","href":null,"layout":null,"metadata":null,"text":"From there, we would attempt targeted account compromise to hop the trust into sub.dev.testlab.local. The Get-DomainForeignUser command would be of no use here, due to the caveats about linked-value replication and trusted described in the Foreign Relationship Enumeration section.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":79,"end":100,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":106,"end":127,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":240,"end":273,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_184":{"__typename":"Paragraph","id":"e6189056e39c_184","name":"83d0","type":"P","href":null,"layout":null,"metadata":null,"text":"However, because external.local -\u003E sub.dev.testlab.local is an external trust relationships, it is implicitly non-transitive, so couldn’t query the domain local group memberships of dev.testlab.local or testlab.local.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":17,"end":56,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":182,"end":199,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":203,"end":216,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_185":{"__typename":"Paragraph","id":"e6189056e39c_185","name":"e74a","type":"P","href":null,"layout":null,"metadata":null,"text":"If we were then able to compromise domain admin (or equivalent) credentials in sub.dev.testlab.local, we could build a sidHistory-trust-hopping Golden Ticket as described in the “Trustpocalypse” section to compromise the testlab.local forest root domain. If we weren’t able to procure elevated access, we would run Get-DomainForeignUser to see if any users from sub.dev.testlab.local had access into other groups in the forest. Again, remember the previous information about scoping- only universal group memberships will be reflected here:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":79,"end":100,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":179,"end":193,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":221,"end":234,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":315,"end":336,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":362,"end":383,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":489,"end":498,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*ftX5ak4zlLyhHCz6.png":{"__typename":"ImageMetadata","id":"0*ftX5ak4zlLyhHCz6.png","originalHeight":269,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_186":{"__typename":"Paragraph","id":"e6189056e39c_186","name":"a1d6","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*ftX5ak4zlLyhHCz6.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_187":{"__typename":"Paragraph","id":"e6189056e39c_187","name":"715d","type":"P","href":null,"layout":null,"metadata":null,"text":"We would also run Get-DomainForeignGroupMember -Domain dev.testlab.local and Get-DomainForeignGroupMember -Domain testlab.local to see that groups in those other forest domains had “incoming” access:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":18,"end":72,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":77,"end":127,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*0Lc9PmsPq0G9hbU1.png":{"__typename":"ImageMetadata","id":"0*0Lc9PmsPq0G9hbU1.png","originalHeight":452,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_188":{"__typename":"Paragraph","id":"e6189056e39c_188","name":"2fa9","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*0Lc9PmsPq0G9hbU1.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*jrtBMujzejCPor7F.png":{"__typename":"ImageMetadata","id":"0*jrtBMujzejCPor7F.png","originalHeight":403,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_189":{"__typename":"Paragraph","id":"e6189056e39c_189","name":"c9af","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*jrtBMujzejCPor7F.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_190":{"__typename":"Paragraph","id":"e6189056e39c_190","name":"41ec","type":"P","href":null,"layout":null,"metadata":null,"text":"Once\u002Fif we were able to compromise part or all of the testlab.local forest root through either of the previous approaches, we would then run Get-DomainForeignGroupMember -Domain contoso.local and Get-DomainForeignGroupMember -Domain prod.contoso.local to see if there were any users in the TESTLAB forest that had foreign group membership in the CONTOSO forest.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":54,"end":67,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":141,"end":191,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":196,"end":251,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*9IrkH8BX2jZmSx9g.png":{"__typename":"ImageMetadata","id":"0*9IrkH8BX2jZmSx9g.png","originalHeight":456,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_191":{"__typename":"Paragraph","id":"e6189056e39c_191","name":"9013","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*9IrkH8BX2jZmSx9g.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_192":{"__typename":"Paragraph","id":"e6189056e39c_192","name":"48cf","type":"P","href":null,"layout":null,"metadata":null,"text":"Along the way, we would could run Get-NetLocalGroupMember \u003Cforeign,server\u003E against a targeted selection of servers (including DCs) to see if any users crossed the boundary that way via machine local groups. We could also use targeted Get-DomainObjectACL -Domain \u003Cforeign.domain\u003E with various filters to check for foreign ACL memberships.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":34,"end":74,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":234,"end":278,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_193":{"__typename":"Paragraph","id":"e6189056e39c_193","name":"6016","type":"P","href":null,"layout":null,"metadata":null,"text":"Or we could just pull everything with BloodHound, and rely on the schema to model the cross-forest hops. :)","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_194":{"__typename":"Paragraph","id":"e6189056e39c_194","name":"7881","type":"H4","href":null,"layout":null,"metadata":null,"text":"Sidenote: Forging Inter-Realm Trust Tickets","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_195":{"__typename":"Paragraph","id":"e6189056e39c_195","name":"a276","type":"P","href":null,"layout":null,"metadata":null,"text":"It is possible to forge inter-realm trust tickets to exploit trust relationships. As Sean covered this extremely well in his “It’s All About Trust” post, I’ll refer you to his documentation for more operational details, and will just cover the implications of this technique and how it fits into our trust attack strategy.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":85,"end":89,"href":"https:\u002F\u002Ftwitter.com\u002Fpyrotek3","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":126,"end":146,"href":"https:\u002F\u002Fadsecurity.org\u002F?p=1588","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_196":{"__typename":"Paragraph","id":"e6189056e39c_196","name":"9588","type":"P","href":null,"layout":null,"metadata":null,"text":"Recall the explanation of how Kerberos works across trusts:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*nOLyXQCdL7VLOxeW.png":{"__typename":"ImageMetadata","id":"0*nOLyXQCdL7VLOxeW.png","originalHeight":662,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_197":{"__typename":"Paragraph","id":"e6189056e39c_197","name":"1b8e","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*nOLyXQCdL7VLOxeW.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_198":{"__typename":"Paragraph","id":"e6189056e39c_198","name":"e576","type":"P","href":null,"layout":null,"metadata":null,"text":"So when the user presents this inter-realm ticket-granting-ticket referral to the foreign domain, again signed by the inter-realm trust key, the user’s TGT is included within it. And again, because the foreign domain trusts the domain that that issued the referral ticket, the foreign domain trusts the user’s TGT and all its included information to be accurate.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_199":{"__typename":"Paragraph","id":"e6189056e39c_199","name":"6be5","type":"P","href":null,"layout":null,"metadata":null,"text":"Again, in English, when the foreign domain decrypts the referral ticket with the negotiated trust key, it sees the user’s TGT and says “OK, the other domain already authenticated this user and said this is who they say they are\u002Fthese are the groups the user is in, so I’ll trust this is accurate because I trust this domain.”","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"EM","start":136,"end":324,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_200":{"__typename":"Paragraph","id":"e6189056e39c_200","name":"baa5","type":"P","href":null,"layout":null,"metadata":null,"text":"So, if we can retrieve the hash of the inter-realm trust key, a referral ticket can be forged (as Sean describes) that allows us to pretend to be any user from the first domain when requesting access to the second domain. This hash retrieval can be done through normal password dumping or through DCSync, by querying the FOREIGN_DOMAIN_SHORTNAME$ account:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":95,"end":112,"href":"https:\u002F\u002Fadsecurity.org\u002F?p=1588","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":321,"end":346,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*t1apIzahwUxnToOf.png":{"__typename":"ImageMetadata","id":"0*t1apIzahwUxnToOf.png","originalHeight":573,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_201":{"__typename":"Paragraph","id":"e6189056e39c_201","name":"0141","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*t1apIzahwUxnToOf.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_202":{"__typename":"Paragraph","id":"e6189056e39c_202","name":"d074","type":"P","href":null,"layout":null,"metadata":null,"text":"However, if we can retrieve the inter-realm trust key, then in pretty much all cases we can pull the krbtgt hash of the referring domain. If we have this, we can construct a ticket for user referring domain, pretending to be any user we want to the foreign domain. This is why I haven’t had a need to forge inter-realm trust referrals in the field, but there is one specific instance where it gets interesting.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_203":{"__typename":"Paragraph","id":"e6189056e39c_203","name":"5738","type":"P","href":null,"layout":null,"metadata":null,"text":"Back in 2015, after everyone started to fully realize the implications of Golden Tickets, Microsoft released scripts that allow organizations to change the password of the krbtgt account. In order for this to be effective for a single-domain forest, the password has to be changed twice. Now, because of the implementation of the sidHistory-hopping attack, the password for the krbtgt account in EVERY domain in the forest, twice.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":90,"end":116,"href":"https:\u002F\u002Fcloudblogs.microsoft.com\u002Fmicrosoftsecure\u002F2015\u002F02\u002F11\u002Fkrbtgt-account-password-reset-scripts-now-available-for-customers\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_204":{"__typename":"Paragraph","id":"e6189056e39c_204","name":"7d3b","type":"P","href":null,"layout":null,"metadata":null,"text":"Say an organization does this, and rotates the passwords for every elevated account in every domain in the forest, are they safe? Well, while inter-realm trust keys automatically rotate every 30 days according to section 6.1.6.9.6.1 of the Active Directory Technical Specification, they aren’t rotated when the krbtgt account changes. So if an attacker has the inter-realm keys in their possession, they can still use the sidHistory approach to hop up a trust, as Sean details. Then again, there’s a million and one other ways to backdoor Active Directory. ¯\\_(ツ)_\u002F¯","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":221,"end":280,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc223791.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":461,"end":476,"href":"https:\u002F\u002Fadsecurity.org\u002F?p=1588","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":500,"end":507,"href":"https:\u002F\u002Fadsecurity.org\u002F?p=1929","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":530,"end":555,"href":"https:\u002F\u002Fspecterops.io\u002Fassets\u002Fresources\u002Fan_ace_up_the_sleeve.pdf","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":61,"end":66,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":87,"end":92,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_205":{"__typename":"Paragraph","id":"e6189056e39c_205","name":"eb2b","type":"P","href":null,"layout":null,"metadata":null,"text":"So there’s only one solution if you want to be sure (thanks @gentilkiwi :)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":60,"end":71,"href":"https:\u002F\u002Ftwitter.com\u002Fgentilkiwi","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*-QdcD2RuB5s8HwM6.png":{"__typename":"ImageMetadata","id":"0*-QdcD2RuB5s8HwM6.png","originalHeight":700,"originalWidth":600,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_206":{"__typename":"Paragraph","id":"e6189056e39c_206","name":"65d9","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*-QdcD2RuB5s8HwM6.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_207":{"__typename":"Paragraph","id":"e6189056e39c_207","name":"6f66","type":"H4","href":null,"layout":null,"metadata":null,"text":"Another Sidenote: Kerberoasting Across Domain Trusts","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_208":{"__typename":"Paragraph","id":"e6189056e39c_208","name":"7904","type":"P","href":null,"layout":null,"metadata":null,"text":"We love Kerberoasting. Introduced by Tim Medin in 2014, we ‘roast on a ton of our engagements. And if we have a domain that trusts us, we can roast across these trust boundaries, with one minor tweak in some situations.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":0,"end":2,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Factivedirectory\u002Ftargeted-kerberoasting\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":8,"end":21,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fpowershell\u002Fkerberoasting-without-mimikatz\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":37,"end":54,"href":"https:\u002F\u002Ffiles.sans.org\u002Fsummit\u002Fhackfest2014\u002FPDFs\u002FKicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1).pdf","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_209":{"__typename":"Paragraph","id":"e6189056e39c_209","name":"05aa","type":"P","href":null,"layout":null,"metadata":null,"text":"When using .NET’s System.IdentityModel.Tokens.KerberosRequestorSecurityToken class (and then its .GetRequest() method), we specify a service principal name (SPN) to request a TGS-REP for, and subsequently use the GetRequest() to retrieve the bytes for the AP-REQ that’s intended to be sent to the target service. This AP-REQ contains the service ticket that we then extract and use for offline Kerberoasting\u002Fpassword cracking.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":18,"end":76,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.identitymodel.tokens.kerberosrequestorsecuritytoken(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":97,"end":110,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.identitymodel.tokens.kerberosrequestorsecuritytoken.getrequest(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":213,"end":225,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.identitymodel.tokens.kerberosrequestorsecuritytoken.getrequest(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_210":{"__typename":"Paragraph","id":"e6189056e39c_210","name":"80b1","type":"P","href":null,"layout":null,"metadata":null,"text":"The documentation for the KerberosRequestorSecurityToken.ServicePrincipalName nicely describes the format as “host\u002F\u003Chostname\u003E@\u003Cdomain\u003E or \u003Chostname\u003E, where hostname is the name of the computer hosting the target Web service and domain is the fully-qualified domain name of the Kerberos realm in which the host computer resides.” So if you have any issues with Kerberoasting across trusts (particularly external and forest trusts), try using the SERVICE\u002Fhost.domain.com@domain.com format and you may have more success. This is possible with PowerView’s Get-DomainSPNTicket, the function that Invoke-Kerberoast is built on.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":26,"end":77,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.identitymodel.tokens.kerberosrequestorsecuritytoken.serviceprincipalname(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":110,"end":327,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fsystem.identitymodel.tokens.kerberosrequestorsecuritytoken.serviceprincipalname(v=vs.110).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":125,"end":134,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":445,"end":479,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":552,"end":571,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":591,"end":608,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":110,"end":327,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_211":{"__typename":"Paragraph","id":"e6189056e39c_211","name":"3381","type":"H4","href":null,"layout":null,"metadata":null,"text":"Epilogue: SID Filtering","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_212":{"__typename":"Paragraph","id":"e6189056e39c_212","name":"71ea","type":"P","href":null,"layout":null,"metadata":null,"text":"So we previously talked about how\u002Fwhy the forest is the trust boundary in Active Directory, not the domain. A big part of this is the security protection I’ve alluded to several times previously called SID Filtering. The best reference for SID filtering is the [MS-PAC] “Privilege Attribute Certificate Data Structure” documentation, specifically section 4.1.2.2 “SID Filtering and Claims Transformation.” I will do my best to explain a few salient points.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":271,"end":317,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237917.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":355,"end":405,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237940.aspx","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_213":{"__typename":"Paragraph","id":"e6189056e39c_213","name":"d5bd","type":"P","href":null,"layout":null,"metadata":null,"text":"When a user’s TGT is presented to the new domain through a referral, that TGT contains a privileged attribute certificate (PAC) that contains, among other things, the user’s security identifier (SID), the security identifiers of groups they are in, and anything present in the previously discussed sidHistory field (i.e. the ExtraSids PAC part described in the Trustpocalypse section). This security identification information in the PAC is parsed and analyzed by a trusting domain, and various filters are executed depending on the type of the trust.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"STRONG","start":325,"end":334,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"STRONG","start":361,"end":375,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":466,"end":474,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_214":{"__typename":"Paragraph","id":"e6189056e39c_214","name":"3955","type":"P","href":null,"layout":null,"metadata":null,"text":"SIDs matching particular patterns are rejected by the trusting domain under various circumstances, as a security protection. SID filtering is meant to stop malicious users with elevated credentials in a trusted domain\u002Fforest from taking control of a trusting domain\u002Fforest. This is also described in Microsoft’s “Security Considerations for Trusts” documentation.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":313,"end":347,"href":"https:\u002F\u002Ftechnet.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc755321(v=ws.10).aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":203,"end":210,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":250,"end":258,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_215":{"__typename":"Paragraph","id":"e6189056e39c_215","name":"753c","type":"P","href":null,"layout":null,"metadata":null,"text":"There is a set of SIDs that are set to ‘AlwaysFilter’, meaning they are always filtered out by a trusting domain, no matter the trust type. The main SID we’re interested in, “Enterprise Admins” (S-1–5–21-\u003CDomain\u003E-519), the one that allows us to execute the sidHistory-hopping attack, is set to “ForestSpecific” for filtering. As Microsoft describes, “The ForestSpecific rule is for those SIDs that are never allowed in a PAC that originates from out of the forest or from a domain that has been marked as QuarantinedWithinForest, unless it belongs to that domain.” Again, this explains why the forest is the trust boundary, not the domain, as this elevated SID (along with many others) can not be passed across a trust boundary except if the target domain is within the same forest.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":351,"end":563,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237940.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":351,"end":563,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_216":{"__typename":"Paragraph","id":"e6189056e39c_216","name":"99c8","type":"P","href":null,"layout":null,"metadata":null,"text":"QuarantinedWithinForest, huh? It so happens that domains within a forest can be set as “quarantined”, which implements a version SID filtering for the domain, even though it is within the forest. However, as the documentation states, “The only SIDs that are allowed to be passed from such a domain are the “Enterprise Domain Controllers” (S-1–5–9) SID and those described by the trusted domain object (TDO).” So, since the “Enterprise Domain Controllers” SID is NOT filtered out for intra-forest quarantined domains, there is still a way to “hop up” the forest trust chain and compromise the forest root:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":235,"end":407,"href":"https:\u002F\u002Fmsdn.microsoft.com\u002Fen-us\u002Flibrary\u002Fcc237940.aspx","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":57,"end":63,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":235,"end":407,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:0*GkDz2Wj2tCRFvZgH.png":{"__typename":"ImageMetadata","id":"0*GkDz2Wj2tCRFvZgH.png","originalHeight":787,"originalWidth":1024,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:e6189056e39c_217":{"__typename":"Paragraph","id":"e6189056e39c_217","name":"e61d","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:0*GkDz2Wj2tCRFvZgH.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_218":{"__typename":"Paragraph","id":"e6189056e39c_218","name":"9ff1","type":"P","href":null,"layout":null,"metadata":null,"text":"This is something I attempted to explain a few years ago without properly understanding the problem, but it makes a bit more sense now after reading heaps of Microsoft documentation :)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":18,"end":40,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fmimikatz-and-dcsync-and-extrasids-oh-my\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_219":{"__typename":"Paragraph","id":"e6189056e39c_219","name":"2ba1","type":"H4","href":null,"layout":null,"metadata":null,"text":"Wrapup","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_220":{"__typename":"Paragraph","id":"e6189056e39c_220","name":"c2ce","type":"P","href":null,"layout":null,"metadata":null,"text":"Trusts are not a simple topic. Most pentesters (and many sysadmins!) do not properly understand trusts and the risk exposed by various trust misconfigurations. Unfortunately for us, some bad guys do, and trusts have been abused since nearly the beginning of Active Directory to exploit access in one domain in order to pivot into another.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_221":{"__typename":"Paragraph","id":"e6189056e39c_221","name":"6cca","type":"P","href":null,"layout":null,"metadata":null,"text":"If your domain trust architecture is setup incorrectly, then what’s the answer? Unfortunately, as with many major architectural flaws of this nature, there is not a simple fix. Rearchitecting a major Active Directory deployment can be a long, expensive, and painful process, but there is still a guiding light: the Enhanced Security Administrative Environment (ESAE), commonly referred to as “Red Forest”, which is a secured Active Directory architecture that mitigates an enormous number of Active Directory vulnerabilities\u002Fmisconfigurations. While Microsoft has published aspects of the architecture, the only way that I currently know how have an ESAE\u002FRed Forest is to pay Microsoft to implement it for you. ¯\\_(ツ)_\u002F¯","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":315,"end":359,"href":"https:\u002F\u002Fdocs.microsoft.com\u002Fen-us\u002Fwindows-server\u002Fidentity\u002Fsecuring-privileged-access\u002Fsecuring-privileged-access-reference-material#ESAE_BM","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":564,"end":601,"href":"https:\u002F\u002Fdocs.microsoft.com\u002Fen-us\u002Fwindows-server\u002Fidentity\u002Fsecuring-privileged-access\u002Fsecuring-privileged-access-reference-material#ESAE_BM","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_222":{"__typename":"Paragraph","id":"e6189056e39c_222","name":"4876","type":"P","href":null,"layout":null,"metadata":null,"text":"I would love to eventually publish guidance on how organizations implement a “red-forest-esque” environment, that while not “officially” compliant with the reference architecture, would still be better than many organization’s current implementations. If anyone has documentation or guidance on how to do practically do this, please contact me (@harmj0y or will [at] harmj0y.net) and I will happily get that kind of information out there.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":345,"end":353,"href":"https:\u002F\u002Ftwitter.com\u002Fharmj0y\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:e6189056e39c_223":{"__typename":"Paragraph","id":"e6189056e39c_223","name":"3dc4","type":"P","href":null,"layout":null,"metadata":null,"text":"Originally published at harmj0y.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":24,"end":31,"href":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fa-guide-to-attacking-domain-trusts\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"EM","start":0,"end":34,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"CollectionViewerEdge:collectionId:f05f8696e3cc-viewerId:lo_57ff73e9b7e1":{"__typename":"CollectionViewerEdge","id":"collectionId:f05f8696e3cc-viewerId:lo_57ff73e9b7e1","isEditor":false,"isMuting":false},"ImageMetadata:1*s-5BWBr8XsgtIU5azKNhZQ.jpeg":{"__typename":"ImageMetadata","id":"1*s-5BWBr8XsgtIU5azKNhZQ.jpeg","originalWidth":2000,"originalHeight":805},"PostViewerEdge:postId:971e52cb2944-viewerId:lo_57ff73e9b7e1":{"__typename":"PostViewerEdge","shouldIndexPostForExternalSearch":true,"id":"postId:971e52cb2944-viewerId:lo_57ff73e9b7e1"},"Tag:domain-trusts":{"__typename":"Tag","id":"domain-trusts","displayTitle":"Domain Trusts","normalizedTagSlug":"domain-trusts"},"Tag:powerview":{"__typename":"Tag","id":"powerview","displayTitle":"Powerview","normalizedTagSlug":"powerview"},"Tag:active-directory":{"__typename":"Tag","id":"active-directory","displayTitle":"Active Directory","normalizedTagSlug":"active-directory"},"Post:971e52cb2944":{"__typename":"Post","id":"971e52cb2944","collection":{"__ref":"Collection:f05f8696e3cc"},"content({\"postMeteringOptions\":{}})":{"__typename":"PostContent","isLockedPreviewOnly":false,"bodyModel":{"__typename":"RichText","sections":[{"__typename":"Section","name":"b810","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null},{"__typename":"Section","name":"464e","startIndex":223,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}],"paragraphs":[{"__ref":"Paragraph:e6189056e39c_0"},{"__ref":"Paragraph:e6189056e39c_1"},{"__ref":"Paragraph:e6189056e39c_2"},{"__ref":"Paragraph:e6189056e39c_3"},{"__ref":"Paragraph:e6189056e39c_4"},{"__ref":"Paragraph:e6189056e39c_5"},{"__ref":"Paragraph:e6189056e39c_6"},{"__ref":"Paragraph:e6189056e39c_7"},{"__ref":"Paragraph:e6189056e39c_8"},{"__ref":"Paragraph:e6189056e39c_9"},{"__ref":"Paragraph:e6189056e39c_10"},{"__ref":"Paragraph:e6189056e39c_11"},{"__ref":"Paragraph:e6189056e39c_12"},{"__ref":"Paragraph:e6189056e39c_13"},{"__ref":"Paragraph:e6189056e39c_14"},{"__ref":"Paragraph:e6189056e39c_15"},{"__ref":"Paragraph:e6189056e39c_16"},{"__ref":"Paragraph:e6189056e39c_17"},{"__ref":"Paragraph:e6189056e39c_18"},{"__ref":"Paragraph:e6189056e39c_19"},{"__ref":"Paragraph:e6189056e39c_20"},{"__ref":"Paragraph:e6189056e39c_21"},{"__ref":"Paragraph:e6189056e39c_22"},{"__ref":"Paragraph:e6189056e39c_23"},{"__ref":"Paragraph:e6189056e39c_24"},{"__ref":"Paragraph:e6189056e39c_25"},{"__ref":"Paragraph:e6189056e39c_26"},{"__ref":"Paragraph:e6189056e39c_27"},{"__ref":"Paragraph:e6189056e39c_28"},{"__ref":"Paragraph:e6189056e39c_29"},{"__ref":"Paragraph:e6189056e39c_30"},{"__ref":"Paragraph:e6189056e39c_31"},{"__ref":"Paragraph:e6189056e39c_32"},{"__ref":"Paragraph:e6189056e39c_33"},{"__ref":"Paragraph:e6189056e39c_34"},{"__ref":"Paragraph:e6189056e39c_35"},{"__ref":"Paragraph:e6189056e39c_36"},{"__ref":"Paragraph:e6189056e39c_37"},{"__ref":"Paragraph:e6189056e39c_38"},{"__ref":"Paragraph:e6189056e39c_39"},{"__ref":"Paragraph:e6189056e39c_40"},{"__ref":"Paragraph:e6189056e39c_41"},{"__ref":"Paragraph:e6189056e39c_42"},{"__ref":"Paragraph:e6189056e39c_43"},{"__ref":"Paragraph:e6189056e39c_44"},{"__ref":"Paragraph:e6189056e39c_45"},{"__ref":"Paragraph:e6189056e39c_46"},{"__ref":"Paragraph:e6189056e39c_47"},{"__ref":"Paragraph:e6189056e39c_48"},{"__ref":"Paragraph:e6189056e39c_49"},{"__ref":"Paragraph:e6189056e39c_50"},{"__ref":"Paragraph:e6189056e39c_51"},{"__ref":"Paragraph:e6189056e39c_52"},{"__ref":"Paragraph:e6189056e39c_53"},{"__ref":"Paragraph:e6189056e39c_54"},{"__ref":"Paragraph:e6189056e39c_55"},{"__ref":"Paragraph:e6189056e39c_56"},{"__ref":"Paragraph:e6189056e39c_57"},{"__ref":"Paragraph:e6189056e39c_58"},{"__ref":"Paragraph:e6189056e39c_59"},{"__ref":"Paragraph:e6189056e39c_60"},{"__ref":"Paragraph:e6189056e39c_61"},{"__ref":"Paragraph:e6189056e39c_62"},{"__ref":"Paragraph:e6189056e39c_63"},{"__ref":"Paragraph:e6189056e39c_64"},{"__ref":"Paragraph:e6189056e39c_65"},{"__ref":"Paragraph:e6189056e39c_66"},{"__ref":"Paragraph:e6189056e39c_67"},{"__ref":"Paragraph:e6189056e39c_68"},{"__ref":"Paragraph:e6189056e39c_69"},{"__ref":"Paragraph:e6189056e39c_70"},{"__ref":"Paragraph:e6189056e39c_71"},{"__ref":"Paragraph:e6189056e39c_72"},{"__ref":"Paragraph:e6189056e39c_73"},{"__ref":"Paragraph:e6189056e39c_74"},{"__ref":"Paragraph:e6189056e39c_75"},{"__ref":"Paragraph:e6189056e39c_76"},{"__ref":"Paragraph:e6189056e39c_77"},{"__ref":"Paragraph:e6189056e39c_78"},{"__ref":"Paragraph:e6189056e39c_79"},{"__ref":"Paragraph:e6189056e39c_80"},{"__ref":"Paragraph:e6189056e39c_81"},{"__ref":"Paragraph:e6189056e39c_82"},{"__ref":"Paragraph:e6189056e39c_83"},{"__ref":"Paragraph:e6189056e39c_84"},{"__ref":"Paragraph:e6189056e39c_85"},{"__ref":"Paragraph:e6189056e39c_86"},{"__ref":"Paragraph:e6189056e39c_87"},{"__ref":"Paragraph:e6189056e39c_88"},{"__ref":"Paragraph:e6189056e39c_89"},{"__ref":"Paragraph:e6189056e39c_90"},{"__ref":"Paragraph:e6189056e39c_91"},{"__ref":"Paragraph:e6189056e39c_92"},{"__ref":"Paragraph:e6189056e39c_93"},{"__ref":"Paragraph:e6189056e39c_94"},{"__ref":"Paragraph:e6189056e39c_95"},{"__ref":"Paragraph:e6189056e39c_96"},{"__ref":"Paragraph:e6189056e39c_97"},{"__ref":"Paragraph:e6189056e39c_98"},{"__ref":"Paragraph:e6189056e39c_99"},{"__ref":"Paragraph:e6189056e39c_100"},{"__ref":"Paragraph:e6189056e39c_101"},{"__ref":"Paragraph:e6189056e39c_102"},{"__ref":"Paragraph:e6189056e39c_103"},{"__ref":"Paragraph:e6189056e39c_104"},{"__ref":"Paragraph:e6189056e39c_105"},{"__ref":"Paragraph:e6189056e39c_106"},{"__ref":"Paragraph:e6189056e39c_107"},{"__ref":"Paragraph:e6189056e39c_108"},{"__ref":"Paragraph:e6189056e39c_109"},{"__ref":"Paragraph:e6189056e39c_110"},{"__ref":"Paragraph:e6189056e39c_111"},{"__ref":"Paragraph:e6189056e39c_112"},{"__ref":"Paragraph:e6189056e39c_113"},{"__ref":"Paragraph:e6189056e39c_114"},{"__ref":"Paragraph:e6189056e39c_115"},{"__ref":"Paragraph:e6189056e39c_116"},{"__ref":"Paragraph:e6189056e39c_117"},{"__ref":"Paragraph:e6189056e39c_118"},{"__ref":"Paragraph:e6189056e39c_119"},{"__ref":"Paragraph:e6189056e39c_120"},{"__ref":"Paragraph:e6189056e39c_121"},{"__ref":"Paragraph:e6189056e39c_122"},{"__ref":"Paragraph:e6189056e39c_123"},{"__ref":"Paragraph:e6189056e39c_124"},{"__ref":"Paragraph:e6189056e39c_125"},{"__ref":"Paragraph:e6189056e39c_126"},{"__ref":"Paragraph:e6189056e39c_127"},{"__ref":"Paragraph:e6189056e39c_128"},{"__ref":"Paragraph:e6189056e39c_129"},{"__ref":"Paragraph:e6189056e39c_130"},{"__ref":"Paragraph:e6189056e39c_131"},{"__ref":"Paragraph:e6189056e39c_132"},{"__ref":"Paragraph:e6189056e39c_133"},{"__ref":"Paragraph:e6189056e39c_134"},{"__ref":"Paragraph:e6189056e39c_135"},{"__ref":"Paragraph:e6189056e39c_136"},{"__ref":"Paragraph:e6189056e39c_137"},{"__ref":"Paragraph:e6189056e39c_138"},{"__ref":"Paragraph:e6189056e39c_139"},{"__ref":"Paragraph:e6189056e39c_140"},{"__ref":"Paragraph:e6189056e39c_141"},{"__ref":"Paragraph:e6189056e39c_142"},{"__ref":"Paragraph:e6189056e39c_143"},{"__ref":"Paragraph:e6189056e39c_144"},{"__ref":"Paragraph:e6189056e39c_145"},{"__ref":"Paragraph:e6189056e39c_146"},{"__ref":"Paragraph:e6189056e39c_147"},{"__ref":"Paragraph:e6189056e39c_148"},{"__ref":"Paragraph:e6189056e39c_149"},{"__ref":"Paragraph:e6189056e39c_150"},{"__ref":"Paragraph:e6189056e39c_151"},{"__ref":"Paragraph:e6189056e39c_152"},{"__ref":"Paragraph:e6189056e39c_153"},{"__ref":"Paragraph:e6189056e39c_154"},{"__ref":"Paragraph:e6189056e39c_155"},{"__ref":"Paragraph:e6189056e39c_156"},{"__ref":"Paragraph:e6189056e39c_157"},{"__ref":"Paragraph:e6189056e39c_158"},{"__ref":"Paragraph:e6189056e39c_159"},{"__ref":"Paragraph:e6189056e39c_160"},{"__ref":"Paragraph:e6189056e39c_161"},{"__ref":"Paragraph:e6189056e39c_162"},{"__ref":"Paragraph:e6189056e39c_163"},{"__ref":"Paragraph:e6189056e39c_164"},{"__ref":"Paragraph:e6189056e39c_165"},{"__ref":"Paragraph:e6189056e39c_166"},{"__ref":"Paragraph:e6189056e39c_167"},{"__ref":"Paragraph:e6189056e39c_168"},{"__ref":"Paragraph:e6189056e39c_169"},{"__ref":"Paragraph:e6189056e39c_170"},{"__ref":"Paragraph:e6189056e39c_171"},{"__ref":"Paragraph:e6189056e39c_172"},{"__ref":"Paragraph:e6189056e39c_173"},{"__ref":"Paragraph:e6189056e39c_174"},{"__ref":"Paragraph:e6189056e39c_175"},{"__ref":"Paragraph:e6189056e39c_176"},{"__ref":"Paragraph:e6189056e39c_177"},{"__ref":"Paragraph:e6189056e39c_178"},{"__ref":"Paragraph:e6189056e39c_179"},{"__ref":"Paragraph:e6189056e39c_180"},{"__ref":"Paragraph:e6189056e39c_181"},{"__ref":"Paragraph:e6189056e39c_182"},{"__ref":"Paragraph:e6189056e39c_183"},{"__ref":"Paragraph:e6189056e39c_184"},{"__ref":"Paragraph:e6189056e39c_185"},{"__ref":"Paragraph:e6189056e39c_186"},{"__ref":"Paragraph:e6189056e39c_187"},{"__ref":"Paragraph:e6189056e39c_188"},{"__ref":"Paragraph:e6189056e39c_189"},{"__ref":"Paragraph:e6189056e39c_190"},{"__ref":"Paragraph:e6189056e39c_191"},{"__ref":"Paragraph:e6189056e39c_192"},{"__ref":"Paragraph:e6189056e39c_193"},{"__ref":"Paragraph:e6189056e39c_194"},{"__ref":"Paragraph:e6189056e39c_195"},{"__ref":"Paragraph:e6189056e39c_196"},{"__ref":"Paragraph:e6189056e39c_197"},{"__ref":"Paragraph:e6189056e39c_198"},{"__ref":"Paragraph:e6189056e39c_199"},{"__ref":"Paragraph:e6189056e39c_200"},{"__ref":"Paragraph:e6189056e39c_201"},{"__ref":"Paragraph:e6189056e39c_202"},{"__ref":"Paragraph:e6189056e39c_203"},{"__ref":"Paragraph:e6189056e39c_204"},{"__ref":"Paragraph:e6189056e39c_205"},{"__ref":"Paragraph:e6189056e39c_206"},{"__ref":"Paragraph:e6189056e39c_207"},{"__ref":"Paragraph:e6189056e39c_208"},{"__ref":"Paragraph:e6189056e39c_209"},{"__ref":"Paragraph:e6189056e39c_210"},{"__ref":"Paragraph:e6189056e39c_211"},{"__ref":"Paragraph:e6189056e39c_212"},{"__ref":"Paragraph:e6189056e39c_213"},{"__ref":"Paragraph:e6189056e39c_214"},{"__ref":"Paragraph:e6189056e39c_215"},{"__ref":"Paragraph:e6189056e39c_216"},{"__ref":"Paragraph:e6189056e39c_217"},{"__ref":"Paragraph:e6189056e39c_218"},{"__ref":"Paragraph:e6189056e39c_219"},{"__ref":"Paragraph:e6189056e39c_220"},{"__ref":"Paragraph:e6189056e39c_221"},{"__ref":"Paragraph:e6189056e39c_222"},{"__ref":"Paragraph:e6189056e39c_223"}]},"validatedShareKey":"","shareKeyCreator":null},"creator":{"__ref":"User:74ad66811b78"},"inResponseToEntityType":null,"isLocked":false,"isMarkedPaywallOnly":false,"lockedSource":"LOCKED_POST_SOURCE_NONE","mediumUrl":"https:\u002F\u002Fposts.specterops.io\u002Fa-guide-to-attacking-domain-trusts-971e52cb2944","primaryTopic":null,"topics":[],"isPublished":true,"latestPublishedVersion":"e6189056e39c","visibility":"PUBLIC","postResponses":{"__typename":"PostResponses","count":0},"clapCount":259,"allowResponses":true,"isLimitedState":false,"title":"A Guide to Attacking Domain Trusts","isSeries":false,"sequence":null,"uniqueSlug":"a-guide-to-attacking-domain-trusts-971e52cb2944","socialTitle":"","socialDek":"","canonicalUrl":"http:\u002F\u002Fwww.harmj0y.net\u002Fblog\u002Fredteaming\u002Fa-guide-to-attacking-domain-trusts\u002F","metaDescription":"","latestPublishedAt":1509392282257,"readingTime":35.922641509433966,"previewContent":{"__typename":"PreviewContent","subtitle":""},"previewImage":{"__ref":"ImageMetadata:0*Hfo-BgoCQjoc1G1H.png"},"isShortform":false,"seoTitle":"","firstPublishedAt":1509391519000,"updatedAt":1524267563490,"shortformType":"SHORTFORM_TYPE_LINK","seoDescription":"","viewerEdge":{"__ref":"PostViewerEdge:postId:971e52cb2944-viewerId:lo_57ff73e9b7e1"},"isSuspended":false,"license":"ALL_RIGHTS_RESERVED","tags":[{"__ref":"Tag:domain-trusts"},{"__ref":"Tag:powerview"},{"__ref":"Tag:active-directory"}],"isNewsletter":false,"statusForCollection":"APPROVED","pendingCollection":null,"detectedLanguage":"en","wordCount":8857,"layerCake":0}}</script><script src="https://cdn-client.medium.com/lite/static/js/manifest.7e50e797.js"></script><script src="https://cdn-client.medium.com/lite/static/js/9865.1496d74a.js"></script><script src="https://cdn-client.medium.com/lite/static/js/main.018e7ca9.js"></script><script src="https://cdn-client.medium.com/lite/static/js/instrumentation.d9108df7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/reporting.ff22a7a5.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9120.5df29668.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5049.d1ead72d.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4810.6318add7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6618.db187378.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1386.6a7a21a1.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9977.84e4bd5c.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/719.ae4dd3e0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5250.9f9e01d2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6349.b071a958.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2648.26563adf.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8393.826a25fb.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1443.598cb8b2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/3735.8c38ede2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5642.d10c9ba0.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6546.cd03f950.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6834.08de95de.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/1781.db373833.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2420.0330d157.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/839.ca7937c2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7975.d195c6f1.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2106.21ff89d3.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7394.55c925ce.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2961.00a48598.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/230.4d7a2738.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4391.59acaed3.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/PostPage.MainContent.563d0db5.chunk.js"></script><script>window.main();</script></body></html>