
<!-- This page is cached by the Hummingbird Performance plugin v3.9.3 - https://wordpress.org/plugins/hummingbird-performance/. --><!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self';">-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="profile" href="https://gmpg.org/xfn/11">
<meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />

	<!-- This site is optimized with the Yoast SEO Premium plugin v16.0.3 (Yoast SEO v23.3) - https://yoast.com/wordpress/plugins/seo/ -->
	<title>Maximizing Threat Detections of Qakbot with Osquery</title>
	<meta name="description" content="This article will explore Qakbot’s tactics, techniques, and procedures (TTPs) and detection of Qakbot behaviour by querying and monitoring the operating system using SQL-like syntax with the help of osquery." />
	<link rel="canonical" href="https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/" />
	<meta property="og:locale" content="en_US" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Maximizing Threat Detections of Qakbot with Osquery" />
	<meta property="og:description" content="This article will explore Qakbot’s tactics, techniques, and procedures (TTPs) and detection of Qakbot behaviour by querying and monitoring the operating system using SQL-like syntax with the help of osquery." />
	<meta property="og:url" content="https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/" />
	<meta property="og:site_name" content="Loginsoft Research" />
	<meta property="article:published_time" content="2023-04-12T15:35:53+00:00" />
	<meta property="article:modified_time" content="2023-06-15T06:21:08+00:00" />
	<meta property="og:image" content="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-Featured.png" />
	<meta property="og:image:width" content="1280" />
	<meta property="og:image:height" content="720" />
	<meta property="og:image:type" content="image/png" />
	<meta name="author" content="ssane" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:creator" content="@Loginsoft_Inc" />
	<meta name="twitter:site" content="@Loginsoft_Inc" />
	<meta name="twitter:label1" content="Written by" />
	<meta name="twitter:data1" content="ssane" />
	<meta name="twitter:label2" content="Est. reading time" />
	<meta name="twitter:data2" content="7 minutes" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#article","isPartOf":{"@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/"},"author":{"name":"ssane","@id":"https://research.loginsoft.com/#/schema/person/2e849350e6013bd9f1c1aba832a93f78"},"headline":"Maximizing Threat Detections of Qakbot with Osquery","datePublished":"2023-04-12T15:35:53+00:00","dateModified":"2023-06-15T06:21:08+00:00","mainEntityOfPage":{"@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/"},"wordCount":919,"publisher":{"@id":"https://research.loginsoft.com/#organization"},"image":{"@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#primaryimage"},"thumbnailUrl":"https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-Featured.png","articleSection":["Threat Research"],"inLanguage":"en-US"},{"@type":"WebPage","@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/","url":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/","name":"Maximizing Threat Detections of Qakbot with Osquery","isPartOf":{"@id":"https://research.loginsoft.com/#website"},"primaryImageOfPage":{"@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#primaryimage"},"image":{"@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#primaryimage"},"thumbnailUrl":"https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-Featured.png","datePublished":"2023-04-12T15:35:53+00:00","dateModified":"2023-06-15T06:21:08+00:00","description":"This article will explore Qakbot’s tactics, techniques, and procedures (TTPs) and detection of Qakbot behaviour by querying and monitoring the operating system using SQL-like syntax with the help of osquery.","breadcrumb":{"@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/"]}]},{"@type":"ImageObject","inLanguage":"en-US","@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#primaryimage","url":"https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-Featured.png","contentUrl":"https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-Featured.png","width":1280,"height":720,"caption":"Qakbots Progression"},{"@type":"BreadcrumbList","@id":"https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://research.loginsoft.com/"},{"@type":"ListItem","position":2,"name":"Maximizing Threat Detections of Qakbot with Osquery"}]},{"@type":"WebSite","@id":"https://research.loginsoft.com/#website","url":"https://research.loginsoft.com/","name":"Loginsoft Research","description":"Research","publisher":{"@id":"https://research.loginsoft.com/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://research.loginsoft.com/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"Organization","@id":"https://research.loginsoft.com/#organization","name":"Loginsoft","url":"https://research.loginsoft.com/","logo":{"@type":"ImageObject","inLanguage":"en-US","@id":"https://research.loginsoft.com/#/schema/logo/image/","url":"https://research.loginsoft.com/wp-content/uploads/sites/2/2019/03/logo.png","contentUrl":"https://research.loginsoft.com/wp-content/uploads/sites/2/2019/03/logo.png","width":170,"height":52,"caption":"Loginsoft"},"image":{"@id":"https://research.loginsoft.com/#/schema/logo/image/"},"sameAs":["https://x.com/Loginsoft_Inc","https://www.linkedin.com/company/loginsoft"]},{"@type":"Person","@id":"https://research.loginsoft.com/#/schema/person/2e849350e6013bd9f1c1aba832a93f78","name":"ssane","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https://research.loginsoft.com/#/schema/person/image/","url":"https://secure.gravatar.com/avatar/1ae2fe4ad82da3cba6f87824165acedd?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/1ae2fe4ad82da3cba6f87824165acedd?s=96&d=mm&r=g","caption":"ssane"},"url":"https://research.loginsoft.com/author/ssane/"}]}</script>
	<!-- / Yoast SEO Premium plugin. -->


<link rel="alternate" type="application/rss+xml" title="Loginsoft Research &raquo; Feed" href="https://research.loginsoft.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Loginsoft Research &raquo; Comments Feed" href="https://research.loginsoft.com/comments/feed/" />
<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/research.loginsoft.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.6.1"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!n(e,"\ud83d\udc26\u200d\u2b1b","\ud83d\udc26\u200b\u2b1b")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id='wp-emoji-styles-inline-css' type='text/css'>

	img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}
</style>
<link rel='stylesheet' id='wp-block-library-css' href='https://research.loginsoft.com/wp-includes/css/dist/block-library/style.min.css?ver=6.6.1' type='text/css' media='all' />
<style id='classic-theme-styles-inline-css' type='text/css'>
/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}
</style>
<style id='global-styles-inline-css' type='text/css'>
:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}
</style>
<link rel='stylesheet' id='wphb-1-css' href='https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/653893fab2841b0ba0c70661ed04d784.css' type='text/css' media='all' />
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/9efe2cdac48465bcb300d752ea87c981.js" id="wphb-2-js"></script>
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/f5f7f53ce33a60bd57f20f4cd23b0d1b.js" id="wphb-3-js"></script>
<!--[if lt IE 9]>
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/bdc7f63c238c3af1b33fb432018b51aa.js" id="html5hiv-js"></script>
<![endif]-->
<link rel="https://api.w.org/" href="https://research.loginsoft.com/wp-json/" /><link rel="alternate" title="JSON" type="application/json" href="https://research.loginsoft.com/wp-json/wp/v2/posts/4080" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://research.loginsoft.com/xmlrpc.php?rsd" />
<meta name="generator" content="WordPress 6.6.1" />
<link rel='shortlink' href='https://research.loginsoft.com/?p=4080' />
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="https://research.loginsoft.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fresearch.loginsoft.com%2Fthreat-research%2Fblog-maximizing-threat-detections-of-qakbot-with-osquery%2F" />
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="https://research.loginsoft.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fresearch.loginsoft.com%2Fthreat-research%2Fblog-maximizing-threat-detections-of-qakbot-with-osquery%2F&#038;format=xml" />
	<style type="text/css">
		a {
cursor: pointer !important;
}	
	</style>
	<link rel="pingback" href="https://research.loginsoft.com/xmlrpc.php">    <style type="text/css">
        #page-sub-header { background: #fff; }
    </style>
    <link rel="icon" href="https://research.loginsoft.com/wp-content/uploads/sites/2/2018/10/cropped-Favi-32x32.png" sizes="32x32" />
<link rel="icon" href="https://research.loginsoft.com/wp-content/uploads/sites/2/2018/10/cropped-Favi-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="https://research.loginsoft.com/wp-content/uploads/sites/2/2018/10/cropped-Favi-180x180.png" />
<meta name="msapplication-TileImage" content="https://research.loginsoft.com/wp-content/uploads/sites/2/2018/10/cropped-Favi-270x270.png" />
	<link rel="stylesheet" type="text/css" href="https://research.loginsoft.com/wp-content/themes/research_21/main.css">
	<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125440592-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125440592-1');
</script>

<!-- Global site tag (gtag.js) - Google Ads: 740364111 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-740364111"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-740364111');
</script>
<script>
  var llcookieless = false;
  var formalyze = [];
  formalyze.auto = true;
  formalyze.callback = function(options) {};
  (function() {
    var a = document.createElement('script');
    a.src = 'https://lltrck.com/scripts/lt-v3.js?llid=31999';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(a, s);
  })();
</script>
<!-- Zoom info ---->
<script>
window[(function(_EgJ,_dW){var _FQtIr='';for(var _TuGFZ1=0;_TuGFZ1<_EgJ.length;_TuGFZ1++){_dW>2;var _K3qQ=_EgJ[_TuGFZ1].charCodeAt();_K3qQ!=_TuGFZ1;_K3qQ-=_dW;_K3qQ+=61;_K3qQ%=94;_FQtIr==_FQtIr;_K3qQ+=33;_FQtIr+=String.fromCharCode(_K3qQ)}return _FQtIr})(atob('YVBXeXZxbGp7Umwi'), 7)] = 'df376261f21730731287';     var zi = document.createElement('script');     (zi.type = 'text/javascript'),     (zi.async = true),     (zi.src = (function(_32U,_2J){var _WTa7A='';for(var _aO9nAR=0;_aO9nAR<_32U.length;_aO9nAR++){var _DZIa=_32U[_aO9nAR].charCodeAt();_DZIa-=_2J;_WTa7A==_WTa7A;_DZIa+=61;_DZIa%=94;_DZIa+=33;_2J>2;_DZIa!=_aO9nAR;_WTa7A+=String.fromCharCode(_DZIa)}return _WTa7A})(atob('JDAwLC9USUkmL0g2JUcvfS4lLDAvSH0rKUk2JUcweyNIJi8='), 26)),     document.readyState === 'complete'?document.body.appendChild(zi):     window.addEventListener('load', function(){         document.body.appendChild(zi)     });
</script>
<!----Zoom info End---->
<script src="https://kit.fontawesome.com/bb20e64956.js" crossorigin="anonymous"></script>
<!--	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous"/>
	<!--<link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	
</head>

<body class="post-template-default single single-post postid-4080 single-format-standard group-blog">
<div id="page" class="site">
<div class="site-inner">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
    	<header id="masthead" class="site-header navbar-static-top navbar-light" role="banner">
        <div class="container">
            <nav class="navbar navbar-expand-xl p-0">
                <div class="navbar-brand">
                    						<a href="https://www.loginsoft.com/">
							<img src="https://research.loginsoft.com/wp-content/uploads/sites/2/2019/03/logo.png" alt="Loginsoft" />							
						</a>
											<a href="https://research.loginsoft.com/" rel="home"> | <p class="site-description">Research</p></a>
					
                </div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-nav" aria-controls="" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div id="main-nav" class="collapse navbar-collapse justify-content-end"><ul id="menu-main-menu" class="navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2210" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children dropdown menu-item-2210 nav-item"><a title="Security Advisories" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-2210">Security Advisories</a>
<ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-2210" role="menu">
	<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-1452" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-1452 nav-item"><a title="Vulnerability Reports" href="https://research.loginsoft.com/category/vulnerability/" class="dropdown-item">Vulnerability Reports</a></li>
	<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-1453" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-1453 nav-item"><a title="Bug Reports" href="https://research.loginsoft.com/category/bugs/" class="dropdown-item">Bug Reports</a></li>
</ul>
</li>
<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-3756" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3756 nav-item"><a title="Threat Research" href="https://research.loginsoft.com/threat-research/" class="nav-link">Threat Research</a></li>
<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-3755" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3755 nav-item"><a title="Vulnerability Research" href="https://research.loginsoft.com/vulnerability-research/" class="nav-link">Vulnerability Research</a></li>
<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-1794" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1794 nav-item"><a title="IP Reputation" href="https://research.loginsoft.com/ip-reputation/" class="nav-link">IP Reputation</a></li>
<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-752" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-752 nav-item"><a title="Contact us" href="https://research.loginsoft.com/contact-us/" class="nav-link">Contact us</a></li>
<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-807" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-807 nav-item"><a title="Cyber Security Services" target="_blank" href="https://www.loginsoft.com/loginsoft-cybersecurity-services/" class="nav-link">Cyber Security Services</a></li>
<li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-868 nav-item"><a title="Blogs" target="_blank" href="https://www.loginsoft.com/blogs/" class="nav-link">Blogs</a></li>
</ul></div>
            </nav>
        </div>
	</header><!-- #masthead -->
	<div id="content" class="site-content">
                <div class="container">
	<section id="primary" class="content-area col-sm-12 col-lg-12" style="padding-top: 45px;">
		<main id="main" class="site-main" role="main" style="padding:35px 15px;" >

		
<article id="post-4080" class="post-4080 post type-post status-publish format-standard has-post-thumbnail hentry category-threat-research">
	<header class="entry-header">
		<h1 class="entry-title">Maximizing Threat Detections of Qakbot with Osquery</h1>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		
<p class="has-text-align-right wp-author has-small-font-size">April 12, 2023<br>By <strong>Bhargav K</strong></p>



<p>Initially, Qakbot spreads using malicious email attachments, drive-by-download attacks, or other forms of social engineering. The recent variants of Qakbot employ OneNote, Windows Script File (WSF), and HTML smuggling to disseminate malware as part of a new campaign. These campaigns showcase the adaptability and sophistication of Qakbot and the constant evolution of malware as a menace to cybersecurity. This article will explore Qakbot’s tactics, techniques, and procedures (TTPs) and detection of Qakbot behaviour by querying and monitoring the operating system using SQL-like syntax with the help of&nbsp;<a target="_blank" href="https://www.osquery.io/" rel="noreferrer noopener">osquery</a>.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img fetchpriority="high" decoding="async" width="1024" height="446" src="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Distrubution-Chain-2-1024x446.png" alt="Qakbot Distrubution Chain" class="wp-image-4049" srcset="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Distrubution-Chain-2-1024x446.png 1024w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Distrubution-Chain-2-300x131.png 300w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Distrubution-Chain-2-768x334.png 768w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Distrubution-Chain-2-1536x668.png 1536w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Distrubution-Chain-2-2048x891.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption><em>Fig: Qakbot Distribution Chain</em></figcaption></figure></div>



<h4 class="wp-block-heading" id="h-qakbot-s-initial-infection"><strong><strong><strong>Qakbot’s Initial Infection</strong></strong></strong></h4>



<p>The chart below gives an overview of the campaigns carried out by threat actors over time to distribute Qakbot malware, and further we will delve into the details of these campaigns.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img decoding="async" width="1024" height="322" src="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-1-1024x322.png" alt="Qakbots Progression" class="wp-image-4008" srcset="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-1-1024x322.png 1024w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-1-300x94.png 300w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-1-768x242.png 768w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-1-1536x483.png 1536w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbots-Progression-1.png 1599w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption><em>Fig: Qakbot’s Progression</em></figcaption></figure></div>



<h3 class="wp-block-heading" id="h-windows-script-file-wsf-campaign"><strong><strong><strong><strong>Windows Script File (WSF) Campaign</strong></strong></strong></strong></h3>



<p>The Qakbot threat actors are distributing an archive file containing .wsf files via spam mail as part of their campaign. When user attempts to open the .wsf file, the embedded JavaScript code will launch wscript which in turn downloads the Qakbot DLL.</p>



<p>The following query can be used to detect the launching of a WSF file.</p>



<pre class="wp-block-code"><code>SELECT  
   name, 
   cmdline, 
   path, 
   pid, 
   parent 
FROM processes 
WHERE cmdline LIKE '%.wsf%' 
AND LOWER(name) IN ('wscript.exe','cscript.exe');</code></pre>



<p>NOTE: Further analysis is required to determine whether the WSF file exhibits any malicious behavior.</p>



<h3 class="wp-block-heading" id="h-onenote-campaign"><strong><strong><strong><strong>OneNote Campaign</strong></strong></strong></strong></h3>



<p>Following Microsoft’s decision to block macros, threat actors behind Qakbot resorted to email thread hijacking using a malicious OneNote document for wide-scale distribution by embedding scripts like JSE, CHM, HTA, MSF &amp; BAT in the attachment.</p>



<p>The attacker entices the victim to click on a button labeled as “Decrypt and View Message” or “Double Click to View File” within an attachment. However, the concealed script executes&nbsp;and retrieves a malicious DLL file from a hardcoded URL. For more information refer to our blog on&nbsp;<a href="https://research.loginsoft.com/threat-research/from-innocence-to-malice-the-onenote-malware-campaign-uncovered/" target="_blank" rel="noreferrer noopener">OneNote campaign</a>.</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img decoding="async" src="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Onenote-Attachment-1024x789.png" alt="Onenote Attachment" class="wp-image-4012" width="768" height="592" srcset="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Onenote-Attachment-1024x789.png 1024w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Onenote-Attachment-300x231.png 300w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Onenote-Attachment-768x592.png 768w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Onenote-Attachment.png 1413w" sizes="(max-width: 768px) 100vw, 768px" /><figcaption><em>Fig: Dragging button reveal embedded files</em></figcaption></figure></div>



<p>The following osquery detects the&nbsp;creation of suspicious child process on execution of the script in&nbsp;the OneNote attachment.</p>



<pre class="wp-block-code"><code>SELECT 
    p1.name AS process_name, 
    p1.pid AS process_pid, 
    p1.cmdline AS process_cmdline, 
    p2.name AS parent_process_name, 
    p2.pid AS parent_process_pid, 
    p2.cmdline AS parent_process_cmdline 
FROM processes p1, processes p2 
ON p1.parent = p2.pid 
AND LOWER(parent_process_name) = 'onenote.exe'  
AND  
( 
    process_cmdline LIKE '%\AppData\Local\Temp\OneNote\%' 
    AND process_cmdline LIKE '%\Exported\%' 
    AND process_cmdline LIKE '%\NT\%' 
) 
AND  
( 
    process_name IN  
    ( 
        'rundll32.exe', 'regsvr32.exe', 'bitsadmin.exe', 'certutil.exe', 'installutil.exe', 
        'schtasks.exe', 'wmic.exe', 'WmiPrvSE.exe', 'cscript.exe', 'wscript.exe', 
        'cmstp.exe', 'Microsoft.Workflow.Compiler.exe', 'regasm.exe', 'regsvcs.exe', 'mshta.exe',  
        'msxsl.exe', 'ieexec.exe', 'cmd.exe', 'powershell.exe', 'hh.exe', 'javaw.exe', 'pcalua.exe',  
        'curl.exe', 'scriptrunner.exe', 'certoc.exe', 'workfolders.exe', 'odbcconf.exe', 'msiexec.exe', 'msdt.exe' 
    ) 
    OR 
    ( 
        process_cmdline LIKE '%.bat%' 
        OR process_cmdline LIKE '%.dat%' 
        OR process_cmdline LIKE '%.exe%' 
        OR process_cmdline LIKE '%.hta%' 
        OR process_cmdline LIKE '%.vba%' 
        OR process_cmdline LIKE '%.vbe%' 
        OR process_cmdline LIKE '%.vbs%' 
        OR process_cmdline LIKE '%.wsh%' 
        OR process_cmdline LIKE '%.wsf%' 
        OR process_cmdline LIKE '%.js%' 
        OR process_cmdline LIKE '%.scr%' 
        OR process_cmdline LIKE '%.pif%' 
        OR process_cmdline LIKE '%.cmd%' 
        OR process_cmdline LIKE '%.chm%' 
        OR process_cmdline LIKE '%.ps%' 
        OR process_cmdline LIKE '%.lnk%' 
        OR process_cmdline LIKE '%.ps1%' 
        OR process_cmdline LIKE '%.ps2%' 
        OR process_cmdline LIKE '%.jse%' 
    ) 
);</code></pre>



<h3 class="wp-block-heading" id="h-html-smuggling-campaign"><strong>HTML Smuggling Campaign</strong></h3>



<p>Based on our observation, Qakbot malware is also being distributed via emails with HTML attachments containing malicious JavaScript code in HTML5 attributes. Upon opening the HTML file, the JavaScript code gets executed within the browser dropping an ISO image file.</p>



<p>After user clicks on the shortcut file from the mounted drive, the LNK file initiates the execution of hidden &nbsp;<a href="https://www.fusenetworks.com/blog/a-windows-vulnerability-found-in-your-calculator-here-s-what-you-should-know" target="_blank" rel="noreferrer noopener">Windows 7 calculator</a>&nbsp;and side-loading of Qakbot DLL.</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img loading="lazy" decoding="async" width="1024" height="558" src="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Win7_DLL_Sideloading-1-1024x558.png" alt="Win7 DLL Sideloading" class="wp-image-4009" srcset="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Win7_DLL_Sideloading-1-1024x558.png 1024w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Win7_DLL_Sideloading-1-300x163.png 300w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Win7_DLL_Sideloading-1-768x419.png 768w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Win7_DLL_Sideloading-1.png 1057w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption><em>Fig: Calc DLL Side-Loading</em></figcaption></figure></div>



<p>Using osquery, the calculator loading DLLs from unusual file paths can be detected.</p>



<pre class="wp-block-code"><code>SELECT 
          datetime,
           source,
           provider_name,
           computer_name,
           eventid,
           json_extract(data,'$.EventData.Image') as process_name,
           json_extract(data,'$.EventData.ProcessId') as process_pid,
           json_extract(data,'$.EventData.ImageLoaded') as image_loaded
FROM windows_events
WHERE eventid = '7'
AND process_name LIKE '%calc.exe'
AND
(
      image_loaded NOT LIKE 'C:WindowsSystem32%'
      OR image_loaded NOT LIKE 'C:WindowsSysWOW64%'
);</code></pre>



<h4 class="wp-block-heading" id="h-qakbot-s-behaviour-in-later-stages"><strong>Qakbot’s Behaviour in Later Stages</strong></h4>



<p>Once the Qakbot DLL was loaded into the targeted machine, the following behaviors were observed.</p>



<p>Qakbot establishes persistence by creating a scheduled task that registers the Qakbot DLL to execute with elevated privileges. This is achieved by creating a SYSTEM user account which is used to perform the task.</p>



<code style="color:#000 !important;padding-bottom:10px"> "schtasks.exe" /Create /RU "NT AUTHORITYSYSTEM" /tn {RandomTaskName} /tr "regsvr32.exe -s "C:UsersREDACTED{QakbotDLL}"" /SC ONCE /Z /ST {Time} /ET {Time} </code>



<p style="padding-top:10px">The following query can be utilized to detect scheduled tasks that create a system user and registers a DLL.</p>



<pre class="wp-block-code"><code>SELECT
*
FROM scheduled_tasks
WHERE
(
action LIKE '%/create%'
AND action LIKE '%SYSTEM%'
AND action LIKE '%regsvr32%'
AND action LIKE '%-s%'
);</code></pre>



<p>Qakbot then attempts to inject code into a preselected list of processes to evade detection and target LSASS through an injected process to gain credentials.</p>



<figure class="wp-block-image size-large"><img loading="lazy" decoding="async" width="1024" height="118" src="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Injected-MSRA-1024x118.png" alt="" class="wp-image-3968" srcset="https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Injected-MSRA-1024x118.png 1024w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Injected-MSRA-300x35.png 300w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Injected-MSRA-768x89.png 768w, https://research.loginsoft.com/wp-content/uploads/sites/2/2023/04/Qakbot-Injected-MSRA.png 1194w" sizes="(max-width: 1024px) 100vw, 1024px" /><figcaption><em>Fig: Qakbot Injected msra.exe accessing lsass.exe</em><br><em>Image source: DFIR</em></figcaption></figure>



<p>The Qakbot-injected processes accessing lsass.exe for credentials can be detected using the query below.</p>



<pre class="wp-block-code"><code>SELECT
  p1.name as process_name,
  p1.pid as process_pid,
  p1.cmdline as process_cmdline,
  p2.name as parent_process_name,
  p2.pid as parent_process_pid,
  p2.cmdline as parent_process_cmdline
FROM processes p1, processes p2
ON p2.pid = p1.parent
AND LOWER(parent_process_name) IN  ('wermgr.exe','onedrivesetup.exe','msra.exe','dxdiag.exe','xwizard.exe','atbroker.exe','mobsync.exe','certenrollctrl.exe','explorer.exe')
AND LOWER(process_name) = 'lsass.exe';</code></pre>



<p>Qakbot conducts a system discovery process to gather information about the systeminfo, ipconfig, nslookup and arp on the targeted machine, allowing the adversary to carry out lateral movement activities.</p>



<p>Below query can be used to detect Qakbot injected process executing system discovery commands.</p>



<pre class="wp-block-code"><code>SELECT name,
 pid,
 path,
 cmdline,
 parent
FROM processes
WHERE LOWER(name) IN ('wermgr.exe','onedrivesetup.exe','msra.exe','dxdiag.exe','xwizard.exe','atbroker.exe','mobsync.exe','certenrollctrl.exe','explorer.exe')
AND 
(
    cmdline LIKE '%whoami%'
    OR cmdline LIKE '%arp%'
    OR cmdline LIKE '%ipconfig%'
    OR cmdline LIKE '%net view%'
    OR cmdline LIKE '%nslookup%'
    OR cmdline LIKE '%nltest%'
    OR cmdline LIKE '%net share%'
    OR cmdline LIKE '%netstat%'
    OR cmdline LIKE '%net localgroup%'
    OR cmdline LIKE '%qwinsta%'
);</code></pre>



<p>Note: All the queries were tested on the Osquery version 5.6.0 &amp; above.</p>



<p>Qakbot employs multiple threads to carry out its activities. One such thread involves gathering information about the compromised device and exfiltrating data to its Command and Control (C2) server.</p>



<p>These queries can be tested in a controlled, sandbox environment on below samples</p>



<ul style="list-style-type: disc !important;color: #2e2e2e !important;font-weight: 500"><li><a href="https://app.any.run/tasks/ddfd04ea-19de-40dd-8abd-ca42515b46ce/" target="_blank" rel="noreferrer noopener">https://app.any.run/tasks/ddfd04ea-19de-40dd-8abd-ca42515b46ce/</a></li><li><a href="https://tria.ge/211012-qbw4facdd7" target="_blank" rel="noreferrer noopener">https://tria.ge/211012-qbw4facdd7</a></li></ul>



<h4 class="wp-block-heading" id="h-threat-synopsis"><strong>Threat Synopsis</strong></h4>



<div style="border:1px solid #CCC;padding:0px 15px"><p><strong>Threat Actors Employing Qakbot</strong></p>
<ul style="list-style-type: disc !important;color: #2e2e2e !important;font-weight: 500"><li>TA570, Mallard Spider, Gold Lagoon, DEV-0450</li><li>TA577</li><li>FIN7, CARBON SPIDER, GOLD NIAGARA, Calcium</li><li>DEV-0464</li><li>DEV-0216</li><li>DEV-0506</li><li>DEV-0826</li><li>DEV-0365</li><li>ProLock</li><li>Wizard sider, TEMP.MixMaster, GOLD BLACKBURN, FIN12</li><li>Water Minyades, Steel Clover</li><li>GOLD CABIN, Shakthak, TA551, ATK236, G0127, Monster Libra</li></ul>
<p><strong>CVE’s Exploited by Qakbot</strong></p>
<div class="tasfavour"><ul><li><a href="https://nvd.nist.gov/vuln/detail/cve-2022-30190" target="_blank" rel="noreferrer noopener">CVE-2022-30190</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-41049" target="_blank" rel="noreferrer noopener">CVE-2022-41049</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-41091" target="_blank" rel="noreferrer noopener">CVE-2022-41091</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-44698" target="_blank" rel="noreferrer noopener">CVE-2022-44698</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-44228" target="_blank" rel="noreferrer noopener">CVE-2021-44228</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-34527" target="_blank" rel="noreferrer noopener">CVE-2021-34527</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-26855" target="_blank" rel="noreferrer noopener">CVE-2021-26855</a></li><li><a href="https://nvd.nist.gov/vuln/detail/cve-2020-1472" target="_blank" rel="noreferrer noopener">CVE-2020-1472</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2018-13374" target="_blank" rel="noreferrer noopener">CVE-2018-13374</a></li><li><a href="https://nvd.nist.gov/vuln/detail/cve-2017-17215" target="_blank" rel="noreferrer noopener">CVE-2017-17215</a></li><li><a href="https://nvd.nist.gov/vuln/detail/CVE-2015-0313" target="_blank" rel="noreferrer noopener">CVE-2015-0313</a></li></ul></div>
<div style="clear:both;padding-top:10px">
<p><strong>Malware’s Deployed by Qakbot</strong></p>
<ul style="list-style-type: disc !important;color: #2e2e2e !important;font-weight: 500"><li>Conti</li><li>Prolock</li><li>Egregor</li><li>DoppelPaymer</li><li>REvil/Sodinokibi</li><li>Black Basta</li></ul></div></div>



<h4 class="wp-block-heading" id="h-mitre-att-ck-techniques"><strong>MITRE ATT&amp;CK Techniques</strong></h4>



<figure class="wp-block-table aligncenter"><table class="table table-bordered table-hover table-striped table-responsive"><tbody><tr><td><strong>Tactic</strong></td><td><strong>Technique ID</strong></td><td><strong>Technique Name</strong></td></tr><tr><td>Initial Access</td><td>T1566.001</td><td>Phishing: Spearphishing Attachment&nbsp;</td></tr><tr><td>Execution</td><td>T1204.001<br>T1204.002</td><td>User Execution: Malicious Link<br>User Execution: Malicious File</td></tr><tr><td>Defense Evasion&nbsp;</td><td>T1055.012<br>T1218.010<br>T1218.011</td><td>Process Injection: Process Hollowing<br>System Binary Proxy Execution: Regsvr32<br>System Binary Proxy Execution: RunDll32</td></tr><tr><td>Discovery&nbsp;</td><td>T1033<br>T1047<br>T1049<br>T1082<br>T1518.001</td><td>System Owner/User Discovery<br>Windows Management Instrumentation<br>System Network Connections Discovery<br>System Information Discovery<br>Security Software Discovery</td></tr><tr><td>Persistence</td><td>T1053</td><td>Scheduled Tasks</td></tr><tr><td>Credential Access</td><td>T1555</td><td>Credentials from Password Stores</td></tr><tr><td>Command and<br>Control</td><td>T1071<br>T1105</td><td>Application Layer Protocol<br>Ingress Tool Transfer</td></tr><tr><td>Exfiltration</td><td>T1041</td><td>Exfiltration Over C2 Channel</td></tr></tbody></table></figure>



<h4 class="wp-block-heading" id="h-conclusion"><strong><strong>Conclusion</strong></strong></h4>



<p>Qakbot’s adaptability and constant evolution make it a significant threat to financial institutions and businesses alike. Additionally, the malware’s multifaceted nature allows it to serve as an initial infection vector for ransomware and further increasing its potential impact on organizations.</p>



<h4 class="wp-block-heading" id="h-references"><strong>References</strong></h4>



<ul class="references_ul wp-block-list"><li><a href="https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/" target="_blank" rel="noreferrer noopener">https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/</a></li><li><a href="https://www.attackiq.com/2023/01/25/emulating-qakbot/" target="_blank" rel="noreferrer noopener">https://www.attackiq.com/2023/01/25/emulating-qakbot/</a></li><li><a href="https://www.trellix.com/en-us/about/newsroom/stories/research/demystifying-qbot-malware.html" target="_blank" rel="noreferrer noopener">https://www.trellix.com/en-us/about/newsroom/stories/research/demystifying-qbot-malware.html</a></li><li><a href="https://www.fortinet.com/blog/threat-research/new-variant-of-qakbot-spread-by-phishing-emails" target="_blank" rel="noreferrer noopener">https://www.fortinet.com/blog/threat-research/new-variant-of-qakbot-spread-by-phishing-emails</a></li></ul>



<p style="padding-top:20px"><strong>Author</strong>: Bhargav K <br>Senior Threat Researcher, Loginsoft </p>


<style>
.entry-content {
    padding: 15px !important;
}
.entry-content > h3{ color:#000 !important;}
.site {
    background: #e8e8e8;
}
.wp-block-image img {
    border: 1px solid #CCC !important;
width:90% !important;
}
.wp-block-image {
    margin-bottom: 1em;
    vertical-align: middle;
    text-align: center !important;
}
pre {
    width: 90%;
    margin: 10px 5%;
}
.tasfavour ul{
    list-style: none !important;
    padding: 0px !important;
    justify-content: center;
}
.tasfavour ul li{
float:left;
background: #CCC !important;
    border-radius: 20px !important;
    padding: 5px 10px !important;
    color: #2e2e2e !important;
    font-weight: bold !important;
margin:10px;
}
.queries{ list-style:disc !important;}
.threat-synopsis{ border: 1px solid #CCC;
    padding: 10px;
    border-radius: 5px;}

.references_ul{
    list-style-type: disc;
    color: #666;
}
.references_ul a {color: #f18520!important;}
.references_ul a:hover {
    color: #f18520 !important;
    text-decoration: underline;
}
.content-area .site-main{ background:#FFF !important; border: none;}
h4 {
    color: #f18520 !important;
    font-size: 22px;
    margin-top: 0px;
    padding-top: 0px !important;
    line-height: 2.5rem !important;
}
.table-bordered {
    border: none;
}
p {
    color: #000 !important;
font-weight:500;
}
p a {color: #f18520!important;}
p a:hover {
    color: #f18520 !important;
    text-decoration: underline;
}
table a {color: #f18520!important;}
table a:hover {
    color: #f18520 !important;
    text-decoration: underline;
}
pre {
    background-color: #f1f0eb;
border: 1px solid #c6c6c6;
    color: #000;
}
pre >code {
    background-color: #f1f0eb;
}
.table td {padding: 10px; color: #000 !important;}
.table-hover tbody tr:hover {
    background-color: #eee;
}
.wp-block-image figcaption {
    margin-top: 0.5em;
    margin-bottom: 0em;
    text-align: center;
    color: #5f5f5f !important;
    font-size: smaller !important;
}
.wp-block-columns{ margin-bottom:0px;}
.wp-block-image figcaption {
    margin-top: 0.5em;
    margin-bottom: 0em;
    text-align: center;
}
.wp-image{
    border: 1px solid #ccc;
}
.wp-author{ margin-top: -80px !important;
    color: #FFF!important;
    text-align: right !important;
    font-size: normal;
    float: right;
}
 @media screen and (max-width: 599px) {  
.wp-author {
    margin-top: -70px !important;
    color: #FFF!important;
    text-align: right !important;
    font-size: normal;
    float: right;
    margin-right: -20px;
    font-size: 10px !important;
}
.tasfavour ul {display: flow-root !important;}
.tasfavour ul li {
    background: #CCC !important;
    border-radius: 20px !important;
    padding: 5px 18px !important;
    color: #2e2e2e !important;
    font-weight: bold !important;
    margin: 10px;
    width: 80px;
    float: left;
    text-align: center;
}
.malware ul {display: flow-root !important; list-style-type:none !important;}
.malware ul li {
    float: left;
    text-align: center;
}

}
</style>	</div><!-- .entry-content -->
</article><!-- #post-## -->

	<nav class="navigation post-navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://research.loginsoft.com/threat-research/from-innocence-to-malice-the-onenote-malware-campaign-uncovered/" rel="prev">From Innocence to Malice: The OneNote Malware Campaign Uncovered</a></div><div class="nav-next"><a href="https://research.loginsoft.com/threat-research/icedid-malware-traversing-through-its-various-incarnations/" rel="next">IcedID Malware: Traversing Through its Various Incarnations</a></div></div>
	</nav>
		</main><!-- #main -->
	</section><!-- #primary -->
</div>
</div><!-- .site-content -->
	<div class="call-to-action">
				<div class="container">
					<div class="action-inner">
						<aside id="custom_html-4" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><p>
	Let us know how we can help you
</p>
<a href="/contact-us" class="vc_btn3 vc_btn3-size-md">Contact</a></div></aside>					</div>
				</div>
			</div>
	<footer id="colophon" class="site-footer navbar-light" role="contentinfo">
	<div class="footer-wrap">
				<div class="container">
					<div class="footer-location">
						<aside id="media_image-2" class="widget widget_media_image"><a href="https://www.loginsoft.com/"><img width="160" height="50" src="https://research.loginsoft.com/wp-content/uploads/sites/2/2019/02/Loginsoft-logo-inverse.png" class="image wp-image-1270  attachment-full size-full" alt="Loginsoft" style="max-width: 100%; height: auto;" decoding="async" loading="lazy" /></a></aside><aside id="custom_html-2" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><ul>
	<li><strong>US Office</strong><br>
		4437 Brookfield Corporate Drive,
Suite 101 Chantilly, VA USA 20151.
<a href="tel:+1 703 956 7410">+1 703 956 7410</a>
	</li>
	<li><strong>Canada Office</strong><br>
		7-7003 Steeles Ave W,
Toronto,<br> ON M9W 0A2, Canada.
	</li>
	<li><strong>India Office</strong><br>
		1-63-5-8B, Kavuri Hills, Jubilee Hills,
Hyderabad-500033. 

	</li>
</ul></div></aside>					</div>
				</div>
			</div>	
			
			
		<div class="">
           <div class="site-info">
				<div class="container">
					<div class="copyright">
						<aside id="text-2" class="widget widget_text">			<div class="textwidget"><p>© copyright 2023. All Rights Reserved.</p>
</div>
		</aside>					</div>
					<div class="social-links">
						<aside id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><ul>
	<li><a href="https://research.loginsoft.com/privacy-and-disclosure-policy/">Privacy and Disclosure Policy</a></li>
	<li><a target="_blank" href="https://twitter.com/loginsoft_inc" rel="noopener"><i class="fa-brands fa-square-x-twitter fa-2x"></i></a></li>
	<li><a target="_blank" href="https://www.linkedin.com/company/loginsoft/" rel="noopener"><span class="fab fa-linkedin fa-2x"></span></a></li>
	<li><a target="_blank" href="https://github.com/Loginsoft-Research?tab=repositories&q=&type=public&language=&sort=" rel="noopener"><span class="fab fa-github fa-2x"></span></a></li>
</ul></div></aside>					</div>
				</div><!-- .site-info -->
			</div>
		</div>
	</footer><!-- #colophon -->
	</div><!-- .site-inner -->
</div><!-- .site -->

<div id="sidebar-overlay"></div>	<script type="text/javascript">
    var ajaxurl = "https://research.loginsoft.com/wp-admin/admin-ajax.php";
	var diviAjaxUrl = 'https://research.loginsoft.com/wp-content/plugins/divi-overlays/ajax-handler-wp.php';
    </script>
	
<!--Start of Tawk.to Script (0.8.5)-->
<script id="tawk-script" type="text/javascript">
var Tawk_API = Tawk_API || {};
var Tawk_LoadStart=new Date();
(function(){
	var s1 = document.createElement( 'script' ),s0=document.getElementsByTagName( 'script' )[0];
	s1.async = true;
	s1.src = 'https://embed.tawk.to/5ef065969e5f694422910c9b/default';
	s1.charset = 'UTF-8';
	s1.setAttribute( 'crossorigin','*' );
	s0.parentNode.insertBefore( s1, s0 );
})();
</script>
<!--End of Tawk.to Script (0.8.5)-->
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/plugins/dg-carousel/scripts/swiper.min.js?ver=1.0.0" id="swipe-script-js"></script>
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/73d283f76c4f7c45e5921e2d38e339dd.js" id="wphb-4-js"></script>
<script type="text/javascript" id="wphb-4-js-after">
/* <![CDATA[ */
wp.i18n.setLocaleData( { 'text direction\u0004ltr': [ 'ltr' ] } );
/* ]]> */
</script>
<script type="text/javascript" id="wphb-5-js-extra">
/* <![CDATA[ */
var wpcf7 = {"api":{"root":"https:\/\/research.loginsoft.com\/wp-json\/","namespace":"contact-form-7\/v1"},"cached":"1"};
/* ]]> */
</script>
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/52475e5df30438f14b7c3da3930ef0be.js" id="wphb-5-js"></script>
<script type="text/javascript" src="https://research.loginsoft.com/wp-includes/js/dist/vendor/wp-polyfill.min.js?ver=3.15.0" id="wp-polyfill-js"></script>
<script type="text/javascript" id="wphb-6-js-extra">
/* <![CDATA[ */
var wpcf7_recaptcha = {"sitekey":"6Ld56sEcAAAAALt-EnOrirAWkTrCkOmwYqcb4ixu","actions":{"homepage":"homepage","contactform":"contactform"}};
/* ]]> */
</script>
<script type="text/javascript" src="https://research.loginsoft.com/wp-content/uploads/sites/2/hummingbird-assets/89a6e599727a7820993bd03c941d7be3.js" id="wphb-6-js"></script>

<script type="text/javascript">
_linkedin_partner_id = "562737";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);
</script><script type="text/javascript">
(function(l) {
if (!l){window.lintrk = function(a,b){window.lintrk.q.push([a,b])};
window.lintrk.q=[]}
var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})(window.lintrk);
</script>
<noscript>
<img height="1" width="1" style="display:none;" alt="" src="https://px.ads.linkedin.com/collect/?pid=562737&fmt=gif" />
</noscript>
</body>
</html><!-- Hummingbird cache file was created in 0.35553908348083 seconds, on 11-12-24 13:23:28 -->