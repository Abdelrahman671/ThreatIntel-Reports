<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>The DGA of QSnatch</title><meta content="QSnatch is a malware that infects QNAP NAS devices. It collects and exfiltrates user credentials from vulnerable devices, and can also load malicious code from its command and control (C2) servers. These C2 servers are resolved by algorithmically generated domains." name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/qsnatch-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="The DGA of QSnatch" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="The DGA of QSnatch" name="twitter:title"><meta content="QSnatch is a malware that infects QNAP NAS devices. It collects and exfiltrates user credentials from vulnerable devices, and can also load malicious code from its command and control (C2) servers. These C2 servers are resolved by algorithmically generated domains." name="twitter:description"><meta content="https://bin.re/assets/img/front/qsnatch-800.jpeg" name="twitter:image"><link href="/assets/css/common-ef2fe0.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script defer src="/assets/js/all.min-a1c570.js"></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/qsnatch-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'The DGA of QSnatch'" class="lazyload b9" data-src="/assets/img/header/qsnatch-640.jpeg" data-srcset="/assets/img/header/qsnatch-830.webp 830w,
/assets/img/header/qsnatch-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjNTYyYzNiIiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGNpcmNsZSBjeD0iMTI3IiBjeT0iMTQwIiByPSIyMDkiIGZpbGw9IiMwMDAwMDEiLz48Y2lyY2xlIGN4PSIxNTYiIGN5PSI5OSIgcj0iMTkyIiBmaWxsPSIjMDAwYTFlIi8+PGVsbGlwc2UgY3g9IjEzMSIgY3k9Ijk4IiBmaWxsPSIjNGMxNTMwIiByeD0iMjU1IiByeT0iMjIiLz48ZWxsaXBzZSBjeD0iMTIyIiBjeT0iMTUxIiBmaWxsPSIjMDEwZTE0IiByeD0iMTkzIiByeT0iMzQiLz48cGF0aCBmaWxsPSIjOWQxZTU3IiBkPSJNMTAxIDk1aDQxdjExaC00MXoiLz48cGF0aCBmaWxsPSIjOTIxYTRiIiBkPSJtMTcxLjYgODktMy4xIDE3LjggMjMuMy0yOC45LTQ4IDEuNnoiLz48cGF0aCBmaWxsPSIjOTkxZDRjIiBkPSJNODQgODJoOXY0MGgtOXoiLz48ZWxsaXBzZSBjeD0iOTAiIGN5PSIzMSIgZmlsbD0iIzAzMGYxYSIgcng9IjE2NSIgcnk9IjQ4Ii8+PHBhdGggZmlsbD0iIzAwMGEwZCIgZD0iTTE0NCA4OGgyNXY0MmgtMjV6Ii8+PHBhdGggZmlsbD0iIzAyMTIyMCIgZD0iTTE3NiA4OGg3N3YyM2gtNzd6Ii8+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgeD0iLS41IiB5PSItLjUiIGZpbGw9IiM5MjFhNDkiIHRyYW5zZm9ybT0ibWF0cml4KC03Ljk4MDUxIC0uNTU4MDUgMS43NDM5MSAtMjQuOTM5MSAyMDYgMTAwKSIvPjxwYXRoIGZpbGw9IiM5YzFmNGQiIGQ9Ik01MiA3OGg3djQxaC03eiIvPjxlbGxpcHNlIGN4PSIxMjUiIGN5PSI4MiIgZmlsbD0iI2I5MWQ1NyIgcng9IjExIiByeT0iNCIvPjxwYXRoIGZpbGw9IiMwMDBjMTQiIGQ9Ik0xMTAgMTA0aDI1djE5aC0yNXoiLz48cGF0aCBmaWxsPSIjYTQyMDUyIiBkPSJNMTAyIDg2aDd2MzVoLTd6Ii8+PHBhdGggZmlsbD0iI2E1MWE1MSIgZD0iTTEzNC44IDg5aDdsLS42IDMwaC03eiIvPjxwYXRoIGZpbGw9IiM5NDFjNGMiIGQ9Ik0xNjkgNzloOHY0MmgtOHoiLz48cGF0aCBmaWxsPSIjMDAwODA0IiBkPSJNNDIgNjNoOXY1OWgtOXoiLz48cGF0aCBmaWxsPSIjMDAwYTBkIiBkPSJNMTk3LjcgNzguMiA4NiA3Ny40bDEzMC43LTguMi04MyAxNDMuMnoiLz48cGF0aCBmaWxsPSIjNzQxZDQ2IiBkPSJtLTE2IDExMyA0NC0yLTYgMTF6Ii8+PHBhdGggZmlsbD0iIzAwMGIwZCIgZD0iTTc5LjYgNTguNiA0My45IDY4bDM4LjkgMzMuNSA0LjMtMTIuN3oiLz48cGF0aCBmaWxsPSIjMDAwOTBlIiBkPSJtMTAyLjQgNzAuNi0uOCA0OS04LS4yLjgtNDl6Ii8+PGVsbGlwc2UgY3g9IjY5IiBjeT0iMTkwIiBmaWxsPSIjNTA0ZGFjIiByeD0iMTMiIHJ5PSIyIi8+PHBhdGggZmlsbD0iIzAwMDkwYyIgZD0ibTEzNC42IDgzLjIgMzEtMzcuNi0xNC4xIDM2LjYgMTggMjIuOXoiLz48cGF0aCBmaWxsPSIjMDAwYjBkIiBkPSJtMTEzIDE0NS01NC0xIDMtNTB6Ii8+PGVsbGlwc2UgY3g9IjIzMSIgY3k9IjE4NSIgZmlsbD0iIzM3Mzg4NiIgcng9IjIwIiByeT0iMiIvPjxwYXRoIGZpbGw9IiMwMDA5MGUiIGQ9Ik0wIDEwM2gzN3Y4SDB6Ii8+PHBhdGggZmlsbD0iIzdjMTkzYyIgZD0iTTEyIDc5aDMxdjdIMTJ6Ii8+PHBhdGggZmlsbD0iIzIwMjE1NSIgZD0iTTM1LjYgMjEyLjEtMTYgMjE0bDkzLTQwLjQtMTcuOSAxLjJ6Ii8+PHBhdGggZmlsbD0iIzc1MTkzNyIgZD0iTTIxMSA3OGgzNHY4aC0zNHoiLz48L2c+PC9zdmc+"></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">The DGA of QSnatch</h1></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2019/11">November 12, 2019</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/dga" class="bg">dga</a> <a href="/tag/malware-analysis" class="bg">malware analysis</a> <a href="/tag/qsnatch" class="bg">qsnatch</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> no comments</li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#version-a">Version A</a></li><li><a href="#bash">Bash</a></li><li><a href="#tlds">TLDs</a></li><li><a href="#domain-timespans">Domain Timespans</a></li><li><a href="#hostname-lengths">Hostname Lengths</a></li><li><a href="#iterating-over-all-tlds">Iterating over all TLDs</a></li><li><a href="#aborting-domain-generation">Aborting Domain Generation</a></li><li><a href="#hostname-string-generation">Hostname String Generation</a></li><li><a href="#trimming-to-desired-length">Trimming to desired length</a></li><li><a href="#concatenating-the-hostname-and-sld">Concatenating the Hostname and SLD</a></li><li><a href="#python">Python</a></li><li><a href="#version-b">Version B</a></li><li><a href="#bash">Bash</a></li><li><a href="#python">Python</a></li></ul><div><span class="bj">Disclaimer<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-exclamation-triangle" xlink:href="/assets/svg/icons.svg#icon-exclamation-triangle"></use></svg></span><p>These are just unpolished notes. The content likely lacks clarity and structure; and the results might not be adequately verified and/or incomplete.</p></div><span class="bj">Changes</span><ul class="i"><li>2019-11-13 21:11:03: Added two more QSnatch samples with the simpler DGA.</li><li>2019-11-14 12:08:08: Version timestamps from version A samples added.</li></ul><div><span class="bj">DGArchive</span><p>The DGA in this blog post has been implemented by the <a href="https://dgarchive.caad.fkie.fraunhofer.de/" class="bm">DGArchive</a> project.</p></div><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/elf.qsnatch" class="bm">Malpedia entry on QSnatch</a>.</p></div></div></div><div class="b6 bi"><p>QSnatch is a malware that infects QNAP NAS devices. It collects and exfiltrates user credentials from vulnerable devices, and can also load malicious code from its command and control (C2) servers. These C2 servers are resolved by algorithmically generated domains.</p><p>The National Cyber Security Centre of Finland (NCSC-FI) published an <a href="https://www.kyberturvallisuuskeskus.fi/en/news/qsnatch-malware-designed-qnap-nas-devices">article about QSnatch</a> in late October 2019 and made the threat known, but samples on Virustotal date back to at least June 2019.</p><p>I found seven different QSnatch samples with two different DGAs. Both versions are very similar, with one being a simpler version of the other. I called the more complicated version <em>Version A</em> and the simpler one <em>Version B</em>. QSnatch is implemented as shell scripts so it is trivial to reimplement the DGA in Python.</p><h2 id="version-a">Version A</h2><p>These are two samples with the more complicted version of the DGA from Virustotal. This version of QSnatch comes with a timestamp as version information:</p><dl><dt>MD5</dt><dd>372140d7c2c68dc2c8dc137d1a471e9f</dd><dt>SHA1</dt><dd>986f38a04937ede2000e8f25e59ea438ee265e24</dd><dt>SHA256</dt><dd>3c38e7bb004b000bd90ad94446437096f46140292a138bfc9f7e44dc136bac8d</dd><dt>Version Timestamp</dt><dd>2019-03-20 5:00 UTC</dd><dt>Size</dt><dd>41KB, 41655 Bytes</dd><dt>Uploaded to Virustotal</dt><dd>2019-11-04 13:39:51 UTC</dd></dl><p>and this sample (which is also the one currently delivered as of 2019-11-14 11:00 UTC):</p><dl><dt>MD5</dt><dd>60567a1d2b2e02e93ffc162e6a70d60c</dd><dt>SHA1</dt><dd>1f1bf0bd2df89029d5267130f014ab5aa133c3ae</dd><dt>SHA256</dt><dd>9526ccdeb9bf7cfd9b34d290bdb49ab6a6acefc17bff0e85d9ebb46cca8b9dc2</dd><dt>Version Timestamp</dt><dd>2019-05-17 5:00 UTC</dd><dt>Size</dt><dd>41KB, 41104 Bytes</dd><dt>Uploaded to Virustotal</dt><dd>2019-06-09 22:56:07 UTC</dd></dl><p>Both samples have a timestamp set to exactly 05:00 UTC, which could mean that the timestamp is in fact a simple date without time information, generated in a timezone UTC+5.</p><p>The DGA generates domains like the following:</p><pre tabindex="0"><code>t2q2r.cf
gc9nz.tk
07tvvc.com
7ubqo.ml
53bcm.de
6zltf.rocks
hv7uv.mx
nypno.biz
qkzccy.net
rassb.cn
</code></pre><h3 id="bash">Bash</h3><p>The following screenshots shows the shell script lines responsible for generating the domains:</p><p><noscript>&lt;img src="assets/the_dga1.jpg" class=""/&gt;</noscript><img alt="The DGA" class="lazyload" data-src="assets/the_dga1.jpg" data-srcset="assets/the_dga1-1x.webp 1050w,
assets/the_dga1-768.webp 768w,
assets/the_dga1-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDUwIiBoZWlnaHQ9Ijk5NyIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I05hTk5hTk5hTiI+PC9zdmc+" sizes="(max-width: 1050px) 100vw, 1050px"></p><p>In the following I will briefly discuss the main components of the DGA.</p><h4 id="tlds">TLDs</h4><p>The complicated version of the DGA of QSnatch uses a whopping 145 top level domain, including many gTLDS like <code>rocks</code>, <code>mobi</code>, <code>today</code>; and a few sld/tld-tuples where domain registrations are only possible on the third level, like <code>.com.ua</code>, <code>.com.bn</code>, <code>.com.by</code>. The domains are listed in a space separated string as tld/number-pairs divided by colons:</p><pre tabindex="0"><code>domainexts='cf:0 tk:0 com:1 ml:0 de:0 rocks:0 mx:0 biz:0 ...``
</code></pre><p>The number next to the domain specifies the number of extra characters in the hostname. In the analysed sample, <code>.com</code>, <code>.net</code> and <code>.org</code> have 1 extra character specified, meaning their hostname has one extra character compared the remaining tlds, which all have 0 extra characters set.</p><p>The script has a bug for the domain <code>.com.bn</code> which is listed with a leading dot, resulting in invalid domains with doubled points, e.g., <code>r4rb..com.bn</code>.</p><h4 id="domain-timespans">Domain Timespans</h4><p>The generated domains have different validities of 15 days (1296000 seconds) down to 1 hour (3600 seconds). The DGA generates domains for all specified intervals starting with the largest timespan.</p><pre tabindex="0"><code>for interval in '1296000' '432000' '86400' '28800' '7200' '3600'; do
</code></pre><h4 id="hostname-lengths">Hostname Lengths</h4><p>The hostnames have varying lengths, which are calculated by adding a global length value and the number next to the list of top level domains. The global lengths are 5, 3, then 4. As a result, <code>.cf</code> hostnames have a length of 3 to 5, while <code>.com</code> hostnames have a length of 4 to 6.</p><pre tabindex="0"><code>for length in 5 3 4; do
</code></pre><h4 id="iterating-over-all-tlds">Iterating over all TLDs</h4><p>The third loop iterates over all top level domains.</p><pre tabindex="0"><code>n=0; while [ "$n" -lt $domainextcnt ]; do
</code></pre><p>Time permitting, the DGA generates 6 (number of timespans) * 3 (number of hostname lengths) * 145 (number of tlds) = 2610 domains.</p><h4 id="aborting-domain-generation">Aborting Domain Generation</h4><p>Before looping over the top level domains, the DGA checks if more than 10 minutes (600 seconds) passed since starting a timespan block. If ten minutes elapsed, then generating domains for that particular timespan is aborted, unless it is the last timespan:</p><pre tabindex="0"><code>test "$(( $timenow - $timestart ))" -gt 600 &amp;&amp; test "$interval" != "3600" &amp;&amp; break
</code></pre><h4 id="hostname-string-generation">Hostname String Generation</h4><p>The following command generates the string which is later trimmed into a hostname:</p><pre tabindex="0"><code>hostname=$(echo \
  "$(( $(date +%s) / $interval ))IbjGOEgnuD${ext}" | \
  openssl dgst -sha1 -binary | \
  openssl base64 | \
  sed 'y/ABCDEFGHIJKLMNOPQRSTUVWXYZ-+\//abcdefghijklmnopqrstuvwxyzabc/;s/=//g')
</code></pre><ol><li>The command <code>($(date +%s) / $interval )</code> divides the current unix timestamp by the timespan length.</li><li>The seed <code>IbjGOEgnuD</code> and the top level domain <code>${ext}</code> are appended to the string from Step 1.</li><li><code>openssl dgst -sha1 -binary</code> generates the SHA1-hash of the string (including a newline character <code>\n</code> from the echo command).</li><li><code>openssl base64</code> converts the hash into base64.</li><li><code>sed 'y/.../;s/=//g')</code> converts the base64 string into lowercase, replaces <code>-</code>, <code>+</code> and <code>\\</code> with <code>a</code>, <code>b</code> and <code>c</code> respectively, and removes <code>=</code>-padding.</li></ol><h4 id="trimming-to-desired-length">Trimming to desired length</h4><p>Next, the hostname is trimmed to the desired length. The length can not be smaller than 3, which is never the case for the configured lengths:</p><pre tabindex="0"><code>trycnt=0
while [ ${#host} -gt "$l" ] &amp;&amp; [ $trycnt -lt 3 ]; do
  trycnt=$(( $trycnt + 1 ))
  host=${host%?}
done
</code></pre><h4 id="concatenating-the-hostname-and-sld">Concatenating the Hostname and SLD</h4><p>Finally, the hostname and tld are joined to produce the DGA domain:</p><pre tabindex="0"><code>curl --connect-timeout "$curlconntimeout" -m 30 -k -o "$outfile" "https://${host}.${ext}/qnap_firmware.xml?t=$(date +%s)"
</code></pre><h3 id="python">Python</h3><p>This is a reimplementation of Version A of the DGA in Python 3:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TLDS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"cf"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"tk"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"ml"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"de"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"rocks"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"mx"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"biz"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"net"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"cn"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ga"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"gq"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"org"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"top"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"nl"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"men"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ws"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"se"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"info"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"xyz"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"today"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ru"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"ec"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ee"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"rs"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.sv"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.cy"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.zw"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"kg"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.ge"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"tl"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"tw"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"lv"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"bs"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"li"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ng"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ae"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"bt"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"tv"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"pe"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"uz"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"me"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"gy"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"am"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"kr"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"by"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"fr"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.uy"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.lb"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"com.br"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"vu"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"hk"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"in"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"re"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ch"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"af"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"com.ps"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ug"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"dz"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"pro"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.th"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"sg"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"cd"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"so"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"mo"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.id"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.il"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.do"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ke"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"cx"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"ro"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"pm"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"hm"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"vg"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"az"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.eg"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"bz"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"su"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.ar"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"gg"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.lr"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"pa"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.ve"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"al"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"fm"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"to"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"mu"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.ck"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"pk"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.rs"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"cw"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"nr"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"gd"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"gl"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ac"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"lk"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"md"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"fi"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"sx"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"lc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"es"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"cc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"cm"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"la"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.za"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"je"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"cz"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"jp"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ai"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"pw"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"bg"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"nu"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ag"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"bm"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"eu"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"com.my"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"sc"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ax"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"wf"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ly"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"qa"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"vn"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"aq"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"mobi"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.tr"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.ua"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.py"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"hk.org"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"south.am"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.kh"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.zm"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"ru.net"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.km"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"tt"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"kn"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.ls"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"co.fk"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"uy.com"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.gu"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">".com.bn"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"com.pf"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"com.fj"</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">SEED</span> <span class="o">=</span> <span class="s2">"IbjGOEgnuD"</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dga</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unix</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">unix</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HOUR</span> <span class="o">=</span> <span class="mi">3600</span>
</span></span><span class="line"><span class="cl">    <span class="n">DAY</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="n">HOUR</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="o">*</span><span class="n">DAY</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">DAY</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">DAY</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">HOUR</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">HOUR</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">HOUR</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">tld</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">TLDS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">min_length</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">length</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">unix</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">//</span><span class="n">interval</span><span class="si">}{</span><span class="n">SEED</span><span class="si">}{</span><span class="n">tld</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">key_hash_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">key_hash</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">key_hash_b64_noeq_lc</span> <span class="o">=</span> <span class="n">key_hash_b64</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"="</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">trantab</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="s2">"-+/"</span><span class="p">,</span> <span class="s2">"abc"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">hostname_src</span> <span class="o">=</span> <span class="n">key_hash_b64_noeq_lc</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">trantab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">hostname_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_length</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname_src</span><span class="p">[:</span><span class="n">hostname_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tld</span><span class="si">}</span><span class="s2">"</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">domain</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"QSnatch dga"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--datetime"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">help</span><span class="o">=</span><span class="s2">"date time for which to generate domains, e.g., "</span>
</span></span><span class="line"><span class="cl">             <span class="s2">"2019-11-11 18:00:00"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">dga</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="version-b">Version B</h2><p>Version B of the DGA is simpler than the previously described version. I found these five samples on Virustotal that use the simpler version of the DGA:</p><table><thead><tr><th>MD5</th><th>SHA1</th><th>SHA256</th><th>Size</th><th>Uploaded to Virustotal</th></tr></thead><tbody><tr><td>8cee2a187198648c199c1d135c918a3a</td><td>a9f39f3b832344a79d32d92ac56c50cdaff0b93c</td><td>09ab3031796bea1b8b79fcfd2b86dac8f38b1f95f0fce6bd2590361f6dcd6764</td><td>19KB, 19120 Bytes</td><td>2019-09-19 16:02:14 UTC</td></tr><tr><td>c49ac8cfe022ff6acb8eb0036e2fc1a1</td><td>e30ce38ff0ce46d8256d06fb3d5e13bf3abb1012</td><td>5cb5dce0a1e03fc4d3ffc831e4a356bce80e928423b374fc80ee997e7c62d3f8</td><td>19KB, 19038 Bytes</td><td>2019-11-04 21:08:21 UTC</td></tr><tr><td>4affa116b27f2d977a756e353f77b8f5</td><td>e8bb081056542504b5a69bd5f202cf77fac0a64f</td><td>8fd16e639f99cdaa7a2b730fc9af34a203c41fb353eaa250a536a09caf78253b</td><td>52KB, 53113 Bytes</td><td>2019-09-19 17:14:38 UTC</td></tr><tr><td>421f006756f72cabc1ffb796c6cdb5c0</td><td>5ca92d6f02019519de593758583d7ca5a4bf9f23</td><td>5130282cdb4e371b5b9257e6c992fb7c11243b2511a6d4185eafc0faa0e0a3a6</td><td>28KB, 28671 Bytes</td><td>2019-10-07 22:53:17 UTC</td></tr><tr><td>421240952a097e904df778590caa9668</td><td>58523de660632c6b84ffbd243cc75f4fb576980a</td><td>15892206207fdef1a60af17684ea18bcaa5434a1c7bdca55f460bb69abec0bdc</td><td>22KB, 21938 Bytes</td><td>2019-09-18 02:37:51 UTC</td></tr></tbody></table><p>Examples of domains of this DGA are:</p><pre tabindex="0"><code>t2q2rs.cf
t2q2rsa.cf
t2q2rsaz.cf
t2q2rsazo.cf
t2q2rsazo1.cf
gc9nzf.tk
gc9nzfb.tk
gc9nzfbt.tk
gc9nzfbt3.tk
gc9nzfbt3i.tk
</code></pre><h3 id="bash-1">Bash</h3><p>These are the lines of QSnatch that generate the domains:</p><p><noscript>&lt;img src="assets/the_dga2.jpg" class=""/&gt;</noscript><img alt="The DGA" class="lazyload" data-src="assets/the_dga2.jpg" data-srcset="assets/the_dga2-1x.webp 1050w,
assets/the_dga2-768.webp 768w,
assets/the_dga2-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDUwIiBoZWlnaHQ9IjQ0OSIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I05hTk5hTk5hTiI+PC9zdmc+" sizes="(max-width: 1050px) 100vw, 1050px"></p><p>The DGA uses fewer tlds, without tld-specific hostname length specifiers. The algorithm only uses one timespan (15 days). It uses more hostname lengths (6, 7, 8, 9 and 10) which are generated one after another for a specific hostname pattern.</p><p>The generation of the string for the hostname is the same as for the more complicated DGA version, including the seed <code>IbjGOEgnuD</code>. Because Version A mostly uses hostname lengths of 5 and shorter, while Version B uses lengths of 6 up to 10, only some domains from Version A with an extra character overlap with Version B (<code>.com</code>, <code>.net</code>, <code>.org</code>). For example, <code>07tvvc.com</code> is a valid domain for both DGAs.</p><h3 id="python-1">Python</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TLDS</span> <span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'cf'</span><span class="p">,</span> <span class="s1">'tk'</span><span class="p">,</span> <span class="s1">'ml'</span><span class="p">,</span> <span class="s1">'ga'</span><span class="p">,</span> <span class="s1">'gq'</span><span class="p">,</span> <span class="s1">'com'</span><span class="p">,</span> <span class="s1">'biz'</span><span class="p">,</span> <span class="s1">'org'</span><span class="p">,</span> <span class="s1">'de'</span><span class="p">,</span> <span class="s1">'rocks'</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="s1">'mx'</span><span class="p">,</span> <span class="s1">'cn'</span><span class="p">,</span> <span class="s1">'top'</span><span class="p">,</span> <span class="s1">'nl'</span><span class="p">,</span> <span class="s1">'men'</span><span class="p">,</span> <span class="s1">'ws'</span><span class="p">,</span> <span class="s1">'se'</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">,</span> <span class="s1">'xyz'</span><span class="p">,</span> <span class="s1">'net'</span><span class="p">,</span> <span class="s1">'today'</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="s1">'ru'</span><span class="p">,</span> <span class="s1">'fi'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">,</span> <span class="s1">'to'</span><span class="p">,</span> <span class="s1">'in'</span><span class="p">,</span> <span class="s1">'com.ua'</span><span class="p">,</span> <span class="s1">'vg'</span><span class="p">,</span> <span class="s1">'vn'</span><span class="p">,</span> <span class="s1">'cd'</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">SEED</span> <span class="o">=</span> <span class="s2">"IbjGOEgnuD"</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dga</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unix</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">unix</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HOUR</span> <span class="o">=</span> <span class="mi">3600</span>
</span></span><span class="line"><span class="cl">    <span class="n">DAY</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="n">HOUR</span>
</span></span><span class="line"><span class="cl">    <span class="n">INTERVAL</span> <span class="o">=</span> <span class="mi">15</span><span class="o">*</span><span class="n">DAY</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">tld</span> <span class="ow">in</span> <span class="n">TLDS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">unix</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">//</span><span class="n">INTERVAL</span><span class="si">}{</span><span class="n">SEED</span><span class="si">}{</span><span class="n">tld</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_hash_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">key_hash</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">key_hash_b64_noeq_lc</span> <span class="o">=</span> <span class="n">key_hash_b64</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"="</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">trantab</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="s2">"-+/"</span><span class="p">,</span> <span class="s2">"abc"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">hostname_src</span> <span class="o">=</span> <span class="n">key_hash_b64_noeq_lc</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">trantab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">hostname_len</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname_src</span><span class="p">[:</span><span class="n">hostname_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tld</span><span class="si">}</span><span class="s2">"</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">domain</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"QSnatch DGA Version 1"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--datetime"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">help</span><span class="o">=</span><span class="s2">"date time for which to generate domains, e.g., "</span>
</span></span><span class="line"><span class="cl">             <span class="s2">"2019-11-11 18:00:00"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">dga</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</span></span></code></pre></div><p>You also find both versions of the QSnatch DGA in <a href="https://github.com/baderj/domain_generation_algorithms/tree/master/qsnatch">my collection of domain generation algorithms on GitHub</a>.</p></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://rosti.bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-rosti" xlink:href="/assets/svg/icons.svg#icon-rosti"></use></svg> Rösti</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2024 Johannes Bader, last updated March 27, 2024</p></div></div></div></div></footer></div></div></body></html>