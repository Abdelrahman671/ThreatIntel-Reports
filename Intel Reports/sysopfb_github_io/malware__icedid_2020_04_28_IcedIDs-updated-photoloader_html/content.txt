<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>IcedID PhotoLoader evolution | Random RE</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="IcedID PhotoLoader evolution" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="IcedID continues to evolve but yet not a lot of attention is given it, Joshua Platt, Vitali Kremez and myself recently released a report[1] detailing how they have been targeting and continue to target tax season in the midst of the Covid-19 pandemic which has extended tax season in the US to July." />
<meta property="og:description" content="IcedID continues to evolve but yet not a lot of attention is given it, Joshua Platt, Vitali Kremez and myself recently released a report[1] detailing how they have been targeting and continue to target tax season in the midst of the Covid-19 pandemic which has extended tax season in the US to July." />
<link rel="canonical" href="/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html" />
<meta property="og:url" content="/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html" />
<meta property="og:site_name" content="Random RE" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-28T17:43:40+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"IcedID PhotoLoader evolution","dateModified":"2020-04-28T17:43:40+00:00","datePublished":"2020-04-28T17:43:40+00:00","url":"/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html","mainEntityOfPage":{"@type":"WebPage","@id":"/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html"},"description":"IcedID continues to evolve but yet not a lot of attention is given it, Joshua Platt, Vitali Kremez and myself recently released a report[1] detailing how they have been targeting and continue to target tax season in the midst of the Covid-19 pandemic which has extended tax season in the US to July.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Random RE" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Random RE</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IcedID PhotoLoader evolution</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-04-28T17:43:40+00:00" itemprop="datePublished">Apr 28, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>IcedID continues to evolve but yet not a lot of attention is given it, Joshua Platt, Vitali Kremez and 
myself recently released a report[<a href="https://labs.sentinelone.com/icedid-botnet-the-iceman-goes-phishing-for-us-tax-returns/">1</a>] detailing how they have been targeting and continue to target 
tax season in the midst of the Covid-19 pandemic which has extended tax season in the US to July.</p>

<p>In light of this they are also continuing to innovate on their malware tools including their PhotoLoader which was 
detailed by MalwareBytes previously[<a href="https://blog.malwarebytes.com/threat-analysis/2019/12/new-version-of-icedid-trojan-uses-steganographic-payloads/">2</a>]. The loader has recently had a number of additions added to it which appear to be designed 
towards protecting the payloads and also evading network detection.</p>

<h1 id="config">Config</h1>

<p>The loader comes with an onboard configuration which will be decoded:</p>

<p><img src="/assets/photoloader_update/decode_config.png" alt="Decode onboard config" title="Decode onboard config" /></p>

<p>Decoding this config shows some hex data and a number of domains:</p>

<p><img src="/assets/photoloader_update/decoded_config.png" alt="Decoded config" title="Decoded config" /></p>

<p>Some of these domains are legit and one of them stands out as suspect, the loader enumerates these domains and makes requests to them in a loop.</p>

<p><img src="/assets/photoloader_update/make_req_look_for_url.png" alt="Make request and look for url tag" title="Make request and look for url tag" /></p>

<p>After retrieving the content it will look for the first occurrence of ‘url(“‘ or ‘src=”’.</p>

<p><img src="/assets/photoloader_update/initial_lp.png" alt="Initial landing page" title="Initial landing page" /></p>

<p>It will then build another request for this resource from the same domain but depending on the flag value before the domain will determine whether or not the second request will have a callback function set on the request for the retrieved resource.</p>

<p><img src="/assets/photoloader_update/flag_check_for_callback.png" alt="Flag check to set callback" title="Flag check to set callback" /></p>

<p>The callback will add cookie values to the request headers.</p>

<p><img src="/assets/photoloader_update/build_cookie_add_header.png" alt="Build cookie header" title="Build cookie header" /></p>

<p>The cookie values built are based on various information from the infected system.</p>

<p><img src="/assets/photoloader_update/build_cookies_overview.png" alt="Overview of cookies built" title="Overview of cookies built" /></p>

<p>An example of the request can be seen from this sandbox detonation[<a href="https://app.any.run/tasks/d092cd7a-3e1c-479f-93e0-6494e464f44e/">3</a>]:</p>

<p><img src="/assets/photoloader_update/sandbox_request.png" alt="Image request" title="Image request" /></p>

<p>The _u cookie value holds the username and computername hexlified.</p>

<p><img src="/assets/photoloader_update/build_cookie_u.png" alt="Building the _u cookie" title="Building the _u cookie" /></p>

<p>Inspecting the data from the sandbox detonation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="s">'4445534B544F502D4A474C4C4A4C44'</span><span class="p">)</span>
<span class="s">'DESKTOP-JGLLJLD'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="s">'61646D696E'</span><span class="p">)</span>
<span class="s">'admin'</span>
</code></pre></div></div>

<p>A breakdown of what the cookie values are:</p>

<table>
  <thead>
    <tr>
      <th>Cookie</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>_gid</td>
      <td>Based on physical address of NIC</td>
    </tr>
    <tr>
      <td>_io</td>
      <td>Domain identifier from SID</td>
    </tr>
    <tr>
      <td>_u</td>
      <td>Username and Computername</td>
    </tr>
    <tr>
      <td>_gat</td>
      <td>Windows version info</td>
    </tr>
    <tr>
      <td>_ga</td>
      <td>Processor info via CPUID including hypervisor brand if available</td>
    </tr>
    <tr>
      <td>_gads</td>
      <td>First DWORD from decoded config data, flag from inspecting server certificate, a random DWORD or number passed as parameter with -id=, number of processes</td>
    </tr>
  </tbody>
</table>

<p>After pulling down the fake image file it will look for ‘IDAT’.</p>

<p><img src="/assets/photoloader_update/idat.png" alt="Look for IDAT" title="Look for IDAT" /></p>

<p>Uses a byte value to determine the size of the RC4 key before RC4 decrypting the data:</p>

<p><img src="/assets/photoloader_update/rc4_decode.png" alt="RC4 decode" title="RC4 decode" /></p>

<p>Then will perform a hash check on the decoded data to determine if it was correct.</p>

<p><img src="/assets/photoloader_update/hash_check.png" alt="Hash check" title="Hash check" /></p>

<p>If the hash check fails it will just continue performing this enumeration through the domain list, effectively turning this process into a checkin loop with fake traffic mixed in.</p>

<p>Many of these added features to their photo loader appear to be designed for evading researchers and detections, 
this gives us insights into their operations as what their customers are asking for dictates what their development team will prioritize. 
With the previous photo loader being blogged about and signatures being released, it was only a few months before a new updated system was created to replace it.</p>

<h1 id="iocs">IOCs</h1>
<p>1a4408ff606936ba91fa759414f1c6dd8b27e825</p>

<p>ca792a5d30d3ca751c4486e2d26c828a542a001a</p>

<p>zajjizev[.]club</p>

<p>hxxp://45.147.231[.]107/ldr.exe</p>

<p>hxxps://customscripts[.]us/ldr_2817175199.exe</p>

<p>karantino[.]xyz</p>

<p>hinkaly[.]club</p>

<h1 id="signatures">Signatures</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alert http $HOME_NET any -&gt; $EXTERNAL_NET any (msg:"IcedID PhotoLoader Ver2"; flow:established,to_server; content:".png"; http_uri; content:"__gads="; http_cookie; content:"gat="; http_cookie; content:"_ga="; http_cookie; content:"_u="; http_cookie; content:"__io="; http_cookie; content:"_gid="; http_cookie; classtype:trojan-activity; sid:9000030; rev:1; metadata:author Jason Reaves;)
</code></pre></div></div>

<p>References:</p>
<ol>
  <li>https://labs.sentinelone.com/icedid-botnet-the-iceman-goes-phishing-for-us-tax-returns/</li>
  <li>https://blog.malwarebytes.com/threat-analysis/2019/12/new-version-of-icedid-trojan-uses-steganographic-payloads/</li>
  <li>https://app.any.run/tasks/d092cd7a-3e1c-479f-93e0-6494e464f44e/</li>
</ol>


  </div><a class="u-url" href="/malware,/icedid/2020/04/28/IcedIDs-updated-photoloader.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Random RE</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Random RE</li><li><a class="u-email" href="mailto:sysopfb@gmail.com">sysopfb@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/sysopfb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">sysopfb</span></a></li><li><a href="https://www.twitter.com/sysopfb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">sysopfb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Place for me to dump random RE posts mostly revolving around Malware.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
