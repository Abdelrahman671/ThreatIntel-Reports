<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#">
  <head>
    <meta charset="UTF-8">
    
    <title>Objective-See's Blog</title>
    
    <link rel="shortcut icon" href="../images/logoApple.ico">
    
    <link href="../css/style.css" rel="stylesheet" />
    <script src="../js/analytics.js"></script>
    <script src="../js/sweetalert.min.js"></script>
    <script src="../js/donationPopup.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script>
    <script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us13.list-manage.com","uuid":"ecee7516f567e712084cdb1d0","lid":"5fae6de946"}) })</script>
    
    
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@objective_see" />
<meta name="twitter:image" content=https://objective-see.com/images/blog/blog_0x69/install.jpg />
<meta name="twitter:title" content=OSX.CDDS&#32;(OSX.MacMa) />
<meta name="twitter:description" content=a&#32;sophisticated&#32;watering&#32;hole&#32;campaign&#32;drops&#32;a&#32;new&#32;macOS&#32;implant! />
    
<meta property="og:type" content="article" />
<meta property="og:title" content=OSX.CDDS&#32;(OSX.MacMa) />
<meta property="og:image" content=https://objective-see.com/images/blog/blog_0x69/install.jpg />

    </head>
    <body>

    <link rel="stylesheet" type="text/css" href="/css/menu.css">

<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<nav role="main" style="padding-bottom:30px;">
<ul>
    
    <li>
    <div class="logo">
        <a href="/index.html">
            <figure class="logo">
                <img src="/images/logoApple.png" style="height:75px; width:75px;" />
                <br>
                <figcaption class="logo">
                    <span style="color: #95c02d;">Objective</span><span style="color: #798992;">-See</span>
                 
                    <div style="color: #798992; font-size: 18px; font-weight: 300; padding-left: 3px; margin-top: -2px;">
                     a non-profit 501(c)(3) foundation.
                    </div>
                
                </figcaption>
            </figure>
        </a>
    </div>
    </li>

    
    <li>  
        <div class="menuicon">
        <div style="position: relative; min-width:0px;">
        <input type="checkbox" class="toggler">
        <div class="hamburger"><div></div></div>
        <div class="menu">
        <div style="padding-right: 20px;">
            <ul>

                <li>
                    <a href="/news.html" style="display:block;">
                        <img style="vertical-align:middle" src="/images/newsIcon.png" height="24px;">
                        <span style="vertical-align:middle">News</span>
                    </a>
                </li>

                <li>
                    <a href="https://objective-see.myshopify.com/" target="_blank" style="display:block;">
                        <img style="vertical-align:middle" src="/images/storeIcon.png" height="24px;">
                        <span style="vertical-align:middle">Swag</span>
                    </a>
                </li>

                <li>
                    <a href="https://taomm.org/" target="_blank" style="display:block;">
                        <img style="vertical-align:middle" src="/images/bookIcon.png" height="24px;">
                        <span style="vertical-align:middle">Books</span>
                    </a>
                </li>

                <li>
                    <a href="https://objectivebythesea.com/" target="_blank" style="display:block;">
                        <img style="vertical-align:middle" src="/images/conferenceIcon.png" height="24px;">
                        <span style="vertical-align:middle">Conference</span>
                    </a>
                </li>

                 <li>
                    <a href="/malware.html" style="display:block;">
                        <img style="vertical-align:middle" src="/images/malwareIcon.png" height="24px;">
                        <span style="vertical-align:middle">Malware Collection</span>
                    </a>
                </li>

                <li style="border-bottom: none;">
                    <a href="/about.html" style="display:block;">
                        <img style="vertical-align:middle" src="/images/aboutIcon.png" height="24px;">
                        <span style="vertical-align:middle">About Objective-See</span>
                    </a>
                </li>

            </ul>
        </div>
    </div>
    </div>
    </div>

    </li>

    
    <li>
        <form action="/support.html" style="display: inline;">
            <button class="menuicon button-4" role="button">Support Us!</button>
        </form>
    </li>

    
    <li>
        <a href="/blog.html" class="menuicon">
        <figure class="item">
            <center>
                <img src="/images/blogIcon.png" class="item"/>
                <figcaption class="item">blog</figcaption>
            </center>
        </figure>
        </a>
    </li>
    
    
    <li>
        <a href="/products.html" class="menuicon">
        <figure class="item">
            <center>
                <img src="/images/productsIcon.png" class="item"/>
            </center>
            <figcaption class="item">tools</figcaption>
        </figure>
        </a>
    </li>

</ul>

<hr class="gradient">

</nav>
    
    <div class="pageContent">
      <br>
      
<section class="blogContent" style="padding-bottom:50px";>
  <div class="blogTitle">OSX.CDDS (OSX.MacMa)</div>
  <div class="blogSubTitle">a sophisticated watering hole campaign drops a new macOS implant!</div>
  <div class="blogDate" style="padding-top:10px;">by: Patrick Wardle / November 11, 2021</div>
  <div style="border: 1px solid #95c02d; padding: 10px; margin-top:15px; border-radius: 10px;">
    <div style="text-align: left; padding-bottom: 10px;">Objective-See's research, tools, and writing, are supported by the "Friends of Objective-See" such as:</div>
    <center>
    <div class="download-link" style="padding: 10px; margin-left: 20px; ">
        <a href="https://1password.com/?utm_medium=parnter&utm_source=Objective-See&utm_campaign=gp&utm_content=sponsorship" style="border: 0px;">
            <img src="https://objective-see.com/images/friends/1Password.png" height="50px">
            <div class="logo-title" style="text-align: center;">...the world‚Äôs most-loved password manager.</div>
        </a>
    </div>
    <div class="download-link" style="padding: 10px; margin-left: 15px; ">
        <a href="http://kandji.io/" style="border: 0px;">
            <img src="https://objective-see.com/images/friends/kandji.png" height="50px">
            <div class="logo-title" style="text-align: center;">...next-generation apple enterprise management.</div>
        </a>
    </div>
    <br>
    <br>
    <div class="download-link" style="padding: 10px;">
        <a href="https://mosyle.com" style="border: 0px;">
            <img src="https://objective-see.com/images/friends/mosyle.png" height="55px">
        <div class="logo-title" style="text-align: center;">...modern apple mdm & security for enterprise &amp; education.</div>
        </a>
    </div>
    <div class="download-link" style="padding: 10px;">
        <a href="https://www.jamf.com?utm_source=objective-see&utm_medium=sponsored-link&utm_campaign=next-gen-security&utm_content=2021-02-05_protect" style="border: 0px;">
            <img src="https://objective-see.com/images/friends/jamf.png" height="55px">
        <div class="logo-title" style="text-align: center;">...the standard in apple enterprise management.</div>
        </a>
    </div>
    <br>
    <br>
    <div class="download-link" style="padding: 10px;">
        <a href="https://macpaw.com/cleanmymac" style="border: 0px;">
            <img src="https://objective-see.com/images/friends/cleanmymac.png" height="55px">
        <div class="logo-title" style="text-align: center;">...an all-in-one package to awesomize your Mac.</div>
        </a>
    </div>
    </center>
      <br>
      <div align="right" style="padding-right:10px; padding-bottom:10px;">
        <a href="https://objective-see.com/friends.html" class="inlineLink">Become a Friend!</a>
    </div>
</div>
<br>
<br>
<div class="note">
&#x1F4DD; &#x1F47E; Want to play along?
<p>I&rsquo;ve uploaded an <a href="https://objective-see.com/downloads/malware/CDDS.zip">OSX.CDDS sample</a> (password: infect3d).</p>
<div align="right" style="padding-right:10px; padding-bottom:10px;">
...please don‚Äôt infect yourself! 
</div>
</div>
<br><br>
<div class="note">
üôãüèª‚Äç‚ôÇÔ∏è Updates:
<ul style="list-style-type:square">
  <li>Anti-Virus engines are <a href="https://www.virustotal.com/gui/file/f0b12413c9d291e3b9edd1ed1496af7712184a63c066e1d5b2bb528376d66ebc" class="inlineLink">now detecting</a> this threat.
  </li>
  <br>
  <li>As Google referred to the attack as "MacMa", some refer to this malware as OSX.MacMa.
  </li>
  <br>
  <li>Trend Micro Researchers such as <a href="https://twitter.com/phretor">@phretor</a> and <a href="https://twitter.com/evanslify">@evanslify</a> noted that (contrary to initial reporting), the malware does not in fact leverage Data Distribution Service (DDS).
  </li>
  <br>
  <li>See also "<a href="https://www.vice.com/en/article/93bw8y/google-caught-hackers-using-a-mac-zero-day-against-hong-kong-users">Google Caught Hackers Using a Mac Zero-Day Against Hong Kong Users</a>".
  </li>
</ul>
</div>
<h3 id="background">Background</h3>
<p>Today, Google&rsquo;s Threat Analysis Group (TAG), published an intriguing report titled, &ldquo;<a href="https://blog.google/threat-analysis-group/analyzing-watering-hole-campaign-using-macos-exploits/">Analyzing a watering hole campaign using macOS exploits</a>.&rdquo;</p>
<p>In this report, they detailed a highly targeted attack that leveraged both iOS and macOS exploits in order to remotely infect Apple users. As they were not able to recover the full iOS exploit chain, the write-up focused almost fully on the macOS version of the attack which leveraged:</p>
<ul>
<li>
<p>A webkit &ldquo;n-day&rdquo; RCE (patched as CVE-2021-1789 in January)</p>
</li>
<li>
<p>An XNU 0-day local privilege escalation (now patched as CVE-2021-30869).
<br>
According to Google this exploit was, &ldquo;<em>was presented by Pangu Lab in a public talk at zer0con21 in April 2021 and Mobile Security Conference (MOSEC) in July 2021</em>&rdquo;</p>
</li>
</ul>
<p>While Google&rsquo;s blog provided a thorough overview of the macOS exploit chain, it did not dig too much into the persistent macOS implant that would be installed upon successfully exploited systems. However they did note:</p>
<p>&ldquo;<em>Notable features for this backdoor include</em>:</p>
<ul>
<li><em>victim device fingerprinting</em></li>
<li><em>screen capture</em></li>
<li><em>file download/upload</em></li>
<li><em>executing terminal commands</em></li>
<li><em>audio recording</em></li>
<li><em>keylogging</em>&rdquo;</li>
</ul>
<p>Moreover, they were kind enough to provided hashes of the implant ü§ó And, as these has also been uploaded to VirusTotal, we can grab them for analysis.</p>
<p>In this blog post, we&rsquo;ll briefly analyze this implant, <code>OSX.CDDS</code> &hellip;an implant that currently remains undetected by all of the anti-virus engines on VirusTotal.</p>
<h3 id="triage">Triage</h3>
<p>Google&rsquo;s report provided two hashes for <code>OSX.CDDS</code> that would be remotely installed on exploited systems:</p>
<ul>
<li>
<p><code>cf5edcff4053e29cb236d3ed1fe06ca93ae6f64f26e25117d68ee130b9bc60c8</code>
<img src="../images/blog/blog_0x69/vt_1.png"  width="100%" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">cf5e... on VirusTotal</center>
</p>
</li>
<li>
<p><code>f0b12413c9d291e3b9edd1ed1496af7712184a63c066e1d5b2bb528376d66ebc</code>
<img src="../images/blog/blog_0x69/vt_2.png"  width="100%" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">f0b1... on VirusTotal</center>
</p>
</li>
</ul>
<p>The first item, <code>cf5e...</code>, they noted was the 2021 version of the implant, while the second item, <code>f0b1...</code>, was from 2019. Note that both are currently undetected on VirusTotal.</p>
<p>The 2019 sample, is a disk image named <code>install_flash_player_osx.dmg</code>. If we mount it, we find application named <code>SafariFlashActivity</code>:</p>
<img src="../images/blog/blog_0x69/dmg.png"  width="" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">Contents of install_flash_player_osx.dmg</center>

<p>If we examine its code-signing information, we see its been signed adhoc:
<div style="border: 1px solid gray; border-radius: 4px; padding-left:25px; padding-right:25px; overflow-wrap: break-word; background-color:#2A2E35; color:lime;">
    <pre style="font-size: 18px;">
% codesign -dvv /Volumes/SafariFlashActivity/SafariFlashActivity.app 
Executable=/Volumes/SafariFlashActivity/
           SafariFlashActivity.app/Contents/MacOS/SafariFlashActivity

Identifier=xxxxxx.preexcl-project
Format=app bundle with Mach-O thin (x86_64)
CodeDirectory v=20100 size=615 flags=0x2(adhoc) hashes=14+3 location=embedded
Signature=adhoc
Info.plist=not bound
TeamIdentifier=not set
Sealed Resources=none
Internal requirements count=0 size=12
</pre>
</div></p>
<p>Taking a peek at it&rsquo;s <code>Info.plist</code> files reveals key-value pairs such as:</p>
<ul>
<li>
<p><code>LSMinimumSystemVersion</code> : <code>10.7</code></p>
</li>
<li>
<p><code>CFBundleExecutable</code>: <code>SafariFlashActivity</code></p>
</li>
<li>
<p><code>CFBundleIdentifier</code>: <code>xxxxx.SafariFlashActivity</code></p>
</li>
<li>
<p><code>NSHumanReadableCopyright</code> : <code>Copyright ¬© 2018Âπ¥ xxxxx. All rights reserved.</code>
<br>
(Note the Chinese character <code>Âπ¥</code> translate to &ldquo;year&rdquo;).</p>
</li>
</ul>
<p>As Google&rsquo;s report noted that this was an older (2019) sample of the implant, we won&rsquo;t dig into it too much more, instead we&rsquo;ll focus on the 2021 sample.</p>
<p>Still let&rsquo;s note a few facts about the older sample. First, it contains various executable components in it <code>/Resources</code> section:</p>
<img src="../images/blog/blog_0x69/resources.png"  width="" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">Additional executable components</center>

<p>The last item, <code>/Resources/SafariFlashActivityinstall</code> is a simple bash script:</p>
<div style="border: 1px solid gray; border-radius: 4px; padding-left:25px; padding-right:25px; overflow-wrap: break-word; background-color:#2A2E35; color:lime;">
    <pre style="font-size: 18px;">
% cat Resources/SafariFlashActivityinstall
#!/bin/bash
user=$(whoami)
dname=`dirname "$0"`
cd "$dname"
./client "$user"

home_dir="$(echo ~)"
launch_dir="$home_dir/Library/LaunchAgents"
launchctl unload "$launch_dir/com.UserAgent.va.plist"
launchctl load "$launch_dir/com.UserAgent.va.plist"
</pre>
</div>
<p>Its main goal is to execute the <code>client</code> binary (with the name of the currently logged in user), and the unload, then load a launch agent named <code>com.UserAgent.va.plist</code>.</p>
<p>We can observe the invocation of the <code>SafariFlashActivityinstall</code> script via a process monitor:</p>
<div style="border: 1px solid gray; border-radius: 4px; padding-left:25px; padding-right:25px; overflow-wrap: break-word; background-color:#2A2E35; color:lime;">
    <pre style="font-size: 18px;">
# ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty
...
{
  "event" : "ES_EVENT_TYPE_NOTIFY_EXEC",
  "process" : {
    "name" : "bash",
    "path" : "/bin/bash",
    "arguments" : [
      "sh",
      "-c",
      "\"/Volumes/SafariFlashActivity/SafariFlashActivity.app
          /Contents/Resources/SafariFlashActivityinstall\""
    ]
  }
}
</pre>
</div>
<p>&hellip;as well as the launch of the <code>client</code> binary:</p>
<div style="border: 1px solid gray; border-radius: 4px; padding-left:25px; padding-right:25px; overflow-wrap: break-word; background-color:#2A2E35; color:lime;">
    <pre style="font-size: 18px;">
# ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty
...
{
  "event" : "ES_EVENT_TYPE_NOTIFY_EXEC",
  "process" : {
    "name" : "client",
    "path" : "/Volumes/SafariFlashActivity/SafariFlashActivity.app
               /Contents/Resources/client",
    "arguments" : [
      "./client",
      "user"
    ]
  }
}
</pre>
</div>
<p>The malware also creates a directory named <code>Tools</code> in the <code>~/Library/Preferences/</code> directory, and saves several (embedded) custom tools into this directory, including:</p>
<ul>
<li>
<p><code>arch</code> (SHA-1 <code>c4511ad16564eabb2c179d2e36f3f1e59a3f1346</code>)
<br>
This binary invokes a function, aptly named <code>captureScreen</code>, to perform a  screen capture, via Apple&rsquo;s Core Graphic APIs (e.g. <code>CGWindowListCreateImageFromArray</code>). It appears to then save it out to user-specified file.</p>
</li>
<li>
<p><code>at</code> (SHA-1 <code>77a86a6b26a6d0f15f0cb40df62c88249ba80773</code>)
<br>
This binary performs a simple survey, then writes it out to <code>stdout</code>. For example, when run in a virtual machine, it produces the following:
<br>
<div style="border: 1px solid gray; border-radius: 4px; padding-left:25px; padding-right:25px; overflow-wrap: break-word; background-color:#2A2E35; color:lime;">
    <pre style="font-size: 18px;">
% ./at 
uuid=564D028C-69EF-7793-5BD9-8CC893CB8C8D
userName=user
version=Version 10.15.6 (Build 19G2021)
equipmentType=VMware7,1
mac=00:0c:29:cb:8c:8d
ip=
diskFreeSpace=11251048448/42605699072
availableMemory=2098040832/2147483648
cpu_info=Intel(R) Core(TM) i7-8559U CPU @ 2.70GHz
</pre>
</div></p>
</li>
</ul>
<p>Back to the <code>client</code> binary, it then installs a persistent implant as a Launch Agent:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-XML" data-lang="XML"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#75715e">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; ...&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#f92672">&lt;plist</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;1.0&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  <span style="color:#f92672">&lt;key&gt;</span>Label<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>  <span style="color:#f92672">&lt;string&gt;</span>com.UserAgent.va<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>  <span style="color:#f92672">&lt;key&gt;</span>LimitLoadToSessionType<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  <span style="color:#f92672">&lt;string&gt;</span>Aqua<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  <span style="color:#f92672">&lt;key&gt;</span>ProgramArguments<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>  <span style="color:#f92672">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>      <span style="color:#f92672">&lt;string&gt;</span>/Users/user/Library/Preferences/UserAgent/lib/UserAgent<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>      <span style="color:#f92672">&lt;string&gt;</span>-runMode<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>      <span style="color:#f92672">&lt;string&gt;</span>ifneeded<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>  <span style="color:#f92672">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>  <span style="color:#f92672">&lt;key&gt;</span>RunAtLoad<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>  <span style="color:#f92672">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>  <span style="color:#f92672">&lt;key&gt;</span>StartInterval<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>  <span style="color:#f92672">&lt;integer&gt;</span>600<span style="color:#f92672">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  <span style="color:#f92672">&lt;key&gt;</span>ThrottleInterval<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>  <span style="color:#f92672">&lt;integer&gt;</span>2<span style="color:#f92672">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>  <span style="color:#f92672">&lt;key&gt;</span>WorkingDirectory<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>  <span style="color:#f92672">&lt;string&gt;</span>/Users/user/Library/Preferences/UserAgent/lib<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#f92672">&lt;/plist&gt;</span></span></span></code></pre></div>
<p>As the <code>RunAtLoad</code> key is set to <code>true</code> the specified binary, <code>/Users/user/Library/Preferences/UserAgent/lib/UserAgent</code> will be persistently executed by macOS each time the user logs in.</p>
<div class="note">
The UserAgent binary was originally submitted to VirusTotal on `2019-12-01`. 
<p>&hellip;and if we analyze the submission meta-data, we can see it was originally submitted to VirusTotal by a user, via one of my Objective-See tools (which integrate with VirusTotal)! How freaking cool!? ü§©
<br></p>
</div>
<p>Finally, let&rsquo;s note that if (when) the <code>SafariFlashActivity</code> application is executed, it will simply display an error to the user:</p>
<p><img src="../images/blog/blog_0x69/install.jpg"  width="" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">...upon install</center>
.</p>
<p>This is notable for two reasons:</p>
<ol>
<li>
<p>Based on the use of the Chinese language, this shows the malware is geared towards Chinese users.</p>
</li>
<li>
<p>Along with the fact that the malware is packaged up in an easily runnable application (masquerading as Flash), this indicates that this version of the malware is designed to be deployed via socially engineering methods. This is different from the 2021 version mentioned by Google that was deployed via (remote) exploitation.
<br>
<br>
This really isn&rsquo;t too surprising. Sophisticated APT groups often split out their implants from their exploits. Besides allowing multiple people (or even teams) to focus on areas of expertise (e.g. writing remote macOS exploits), this also allows the two to be decoupled &hellip;meaning, the implant can be deployed in a variety of ways (social engineering, exploitation, etc. etc.).</p>
</li>
</ol>
<h3 id="2021">2021</h3>
<p>Now on to the 2021 version, (<code>cf5e...</code>). This binary seems to directly comparable the <code>client</code> (recall that was found in the <code>/Resources</code> of the application, and launched via the <code>SafariFlashActivityinstall</code> bash script when the application was launched).</p>
<p>In Google&rsquo;s report, they note that this binary (<code>cf5e...</code>) was downloaded and executed up successful exploitation. For purposes of analysis we can simply run it directly from the Terminal.</p>
<p>During this results in actions similar to those performed by the (older) <code>client</code> binary including:</p>
<ul>
<li>
<p>The creation of a directory named <code>Tools</code> in the <code>~/Library/Preferences/</code> directory, into which it drops several custom tools (named <code>arch</code>, <code>at</code>, etc.).</p>
</li>
<li>
<p>The persistence of Launch Agent (or likely daemon is running as root) via the <code>com.UserAgent.va.plist</code>.
<br>
As the <code>RunAtLoad</code> key is set to <code>true</code> the specified binary, <code>/Users/user/Library/Preferences/UserAgent/lib/UserAgent</code> will be persistently executed by macOS each time the user logs in.</p>
</li>
</ul>
<p>Of note this, version of the malware drops a new tool named <code>kAgent</code> (<code>SHA-1</code>: <code>D811E97461741E93813EECD8E5349772B1C0B001</code>) into the <code>~/Library/Preferences/Tools</code> directory.</p>
<p>A quick triage of this binary reveals it&rsquo;s a simple keylogger that leverages Core Graphics Event Taps to intercept user keystrokes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sub_1000028f0</span>(<span style="color:#66d9ef">int</span> arg0) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    runLoop <span style="color:#f92672">=</span> CFRunLoopGetCurrent();
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    runLoopSource <span style="color:#f92672">=</span> CFMachPortCreateRunLoopSource(kCFAllocatorDefault, <span style="color:#f92672">*</span>g_eventTap, <span style="color:#ae81ff">0x0</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    CFRunLoopAddSource(<span style="color:#f92672">*</span>runLoop, runLoopSource, kCFRunLoopCommonModes);
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    CGEventTapEnable(<span style="color:#f92672">*</span>g_eventTap, <span style="color:#ae81ff">0x1</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    CFRunLoopRun();
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0x0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>}</span></span></code></pre></div>
<p>In Google&rsquo;s report they noted that, &ldquo;<em>It uses a publish- subscribe model via a Data Distribution Service (DDS) framework for communicating with the C2</em>&rdquo;</p>
<p>As the malware is compiled with a myriad or error and logging message, we can confirm this, but also see exactly what capabilities it supports.</p>
<p>Specifically we can extract strings in the format <code>&lt;number&gt;CDDS</code>, as these appear to show the requests the implant supports:</p>
<ul>
<li>&ldquo;24CDDSScreenCaptureRequest&rdquo;</li>
<li>&ldquo;28CDDSAutoScreenCaptureRequest&rdquo;</li>
<li>&ldquo;21CDDSScreenCaptureInfo&rdquo;</li>
<li>&ldquo;33CDDSScreenCaptureParameterRequest&rdquo;</li>
<li>&ldquo;19CDDSFileInfoRequest&rdquo;</li>
<li>&ldquo;12CDDSFileInfo&rdquo;</li>
<li>&ldquo;18CDDSDirInfoRequest&rdquo;</li>
<li>&ldquo;11CDDSDirInfo&rdquo;</li>
<li>&ldquo;17CDDSZipDirRequest&rdquo;</li>
<li>&ldquo;21CDDSZipDirRequestInfo&rdquo;</li>
<li>&ldquo;22CDDSExecuteFileRequest&rdquo;</li>
<li>&ldquo;19CDDSTerminalConnect&rdquo;</li>
<li>&ldquo;22CDDSTerminalDisConnect&rdquo;</li>
<li>&ldquo;17CDDSTerminalInput&rdquo;</li>
<li>&ldquo;18CDDSTerminalOutput&rdquo;</li>
<li>&ldquo;20CDDSUninstallRequest&rdquo;</li>
<li>&ldquo;20CDDSClearDataRequest&rdquo;</li>
<li>&ldquo;10CDDSCmdAck&rdquo;</li>
<li>&ldquo;18CDDSReqMacBaseInfo&rdquo;</li>
<li>&ldquo;15CDDSMacBaseInfo&rdquo;</li>
<li>&ldquo;18CDDSReqMacFileList&rdquo;</li>
<li>&ldquo;15CDDSMacFileList&rdquo;</li>
<li>&ldquo;20CDDSMacFileListReply&rdquo;</li>
<li>&ldquo;20CDDSReqMacSearchFile&rdquo;</li>
<li>&ldquo;17CDDSMacSearchFile&rdquo;</li>
<li>&ldquo;22CDDSMacSearchFileReply&rdquo;</li>
<li>&ldquo;21CDDSStopMacSearchFile&rdquo;</li>
<li>&ldquo;20CDDSReqMacDeleteFile&rdquo;</li>
<li>&ldquo;20CDDSReqMacFileSystem&rdquo;</li>
<li>&ldquo;17CDDSBaseInfoReply&rdquo;</li>
<li>&ldquo;14CDDSReqMacTree&rdquo;</li>
<li>&ldquo;13CDDSDriveInfo&rdquo;</li>
</ul>
<p>&hellip;based off these tasking strings, it&rsquo;s clear to see the implant supports a myriad of features!</p>
<div class="note">
This is also why this malware is named OSX.CDDS! 
</div>
<h3 id="osxcdds-vs-objective-see"><code>OSX.CDDS</code> .vs Objective-See</h3>
<p>Whenever a new piece of malware is uncovered I like to see how Objective-See&rsquo;s <a href="https://objective-see.com/products.html">free open-source tools</a> stack up.</p>
<p>Good news (and no really no surprise) they are able to detect and thus thwart this new threat, even with no a priori knowledge of it! üòç</p>
<p>Let&rsquo;s look at how!</p>
<p>First, <a href="https://objective-see.com/products/blockblock.html">BlockBlock</a> detects OSX.CDDS&rsquo; attempt at persistence &hellip;specifically when it executes <code>cp</code> to create a launch item:</p>
<img src="../images/blog/blog_0x69/bb.png"  width="100%" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">BlockBlock alert</center>

<p><a href="https://objective-see.com/products/lulu.html">LuLu</a>, our free, open-source firewall detects when the implant first attempts to beacon out to its command and control server to check-in and ask for tasking:</p>
<img src="../images/blog/blog_0x69/ll.png"  width="100%" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">LuLu alert</center>

<p>And if you&rsquo;re worried that you are already infected? <a href="https://objective-see.com/products/knockknock.html">KnockKnock</a> can uncover the malware&rsquo;s persistence (after the fact):</p>
<img src="../images/blog/blog_0x69/kk.jpg"  width="100%" class="center" style="border-radius: 4px;">

<center style="color:#787878; padding-top:5px;">KnockKnock detection</center>

<h3 id="conclusions">Conclusions</h3>
<p>It&rsquo;s not everyday we come across a brand new fully-featured macOS implant to analyze. ü§ó</p>
<p>Today, we triaged OSX.CDDS, an implant (whose latest version) Google detected being remotely deployed via n-day and 0-day exploits.</p>
<h3 id="-support-me">üíï Support Me:</h3>
<div style="border: 1px solid #DCDCDC; border-radius:7px; padding: 10px; margin-top:15px; margin-bottom: 15px;">
    <center>Love these blog posts? You can support them via my <a href="https://www.patreon.com/bePatron?c=701171" class="inlineLink">Patreon</a> page!
    <br><br>
    <a href="https://www.patreon.com/bePatron?c=701171" style="text-decoration: none;">
      <img src="../images/patreon.png" style="display:block;margin:auto; padding-top:0px; width:100%"/>
    </a>
    </center>
</div>
</section>

    </div>

    
<script src="/js/cookies.js"></script>
<script src="/social/ss-social.js"></script>
<link href="/social/ss-social.css" rel="stylesheet" />

<script> 
    $(function(){
        
        
        
        if("" == getCookie("acceptedCookies")) 
        {
            console.log('ok showing!')

            document.getElementById("cookies").style.display = "block";
        }

    });
</script>

<script>
function acceptCookies() {

    
    setCookie("acceptedCookies", "yes", 365);

    
    document.getElementById("cookies").style.display = "none";
}
</script>

<br>
<br>
<div id="cookies" class="cookie" style="padding-left:20px;">
    This website uses cookies to improve your experience.
    <div class="cookieButton">
        
        <button class="menuicon button-4" role="button" onclick="acceptCookies()" style="margin-top: 12px; float: right; padding:3px; padding-left: 10px; padding-right: 10px;">Okay!</button>
    </div>
</div>
<nav role="footer">
<ul>

    <li>
        <a href="mailto:contact@objective-see.com" class="menubutton icon"><span class="ss-icon" style="overflow-y: hidden;">&#x2709;</span></a>
    </li>

     <li>
        <a href="rss.xml" class="menubutton icon"><span class="ss-icon" style="overflow-y: hidden;">&#xE310;</span></a>
    </li>

    <li>
        <a href="https://www.youtube.com/channel/UCQycc8VDhHuNkZlKSSTDHzw" class="menubutton icon"><span class="ss-icon" style="overflow-y: hidden;">&#xF630;</span></a>
    </li>
   
    <li>
        <a href="https://twitter.com/objective_see" class="menubutton icon"><span class="ss-icon">&#xF611;</span></a>
    </li>
    
    <li>
         <form action="support.html" style="display: inline;">
            <button class="menuicon button-4" role="button" style="margin-top: 7px; float: right; padding:3px; padding-left: 10px; padding-right: 10px;">Support Us!</button>
        </form>
        
    </li>

    <li>
        <div style="margin-top: 10px;">
        Signup for our <a class="inlineLink" target="_blank" href="http://eepurl.com/bXpXeT">newsletter </a> ¬ª
        </div>
    </li>

</ul>
</nav>

  </body>
</html>