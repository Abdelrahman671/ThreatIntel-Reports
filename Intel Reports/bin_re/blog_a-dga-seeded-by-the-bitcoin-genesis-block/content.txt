<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>The Domain Generation Algorithm of Orchard v3 - A DGA Seeded by the Bitcoin Genesis Block</title><meta content="The Orchard malware uses a domain generation algorithm (DGA) that is seeded both by the current date, and also by the current balance of the Bitcoin genesis block." name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/bitcoin-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="The Domain Generation Algorithm of Orchard v3 - A DGA Seeded by the Bitcoin Genesis Block" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="The Domain Generation Algorithm of Orchard v3 - A DGA Seeded by the Bitcoin Genesis Block" name="twitter:title"><meta content="The Orchard malware uses a domain generation algorithm (DGA) that is seeded both by the current date, and also by the current balance of the Bitcoin genesis block." name="twitter:description"><meta content="https://bin.re/assets/img/front/bitcoin-800.jpeg" name="twitter:image"><link href="/assets/css/common-ef2fe0.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script defer src="/assets/js/all.min-a1c570.js"></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/bitcoin-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'The Domain Generation Algorithm of Orchard v3'" class="lazyload b9" data-src="/assets/img/header/bitcoin-640.jpeg" data-srcset="/assets/img/header/bitcoin-3090.webp 3090w,
/assets/img/header/bitcoin-2376.webp 2376w,
/assets/img/header/bitcoin-1830.webp 1830w,
/assets/img/header/bitcoin-1400.webp 1400w,
/assets/img/header/bitcoin-1080.webp 1080w,
/assets/img/header/bitcoin-830.webp 830w,
/assets/img/header/bitcoin-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjMmMyYzM0IiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGVsbGlwc2UgY3g9IjkzIiBjeT0iOTciIGZpbGw9IiNmZmZmNzgiIHJ4PSIxODIiIHJ5PSIzMiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iI2ZmZDU4OCIgdHJhbnNmb3JtPSJtYXRyaXgoOTAuMTQyNjYgMy4zNzc4NyAtMS4xMzcwNCAzMC4zNDM0MiA5Mi4zIDk3LjUpIi8+PGNpcmNsZSByPSIxIiBmaWxsPSIjYmM1ZjAwIiB0cmFuc2Zvcm09Im1hdHJpeCg1Ny4wNzcyOSAtMi45OTEzIDEuNTg3MTMgMzAuMjg0MjQgMjE1IDEwNS45KSIvPjxlbGxpcHNlIGN4PSIxMDMiIGN5PSIxNjciIGZpbGw9IiMwMjA0MDIiIHJ4PSIyNDMiIHJ5PSIzOCIvPjxwYXRoIGQ9Im0tMS40IDEyNS4zIDg0LjYgMjkuOCAyNy4zLTQ4LjZMNC45IDE1M3oiLz48Y2lyY2xlIHI9IjEiIHRyYW5zZm9ybT0icm90YXRlKC02NC4xIDE0NCAtMTcyLjIpc2NhbGUoNDQuMTgyNDIgMTAzLjI0NjgpIi8+PGVsbGlwc2UgY3g9IjMyIiBjeT0iMTEwIiBmaWxsPSIjZmZjMjZmIiByeD0iNDAiIHJ5PSIyMyIvPjxjaXJjbGUgY3g9IjE0NCIgY3k9IjkzIiByPSIzMSIgZmlsbD0iI2ZmYzk3ZCIvPjxwYXRoIGZpbGw9IiMwMDAwMTAiIGQ9Im0tNyA2NyA0Mi0xLTUxIDMyeiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzBkMDAwMCIgdHJhbnNmb3JtPSJtYXRyaXgoMzMuNTQ1MDQgLTIwLjYzNzA1IDMuNjU4NSA1Ljk0NjggMTY0LjkgMTI1LjMpIi8+PGNpcmNsZSByPSIxIiBmaWxsPSIjZmZkZWEyIiB0cmFuc2Zvcm09InJvdGF0ZSgxMTAuNiAxLjggNjkuMilzY2FsZSgyNy4wOTA4IDMwLjM5NDA3KSIvPjxlbGxpcHNlIGN4PSI4NiIgY3k9IjE3MyIgZmlsbD0iIzJlMzAzNSIgcng9Ijk4IiByeT0iMjMiLz48cGF0aCBmaWxsPSIjNWMxYzAwIiBkPSJtMTA5LjcgOTQuOC0zNS40IDM1LjYgMjUuNy00LjcgMTIuOC0xOS43eiIvPjxlbGxpcHNlIGN4PSIyMTAiIGN5PSIxMTciIGZpbGw9IiNhZDc3MTYiIHJ4PSIzOSIgcnk9IjE4Ii8+PHBhdGggZmlsbD0iI2ZmZDQ5NSIgZD0iTTExMSA2OWgyMnY2MWgtMjJ6Ii8+PHBhdGggZmlsbD0iIzEzMGMxNSIgZD0ibTEwMC4yIDY2LjYgMzAuOC00LTMxLjkgOC42LTI2LjgtMTAuM3oiLz48cGF0aCBkPSJNNSAxMzJoMjUxdjE2SDV6Ii8+PHBhdGggZmlsbD0iI2ZmZmZmYyIgZD0iTTU4IDgyaDE2djIzSDU4eiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzE4MWExYyIgdHJhbnNmb3JtPSJyb3RhdGUoNzguOSA2Mi44IDEzNy4zKXNjYWxlKDIzLjQxNTg1IDI5LjE4MTA3KSIvPjxwYXRoIGZpbGw9IiM5YjY3MTkiIGQ9Ik0xODQgNzFoMzZ2NjRoLTM2eiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iI2M2OTQzOSIgdHJhbnNmb3JtPSJtYXRyaXgoLTQwLjkxMjEgLTIyLjU1NjM2IDcuMjU0MTYgLTEzLjE1NzQgMCAxMDYpIi8+PHBhdGggZmlsbD0iIzAxMDAwMCIgZD0ibTg2LjUgMTM5LjYgNjUuOCAxMy42IDI4LjMtMzQuOC00Mi45IDl6Ii8+PHBhdGggZD0iTS0xMy45IDE0Ny40IDc5LjggMTIybDQuNi0zLjIgMjQuNyAyMi4yeiIvPjxwYXRoIGZpbGw9IiNkZmExNTEiIGQ9Ik0xNzAuMyAxMTguNiAxODguNyA5M2wtMTQuMi0yNC01OC4zLTcuMnoiLz48cGF0aCBmaWxsPSIjZGNhNTRlIiBkPSJNMTIxLjUgOTcuNSA4OC43IDY2LjRsLTI1LjgtMy4xIDIyLjkgMzMuMXoiLz48cGF0aCBmaWxsPSIjNGMyZDAwIiBkPSJtMTk1LjEgMTAwLjItNS4yLTIwLjUtNS4zIDI4LjUgMTYgMTMuNnoiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiMxYjFlMjAiIHRyYW5zZm9ybT0ibWF0cml4KC00My4zNDA5OCAtMzkuMTE1NDMgMjEuODM4NCAtMjQuMTk3NTYgMTU4LjMgMjYuMSkiLz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4PSItLjUiIHk9Ii0uNSIgZmlsbD0iIzA0MGIxMyIgdHJhbnNmb3JtPSJtYXRyaXgoLTMyLjc2NjA4IC0yMi45NDMwNiAxNi4wNjAxNCAtMjIuOTM2MjYgMjUxIDcxKSIvPjxwYXRoIGZpbGw9IiMxYzFhMmYiIGQ9Ik0tMTYgODZWNjVoNjV6Ii8+PHBhdGggZmlsbD0iI2M4OTEyOSIgZD0iTTE5OSAxMTdoMzB2MTdoLTMweiIvPjwvZz48L3N2Zz4="></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">The Domain Generation Algorithm of Orchard v3</h1><span class="bo">A DGA Seeded by the Bitcoin Genesis Block</span></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2022/07">July 24, 2022</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/dga" class="bg">dga</a> <a href="/tag/malware-analysis" class="bg">malware analysis</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> no comments</li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#seeding">Seeding</a></li><li><a href="#domain-generation">Domain Generation</a></li><li><a href="#reimplementation">Reimplementation</a></li><li><a href="#characteristics-of-the-dga">Characteristics of the DGA</a></li><li><a href="#c2-communication">C2 Communication</a></li><li><a href="#detection">Detection</a></li></ul><div><span class="bj">Disclaimer<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-exclamation-triangle" xlink:href="/assets/svg/icons.svg#icon-exclamation-triangle"></use></svg></span><p>These are just unpolished notes. The content likely lacks clarity and structure; and the results might not be adequately verified and/or incomplete.</p></div><span class="bj">Changes</span><ul class="i"><li>2022-08-08 07:27:13: renamed the DGA to Orchard</li><li>2022-09-29 16:34:13: fixed the Python reimplementation, thanks to @Manny684</li></ul><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.orchard" class="bm">Malpedia entry on Orchard</a>.</p></div><div><span class="bj">VirusTotal</span><p>The IOCs in this blog post are summarized in this <a href="https://www.virustotal.com/gui/collection/a027d14bee2a97dddd656b8d008c9f97426e599dff72fd09af95c1d32c2c6289" class="bm">VirusTotal Collection. </a>.</p></div><div><span class="bj">Cover Image</span> Photo by <a href="https://unsplash.com/@wildbook">Dmitry Demidko</a> on <a href="https://unsplash.com">Unsplash</a></div></div></div><div class="b6 bi"><p><strong>Edit 2022-08-08</strong>: Two weeks after this blog post, 360 Netlab published a <a href="https://blog.netlab.360.com/orchard-dga/">detailed report</a> on the malware, whose DGA version 3 I have described below. Please read Netlab’s post for general informations about the malware and two older DGA’s that is uses. I have adopted the name <em>“Orchard”</em> that they have given to the malware.</p><p>XMRig is an open-source software for mining cryptocurrencies like Monero or Bitcoin. It is also frequently used by cryptojacking malware to mine cryptocurrencies on victims’ computers. These malwares are a dime a dozen and are mostly unremarkable — to the point that they remain unnamed by AV vendors. Orchard is no exception. What sets the sample apart, however, is its Domain Generation Algorithm (DGA) which uses two different sources for seeding:</p><ol><li>the current date — which is deterministic of course</li><li>balance of the Bitcoin genesis block (the first block on the Bitcoin blockchain) — which is not deterministic</li></ol><p>For both seeds the same algorithm is used to generate the domains. The first 16 domains are derived from the current date, while the next 16 domains are based on the Bitcoin block:</p><figure><img alt="Wireshark screenshot of dns queries" class="lazyload bq" data-src="assets/cap1.png" data-srcset="assets/cap1-1x.webp 600w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MDAiIGhlaWdodD0iNzYyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 600px) 100vw, 600px" aria-describedby="cap-1"><figcaption class="br"><span class="bs">Figure 1</span>DNS traffic related to the DGA. The first 16 domains are seeded with the date, and the last 16 domains with the genesis block, whose current balance is retrieved from <em>blockchain.info</em> <a href="assets/cap1-fs.png">(larger version)</a>.</figcaption></figure><p>I analyzed the following sample:</p><dl><dt>File type</dt><dd>PE32 executable (GUI) Intel 80386, for MS Windows</dd><dt>MD5</dt><dd>077b6b101cccb3d77a98e2cc02003526</dd><dt>SHA1</dt><dd>9e4f04d513ef119d7872c7ce0af6ffbdf4f42a7c</dd><dt>SHA256</dt><dd>2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9</dd><dt>Size</dt><dd>507 KB (519680 Bytes)</dd><dt>Compile Timestamp</dt><dd>2022-06-19 16:47:27 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9/">MalwareBazaar</a>, <a href="https://www.capesandbox.com/analysis/293424/">Cape</a>, <a href="ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f">Dropping_sha256</a>, <a href="5c13ee5dbe45d02ed74ef101b2e82ae6">Dropping_md5</a>, <a href="https://www.virustotal.com/gui/file/2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9">VirusTotal</a></dd><dt>Filenames</dt><dd>uAAAACCCGGGJ.exe (VirusTotal )</dd><dt>Detections[</dt><dd><strong>Virustotal</strong>: 53/73 as of 2022-07-22, nothing specific</dd></dl><p>The sample unpacks to this binary, which — like the original — can be downloaded from MalwareBazaar:</p><dl><dt>File type</dt><dd>PE32 executable (GUI) Intel 80386, for MS Windows</dd><dt>MD5</dt><dd>5c13ee5dbe45d02ed74ef101b2e82ae6</dd><dt>SHA1</dt><dd>bdc36bc233675e7a96faa2c4917e9b756cc2a2a0</dd><dt>SHA256</dt><dd>ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f</dd><dt>Size</dt><dd>400 KB (409600 Bytes)</dd><dt>Compile Timestamp</dt><dd>2022-06-19 19:59:36 UTC</dd><dt>Links</dt><dd><a href="https://bazaar.abuse.ch/sample/ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f/">MalwareBazaar</a>, <a href="077b6b101cccb3d77a98e2cc02003526">Dropped_by_md5</a>, <a href="2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9">Dropping_sha256</a>, <a href="https://www.capesandbox.com/analysis/293425/">Cape</a>, <a href="2e63bbbbbb11c21445885f85fc8ef398737184c603f365c8e77a8cbf7523cac9">Dropped_by_sha256</a>, <a href="https://www.virustotal.com/gui/file/ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f">VirusTotal</a></dd><dt>Detections</dt><dd><strong>Virustotal</strong>: 53/74 as of 2022-07-22, nothing specific.</dd></dl><p>Many more samples that feature the DGA can be found on VirusTotal since June 22, 2022, with a clear cluster on July 6 and 7. The hashes are summarized in this <a href="https://www.virustotal.com/gui/collection/a027d14bee2a97dddd656b8d008c9f97426e599dff72fd09af95c1d32c2c6289/">VT Collection</a>.</p><h2 id="seeding">Seeding</h2><p>The <strong>first seed</strong> is calculated by taking the current date and formatting it as <code>YYYY-mm-dd</code>, e.g., <code>2022-07-23</code>. Then a hardcoded domain name is appended. In the examined sample, the domain is “<code>ojena.duckdns.org</code>” so the resulting seed string would be “<code>2022-07-23ojena.duckdns.org</code>”.</p><p>The <strong>second seed</strong> is obtained by making a GET request to the following URL:</p><p><code>https://blockchain.info/balance?active=1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa</code></p><p>This url returns the current balance of the Bitcoin genesis block. The response is the seed for the DGA, for example:</p><pre tabindex="0"><code>{"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa":{"final_balance":6854870116,"n_tx":3389,"total_received":6854870116}}
</code></pre><p>Due to the fame of the genesis account, it receives many transactions, which all result in a changed seed string and therefore different domains. The time between transactions varies greatly, but there was only about a 20% chance last year that a domain would have been valid for more than 2 days.</p><figure><img alt="Lifespan of Genesis Block Seeds" class="lazyload bq" data-src="assets/lifespan.png" data-srcset="assets/lifespan-2x.webp 2100w,
assets/lifespan-1x.webp 1050w,
assets/lifespan-768.webp 768w,
assets/lifespan-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDUwIiBoZWlnaHQ9IjUzMSIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I05hTk5hTk5hTiI+PC9zdmc+" sizes="(max-width: 1050px) 100vw, 1050px" aria-describedby="cap-2"><figcaption class="br"><span class="bs">Figure 2</span>Lifespan of DGA domains seeded by the Bitcoin genesis block <a href="assets/lifespan-fs.png">(larger version)</a>.</figcaption></figure><p>DGAs that use undeterministic sources for seeding are rare: <em>Bedep</em> used the foreign exchange reference rates published by the European Central Bank and <em>Torpig</em> Twitter trends. Unlike for these two examples, the seed in our case can be changed by anyone with a predictable outcome. This allows domains to be registered before they are used by Orchard, something which is not possible for <em>Bedep</em> and <em>Torpig</em> whose seeds can’t be influenced.</p><h2 id="domain-generation">Domain Generation</h2><p>The DGA itself is very simple: The seed string is MD5-hashed, then the hex representation of the hash is split into 4 strings of 8 characters to form the second level domains (sld). These 4 slds are then combined with 4 hardcoded top level domains to form 16 domains:</p><figure><img alt="Illustration of the DGA" class="lazyload bq" data-src="assets/dga.png" data-srcset="assets/dga-2x.webp 1500w,
assets/dga-1x.webp 750w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NTAiIGhlaWdodD0iNDczIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 750px) 100vw, 750px" aria-describedby="cap-3"><figcaption class="br"><span class="bs">Figure 3</span>Illustration of the DGA <a href="assets/dga-fs.png">(larger version)</a></figcaption></figure><h2 id="reimplementation">Reimplementation</h2><p>The following script is a reimplementation of the DGA in Python. It can generate the first set of domains for arbitrary dates, but if you like to generate the second set of domains seeded by the genesis block, you need to request it with the <code>-b</code> command line argument. This will check if the date is covered by a local database of transactions of the Bitcoin genesis block. If necessary, this database will be updated by downloading transactions from <em>blockchain.info</em>. You find the DGA on my Github <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, along with a database of transactions until September 2022.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">itertools</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Union</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LIMIT</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="n">DB_PATH</span> <span class="o">=</span> <span class="s2">"db.json"</span>
</span></span><span class="line"><span class="cl"><span class="n">BLOCK</span> <span class="o">=</span> <span class="s2">"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"</span>
</span></span><span class="line"><span class="cl"><span class="n">PATTERN</span> <span class="o">=</span> <span class="s1">'{"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa":{"final_balance":FB,"n_tx":NTX,"total_received":FB}}'</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">refresh_blockchain_db</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"https://blockchain.info/multiaddr?active=</span><span class="si">{</span><span class="n">BLOCK</span><span class="si">}</span><span class="s2">&amp;limit=</span><span class="si">{</span><span class="n">LIMIT</span><span class="si">}</span><span class="s2">&amp;offset=</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">"</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'error'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"error updating blockchain balance: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">quit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">txs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"txs"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">txs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="s1">'hash'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="n">LIMIT</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_blockchain_seed</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">updated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">when</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">"you can't generate the blockchain domains for the future!"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DB_PATH</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">transactions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">transactions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">transactions</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">'balance'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ntx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transactions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transactions</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tt</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">[</span><span class="s2">"time"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">when</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="s2">""" if the desired date is later than the latest transaction,
</span></span></span><span class="line"><span class="cl"><span class="s2">                then update the transaction database to make sure it is
</span></span></span><span class="line"><span class="cl"><span class="s2">                the current transaction you like to access """</span>
</span></span><span class="line"><span class="cl">            <span class="n">refresh_blockchain_db</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">get_blockchain_seed</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">balance</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">'balance'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">PATTERN</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"FB"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">balance</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"NTX"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ntx</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"the provided date is before the first transaction"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dga</span><span class="p">(</span><span class="n">when</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">],</span> <span class="n">blockchain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blockchain</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">magic</span> <span class="o">=</span> <span class="n">when</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">seed</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">magic</span><span class="si">}</span><span class="s2">ojena.duckdns.org"</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">magic</span> <span class="o">=</span> <span class="n">get_blockchain_seed</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">seed</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">magic</span><span class="si">}</span><span class="s2">"</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"ascii"</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">slds</span> <span class="o">=</span> <span class="p">[</span><span class="n">md5</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">md5</span><span class="p">),</span> <span class="mi">8</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">tlds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">".com"</span><span class="p">,</span> <span class="s2">".net"</span><span class="p">,</span> <span class="s2">".org"</span><span class="p">,</span> <span class="s2">".duckdns.org"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">sld</span><span class="p">,</span> <span class="n">tld</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">slds</span><span class="p">,</span> <span class="n">tlds</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">sld</span><span class="si">}{</span><span class="n">tld</span><span class="si">}</span><span class="s2">"</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">date_parser</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y-%m-</span><span class="si">%d</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="o">=</span><span class="s2">"Orchard malware with DGA based on Bitcoin Genesis Block"</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--date"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">help</span><span class="o">=</span><span class="s2">"date for which to generate domains, e.g., 2022-05-09"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">type</span><span class="o">=</span><span class="n">date_parser</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">"-b"</span><span class="p">,</span> <span class="s2">"--blockchain"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">help</span><span class="o">=</span><span class="s2">"also generate blockchain domains, requires blockchain db"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">"-u"</span><span class="p">,</span> <span class="s2">"--update"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">help</span><span class="o">=</span><span class="s2">"just update of blockchain db"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">refresh_blockchain_db</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">dga</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">blockchain</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="characteristics-of-the-dga">Characteristics of the DGA</h2><p>The following table summarizes the properties of the DGA</p><table><thead><tr><th>property</th><th>value</th></tr></thead><tbody><tr><td>type</td><td>TDD-H and TDN-H</td></tr><tr><td>seeding</td><td>time-dependent deterministic and indeterministic</td></tr><tr><td>generation scheme</td><td>hash</td></tr><tr><td>seed</td><td>current date</td></tr><tr><td>domain change frequency</td><td>every day / arbitrary</td></tr><tr><td>unique domains per day</td><td>32</td></tr><tr><td>sequence</td><td>sequential</td></tr><tr><td>wait time between domains</td><td>none</td></tr><tr><td>top level domain</td><td>.com, .net, .org, .duckdns.org</td></tr><tr><td>second level characters</td><td>0-9a-f</td></tr><tr><td>regex</td><td>``[0-9a-f]{8}.(com</td></tr><tr><td>second level domain length</td><td>8</td></tr></tbody></table><h2 id="c2-communication">C2 Communication</h2><p>The DGA domains — along with the hardcoded domain (<code>ojena.duckdns.org</code>) — are used to control XMRig. First, the client sends some fingerprinting information like the following to the C2. The data is sent unencrypted to a hardcoded port, in my sample to port 25654:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Active_Window"</span><span class="p">:</span> <span class="s2">"*internet"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Antivirus"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Windows Defender"</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Authenticate_Type"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"CPU_Model"</span><span class="p">:</span> <span class="s2">"12th Gen Intel(R) Core(TM) i9-12900K"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Camera"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Elevated"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"GPU_Models"</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"Name"</span><span class="p">:</span> <span class="s2">"-"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"Type"</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Identity"</span><span class="p">:</span> <span class="s2">"F12C8A2E\Username\DESKTOP-XYZ"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Operating_System"</span><span class="p">:</span> <span class="s2">"{\"BuildNumber\":19044,\"MajorVersion\":10,\"MinorVersion\":0,\"ProductType\":false}"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Ram_Size"</span><span class="p">:</span> <span class="mi">17179332608</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"System_Architecture"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Threads"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"Version"</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>After that, the XMRig JSON RPC communication is also sent — again unencrypted — to the C2. For example the login:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="nt">"jsonrpc"</span><span class="p">:</span> <span class="s2">"2.0"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="nt">"method"</span><span class="p">:</span> <span class="s2">"login"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="nt">"params"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"login"</span><span class="p">:</span> <span class="s2">"CPU"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="nt">"pass"</span><span class="p">:</span> <span class="s2">"x"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"agent"</span><span class="p">:</span> <span class="s2">"XMRig/6.15.2 (Windows NT 10.0; Win64; x64) libuv/1.38.0 msvc/2019"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"algo"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"cn/0"</span><span class="p">,</span> <span class="s2">"cn/1"</span><span class="p">,</span> <span class="s2">"cn/2"</span><span class="p">,</span> <span class="s2">"cn/r"</span><span class="p">,</span> <span class="s2">"cn/fast"</span><span class="p">,</span> <span class="s2">"cn/half"</span><span class="p">,</span> <span class="s2">"cn/xao"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="s2">"cn/rto"</span><span class="p">,</span> <span class="s2">"cn/rwz"</span><span class="p">,</span> <span class="s2">"cn/zls"</span><span class="p">,</span> <span class="s2">"cn/double"</span><span class="p">,</span> <span class="s2">"cn/ccx"</span><span class="p">,</span> <span class="s2">"cn-lite/0"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="s2">"cn-lite/1"</span><span class="p">,</span> <span class="s2">"cn-heavy/0"</span><span class="p">,</span> <span class="s2">"cn-heavy/tube"</span><span class="p">,</span> <span class="s2">"cn-heavy/xhv"</span><span class="p">,</span> <span class="s2">"cn-pico"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="s2">"cn-pico/tlo"</span><span class="p">,</span> <span class="s2">"cn/upx2"</span><span class="p">,</span> <span class="s2">"rx/0"</span><span class="p">,</span> <span class="s2">"rx/wow"</span><span class="p">,</span> <span class="s2">"rx/arq"</span><span class="p">,</span> <span class="s2">"rx/graft"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="s2">"rx/sfx"</span><span class="p">,</span> <span class="s2">"rx/keva"</span><span class="p">,</span> <span class="s2">"argon2/chukwa"</span><span class="p">,</span> <span class="s2">"argon2/chukwav2"</span><span class="p">,</span> <span class="s2">"argon2/ninja"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">      <span class="s2">"astrobwt"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>These JSON RPC connections of XMRig will be detected by many Suricata rules.</p><h2 id="detection">Detection</h2><p>Speaking of detections: there are many YARA rule hits you will see both on VirusTotal and MalwareBazaar:</p><p><noscript>&lt;img src="assets/false_positives.png" class=""/&gt;</noscript><img alt="False Positive Yara Detections" class="lazyload" data-src="assets/false_positives.png" data-srcset="assets/false_positives-1x.webp 500w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iMzA4IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 500px) 100vw, 500px"></p><p>Unfortunately, all these rules by <em>The DFIR Report</em> are non functional <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. I wrote the following YARA rule, but it only matches on the unpacked sample, e.g., on memory dumps:</p><pre tabindex="0"><code>rule win_bitcoin_genesis_b9 {

    meta:
        author      = "Johannes Bader @viql"
        date        = "2022-07-22"
        description = "detects a downloader with a DGA based on the Bitcoin Genesis Block"
        tlp         = "TLP:WHITE"
        version     = "v1.0"
        hash_md5    = "5c13ee5dbe45d02ed74ef101b2e82ae6"
        hash_sha1   = "bdc36bc233675e7a96faa2c4917e9b756cc2a2a0"
        hash_sha256 = "ad1e39076212d8d58ff45d1e24d681fe0c600304bd20388cddcf9182b1d28c2f"

    strings:
        $str_json_1 = "\"bytes\": ["
        $str_json_2 = "\"subtype\": "
        $str_json_3 = "{\"bytes\":["
        $str_json_4 = "],\"subtype\":"
        $str_json_5 = "null}"
        $str_json_6 = "&lt;discarded&gt;"
        $str_json_7 = "[json.exception."

        /*
            mov     dl, [ebp+var_14]
            mov     [eax+ecx], dl
            mov     byte ptr [eax+ecx+1], 0
            jmp     short loc_3CBF9F
        */
        $split_hash_1 = {8A 55 ?? 88 14 08 C6 44 08 01 00 EB}
        /*
            inc     ebx
            cmp     ebx, 10h
            jl      loc_3CBF10
        */
        $split_hash_2 = {43 83 FB 10 0F 8C}

        /*
            push    0
            push    0
            mov     [ebp-14h], edx
            mov     [ebp-18h], eax
        */
        $format_the_date = {6A 00 6A 00 89 55 EC 89 45 E8}

    condition:
        uint16(0) == 0x5A4D and 
        all of ($str_json_*) and
        all of ($split_hash_*) and
        $format_the_date
}
</code></pre><div class="footnotes" role="doc-endnotes"><hr><ol><li id="fn:1"><p><a href="https://github.com/baderj/domain_generation_algorithms/tree/master/orchard">https://github.com/baderj/domain_generation_algorithms/tree/master/orchard</a>&nbsp;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">↩︎</a></p></li><li id="fn:2"><p><a href="https://github.com/The-DFIR-Report/Yara-Rules/issues/2">https://github.com/The-DFIR-Report/Yara-Rules/issues/2</a>&nbsp;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">↩︎</a></p></li></ol></div></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://rosti.bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-rosti" xlink:href="/assets/svg/icons.svg#icon-rosti"></use></svg> Rösti</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2024 Johannes Bader, last updated March 27, 2024</p></div></div></div></div></footer></div></div></body></html>