<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
		<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
		<title>News from the Lab Archive : January 2004 to September 2015</title>
		<meta name="description" content="The original antivirus blog.">
		<meta name="keywords" content="F-Secure Labs">
		<link rel="stylesheet" href="main.css" type="text/css" media="screen">
		<link rel="SHORTCUT ICON" href="https://www.f-secure.com/theme/images/favicon.ico">
	</head>
	<body>
		<div id="besure"></div>
		<div id="bodyWrapper">
			<table id="mainTable" border="0" cellpadding="0" cellspacing="0">
				<tbody>
					<tr>
						<td id="logo" valign="top">
						<div id="logo" style="border-left:1px solid #d5d5d5; border-top:1px solid #d5d5d5; width:780px; height:197px;"><a href="https://www.f-secure.com/labs"><img width="780" height="197" src="FSecureLabs.png" border="0" alt="F-Secure Labs"></a></div>
						</td>
					</tr>
					<tr>
						<td id="mainContentContainer" valign="top">
						<div id="mod">
						<table id="modTable" cellpadding="0" cellspacing="0">
						<tbody>
						<tr>
						<td class="modSectionTd">
						<div class="modSubHeaderBg"><table width="100%"><tbody><td style="text-align:left; font-size: 0.8em; width:5%;"><a href='https://www.f-secure.com/weblog/archives/00002762' onmouseout='window.status=\'';return true' onmouseover='window.status=\'11/12/14: What grade does your favorite app get?\';return true' style='color: white; font-family: courier, verdana;' target='_top'>&#60;&#60;&#60;</a></td><td style="width:90%;"><center>NEWS FROM THE LAB - Friday, November 14, 2014</center></td><td style="text-align:right; font-size: 0.8em; width:5%;"><a href='https://www.f-secure.com/weblog/archives/00002765' onmouseout='window.status=\'';return true' onmouseover='window.status=\'11/20/14: Video: R.I.P. Internet #Slush14\';return true' style='color: white; font-family: courier, verdana;' target='_top'>&#62;&#62;&#62;</a></td></tbody></table></div>
						<div>&nbsp;</div>
						<div><center><b><a href="https://www.f-secure.com/weblog/archives/">ARCHIVES</a> | <a href="https://www.bing.com/search?q=site:f-secure.com/weblog">SEARCH</a></b></center></div>
						<div><hr></div>
						<div>&nbsp;</div>
						<div class="modSectionTd2"><a name="00002764"></a><table width="100%" cellpadding="1" cellspacing="0" border="0"><tbody>

					<tr>
						<td style="text-align:left; font-size:12px; width:60%;"><a href='https://www.f-secure.com/weblog/archives/00002764'><b>OnionDuke: APT Attacks Via the Tor Network</b></a></td>
						<td style="text-align:right; font-size:12px; width:40%;">Posted by FSLabs @ 05:00 GMT</td></tr><tr><td colspan="2"><hr style="border:none; border-top: 1px solid #dddddd; border-bottom: 1px solid #ffffff;"></td></tr></tbody></table><p align="justify"><span class="rss:item">Recently, <a href="https://www.leviathansecurity.com/blog/the-case-of-the-modified-binaries/">research was published</a> identifying a Tor exit node, located in Russia, that was consistently and maliciously modifying any uncompressed Windows executables downloaded through it. Naturally this piqued our interest, so we decided to peer down the rabbit hole. Suffice to say, the hole was a lot deeper than we expected! In fact, it went all the way back to the notorious Russian APT family MiniDuke, known to have been used in targeted attacks against NATO and European government agencies. The malware used in this case is, however, not a version of MiniDuke. It is instead a separate, distinct family of malware that we have since taken to calling OnionDuke. But lets start from the beginning.<br /><br />When a user attempts to download an executable via the malicious Tor exit node, what they actually receive is an executable "wrapper" that embeds both the original executable and a second, malicious executable. By using a separate wrapper, the malicious actors are able to bypass any integrity checks the original binary might contain. Upon execution, the wrapper will proceed to write to disk and execute the original executable, thereby tricking the user into believing that everything went fine. However, the wrapper will also write to disk and execute the second executable. In all the cases we have observed, this malicious executable has been the same binary (SHA1: a75995f94854dea8799650a2f4a97980b71199d2, detected as <span style="font-weight: bold;">Trojan-Dropper:W32/OnionDuke.A</span>). This executable is a dropper containing a PE resource that pretends to be an embedded GIF image file. In reality, the resource is actually an encrypted dynamically linked library (DLL) file. The dropper will proceed to decrypt this DLL, write it to disk and execute it.<br /><br /><img border="1" src="https://www.f-secure.com/weblog/archives/flowchart.png" alt="A flowchart of the infection process" height="365" width="650" /><br /><span style="font-style: italic;">A flowchart of the infection process</span><br /><br />Once executed, the DLL file (SHA1: <span style="font-style: italic;">b491c14d8cfb48636f6095b7b16555e9a575d57f</span>, detected as <span style="font-weight: bold;">Backdoor:W32/OnionDuke.B</span>) will decrypt an embedded configuration (shown below) and attempt to connect to hardcoded C&amp;C URLs specified in the configuration data. From these C&amp;Cs the malware may receive instructions to download and execute additional malicious components. It should be noted, that we believe all five domains contacted by the malware are innocent websites compromised by the malware operators, not dedicated malicious servers.<br /><br /><img border="0" src="https://www.f-secure.com/weblog/archives/conf1_red.png" alt="Screenshot of the embedded configuration data" height="300" width="650" /><br /><span style="font-style: italic;">A screenshot of the embedded configuration data</span><br /><br />Through our research, we have also been able to identify multiple other components of the OnionDuke malware family. We have, for instance, observed components dedicated to stealing login credentials from the victim machine and components dedicated to gathering further information on the compromised system like the presence of antivirus software or a firewall. Some of these components have been observed being downloaded and executed by the original backdoor process but for other components, we have yet to identify the infection vector. Most of these components don't embed their own C&amp;C information but rather communicate with their controllers through the original backdoor process.<br /><br />One component, however, is an interesting exception. This DLL file (SHA1 <span style="font-style: italic;">d433f281cf56015941a1c2cb87066ca62ea1db37</span>, detected as <span style="font-weight: bold;">Backdoor:W32/OnionDuke.A</span>) contains among its configuration data a different hardcoded C&amp;C domain, <span style="font-style: italic;">overpict.com</span> and also evidence suggesting that this component may abuse Twitter as an additional C&amp;C channel. What makes the <span style="font-style: italic;">overpict.com</span> domain interesting, is it was originally registered in 2011 with the alias of "<span style="font-style: italic;">John Kasai</span>". Within a two-week window, "<span style="font-style: italic;">John Kasai</span>" also registered the following domains: <span style="font-style: italic;">airtravelabroad.com, beijingnewsblog.net, grouptumbler.com, leveldelta.com, nasdaqblog.net, natureinhome.com, nestedmail.com, nostressjob.com, nytunion.com, oilnewsblog.com, sixsquare.net</span> and <span style="font-style: italic;">ustradecomp.com</span>. This is significant because the domains <span style="font-style: italic;">leveldelta.com</span> and <span style="font-style: italic;">grouptumbler.com</span> have previously been identified as C&amp;C domains used by MiniDuke. This strongly suggests that although OnionDuke and MiniDuke are two separate families of malware, the actors behind them are connected through the use of shared infrastructure.<br /><br /><img border="1" src="https://www.f-secure.com/weblog/archives/infrastructure.png" alt="A graph showing the infrastructure shared between OnionDuke and MiniDuke" height="406" width="650" /><br /><span style="font-style: italic;">A visualization of the infrastructure shared between OnionDuke and MiniDuke</span><br /><br />Based on compilation timestamps and discovery dates of samples we have observed, we believe the OnionDuke operators have been infecting downloaded executables at least since the end of October 2013. We also have evidence suggesting that, at least since February of 2014, OnionDuke has not only been spread by modifying downloaded executables but also by infecting executables in .torrent files containing pirated software. However, it would seem that the  OnionDuke family is much older, both based on older compilation timestamps and also on the fact that some of the embedded configuration data make reference to an apparent version number of 4 suggesting that at least three earlier versions of the family exist.<br /><br />During our research, we have also uncovered strong evidence suggesting that OnionDuke has been used in targeted attacks against European government agencies, although we have so far been unable to identify the infection vector(s). Interestingly, this would suggest two very different targeting strategies. On one hand is the "<span style="font-style: italic;">shooting a fly with a cannon</span>" mass-infection strategy through modified binaries and, on the other, the more surgical targeting traditionally associated with APT operations.<br /><br />In any case, although much is still shrouded in mystery and speculation, one thing is certain. While using Tor may help you stay anonymous, it does at the same time paint a huge target on your back. It's never a good idea to download binaries via Tor (or anything else) without encryption. The problem with Tor is that you have no idea who is maintaining the exit node you are using and what their motives are. VPNs (such as our <a href="https://www.f-secure.com/en/web/home_global/freedome">Freedome VPN</a>) will encrypt your connection all the way through the Tor network, so the maintainers of Tor exit nodes will not see your traffic and can't tamper with it.<br /><br />Samples:<br /><br />&nbsp;&nbsp;&bull;&nbsp;&nbsp;a75995f94854dea8799650a2f4a97980b71199d2<br />&nbsp;&nbsp;&bull;&nbsp;&nbsp;b491c14d8cfb48636f6095b7b16555e9a575d57f<br />&nbsp;&nbsp;&bull;&nbsp;&nbsp;d433f281cf56015941a1c2cb87066ca62ea1db37<br /><br />Detected as: <span style="font-weight: bold;">Trojan-Dropper:W32/OnionDuke.A</span>, <span style="font-weight: bold;">Backdoor:W32/OnionDuke.A</span>, and <span style="font-weight: bold;">Backdoor:W32/OnionDuke.B</span>.<br /><br />Post by &mdash; Artturi (<a href="https://www.twitter.com/lehtior2">@lehtior2</a>)</span><br><br><br><br><br></p></div>
						</td>
						</tr>
						</tbody>
						</table>
						</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</body>
</html>