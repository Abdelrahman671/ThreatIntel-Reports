<!DOCTYPE html>
<html class='v2' dir='ltr' lang='en' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/3566091532-css_bundle_v2.css' rel='stylesheet' type='text/css'/>
<meta content='width=1100' name='viewport'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='https://googleprojectzero.blogspot.com/favicon.ico' rel='icon' type='image/x-icon'/>
<link href='https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="Project Zero - Atom" href="https://googleprojectzero.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="Project Zero - RSS" href="https://googleprojectzero.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="Project Zero - Atom" href="https://www.blogger.com/feeds/4838136820032157985/posts/default" />

<link rel="alternate" type="application/atom+xml" title="Project Zero - Atom" href="https://googleprojectzero.blogspot.com/feeds/7918586333811798677/comments/default" />
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<meta content='https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html' property='og:url'/>
<meta content='The Qualcomm DSP Driver - Unexpectedly Excavating an Exploit' property='og:title'/>
<meta content='Posted by Seth Jenkins, Google Project Zero This blog post provides a technical analysis of exploit artifacts provided to us by Google&#39;s Thr...' property='og:description'/>
<title>Project Zero: The Qualcomm DSP Driver - Unexpectedly Excavating an Exploit</title>
<style type='text/css'>@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:normal;font-display:swap;src:url(//fonts.gstatic.com/s/opensans/v40/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4gaVc.ttf)format('truetype');}</style>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Simple
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */
/* Variable definitions
====================
<Variable name="keycolor" description="Main Color" type="color" default="#66bbdd"/>
<Group description="Page Text" selector="body">
<Variable name="body.font" description="Font" type="font"
default="normal normal 12px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/>
<Variable name="body.text.color" description="Text Color" type="color" default="#222222"/>
</Group>
<Group description="Backgrounds" selector=".body-fauxcolumns-outer">
<Variable name="body.background.color" description="Outer Background" type="color" default="#66bbdd"/>
<Variable name="content.background.color" description="Main Background" type="color" default="#ffffff"/>
<Variable name="header.background.color" description="Header Background" type="color" default="transparent"/>
</Group>
<Group description="Links" selector=".main-outer">
<Variable name="link.color" description="Link Color" type="color" default="#2288bb"/>
<Variable name="link.visited.color" description="Visited Color" type="color" default="#888888"/>
<Variable name="link.hover.color" description="Hover Color" type="color" default="#33aaff"/>
</Group>
<Group description="Blog Title" selector=".header h1">
<Variable name="header.font" description="Font" type="font"
default="normal normal 60px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/>
<Variable name="header.text.color" description="Title Color" type="color" default="#3399bb" />
</Group>
<Group description="Blog Description" selector=".header .description">
<Variable name="description.text.color" description="Description Color" type="color"
default="#777777" />
</Group>
<Group description="Tabs Text" selector=".tabs-inner .widget li a">
<Variable name="tabs.font" description="Font" type="font"
default="normal normal 14px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/>
<Variable name="tabs.text.color" description="Text Color" type="color" default="#999999"/>
<Variable name="tabs.selected.text.color" description="Selected Color" type="color" default="#000000"/>
</Group>
<Group description="Tabs Background" selector=".tabs-outer .PageList">
<Variable name="tabs.background.color" description="Background Color" type="color" default="#f5f5f5"/>
<Variable name="tabs.selected.background.color" description="Selected Color" type="color" default="#eeeeee"/>
</Group>
<Group description="Post Title" selector="h3.post-title, .comments h4">
<Variable name="post.title.font" description="Font" type="font"
default="normal normal 22px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/>
</Group>
<Group description="Date Header" selector=".date-header">
<Variable name="date.header.color" description="Text Color" type="color"
default="#000000"/>
<Variable name="date.header.background.color" description="Background Color" type="color"
default="transparent"/>
<Variable name="date.header.font" description="Text Font" type="font"
default="normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/>
<Variable name="date.header.padding" description="Date Header Padding" type="string" default="inherit"/>
<Variable name="date.header.letterspacing" description="Date Header Letter Spacing" type="string" default="inherit"/>
<Variable name="date.header.margin" description="Date Header Margin" type="string" default="inherit"/>
</Group>
<Group description="Post Footer" selector=".post-footer">
<Variable name="post.footer.text.color" description="Text Color" type="color" default="#666666"/>
<Variable name="post.footer.background.color" description="Background Color" type="color"
default="#f9f9f9"/>
<Variable name="post.footer.border.color" description="Shadow Color" type="color" default="#eeeeee"/>
</Group>
<Group description="Gadgets" selector="h2">
<Variable name="widget.title.font" description="Title Font" type="font"
default="normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/>
<Variable name="widget.title.text.color" description="Title Color" type="color" default="#000000"/>
<Variable name="widget.alternate.text.color" description="Alternate Color" type="color" default="#999999"/>
</Group>
<Group description="Images" selector=".main-inner">
<Variable name="image.background.color" description="Background Color" type="color" default="#ffffff"/>
<Variable name="image.border.color" description="Border Color" type="color" default="#eeeeee"/>
<Variable name="image.text.color" description="Caption Text Color" type="color" default="#000000"/>
</Group>
<Group description="Accents" selector=".content-inner">
<Variable name="body.rule.color" description="Separator Line Color" type="color" default="#eeeeee"/>
<Variable name="tabs.border.color" description="Tabs Border Color" type="color" default="transparent"/>
</Group>
<Variable name="body.background" description="Body Background" type="background"
color="#eeeeee" default="$(color) none repeat scroll top left"/>
<Variable name="body.background.override" description="Body Background Override" type="string" default=""/>
<Variable name="body.background.gradient.cap" description="Body Gradient Cap" type="url"
default="url(https://resources.blogblog.com/blogblog/data/1kt/simple/gradients_light.png)"/>
<Variable name="body.background.gradient.tile" description="Body Gradient Tile" type="url"
default="url(https://resources.blogblog.com/blogblog/data/1kt/simple/body_gradient_tile_light.png)"/>
<Variable name="content.background.color.selector" description="Content Background Color Selector" type="string" default=".content-inner"/>
<Variable name="content.padding" description="Content Padding" type="length" default="10px" min="0" max="100px"/>
<Variable name="content.padding.horizontal" description="Content Horizontal Padding" type="length" default="10px" min="0" max="100px"/>
<Variable name="content.shadow.spread" description="Content Shadow Spread" type="length" default="40px" min="0" max="100px"/>
<Variable name="content.shadow.spread.webkit" description="Content Shadow Spread (WebKit)" type="length" default="5px" min="0" max="100px"/>
<Variable name="content.shadow.spread.ie" description="Content Shadow Spread (IE)" type="length" default="10px" min="0" max="100px"/>
<Variable name="main.border.width" description="Main Border Width" type="length" default="0" min="0" max="10px"/>
<Variable name="header.background.gradient" description="Header Gradient" type="url" default="none"/>
<Variable name="header.shadow.offset.left" description="Header Shadow Offset Left" type="length" default="-1px" min="-50px" max="50px"/>
<Variable name="header.shadow.offset.top" description="Header Shadow Offset Top" type="length" default="-1px" min="-50px" max="50px"/>
<Variable name="header.shadow.spread" description="Header Shadow Spread" type="length" default="1px" min="0" max="100px"/>
<Variable name="header.padding" description="Header Padding" type="length" default="30px" min="0" max="100px"/>
<Variable name="header.border.size" description="Header Border Size" type="length" default="1px" min="0" max="10px"/>
<Variable name="header.bottom.border.size" description="Header Bottom Border Size" type="length" default="1px" min="0" max="10px"/>
<Variable name="header.border.horizontalsize" description="Header Horizontal Border Size" type="length" default="0" min="0" max="10px"/>
<Variable name="description.text.size" description="Description Text Size" type="string" default="140%"/>
<Variable name="tabs.margin.top" description="Tabs Margin Top" type="length" default="0" min="0" max="100px"/>
<Variable name="tabs.margin.side" description="Tabs Side Margin" type="length" default="30px" min="0" max="100px"/>
<Variable name="tabs.background.gradient" description="Tabs Background Gradient" type="url"
default="url(https://resources.blogblog.com/blogblog/data/1kt/simple/gradients_light.png)"/>
<Variable name="tabs.border.width" description="Tabs Border Width" type="length" default="1px" min="0" max="10px"/>
<Variable name="tabs.bevel.border.width" description="Tabs Bevel Border Width" type="length" default="1px" min="0" max="10px"/>
<Variable name="post.margin.bottom" description="Post Bottom Margin" type="length" default="25px" min="0" max="100px"/>
<Variable name="image.border.small.size" description="Image Border Small Size" type="length" default="2px" min="0" max="10px"/>
<Variable name="image.border.large.size" description="Image Border Large Size" type="length" default="5px" min="0" max="10px"/>
<Variable name="page.width.selector" description="Page Width Selector" type="string" default=".region-inner"/>
<Variable name="page.width" description="Page Width" type="string" default="auto"/>
<Variable name="main.section.margin" description="Main Section Margin" type="length" default="15px" min="0" max="100px"/>
<Variable name="main.padding" description="Main Padding" type="length" default="15px" min="0" max="100px"/>
<Variable name="main.padding.top" description="Main Padding Top" type="length" default="30px" min="0" max="100px"/>
<Variable name="main.padding.bottom" description="Main Padding Bottom" type="length" default="30px" min="0" max="100px"/>
<Variable name="paging.background"
color="#ffffff"
description="Background of blog paging area" type="background"
default="transparent none no-repeat scroll top center"/>
<Variable name="footer.bevel" description="Bevel border length of footer" type="length" default="0" min="0" max="10px"/>
<Variable name="mobile.background.overlay" description="Mobile Background Overlay" type="string"
default="transparent none repeat scroll top left"/>
<Variable name="mobile.background.size" description="Mobile Background Size" type="string" default="auto"/>
<Variable name="mobile.button.color" description="Mobile Button Color" type="color" default="#ffffff" />
<Variable name="startSide" description="Side where text starts in blog language" type="automatic" default="left"/>
<Variable name="endSide" description="Side where text ends in blog language" type="automatic" default="right"/>
*/
/* Content
----------------------------------------------- */
body {
font: normal normal 12px Open Sans;
color: #000000;
background: #eeeeee none repeat scroll top left;
padding: 0 0 0 0;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
h2 {
font-size: 22px;
}
a:link {
text-decoration:none;
color: #2288bb;
}
a:visited {
text-decoration:none;
color: #888888;
}
a:hover {
text-decoration:underline;
color: #33aaff;
}
.body-fauxcolumn-outer .fauxcolumn-inner {
background: transparent none repeat scroll top left;
_background-image: none;
}
.body-fauxcolumn-outer .cap-top {
position: absolute;
z-index: 1;
height: 400px;
width: 100%;
}
.body-fauxcolumn-outer .cap-top .cap-left {
width: 100%;
background: transparent none repeat-x scroll top left;
_background-image: none;
}
.content-outer {
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 0 #333333;
box-shadow: 0 0 0 rgba(0, 0, 0, .15);
margin-bottom: 1px;
}
.content-inner {
padding: 10px 40px;
}
.content-inner {
background-color: #ffffff;
}
/* Header
----------------------------------------------- */
.header-outer {
background: transparent none repeat-x scroll 0 -400px;
_background-image: none;
}
.Header h1 {
font: normal normal 40px Open Sans;
color: #000000;
text-shadow: 0 0 0 rgba(0, 0, 0, .2);
}
.Header h1 a {
color: #000000;
}
.Header .description {
font-size: 18px;
color: #000000;
}
.header-inner .Header .titlewrapper {
padding: 22px 0;
}
.header-inner .Header .descriptionwrapper {
padding: 0 0;
}
/* Tabs
----------------------------------------------- */
.tabs-inner .section:first-child {
border-top: 0 solid #dddddd;
}
.tabs-inner .section:first-child ul {
margin-top: -1px;
border-top: 1px solid #dddddd;
border-left: 1px solid #dddddd;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget ul {
background: transparent none repeat-x scroll 0 -800px;
_background-image: none;
border-bottom: 1px solid #dddddd;
margin-top: 0;
margin-left: -30px;
margin-right: -30px;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .6em 1em;
font: normal normal 12px Open Sans;
color: #000000;
border-left: 1px solid #ffffff;
border-right: 1px solid #dddddd;
}
.tabs-inner .widget li:first-child a {
border-left: none;
}
.tabs-inner .widget li.selected a, .tabs-inner .widget li a:hover {
color: #000000;
background-color: #eeeeee;
text-decoration: none;
}
/* Columns
----------------------------------------------- */
.main-outer {
border-top: 0 solid transparent;
}
.fauxcolumn-left-outer .fauxcolumn-inner {
border-right: 1px solid transparent;
}
.fauxcolumn-right-outer .fauxcolumn-inner {
border-left: 1px solid transparent;
}
/* Headings
----------------------------------------------- */
div.widget > h2,
div.widget h2.title {
margin: 0 0 1em 0;
font: normal bold 11px 'Trebuchet MS',Trebuchet,Verdana,sans-serif;
color: #000000;
}
/* Widgets
----------------------------------------------- */
.widget .zippy {
color: #999999;
text-shadow: 2px 2px 1px rgba(0, 0, 0, .1);
}
.widget .popular-posts ul {
list-style: none;
}
/* Posts
----------------------------------------------- */
h2.date-header {
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
}
.date-header span {
background-color: #bbbbbb;
color: #ffffff;
padding: 0.4em;
letter-spacing: 3px;
margin: inherit;
}
.main-inner {
padding-top: 35px;
padding-bottom: 65px;
}
.main-inner .column-center-inner {
padding: 0 0;
}
.main-inner .column-center-inner .section {
margin: 0 1em;
}
.post {
margin: 0 0 45px 0;
}
h3.post-title, .comments h4 {
font: normal normal 22px Open Sans;
margin: .75em 0 0;
}
.post-body {
font-size: 110%;
line-height: 1.4;
position: relative;
}
.post-body img, .post-body .tr-caption-container, .Profile img, .Image img,
.BlogList .item-thumbnail img {
padding: 2px;
background: #ffffff;
border: 1px solid #eeeeee;
-moz-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
-webkit-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
}
.post-body img, .post-body .tr-caption-container {
padding: 5px;
}
.post-body .tr-caption-container {
color: #666666;
}
.post-body .tr-caption-container img {
padding: 0;
background: transparent;
border: none;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
box-shadow: 0 0 0 rgba(0, 0, 0, .1);
}
.post-header {
margin: 0 0 1.5em;
line-height: 1.6;
font-size: 90%;
}
.post-footer {
margin: 20px -2px 0;
padding: 5px 10px;
color: #666666;
background-color: #eeeeee;
border-bottom: 1px solid #eeeeee;
line-height: 1.6;
font-size: 90%;
}
#comments .comment-author {
padding-top: 1.5em;
border-top: 1px solid transparent;
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
#comments .avatar-image-container img {
border: 1px solid #eeeeee;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #999999;
border-bottom: 1px solid #999999;
}
.comments .comment-thread.inline-thread {
background-color: #eeeeee;
}
.comments .continue {
border-top: 2px solid #999999;
}
/* Accents
---------------------------------------------- */
.section-columns td.columns-cell {
border-left: 1px solid transparent;
}
.blog-pager {
background: transparent url(//www.blogblog.com/1kt/simple/paging_dot.png) repeat-x scroll top center;
}
.blog-pager-older-link, .home-link,
.blog-pager-newer-link {
background-color: #ffffff;
padding: 5px;
}
.footer-outer {
border-top: 1px dashed #bbbbbb;
}
/* Mobile
----------------------------------------------- */
body.mobile  {
background-size: auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
.mobile .body-fauxcolumn-outer .cap-top {
background-size: 100% auto;
}
.mobile .content-outer {
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
}
.mobile .tabs-inner .widget ul {
margin-left: 0;
margin-right: 0;
}
.mobile .post {
margin: 0;
}
.mobile .main-inner .column-center-inner .section {
margin: 0;
}
.mobile .date-header span {
padding: 0.1em 10px;
margin: 0 -10px;
}
.mobile h3.post-title {
margin: 0;
}
.mobile .blog-pager {
background: transparent none no-repeat scroll top center;
}
.mobile .footer-outer {
border-top: none;
}
.mobile .main-inner, .mobile .footer-inner {
background-color: #ffffff;
}
.mobile-index-contents {
color: #000000;
}
.mobile-link-button {
background-color: #2288bb;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile .tabs-inner .section:first-child {
border-top: none;
}
.mobile .tabs-inner .PageList .widget-content {
background-color: #eeeeee;
color: #000000;
border-top: 1px solid #dddddd;
border-bottom: 1px solid #dddddd;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #dddddd;
}

--></style>
<style id='template-skin-1' type='text/css'><!--
body {
min-width: 1120px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1120px;
max-width: 1120px;
_width: 1120px;
}
.main-inner .columns {
padding-left: 0;
padding-right: 310px;
}
.main-inner .fauxcolumn-center-outer {
left: 0;
right: 310px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0") -
parseInt("310px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0;
}
.main-inner .fauxcolumn-right-outer {
width: 310px;
}
.main-inner .column-left-outer {
width: 0;
right: 100%;
margin-left: -0;
}
.main-inner .column-right-outer {
width: 310px;
margin-right: -310px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
body#layout div.add_widget {
padding: 8px;
}
body#layout div.add_widget a {
margin-left: 32px;
}
--></style>
<script type='text/javascript'>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-240546891-1', 'auto', 'blogger');
        ga('blogger.send', 'pageview');
      </script>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=4838136820032157985&amp;zx=9f5f0e5b-beb0-4ee7-a5de-babe08d75627' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=4838136820032157985&amp;zx=9f5f0e5b-beb0-4ee7-a5de-babe08d75627' rel='stylesheet'/></noscript>
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>

</head>
<body class='loading'>
<div class='navbar section' id='navbar' name='Navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d4838136820032157985\x26blogName\x3dProject+Zero\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dLIGHT\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttps://googleprojectzero.blogspot.com/search\x26blogLocale\x3den\x26v\x3d2\x26homepageUrl\x3dhttps://googleprojectzero.blogspot.com/\x26targetPostID\x3d7918586333811798677\x26blogPostOrPageUrl\x3dhttps://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html\x26vt\x3d-7393914276315961640',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe",
              messageHandlersFilter: gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER,
              messageHandlers: {
                'blogger-ping': function() {}
              }
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div class='body-fauxcolumns'>
<div class='fauxcolumn-outer body-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content'>
<div class='content-fauxcolumns'>
<div class='fauxcolumn-outer content-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content-outer'>
<div class='content-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left content-fauxborder-left'>
<div class='fauxborder-right content-fauxborder-right'></div>
<div class='content-inner'>
<header>
<div class='header-outer'>
<div class='header-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left header-fauxborder-left'>
<div class='fauxborder-right header-fauxborder-right'></div>
<div class='region-inner header-inner'>
<div class='header section' id='header' name='Header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
<a href='https://googleprojectzero.blogspot.com/'>
Project Zero
</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span>News and updates from the Project Zero team at Google</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class='header-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</header>
<div class='tabs-outer'>
<div class='tabs-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left tabs-fauxborder-left'>
<div class='fauxborder-right tabs-fauxborder-right'></div>
<div class='region-inner tabs-inner'>
<div class='tabs no-items section' id='crosscol' name='Cross-Column'></div>
<div class='tabs no-items section' id='crosscol-overflow' name='Cross-Column 2'></div>
</div>
</div>
<div class='tabs-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='main-outer'>
<div class='main-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left main-fauxborder-left'>
<div class='fauxborder-right main-fauxborder-right'></div>
<div class='region-inner main-inner'>
<div class='columns fauxcolumns'>
<div class='fauxcolumn-outer fauxcolumn-center-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-left-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-right-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class='columns-inner'>
<div class='column-center-outer'>
<div class='column-center-inner'>
<div class='main section' id='main' name='Main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Sunday, December 15, 2024</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='4838136820032157985' itemprop='blogId'/>
<meta content='7918586333811798677' itemprop='postId'/>
<a name='7918586333811798677'></a>
<h3 class='post-title entry-title' itemprop='name'>
The Qualcomm DSP Driver - Unexpectedly Excavating an Exploit
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-7918586333811798677' itemprop='description articleBody'>
<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=XGMkxXUZTA64h2imyzu79g);.lst-kix_mz24o9o07kqy-1>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-1}.lst-kix_d27lror3sq5g-6>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-6,decimal) ". "}.lst-kix_d27lror3sq5g-7>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-7,lower-latin) ". "}ol.lst-kix_d27lror3sq5g-5.start{counter-reset:lst-ctn-kix_d27lror3sq5g-5 0}.lst-kix_d27lror3sq5g-4>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-4,lower-latin) ". "}.lst-kix_d27lror3sq5g-5>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-5,lower-roman) ". "}.lst-kix_d27lror3sq5g-8>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-8,lower-roman) ". "}ul.lst-kix_klp6u7xplfnr-0{list-style-type:none}ul.lst-kix_klp6u7xplfnr-1{list-style-type:none}.lst-kix_d27lror3sq5g-3>li{counter-increment:lst-ctn-kix_d27lror3sq5g-3}ol.lst-kix_d27lror3sq5g-2.start{counter-reset:lst-ctn-kix_d27lror3sq5g-2 0}ol.lst-kix_mz24o9o07kqy-6.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-6 0}.lst-kix_klp6u7xplfnr-4>li:before{content:"\0025cb   "}.lst-kix_klp6u7xplfnr-3>li:before{content:"\0025cf   "}.lst-kix_klp6u7xplfnr-5>li:before{content:"\0025a0   "}ol.lst-kix_mz24o9o07kqy-3.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-3 0}.lst-kix_d27lror3sq5g-8>li{counter-increment:lst-ctn-kix_d27lror3sq5g-8}ol.lst-kix_d27lror3sq5g-1.start{counter-reset:lst-ctn-kix_d27lror3sq5g-1 0}.lst-kix_klp6u7xplfnr-8>li:before{content:"\0025a0   "}.lst-kix_klp6u7xplfnr-7>li:before{content:"\0025cb   "}.lst-kix_klp6u7xplfnr-6>li:before{content:"\0025cf   "}.lst-kix_mz24o9o07kqy-7>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-7}.lst-kix_d27lror3sq5g-2>li{counter-increment:lst-ctn-kix_d27lror3sq5g-2}ol.lst-kix_mz24o9o07kqy-0.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-0 0}ol.lst-kix_mz24o9o07kqy-7.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-7 0}ol.lst-kix_mz24o9o07kqy-3{list-style-type:none}ol.lst-kix_mz24o9o07kqy-4{list-style-type:none}.lst-kix_klp6u7xplfnr-1>li:before{content:"\0025cb   "}ol.lst-kix_mz24o9o07kqy-1{list-style-type:none}ol.lst-kix_mz24o9o07kqy-2{list-style-type:none}.lst-kix_klp6u7xplfnr-2>li:before{content:"\0025a0   "}.lst-kix_mz24o9o07kqy-3>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-3}ol.lst-kix_mz24o9o07kqy-7{list-style-type:none}.lst-kix_mz24o9o07kqy-0>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-0}ol.lst-kix_mz24o9o07kqy-8{list-style-type:none}ol.lst-kix_mz24o9o07kqy-5{list-style-type:none}ol.lst-kix_mz24o9o07kqy-6{list-style-type:none}ol.lst-kix_d27lror3sq5g-8.start{counter-reset:lst-ctn-kix_d27lror3sq5g-8 0}ol.lst-kix_mz24o9o07kqy-0{list-style-type:none}.lst-kix_mz24o9o07kqy-6>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-6}.lst-kix_klp6u7xplfnr-0>li:before{content:"\0025cf   "}ul.lst-kix_klp6u7xplfnr-2{list-style-type:none}ul.lst-kix_klp6u7xplfnr-3{list-style-type:none}ul.lst-kix_klp6u7xplfnr-4{list-style-type:none}ul.lst-kix_klp6u7xplfnr-5{list-style-type:none}ul.lst-kix_klp6u7xplfnr-6{list-style-type:none}ol.lst-kix_mz24o9o07kqy-4.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-4 0}ul.lst-kix_klp6u7xplfnr-7{list-style-type:none}ul.lst-kix_klp6u7xplfnr-8{list-style-type:none}.lst-kix_d27lror3sq5g-0>li{counter-increment:lst-ctn-kix_d27lror3sq5g-0}ol.lst-kix_d27lror3sq5g-7.start{counter-reset:lst-ctn-kix_d27lror3sq5g-7 0}ol.lst-kix_mz24o9o07kqy-1.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-1 0}.lst-kix_d27lror3sq5g-6>li{counter-increment:lst-ctn-kix_d27lror3sq5g-6}.lst-kix_d27lror3sq5g-5>li{counter-increment:lst-ctn-kix_d27lror3sq5g-5}ol.lst-kix_d27lror3sq5g-4.start{counter-reset:lst-ctn-kix_d27lror3sq5g-4 0}.lst-kix_mz24o9o07kqy-4>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-4}ol.lst-kix_mz24o9o07kqy-8.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-8 0}.lst-kix_d27lror3sq5g-7>li{counter-increment:lst-ctn-kix_d27lror3sq5g-7}ol.lst-kix_d27lror3sq5g-8{list-style-type:none}.lst-kix_mz24o9o07kqy-1>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-1,lower-latin) ". "}ol.lst-kix_d27lror3sq5g-6{list-style-type:none}ol.lst-kix_d27lror3sq5g-6.start{counter-reset:lst-ctn-kix_d27lror3sq5g-6 0}.lst-kix_mz24o9o07kqy-0>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-0,decimal) ". "}.lst-kix_mz24o9o07kqy-2>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-2,lower-roman) ". "}ol.lst-kix_d27lror3sq5g-7{list-style-type:none}.lst-kix_d27lror3sq5g-1>li{counter-increment:lst-ctn-kix_d27lror3sq5g-1}.lst-kix_mz24o9o07kqy-3>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-3,decimal) ". "}.lst-kix_d27lror3sq5g-4>li{counter-increment:lst-ctn-kix_d27lror3sq5g-4}.lst-kix_mz24o9o07kqy-5>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-5}ol.lst-kix_mz24o9o07kqy-5.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-5 0}ol.lst-kix_mz24o9o07kqy-2.start{counter-reset:lst-ctn-kix_mz24o9o07kqy-2 0}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_mz24o9o07kqy-8>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-8}ol.lst-kix_d27lror3sq5g-3.start{counter-reset:lst-ctn-kix_d27lror3sq5g-3 0}.lst-kix_mz24o9o07kqy-8>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-8,lower-roman) ". "}.lst-kix_mz24o9o07kqy-7>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-7,lower-latin) ". "}.lst-kix_d27lror3sq5g-0>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-0,decimal) ". "}.lst-kix_d27lror3sq5g-1>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-1,lower-latin) ". "}.lst-kix_mz24o9o07kqy-2>li{counter-increment:lst-ctn-kix_mz24o9o07kqy-2}ol.lst-kix_d27lror3sq5g-0{list-style-type:none}.lst-kix_mz24o9o07kqy-5>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-5,lower-roman) ". "}ol.lst-kix_d27lror3sq5g-1{list-style-type:none}.lst-kix_d27lror3sq5g-2>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-2,lower-roman) ". "}.lst-kix_d27lror3sq5g-3>li:before{content:"" counter(lst-ctn-kix_d27lror3sq5g-3,decimal) ". "}.lst-kix_mz24o9o07kqy-4>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-4,lower-latin) ". "}.lst-kix_mz24o9o07kqy-6>li:before{content:"" counter(lst-ctn-kix_mz24o9o07kqy-6,decimal) ". "}ol.lst-kix_d27lror3sq5g-4{list-style-type:none}ol.lst-kix_d27lror3sq5g-5{list-style-type:none}ol.lst-kix_d27lror3sq5g-2{list-style-type:none}ol.lst-kix_d27lror3sq5g-0.start{counter-reset:lst-ctn-kix_d27lror3sq5g-0 0}ol.lst-kix_d27lror3sq5g-3{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c3{padding-top:12pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c26{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c27{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c15{padding-top:14pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c10{color:#188038;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Roboto Mono";font-style:normal}.c33{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c2{font-size:9pt;font-family:"Roboto Mono";color:#188038;font-weight:400}.c17{color:#434343;font-weight:400;font-size:14pt;font-family:"Arial"}.c1{font-size:9pt;font-family:"Roboto Mono";color:#37474f;font-weight:400}.c0{font-size:9pt;font-family:"Roboto Mono";color:#1967d2;font-weight:400}.c7{color:#b80672;text-decoration:none;vertical-align:baseline;font-style:normal}.c6{color:#000000;text-decoration:none;vertical-align:baseline;font-style:normal}.c24{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c29{color:#000000;text-decoration:none;vertical-align:baseline}.c30{font-weight:400;font-size:16pt;font-family:"Arial"}.c4{font-size:9pt;font-weight:400;font-family:"Roboto Mono"}.c22{font-weight:400;font-size:12pt;font-family:"Arial"}.c11{text-decoration:none;vertical-align:baseline;font-style:normal}.c31{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c13{font-weight:400;font-size:11pt;font-family:"Arial"}.c34{font-weight:400;font-size:26pt;font-family:"Arial"}.c8{font-weight:400;font-family:"Courier New"}.c21{margin-left:36pt;padding-left:0pt}.c9{color:#9334e6}.c28{font-style:italic}.c23{margin-left:36pt}.c19{color:#666666}.c32{color:#999999}.c25{color:#b80672}.c12{height:11pt}.c18{text-indent:36pt}.c16{font-size:11pt}.c14{color:#c5221f}.c20{font-weight:700}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c31 doc-content"><p class="c5 c12"><span class="c11 c13 c32"></span></p><p class="c5"><span class="c32">Posted by Seth Jenkins, Google Project Zero</span></p><p class="c5 c12"><span class="c29 c13 c28"></span></p><p class="c5"><span class="c28">This blog post provides a technical analysis of exploit artifacts provided to us by Google&#39;s Threat Analysis Group (TAG) from Amnesty International. Amnesty&rsquo;s report on these exploits is available </span><span class="c24 c28"><a href="https://securitylab.amnesty.org/latest/2024/12/a-digital-prison-surveillance-and-the-suppression-of-civil-society-in-serbia/">here</a></span><span>. </span><span class="c28">Thanks to both Amnesty International and Google&#39;s Threat Analysis Group for providing the artifacts and collaborating on the subsequent technical analysis!</span></p><h2 class="c26" id="h.9g2ubqaw4j4x"><span class="c6 c30">Introduction</span></h2><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>Earlier this year, Google&#39;s TAG received some kernel panic logs generated by an In-the-Wild (ITW) exploit. Those logs kicked off a bug hunt that led to the discovery of 6 vulnerabilities in </span><span>one Qualcomm driver</span><span>&nbsp;over the course of 2.5 months, </span><span>including one issue that TAG reported as ITW</span><span class="c6 c13">. This blog post covers the details of the original artifacts, each of the bugs discovered, and the hypothesized ITW exploit strategy gleaned from the logs.</span></p><h2 class="c26" id="h.7paatm2vk7xg"><span class="c6 c30">Artifacts</span></h2><p class="c5"><span>Usually when successfully reverse-engineering an ITW exploit, Project Zero/</span><span>TAG</span><span class="c6 c13">&nbsp;have had access to the exploit sample itself, making determining what vulnerability was exploited primarily a matter of time and effort. However, in this particular case, we received several kernel panic logs but unfortunately not the exploit sample. This meant we could not directly reproduce crashes or reverse engineer what bug was being exploited.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span class="c6 c13">Accurately determining what vulnerability an exploit uses working only off of crash logs and without the exploit itself can range in difficulty from highly plausible to impossible. I decided to give it a try and see what I could learn. Out of the 6 panics we received, 4 panics in particular contained potentially useful information:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><h5 class="c3" id="h.cb4inbow4sw8"><span class="c11 c13 c19">Log 1:</span></h5><p class="c5"><span></span><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">47.223480]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_init_process:</span><span class="c4">&nbsp;</span><span class="c2">untrusted</span><span class="c4">&nbsp;</span><span class="c2">app</span><span class="c4">&nbsp;</span><span class="c2">trying</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">attach</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">privileged</span><span class="c4">&nbsp;</span><span class="c2">DSP</span><span class="c4">&nbsp;</span><span class="c2">PD</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">47.254494]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0xffffffffffffffff,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">47.254512]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">falcon:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_internal_mmap:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:</span><span class="c4">&nbsp;</span><span class="c2">adding</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">allocated</span><span class="c4">&nbsp;</span><span class="c2">pages</span><span class="c4">&nbsp;</span><span class="c2">is</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">supported</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">47.261488]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xa,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0x0,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0x0</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865579]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">NULL</span><span class="c4">&nbsp;</span><span class="c2">pointer</span><span class="c4">&nbsp;</span><span class="c2">dereference</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865586]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865590]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000006</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865593]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">Exception</span><span class="c4">&nbsp;</span><span class="c2">class</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865597]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865600]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865603]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865606]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000006</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865609]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865614]</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">pgtable:</span><span class="c4">&nbsp;</span><span class="c2">4k</span><span class="c4">&nbsp;</span><span class="c2">pages,</span><span class="c4">&nbsp;</span><span class="c2">39-bit</span><span class="c4">&nbsp;</span><span class="c2">VAs,</span><span class="c4">&nbsp;</span><span class="c2">pgdp</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">00000000f66703d3</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865617]</span><span class="c4">&nbsp;</span><span class="c2">[0000000000000000]</span><span class="c4">&nbsp;</span><span class="c2">pgd=0000000213147003,</span><span class="c4">&nbsp;</span><span class="c2">pud=0000000213147003,</span><span class="c4">&nbsp;</span><span class="c2">pmd=0000000000000000</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865624]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000006</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865649]</span><span class="c4">&nbsp;</span><span class="c2">Process</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">(pid:</span><span class="c4">&nbsp;</span><span class="c2">8909,</span><span class="c4">&nbsp;</span><span class="c2">stack</span><span class="c4">&nbsp;</span><span class="c2">limit</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x000000000e91af69)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865654]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">5</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">8909</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">W</span><span class="c4">&nbsp; </span><span class="c2">O</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">4.19.157-perf-g8779875ad741</span><span class="c4">&nbsp;</span><span class="c2">#1</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865657]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Qualcomm</span><span class="c4">&nbsp;</span><span class="c2">Technologies,</span><span class="c4">&nbsp;</span><span class="c2">Inc.</span><span class="c4">&nbsp;</span><span class="c2">xiaomi</span><span class="c4">&nbsp;</span><span class="c2">apollo</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865661]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">00400005</span><span class="c4">&nbsp;</span><span class="c2">(nzcv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865669]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">__list_del_entry_valid+0x34/0xd0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865672]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">dma_buf_detach+0x34/0xa0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865675]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff802c7bb990</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865735]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865739]</span><span class="c4">&nbsp; </span><span class="c2">__list_del_entry_valid+0x34/0xd0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865742]</span><span class="c4">&nbsp; </span><span class="c2">dma_buf_detach+0x34/0xa0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865746]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_mmap_free+0x3e8/0x4d0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865749]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_file_free+0x1a8/0x2e0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865753]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_device_release+0x50/0x68</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865757]</span><span class="c4">&nbsp; </span><span class="c2">__fput+0xb8/0x1b0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865762]</span><span class="c4">&nbsp; </span><span class="c2">____fput+0xc/0x18</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865764]</span><span class="c4">&nbsp; </span><span class="c2">task_work_run+0x8c/0xb0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865767]</span><span class="c4">&nbsp; </span><span class="c2">do_exit+0x3fc/0xa10</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865770]</span><span class="c4">&nbsp; </span><span class="c2">do_group_exit+0x8c/0xa0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865773]</span><span class="c4">&nbsp; </span><span class="c2">get_signal+0x7c8/0x958</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865778]</span><span class="c4">&nbsp; </span><span class="c2">do_notify_resume+0x148/0x23e8</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865781]</span><span class="c4">&nbsp; </span><span class="c2">work_pending+0x8/0x10</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865785]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">f9400669</span><span class="c4">&nbsp;</span><span class="c2">91040042</span><span class="c4">&nbsp;</span><span class="c2">eb02013f</span><span class="c4">&nbsp;</span><span class="c2">54000260</span><span class="c4">&nbsp;</span><span class="c2">(f9400122)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865789]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">42c589b65f43d4ee</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">50.865802]</span><span class="c4">&nbsp;</span><span class="c2">Kernel</span><span class="c4">&nbsp;</span><span class="c2">panic</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">syncing:</span><span class="c4">&nbsp;</span><span class="c2">Fatal</span><span class="c4">&nbsp;</span><span class="c2">exception</span></p><p class="c5"><span>We see right away from the first panic that the exploit appears to be targeting a driver called adsprpc. We also see from the stacktrace that the crash is happening when freeing a </span><span class="c8">fastrpc_mmap</span><span>&nbsp;struct - so it seems likely this is a heap exploit of some sort, and that a </span><span class="c8">fastrpc_mmap</span><span class="c6 c13">&nbsp;struct is potentially involved.</span></p><h5 class="c3" id="h.r5zalfh7d325"><span class="c11 c13 c19">Log 2:</span></h5><p class="c5"><span></span><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">37.450199]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_init_process:</span><span class="c4">&nbsp;</span><span class="c2">untrusted</span><span class="c4">&nbsp;</span><span class="c2">app</span><span class="c4">&nbsp;</span><span class="c2">trying</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">attach</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">privileged</span><span class="c4">&nbsp;</span><span class="c2">DSP</span><span class="c4">&nbsp;</span><span class="c2">PD</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">37.482741]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0xffffffffffffffff,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">37.482759]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">falcon:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_internal_mmap:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:</span><span class="c4">&nbsp;</span><span class="c2">adding</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">allocated</span><span class="c4">&nbsp;</span><span class="c2">pages</span><span class="c4">&nbsp;</span><span class="c2">is</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">supported</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">37.486210]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xa,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0x0,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0x0</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">40.917577]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702834303,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">41.970037]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702834303,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">51.052781]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702834303,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">73.964765]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702834303,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">83.030394]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702834303,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358103]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">paging</span><span class="c4">&nbsp;</span><span class="c2">request</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">0035fb968c5d536d</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358118]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358122]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000044</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358127]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">Exception</span><span class="c4">&nbsp;</span><span class="c2">class</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358131]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358135]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358139]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358143]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000044</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358147]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">1</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358151]</span><span class="c4">&nbsp;</span><span class="c2">[0035fb968c5d536d]</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">between</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">and</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">ranges</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358159]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000044</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358221]</span><span class="c4">&nbsp;</span><span class="c2">Process</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">(pid:</span><span class="c4">&nbsp;</span><span class="c2">7053,</span><span class="c4">&nbsp;</span><span class="c2">stack</span><span class="c4">&nbsp;</span><span class="c2">limit</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000000a7dfa97f)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358230]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">0</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">7053</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">O</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">4.19.157-perf-g8779875ad741</span><span class="c4">&nbsp;</span><span class="c2">#1</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358235]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Qualcomm</span><span class="c4">&nbsp;</span><span class="c2">Technologies,</span><span class="c4">&nbsp;</span><span class="c2">Inc.</span><span class="c4">&nbsp;</span><span class="c2">xiaomi</span><span class="c4">&nbsp;</span><span class="c2">apollo</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358241]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">60400005</span><span class="c4">&nbsp;</span><span class="c2">(nZCv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358259]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_file_free+0x1c4/0x2e0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358264]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_file_free+0x198/0x2e0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358268]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff80264d3a50</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358352]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358359]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_file_free+0x1c4/0x2e0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358364]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_device_release+0x50/0x68</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358374]</span><span class="c4">&nbsp; </span><span class="c2">__fput+0xb8/0x1b0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358380]</span><span class="c4">&nbsp; </span><span class="c2">____fput+0xc/0x18</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358387]</span><span class="c4">&nbsp; </span><span class="c2">task_work_run+0x8c/0xb0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358394]</span><span class="c4">&nbsp; </span><span class="c2">do_exit+0x3fc/0xa10</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358399]</span><span class="c4">&nbsp; </span><span class="c2">do_group_exit+0x8c/0xa0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358405]</span><span class="c4">&nbsp; </span><span class="c2">get_signal+0x7c8/0x958</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358412]</span><span class="c4">&nbsp; </span><span class="c2">do_notify_resume+0x148/0x23e8</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358418]</span><span class="c4">&nbsp; </span><span class="c2">work_pending+0x8/0x10</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358424]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">b4ffff68</span><span class="c4">&nbsp;</span><span class="c2">f9400009</span><span class="c4">&nbsp;</span><span class="c2">f9000109</span><span class="c4">&nbsp;</span><span class="c2">b4fffee9</span><span class="c4">&nbsp;</span><span class="c2">(f9000528)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358430]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">9b01c55ca2d0bfea</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">86.358452]</span><span class="c4">&nbsp;</span><span class="c2">Kernel</span><span class="c4">&nbsp;</span><span class="c2">panic</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">syncing:</span><span class="c4">&nbsp;</span><span class="c2">Fatal</span><span class="c4">&nbsp;</span><span class="c2">exception</span></p><p class="c5"><span>Here&rsquo;s another crash in the adsprpc driver, this time associated with a </span><span class="c8">fastrpc_file</span><span>&nbsp;struct which is associated with a </span><span class="c8">struct file</span><span>&nbsp;which itself is the backing object referenced by a file descriptor. We </span><span class="c20">also</span><span>&nbsp;see that the exploit appears to have gotten farther in the exploit process this time and was making multiple calls to </span><span class="c8">fastrpc_mmap_free</span><span>. Notably the channel id is set to this very large value: </span><span class="c8">1702834303</span><span>. Channel id&rsquo;s can&rsquo;t usually be set this high. While the maximum value varies from version to version, valid channel ids are in the range from 0 to about 6, so it&rsquo;s clear that there is somehow memory corruption of the channel id (</span><span class="c8">cid</span><span>). It is also notable that the channel id value is set to a Unix epoch timestamp value - something Donncha of Amnesty noticed in the course of investigation. </span><span class="c8">1702834303</span><span>&nbsp;represents the date Sunday, December 17, 2023 5:31:43 PM </span><span class="c6 c13">which is quite close to when the exploit was thrown&hellip;why could this be?</span></p><h5 class="c3" id="h.yqzvddyah23d"><span class="c11 c13 c19">Log 3:</span></h5><p class="c5"><span></span><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2244.639158]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_internal_mmap:</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">application</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">trying</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">map</span><span class="c4">&nbsp;</span><span class="c2">without</span><span class="c4">&nbsp;</span><span class="c2">initialization</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2244.641272]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">falcon:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_init_process:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:</span><span class="c4">&nbsp;</span><span class="c2">donated</span><span class="c4">&nbsp;</span><span class="c2">memory</span><span class="c4">&nbsp;</span><span class="c2">allocated</span><span class="c4">&nbsp;</span><span class="c2">in</span><span class="c4">&nbsp;</span><span class="c2">userspace</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2244.683779]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0xffffffffffffffff,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2244.683794]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">falcon:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_internal_mmap:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:</span><span class="c4">&nbsp;</span><span class="c2">adding</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">allocated</span><span class="c4">&nbsp;</span><span class="c2">pages</span><span class="c4">&nbsp;</span><span class="c2">is</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">supported</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2244.689633]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0x9,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0x0,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0x0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159424]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">paging</span><span class="c4">&nbsp;</span><span class="c2">request</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">006f7778a9cf5b88</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159442]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159446]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000004</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159453]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">Exception</span><span class="c4">&nbsp;</span><span class="c2">class</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159458]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159462]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159468]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159472]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000004</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159476]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159481]</span><span class="c4">&nbsp;</span><span class="c2">[006f7778a9cf5b88]</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">between</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">and</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">ranges</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159489]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000004</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159572]</span><span class="c4">&nbsp;</span><span class="c2">Process</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">(pid:</span><span class="c4">&nbsp;</span><span class="c2">17512,</span><span class="c4">&nbsp;</span><span class="c2">stack</span><span class="c4">&nbsp;</span><span class="c2">limit</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000000c911fea5)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159582]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">0</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">17512</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">W</span><span class="c4">&nbsp; </span><span class="c2">O</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">4.19.157-perf-g8779875ad741</span><span class="c4">&nbsp;</span><span class="c2">#1</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159587]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Qualcomm</span><span class="c4">&nbsp;</span><span class="c2">Technologies,</span><span class="c4">&nbsp;</span><span class="c2">Inc.</span><span class="c4">&nbsp;</span><span class="c2">xiaomi</span><span class="c4">&nbsp;</span><span class="c2">apollo</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159595]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">60400005</span><span class="c4">&nbsp;</span><span class="c2">(nZCv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159614]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">__kmalloc+0x1c4/0x398</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159619]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">__kmalloc+0x60/0x398</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159623]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8029173b80</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159719]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159727]</span><span class="c4">&nbsp; </span><span class="c2">__kmalloc+0x1c4/0x398</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159740]</span><span class="c4">&nbsp; </span><span class="c2">inotify_handle_event+0xc8/0x1c8</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159746]</span><span class="c4">&nbsp; </span><span class="c2">fsnotify+0x270/0x378</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159753]</span><span class="c4">&nbsp; </span><span class="c2">__fsnotify_parent+0xdc/0x138</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159763]</span><span class="c4">&nbsp; </span><span class="c2">notify_change2+0x314/0x348</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159771]</span><span class="c4">&nbsp; </span><span class="c2">do_sys_ftruncate+0x190/0x1c0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159776]</span><span class="c4">&nbsp; </span><span class="c2">__arm64_sys_ftruncate+0x1c/0x28</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159786]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_common+0x98/0x160</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159792]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_handler+0x68/0x80</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159800]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc+0x8/0xc</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159808]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">b4000a77</span><span class="c4">&nbsp;</span><span class="c2">b940230a</span><span class="c4">&nbsp;</span><span class="c2">f940bf0b</span><span class="c4">&nbsp;</span><span class="c2">8b0a02ea</span><span class="c4">&nbsp;</span><span class="c2">(f940014c)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159815]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">3729c600fbf1ba28</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159842]</span><span class="c4">&nbsp;</span><span class="c2">Kernel</span><span class="c4">&nbsp;</span><span class="c2">panic</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">syncing:</span><span class="c4">&nbsp;</span><span class="c2">Fatal</span><span class="c4">&nbsp;</span><span class="c2">exception</span></p><p class="c5"><span class="c6 c13">Again we see adsprpc driver logs, but it culminates in a crash within the context of the exploit process in a different part of the code entirely - this time from the inotify subsystem. We will revisit the importance of this crash later.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><h5 class="c3" id="h.ntm9w7ryhnoi"><span class="c11 c13 c19">Log 4:</span></h5><p class="c5"><span></span><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">67.167510]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_init_process:</span><span class="c4">&nbsp;</span><span class="c2">untrusted</span><span class="c4">&nbsp;</span><span class="c2">app</span><span class="c4">&nbsp;</span><span class="c2">trying</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">attach</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">privileged</span><span class="c4">&nbsp;</span><span class="c2">DSP</span><span class="c4">&nbsp;</span><span class="c2">PD</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">67.202061]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0xffffffffffffffff,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0xffffffff</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">67.202084]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">falcon:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_internal_mmap:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:</span><span class="c4">&nbsp;</span><span class="c2">adding</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">allocated</span><span class="c4">&nbsp;</span><span class="c2">pages</span><span class="c4">&nbsp;</span><span class="c2">is</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">supported</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">67.207916]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">mapping</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">found</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">unmap</span><span class="c4">&nbsp;</span><span class="c2">fd</span><span class="c4">&nbsp;</span><span class="c2">0xa,</span><span class="c4">&nbsp;</span><span class="c2">va</span><span class="c4">&nbsp;</span><span class="c2">0x0,</span><span class="c4">&nbsp;</span><span class="c2">len</span><span class="c4">&nbsp;</span><span class="c2">0x0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">69.577152]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702832054,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">70.621863]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702832054,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">79.689300]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702832054,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574406]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">NULL</span><span class="c4">&nbsp;</span><span class="c2">pointer</span><span class="c4">&nbsp;</span><span class="c2">dereference</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">0000000000000009</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574435]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574445]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000006</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574457]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">Exception</span><span class="c4">&nbsp;</span><span class="c2">class</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574467]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574476]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574485]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574495]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000006</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574504]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574522]</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">pgtable:</span><span class="c4">&nbsp;</span><span class="c2">4k</span><span class="c4">&nbsp;</span><span class="c2">pages,</span><span class="c4">&nbsp;</span><span class="c2">39-bit</span><span class="c4">&nbsp;</span><span class="c2">VAs,</span><span class="c4">&nbsp;</span><span class="c2">pgdp</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">00000000ad40fd5a</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574532]</span><span class="c4">&nbsp;</span><span class="c2">[0000000000000009]</span><span class="c4">&nbsp;</span><span class="c2">pgd=00000001cadcb003,</span><span class="c4">&nbsp;</span><span class="c2">pud=00000001cadcb003,</span><span class="c4">&nbsp;</span><span class="c2">pmd=0000000000000000</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574554]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000006</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574680]</span><span class="c4">&nbsp;</span><span class="c2">Process</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">(pid:</span><span class="c4">&nbsp;</span><span class="c2">10050,</span><span class="c4">&nbsp;</span><span class="c2">stack</span><span class="c4">&nbsp;</span><span class="c2">limit</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000000eac9e565)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574700]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">0</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">10050</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">falcon</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">O</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">4.19.157-perf-g8779875ad741</span><span class="c4">&nbsp;</span><span class="c2">#1</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574711]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Qualcomm</span><span class="c4">&nbsp;</span><span class="c2">Technologies,</span><span class="c4">&nbsp;</span><span class="c2">Inc.</span><span class="c4">&nbsp;</span><span class="c2">xiaomi</span><span class="c4">&nbsp;</span><span class="c2">apollo</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574726]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">00400005</span><span class="c4">&nbsp;</span><span class="c2">(nzcv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574756]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">pipe_read+0xac/0x308</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574769]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">pipe_read+0x4c/0x308</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574778]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff802e43bc80</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574982]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.574996]</span><span class="c4">&nbsp; </span><span class="c2">pipe_read+0xac/0x308</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575014]</span><span class="c4">&nbsp; </span><span class="c2">__vfs_read+0xf8/0x140</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575027]</span><span class="c4">&nbsp; </span><span class="c2">vfs_read+0xb8/0x150</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575039]</span><span class="c4">&nbsp; </span><span class="c2">ksys_read+0x6c/0xd0</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575053]</span><span class="c4">&nbsp; </span><span class="c2">__arm64_sys_read+0x18/0x20</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575071]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_common+0x98/0x160</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575083]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_handler+0x68/0x80</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575097]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc+0x8/0xc</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575114]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">aa1c03fb</span><span class="c4">&nbsp;</span><span class="c2">aa1c03e1</span><span class="c4">&nbsp;</span><span class="c2">b840ce68</span><span class="c4">&nbsp;</span><span class="c2">f8410f69</span><span class="c4">&nbsp;</span><span class="c2">(f9400529)</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575127]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">72c08623f6dedcd7</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">97.575174]</span><span class="c4">&nbsp;</span><span class="c2">Kernel</span><span class="c4">&nbsp;</span><span class="c2">panic</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">syncing:</span><span class="c4">&nbsp;</span><span class="c2">Fatal</span><span class="c4">&nbsp;</span><span class="c2">exception</span></p><p class="c5"><span class="c6 c13">We see here a fourth type of crash, this time in the pipe subsystem. Pipe buffers are often used as a spray object for heap exploitation, and it wouldn&rsquo;t be terribly surprising if that were the case here.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>There are several valuable pieces of information to glean from the logs - the most meaningful being the usage of this adsprpc driver. We </span><span class="c20">also</span><span class="c6 c13">&nbsp;see log lines from several adsprpc functions:</span></p><ul class="lst-kix_klp6u7xplfnr-0 start"><li class="c5 c21 li-bullet-0"><span class="c6 c8 c16">fastrpc_init_process</span></li><li class="c5 c21 li-bullet-0"><span class="c6 c8 c16">fastrpc_internal_munmap_fd</span></li><li class="c5 c21 li-bullet-0"><span class="c6 c8 c16">fastrpc_internal_mmap</span></li><li class="c5 c21 li-bullet-0"><span class="c6 c8 c16">fastrpc_mmap_free</span></li></ul><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>It is likely the bug used by the attacker resides somewhere in the relationships between these functions, but exactly </span><span class="c20">where</span><span>&nbsp;is</span><span>&nbsp;not clear from the logs alone. The functions that are executed by the exploit only serve to complicate the investigation, as the exploit seems to constantly hit very early</span><span>&nbsp;bailouts</span><span class="c6 c13">&nbsp;that shouldn&rsquo;t cause any change in kernel state whatsoever.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>Upon additional investigation (by Jann Horn in particular!) it became clear that this driver is accessible from a spectrum of unprivileged contexts. </span><span class="c8">untrusted_app</span><span>&nbsp;does not have the ability to directly open the driver device file, but at least on some devices it can obtain limited access by receiving a file descriptor to the device file from the </span><span class="c8">dspservice</span><span>&nbsp;process through the </span><span class="c8">IDspService</span><span>&nbsp;HAL interface, which is reachable through </span><span class="c8">hwbinder</span><span class="c6 c13">.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span class="c24"><a href="https://googleprojectzero.blogspot.com/2024/06/driving-forward-in-android-drivers.html">As we&rsquo;ve seen before</a></span><span>, third-party </span><span>Android drivers</span><span>&nbsp;are appealingly buggy attack surfaces, regularly containing a reservoir of potential vulnerabilities for attackers. While it wasn&rsquo;t immediately clear what vulnerability the attackers had exploited, it </span><span class="c20">was</span><span class="c6 c13">&nbsp;clear that performing a more thorough audit of this driver was warranted.</span></p><h2 class="c26" id="h.szhd4ck9ddkp"><span class="c6 c30">The adsprpc Driver</span></h2><p class="c5"><span>The </span><span class="c24"><a href="https://pages.cs.wisc.edu/%257Edanav/pubs/qcom/hexagon_micro2014_v6.pdf">Application</a></span><span>&nbsp;Digital Signal Processor Remote Procedure Call driver (or adsprpc for short) is primarily used for offloading multimedia processing to a more efficient DSP co-processor core. The driver is primarily accessed through the </span><span class="c8">/dev/adsprpc-smd</span><span>&nbsp;character device file although historically it could be reached via a variety of device files including </span><span class="c8">cdsprpc-smd</span><span>&nbsp;and </span><span class="c8">mdsprpc-smd</span><span>. The driver&rsquo;s architecture is helpfully thoroughly described in </span><span class="c24"><a href="https://android.googlesource.com/kernel/msm/%2B/android-msm-flo-3.4-kitkat-mr1/Documentation/arm/msm/adsprpc-drv.txt">the kernel documentation</a></span><span>. Through this driver, co-processor routines are exposed to the application processor userland (including </span><span class="c8">untrusted_app</span><span class="c6 c13">&nbsp;processes) via an RPC interface, providing an efficient abstraction methodology by which multimedia processing can be offloaded to the specialized hardware in the SoC. Through the use of DMA buffers that are mapped directly onto the DSP core, adsprpc looks to minimize the amount of data copied across the processor boundary. This featureset is necessarily complex, and that makes it a ripe target for in-depth security research.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><h2 class="c26" id="h.h2hp459hfm1a"><span class="c6 c30">The Bughunt Begins</span></h2><p class="c5"><span class="c6 c13">Having given up on discovering the bug exploited in the ITW logs directly, it was time to start a broader code review process. This turned out to be a very productive research decision. Jann found the first bug quite quickly, and over the course of the next several months, I found 5 more. I&rsquo;ve described each of the bugs below.</span></p><h4 class="c15" id="h.ph2uuuphzaot"><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451711">CVE-2024-38402: refcount leak leading to UAF in fastrpc_get_process_gids</a></span></h4><p class="c5"><span>T</span><span>he first discovered vulnerability in the driver is a refcount leak of the </span><span class="c8">group_info</span><span>&nbsp;struct associated with the task that leads to a UAF. In the function </span><span class="c8">fastrpc_get_process_gids</span><span>, </span><span class="c8">get_current_groups</span><span>&nbsp;is called which increments a refcount on the </span><span class="c8">group_info</span><span>&nbsp;struct, but that refcount is never dropped. Furthermore, this refcount is a non-saturating refcount which makes it possible to overflow if you execute </span><span class="c8">fastrpc_get_process_gids</span><span>&nbsp;approximately 2^32 times. This is a difficult bug to exploit in practice, taking at least 14 hours to trigger, but it&rsquo;s nevertheless memory corruption with all the associated consequences.</span><span class="c6 c13">&nbsp;An example crash from this issue is below:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c2">[77306.174599]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">BUG:</span><span class="c4">&nbsp;</span><span class="c2">KFENCE:</span><span class="c4">&nbsp;</span><span class="c2">invalid</span><span class="c4">&nbsp;</span><span class="c2">read</span><span class="c4">&nbsp;</span><span class="c2">in</span><span class="c4">&nbsp;</span><span class="c2">groups_to_user+0x34/0x1a4</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174606]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">read</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">0xffffff89572a0000:</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174607]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">groups_to_user+0x34/0x1a4</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174609]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">invoke_syscall+0x58/0x13c</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174612]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_common+0xb4/0xf0</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174614]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">do_el0_svc+0x24/0x90</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174615]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc+0x20/0x7c</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174617]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0t_64_sync_handler+0x84/0xe4</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174618]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0t_64_sync+0x1b8/0x1bc</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174620]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c6 c4">&nbsp; &nbsp;</span></p><p class="c5"><span class="c2">[77306.174621]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">7</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">5455</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">adbd</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">W</span><span class="c4">&nbsp; </span><span class="c2">OE</span><span class="c4">&nbsp; &nbsp; &nbsp;</span><span class="c2">5.15.123-android13-8-28577312-abS911BXXU3CXD3</span><span class="c4">&nbsp;</span><span class="c2">#1</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174623]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Samsung</span><span class="c4">&nbsp;</span><span class="c2">DM1Q</span><span class="c4">&nbsp;</span><span class="c2">PROJECT</span><span class="c4">&nbsp;</span><span class="c2">(board-id,13)</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174624]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">22400005</span><span class="c4">&nbsp;</span><span class="c2">(nzCv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO</span><span class="c4">&nbsp;</span><span class="c2">+TCO</span><span class="c4">&nbsp;</span><span class="c2">-DIT</span><span class="c4">&nbsp;</span><span class="c2">-SSBS</span><span class="c4">&nbsp;</span><span class="c2">BTYPE=--)</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174626]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">groups_to_user+0x34/0x1a4</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174628]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">__arm64_sys_getgroups+0x4c/0x6c</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174629]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02a073e00</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174630]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x29:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02a073e00</span><span class="c4">&nbsp;</span><span class="c2">x28:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8868030040</span><span class="c4">&nbsp;</span><span class="c2">x27:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174633]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x26:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x25:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x24:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174635]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x23:</span><span class="c4">&nbsp;</span><span class="c2">0000000060001000</span><span class="c4">&nbsp;</span><span class="c2">x22:</span><span class="c4">&nbsp;</span><span class="c2">00000077219a4f2c</span><span class="c4">&nbsp;</span><span class="c2">x21:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8868030040</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174637]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x20:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc0081bd46c</span><span class="c4">&nbsp;</span><span class="c2">x19:</span><span class="c4">&nbsp;</span><span class="c2">000000006b6b6b6b</span><span class="c4">&nbsp;</span><span class="c2">x18:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc016089000</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174638]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x17:</span><span class="c4">&nbsp;</span><span class="c2">000000000000fffe</span><span class="c4">&nbsp;</span><span class="c2">x16:</span><span class="c4">&nbsp;</span><span class="c2">b4000074e392f638</span><span class="c4">&nbsp;</span><span class="c2">x15:</span><span class="c4">&nbsp;</span><span class="c2">ffffff895729fff8</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174640]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x14:</span><span class="c4">&nbsp;</span><span class="c2">00000000524e68f8</span><span class="c4">&nbsp;</span><span class="c2">x13:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8868030040</span><span class="c4">&nbsp;</span><span class="c2">x12:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc00ad82000</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174641]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x11:</span><span class="c4">&nbsp;</span><span class="c2">0000007fffffffff</span><span class="c4">&nbsp;</span><span class="c2">x10:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc00aa93000</span><span class="c4">&nbsp;</span><span class="c2">x9</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000014939a3e</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174643]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x8</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">000000006b6b6b6b</span><span class="c4">&nbsp;</span><span class="c2">x7</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x6</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174645]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x5</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x4</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x3</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174646]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">x2</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000040</span><span class="c4">&nbsp;</span><span class="c2">x1</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8904db9700</span><span class="c4">&nbsp;</span><span class="c2">x0</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">b400007491448d40</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174648]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174648]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">groups_to_user+0x34/0x1a4</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174650]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">invoke_syscall+0x58/0x13c</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174651]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_common+0xb4/0xf0</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174653]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">do_el0_svc+0x24/0x90</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174654]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc+0x20/0x7c</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174655]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0t_64_sync_handler+0x84/0xe4</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c2">[77306.174656]</span><span class="c4">&nbsp;</span><span class="c2">[7:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">adbd:</span><span class="c4">&nbsp;</span><span class="c2">5455]</span><span class="c4">&nbsp; </span><span class="c2">el0t_64_sync+0x1b8/0x1bc</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c6 c13"></span></p><p class="c5 c12"><span class="c6 c13"></span></p><h4 class="c15" id="h.q4wmlexvys1"><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451710">CVE-2024-21455: is_compat flag leads to access of userland provided addresses as kernel pointers</a></span></h4><p class="c5"><span>In order to support 32-bit userland processes, 64-bit kernels contain a &ldquo;compatibility layer&rdquo; that ioctls can support. This layer is responsible for marshaling over 32-bit structs into their 64-bit equivalents which involves upcasting 32-bit userland pointers into 64-bit pointers. The adsprpc driver handles this case in the </span><span class="c8">adsprpc_compat.c</span><span>&nbsp;file. It allocates kernel memory, copies and converts the 32-bit struct into that kernel memory as a 64-bit struct, and then calls the 64-bit ioctl interface. The 64-bit ioctl interface thus needs to handle calls coming from both the 32-bit kernel compatibility layer and from 64-bit userland. In order to provide this support, the 32-bit compatibility layer indicates to the broader adsprpc driver that the 32-bit compatibility layer is in use by setting a flag </span><span class="c8">is_compat</span><span>&nbsp;in the file-descriptor-bound </span><span class="c8">fl</span><span class="c6 c13">&nbsp;struct.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c4 c9">long</span><span class="c4">&nbsp;</span><span class="c1">compat_fastrpc_device_ioctl(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">file</span><span class="c4">&nbsp;</span><span class="c1">*filp,</span><span class="c4">&nbsp;</span><span class="c4 c9">unsigned</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">cmd,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">unsigned</span><span class="c4">&nbsp;</span><span class="c4 c9">long</span><span class="c4">&nbsp;</span><span class="c1">arg)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*)filp-&gt;private_data;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!filp-&gt;f_op</span><span class="c4">&nbsp;</span><span class="c1">||</span><span class="c4">&nbsp;</span><span class="c1">!filp-&gt;f_op-&gt;unlocked_ioctl)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">return</span><span class="c4">&nbsp;</span><span class="c1">-ENOTTY;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fl-&gt;is_compat</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">true;</span></p><p class="c5"><span class="c1 c11">...</span></p><p class="c5"><span class="c1 c11">}</span></p><p class="c5"><span class="c6 c13"></span></p><p class="c5"><span>Later on, that </span><span class="c8">is_compat</span><span>&nbsp;flag is used in calls to </span><span class="c8">K_COPY_FROM_USER</span><span>&nbsp;to make decisions about whether to use </span><span class="c8">memmove</span><span>&nbsp;(32-bit compatibility layer or other kernel invocation) or </span><span class="c8">copy_from_user</span><span class="c6 c13">.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c1">#define</span><span class="c4 c9">&nbsp;</span><span class="c1">K_COPY_FROM_USER(err,</span><span class="c4 c9">&nbsp;</span><span class="c1">kernel,</span><span class="c4 c9">&nbsp;</span><span class="c1">dst,</span><span class="c4 c9">&nbsp;</span><span class="c1">src,</span><span class="c4 c9">&nbsp;</span><span class="c1">size)</span><span class="c4 c9">&nbsp;</span><span class="c1">\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">do</span><span class="c4 c9">&nbsp;</span><span class="c1">{\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4 c9">&nbsp;</span><span class="c1">(!(kernel))\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">err</span><span class="c4 c9">&nbsp;</span><span class="c1">=</span><span class="c4 c9">&nbsp;</span><span class="c1">copy_from_user((dst),\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">(</span><span class="c0">void</span><span class="c4 c9">&nbsp;</span><span class="c0">const</span><span class="c4 c9">&nbsp;</span><span class="c1">__user</span><span class="c4 c9">&nbsp;</span><span class="c1">*)(src),\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">(size));\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">else</span><span class="c1">\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">memmove((dst),</span><span class="c4 c9">&nbsp;</span><span class="c1">(src),</span><span class="c4 c9">&nbsp;</span><span class="c1">(size));\</span></p><p class="c5"><span class="c4 c9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span><span class="c4 c9">&nbsp;</span><span class="c0">while</span><span class="c4 c9">&nbsp;</span><span class="c1">(</span><span class="c4 c14">0</span><span class="c1">)</span></p><p class="c5"><span class="c1">...</span><span class="c4 c9"><br>int</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_internal_invoke2(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_ioctl_invoke2</span><span class="c4">&nbsp;</span><span class="c1">*inv2)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5 c18"><span class="c0">switch</span><span class="c4">&nbsp;</span><span class="c1">(inv2-&gt;req)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">case</span><span class="c4">&nbsp;</span><span class="c1">FASTRPC_INVOKE2_ASYNC:</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">K_COPY_FROM_USER(err,</span><span class="c4">&nbsp;</span><span class="c1">fl-&gt;is_compat,</span><span class="c4">&nbsp;</span><span class="c1">&amp;p.inv3,</span><span class="c4">&nbsp;</span><span class="c1">(</span><span class="c0">void</span><span class="c1">*)inv2-&gt;invparam,</span><span class="c4">&nbsp;</span><span class="c0">sizeof</span><span class="c1">(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_ioctl_invoke_async_no_perf));</span></p><p class="c5"><span class="c1 c11">...</span></p><p class="c5"><span class="c1 c11">}</span></p><p class="c5"><span class="c6 c13"></span></p><p class="c5"><span>However, this flag is set at a relatively global level in that any other ioctl calls on the same file descriptor will see that this flag is set. Furthermore, once the flag is set, it is never UNset. Consider the following scenario:</span></p><ol class="lst-kix_d27lror3sq5g-0 start" start="1"><li class="c5 c21 li-bullet-0"><span>A malicious 64-bit process A opens the </span><span class="c8">adsprpc-smd</span><span class="c6 c13">&nbsp;file, creating a new adsprpc file descriptor</span></li><li class="c5 c21 li-bullet-0"><span>Process A forks and creates a new 32-bit process B (A and B share the adsprpc fd/</span><span class="c8">fl</span><span class="c6 c13">)</span></li><li class="c5 c21 li-bullet-0"><span>Process B invokes the 32-bit ioctl interface (thusly setting the </span><span class="c8">is_compat</span><span class="c6 c13">&nbsp;flag) and exits</span></li><li class="c5 c21 li-bullet-0"><span class="c6 c13">Process A invokes the 64-bit ioctl interface</span></li></ol><p class="c5"><span>In this circumstance, the driver incorrectly thinks that the request is coming from the 32-bit compatibility layer (since </span><span class="c8">is_compat</span><span>&nbsp;is set) and that it should access the struct as if it contained </span><span class="c20">kernel</span><span>&nbsp;pointers while it is in fact a request coming from 64-bit </span><span class="c20">userland</span><span>&nbsp;containing untrusted </span><span class="c20">userland-provided</span><span>&nbsp;pointers (which could in a malicious case be kernel pointers!). The kernel will subsequently use an unsafe </span><span class="c8">memmove</span><span class="c6 c13">&nbsp;to access these pointers, leading to userland controlled reads of kernel addresses.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c2">[49468.514358]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">paging</span><span class="c4">&nbsp;</span><span class="c2">request</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">ffffffff41414141</span></p><p class="c5"><span class="c2">[49468.514397]</span><span class="c4">&nbsp;</span><span class="c2">PC</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">d65f03c0</span><span class="c4">&nbsp;</span><span class="c2">d503201f</span><span class="c4">&nbsp;</span><span class="c2">(a9401c26)</span><span class="c4">&nbsp;</span><span class="c2">a9412428</span></p><p class="c5"><span class="c2">[49468.514407]</span><span class="c4">&nbsp;</span><span class="c2">LR</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">340003a8</span><span class="c4">&nbsp;</span><span class="c2">957474dd</span><span class="c4">&nbsp;</span><span class="c2">(f9401be8)</span><span class="c4">&nbsp;</span><span class="c2">f90023e8</span></p><p class="c5"><span class="c2">[49468.514413]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[49468.514418]</span><span class="c4">&nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000005</span></p><p class="c5"><span class="c2">[49468.514426]</span><span class="c4">&nbsp;</span><span class="c2">EC</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x25:</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[49468.514433]</span><span class="c4">&nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[49468.514440]</span><span class="c4">&nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[49468.514445]</span><span class="c4">&nbsp;</span><span class="c2">FSC</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x05:</span><span class="c4">&nbsp;</span><span class="c2">level</span><span class="c4">&nbsp;</span><span class="c2">1</span><span class="c4">&nbsp;</span><span class="c2">translation</span><span class="c4">&nbsp;</span><span class="c2">fault</span></p><p class="c5"><span class="c2">[49468.514452]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[49468.514456]</span><span class="c4">&nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000005</span></p><p class="c5"><span class="c2">[49468.514463]</span><span class="c4">&nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[49468.514469]</span><span class="c4">&nbsp;</span><span class="c2">swapper</span><span class="c4">&nbsp;</span><span class="c2">pgtable:</span><span class="c4">&nbsp;</span><span class="c2">4k</span><span class="c4">&nbsp;</span><span class="c2">pages,</span><span class="c4">&nbsp;</span><span class="c2">39-bit</span><span class="c4">&nbsp;</span><span class="c2">VAs,</span><span class="c4">&nbsp;</span><span class="c2">pgdp=00000000aa728000</span></p><p class="c5"><span class="c2">[49468.514479]</span><span class="c4">&nbsp;</span><span class="c2">[ffffffff41414141]</span><span class="c4">&nbsp;</span><span class="c2">pgd=0000000000000000,</span><span class="c4">&nbsp;</span><span class="c2">p4d=0000000000000000,</span><span class="c4">&nbsp;</span><span class="c2">pud=0000000000000000</span></p><p class="c5"><span class="c2">[49468.514502]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000005</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">[49468.514780]</span><span class="c4">&nbsp;</span><span class="c2">sec_arm64_ap_context:sec_arm64_ap_context_on_die()</span><span class="c4">&nbsp;</span><span class="c2">context</span><span class="c4">&nbsp;</span><span class="c2">saved</span><span class="c4">&nbsp;</span><span class="c2">(CPU:6)</span></p><p class="c5"><span class="c2">[49468.514788]</span><span class="c4">&nbsp;</span><span class="c2">Modules</span><span class="c4">&nbsp;</span><span class="c2">linked</span><span class="c4">&nbsp;</span><span class="c2">in:</span><span class="c4">&nbsp;</span><span class="c2">[...]</span></p><p class="c5"><span class="c2">[49468.516301]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">6</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">17448</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">poc_compat_pare</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">W</span><span class="c4">&nbsp; </span><span class="c2">OE</span><span class="c4">&nbsp; &nbsp; &nbsp;</span><span class="c2">5.15.123-android13-8-28577312-abS911BXXU3CXD3</span><span class="c4">&nbsp;</span><span class="c2">#1</span></p><p class="c5"><span class="c2">[49468.516312]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Samsung</span><span class="c4">&nbsp;</span><span class="c2">DM1Q</span><span class="c4">&nbsp;</span><span class="c2">PROJECT</span><span class="c4">&nbsp;</span><span class="c2">(board-id,13)</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[49468.516317]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">22400005</span><span class="c4">&nbsp;</span><span class="c2">(nzCv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO</span><span class="c4">&nbsp;</span><span class="c2">+TCO</span><span class="c4">&nbsp;</span><span class="c2">-DIT</span><span class="c4">&nbsp;</span><span class="c2">-SSBS</span><span class="c4">&nbsp;</span><span class="c2">BTYPE=--)</span></p><p class="c5"><span class="c2">[49468.516326]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">__memcpy+0x90/0x250</span></p><p class="c5"><span class="c2">[49468.516339]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_internal_invoke2+0x308/0x408</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[49468.516471]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02fe33ba0</span></p><p class="c5"><span class="c2">[49468.516475]</span><span class="c4">&nbsp;</span><span class="c2">x29:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02fe33cb0</span><span class="c4">&nbsp;</span><span class="c2">x28:</span><span class="c4">&nbsp;</span><span class="c2">ffffff894341bb80</span><span class="c4">&nbsp;</span><span class="c2">x27:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span></p><p class="c5"><span class="c2">[49468.516489]</span><span class="c4">&nbsp;</span><span class="c2">x26:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x25:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x24:</span><span class="c4">&nbsp;</span><span class="c2">ffffff891fe6c5c0</span></p><p class="c5"><span class="c2">[49468.516499]</span><span class="c4">&nbsp;</span><span class="c2">x23:</span><span class="c4">&nbsp;</span><span class="c2">00000000ffffffe7</span><span class="c4">&nbsp;</span><span class="c2">x22:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8939eff010</span><span class="c4">&nbsp;</span><span class="c2">x21:</span><span class="c4">&nbsp;</span><span class="c2">00000000c0185212</span></p><p class="c5"><span class="c2">[49468.516510]</span><span class="c4">&nbsp;</span><span class="c2">x20:</span><span class="c4">&nbsp;</span><span class="c2">0000007fe5890e40</span><span class="c4">&nbsp;</span><span class="c2">x19:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8939eff000</span><span class="c4">&nbsp;</span><span class="c2">x18:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc017b37010</span></p><p class="c5"><span class="c2">[49468.516520]</span><span class="c4">&nbsp;</span><span class="c2">x17:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x16:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x15:</span><span class="c4">&nbsp;</span><span class="c2">0000007fe5890e40</span></p><p class="c5"><span class="c2">[49468.516530]</span><span class="c4">&nbsp;</span><span class="c2">x14:</span><span class="c4">&nbsp;</span><span class="c2">ffffff80011f6480</span><span class="c4">&nbsp;</span><span class="c2">x13:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x12:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8034b27ce8</span></p><p class="c5"><span class="c2">[49468.516540]</span><span class="c4">&nbsp;</span><span class="c2">x11:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000010</span><span class="c4">&nbsp;</span><span class="c2">x10:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc002443654</span><span class="c4">&nbsp;</span><span class="c2">x9</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000008</span></p><p class="c5"><span class="c2">[49468.516549]</span><span class="c4">&nbsp;</span><span class="c2">x8</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000001</span><span class="c4">&nbsp;</span><span class="c2">x7</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000001</span><span class="c4">&nbsp;</span><span class="c2">x6</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02fe33d30</span></p><p class="c5"><span class="c2">[49468.516559]</span><span class="c4">&nbsp;</span><span class="c2">x5</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02fe33bd8</span><span class="c4">&nbsp;</span><span class="c2">x4</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffff41414171</span><span class="c4">&nbsp;</span><span class="c2">x3</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000008</span></p><p class="c5"><span class="c2">[49468.516568]</span><span class="c4">&nbsp;</span><span class="c2">x2</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000030</span><span class="c4">&nbsp;</span><span class="c2">x1</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffff41414141</span><span class="c4">&nbsp;</span><span class="c2">x0</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc02fe33ba8</span></p><p class="c5"><span class="c2">[49468.516577]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[49468.516582]</span><span class="c4">&nbsp;</span><span class="c2">__memcpy+0x90/0x250</span></p><p class="c5"><span class="c2">[49468.516593]</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_device_ioctl+0x1b0/0x92c</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[49468.516716]</span><span class="c4">&nbsp;</span><span class="c2">__arm64_sys_ioctl+0x120/0x170</span></p><p class="c5"><span class="c2">[49468.516734]</span><span class="c4">&nbsp;</span><span class="c2">invoke_syscall+0x58/0x13c</span></p><p class="c5"><span class="c2">[49468.516745]</span><span class="c4">&nbsp;</span><span class="c2">el0_svc_common+0xb4/0xf0</span></p><p class="c5"><span class="c2">[49468.516753]</span><span class="c4">&nbsp;</span><span class="c2">do_el0_svc+0x24/0x90</span></p><p class="c5"><span class="c2">[49468.516760]</span><span class="c4">&nbsp;</span><span class="c2">el0_svc+0x20/0x7c</span></p><p class="c5"><span class="c2">[49468.516771]</span><span class="c4">&nbsp;</span><span class="c2">el0t_64_sync_handler+0x84/0xe4</span></p><p class="c5"><span class="c2">[49468.516778]</span><span class="c4">&nbsp;</span><span class="c2">el0t_64_sync+0x1b8/0x1bc</span></p><p class="c5"><span class="c2">[49468.516790]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">382e6808</span><span class="c4">&nbsp;</span><span class="c2">381ff0aa</span><span class="c4">&nbsp;</span><span class="c2">d65f03c0</span><span class="c4">&nbsp;</span><span class="c2">d503201f</span><span class="c4">&nbsp;</span><span class="c2">(a9401c26)</span></p><p class="c5"><span class="c2">[49468.516799]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">9c87e0f40bf8f469</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c6 c13">This could plausibly be elevated directly into an arbitrary kernel read primitive.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><h3 class="c27" id="h.9ttjgt27xbrk"><span>Understanding the </span><span class="c8">fastrpc_mmap</span><span class="c11 c17">&nbsp;struct</span></h3><p class="c5"><span>The adsprpc driver maintains some internal bookkeeping on what DMA buffers are mapped onto the co-processor via </span><span class="c8">fastrpc_mmap</span><span>&nbsp;structs. These structs are allocated and initialized in </span><span class="c8">fastrpc_mmap_create</span><span>&nbsp;and contain several characteristics that substantially complicate management of these objects. They can be on either an </span><span class="c8">fl</span><span>&nbsp;(associated with a </span><span class="c8">struct</span><span>&nbsp;</span><span class="c8">file</span><span>) local or global linked list, depending on the flags used on creation. They have two separate refcounts </span><span class="c8">refs</span><span>&nbsp;and </span><span class="c8">ctx_refs</span><span>&nbsp;and they can be referenced from multiple places at once, including a context (an object that tracks data associated with a single RPC call), the global or local map lists, and of course transient stack-based references when being created or destroyed. A reference on an existing map is taken when </span><span class="c8">fastrpc_mmap_create</span><span class="c6 c13">&nbsp;is called with a set of parameters that are fulfilled by an existing mapping.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span class="c8">fastrpc_mmap</span><span>&nbsp;objects can be created via several different codepaths. This includes during context initialization, by accessing two different dedicated ioctl handlers, during DSP initialization and process creation, and even by a request from the DSP itself. </span><span class="c8">fastrpc_mmap</span><span>&nbsp;objects can be </span><span class="c20">freed</span><span>&nbsp;through a reciprocal set of codepaths such as context or </span><span class="c8">struct file</span><span>&nbsp;teardown, and via </span><span class="c20">three</span><span>&nbsp;different dedicated unmapping ioctls. We will examine several of these creation and destruction codepaths as I discuss three discovered bugs involving use-after-free of a </span><span class="c8">fastrpc_mmap_struct</span><span class="c6 c13">.</span></p><h4 class="c15" id="h.jvp9ayz9sab2"><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451715">CVE-2024-33060: UAF race of global maps in fastrpc_mmap_create (and epilogue functions)</a></span></h4><p class="c5"><span class="c6 c13">It is important to have a good understanding of the locking utilized for protecting these map lists from races in order to understand the first bug found:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_internal_mem_map(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_ioctl_mem_map</span><span class="c4">&nbsp;</span><span class="c1">*ud)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap</span><span class="c4">&nbsp;</span><span class="c1">*map</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;internal_map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">VERIFY(err,</span><span class="c4">&nbsp;</span><span class="c1">!(err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_create(fl,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.fd,</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.attrs,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ud-&gt;m.vaddrin,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.length,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ud-&gt;m.flags,</span><span class="c4">&nbsp;</span><span class="c1">&amp;map)));</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(err)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">goto</span><span class="c4">&nbsp;</span><span class="c1">bail;</span></p><p class="c5 c18"><span class="c1">...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c7 c4">//[1] map may already be globally visible</span></p><p class="c5 c18"><span class="c1">VERIFY(err,</span><span class="c4 c25">&nbsp;</span><span class="c1">!(err</span><span class="c4 c25">&nbsp;</span><span class="c1">=</span><span class="c4 c25">&nbsp;</span><span class="c1">fastrpc_mem_map_to_dsp(fl,</span><span class="c4 c25">&nbsp;</span><span class="c1">ud-&gt;m.fd,</span><span class="c4 c25">&nbsp;</span><span class="c1">ud-&gt;m.offset,</span></p><p class="c5 c18"><span class="c1 c11">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ud-&gt;m.flags, map-&gt;va, map-&gt;phys, map-&gt;size, &amp;map-&gt;raddr)));</span></p><p class="c5 c18"><span class="c0">if</span><span class="c1 c11">&nbsp;(err)</span></p><p class="c5 c18"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">goto</span><span class="c1 c11">&nbsp;bail;</span></p><p class="c5 c18"><span class="c1 c11">ud-&gt;m.vaddrout = map-&gt;raddr;</span></p><p class="c5"><span class="c1">bail:</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(err)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_mmap_free(map,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;internal_map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">return</span><span class="c4">&nbsp;</span><span class="c1">err;</span></p><p class="c5"><span class="c1">}</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c6 c13"></span></p><p class="c5"><span>Two mutexes are held here, one of which is held throughout the lifetime of the function including in the error condition bailout: </span><span class="c8">fl-&gt;map_mutex</span><span>&nbsp;and </span><span class="c8">fl-&gt;internal_map_mutex</span><span>. Both of these mutexes are bound to the </span><span class="c8">fl</span><span>&nbsp;struct which is itself bound to the </span><span class="c8">struct file</span><span>&nbsp;associated with a file descriptor. These mutexes prevent concurrency for e.g. multiple </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;calls on the </span><span class="c20">same</span><span>&nbsp;file descriptor, but do </span><span class="c20">not</span><span>&nbsp;prevent concurrency with </span><span class="c20">other</span><span>&nbsp;</span><span class="c8">fl</span><span>&nbsp;structs (e.g. from a </span><span class="c20">second</span><span>&nbsp;open&rsquo;d adsprpc-smd file descriptor) being utilized in the same ioctls. As these ioctls are often used to administer </span><span class="c8">fl</span><span>&nbsp;struct</span><span>&nbsp;</span><span class="c20">local</span><span>&nbsp;maps, global concurrency is often okay. However </span><span class="c8">fastrpc_mmap_create</span><span>&nbsp;and </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;can create </span><span class="c20">global</span><span>&nbsp;maps too. And for </span><span class="c20">global</span><span>&nbsp;maps that are added to </span><span class="c20">global</span><span>&nbsp;structures, global mutexing is only </span><span class="c20">briefly</span><span>&nbsp;taken in </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;-&gt; </span><span class="c8">fastrpc_mmap_create</span><span>&nbsp;-&gt; </span><span class="c8">fastrpc_mmap_add</span><span class="c6 c13">:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c0">static</span><span class="c4">&nbsp;</span><span class="c0">void</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_add(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap</span><span class="c4">&nbsp;</span><span class="c1">*map)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;flags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">ADSP_MMAP_HEAP_ADDR</span><span class="c4">&nbsp;</span><span class="c1">||</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;flags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">ADSP_MMAP_REMOTE_HEAP_ADDR)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_apps</span><span class="c4">&nbsp;</span><span class="c1">*me</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">&amp;gfa; </span><span class="c7 c4">//gfa is a global struct</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">unsigned</span><span class="c4">&nbsp;</span><span class="c4 c9">long</span><span class="c4">&nbsp;</span><span class="c1">irq_flags</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">spin_lock_irqsave(&amp;me-&gt;hlock,</span><span class="c4">&nbsp;</span><span class="c1">irq_flags); </span><span class="c7 c4">//Taken here</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">hlist_add_head(&amp;map-&gt;hn,</span><span class="c4">&nbsp;</span><span class="c1">&amp;me-&gt;maps);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">spin_unlock_irqrestore(&amp;me-&gt;hlock,</span><span class="c4">&nbsp;</span><span class="c1">irq_flags); </span><span class="c7 c4">//Dropped here</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span><span class="c4">&nbsp;</span><span class="c0">else</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;fl;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">hlist_add_head(&amp;map-&gt;hn,</span><span class="c4">&nbsp;</span><span class="c1">&amp;fl-&gt;maps);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span class="c6 c13"></span></p><p class="c5"><span>This means that the global mutexing architecture is not enough to prevent two concurrent invocations of the fastrpc mapping ioctl calls, even if a global map is being created. This itself is not a bug, but even </span><span class="c20">after</span><span>&nbsp;insertion of a global map onto the global map list, </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;continues to access the map even though it should really be considering its reference to the global map &ldquo;consumed&rdquo;. Crucially, if a global map is created and added to the global list, it is immediately visible to concurrent callers - a thread calling </span><span class="c8">fastrpc_internal_munmap</span><span>&nbsp;with a different adsprpc fd / </span><span class="c8">fl struct</span><span>&nbsp;could destroy the global map while </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;</span><span>continues to use it</span><span>&nbsp;(see [1] in the above code sample from </span><span class="c8">fastrpc_internal_mem_map</span><span>). </span><span>This is an example of</span><span>&nbsp;continuing to use a transient reference after transferring that reference to a data structure where the lifetimes of the residing objects are userland-managed &nbsp;- another example would be using &nbsp;a </span><span class="c8">struct file</span><span>&nbsp;object after installing the only reference in a file descriptor table (via </span><span class="c8">fd_install</span><span>) at which point</span><span>&nbsp;userland can drop the reference using the </span><span class="c8">close</span><span class="c6 c13">(2) syscall.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>Triggering this bug generates the following kernel panic with </span><span class="c8">PAGE_POISON</span><span class="c6 c13">&nbsp;enabled:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c10">[ 2890.558370] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Unable to handle kernel paging request at virtual address 006b6b6b6b6b6b83</span></p><p class="c5"><span class="c10">[ 2890.558411] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] PC Code: 95ca6fb3 aa1703e0 2a1f03e1 97ffdbcc 2a1f03f6 14000008 f9400ae8 (f8418d09) f90002e9 b4000049 f9000537 f9000117 f90006e8 aa1403e0 95ca66a2 aa1303e0 95ca66a0 d5384108 f942f108 f94007e9</span></p><p class="c5"><span class="c10">[ 2890.558618] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] LR Code: 94000075 2a0003f6 aa1403e0 95ca66ed f94003f7 340006f6 b4000937 aa1403e0 95ca6feb (b94026e8) 7100211f 54000060 7100111f 54000721 b00000f8 91038318 91008315 aa1503e0 95ca97d3 f9400308</span></p><p class="c5"><span class="c10">[ 2890.558633] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Mem abort info:</span></p><p class="c5"><span class="c10">[ 2890.558641] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; ESR = 0x96000004</span></p><p class="c5"><span class="c10">[ 2890.558650] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; EC = 0x25: DABT (current EL), IL = 32 bits</span></p><p class="c5"><span class="c10">[ 2890.558661] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; SET = 0, FnV = 0</span></p><p class="c5"><span class="c10">[ 2890.558670] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; EA = 0, S1PTW = 0</span></p><p class="c5"><span class="c10">[ 2890.558678] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; FSC = 0x04: level 0 translation fault</span></p><p class="c5"><span class="c10">[ 2890.558688] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Data abort info:</span></p><p class="c5"><span class="c10">[ 2890.558696] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; ISV = 0, ISS = 0x00000004</span></p><p class="c5"><span class="c10">[ 2890.558704] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp; CM = 0, WnR = 0</span></p><p class="c5"><span class="c10">[ 2890.558713] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] [006b6b6b6b6b6b83] address between user and kernel address ranges</span></p><p class="c5"><span class="c10">[ 2890.558727] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Internal error: Oops: 96000004 [#1] PREEMPT SMP</span></p><p class="c5"><span class="c10">[ 2890.559162] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] sec_arm64_ap_context:sec_arm64_ap_context_on_die() context saved (CPU:0)</span></p><p class="c5"><span class="c10">...</span></p><p class="c5"><span class="c10">[ 2890.560996] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] CPU: 0 PID: 22189 Comm: poc Tainted: G S &nbsp; &nbsp; &nbsp;W &nbsp;OE &nbsp; &nbsp; 5.15.123-android13-8-28577312-abS911BXXU3CXD3 #1</span></p><p class="c5"><span class="c10">[ 2890.561007] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Hardware name: Samsung DM1Q PROJECT (board-id,13) (DT)</span></p><p class="c5"><span class="c10">[ 2890.561014] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] pstate: 22400005 (nzCv daif +PAN -UAO +TCO -DIT -SSBS BTYPE=--)</span></p><p class="c5"><span class="c10">[ 2890.561024] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] pc : fastrpc_internal_munmap+0x1ac/0x264 [frpc_adsprpc]</span></p><p class="c5"><span class="c10">[ 2890.561202] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] lr : fastrpc_internal_munmap+0xb4/0x264 [frpc_adsprpc]</span></p><p class="c5"><span class="c10">[ 2890.561376] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] sp : ffffffc025ee3cc0</span></p><p class="c5"><span class="c10">[ 2890.561382] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x29: ffffffc025ee3cd0 x28: ffffff88bf4fbb80 x27: 0000000000000000</span></p><p class="c5"><span class="c10">[ 2890.561397] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x26: 0000000000000000 x25: 0000000000000000 x24: ffffff8922ae4301</span></p><p class="c5"><span class="c10">[ 2890.561411] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x23: ffffff803bb30900 x22: 0000000080000448 x21: ffffff8928fb5800</span></p><p class="c5"><span class="c10">[ 2890.561424] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x20: ffffff8928fb5910 x19: ffffff8928fb5940 x18: ffffffc00b492010</span></p><p class="c5"><span class="c10">[ 2890.561437] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x17: 00000000000003e7 x16: 0000000000007e00 x15: 0000000000000600</span></p><p class="c5"><span class="c10">[ 2890.561450] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x14: ffffff891cc57e00 x13: dee89d8ccc1e57a7 x12: 088000400811164c</span></p><p class="c5"><span class="c10">[ 2890.561463] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x11: ffffff891cc51a00 x10: ffffff88bf4fbb80 x9 : 0000000000000000</span></p><p class="c5"><span class="c10">[ 2890.561476] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x8 : 6b6b6b6b6b6b6b6b x7 : bbbbbbbbbbbbbbbb x6 : 00000000000000c0</span></p><p class="c5"><span class="c10">[ 2890.561489] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x5 : 0000000000150009 x4 : ffffff891cc57400 x3 : 000000000015000a</span></p><p class="c5"><span class="c10">[ 2890.561502] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] x2 : ffffff88bf4fbb80 x1 : 0000000000000000 x0 : 0000000000000000</span></p><p class="c5"><span class="c10">[ 2890.561516] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Call trace:</span></p><p class="c5"><span class="c10">[ 2890.561523] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;fastrpc_internal_munmap+0x1ac/0x264 [frpc_adsprpc]</span></p><p class="c5"><span class="c10">[ 2890.561696] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;fastrpc_device_ioctl+0x7e8/0x92c [frpc_adsprpc]</span></p><p class="c5"><span class="c10">[ 2890.561867] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;__arm64_sys_ioctl+0x120/0x170</span></p><p class="c5"><span class="c10">[ 2890.561886] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;invoke_syscall+0x58/0x13c</span></p><p class="c5"><span class="c10">[ 2890.561899] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;el0_svc_common+0xb4/0xf0</span></p><p class="c5"><span class="c10">[ 2890.561908] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;do_el0_svc+0x24/0x90</span></p><p class="c5"><span class="c10">[ 2890.561917] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;el0_svc+0x20/0x7c</span></p><p class="c5"><span class="c10">[ 2890.561929] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;el0t_64_sync_handler+0x84/0xe4</span></p><p class="c5"><span class="c10">[ 2890.561937] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] &nbsp;el0t_64_sync+0x1b8/0x1bc</span></p><p class="c5"><span class="c10">[ 2890.561951] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Code: 97ffdbcc 2a1f03f6 14000008 f9400ae8 (f8418d09)</span></p><p class="c5"><span class="c10">[ 2890.561967] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] ---[ end trace af6bd4fc06724258 ]---</span></p><p class="c5"><span class="c10">[ 2890.561978] [0: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;poc:22189] Kernel panic - not syncing: Oops: Fatal exception</span></p><p class="c5"><span class="c6 c13"></span></p><h4 class="c15" id="h.74iu61pc8jz6"><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451713">PZ Issue 42451713 (fixed with CVE-2024-33060): Incorrect searching algorithm in fastrpc_mmap_find leads to kernel address space info leak</a></span></h4><p class="c5"><span>The </span><span class="c8">fastrpc_mmap_create</span><span>&nbsp;function calls the function </span><span class="c8">fastrpc_mmap_find</span><span>&nbsp;with attacker controlled arguments in order to identify existing maps that already fulfill the map creation request and if an existing map fulfills the request, it simply takes a refcount on that map and returns (this is an important aspect of </span><span>CVE-2024-49848</span><span>&nbsp;too, as we&rsquo;ll see in the next section!). In the case of </span><span class="c20">global</span><span class="c6 c13">&nbsp;maps it performs the following:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c1">hlist_for_each_entry_safe(map,</span><span class="c4">&nbsp;</span><span class="c1">n,</span><span class="c4">&nbsp;</span><span class="c1">&amp;me-&gt;maps,</span><span class="c4">&nbsp;</span><span class="c1">hn)</span><span class="c4">&nbsp;</span><span class="c1">{</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; </span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(va</span><span class="c4">&nbsp;</span><span class="c1">&gt;=</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;va</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp; </span><span class="c7 c4">//Is the userland provided va and len in the range of the map?</span></p><p class="c5"><span class="c4">&nbsp; &nbsp; </span><span class="c1">va</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c1">len</span><span class="c4">&nbsp;</span><span class="c1">&lt;=</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;va</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;len</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; </span><span class="c1">map-&gt;fd</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">fd)</span><span class="c4">&nbsp;</span><span class="c1">{ </span><span class="c7 c4">//And is the fd the same?</span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(refs)</span><span class="c4">&nbsp;</span><span class="c1">{</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;refs</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c4 c14">1</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">INT_MAX)</span><span class="c4">&nbsp;</span><span class="c1">{</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">spin_unlock_irqrestore(&amp;me-&gt;hlock,</span><span class="c4">&nbsp;</span><span class="c1">irq_flags);</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c0">return</span><span class="c4">&nbsp;</span><span class="c1">-ETOOMANYREFS;</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">map-&gt;refs++;</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">}</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c1">match</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">map;</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c0">break</span><span class="c1">;</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c4">&nbsp; &nbsp; </span><span class="c1">}</span><span class="c6 c4">&nbsp; </span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span>While this code makes sense for </span><span class="c8">fl</span><span>&nbsp;</span><span class="c20">local</span><span>&nbsp;maps where </span><span class="c8">map-&gt;va</span><span>&nbsp;is set to a userland provided value, in the case of </span><span class="c20">global</span><span>&nbsp;maps they are set to a </span><span class="c20">kernel</span><span>&nbsp;</span><span class="c8">struct page</span><span>&nbsp;pointer that serves as an opaque handle for the allocated memory. Consequently, via </span><span class="c8">fastrpc_internal_mem_map</span><span>, an attacker can cause a userland provided value to be compared to a kernel </span><span class="c8">struct page</span><span>&nbsp;pointer. Furthermore the ioctl return value can differ based on whether the comparison returns true or false, allowing an attacker to brute force page pointer addresses associated with a </span><span class="c8">fastrpc_map</span><span class="c6 c13">&nbsp;object.</span></p><h4 class="c15" id="h.jmnjfxzayael"><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451725">CVE-2024-49848: FASTRPC_ATTR_KEEP_MAP logic bug allows fastrpc_internal_munmap_fd to racily free in-use mappings leading to UAF</a></span></h4><p class="c5"><span>One critically important aspect of the </span><span class="c8">fastrpc_internal_mem_unmap</span><span>&nbsp;and </span><span class="c8">fastrpc_internal_munmap</span><span>&nbsp;functions is their reliance on </span><span class="c8">fastrpc_mmap_remove</span><span>&nbsp;when trying to find a map to delete. This function contains a list of checks to attempt to ensure that it cannot free a map presently in use:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c7 c4">//Entered with fl mapping mutexes held</span></p><p class="c5"><span class="c1">s</span><span class="c0">tatic </span><span class="c4 c9">int</span><span class="c0">&nbsp;</span><span class="c1">fastrpc_mmap_remove(</span><span class="c0">struct </span><span class="c1">fastrpc_file</span><span class="c0">&nbsp;</span><span class="c1">*fl,</span><span class="c0">&nbsp;</span><span class="c4 c9">int</span><span class="c0">&nbsp;</span><span class="c1">fd,</span><span class="c0">&nbsp;</span><span class="c1">uintptr_t</span><span class="c0">&nbsp;</span><span class="c1">va,</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">size_t</span><span class="c0">&nbsp;</span><span class="c1">len,</span><span class="c0">&nbsp;struct </span><span class="c1">fastrpc_mmap</span><span class="c0">&nbsp;</span><span class="c1">**ppmap)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct </span><span class="c1">fastrpc_mmap</span><span class="c0">&nbsp;</span><span class="c1">*match</span><span class="c0">&nbsp;</span><span class="c1">=</span><span class="c0">&nbsp;NULL</span><span class="c1">,</span><span class="c0">&nbsp;</span><span class="c1">*map;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct </span><span class="c1">hlist_node</span><span class="c0">&nbsp;</span><span class="c1">*n;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct </span><span class="c1">fastrpc_apps</span><span class="c0">&nbsp;</span><span class="c1">*me</span><span class="c0">&nbsp;</span><span class="c1">=</span><span class="c0">&nbsp;</span><span class="c1">&amp;gfa;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">unsigned</span><span class="c0">&nbsp;</span><span class="c4 c9">long</span><span class="c0">&nbsp;</span><span class="c1">irq_flags</span><span class="c0">&nbsp;</span><span class="c1">=</span><span class="c0">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5 c12"><span class="c0 c11"></span></p><p class="c5 c18"><span class="c1">...</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">hlist_for_each_entry_safe(map,</span><span class="c0">&nbsp;</span><span class="c1">n,</span><span class="c0">&nbsp;</span><span class="c1">&amp;fl-&gt;maps,</span><span class="c0">&nbsp;</span><span class="c1">hn)</span><span class="c0">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if </span><span class="c1">((fd</span><span class="c0">&nbsp;</span><span class="c1">&lt;</span><span class="c0">&nbsp;</span><span class="c4 c14">0</span><span class="c0">&nbsp;</span><span class="c1">||</span><span class="c0">&nbsp;</span><span class="c1">map-&gt;fd</span><span class="c0">&nbsp;</span><span class="c1">==</span><span class="c0">&nbsp;</span><span class="c1">fd)</span><span class="c0">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c0">&nbsp;</span><span class="c1">map-&gt;raddr</span><span class="c0">&nbsp;</span><span class="c1">==</span><span class="c0">&nbsp;</span><span class="c1">va</span><span class="c0">&nbsp;</span><span class="c1">&amp;&amp;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;raddr</span><span class="c0">&nbsp;</span><span class="c1">+</span><span class="c0">&nbsp;</span><span class="c1">map-&gt;len</span><span class="c0">&nbsp;</span><span class="c1">==</span><span class="c0">&nbsp;</span><span class="c1">va</span><span class="c0">&nbsp;</span><span class="c1">+</span><span class="c0">&nbsp;</span><span class="c1">len</span><span class="c0">&nbsp;</span><span class="c1">&amp;&amp;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;refs</span><span class="c0">&nbsp;</span><span class="c1">==</span><span class="c0">&nbsp;</span><span class="c4 c14">1</span><span class="c0">&nbsp;</span><span class="c1">&amp;&amp; </span><span class="c7 c4">//verifies only 1 reference (from map creation)</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">/*</span><span class="c0">&nbsp;</span><span class="c1">Remove</span><span class="c0">&nbsp;if </span><span class="c1">only</span><span class="c0">&nbsp;</span><span class="c1">one</span><span class="c0">&nbsp;</span><span class="c1">reference</span><span class="c0">&nbsp;</span><span class="c1">map</span><span class="c0">&nbsp;</span><span class="c1">and</span><span class="c0">&nbsp;</span><span class="c1">no</span><span class="c0">&nbsp;</span><span class="c1">context</span><span class="c0">&nbsp;</span><span class="c1">map</span><span class="c0">&nbsp;</span><span class="c1">*/</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">!map-&gt;ctx_refs</span><span class="c0">&nbsp;</span><span class="c1">&amp;&amp; </span><span class="c7 c4">//And that no context holds a reference (important because context creation can create maps as well)</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">/*</span><span class="c0">&nbsp;</span><span class="c1">Skip</span><span class="c0">&nbsp;</span><span class="c1">unmap</span><span class="c0">&nbsp;if </span><span class="c1">it</span><span class="c0">&nbsp;</span><span class="c1">is</span><span class="c0">&nbsp;</span><span class="c1">fastrpc</span><span class="c0">&nbsp;</span><span class="c1">shell</span><span class="c0">&nbsp;</span><span class="c1">memory</span><span class="c0">&nbsp;</span><span class="c1">*/</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">!map-&gt;is_filemap)</span><span class="c0">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">match</span><span class="c0">&nbsp;</span><span class="c1">=</span><span class="c0">&nbsp;</span><span class="c1">map;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">hlist_del_init(&amp;map-&gt;hn);</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</span><span class="c1">;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if </span><span class="c1">(match)</span><span class="c0">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">*ppmap</span><span class="c0">&nbsp;</span><span class="c1">=</span><span class="c0">&nbsp;</span><span class="c1">match;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return </span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return </span><span class="c1">-ETOOMANYREFS;</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span>This function tries to ensure there can be no references to a map outside of the initial reference set upon creation of the map. </span><span>This works </span><span class="c20">as long as</span><span>&nbsp;there are never any references to the map unassociated with an explicit reference (</span><span class="c8">map-&gt;refs &gt; 1 || map-&gt;ctx_refs &gt; 0</span><span>) concurrent to this function. This is in fact, precisely the invariant violated by CVE-2024-33060! In that case, we have a transient stack-based reference (from map creation) that doesn&rsquo;t take an explicit reference (</span><span class="c8">map-&gt;refs == 1</span><span>) that is concurrent to this function (since the transient reference was held beyond the global mutexing lock).</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>This invariant check is clearly a bit fragile to begin with, but there are at least two other paths to potential map destruction that don&rsquo;t utilize this </span><span class="c8">fastrpc_mmap_remove</span><span>&nbsp;path and the guarantees it tries to provide. One of these paths is </span><span class="c8">fastrpc_internal_munmap_fd</span><span class="c6 c13">:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c1">/*</span></p><p class="c5"><span class="c4">&nbsp;</span><span class="c1">*</span><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_internal_munmap_fd</span><span class="c4">&nbsp;</span><span class="c1">can</span><span class="c4">&nbsp;</span><span class="c1">only</span><span class="c4">&nbsp;</span><span class="c1">be</span><span class="c4">&nbsp;</span><span class="c1">used</span><span class="c4">&nbsp;</span><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">buffers</span></p><p class="c5"><span class="c4">&nbsp;</span><span class="c1">*</span><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mapped</span><span class="c4">&nbsp;</span><span class="c1">with</span><span class="c4">&nbsp;</span><span class="c1">persist</span><span class="c4">&nbsp;</span><span class="c1">attributes.</span><span class="c4">&nbsp;</span><span class="c1">This</span><span class="c4">&nbsp;</span><span class="c1">can</span><span class="c4">&nbsp;</span><span class="c1">only</span><span class="c4">&nbsp;</span><span class="c1">be</span><span class="c4">&nbsp;</span><span class="c1">called</span></p><p class="c5"><span class="c4">&nbsp;</span><span class="c1">*</span><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">once</span><span class="c4">&nbsp;</span><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">any</span><span class="c4">&nbsp;</span><span class="c1">persist</span><span class="c4">&nbsp;</span><span class="c1">buffer</span></p><p class="c5"><span class="c4">&nbsp;</span><span class="c1">*/</span></p><p class="c5"><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_internal_munmap_fd(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_ioctl_munmap_fd</span><span class="c4">&nbsp;</span><span class="c1">*ud)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap</span><span class="c4">&nbsp;</span><span class="c1">*map</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;internal_map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_find(fl,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;fd,</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;va,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;len,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c1">&amp;map);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(err)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">goto</span><span class="c4">&nbsp;</span><span class="c1">bail;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;attr</span><span class="c4">&nbsp;</span><span class="c1">&amp;</span><span class="c4">&nbsp;</span><span class="c1">FASTRPC_ATTR_KEEP_MAP))</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;attr</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;attr</span><span class="c4">&nbsp;</span><span class="c1">&amp;</span><span class="c4">&nbsp;</span><span class="c1">(~FASTRPC_ATTR_KEEP_MAP);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_mmap_free(map,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c1">bail:</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;internal_map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">return</span><span class="c4">&nbsp;</span><span class="c1">err;</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span>We can see that this function finds a map and calls </span><span class="c8">fastrpc_mmap_free</span><span>&nbsp;on that map if the flag </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span>&nbsp;is set. It also unsets this flag, so it&rsquo;s impossible to call this function on the same map more than once. &nbsp;Looking inside of </span><span class="c8">fastrpc_mmap_create</span><span class="c6 c13">&nbsp;we see a corresponding line of code that adds an additional reference in the case where this flag is set:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c0">static</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_create(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl,</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">fd,</span><span class="c4">&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">dma_buf</span><span class="c4">&nbsp;</span><span class="c1">*buf,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">unsigned</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">attr,</span><span class="c4">&nbsp;</span><span class="c1">uintptr_t</span><span class="c4">&nbsp;</span><span class="c1">va,</span><span class="c4">&nbsp;</span><span class="c1">size_t</span><span class="c4">&nbsp;</span><span class="c1">len,</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">mflags,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap</span><span class="c4">&nbsp;</span><span class="c1">**ppmap)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">kzalloc(</span><span class="c0">sizeof</span><span class="c1">(*map),</span><span class="c4">&nbsp;</span><span class="c1">GFP_KERNEL);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">INIT_HLIST_NODE(&amp;map-&gt;hn);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;flags</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">mflags;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;refs</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">1</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;fl</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fl;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;fd</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fd;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;attr</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">attr;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;ctx_refs</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ktime_get_real_ts64(&amp;map-&gt;map_start_time);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(mflags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">ADSP_MMAP_HEAP_ADDR</span><span class="c4">&nbsp;</span><span class="c1">||</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mflags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">ADSP_MMAP_REMOTE_HEAP_ADDR)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span><span class="c4">&nbsp;</span><span class="c0">else</span><span class="c4">&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(mflags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">FASTRPC_MAP_FD_NOMAP)</span><span class="c4">&nbsp;</span><span class="c1 c11">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span><span class="c4">&nbsp;</span><span class="c0">else</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;attr</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;attr</span><span class="c4">&nbsp;</span><span class="c1">&amp;</span><span class="c4">&nbsp;</span><span class="c1">FASTRPC_ATTR_KEEP_MAP))</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ADSPRPC_INFO(</span><span class="c2">&quot;buffer mapped with persist attr 0x%x\n&quot;</span><span class="c1">,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">(</span><span class="c4 c9">unsigned</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c1">)map-&gt;attr);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;refs</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">2</span><span class="c1">; </span><span class="c7 c4">//References increases to 2</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;va</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">va;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;len</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">len;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_mmap_add(map);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">*ppmap</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">map;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c1">bail:</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">return</span><span class="c4">&nbsp;</span><span class="c1">err;</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span>However we can see that </span><span class="c8">map-&gt;refs</span><span>&nbsp;is </span><span class="c20">only</span><span>&nbsp;bumped in the default case where </span><span class="c8">mflags</span><span>&nbsp;isn&rsquo;t equal to one of </span><span class="c8">ADSP_MMAP_HEAP_ADDR</span><span>, </span><span class="c8">ADSP_MMAP_REMOTE_HEAP_ADDR</span><span>&nbsp;or </span><span class="c8">FASTRPC_MAP_FD_NOMAP</span><span>. We can also see that </span><span class="c20">regardless</span><span>&nbsp;of the </span><span class="c8">mflags</span><span>&nbsp;value, it is possible to set </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span>&nbsp;- so it is still possible to create a </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span>&nbsp;map with </span><span class="c8">map-&gt;refs == 1</span><span>! This means that the map is visible to a </span><span class="c8">fastrpc_internal_munmap_fd</span><span>&nbsp;call which doesn&rsquo;t guarantee the invariant provided by </span><span class="c8">fastrpc_mmap_remove</span><span>&nbsp;is unviolated when </span><span class="c8">fastrpc_mmap_free</span><span>&nbsp;gets called. This can be a problem for example, when a context takes a reference to a </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span>, </span><span class="c8">FASTRPC_MAP_FD_NOMAP </span><span>mapping in </span><span class="c8">get_args</span><span class="c6 c13">:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c0">static</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">get_args(uint32_t</span><span class="c4">&nbsp;</span><span class="c1">kernel,</span><span class="c4">&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">smq_invoke_ctx</span><span class="c4">&nbsp;</span><span class="c1">*ctx)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">remote_arg64_t</span><span class="c4">&nbsp;</span><span class="c1">*rpra,</span><span class="c4">&nbsp;</span><span class="c1">*lrpra;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">remote_arg_t</span><span class="c4">&nbsp;</span><span class="c1">*lpra</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;lpra;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">mflags</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">(i</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span><span class="c4">&nbsp;</span><span class="c1">i</span><span class="c4">&nbsp;</span><span class="c1">&lt;</span><span class="c4">&nbsp;</span><span class="c1">bufs;</span><span class="c4">&nbsp;</span><span class="c1">++i)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">uintptr_t</span><span class="c4">&nbsp;</span><span class="c1">buf</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">(uintptr_t)lpra[i].buf.pv;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">size_t</span><span class="c4">&nbsp;</span><span class="c1">len</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">lpra[i].buf.len;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;ctx-&gt;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;fds</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;fds[i]</span><span class="c4">&nbsp;</span><span class="c1">!=</span><span class="c4">&nbsp;</span><span class="c4 c14">-1</span><span class="c1">))</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_create(ctx-&gt;fl,</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;fds[i],</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;attrs[i],</span><span class="c4">&nbsp;</span><span class="c1">buf,</span><span class="c4">&nbsp;</span><span class="c1">len,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mflags,</span><span class="c4">&nbsp;</span><span class="c1">&amp;ctx-&gt;maps[i]);</span><span class="c7 c4">//Can take a reference to an existing mapping</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;maps[i])</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;maps[i]-&gt;ctx_refs++;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;ctx-&gt;fl-&gt;map_mutex);</span></p><p class="c5 c18 c23"><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span></span><span class="c8">map-&gt;ctx_refs</span><span>&nbsp;is set to greater than zero, but this does not stop </span><span class="c8">fastrpc_internal_munmap_fd</span><span>&rsquo;s call to </span><span class="c8">fastrpc_mmap_free </span><span>from calling </span><span class="c8">kfree</span><span>&nbsp;on the map</span><span class="c6 c13">:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c0">static</span><span class="c4">&nbsp;</span><span class="c0">void</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_free(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap</span><span class="c4">&nbsp;</span><span class="c1">*map,</span><span class="c4">&nbsp;</span><span class="c1">uint32_t</span><span class="c4">&nbsp;</span><span class="c1">flags)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;flags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">ADSP_MMAP_HEAP_ADDR</span><span class="c4">&nbsp;</span><span class="c1">||</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;flags</span><span class="c4">&nbsp;</span><span class="c1">==</span><span class="c4">&nbsp;</span><span class="c1">ADSP_MMAP_REMOTE_HEAP_ADDR)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span><span class="c4">&nbsp;</span><span class="c0">else</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">map-&gt;refs--;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!map-&gt;refs</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">!map-&gt;ctx_refs)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">hlist_del_init(&amp;map-&gt;hn);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map-&gt;refs</span><span class="c4">&nbsp;</span><span class="c1">&gt;</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">!flags) </span><span class="c7 c4">//This is the only relevant bailout to avoid freeing map - ctx_refs value does not influence free decision</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">return</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c1">bail:</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!map-&gt;is_persistent)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">kfree(map); </span><span class="c4 c7">//Map is destroyed here!</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span>This means it&rsquo;s theoretically possible to create a UAF mapping if a fastrpc context holds the </span><span class="c20">only</span><span>&nbsp;reference to a </span><span class="c8">FASTRPC_MAP_FD_NOMAP</span><span>&nbsp;mapping with the </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span>&nbsp;attribute set. This cocktail of flags and attributes is possible with </span><span class="c8">fastrpc_internal_mem_map</span><span>, however it&rsquo;s not immediately apparent how to cause a context to hold the only reference. The only intended circumstance where a context holds the sole reference to a map is when context creation and initialization leads directly to map creation - but in that map creation path, it&rsquo;s not possible to specify the flags and attributes necessary to create the needed edge case. We need to have </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;create the map, have a context take a reference, and then somehow drop the initial reference that map creation provides. We cannot do this with </span><span class="c8">fastrpc_internal_mem_unmap</span><span>&nbsp;(because of the guarantees provided by </span><span class="c8">fastrpc_mmap_remove</span><span>) but we CAN racily do this by taking the </span><span class="c8">fastrpc_internal_mem_map</span><span class="c6 c13">&nbsp;bailout after the map is created and a context has taken a reference!</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_internal_mem_map(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_file</span><span class="c4">&nbsp;</span><span class="c1">*fl,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_ioctl_mem_map</span><span class="c4">&nbsp;</span><span class="c1">*ud)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap</span><span class="c4">&nbsp;</span><span class="c1">*map</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">;</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;internal_map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">VERIFY(err,</span><span class="c4">&nbsp;</span><span class="c1">!(err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_create(fl,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.fd,</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.attrs,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ud-&gt;m.vaddrin,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.length,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ud-&gt;m.flags,</span><span class="c4">&nbsp;</span><span class="c1">&amp;map))); </span><span class="c7 c4">//Create the map here</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">... </span><span class="c7 c4">//Have a context take a reference to the created map here</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">VERIFY(err,</span><span class="c4">&nbsp;</span><span class="c1">!(err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mem_map_to_dsp(fl,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.fd,</span><span class="c4">&nbsp;</span><span class="c1">ud-&gt;m.offset,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ud-&gt;m.flags,</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;va,</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;phys,</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;size,</span><span class="c4">&nbsp;</span><span class="c1">&amp;map-&gt;raddr))); </span><span class="c7 c4">//Fail this</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(err)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">goto</span><span class="c4">&nbsp;</span><span class="c1">bail; </span><span class="c7 c4">//bailout</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ud-&gt;m.vaddrout</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">map-&gt;raddr;</span></p><p class="c5"><span class="c1">bail:</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(err)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(map)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_lock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_mmap_free(map,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">); </span><span class="c7 c4">//Drop reference leaving the context as the only reference holder</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;fl-&gt;internal_map_mutex);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">return</span><span class="c4">&nbsp;</span><span class="c1">err;</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span></span></p><p class="c5"><span class="c6 c13">Consider two concurrent processes (A and B) implementing the following sequence of events:</span></p><p class="c5"><span>[A]: Completely fills the dsp address space with valid mappings using </span><span class="c6 c8 c16">fastrpc_internal_mem_map</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>[A]: Creates a </span><span class="c8">FASTRPC_MAP_FD_NOMAP</span><span>&nbsp;map with attribute </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span>&nbsp;using </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;and enters into </span><span class="c8">fastrpc_mem_map_to_dsp</span><span>&nbsp;(holding </span><span class="c8">internal_map_mutex</span><span>, dropped </span><span class="c8">map_mutex</span><span class="c6 c13">)</span></p><p class="c5"><span class="c6 c8 c16">map-&gt;refs == 1, map-&gt;ctx_refs == 0</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>[B]: Invokes a call using </span><span class="c8">FASTRPC_IOCTL_INVOKE2</span><span>&nbsp;and creates a context, </span><span class="c8">get_args</span><span class="c6 c13">&nbsp;grabs the map mutex, finds and grabs a reference to map, drops the map mutex (not holding any mutexes)</span></p><p class="c5"><span class="c6 c8 c16">map-&gt;refs == 2, map-&gt;ctx_refs == 1</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>[A]: </span><span class="c8">fastrpc_mem_map_to_dsp</span><span>&nbsp;fails as the dsp address space is completely full, </span><span class="c8">fastrpc_internal_mem_map</span><span>&nbsp;bails out and calls </span><span class="c8">fastrpc_mmap_free</span><span>, dropping the </span><span class="c8">internal_map_mutex</span><span class="c6 c13">&nbsp;(not holding any mutexes)</span></p><p class="c5"><span class="c6 c8 c16">map-&gt;refs == 1, map-&gt;ctx_refs == 1</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>[A]: Calls </span><span class="c8">fastrpc_internal_munmap_fd</span><span>&nbsp;grabs </span><span class="c8">internal_map_mutex</span><span>, and </span><span class="c8">map_mutex</span><span>, finds map with </span><span class="c8">fastrpc_mmap_find</span><span>, and calls </span><span class="c8">fastrpc_mmap_free</span><span>&nbsp;because the </span><span class="c8">FASTRPC_ATTR_KEEP_MAP</span><span class="c6 c13">&nbsp;attribute is set</span></p><p class="c5"><span class="c8">map-&gt;refs == 0, map-&gt;ctx_refs == 1</span><span class="c6 c13">, mapping is kfree&#39;d</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span class="c6 c13">At the end of this sequence, an existing context still holds a reference to the freed map. An example crash from this bug is:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c2">[42694.423088]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">paging</span><span class="c4">&nbsp;</span><span class="c2">request</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">006b6b6b6b6b6c27</span></p><p class="c5"><span class="c2">[42694.423153]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">PC</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">b4000115</span><span class="c4">&nbsp;</span><span class="c2">7100111f</span><span class="c4">&nbsp;</span><span class="c2">540000c0</span><span class="c4">&nbsp;</span><span class="c2">7100211f</span><span class="c4">&nbsp;</span><span class="c2">54000080</span><span class="c4">&nbsp;</span><span class="c2">(b940beb4)</span><span class="c4">&nbsp;</span><span class="c2">71001e9f</span><span class="c4">&nbsp;</span><span class="c2">54001ba2</span><span class="c4">&nbsp;</span><span class="c2">7100211f</span><span class="c4">&nbsp;</span><span class="c2">54000060</span><span class="c4">&nbsp;</span><span class="c2">7100111f</span><span class="c4">&nbsp;</span><span class="c2">54000c21</span><span class="c4">&nbsp;</span><span class="c2">d0000120</span><span class="c4">&nbsp;</span><span class="c2">91040000</span><span class="c4">&nbsp;</span><span class="c2">95658fb7</span><span class="c4">&nbsp;</span><span class="c2">b9406a68</span><span class="c4">&nbsp;</span><span class="c2">aa0003e1</span><span class="c4">&nbsp;</span><span class="c2">71000508</span><span class="c4">&nbsp;</span><span class="c2">b9006a68</span><span class="c4">&nbsp;</span><span class="c2">54000181</span></p><p class="c5"><span class="c2">[42694.423167]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">LR</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">2a1f03e1</span><span class="c4">&nbsp;</span><span class="c2">97ffeafe</span><span class="c4">&nbsp;</span><span class="c2">(91002294)</span><span class="c4">&nbsp;</span><span class="c2">eb1402bf</span></p><p class="c5"><span class="c2">[42694.423229]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[42694.423236]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000004</span></p><p class="c5"><span class="c2">[42694.423243]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EC</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x25:</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[42694.423259]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[42694.423265]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[42694.423270]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">FSC</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x04:</span><span class="c4">&nbsp;</span><span class="c2">level</span><span class="c4">&nbsp;</span><span class="c2">0</span><span class="c4">&nbsp;</span><span class="c2">translation</span><span class="c4">&nbsp;</span><span class="c2">fault</span></p><p class="c5"><span class="c2">[42694.423277]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[42694.423281]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000004</span></p><p class="c5"><span class="c2">[42694.423288]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[42694.423294]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">[006b6b6b6b6b6c27]</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">between</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">and</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">ranges</span></p><p class="c5"><span class="c2">[42694.423304]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000004</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[42694.424942]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Samsung</span><span class="c4">&nbsp;</span><span class="c2">DM1Q</span><span class="c4">&nbsp;</span><span class="c2">PROJECT</span><span class="c4">&nbsp;</span><span class="c2">(board-id,13)</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[42694.424947]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">22400005</span><span class="c4">&nbsp;</span><span class="c2">(nzCv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO</span><span class="c4">&nbsp;</span><span class="c2">+TCO</span><span class="c4">&nbsp;</span><span class="c2">-DIT</span><span class="c4">&nbsp;</span><span class="c2">-SSBS</span><span class="c4">&nbsp;</span><span class="c2">BTYPE=--)</span></p><p class="c5"><span class="c2">[42694.424954]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_mmap_free+0x58/0x734</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425067]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">context_free+0x130/0x2cc</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425173]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc036c4b8d0</span></p><p class="c5"><span class="c2">[42694.425178]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x29:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc036c4b920</span><span class="c4">&nbsp;</span><span class="c2">x28:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x27:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc036c4bba8</span></p><p class="c5"><span class="c2">[42694.425190]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x26:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000003</span><span class="c4">&nbsp;</span><span class="c2">x25:</span><span class="c4">&nbsp;</span><span class="c2">00000049216800d0</span><span class="c4">&nbsp;</span><span class="c2">x24:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc003d62390</span></p><p class="c5"><span class="c2">[42694.425198]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x23:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc003d4ff88</span><span class="c4">&nbsp;</span><span class="c2">x22:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000002</span><span class="c4">&nbsp;</span><span class="c2">x21:</span><span class="c4">&nbsp;</span><span class="c2">6b6b6b6b6b6b6b6b</span></p><p class="c5"><span class="c2">[42694.425206]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x20:</span><span class="c4">&nbsp;</span><span class="c2">00000000ffffffff</span><span class="c4">&nbsp;</span><span class="c2">x19:</span><span class="c4">&nbsp;</span><span class="c2">ffffff88ef024d00</span><span class="c4">&nbsp;</span><span class="c2">x18:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc01e79d028</span></p><p class="c5"><span class="c2">[42694.425215]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x17:</span><span class="c4">&nbsp;</span><span class="c2">ffffffffffffffff</span><span class="c4">&nbsp;</span><span class="c2">x16:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000004</span><span class="c4">&nbsp;</span><span class="c2">x15:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000004</span></p><p class="c5"><span class="c2">[42694.425222]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x14:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8957f20000</span><span class="c4">&nbsp;</span><span class="c2">x13:</span><span class="c4">&nbsp;</span><span class="c2">0000000000001c4a</span><span class="c4">&nbsp;</span><span class="c2">x12:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000003</span></p><p class="c5"><span class="c2">[42694.425231]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x11:</span><span class="c4">&nbsp;</span><span class="c2">0000000100449c4a</span><span class="c4">&nbsp;</span><span class="c2">x10:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8846550040</span><span class="c4">&nbsp;</span><span class="c2">x9</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span></p><p class="c5"><span class="c2">[42694.425239]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x8</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">000000006b6b6b6b</span><span class="c4">&nbsp;</span><span class="c2">x7</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">2820637072707364</span><span class="c4">&nbsp;</span><span class="c2">x6</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">61203a726f727245</span></p><p class="c5"><span class="c2">[42694.425247]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x5</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff88002ada57</span><span class="c4">&nbsp;</span><span class="c2">x4</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">6363346478302041</span><span class="c4">&nbsp;</span><span class="c2">x3</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span></p><p class="c5"><span class="c2">[42694.425255]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">x2</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8846550040</span><span class="c4">&nbsp;</span><span class="c2">x1</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x0</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff88ef024d00</span></p><p class="c5"><span class="c2">[42694.425263]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[42694.425267]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_mmap_free+0x58/0x734</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425373]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">context_free+0x130/0x2cc</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425479]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_internal_invoke+0xb88/0x1ef4</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425584]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_internal_invoke2+0x320/0x408</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425689]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_device_ioctl+0x1b0/0x92c</span><span class="c4">&nbsp;</span><span class="c2">[frpc_adsprpc]</span></p><p class="c5"><span class="c2">[42694.425795]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">__arm64_sys_ioctl+0x120/0x170</span></p><p class="c5"><span class="c2">[42694.425805]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">invoke_syscall+0x58/0x13c</span></p><p class="c5"><span class="c2">[42694.425811]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_common+0xb4/0xf0</span></p><p class="c5"><span class="c2">[42694.425817]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">do_el0_svc+0x24/0x90</span></p><p class="c5"><span class="c2">[42694.425823]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc+0x20/0x7c</span></p><p class="c5"><span class="c2">[42694.425828]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">el0t_64_sync_handler+0x84/0xe4</span></p><p class="c5"><span class="c2">[42694.425833]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp; </span><span class="c2">el0t_64_sync+0x1b8/0x1bc</span></p><p class="c5"><span class="c2">[42694.425842]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">7100111f</span><span class="c4">&nbsp;</span><span class="c2">540000c0</span><span class="c4">&nbsp;</span><span class="c2">7100211f</span><span class="c4">&nbsp;</span><span class="c2">54000080</span><span class="c4">&nbsp;</span><span class="c2">(b940beb4)</span></p><p class="c5"><span class="c2">[42694.425853]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">7349f07610aa0ad6</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c2">[42694.425862]</span><span class="c4">&nbsp;</span><span class="c2">[0:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">7171]</span><span class="c4">&nbsp;</span><span class="c2">Kernel</span><span class="c4">&nbsp;</span><span class="c2">panic</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">syncing:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">Fatal</span><span class="c4">&nbsp;</span><span class="c2">exception</span></p><p class="c5"><span></span></p><h4 class="c15" id="h.c8nm4kjm3nmx"><span class="c11 c19 c22">CVE-2024-43047 (ITW): Map collision leads to UAF on 4.x kernels, and some 5.x kernel configurations</span></h4><p class="c5"><span>At this point, it became apparent that two of these issues bear more than a passing resemblance to the exploit logs. The kernel panics (particularly the first one) strongly suggest that a </span><span class="c8">fastrpc_mmap</span><span>&nbsp;struct is involved in the initial memory corruption primitive, and the exploit makes calls to several ioctls that are responsible for the creation and administration of these structs. Additionally we previously saw memory corruption in the chain of structs/members </span><span class="c8">map-&gt;fl-&gt;cid</span><span>. The logs make a lot of sense in the context of a UAF of this </span><span class="c8">fastrpc_mmap</span><span class="c6 c13">&nbsp;struct, meaning that CVE-2024-33060 and CVE-2024-49848 stand out as particularly plausible candidates to have been the ITW issue used by the attacker. However, if the exploit were triggering CVE-2024-33060, I would have expected it to generate some kernel log lines that we don&rsquo;t see in the ITW artifacts. CVE-2024-49848 is disqualified on the basis of working upon strictly newer kernels than the ITW exploit was used against.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>Complicating the identification of the ITW bug, the exploit repeatedly hits several early bailouts in the ioctl handlers - these bailouts have no discernible side effect and it&rsquo;s unclear why the exploit exercises this code at all. It is difficult to know what log lines from the exploit are due to this behavior and what log lines are related to the exploit exercising the bug used. But the kernel panics themselves do not lie. They are indisputable records of memory corruption, and (particularly in cases where the crash came from the exploit program itself) their associated stack traces are strong indicators of proximity to the bug or to the exploit strategy. </span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>A context treats references to a map differently depending on if the map is used as a buffer or as a handle. The context has a dynamically allocated array for map pointer references in </span><span class="c8">ctx-&gt;maps</span><span class="c6 c13">, and both buffers and handles are referenced in this array.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c0">static</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">get_args(uint32_t</span><span class="c4">&nbsp;</span><span class="c1">kernel,</span><span class="c4">&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">smq_invoke_ctx</span><span class="c4">&nbsp;</span><span class="c1">*ctx)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">uint32_t</span><span class="c4">&nbsp;</span><span class="c1">sc</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;sc;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">inbufs</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">REMOTE_SCALARS_INBUFS(sc);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">outbufs</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">REMOTE_SCALARS_OUTBUFS(sc);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">handles,</span><span class="c4">&nbsp;</span><span class="c1">bufs</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">inbufs</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c1">outbufs;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">(i</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span><span class="c4">&nbsp;</span><span class="c1">i</span><span class="c4">&nbsp;</span><span class="c1">&lt;</span><span class="c4">&nbsp;</span><span class="c1">bufs;</span><span class="c4">&nbsp;</span><span class="c1">++i)</span><span class="c4">&nbsp;</span><span class="c1">{ </span><span class="c7 c4">//buffer references</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;fds</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;fds[i]</span><span class="c4">&nbsp;</span><span class="c1">!=</span><span class="c4">&nbsp;</span><span class="c4 c14">-1</span><span class="c1">))</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_create(ctx-&gt;fl,</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;fds[i],</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;attrs[i],</span><span class="c4">&nbsp;</span><span class="c1">buf,</span><span class="c4">&nbsp;</span><span class="c1">len,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mflags,</span><span class="c4">&nbsp;</span><span class="c1">&amp;ctx-&gt;maps[i]);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;maps[i])</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;maps[i]-&gt;ctx_refs++;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">handles</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">REMOTE_SCALARS_INHANDLES(sc)</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c1">REMOTE_SCALARS_OUTHANDLES(sc);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">(i</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">bufs;</span><span class="c4">&nbsp;</span><span class="c1">i</span><span class="c4">&nbsp;</span><span class="c1">&lt;</span><span class="c4">&nbsp;</span><span class="c1">bufs</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c1">handles;</span><span class="c4">&nbsp;</span><span class="c1">i++)</span><span class="c4">&nbsp;</span><span class="c1">{ </span><span class="c7 c4">//handle references</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!dsp_cap_ptr-&gt;dsp_attributes[DMA_HANDLE_REVERSE_RPC_CAP]</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;fds</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;fds[i]</span><span class="c4">&nbsp;</span><span class="c1">!=</span><span class="c4">&nbsp;</span><span class="c4 c14">-1</span><span class="c1">))</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">err</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">fastrpc_mmap_create(ctx-&gt;fl,</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;fds[i],</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">FASTRPC_ATTR_NOVA,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c1">dmaflags,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">&amp;ctx-&gt;maps[i]);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!err</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;maps[i])</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;maps[i]-&gt;ctx_refs++;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(err)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">(j</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">bufs;</span><span class="c4">&nbsp;</span><span class="c1">j</span><span class="c4">&nbsp;</span><span class="c1">&lt;</span><span class="c4">&nbsp;</span><span class="c1">i;</span><span class="c4">&nbsp;</span><span class="c1">j++)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(ctx-&gt;maps[j]</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">ctx-&gt;maps[j]-&gt;ctx_refs)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">ctx-&gt;maps[j]-&gt;ctx_refs--;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_mmap_free(ctx-&gt;maps[j],</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mutex_unlock(&amp;ctx-&gt;fl-&gt;map_mutex);</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c6 c13"></span></p><p class="c5"><span>However only buffers are freed using the pointer reference in </span><span class="c8">ctx-&gt;maps</span><span>. In fact, once handle maps are initialized without error, their reference in </span><span class="c8">ctx-&gt;maps</span><span>&nbsp;is never used again. Instead, the DSP is given a list of values associated with map file descriptors, and later passes these file descriptors back to the adsprpc driver in the AP once it is done using them. The AP then finds </span><span class="c20">a</span><span class="c6 c13">&nbsp;map associable with the file descriptor returned by the DSP and drops a reference on it, potentially freeing it:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c0">static </span><span class="c4 c9">int</span><span class="c0">&nbsp;</span><span class="c1">put_args(uint32_t</span><span class="c0">&nbsp;</span><span class="c1">kernel,</span><span class="c0">&nbsp;struct </span><span class="c1">smq_invoke_ctx</span><span class="c0">&nbsp;</span><span class="c1">*ctx,</span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; </span><span class="c1">remote_arg_t</span><span class="c0">&nbsp;</span><span class="c1">*upra)</span></p><p class="c5"><span class="c1">{<br>...</span></p><p class="c5 c18"><span class="c0">for</span><span class="c4">&nbsp;</span><span class="c1">(i</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">;</span><span class="c4">&nbsp;</span><span class="c1">i</span><span class="c4">&nbsp;</span><span class="c1">&lt;</span><span class="c4">&nbsp;</span><span class="c1">M_FDLIST;</span><span class="c4">&nbsp;</span><span class="c1">i++)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!fdlist[i])</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">break</span><span class="c1">;</span></p><p class="c5 c18"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(!fastrpc_mmap_find(ctx-&gt;fl,</span><span class="c4">&nbsp;</span><span class="c1">(</span><span class="c4 c9">int</span><span class="c1">)fdlist[i],</span><span class="c4">&nbsp;</span><span class="c0">NULL</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">,</span><span class="c4">&nbsp;</span><span class="c1">&amp;mmap))</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(mmap</span><span class="c4">&nbsp;</span><span class="c1">&amp;&amp;</span><span class="c4">&nbsp;</span><span class="c1">mmap-&gt;ctx_refs)</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">mmap-&gt;ctx_refs--;</span></p><p class="c5 c18"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">fastrpc_mmap_free(mmap,</span><span class="c4">&nbsp;</span><span class="c4 c14">0</span><span class="c1">);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}<br>...</span></p><p class="c5"><span class="c1">}</span></p><p class="c5"><span>This is wrong because there is </span><span class="c20">no</span><span>&nbsp;guarantee that the map found and de-refcounted in </span><span class="c8">put_args</span><span>&nbsp;will be the same map that </span><span class="c8">get_args</span><span>&nbsp;previously took a reference on and it in fact could be a map still referenced by another context as a buffer. I discovered that this can happen if there are map collisions (cases where two created maps would fulfill a </span><span class="c8">fastrpc_mmap_find</span><span>&nbsp;request). Since </span><span class="c8">fastrpc_mmap_find</span><span>&nbsp;will find any mapping that encompasses the searched virtual-address range, you can create a mapping B that collides with future searches for mapping A by comprising a superset of mapping A&#39;s virtual address range, e.g. by setting </span><span class="c8">mapB-&gt;va == mapA-&gt;va &amp;&amp; mapB-&gt;len &gt; mapA-&gt;len</span><span class="c6 c13">.<br><br>An example of this map collision that leads to memory corruption is:</span></p><ol class="lst-kix_mz24o9o07kqy-0 start" start="1"><li class="c5 c21 li-bullet-0"><span>Create a small mapping A with </span><span class="c8">va == 0</span><span>&nbsp;using </span><span class="c6 c8 c16">fastrpc_internal_mmap</span></li><li class="c5 c21 li-bullet-0"><span>Create context 1, </span><span class="c8">get_args</span><span>&nbsp;gets a reference to mapping A as a </span><span class="c20">handle</span><span class="c6 c13">.</span></li><li class="c5 c21 li-bullet-0"><span>Create a BIG second mapping B with </span><span class="c8">va == 0</span><span>&nbsp;using </span><span class="c8">fastrpc_internal_mmap</span><span class="c6 c13">&nbsp;with the same fd as mapping A.</span></li><li class="c5 c21 li-bullet-0"><span>Create context 2, grab a reference to mapping B as a </span><span class="c20">buffer</span><span>&nbsp;(vs a handle) so that we use the </span><span class="c8">ctx-&gt;maps</span><span class="c6 c13">&nbsp;pointer.</span></li><li class="c5 c21 li-bullet-0"><span>Complete context 1, causing </span><span class="c8">put_args</span><span>&nbsp;to be called. </span><span class="c20">We find and drop a refcount on mapping B since it collides with mapping A.</span><span class="c6 c13">&nbsp;Mapping A&rsquo;s refcount is permanently leaked.</span></li><li class="c5 c21 li-bullet-0"><span>We then unmap mapping B using </span><span class="c6 c8 c16">FASTRPC_IOCTL_MUNMAP</span></li></ol><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span class="c6 c13">Now there is a still valid context (context 2 in the above example) that still has a reference to mapping B even though mapping B was freed. Here&rsquo;s an example kernel panic when triggering this bug:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c2">[93168.108618]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">NULL</span><span class="c4">&nbsp;</span><span class="c2">pointer</span><span class="c4">&nbsp;</span><span class="c2">dereference</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">0000000000000018</span></p><p class="c5"><span class="c2">[93168.108656]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Mem</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[93168.108675]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ESR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x96000006</span></p><p class="c5"><span class="c2">[93168.108696]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">Exception</span><span class="c4">&nbsp;</span><span class="c2">class</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">DABT</span><span class="c4">&nbsp;</span><span class="c2">(current</span><span class="c4">&nbsp;</span><span class="c2">EL),</span><span class="c4">&nbsp;</span><span class="c2">IL</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">32</span><span class="c4">&nbsp;</span><span class="c2">bits</span></p><p class="c5"><span class="c2">[93168.108716]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">SET</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">FnV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[93168.108735]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">EA</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">S1PTW</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[93168.108754]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Data</span><span class="c4">&nbsp;</span><span class="c2">abort</span><span class="c4">&nbsp;</span><span class="c2">info:</span></p><p class="c5"><span class="c2">[93168.108773]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">ISV</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">ISS</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x00000006</span></p><p class="c5"><span class="c2">[93168.108792]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">CM</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0,</span><span class="c4">&nbsp;</span><span class="c2">WnR</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0</span></p><p class="c5"><span class="c2">[93168.108816]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">user</span><span class="c4">&nbsp;</span><span class="c2">pgtable:</span><span class="c4">&nbsp;</span><span class="c2">4k</span><span class="c4">&nbsp;</span><span class="c2">pages,</span><span class="c4">&nbsp;</span><span class="c2">39-bit</span><span class="c4">&nbsp;</span><span class="c2">VAs,</span><span class="c4">&nbsp;</span><span class="c2">pgdp</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">00000000a5933260</span></p><p class="c5"><span class="c2">[93168.108837]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">[0000000000000018]</span><span class="c4">&nbsp;</span><span class="c2">pgd=08000001926ef003,</span><span class="c4">&nbsp;</span><span class="c2">pud=08000001926ef003,</span><span class="c4">&nbsp;</span><span class="c2">pmd=0000000000000000</span></p><p class="c5"><span class="c2">[93168.108905]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Internal</span><span class="c4">&nbsp;</span><span class="c2">error:</span><span class="c4">&nbsp;</span><span class="c2">Oops:</span><span class="c4">&nbsp;</span><span class="c2">96000006</span><span class="c4">&nbsp;</span><span class="c2">[#1]</span><span class="c4">&nbsp;</span><span class="c2">PREEMPT</span><span class="c4">&nbsp;</span><span class="c2">SMP</span></p><p class="c5"><span class="c2">[93168.108928]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Modules</span><span class="c4">&nbsp;</span><span class="c2">linked</span><span class="c4">&nbsp;</span><span class="c2">in:</span></p><p class="c5"><span class="c2">[93168.108951]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Process</span><span class="c4">&nbsp;</span><span class="c2">poc</span><span class="c4">&nbsp;</span><span class="c2">(pid:</span><span class="c4">&nbsp;</span><span class="c2">8227,</span><span class="c4">&nbsp;</span><span class="c2">stack</span><span class="c4">&nbsp;</span><span class="c2">limit</span><span class="c4">&nbsp;</span><span class="c2">=</span><span class="c4">&nbsp;</span><span class="c2">0x0000000041a3591e)</span></p><p class="c5"><span class="c2">[93168.108979]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">CPU:</span><span class="c4">&nbsp;</span><span class="c2">3</span><span class="c4">&nbsp;</span><span class="c2">PID:</span><span class="c4">&nbsp;</span><span class="c2">8227</span><span class="c4">&nbsp;</span><span class="c2">Comm:</span><span class="c4">&nbsp;</span><span class="c2">poc</span><span class="c4">&nbsp;</span><span class="c2">FTT:</span><span class="c4">&nbsp;</span><span class="c2">0</span><span class="c4">&nbsp;</span><span class="c2">0</span><span class="c4">&nbsp;</span><span class="c2">Tainted:</span><span class="c4">&nbsp;</span><span class="c2">G</span><span class="c4">&nbsp;</span><span class="c2">S</span><span class="c4">&nbsp; &nbsp; &nbsp; </span><span class="c2">W</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">4.19.113-27095354</span><span class="c4">&nbsp;</span><span class="c2">#1</span></p><p class="c5"><span class="c2">[93168.109000]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Hardware</span><span class="c4">&nbsp;</span><span class="c2">name:</span><span class="c4">&nbsp;</span><span class="c2">Samsung</span><span class="c4">&nbsp;</span><span class="c2">X1Q</span><span class="c4">&nbsp;</span><span class="c2">PROJECT</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">SM-G981V_REV0.3_PV3</span><span class="c4">&nbsp;</span><span class="c2">(board-id,20)</span><span class="c4">&nbsp;</span><span class="c2">(DT)</span></p><p class="c5"><span class="c2">[93168.109024]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">pstate:</span><span class="c4">&nbsp;</span><span class="c2">80400005</span><span class="c4">&nbsp;</span><span class="c2">(Nzcv</span><span class="c4">&nbsp;</span><span class="c2">daif</span><span class="c4">&nbsp;</span><span class="c2">+PAN</span><span class="c4">&nbsp;</span><span class="c2">-UAO)</span></p><p class="c5"><span class="c2">[93168.109047]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">pc</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">dma_buf_unmap_attachment+0x20/0x58</span></p><p class="c5"><span class="c2">[93168.109069]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">lr</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">fastrpc_mmap_free+0x3dc/0x4e8</span></p><p class="c5"><span class="c2">[93168.109088]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">sp</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff80302239c0</span></p><p class="c5"><span class="c2">[93168.109107]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x29:</span><span class="c4">&nbsp;</span><span class="c2">ffffff80302239c0</span><span class="c4">&nbsp;</span><span class="c2">x28:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000002</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109131]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x27:</span><span class="c4">&nbsp;</span><span class="c2">0000000000010100</span><span class="c4">&nbsp;</span><span class="c2">x26:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8030223bf0</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109154]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x25:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc0c518f410</span><span class="c4">&nbsp;</span><span class="c2">x24:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc09152ce00</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109177]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x23:</span><span class="c4">&nbsp;</span><span class="c2">ffffff800b48d0b0</span><span class="c4">&nbsp;</span><span class="c2">x22:</span><span class="c4">&nbsp;</span><span class="c2">0000000000010000</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109199]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x21:</span><span class="c4">&nbsp;</span><span class="c2">00000004f79e0000</span><span class="c4">&nbsp;</span><span class="c2">x20:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000003</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109222]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x19:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc0145d2e00</span><span class="c4">&nbsp;</span><span class="c2">x18:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109244]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x17:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x16:</span><span class="c4">&nbsp;</span><span class="c2">a70d810816bbf5af</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109267]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x15:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000008</span><span class="c4">&nbsp;</span><span class="c2">x14:</span><span class="c4">&nbsp;</span><span class="c2">0000000080000000</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109289]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x13:</span><span class="c4">&nbsp;</span><span class="c2">0000000034155555</span><span class="c4">&nbsp;</span><span class="c2">x12:</span><span class="c4">&nbsp;</span><span class="c2">001d067cf6237800</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109312]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x11:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000007</span><span class="c4">&nbsp;</span><span class="c2">x10:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000003</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109334]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x9</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c4">&nbsp;</span><span class="c2">x8</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109357]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x7</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0001010000000004</span><span class="c4">&nbsp;</span><span class="c2">x6</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8030223c08</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109379]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x5</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffff8030223c08</span><span class="c4">&nbsp;</span><span class="c2">x4</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000004</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109401]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x3</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000037c648b0</span><span class="c4">&nbsp;</span><span class="c2">x2</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">0000000000000000</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.109423]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">x1</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc111df9800</span><span class="c4">&nbsp;</span><span class="c2">x0</span><span class="c4">&nbsp;</span><span class="c2">:</span><span class="c4">&nbsp;</span><span class="c2">ffffffc111df9680</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.114754]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[93168.114777]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">dma_buf_unmap_attachment+0x20/0x58</span></p><p class="c5"><span class="c2">[93168.114799]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_mmap_free+0x3dc/0x4e8</span></p><p class="c5"><span class="c2">[93168.114821]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_internal_invoke+0x1654/0x24b0</span></p><p class="c5"><span class="c2">[93168.114843]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8^R27]</span><span class="c4">&nbsp; </span><span class="c2">fastrpc_device_ioctl+0xcd4/0x1df8</span></p><p class="c5"><span class="c2">[93168.114865]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">do_vfs_ioctl+0x6f0/0xac0</span></p><p class="c5"><span class="c2">[93168.114887]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">__arm64_sys_ioctl+0x74/0xa8</span></p><p class="c5"><span class="c2">[93168.114909]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_common+0xd8/0x188</span></p><p class="c5"><span class="c2">[93168.114931]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc_handler+0x6c/0x90</span></p><p class="c5"><span class="c2">[93168.114952]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp; </span><span class="c2">el0_svc+0x8/0x280</span></p><p class="c5"><span class="c2">[93168.114977]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Code:</span><span class="c4">&nbsp;</span><span class="c2">b4000121</span><span class="c4">&nbsp;</span><span class="c2">f9400008</span><span class="c4">&nbsp;</span><span class="c2">b40000e8</span><span class="c4">&nbsp;</span><span class="c2">f9401108</span><span class="c4">&nbsp;</span><span class="c2">(f9400d08)</span><span class="c6 c4">&nbsp;</span></p><p class="c5"><span class="c2">[93168.115002]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">---[</span><span class="c4">&nbsp;</span><span class="c2">end</span><span class="c4">&nbsp;</span><span class="c2">trace</span><span class="c4">&nbsp;</span><span class="c2">2a2f45652740934f</span><span class="c4">&nbsp;</span><span class="c2">]---</span></p><p class="c5"><span class="c2">[93168.197067]</span><span class="c4">&nbsp; </span><span class="c2">[3:</span><span class="c4">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c2">poc:</span><span class="c4">&nbsp;</span><span class="c2">8227]</span><span class="c4">&nbsp;</span><span class="c2">Kernel</span><span class="c4">&nbsp;</span><span class="c2">panic</span><span class="c4">&nbsp;</span><span class="c2">-</span><span class="c4">&nbsp;</span><span class="c2">not</span><span class="c4">&nbsp;</span><span class="c2">syncing:</span><span class="c4">&nbsp;</span><span class="c2">Fatal</span><span class="c4">&nbsp;</span><span class="c2">exception</span></p><p class="c5"><span>Another researcher, </span><span class="c24"><a href="https://docs.qualcomm.com/product/publicresources/securitybulletin/october-2024-bulletin.html">Conghui Wang</a></span><span>&nbsp;</span><span>appears to have discovered </span><span class="c24"><a href="https://git.codelinaro.org/clo/la/kernel/msm-5.4/-/commit/c6e7698c0cf35551ab16d16ac5e21e2272644734">a different path</a></span><span class="c6 c13">&nbsp;to reach the same bug that does not involve map collisions - since the code running on the DSP can be from an unsigned ELF binary uploaded by the attacker, it&rsquo;s possible for an attacker to simply have the DSP send back bogus fd&rsquo;s in an RPC response, causing the AP kernel to free mappings that are still referenced.</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span>This bug retains a similarly high level of resemblance to the original In-The-Wild exploit as bugs CVE-2024-33060</span><span>&nbsp;and </span><span>CVE-2024-49848 did. It appears to be a UAF on the same object that was likely exploited given the ITW kernel logs (</span><span class="c8">struct fastrpc_mmap</span><span>), and unlike the other discovered bugs cannot be disqualified on the basis of non-intersecting version ranges or log messages. While we cannot prove beyond a doubt that this is the same bug used by the ITW attacker, after careful consideration TAG and Project Zero determined that this issue met the bar for being considered as exploited ITW. We </span><span class="c20">are</span><span class="c6 c13">&nbsp;confident that this driver is under active exploitation by real-world attackers and that all the bugs resolved as part of this research had an outsized impact in preventing in-the-wild exploitation.</span></p><h2 class="c26" id="h.7qtmn0ie3m4t"><span class="c6 c30">Excavating an exploit</span></h2><p class="c5"><span>After discovering these issues, I looked into potential ways to exploit a </span><span class="c8">fastrpc_mmap</span><span class="c6 c13">&nbsp;struct vulnerability. Finding a compatible object to heap spray that would yield a meaningfully improved primitive (especially without an ASLR leak) is not a trivial task for this bug. While looking across the Linux kernel for useful objects to spray, my attention was once again drawn back to the ITW exploit logs, in particular the logs we saw previously involving an invalid channel id:<br></span></p><p class="c5"><span></span><span class="c2">[</span><span class="c4">&nbsp; &nbsp;</span><span class="c2">40.917577]</span><span class="c4">&nbsp;</span><span class="c2">adsprpc:</span><span class="c4">&nbsp;</span><span class="c2">ERROR:fastrpc_mmap_free,</span><span class="c4">&nbsp;</span><span class="c2">Invalid</span><span class="c4">&nbsp;</span><span class="c2">channel</span><span class="c4">&nbsp;</span><span class="c2">id:</span><span class="c4">&nbsp;</span><span class="c2">1702834303,</span><span class="c4">&nbsp;</span><span class="c2">err:-44</span></p><p class="c5"><span>This value is coming from </span><span class="c8">map-&gt;fl-&gt;cid</span><span class="c6 c13">&nbsp;- so it seems exceedingly likely that whatever heap spray object the attacker used had a timestamp value at this offset location. Perhaps it would be possible to discover what object the attacker was heap spraying! After searching fruitlessly for cases of time-related members of variable-sized structs, my attention was drawn to kernel panic log 3:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159424]</span><span class="c4">&nbsp;</span><span class="c2">Unable</span><span class="c4">&nbsp;</span><span class="c2">to</span><span class="c4">&nbsp;</span><span class="c2">handle</span><span class="c4">&nbsp;</span><span class="c2">kernel</span><span class="c4">&nbsp;</span><span class="c2">paging</span><span class="c4">&nbsp;</span><span class="c2">request</span><span class="c4">&nbsp;</span><span class="c2">at</span><span class="c4">&nbsp;</span><span class="c2">virtual</span><span class="c4">&nbsp;</span><span class="c2">address</span><span class="c4">&nbsp;</span><span class="c2">006f7778a9cf5b88</span></p><p class="c5"><span class="c2">...</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159719]</span><span class="c4">&nbsp;</span><span class="c2">Call</span><span class="c4">&nbsp;</span><span class="c2">trace:</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159727]</span><span class="c4">&nbsp; </span><span class="c2">__kmalloc+0x1c4/0x398</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159740]</span><span class="c4">&nbsp; </span><span class="c2">inotify_handle_event+0xc8/0x1c8</span></p><p class="c5"><span class="c2">[</span><span class="c4">&nbsp;</span><span class="c2">2247.159746]</span><span class="c4">&nbsp; </span><span class="c2">fsnotify+0x270/0x378</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span>We see here a crash that occurred in a heap allocation crucially </span><span class="c20">before</span><span>&nbsp;the invalid channel id messages typically appeared in the log. Looking at </span><span class="c8">inotify_handle_event</span><span>&nbsp;more closely we see the following </span><span class="c20">variable-sized</span><span class="c6 c13">&nbsp;allocation:</span></p><p class="c5 c12"><span class="c6 c13"></span></p><p class="c5"><span></span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">inotify_handle_event(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fsnotify_group</span><span class="c4">&nbsp;</span><span class="c1">*group,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">inode</span><span class="c4">&nbsp;</span><span class="c1">*inode,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">u32</span><span class="c4">&nbsp;</span><span class="c1">mask,</span><span class="c4">&nbsp;</span><span class="c1">const</span><span class="c4">&nbsp;</span><span class="c0">void</span><span class="c4">&nbsp;</span><span class="c1">*data,</span><span class="c4">&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">data_type,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">const</span><span class="c4">&nbsp;</span><span class="c4 c9">unsigned</span><span class="c4">&nbsp;</span><span class="c4 c9">char</span><span class="c4">&nbsp;</span><span class="c1">*file_name,</span><span class="c4">&nbsp;</span><span class="c1">u32</span><span class="c4">&nbsp;</span><span class="c1">cookie,</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">fsnotify_iter_info</span><span class="c4">&nbsp;</span><span class="c1">*iter_info)</span></p><p class="c5"><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">inotify_event_info</span><span class="c4">&nbsp;</span><span class="c1">*event;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c4 c9">int</span><span class="c4">&nbsp;</span><span class="c1">alloc_len</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c0">sizeof</span><span class="c1">(</span><span class="c0">struct</span><span class="c4">&nbsp;</span><span class="c1">inotify_event_info);</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">if</span><span class="c4">&nbsp;</span><span class="c1">(file_name)</span><span class="c4">&nbsp;</span><span class="c1">{</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">len</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">strlen(file_name);</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">alloc_len</span><span class="c4">&nbsp;</span><span class="c1">+=</span><span class="c4">&nbsp;</span><span class="c1">len</span><span class="c4">&nbsp;</span><span class="c1">+</span><span class="c4">&nbsp;</span><span class="c4 c14">1</span><span class="c1">;</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">}</span></p><p class="c5 c12"><span class="c6 c4"></span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">...</span></p><p class="c5"><span class="c4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c1">event</span><span class="c4">&nbsp;</span><span class="c1">=</span><span class="c4">&nbsp;</span><span class="c1">kmalloc(alloc_len,</span><span class="c4">&nbsp;</span><span class="c1">GFP_KERNEL_ACCOUNT</span><span class="c4">&nbsp;</span><span class="c1">|</span><span class="c4">&nbsp;</span><span class="c1">__GFP_RETRY_MAYFAIL);</span></p><p class="c5"><span></span><span>I then compared the struct offsets for</span><span class="c8">&nbsp;map-&gt;fl-&gt;cid</span><span>&nbsp;and superimposed them onto a struct </span><span class="c8">inotify_event_info</span><span>&nbsp;object. </span><span>We see that </span><span class="c8">map-&gt;fl-&gt;cid</span><span>&nbsp;aligns perfectly with </span><span class="c8">event-&gt;fse.inode-&gt;i_mtime</span><span>&nbsp;- the modification time for the file inode associated with the inotify event</span><span>!</span><span>&nbsp;Given that the cid is set to a timestamp value by the exploit, this makes perfect sense. It&rsquo;s highly likely that part of the ITW exploit process involved spraying </span><span class="c8">inotify_event_info</span><span>&nbsp;objects in order to reclaim a UAF&rsquo;d </span><span class="c8">fastrpc_mmap</span><span>&nbsp;struct (</span><span class="c24"><a href="https://mcyoloswagham.github.io/linux/">perhaps as part of an ASLR leak</a></span><span>), and that the unrealistic channel id value is the modification time for whatever file the exploit used for the heap spray. Based on the pipe crash, it seems plausible it then reallocates the </span><span class="c8">fastrpc_mmap</span><span class="c6 c13">&nbsp;struct with pipe buffers to gain full control of the underlying object. This, plus an info leak, would be more than enough to achieve code execution or arbitrary read/write.</span></p><h2 class="c26" id="h.514dx1md8ils"><span class="c6 c30">Conclusion</span></h2><p class="c5"><span>It took less than 3 months of research to discover 6 separate bugs in the adsprpc driver, two of which (</span><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451725">CVE-2024-49848</a></span><span>&nbsp;and </span><span class="c24"><a href="https://project-zero.issues.chromium.org/issues/42451710">CVE-2024-21455</a></span><span>) were not fixed by Qualcomm under the </span><span>industry standard 90-day deadline</span><span>. Furthermore, a</span><span>t the time of writing, CVE-2024-49848 remains unfixed 145 days after it was reported.</span><span>&nbsp;</span><span class="c24"><a href="https://googleprojectzero.blogspot.com/2024/06/driving-forward-in-android-drivers.html">Past research</a></span><span>&nbsp;has shown</span><span>&nbsp;</span><span>that chipset drivers for </span><span>Android</span><span class="c6 c13">&nbsp;are a promising target for attackers, and this ITW exploit represents a meaningful real-world example of the negative ramifications that the current third-party vendor driver security posture poses to end-users. A system&rsquo;s cybersecurity is only as strong as its weakest link, and chipset/GPU drivers represent one of the weakest links for privilege separation on Android in 2024. Improving both the consistency and quality of code and the efficiency of the third-party vendor driver patch dissemination process are crucial next steps in order to increase the difficulty of privilege escalation on Android devices.</span></p><div><p class="c5 c12"><span class="c6 c13"></span></p></div></body></html>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
Posted by
<span class='fn' itemprop='author' itemscope='itemscope' itemtype='http://schema.org/Person'>
<meta content='https://www.blogger.com/profile/08975904405228580347' itemprop='url'/>
<a class='g-profile' href='https://www.blogger.com/profile/08975904405228580347' rel='author' title='author profile'>
<span itemprop='name'>Google Project Zero</span>
</a>
</span>
</span>
<span class='post-timestamp'>
at
<meta content='https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html' itemprop='url'/>
<a class='timestamp-link' href='https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2024-12-15T22:11:00-08:00'>10:11&#8239;PM</abbr></a>
</span>
<span class='post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1053444070'>
<a href='https://www.blogger.com/post-edit.g?blogID=4838136820032157985&postID=7918586333811798677&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=7918586333811798677&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=7918586333811798677&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=7918586333811798677&target=twitter' target='_blank' title='Share to X'><span class='share-button-link-text'>Share to X</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=7918586333811798677&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=7918586333811798677&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
<div class='comments' id='comments'>
<a name='comments'></a>
<h4>No comments:</h4>
<div id='Blog1_comments-block-wrapper'>
<dl class='avatar-comment-indent' id='comments-block'>
</dl>
</div>
<p class='comment-footer'>
<div class='comment-form'>
<a name='comment-form'></a>
<h4 id='comment-post-message'>Post a Comment</h4>
<p>
</p>
<a href='https://www.blogger.com/comment/frame/4838136820032157985?po=7918586333811798677&hl=en' id='comment-editor-src'></a>
<iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410px' id='comment-editor' name='comment-editor' src='' width='100%'></iframe>
<script src='https://www.blogger.com/static/v1/jsbin/2315299244-comment_from_post_iframe.js' type='text/javascript'></script>
<script type='text/java                   '>
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
</p>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='https://googleprojectzero.blogspot.com/2024/12/windows-tooling-updates-oleviewnet.html' id='Blog1_blog-pager-older-link' title='Older Post'>Older Post</a>
</span>
<a class='home-link' href='https://googleprojectzero.blogspot.com/'>Home</a>
</div>
<div class='clear'></div>
<div class='post-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='https://googleprojectzero.blogspot.com/feeds/7918586333811798677/comments/default' target='_blank' type='application/atom+xml'>Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
</div>
<div class='column-left-outer'>
<div class='column-left-inner'>
<aside>
</aside>
</div>
</div>
<div class='column-right-outer'>
<div class='column-right-inner'>
<aside>
<div class='sidebar section' id='sidebar-right-1'><div class='widget BlogSearch' data-version='1' id='BlogSearch1'>
<h2 class='title'>Search This Blog</h2>
<div class='widget-content'>
<div id='BlogSearch1_form'>
<form action='https://googleprojectzero.blogspot.com/search' class='gsc-search-box' target='_top'>
<table cellpadding='0' cellspacing='0' class='gsc-search-box'>
<tbody>
<tr>
<td class='gsc-input'>
<input autocomplete='off' class='gsc-input' name='q' size='10' title='search' type='text' value=''/>
</td>
<td class='gsc-search-button'>
<input class='gsc-search-button' title='search' type='submit' value='Search'/>
</td>
</tr>
</tbody>
</table>
</form>
</div>
</div>
<div class='clear'></div>
</div><div class='widget PageList' data-version='1' id='PageList1'>
<h2>Pages</h2>
<div class='widget-content'>
<ul>
<li>
<a href='https://googleprojectzero.blogspot.com/p/about-project-zero.html'>About Project Zero</a>
</li>
<li>
<a href='https://googleprojectzero.blogspot.com/p/working-at-project-zero.html'>Working at Project Zero</a>
</li>
<li>
<a href='https://googleprojectzero.blogspot.com/p/0day.html'>0day "In the Wild"</a>
</li>
<li>
<a href='https://googleprojectzero.github.io/0days-in-the-wild/rca.html'>0day Exploit Root Cause Analyses</a>
</li>
<li>
<a href='https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html'>Vulnerability Disclosure FAQ</a>
</li>
</ul>
<div class='clear'></div>
</div>
</div><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Archives</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2024/'>
2024
</a>
<span class='post-count' dir='ltr'>(11)</span>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2024/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='posts'>
<li><a href='https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html'>The Qualcomm DSP Driver - Unexpectedly Excavating ...</a></li>
<li><a href='https://googleprojectzero.blogspot.com/2024/12/windows-tooling-updates-oleviewnet.html'>Windows Tooling Updates: OleView.NET</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2024/11/'>
November
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2024/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2024/06/'>
June
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2024/04/'>
April
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/'>
2023
</a>
<span class='post-count' dir='ltr'>(11)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/09/'>
September
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/08/'>
August
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/04/'>
April
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2023/01/'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/'>
2022
</a>
<span class='post-count' dir='ltr'>(17)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/11/'>
November
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/06/'>
June
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/04/'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/03/'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/02/'>
February
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2022/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/'>
2021
</a>
<span class='post-count' dir='ltr'>(24)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/10/'>
October
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/09/'>
September
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/06/'>
June
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/04/'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/02/'>
February
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2021/01/'>
January
</a>
<span class='post-count' dir='ltr'>(10)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/'>
2020
</a>
<span class='post-count' dir='ltr'>(36)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/09/'>
September
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/08/'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/07/'>
July
</a>
<span class='post-count' dir='ltr'>(8)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/06/'>
June
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/04/'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/02/'>
February
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2020/01/'>
January
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/'>
2019
</a>
<span class='post-count' dir='ltr'>(27)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/09/'>
September
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/08/'>
August
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/04/'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/03/'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/02/'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2019/01/'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/'>
2018
</a>
<span class='post-count' dir='ltr'>(22)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/12/'>
December
</a>
<span class='post-count' dir='ltr'>(7)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/10/'>
October
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/09/'>
September
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/08/'>
August
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/06/'>
June
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/04/'>
April
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2018/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/'>
2017
</a>
<span class='post-count' dir='ltr'>(19)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/10/'>
October
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/09/'>
September
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/08/'>
August
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/04/'>
April
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2017/02/'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/'>
2016
</a>
<span class='post-count' dir='ltr'>(17)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/09/'>
September
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/06/'>
June
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/03/'>
March
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/02/'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2016/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/'>
2015
</a>
<span class='post-count' dir='ltr'>(33)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/11/'>
November
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/09/'>
September
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/08/'>
August
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/07/'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/06/'>
June
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/05/'>
May
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/04/'>
April
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/03/'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/02/'>
February
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2015/01/'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/'>
2014
</a>
<span class='post-count' dir='ltr'>(11)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/11/'>
November
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/09/'>
September
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/08/'>
August
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://googleprojectzero.blogspot.com/2014/07/'>
July
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<script type='text/javascript'>
//<![CDATA[
(function(){
  let archive_list = document.getElementById('ArchiveList');
  if (archive_list == null) return;
  let cur_year = archive_list.querySelector('.post-count-link').innerText.trim() - 0;
  let last_year = 2014;
  let elements = [];
  const MONTHS = ',Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec'.split(',');

  let parent = document.getElementById('ArchiveList');
  while (parent.childNodes.length) parent.removeChild(parent.childNodes[0]);

  function fetch_next_year() {
    let url = 'https://googleprojectzero.blogspot.com/?action=getTitles&widgetId=BlogArchive1&widgetType=BlogArchive&responseType=js&path=https%3A%2F%2Fgoogleprojectzero.blogspot.com%2F'+cur_year;
    fetch(url).then(resp => {
      if (!resp.ok) {
        console.log('http error');
        return;
      }
      resp.text().then(text => {
        let scope = {
          _WidgetManager: {
            _HandleControllerResult: (name, method, results) => {
              elements.push(document.createElement('hr'));
              let year_header = document.createElement('div');
              year_header.appendChild(document.createTextNode(cur_year));
              year_header.style.fontSize = 'large';
              elements.push(year_header);

              let list = document.createElement('ul');
              elements.push(list);

              for (let obj of results.posts) {
                let link_parts = obj.url.split('/');
                let year = link_parts[3];
                let month = link_parts[4];

                let el = document.createElement(/*'div'*/'li');
                el.style.listStyleType = 'square';
                el.style.listStylePosition = 'inside';
                let link = document.createElement('a');
                el.appendChild(link);
                link.appendChild(document.createTextNode(obj.title));
                link.href = obj.url;
                let date_trailer = document.createElement('span');
                el.appendChild(date_trailer);
                //date_trailer.appendChild(document.createTextNode(' ('+year+'-'+month+')'));
                date_trailer.appendChild(document.createTextNode(' ('+MONTHS[parseInt(month, 10)]+')'));
                //date_trailer.style.textAlign = 'right';
                //elements.push(el);
                list.appendChild(el);
              }
            }
          }
        };
        with (scope) { eval(text); }
        if (cur_year == last_year) {
          finish();
        } else {
          cur_year--;
          fetch_next_year();
        }
      });
    });
  }
  fetch_next_year();
  function finish() {
    for (let obj of elements) {
      parent.appendChild(obj);
    }
    console.log(elements);
  }
})();
//]]>
</script>
<div class='clear'></div>
</div>
</div></div>
<table border='0' cellpadding='0' cellspacing='0' class='section-columns columns-2'>
<tbody>
<tr>
<td class='first columns-cell'>
<div class='sidebar no-items section' id='sidebar-right-2-1'></div>
</td>
<td class='columns-cell'>
<div class='sidebar no-items section' id='sidebar-right-2-2'></div>
</td>
</tr>
</tbody>
</table>
<div class='sidebar no-items section' id='sidebar-right-3'></div>
</aside>
</div>
</div>
</div>
<div style='clear: both'></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class='main-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<footer>
<div class='footer-outer'>
<div class='footer-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left footer-fauxborder-left'>
<div class='fauxborder-right footer-fauxborder-right'></div>
<div class='region-inner footer-inner'>
<div class='foot no-items section' id='footer-1'></div>
<table border='0' cellpadding='0' cellspacing='0' class='section-columns columns-2'>
<tbody>
<tr>
<td class='first columns-cell'>
<div class='foot no-items section' id='footer-2-1'></div>
</td>
<td class='columns-cell'>
<div class='foot no-items section' id='footer-2-2'></div>
</td>
</tr>
</tbody>
</table>
<!-- outside of the include in order to lock Attribution widget -->
<div class='foot section' id='footer-3' name='Footer'><div class='widget Attribution' data-version='1' id='Attribution1'>
<div class='widget-content' style='text-align: center;'>
Powered by <a href='https://www.blogger.com' target='_blank'>Blogger</a>.
</div>
<div class='clear'></div>
</div></div>
</div>
</div>
<div class='footer-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class='content-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<script type='text/javascript'>
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/3704019819-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY6Z8FlFD705E8OiFteDXR3KlQHpmQ:1734394892443';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d4838136820032157985','//googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html','4838136820032157985');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '4838136820032157985', 'title': 'Project Zero', 'url': 'https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html', 'canonicalUrl': 'https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html', 'homepageUrl': 'https://googleprojectzero.blogspot.com/', 'searchUrl': 'https://googleprojectzero.blogspot.com/search', 'canonicalHomepageUrl': 'https://googleprojectzero.blogspot.com/', 'blogspotFaviconUrl': 'https://googleprojectzero.blogspot.com/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': 'UA-240546891-1', 'encoding': 'UTF-8', 'locale': 'en', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Project Zero - Atom\x22 href\x3d\x22https://googleprojectzero.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Project Zero - RSS\x22 href\x3d\x22https://googleprojectzero.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Project Zero - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/4838136820032157985/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Project Zero - Atom\x22 href\x3d\x22https://googleprojectzero.blogspot.com/feeds/7918586333811798677/comments/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'boqCommentIframeForm': true, 'loginRedirectParam': '', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/2dbf2ee4cef330c7', 'plusOneApiSrc': 'https://apis.google.com/js/platform.js', 'disableGComments': true, 'interstitialAccepted': false, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'X', 'key': 'twitter', 'shareMessage': 'Share to X', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'item', 'postId': '7918586333811798677', 'pageName': 'The Qualcomm DSP Driver - Unexpectedly Excavating an Exploit', 'pageTitle': 'Project Zero: The Qualcomm DSP Driver - Unexpectedly Excavating an Exploit'}}, {'name': 'features', 'data': {}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'name': 'custom', 'localizedName': 'Custom', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': true}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'The Qualcomm DSP Driver - Unexpectedly Excavating an Exploit', 'description': 'Posted by Seth Jenkins, Google Project Zero This blog post provides a technical analysis of exploit artifacts provided to us by Google\x27s Thr...', 'url': 'https://googleprojectzero.blogspot.com/2024/12/qualcomm-dsp-driver-unexpectedly-excavating-exploit.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 7918586333811798677}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/2019811046-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/1964470060-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogSearchView', new _WidgetInfo('BlogSearch1', 'sidebar-right-1', document.getElementById('BlogSearch1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PageListView', new _WidgetInfo('PageList1', 'sidebar-right-1', document.getElementById('PageList1'), {'title': 'Pages', 'links': [{'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/about-project-zero.html', 'id': '4384467920505278144', 'title': 'About Project Zero'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/working-at-project-zero.html', 'id': '2459334498880008057', 'title': 'Working at Project Zero'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/0day.html', 'id': '3414239791814532209', 'title': '0day \x22In the Wild\x22'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.github.io/0days-in-the-wild/rca.html', 'title': '0day Exploit Root Cause Analyses'}, {'isCurrentPage': false, 'href': 'https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html', 'id': '2935252455704572784', 'title': 'Vulnerability Disclosure FAQ'}], 'mobile': false, 'showPlaceholder': true, 'hasCurrentPage': false}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>
</body>
</html>