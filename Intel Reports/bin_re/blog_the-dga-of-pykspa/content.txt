<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>The DGA of Pykspa - "you skype version is old"</title><meta content="Pykspa (also known as Pykse, Skyper or SkypeBot) is a worm that spreads via Skype, see &amp;ldquo;Take a Deep Breath: a Stealthy, Resilient and Cost-Effective Botnet Using Skype&amp;rdquo; by Antonio Nappa et al." name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/pykspa-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="The DGA of Pykspa - &quot;you skype version is old&quot;" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="The DGA of Pykspa - &quot;you skype version is old&quot;" name="twitter:title"><meta content="Pykspa (also known as Pykse, Skyper or SkypeBot) is a worm that spreads via Skype, see &amp;ldquo;Take a Deep Breath: a Stealthy, Resilient and Cost-Effective Botnet Using Skype&amp;rdquo; by Antonio Nappa et al." name="twitter:description"><meta content="https://bin.re/assets/img/front/pykspa-800.jpeg" name="twitter:image"><link href="/assets/css/common-ef2fe0.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script defer src="/assets/js/all.min-a1c570.js"></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/pykspa-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'The DGA of Pykspa'" class="lazyload b9" data-src="/assets/img/header/pykspa-640.jpeg" data-srcset="/assets/img/header/pykspa-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjMzQ0MzRhIiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGNpcmNsZSBjeD0iNjQiIGN5PSIxNTUiIHI9IjI1NCIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzJlOTQ0ZCIgdHJhbnNmb3JtPSJtYXRyaXgoLS4xMjcyMiAtMTcuODU2NzMgMTMxLjgxMjM0IC0uOTM5MTMgMTU5LjcgMTAwLjcpIi8+PGVsbGlwc2UgY3g9IjkwIiBjeT0iMzMiIGZpbGw9IiMwMDAyMDAiIHJ4PSIyNTUiIHJ5PSI1MiIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzAwMDMwMCIgdHJhbnNmb3JtPSJyb3RhdGUoLTE2Ny45IDgwIDg1Ljkpc2NhbGUoMjIxLjU2NzIgNjYuODYwNjkpIi8+PHBhdGggZmlsbD0iIzc4ZmY5ZiIgZD0iTTE0MiA4NWg2NHY2aC02NHoiLz48cGF0aCBmaWxsPSIjNzVmZjk4IiBkPSJNOTQgODBoNnY0M2gtNnoiLz48cGF0aCBmaWxsPSIjNmRmZjhiIiBkPSJtMTg4LjQgMTA1LjEgNC44LjMtMTQuNS0yMS43LS40IDM2LjZ6Ii8+PHBhdGggZmlsbD0iIzAwMGYwOSIgZD0iTTE4NCAxMDVoNjZ2OTRoLTY2eiIvPjxwYXRoIGZpbGw9IiM1NWQ1ODUiIGQ9Im0xNDAuMiAxMDIuNCAyNC43IDE0LjNMMTM5IDEyMWwzMC41LTMwLjl6Ii8+PHBhdGggZD0iTTE3MSA4NGg3djY3aC03eiIvPjxwYXRoIGZpbGw9IiM0ZmJhNmEiIGQ9Ik02OC4xIDEwNS43IDQ1LjQgNzUuMWwyMy44IDQ2LjUgMTkuOS0zOS4xeiIvPjxwYXRoIGZpbGw9IiM2MWVjN2UiIGQ9Ik0yMjAgOTNoN3YyNmgtN3oiLz48cGF0aCBmaWxsPSIjN2ZmZmEzIiBkPSJNOTkgOTloMjF2Nkg5OXoiLz48cGF0aCBkPSJtNzcuMiAxMDUuOCAxMy43LTEzLjYgNi43IDUwLjItMzQtNDQuOHoiLz48cGF0aCBmaWxsPSIjMmE5MTM5IiBkPSJNMzYgODUgOSAxMTZsMy0zM3oiLz48cGF0aCBkPSJNMTA1IDk4IDg1IDUybDM2IDM3em0yNCA3aDMzdjhoLTMzeiIvPjxwYXRoIGZpbGw9IiM1YWQzNzciIGQ9Im0xMjcuNiAxMjMuNS41LTM2LjctNi41LTIuNS40IDM0LjJ6Ii8+PHBhdGggZmlsbD0iIzcwZmY5MCIgZD0iTTE4MSA5OWgyNHY3aC0yNHoiLz48cGF0aCBmaWxsPSIjNzhmZjljIiBkPSJtMTM2IDExMCAyMyA3LTI0IDF6Ii8+PHBhdGggZD0ibTEwNy42IDEwNS42IDQ2IDItMzIuMy0xMC4zLjkgNDd6Ii8+PHBhdGggZmlsbD0iIzZmZmY5NyIgZD0iTTE0NSA5OGgxOXY3aC0xOXoiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiMwMDBiMDAiIHRyYW5zZm9ybT0ibWF0cml4KC43MzI1MiAyNy45NzM5OCAtMjA4LjczNTkgNS40NjU5NCAxMzQuOCA5LjgpIi8+PHBhdGggZmlsbD0iIzAwMDcwNiIgZD0iTS0xNiAyMDQuOSA5MC42IDU0LjggNzMuOSA5OC43bC0zMy44LTEuMXoiLz48ZWxsaXBzZSBjeD0iNjkiIGN5PSIxOTgiIGZpbGw9IiMwMDA4MDAiIHJ4PSIyNDEiIHJ5PSIyNCIvPjxwYXRoIGZpbGw9IiMwYTI1MjciIGQ9Ik0xNTMuNiA1MC44IDU2LjUgMTcuOWw3MS43IDY1LjkgMi42IDQ4LjN6Ii8+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgeD0iLS41IiB5PSItLjUiIGZpbGw9IiM2NmZkOGQiIHRyYW5zZm9ybT0icm90YXRlKC0xNjYgNDcgMzkuNClzY2FsZSg5IDEyKSIvPjxwYXRoIGZpbGw9IiMwMDEwMGIiIGQ9Im0xNjkuMSAxNzEuMSA2NC4xLTkxLjkgMzcuOCAyMi4zLTI2LjQtNjQuNHoiLz48cGF0aCBmaWxsPSIjMzE3YThlIiBkPSJtMTk2LjEgNjUuOS05LjktNC01IDcuOUgxOTV6Ii8+PGVsbGlwc2UgY3g9IjkwIiBjeT0iMTQ2IiBmaWxsPSIjMDMxNDExIiByeD0iMjIyIiByeT0iMjgiLz48L2c+PC9zdmc+"></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">The DGA of Pykspa</h1><span class="bo">"you skype version is old"</span></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2015/03">March 10, 2015</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/dga" class="bg">dga</a> <a href="/tag/malware-analysis" class="bg">malware analysis</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> no comments</li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#some-of-the-preliminary-steps">Some of the Preliminary Steps</a></li><li><a href="#anti-vm">Anti-VM</a></li><li><a href="#host-ip">Host-IP</a></li><li><a href="#current-time">Current Time</a></li><li><a href="#callback-loop">Callback Loop</a></li><li><a href="#when-are-dga-calls-made">When are DGA Calls Made</a></li><li><a href="#seed">Seed</a></li><li><a href="#the-dga">The DGA</a></li><li><a href="#python-code-and-summary">Python Code and Summary</a></li><li><a href="#samples-on-malwrcom">Samples on Malwr.com</a></li></ul><span class="bj">Changes</span><ul class="i"><li>2020-01-06 21:11:03: Added more Pyskpa Seeds</li></ul><div><span class="bj">DGArchive</span><p>The DGA in this blog post has been implemented by the <a href="https://dgarchive.caad.fkie.fraunhofer.de/" class="bm">DGArchive</a> project.</p></div><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.pykspa" class="bm">Malpedia entry on Pykspa</a>.</p></div></div></div><div class="b6 bi"><p>Pykspa (also known as <em>Pykse</em>, <em>Skyper</em> or <em>SkypeBot</em>) is a worm that spreads via Skype, see <a href="http://www.eurecom.fr/en/publication/3093/download/rs-publi-3093.pdf"><em>“Take a Deep Breath: a Stealthy, Resilient and Cost-Effective Botnet Using Skype” by Antonio Nappa et al.</em></a> and <a href="http://www.ru.nl/publish/pages/578936/thesis_final_censored-bweymes.pdf"><em>“Recognising Botnets in Organisations” by Barry Weymes</em></a>. The malware has a hardcoded list of chat messages which it sends to contacts of the infected Skype user, trying to lure them into clicking on links that install Pykspa on their computer. Examples of the chat messages from my sample are:</p><blockquote><p>you skype version is old <cite>Pykspa</cite></p></blockquote><blockquote><p>I saw you last week. I would like to speak with you <cite>Pykspa</cite></p></blockquote><blockquote><p>i lost my job..<br>i am idiot..<br>i want to die.. <cite>Pykspa</cite></p></blockquote><p><a href="assets/chat_messages.txt">This file</a> lists all chat messages in English. All messages are translated, albeit poorly, to the following languages: <em>German</em>, <em>Russian</em>, <em>Ukranian</em>, <em>Romanian</em>, <em>Danish</em>, <em>Polish</em>, <em>Italian</em>, <em>Latvian</em>, <em>French</em>, <em>Slovak</em>, <em>Lithuanian</em>, <em>Spanish</em>, <em>Norwegian</em>, <em>Estonian</em>, <em>Swedish</em>, <em>Czech</em>.</p><p>Since at least October 2013, Pykspa comes with a Domain Generation Algorithm (DGA) to contact its Command and Control (C&amp;C) servers. Here is an example of the traffic generated on February 16th, 2015:</p><pre><code>    +--- whatismyip.everdot.org	
    |    www.whatismyip.ca	
(1)-+    whatismyipaddress.com	
    |    www.showmyipaddress.com	
    +--- www.whatismyip.com	
(2)----&gt; www.google.com	
    +--&gt; ejtuxsflbknn.net	
    |    haqwrnonlaj.info &lt;--+	
    |    jlbdgfhi.net &lt;------+	
    |    hiyumk.net &lt;--------+
    |    ezrmsrnmzddx.net &lt;--+	
(3)-+    okqwmayiseaq.com &lt;--+	
    |    lchsxgzmwg.info &lt;---+--- (4)
    +--&gt; wrthooba.info       |	
    |    wbtkdnfr.info &lt;-----+	
    |    bodlmkjkckx.net &lt;---+
    +--&gt; asgwkyaioy.com      |	
    |    xcixrwcyesou.net &lt;--+	
    |    ofebrbnbmvfa.info &lt;-+	
    +--&gt; nazihzsljevt.net    |	
         bkmothb.net &lt;-------+
</code></pre><p>The IP lookup domains <strong>(1)</strong> are used to determine the IP and location of the host, probably to select the right language for the chat messages. The single call to Google <strong>(2)</strong> is used to determine the current date and time. After that follow two sets of interleaved DGA domains. The set <strong>(3)</strong> likely contains the C&amp;C target, while <strong>(4)</strong> is probably just added as noise.</p><p>Both <strong>(3)</strong> and <strong>(4)</strong> use the same DGA, but with different seeds. This blog post shows the DGA of Pykspa, lists the time dependent seeds, and links to some samples on malwr.com that match the DGA and seeds. I analysed <a href="https://malwr.com/analysis/ZDhjNDE0MDZmNjdmNGNkM2JiZmJlN2UyYTE4YTI5ZDM/">this sample from malwr.com</a>, more samples that use Pykspa’s DGA are listed in Section <a href="#samples-on-malwrcom"><em>Samples on Malwr.com</em></a>:</p><dl><dt>MD5</dt><dd>6da71b4317dd664544903cbc872308d7</dd><dt>SHA1</dt><dd>e373766587b78c4ee7cef9d7a7735b3a52cf41bb</dd><dt>SHA256</dt><dd>16cf97e7237828c37c796a8f9e81451f7fc301da7fe2ff66d97ce5b44c7dfb42</dd><dt>Size</dt><dd>1284KB, 1314816 Bytes</dd><dt>Compile Timestamp</dt><dd>2006-12-09 09:18:24 UTC</dd></dl><p>(<em>Changes 2015-03-11: Also included discussion of the second set of domains.</em>)</p><h2 id="some-of-the-preliminary-steps">Some of the Preliminary Steps</h2><h3 id="anti-vm">Anti-VM</h3><p>Most of the recent Pykspa samples use VM detection. If the sample feels like it is running inside a VM, it immediately shuts down the machine:</p><pre><code>0040DAE6 shutdown:                               
0040DAE6                 call    shutdown1
0040DAEB                 call    shutdown2
0040DAF0
0040DAF0 loc_40DAF0:                            
0040DAF0                 call    detect_vm
0040DAF5                 test    al, al
0040DAF7                 jnz     short shutdown
</code></pre><p>The VM detection is based on the exotic “Visual Property Container Extender” assembly call:</p><pre><code>0040D408 vpcext  7, 0Bh
</code></pre><p>My VM was unmasked by this call; I therefore patched the call to the VM detection routine with <code>xor eax, eax</code>:</p><pre><code>0040DAF0 loc_40DAF0:                             
0040DAF0                 xor     eax, eax
0040DAF2                 nop
0040DAF3                 nop
0040DAF4                 nop
0040DAF5                 test    al, al
0040DAF7                 jnz     short shutdown
</code></pre><h3 id="host-ip">Host-IP</h3><p>The first network traffic that the sample generates are calls to various IP lookup sites. Pykspa probably uses the information from these sites to geolocate the infected client and choose the appropriate language in Skype chats.</p><h3 id="current-time">Current Time</h3><p>Next, Pykspa enters this code snippet:</p><p><noscript>&lt;img src="assets/connectivity_and_time.png" class=""/&gt;</noscript><img alt="Connectivity Check" class="lazyload" data-src="assets/connectivity_and_time.png" data-srcset="assets/connectivity_and_time-1x.webp 775w,
assets/connectivity_and_time-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NzUiIGhlaWdodD0iOTEwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 775px) 100vw, 775px"></p><p>These lines first randomly choose one of the following 13 common website (stored at <code>test_domains</code>, see offset 40C214):</p><pre><code>- www.google.com
- www.facebook.com
- www.myspace.com
- www.youtube.com
- www.yahoo.com
- www.youtube.com
- www.wikipedia.org
- www.blogger.com
- www.adobe.com
- www.bbc.co.uk
- www.imdb.com
- www.baidu.com
- www.ebay.com
</code></pre><p>The malware then calls the subroutine <code>connectivity_check</code> which makes a HTTP GET request for the selected domain , e.g.,</p><pre><code>GET / HTTP/1.1
Host: www.blogger.com
Accept: */*
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; -&gt; 
 -&gt; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3
Connection: close
</code></pre><p>Pykspa extracts the <code>Date</code> field of the HTTP reponse’s header:</p><p><noscript>&lt;img src="assets/get_date_http_header_field.png" class=""/&gt;</noscript><img alt="image" class="lazyload" data-src="assets/get_date_http_header_field.png" data-srcset="assets/get_date_http_header_field-1x.webp 351w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTEiIGhlaWdodD0iMjE4IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 351px) 100vw, 351px"></p><p>The string is then parsed to get the current date and time. For example, these lines convert “Feb” to the month number 2:</p><pre><code>0040FC6F loc_40FC6F:                             
0040FC6F                 push    offset aFeb     
0040FC74                 push    edi             
0040FC75                 call    esi ; lstrcmpiA
0040FC77                 test    eax, eax
0040FC79                 jnz     short loc_40FC84
0040FC7B                 mov     [ebp+74h+month], 2
0040FC7F                 jmp     loc_40FD3C
</code></pre><p>For instance, if the response from <code>www.blogger.com</code> is:</p><pre><code>HTTP/1.1 302 Moved Temporarily
P3P: CP="This is not a P3P policy! See http://www.google.com/support/accounts/ -&gt;
    -&gt; bin/answer.py?hl=en&amp;answer=151657 for more info."
Content-Type: text/html; charset=UTF-8
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: Fri, 01 Jan 1990 00:00:00 GMT
Date: Mon, 09 Mar 2015 11:03:14 GMT
...
</code></pre><p>Then the date is <code>2015-03-09 11:03:14</code>. The routine <code>connectivity_check</code> returns this date in unix timestamp format in <code>eax</code>, or NULL if the date extraction failed. If a date is returned, it is saved in variable <code>today</code> at offset 40C224. If the date extraction failed, for example because internet went down, the snippet sleep 3 seconds at 40C22B and retries with a different domain for at most 20 times.</p><p>After the current time is stored in <code>today</code>, the malware starts a stopwatch in line <code>40c247</code> which allows it to estimate the current time using only calls to <code>GetTickCount</code> (see Section <a href="#seed"><em>Seed</em></a>).</p><h2 id="callback-loop">Callback Loop</h2><p>As shown in the beginning of the post, Pykspa generates two sets of interleaved DGA domains. These domains are indistinguishable due to using the same algorithm. However, the two sets use a different seed and are generated under different circumstances.</p><p>In the following I first show which seed is used when and how the seeds are changed. Next, I show how the initial seed is determined based on the current time. I conclude the section by showing how the DGA actually generates domains based on the current seed.</p><h3 id="when-are-dga-calls-made">When are DGA Calls Made</h3><p>The callback loop iterates from 0 to 15999:</p><pre><code>00406B7A xor     dga1_nr, dga1_nr
(...)
00406B82 mov     [ebp+index], dga1_nr
00406B85 next_index:
(...)

00406C64                 mov     eax, 16000
(...)
00406C7A                 inc     [ebp+index]
00406C7D                 cmp     [ebp+index], eax
00406C80                 jl      next_index
</code></pre><p>The above loop is wrapped in an infinite loop, which sleeps 1 second before starting the callback loop over:</p><pre><code>.text:00406C86 push    one_second      ; dwMilliseconds
.text:00406C8C call    ds:Sleep
.text:00406C92 jmp     restart_all
</code></pre><p>To summarize, these are the two loops in pseudo code:</p><pre><code>WHILE True DO
    // Initialize seeds
    FOR index = 0 TO 15999 DO
        // DGA calls
    END FOR
    sleep 1 second
END WHILE
</code></pre><p><strong>First Seed - The Useful DGA calls:</strong> Whenever the <code>index</code> is divisible by 80, the DGA is called based on the first seed:</p><pre><code>00406B85                 mov     eax, [ebp+index]
00406B88                 push    80
00406B8A                 cdq
00406B8B                 pop     ecx
00406B8C                 idiv    ecx
00406B8E                 test    edx, edx
00406B90                 jnz     short loc_406BF9
00406B92                 mov     ecx, [ebp+seed1]
00406B95                 mov     eax, ecx
00406B97                 lea     ebx, [dga1_nr+1]
00406B9A                 div     ebx
00406B9C                 lea     eax, [ecx+edx+1]
00406BA0                 push    eax             ; seed
00406BA1                 mov     [ebp+seed1], eax
(DGA related lines)
00406BE6                 mov     dga1_nr, ebx
</code></pre><p>These lines decompile to:</p><pre><code>IF index % 80 == 0 THEN
    s = seed1 % (dga1_nr + 1) 
    seed1 = seed1 + s + 1
    // DGA call
    dga1_nr = dga1_nr + 1
END IF
</code></pre><p>The <code>dga1_nr</code> starts at 0 (see offset <code>00406B7A</code>). The initial value of the seed will be discussed later on. Because the index runs from 0 to 15999, there are 200 different domains generated by <code>seed1</code>.</p><p><strong>Second Seed - The Noisy DGA calls:</strong> The callback loop can make second DGA calls independent of the above DGA calls. These second DGA calls are based on an independent second seed. This seed is changed every iteration, but DGA calls are only made in about 5% of all iterations:</p><pre><code>.text:00406BF9 loc_406BF9:
.text:00406BF9 mov     ecx, [ebp+seed2]
.text:00406BFC mov     ebx, [ebp+dga2_nr]
.text:00406BFF mov     eax, ecx
.text:00406C01 xor     edx, edx
.text:00406C03 inc     ebx
.text:00406C04 div     ebx
.text:00406C06 lea     eax, [ecx+edx+1]
.text:00406C0A mov     [ebp+seed2], eax
.text:00406C0D call    _rand
.text:00406C12 push    20
.text:00406C14 cdq
.text:00406C15 pop     ecx
.text:00406C16 idiv    ecx
.text:00406C18 test    edx, edx
.text:00406C1A jnz     short loc_4
</code></pre><p>These line decompile to this pseudo code:</p><pre><code>s = seed2 % (dga2_nr + 1)
seed2 = seed2 + s + 1
IF rand() % 20 == 0 THEN
    // DGA call
END IF
dga2_nr = dga2_nr + 1
</code></pre><p>Notice that the seed2 is changed regardless of whether the seed2 is actually used to generate a new domain. Therefore, there exist 16000 different domains from seed2, of which only about 5% or 800 domains are actually generated and used.</p><p>The <code>rand()</code> call used to determine if a domain is generated or not is based on the current tick count:</p><pre><code>.text:00406ABE call    ds:GetTickCount
.text:00406AC4 push    eax
.text:00406AC5 call    set_seed
</code></pre><p>This makes the <code>rand()</code> function unpredictable. Because each of the domains from the second seed only has a 5% chance of being used, I assume these domains are meant merely to produce noise and not be registered as actual C&amp;C servers.</p><h3 id="seed">Seed</h3><p>The intial seeds for both DGA sets are generated almost the same way. First, the current time is determined:</p><pre><code>00406ACA call    get_timestamp
</code></pre><p>This routine uses the unix timestamp in <code>today</code>, which was determined during the <a href="#current-time">connectivity check</a>, and adds the number of seconds that passed since then:</p><pre><code>.text:00413F2B get_timestamp proc near
.text:00413F2B call    ds:GetTickCount
.text:00413F31 sub     eax, tick_count_after_connectivity_check
.text:00413F37 xor     edx, edx
.text:00413F39 mov     ecx, 1000
.text:00413F3E div     ecx
.text:00413F40 add     eax, today
.text:00413F46 retn
.text:00413F46 get_timestamp 
</code></pre><p>This gives an estimate of the current time as unix timestamp. This value — in <code>eax</code> — is then divided:</p><pre><code>.text:00406ACF xor     edx, edx
.text:00406AD1 mov     ecx, 1728000    ; 20 days ...
.text:00406AD6 div     ecx
.text:00406AD8 mov     [ebp+time_divided_by_20days], eax
</code></pre><p>The divisor is the only difference in creating the first and second seed:</p><ul><li>For the first set of domains the divisor is 1728000. This is the number of seconds in <strong>20 days</strong>.</li><li>For the second set of domains the divisor is 86400. This is the number of seconds in <strong>1 day</strong>.</li></ul><p>The seed is based on the resulting quotient, and will therefore change once every 20 days for the useful first set of domains, and daily for the noisy second set of domains. The seed initialization continues by creating a 64 bytes long ASCII hex string:</p><pre><code>.text:00406ADB lea     eax, [ebp+hash_string]
.text:00406AE1 push    eax             ; void *
.text:00406AE2 push    4
.text:00406AE4 pop     edi
.text:00406AE5 lea     eax, [ebp+time_divided_by_20days]
.text:00406AE8 push    edi             ; int
.text:00406AE9 push    eax             ; int
.text:00406AEA call    create_hash_string
</code></pre><p>The routine <code>create_hash_string</code> is complicated and I didn’t reverse engineer the code. It probably is a hash function that returns 256 bytes encoded as a hex string. Pykspa then takes a 4 character substring of this hex string. The start of the substring is determined by taking the time quotient modulo 50:</p><pre><code>.text:00406AEF mov     eax, [ebp+time_divided_by_20days]
.text:00406AF2 push    edi             ; size_t
.text:00406AF3 push    50
.text:00406AF5 pop     ecx
.text:00406AF6 xor     edx, edx
.text:00406AF8 div     ecx             ; offset at most 49
.text:00406AFA lea     eax, [ebp+edx+hash_string]
.text:00406B01 push    eax             ; substring 
</code></pre><p>For instance, on March 10th, 2015 at 8 pm the <code>hash_string</code> for the first set of domains is:</p><pre><code>b8b8ae799a67ccc2046e97b6935341680e0e830a8920ec393aa8fe12860b9b09
</code></pre><p>The unix timestamp is 1426017600. Divided by twenty days, this becomes 825, which is 25 modulo 50. The malware will therefore use the 4 characters starting at offset 25, i.e., “3534”.</p><p>These four hex characters and the entire 64 character hash are then passed to routine <code>calc_seed</code> that will determine the seed:</p><pre><code>.text:00406B0B lea     eax, [ebp+hash_string]
.text:00406B11 push    eax             ; hash
.text:00406B12 lea     eax, [ebp+seed]
.text:00406B15 push    edi             ; 4 
.text:00406B16 push    eax             ; target
.text:00406B17 call    calc_seed
.text:00406B1C mov     eax, [ebp+seed]
.text:00406B1F mov     [ebp+original_seed], eax
</code></pre><p>Again, this routine is quite complicated. It probably does some sort of decryption of the substring based on the hash. I couldn’t identify the algorithm, and didn’t have the time to reverse the code from scratch. I opted instead to let the code calculate the seeds for me using a small debugger script. The procedure was as follows:</p><ol><li>Attach a debugger to the malware while inside the callback loop.</li><li>Set a first breakpoint at offset <code>0x00406ACF</code>, this is where the current time has just been stored in <code>eax</code>.</li><li>Set a second breakpoint at offset <code>0x00406B1F</code>, this is after the first seed has been stored in <code>eax</code>.</li><li>Iterate over all desired timestamps. For each timestamp do the following: (a) Jump to the beginning of the callback routine; (b) Run to the first breakpoint and change <code>eax</code> to the desired timestamp; (c) Run to the second breakpoint, get the seed from <code>eax</code> and log the result.</li></ol><p>I implemented these steps in the following Immunity Debugger script:</p><pre><code>import immlib
import time
from datetime import datetime

def main(args):
    imm = immlib.Debugger()
    filename = "seeds.txt"

    with open(filename, "w") as w:
        w.write("first time;last time;seed\n")

    # addresses
    start_of_callback = 0x00406A7C
    after_get_timestamp = 0x00406ACF 
    result = 0x00406B1F 

    # time values
    twenty_days = 3600*24*20
    timestamp = time.mktime((2008,1,1,0,0,0,1,1,-1))
    timestamp = int(((timestamp//twenty_days)*twenty_days))
    end_timestamp = time.mktime((2016,1,1,0,0,0,4,1,-1))

    # setting breakpoints
    imm.log("setting breakpoints ...")
    imm.setBreakpoint(after_get_timestamp)
    imm.setBreakpoint(result)

    while timestamp &lt; end_timestamp:
        first_time = datetime.fromtimestamp(timestamp).strftime("%Y-%m-%d %H:%M:%S")
        last_time = datetime.fromtimestamp(timestamp + twenty_days - 1).\
                strftime("%Y-%m-%d %H:%M:%S")
        imm.log("getting seed for {}".format(first_time))
        imm.setReg('EIP', start_of_callback)
        imm.run()
        imm.setReg('EAX', timestamp)
        imm.run()
        seed = imm.getRegs()['EAX']
        with open(filename, "a") as a:
            a.write("{};{};{:x}\n".format(first_time, last_time, seed))
        timestamp += twenty_days
    return "done extracting seeds"
</code></pre><p>To generate the seeds of the second set of domains, simply change the breakpoints to 0x406B27 and 0x406B7C respectively.</p><p>The following table lists all seeds of the useful domains for the years 2014 and 2015, including the first five domains that the DGA — shown in the <a href="#the-dga">following Section</a> — produces: The time periods are in UTC.</p><table><thead><tr><th>period</th><th>seed</th><th>first domains</th></tr></thead><tbody><tr><td>2013-12-21 - 2014-01-10</td><td>4ae6a802</td><td>yabbpifwawe.info, eszgwhn.net, fgskxmbql.org, ycautv.net, dlhcdwfif.info</td></tr><tr><td>2014-01-10 - 2014-01-30</td><td>3896367b</td><td>jkdcmitej.com, ccnfrsfseht.net, wwlodun.info, ivdjhcvwvnla.info, clvcgwxp.net</td></tr><tr><td>2014-01-30 - 2014-02-19</td><td>6a2c8eb2</td><td>nbmcfivnj.info, wkjywepmjoqx.net, zkkerwhef.com, owvydqimfvl.net, gwiogocc.com</td></tr><tr><td>2014-02-19 - 2014-03-11</td><td>f96bf2a5</td><td>bvxbdfe.org, msmyftxyd.info, ncnalaomgmw.com, xvanur.net, yookeocesq.com</td></tr><tr><td>2014-03-11 - 2014-03-31</td><td>fcef457e</td><td>zfjobfqorjhm.info, fjzcpepv.net, msseaycyaeak.com, zstalto.net, xmfzbtyaewxb.net</td></tr><tr><td>2014-03-31 - 2014-04-20</td><td>dd370744</td><td>eugcldt.net, bplvoxgfxb.info, macccwskcmsq.com, zwfelqr.net, omizdirtly.info</td></tr><tr><td>2014-04-20 - 2014-05-10</td><td>a1c5400f</td><td>vcsvuay.com, emhebepmd.net, ufakhnixqiwr.info, lfsuyhcrlx.info, ymesmsyiymqo.com</td></tr><tr><td>2014-05-10 - 2014-05-30</td><td>9d0d436c</td><td>wcsjaj.net, hmdfbqzor.info, xigkzlxyfen.com, nfinek.net, yicuqmsi.org</td></tr><tr><td>2014-05-30 - 2014-06-19</td><td>7bb24638</td><td>wjfbhnjedf.net, tltcpr.info, sbfebsuys.net, zrqhcumanzne.info, jilmfepwgrc.com</td></tr><tr><td>2014-06-19 - 2014-07-09</td><td>a6b042c</td><td>lbjafzzofdx.net, ntilnij.info, vcjdxwbxx.com, cyfwjticnep.net, assoka.org</td></tr><tr><td>2014-07-09 - 2014-07-29</td><td>f34c4850</td><td>usyytuo.net, hnhdxtxbvd.info, wmsuiuckkagu.com, rosktbi.net, adgzqqstzn.info</td></tr><tr><td>2014-07-29 - 2014-08-18</td><td>f2509f0b</td><td>quyeek.com, rprumlqy.net, uuocymsegeog.com, rrrkxsp.net, vbkubbxralgs.net</td></tr><tr><td>2014-08-18 - 2014-09-07</td><td>f0978d0e</td><td>mgojzac.info, tkcapzfbrj.net, uscoccqakswe.org, jcrwiwvmq.net, kexlgqb.net</td></tr><tr><td>2014-09-07 - 2014-09-27</td><td>44dd4e5f</td><td>bewbwrj.com, amoudctuy.net, cciksy.com, masvzhrl.net, lkirpo.net</td></tr><tr><td>2014-09-27 - 2014-10-17</td><td>aac6d7f6</td><td>lrvhlp.info, ojxczyten.net, zlyqrojjqhiw.info, yjvmfyxydt.info, drdgnmro.info</td></tr><tr><td>2014-10-17 - 2014-11-06</td><td>f26296b1</td><td>nemnthdcpag.org, rdflml.info, oaiwwgaa.com, mjzknmuztv.net, wzhpoo.info</td></tr><tr><td>2014-11-06 - 2014-11-26</td><td>c950cbfe</td><td>vehbkr.info, zfvszoiql.net, lcqgvikjtgv.org, vbthttzj.net, kiusqwmsye.org</td></tr><tr><td>2014-11-26 - 2014-12-16</td><td>41de3ee2</td><td>eiiuvwczrb.info, uhorab.net, uqocygsskk.com, ltzzjconbftl.net, fsoelqbsd.com</td></tr><tr><td>2014-12-16 - 2015-01-05</td><td>f085a446</td><td>bmnudlx.info, dsyxxfvtyy.net, bshtdy.info, toefqwaaeim.info, rkskpjb.net</td></tr><tr><td>2015-01-05 - 2015-01-25</td><td>ffc222d4</td><td>xwwglbhkjsl.net, tscdrkt.info, pvdldmlteif.org, hldvfrca.net, bsvurea.org</td></tr><tr><td>2015-01-25 - 2015-02-14</td><td>f3fc72bb</td><td>titjxqdwcmd.com, yglkyz.net, qoumyuce.org, rwhnxqtqftkb.net, lhheddtsy.com</td></tr><tr><td>2015-02-14 - 2015-03-06</td><td>2ff654d0</td><td>ejtuxsflbknn.net, wrthooba.info, asgwkyaioy.com, nazihzsljevt.net, tdxbpku.org</td></tr><tr><td>2015-03-06 - 2015-03-26</td><td>54d64257</td><td>nlpfgnhcb.com, horfdqdqtia.net, oayeww.org, jmydflbsel.net, dkvyhta.com</td></tr><tr><td>2015-03-26 - 2015-04-15</td><td>ec343337</td><td>rwtyvfrddfk.com, imwgaj.net, mkyaeeye.org, xkvjbgdknfbt.net, teejnil.org</td></tr><tr><td>2015-04-15 - 2015-05-05</td><td>ccd10407</td><td>aaqeemgo.com, gilzxjidxj.net, ywumyoiuuigi.org, uvfpbbsyv.net, tbvtngvxocp.org</td></tr><tr><td>2015-05-05 - 2015-05-25</td><td>91f7e71c</td><td>ytaxprtas.net, hstrdnpcoznh.info, nqpmsct.com, xulciqvvd.net, ggwjhuxqtklf.info</td></tr><tr><td>2015-05-25 - 2015-06-14</td><td>5cea1d7a</td><td>veliren.info, xqzupldhuo.net, ooiomymggqom.org, ucovoaxwi.net, ywmuyucg.org</td></tr><tr><td>2015-06-14 - 2015-07-04</td><td>b6fcd7ef</td><td>hwumvsr.com, gipqptued.net, gickck.com, lobmdjpw.net, nedqtxt.org</td></tr><tr><td>2015-07-04 - 2015-07-24</td><td>7c562f77</td><td>uoakekgy.com, ysbcaebxnt.net, oucmkcyaskua.org, agvsjmdoz.net, omgsgs.com</td></tr><tr><td>2015-07-24 - 2015-08-13</td><td>4936d2db</td><td>wgascuec.com, goxolemcot.net, gyykawsgmeki.org, uiffdqxsf.net, gauaam.com</td></tr><tr><td>2015-08-13 - 2015-09-02</td><td>b8b2c9e1</td><td>uammskmq.org, jqplflktas.info, rybwtr.net, uyznvxlof.info, gakcmqiw.com</td></tr><tr><td>2015-09-02 - 2015-09-22</td><td>31b275c5</td><td>mcuomg.org, qdzzziyj.info, cyykckimuy.com, tufbdpbtbxyr.net, hofzvmd.org</td></tr><tr><td>2015-09-22 - 2015-10-12</td><td>a13852</td><td>hrlefwvvqqpp.info, dthawyxm.net, aucoakiaicoe.com, voqzaaq.net, ehibnxwshs.info</td></tr><tr><td>2015-10-12 - 2015-11-01</td><td>6f4f5a0</td><td>uauyxamffw.net, mhfira.info, ugfuystwx.net, ffxxnbesitxz.info, hvhkadugb.org</td></tr><tr><td>2015-11-01 - 2015-11-21</td><td>90864d97</td><td>egmsooqueq.com, ckcdayqewadl.net, bwrdwuhv.info, xkywrr.info, oyiaaweoymgu.com</td></tr><tr><td>2015-11-21 - 2015-12-11</td><td>225a3e31</td><td>rgdyrur.org, yfthagxeb.info, rwccjihweor.com, xdhgnb.net, egymosgwqiue.org</td></tr><tr><td>2015-12-11 - 2015-12-31</td><td>f400ac9c</td><td>kzdwohdroo.net, joemwm.info, mkuqmkccgo.org, lqyxezj.net, mydsxhtrli.info</td></tr><tr><td>2015-12-31 - 2016-01-20</td><td>1f5c0eed</td><td>lkwokkrehon.org, cwcrlh.info, hcgktapuh.net, dgarcqijrdjc.info, zufrrmm.com</td></tr></tbody></table><p>You can find more seeds for the useful domains, as well as the seeds for the noisy domains, in the download in the <a href="assets/dga.zip">DGA download</a>.</p><h3 id="the-dga">The DGA</h3><p>Finally, this section shows how the domains are generated based on the current seed. First, the length of the domains is determined and passed to the dga subroutine <code>get_sld</code> (= get second level domain):</p><pre><code>.text:00406BA4 push    7
.text:00406BA6 pop     ecx
.text:00406BA7 add     eax, dga1_nr
.text:00406BA9 xor     edx, edx
.text:00406BAB div     ecx
.text:00406BAD lea     eax, [ebp+domain]
.text:00406BB0 add     edx, 6
.text:00406BB3 push    edx             ; length
.text:00406BB4 push    eax             ; domain 
.text:00406BB5 call    get_sld 
</code></pre><p>This snippet boils down to:</p><pre><code>length = (seed1 + dga1_nr) % 7 + 6  
domain = get_sld(length, seed)
</code></pre><p>The DGA routine to generate the second level domain is quite long, you can <a href="assets/the_dga.asm">see the full disassembly here</a>. The code boils down to this Python snippet:</p><pre><code>def get_sld(length, seed):
    domain = ""
    modulo = 541 * length + 4
    a = length * length
    for i in range(length):
        index = (a + (seed*((seed % 5) + (seed % 123456) +
            i*((seed &amp; 1) + (seed % 4567))) &amp; 0xFFFFFFFF))  % 26
        a += length;
        a &amp;= 0xFFFFFFFFF
        domain += chr(ord('a') + index)
        seed += (((7837632 * seed * length) &amp; 0xFFFFFFFF) + 82344) % modulo;
    return domain 
</code></pre><p>Because the seed is passed <em>by value</em>, the assignment in the second to last line won’t change <code>seed1</code> or <code>seed2</code>.</p><p>Next, the top level domain is chosen randomly from an array of top level domains:</p><pre><code>.text:00406BBA                 add     esp, 0Ch
.text:00406BBD                 push    offset a_       ; "."
.text:00406BC2                 lea     eax, [ebp+hostname]
.text:00406BC5                 push    eax             ; lpString1
.text:00406BC6                 call    esi ; lstrcatA
.text:00406BC8                 mov     eax, [ebp+asdf]
.text:00406BCB                 and     eax, 3
.text:00406BCE                 imul    eax, 7
.text:00406BD1                 add     eax, offset tld ; "com"
.text:00406BD6                 push    eax             ; lpString2
.text:00406BD7                 lea     eax, [ebp+hostname]
.text:00406BDA                 push    eax             ; lpString1
.text:00406BDB                 call    esi ; lstrcatA
</code></pre><p>With the <code>tld</code> array:</p><pre><code>.data:0042E048 tld             db 'com',0              ; DATA XREF: sub_406A7C+155o
.data:0042E048                                         ; sub_406A7C+1D2o
.data:0042E04C                 db    0
.data:0042E04D                 db    0
.data:0042E04E                 db    0
.data:0042E04F                 db 'net',0
.data:0042E053                 db    0
.data:0042E054                 db    0
.data:0042E055                 db    0
.data:0042E056                 db 'org',0
.data:0042E05A                 db    0
.data:0042E05B                 db    0
.data:0042E05C                 db    0
.data:0042E05D                 db 'info',0
.data:0042E062                 db    0
.data:0042E063                 db    0
.data:0042E064                 db 'cc',0
.data:0042E067                 db    0
.data:0042E068                 db    0
</code></pre><p>So the top level domain is picked according to:</p><pre><code>tlds = ['com', 'net', 'org', 'info', 'cc']
top_level_domain = tlds[(seed1 &amp; 3)]
</code></pre><p>Note that only the first four top level domains are reachable, “<em>cc</em>” can’t be picked.</p><h3 id="python-code-and-summary">Python Code and Summary</h3><p>The Python code <a href="assets/dga.zip">in this ZIP download</a> generates the useful domain for any date between 2008 and 2020. It can also generate the noisy domains for the period March 2013 to March 2020. The script uses the list of seeds stored in <code>dga1_seeds.json</code> and <code>dga2_seeds.json</code>. For instance, to get the four DGA domains from set (3) shown in the introduction:</p><pre><code>$ python dga.py -d 2015-02-16 -n 4
ejtuxsflbknn.net
wrthooba.info
asgwkyaioy.com
nazihzsljevt.net
</code></pre><p>To confirm that the first noisy domain from (4), i.e., <em>haqwrnonlaj.info</em> is covered by the second seed (the date is offset by two days, maybe because of timezone differences?):</p><pre><code>$ python dga.py -d 2015-02-18 -n 1000 -s 2 | grep -n haqwrnonlaj.info
8:haqwrnonlaj.info
</code></pre><p>The following table summarizes the properties of the DGA:</p><table><thead><tr><th>property</th><th>useful domains (first seed)</th><th>noisy domains (second seed)</th></tr></thead><tbody><tr><td>seed</td><td>changes every 20 days</td><td>changes daily</td></tr><tr><td>domains per seed</td><td>200</td><td>800</td></tr><tr><td>tested domains</td><td>all</td><td>5% per round</td></tr><tr><td>sequence</td><td>one after another</td><td>skipping over 95% of domains</td></tr><tr><td>wait time between domains</td><td>none</td><td>same</td></tr><tr><td>top level domain</td><td>.com, .net, .org and .info, picked uniformly at random</td><td>same</td></tr><tr><td>second level characters</td><td>lower case letters, picked uniformly at random</td><td>same</td></tr><tr><td>second level domain length</td><td>6 to 12 characters</td><td>same</td></tr></tbody></table><h2 id="samples-on-malwrcom">Samples on Malwr.com</h2><p>The DGA was probably first used in <strong>October 2013</strong>. The first reference to a DGA domain on Google are for the domain “mczvyzye.net”, which was active from October 3rd to 22nd, 2013, and is listed in <a href="http://software.sonicwall.com/applications/gav/index.asp?ev=v&amp;v_id=5390">in this analysis</a>. The following table lists samples on malwr.com that match the DGA and seeding procedure:</p><table><thead><tr><th>md5</th><th>analysis date</th><th>seed</th></tr></thead><tbody><tr><td><a href="https://malwr.com/analysis/MTBmNmJjYTU4YzBmNGY4YzhlNmMwN2IwM2M1YmQ3ZDY/">467a8f934ba9ea9b438a2c89c9f18c1b</a></td><td>21 Feb. 2014</td><td>0xf96bf2a5L</td></tr><tr><td><a href="https://malwr.com/analysis/NWMxYTA2YjE3OTQwNGJiZGEzMGMyZGQ3M2MyNjUxY2Y/">f081f266f1800f6192aa662c9cd15da1</a></td><td>21 Feb. 2014</td><td>0xf96bf2a5L</td></tr><tr><td><a href="https://malwr.com/analysis/Zjg3ODQ2Zjk5YzM4NDQ4YzhmMWU2NTc2N2RkOThiMDM/">45c750a60992e1f0c433713fbff50734</a></td><td>21 Feb. 2014</td><td>0xf96bf2a5L</td></tr><tr><td><a href="https://malwr.com/analysis/ZDFjMTQ4MDc5M2EzNGVmYmI3OTYyYmZlMzY3N2RkMTk/">04d5ee33b95c4ec35ee5295fedf155a9</a></td><td>21 Feb. 2014</td><td>0xf96bf2a5L</td></tr><tr><td><a href="https://malwr.com/analysis/MTQ4OTZjNjJhZmJlNDhjZWFiNGEwOTc3NzVmMjcwNWI/">02a4634b2ad3800f2a8a285933f03946</a></td><td>29 May. 2014</td><td>0x9d0d436cL</td></tr><tr><td><a href="https://malwr.com/analysis/OGFjMmU3Yzc2N2I4NDljNjk0ZWEyNTQzZmM3ZTUyMGY/">30ea7bfee0a9a5fa1a94265cba336116</a></td><td>04 Jun. 2014</td><td>0x7bb24638</td></tr><tr><td><a href="https://malwr.com/analysis/NzEzNzQ5ZWZhMmI5NGUzZmE3OWY4ZGU3NjRlMDk2NmE/">0f223c93889d60de3eeec997a17a5121</a></td><td>18 Jun. 2014</td><td>0x7bb24638</td></tr><tr><td><a href="https://malwr.com/analysis/NzIyYTMxMjdmMzQyNDVmNjllNmM5NWJhMjdlMzAxZjM/">1c04b0440ca8fbf2f9e4fdae6783e480</a></td><td>18 Jun. 2014</td><td>0x7bb24638</td></tr><tr><td><a href="https://malwr.com/analysis/YmQ2ODJmZWRlZTQ2NDVkMmJlMjZlNWViYjA1YmZlNzE/">01d57201b405cc2eec8688ceac6861f6</a></td><td>27 Jun. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/MzIyM2E0MTUzNTRmNDQ0NTgyYTZkZGQxMDQ0OTA0NDg/">21bbf78287b44331941e99f124326156</a></td><td>03 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/MjFhMDUxOTkxN2FkNGY0ODk2ZGQ2NzkwMTJiYTg5MmI/">02b9fba52d81bc77f92dd6cbdae2eae1</a></td><td>03 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/MWVhODMyZmRiZWE2NDgzMWIzZmRjNDk1NDg1ODhkZjE/">10aa6b8873010c2158342d2f96f11fc1</a></td><td>03 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/YzFkMjFjNmJkYTAxNDgzZjhiZTBkNjY2M2NkYWM5NGE/">16a39f6d50deef6614e2e8cabdc56671</a></td><td>03 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/NDA2NjMzYTg1ZWVlNDllMDg4ZjgzZDFmNzdlYjFiNmQ/">28cbcc88b68bba309fab8229fdfb3621</a></td><td>04 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/YjM1YTIxNjRiYTBiNGFmZThiZjQzMjM1YTlhZmJlMDg/">d4fdea06373888645c693ed2c91b9853</a></td><td>08 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/OTMwMDZhMmM1NmI0NGQ0YmFmMGMzZTk5OGJiNmI3OTQ/">f95f4809d1e239da71935728ae588c05</a></td><td>08 Jul. 2014</td><td>0xa6b042c</td></tr><tr><td><a href="https://malwr.com/analysis/NTA5OWMzZDU2NjljNDc0MmI0YjljYWUxNzQ3NmI4OGI/">57231e30070e9d500ffa25774809c6b1</a></td><td>13 Jul. 2014</td><td>0xf34c4850L</td></tr><tr><td><a href="https://malwr.com/analysis/ZDE1ZDE1MzA2YWVjNDY5N2JiYTE4ZDFiZjZjMGYxMTc/">77ce85d6fc611cc533fcc5c235fb71af</a></td><td>20 Jul. 2014</td><td>0xf34c4850L</td></tr><tr><td><a href="https://malwr.com/analysis/MTlmNjQxMjZmZjMxNDE4YTg5YjQ5ODgxMzgwODUwN2Y/">83e4b0ca5ebfa9de4adbc58009629d61</a></td><td>27 Dec. 2014</td><td>0xf085a446L</td></tr><tr><td><a href="https://malwr.com/analysis/MGMzZDE5M2JkZjgwNDNlNzhkYjlhYTY4YTFmNTNjZGM/">c85ddcad47577b294b13ce3c8f0134bb</a></td><td>14 Jan. 2015</td><td>0xffc222d4L</td></tr><tr><td><a href="https://malwr.com/analysis/ZGI1ZTEyMWZkNGFjNDdkOWI5Y2VlM2ZiZTIzMGU0NDk/">6da71b4317dd664544903cbc872308d7</a></td><td>25 Jan. 2015</td><td>0xf3fc72bbL</td></tr><tr><td><a href="https://malwr.com/analysis/ZDhjNDE0MDZmNjdmNGNkM2JiZmJlN2UyYTE4YTI5ZDM/">1667b27c7ca9662330ad15a9ab34dffc</a></td><td>16 Feb. 2015</td><td>0x2ff654d0</td></tr><tr><td><a href="https://malwr.com/analysis/OTQ3ZDU5M2E0M2I2NGU0ZjgxN2ExOTlkN2IzMjM1NTg/">cb07607586d35e8a5832c0149f6c244c</a></td><td>09 Mar. 2015</td><td>0x54d64257</td></tr><tr><td><a href="https://malwr.com/analysis/Y2FjMWVjMjVjZjNkNDM1ZGFkMjEyYWY2MDA5ZWRkNzY/">1667b27c7ca9662330ad15a9ab34dffc</a></td><td>09 Mar. 2015<sup>R</sup></td><td>0x54d64257</td></tr><tr><td><a href="https://malwr.com/analysis/MDkyYjFiMzcxMWU4NGRhMzlkYmQyZGE1MjgwNzJkYjk/">cb07607586d35e8a5832c0149f6c244c</a></td><td>09 Mar. 2015<sup>R</sup></td><td>0x54d64257</td></tr></tbody></table><p><sup>R</sup>: Reanalysis</p><p>Most samples on Malwr were analysed in June and July of 2014, but there are also some recent samples.</p></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://rosti.bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-rosti" xlink:href="/assets/svg/icons.svg#icon-rosti"></use></svg> Rösti</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2024 Johannes Bader, last updated March 27, 2024</p></div></div></div></div></footer></div></div></body></html>