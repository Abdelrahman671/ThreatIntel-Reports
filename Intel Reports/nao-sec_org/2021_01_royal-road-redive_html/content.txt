<!DOCTYPE html>
<title>Royal Road! Re:Dive | @nao_sec</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta content="nao-sec.org" property="og:title" />
<meta content="article" property="og:type" />
<meta content="https://nao-sec.org/2021/01/royal-road-redive.html" property="og:url" />
<meta content="nao-sec.org" property="og:site_name" />
<meta content="Royal Road! Re:Dive - @nao_sec" property="og:description" />
<meta content="https://nao-sec.org/assets/icon.png" name="twitter:image:src" />
<meta content="@nao_sec" name="twitter:site" />
<meta content="summary" name="twitter:card" />
<meta content="nao-sec.org" name="twitter:title" />
<meta content="https://nao-sec.org/assets/icon.png" property="og:image" />
<meta name="description" content="Abstract We introduced the “Royal Road RTF Weaponizer” in our previous blog [1] (and presented at Japan Security Analyst Conference 2020 and CPX 360 CPRCon 2...">
<meta name="author" content="nao_sec">
<meta name="generator" content="Jekyll v3.10.0">
<link rel="canonical" href="https://nao-sec.org/2021/01/royal-road-redive.html">
<link rel="stylesheet" href="/assets/css/index.css">
<link rel="stylesheet" href="/assets/css/classes.css">
<link rel="stylesheet" href="/assets/css/default.css">
<link rel="alternate" type="application/atom+xml" href="/feed.xml" title="nao_sec" />




<body class="light">

<header>
  <div id="head-wrap">
    <div id="head-row">
      <h1><a href="/" class="brand"><img src="/assets/logo.png" class="logo" />nao_sec</a></h1>
    </div>
    <div id="head-row">
      <nav><a href="/">Home</a><a href="/archive">Archive</a><a href="/about">About</a></nav>
      <nav><a class="icon" href="/cdn-cgi/l/email-protection#274e494148674946480a54424409485540"><svg><use xlink:href="/assets/fontawesome/icons.svg#envelope"></use></svg></a><a class="icon" href="https://twitter.com/nao_sec"><svg><use xlink:href="/assets/fontawesome/icons.svg#twitter"></use></svg></a><a class="icon" href="https://infosec.exchange/@nao_sec"><svg><use xlink:href="/assets/fontawesome/icons.svg#mastodon"></use></svg></a><a class="icon" href="https://github.com/nao-sec"><svg><use xlink:href="/assets/fontawesome/icons.svg#github"></use></svg></a><a class="icon" href="/feed.xml"><svg><use xlink:href="/assets/fontawesome/icons.svg#rss"></use></svg></a></nav>    
    </div>
  </div>
</header>

<article>
  <header><h1><a href="/2021/01/royal-road-redive.html">Royal Road! Re:Dive</a></h1>
    <time datetime="2021-01-04T15:00:00+00:00">2021-01-04</time>
  </header>
<p><img src="https://nao-sec.org/assets/2021-01-05/00.png" alt="" /></p>

<h2 id="abstract">Abstract</h2>
<p>We introduced the “Royal Road RTF Weaponizer” in our previous blog [1] (and presented at Japan Security Analyst Conference 2020 and CPX 360 CPRCon 2020). Royal Road is a tool shared by many targeted attack groups believed to belong to China. It’s been a year since our previous blog, and Royal Road is still in use. Here, we will introduce the Royal Road-related attacks observed during 2020.</p>

<h2 id="previous-blog">Previous Blog</h2>
<p>Let’s briefly review the previous blog. Royal Road is a tool that generates RTF files that exploit the Microsoft Office Equation Editor vulnerabilities (CVE-2017-11882, CVE-2018-0798, CVE-2018-0802). The details of the tool are unknown, but the RTF file generated by it has various characteristics. The definition of “RTF file generated by Royal Road” may vary from researcher to researcher. Therefore, we define a file that meets the following conditions as an “RTF file generated by Royal Road”.</p>

<ol>
  <li>Exploiting a vulnerability in Microsoft Office Equation Editor</li>
  <li>Containing an object named “8.t”</li>
</ol>

<p>However, some RTF files are likely to be related to Royal Road, even though they don’t meet the second condition. For classification purposes, we refer to this as “Related Samples”. In reality, this may also be an RTF file generated by Royal Road, but the truth is only known to the attacker. Due to the our research, we have divided these into “Royal Road Samples” and “Related Samples”. However, they are treated the same in the specific case studies below.</p>

<p>And Royal Road is shared among various attack groups believed to belong to China. Specifically, it is believed to be used by the following attack groups. The attack group alias is written for reference. Strictly speaking, these can be different. For example, TA428 and Pirate Panda are not exactly equivalent.</p>

<ol>
  <li>Temp.Tick (BRONZE BUTLER, RedBaldKnight)</li>
  <li>Temp.Conimes (Goblin Panda, Cycldek)</li>
  <li>Temp.Periscope (Leviathan, APT40)</li>
  <li>Temp.Trident (Dagger Panda, IceFog)</li>
  <li>Tonto (Karma Panda, CactusPete, LoneRanger)</li>
  <li>TA428 (Pirate Panda)</li>
  <li>Rancor</li>
</ol>

<p>Also, we categorized the various characteristics of the RTF files used by these groups and showed what they have in common.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/01.png" alt="" /></p>

<h2 id="updates">Updates</h2>
<p>It’s been a year since we introduced Royal Road. In the meantime, the RTF file, believed to have been generated by Royal Road, has been used many times in targeted attacks, and several updates have been observed. First of all, we will introduce the updates.</p>

<p>The RTF file generated by Royal Road contains encoded malware. It is decoded by Shellcode after exploit. In our previous blog, we introduced the following 5 encodings.</p>

<ol>
  <li>4D 5A 90 00  (not encoded)</li>
  <li>F2 A3 20 72</li>
  <li>B2 A6 6D FF</li>
  <li>B0 74 77 46</li>
  <li>B2 5A 6F 00</li>
</ol>

<p>Many of the RTF files we observed in 2020 used the 3rd and 4th encodings. However, a few samples used the new encodings. The following 2 encodings.</p>

<ol>
  <li>A9 A4 6E FE</li>
</ol>

<p><img src="https://nao-sec.org/assets/2021-01-05/02.png" alt="" /></p>

<p>This encoding can be decoded with code like the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dec_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)):</span>
    <span class="n">dec_data</span><span class="p">.</span><span class="n">append</span><span class="p">(((</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">enc_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="s">"little"</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x7b</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x7b</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>94 5F DA D8</li>
</ol>

<p><img src="https://nao-sec.org/assets/2021-01-05/03.png" alt="" /></p>

<p>This encoding can be decoded with code like the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dec_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">xor_key</span> <span class="o">=</span> <span class="mi">1387678300</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20000000</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">xor_key</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">x3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x0</span> <span class="o">^</span> <span class="n">x1</span> <span class="o">^</span> <span class="n">x2</span><span class="p">)</span>
        <span class="n">xor_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">+</span> <span class="n">xor_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">x3</span>
    <span class="n">dec_data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">enc_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">"little"</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">xor_key</span> <span class="o">%</span> <span class="mi">256</span><span class="p">))</span>
</code></pre></div></div>

<p>Our tool for decrypting Royal Road encoded object is already available on GitHub. It also supports the above new encodings.</p>

<p><a href="https://github.com/nao-sec/rr_decoder">https://github.com/nao-sec/rr_decoder</a></p>

<h2 id="new-attack-groups">New Attack Groups</h2>
<p>As we mentioned earlier, several attack groups use Royal Road. The following eight attack groups have been observed to use Royal Road (including both Royal Road Samples and Related Samples) during 2020.</p>

<ol>
  <li>Temp.Conimes</li>
  <li>Tonto</li>
  <li>TA428</li>
  <li>Naikon</li>
  <li>Higaisa</li>
  <li>Vicious Panda</li>
  <li>FunnyDream</li>
  <li>TA410</li>
</ol>

<p>Of these, we have already reported on 1-3 attack groups in our previous blog. Temp.Conimes used NewCore RAT to attack Vietnamese organizations. Tonto used Bisonal to attack organizations in East Asia such as Russia.</p>

<p>And the TA428 was also particularly active, using PoisonIvy, Cotx RAT, Tmanger, and nccTrojan to attack East Asian organizations such as Mongolia. We will not cover these individual cases here, but if you are interested, see the IOC chapter. For TA428, the paper [2] and blogs [3][4][5] are available from NSJ (NTT Security Japan). Please refer to that.</p>

<p>For Naikon, CheckPoint Research reported [6], but unfortunately, we could not observe this. Therefore, in the following, we will introduce attack cases related to Royal Road for four groups (5-8).</p>

<h3 id="higaisa">Higaisa</h3>
<p>Higaisa is an attack group that seems to have been active since at least around 2016. It is primarily targeted at North Korean-related organizations and is believed to be aimed at stealing information using AttackBot, PIZ Stealer, and Gh0st RAT.</p>

<p>The blogs have been written by Tencent and Positive Technologies so far [7][8][9], and are attributed to (South) Korea. However, NSJ’s paper [10] showed a connection with Ghost Dragon [11] and PKPLUG [12], and it was reported that it might belong to China.</p>

<p>We observed an attack by Higaisa on Royal Road in March 2020.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/04.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/05.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/06.png" alt="" /></p>

<p>The malware executed by the Royal Road RTF was AttackBot. AttackBot is a downloader that has been used by Higaisa since at least April 2018.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/07.png" alt="" /></p>

<h3 id="vicious-panda">Vicious Panda</h3>
<p>Vicious Panda is an attack group reported by CheckPoint Research in March 2020 [13]. It is said to belong to China and targets East Asia such as Russia, Mongolia, and Ukraine.</p>

<p>We observed an attack on the Royal Road by Vicious Panda in March 2020.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/08.png" alt="" /></p>

<p>It has been reported to execute malware similar to Enfal and BYEBY.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/09.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/10.png" alt="" /></p>

<h3 id="funnydream">FunnyDream</h3>
<p>FunnyDream is an attack group that is said to have been active since around 2018. It is said to belong to China and targets Southeast Asia such as Vietnam and Malaysia. FunnyDream uses Chinoxy and FunnyDream Backdoor. BitDefender has published a detailed report [14] on FunnyDream.</p>

<p>We observed an attack by FunnyDream from March to May 2020.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/11.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/12.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/13.png" alt="" /></p>

<p>Chinoxy is a RAT that has been used by FunnyDream since around 2018. It decoded the config using two numeric data and communicates with the C&amp;C server using its original protocol using Blowfish.</p>

<h3 id="ta410">TA410</h3>
<p>TA410 is an attack group that is said to have been active since around 2016. It is said to belong to China and is suspected to be related to APT10. The report has been published by Proofpoint [15][16][17] and is mainly targeted at public sector in the US. It uses malware called LockBack and FlowCloud.</p>

<p>We observed an attack by TA410 in October 2020.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/15.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/16.png" alt="" /></p>

<p>FlowCloud is a RAT reported by Proofpoint in June 2020. FlowCloud has been reported to be v4 and v5, but the FlowCloud we observed at this time was similar to v4.</p>

<h2 id="attack-case-against-japan">Attack case against Japan</h2>
<p>In addition to the four attack groups shown so far (Higaisa, Vicious Panda, FunnyDream, TA410), attacks that appear to be related to Royal Road have been observed. Among them, we will introduce an example of attacks on Japan. We are not able to identify which attack group made this attack. If you have any knowledge about it, please share it with us…</p>

<p>The attack on Japan took place in November 2020. The attack began with 2 RTF files attached to the email.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/18.png" alt="" /></p>

<p><img src="https://nao-sec.org/assets/2021-01-05/19.png" alt="" /></p>

<p>These RTF files did not contain an 8.t object, however  did contain an associated object. This is the malware encoded by the 4th (B0 74 77 46) encoding shown above.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/20.png" alt="" /></p>

<p>The overall picture of the attack is as follows.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/21.png" alt="" /></p>

<p>The malware executed was an unknown RAT. We call this XLBug RAT because of the characteristics left in this RAT. The RAT held information such as C&amp;C server encoded by Base64 and XOR.</p>

<p><img src="https://nao-sec.org/assets/2021-01-05/22.png" alt="" /></p>

<p>The following commands are implemented in XLBug RAT.</p>

<ul>
  <li>Get directory information</li>
  <li>Get file information</li>
  <li>Get computer information</li>
  <li>Execute file</li>
  <li>Upload file</li>
  <li>Download file</li>
  <li>Rename file</li>
  <li>Delete file</li>
  <li>Delete itself</li>
</ul>

<p>The naming convention and encoding of the encoded object contained in the RTF are similar to those of the TA428. However, we could not say that this was a TA428 attack.</p>

<h2 id="relationship">Relationship</h2>
<p>In the previous blog, we summarized the characteristics of attack groups that use Royal Road. We used it to divide the attack groups into two groups. However, by 2020, those characteristics are almost meaningless. It has been standardized or deleted. It’s not as easy to group as it used to be. In the first place, the groups sharing Royal Road should be close. We do not classify further, but if you have any comments please let us know.</p>

<h2 id="yara-rule">Yara Rule</h2>
<p>The GitHub repository we shared in the previous blog is still being updated.</p>

<p><a href="https://github.com/nao-sec/yara_rules">https://github.com/nao-sec/yara_rules</a></p>

<h2 id="ioc">IOC</h2>
<p>The IOC sheet shared in the previous blog is still being updated.</p>

<p><a href="https://nao-sec.org/jsac2020_ioc.html">https://nao-sec.org/jsac2020_ioc.html</a></p>

<h2 id="tool">Tool</h2>
<p>The tool used by Royal Road to decrypt encoded object is still being updated.</p>

<p><a href="https://github.com/nao-sec/rr_decoder">https://github.com/nao-sec/rr_decoder</a></p>

<h2 id="wrap-up">Wrap-Up</h2>
<p>The attacks using Royal Road have decreased compared to 2019, but are still ongoing. There are many cases of attacks by TA428 and Tonto, but other attacks by different attack groups (Higaisa, Vicious Panda, FunnyDream, TA410) have also been observed.</p>

<p>The attacks on Japan have also been observed and we were unable to identify this with a known attack group. The use of Royal Road by these unknown attack groups is expected to continue.</p>

<p>In addition to Royal Road, there are other cases, such as the Tmanger family, that appear to share tools among multiple targeted attack groups. We should continue to pay close attention to these tool sharing cases.</p>

<h2 id="acknowledgments">Acknowledgments</h2>
<p>“nao_sec” is an independent research team that does not belong to any company. Individuals belong to each company and engage in research, but the activities of nao_sec still maintain their independence from each company. We are grateful to all of you who cooperated with our research activities every day.</p>

<hr />

<h2 id="references">References</h2>
<p>[1] nao_sec, “An Overhead View of the Royal Road”, https://nao-sec.org/2020/01/an-overhead-view-of-the-royal-road.html<br />
[2] NTT Security Japan, “Operation LagTime IT: colourful Panda footprint”, https://vblocalhost.com/uploads/VB2020-Ozawa-etal.pdf<br />
[3] NTT Security Japan, “Panda’s New Arsenal: Part 1 Tmanger”, https://insight-jp.nttsecurity.com/post/102gi9b/pandas-new-arsenal-part-1-tmanger<br />
[4] NTT Security Japan, “Panda’s New Arsenal: Part 2 Albaniiutas”, https://insight-jp.nttsecurity.com/post/102gkfp/pandas-new-arsenal-part-2-albaniiutas<br />
[5] NTT Security Japan, “Panda’s New Arsenal: Part 3 Smanager”, https://insight-jp.nttsecurity.com/post/102glv5/pandas-new-arsenal-part-3-smanager<br />
[6] CheckPoint Research, “Naikon APT: Cyber Espionage Reloaded”, https://research.checkpoint.com/2020/naikon-apt-cyber-espionage-reloaded/<br />
[7] Tencent, “APT攻击组织”黑格莎（Higaisa）”攻击活动披露”, https://s.tencent.com/research/report/836.html<br />
[8] Tencent, ““Higaisa（黑格莎）”组织近期攻击活动报告”, https://s.tencent.com/research/report/895.html<br />
[9] Positive Technologies, “COVID-19 и новогодние поздравления: исследуем инструменты группировки Higaisa”, https://www.ptsecurity.com/ru-ru/research/pt-esc-threat-intelligence/covid-19-i-novogodnie-pozdravleniya-issleduem-instrumenty-gruppirovki-higaisa/<br />
[10] NTT Security Japan, “Crafty Panda 標的型攻撃解析レポート”, https://www.nttsecurity.com/docs/librariesprovider3/default-document-library/craftypanda-analysis-report<br />
[11] Cylance (BlackBerry), “The Ghost Dragon”, https://blogs.blackberry.com/en/2016/04/the-ghost-dragon<br />
[12] Palo Alto Networks, “PKPLUG: Chinese Cyber Espionage Group Attacking Southeast Asia”, https://unit42.paloaltonetworks.com/pkplug_chinese_cyber_espionage_group_attacking_asia/<br />
[13] CheckPoint Research, “Vicious Panda: The COVID Campaign”, https://research.checkpoint.com/2020/vicious-panda-the-covid-campaign/<br />
[14] BitDefender, “A Detailed Timeline of a Chinese APT Espionage Attack Targeting South Eastern Asian Government Institutions”, https://labs.bitdefender.com/2020/11/a-detailed-timeline-of-a-chinese-apt-espionage-attack-targeting-south-eastern-asian-government-institutions/<br />
[15] Proofpoint, “LookBack Malware Targets the United States Utilities Sector with Phishing Attacks Impersonating Engineering Licensing Boards”, https://www.proofpoint.com/us/threat-insight/post/lookback-malware-targets-united-states-utilities-sector-phishing-attacks<br />
[16] Proofpoint, “LookBack Forges Ahead: Continued Targeting of the United States’ Utilities Sector Reveals Additional Adversary TTPs”, https://www.proofpoint.com/us/threat-insight/post/lookback-forges-ahead-continued-targeting-united-states-utilities-sector-reveals<br />
[17] Proofpoint, “TA410: The Group Behind LookBack Attacks Against U.S. Utilities Sector Returns with New Malware”, https://www.proofpoint.com/us/blog/threat-insight/ta410-group-behind-lookback-attacks-against-us-utilities-sector-returns-new</p>

  
  
</article>


<footer>
  <a class="gray" href="/2021/04/exploit-kit-still-sharpens-a-sword.html">« Exploit Kit still sharpens a sword</a>
  <a class="gray" href="/2020/01/an-overhead-view-of-the-royal-road.html">An Overhead View of the Royal Road »</a>
</footer>



<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body>