<!doctype html><html lang="en-US"><head><link href="/assets/fonts/Montserrat-VariableFont_wght.woff2" rel="preload" type="font/woff2" as="font" crossorigin=""><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>The DGA of Ranbyus</title><meta content="Ranbyus is a trojan that steals banking information &amp;mdash; among other personal data. End of April 2015 I first noticed samples of Ranbyus that use a Domain Generation Algorithm (DGA) to generate the domains for its command and control (C2) traffic:" name="description" property="og:description"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="en_US" property="og:locale"><meta content="./assets/img/front/ranbyus-800.jpeg" property="og:image"><meta content="website" property="og:type"><meta content="Binary Reverse Engineering Blog" property="og:site_name"><meta content="The DGA of Ranbyus" property="og:title"><meta content="summary" name="twitter:card"><meta content="@viql" name="twitter:site"><meta content="@viql" name="twitter:creator"><meta content="The DGA of Ranbyus" name="twitter:title"><meta content="Ranbyus is a trojan that steals banking information &amp;mdash; among other personal data. End of April 2015 I first noticed samples of Ranbyus that use a Domain Generation Algorithm (DGA) to generate the domains for its command and control (C2) traffic:" name="twitter:description"><meta content="https://bin.re/assets/img/front/ranbyus-800.jpeg" name="twitter:image"><link href="/assets/css/common-ef2fe0.css" rel="stylesheet"><link href="feed.xml" rel="alternate" type="application/atom+xml" title="Atom feed for the Blog"><link href="/assets/css/blog-a83391.css" rel="stylesheet"><link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60"><link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76"><link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120"><link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152"><link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180"><link href="/apple-touch-icon-192x192.png" rel="apple-touch-icon" sizes="192x192"><link href="/apple-touch-icon-512x512.png" rel="apple-touch-icon" sizes="512x512"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon"><noscript><style>img.lazyload {
          display: none;
        }</style></noscript><script defer src="/assets/js/all.min-a1c570.js"></script></head><body class="a b7"><div class="b"><div class="d"><div class="f e"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-close" xlink:href="/assets/svg/icons.svg#icon-close"></use></svg></div><div class="h"><ul class="i j sidebar"><li class="q r"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul></div></div></div><div id="aw"><div class="w"><header class="y x"><nav class="z a0"><a href="/"><span class="a1"><!-- Generator: Adobe Illustrator 25.0.0, SVG Export Plug-In  --> <svg viewBox="0 0 86.4 20.21" height="20.21px" style="overflow:visible;enable-background:new 0 0 86.4 20.21;" version="1.1" width="86.4px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g><path class="a2" d="M28.56,5.13c-1.99,0-2.87-1.12-2.87-2.57c0-1.5,0.9-2.57,2.87-2.57c2.02,0,2.95,1.07,2.95,2.57
    C31.51,4.01,30.58,5.13,28.56,5.13z M25.96,19.94V6.47h5.22v13.46H25.96z"></path><path class="a2" d="M43.69,19.94v-7.92c0-1.23-0.27-1.91-1.59-1.91c-0.6,0-1.53,0.3-2.24,0.76v9.07H34.6V6.45h4.89l0.08,1.31
    l0.16,0.05c1.58-1.12,3.5-1.69,4.78-1.69c3.47,0,4.42,1.91,4.42,4.86v8.96H43.69z"></path><path class="a2" d="M54.33,20.15c-1.83,0-2.62-1.01-2.62-2.37c0-1.37,0.82-2.35,2.62-2.35c1.86,0,2.68,0.98,2.68,2.35
    C57,19.14,56.16,20.15,54.33,20.15z"></path><path class="a2" d="M65.14,9.23c1.58-1.69,3.85-3.17,5.49-3.17c0.63,0,0.79,0.49,0.79,1.09c0,1.45-0.87,4.29-1.58,5.3l-4.51-0.57
    v8.06h-5.21V6.45h5.16c0,0.66-0.14,2.08-0.25,2.7L65.14,9.23z"></path><path class="a2" d="M86.4,12.78v1.2h-8.63c0.03,1.72,1.07,2.4,3.03,2.4c1.34,0,3-0.35,4.34-0.76l0.98,3.2
    c-1.94,1.04-4.34,1.39-6.25,1.39c-5.9,0-7.32-3.33-7.32-6.99c0-3.41,1.58-7.13,7.07-7.13C85.74,6.09,86.4,9.78,86.4,12.78z
     M77.82,11.52h3.9c-0.03-1.31-0.41-2.29-1.83-2.29C78.4,9.23,77.93,10.32,77.82,11.52z"></path><path class="a2" d="M6.92,12.81"></path><path class="a2" d="M17.24,6.06c-0.79,0-2.43,0.29-3.87,1.3c0-0.14-0.06-2.69-0.06-3.07V0.27H8.12v9.28
    c2.71-0.69,4.54-1.87,5.24-2.18v3.06c-0.85,0.55-4.15,2.11-5.24,2.44v5.86c2.62,1.28,6.12,1.48,7.54,1.48
    c5.79,0,7.16-3.33,7.16-7.02C22.82,9.07,21.45,6.06,17.24,6.06z M15.41,16.6c-0.54,0-1.31-0.08-2.05-0.38v-5.79
    c0.66-0.33,1.45-0.65,2.16-0.65c1.01,0,2.1,0.35,2.1,3.47C17.63,16.14,16.59,16.6,15.41,16.6z"></path><path class="a2" d="M8.12,9.55c-1.03,0.23-2.56,0.51-3.66,0.23l0-3.09L0,11.57l4.51,4.88l0-3.13c1.38,0.17,2.69-0.23,3.61-0.45
    V9.55z"></path></g></svg></span></a><div class="a3"><button class="a2 a4" id="ax"><svg height="20px" version="1.1" width="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewport="0 0 20 20"><path class="a5" d="M2.28,15.89l1.57-1.61l1.24,1.24l-1.57,1.61L2.28,15.89z M8.86,19.33v-2.61h1.74v2.61H8.86z M9.73,4.35
	c1.46,0,2.71,0.52,3.75,1.55s1.55,2.28,1.55,3.75s-0.52,2.71-1.55,3.75c-1.03,1.03-2.28,1.55-3.75,1.55s-2.71-0.52-3.75-1.55
	s-1.55-2.28-1.55-3.75S4.95,6.93,5.98,5.9S8.26,4.35,9.73,4.35z M16.81,8.77h2.65v1.78h-2.65V8.77z M14.36,15.52l1.24-1.2l1.57,1.57
	l-1.24,1.24L14.36,15.52z M17.18,3.43l-1.57,1.57l-1.24-1.24l1.57-1.57L17.18,3.43z M10.6,0v2.61H8.86V0C8.86,0,10.6,0,10.6,0z
	 M2.65,8.77v1.78H0V8.77H2.65z M5.09,3.77L3.85,5.01L2.28,3.43l1.24-1.24L5.09,3.77z"></path><path class="a6" d="M14.18,14.19c3.31-3.31,3.31-8.67,0-11.97C13.06,1.1,11.7,0.36,10.26,0c2.2,2.88,1.98,7.01-0.65,9.65
	C6.99,12.26,2.88,12.49,0,10.33c0.37,1.41,1.1,2.76,2.21,3.87C5.52,17.5,10.88,17.5,14.18,14.19z M7.1,2.48H6.36l0.52,0.52
	L6.55,3.34L6.03,2.81v0.74H5.56V2.81L5.04,3.34L4.71,3.01l0.52-0.52H4.49V2.02h0.74L4.71,1.49l0.33-0.33l0.52,0.52V0.95h0.47v0.74
	l0.52-0.52l0.33,0.33L6.36,2.02H7.1V2.48z M0.94,3.94c0,0.26-0.21,0.47-0.47,0.47S0,4.2,0,3.94s0.21-0.47,0.47-0.47
	S0.94,3.68,0.94,3.94z M3.88,5.66c0,0.29-0.24,0.53-0.53,0.53S2.83,5.95,2.83,5.66c0-0.29,0.24-0.53,0.53-0.53S3.88,5.36,3.88,5.66z
	"></path></svg></button><ul class="i j a7"><li class="q"><a href="/">Home</a></li><li class="q"><a href="/publications/">Publications</a></li><li class="q t"><span class="u">Projects<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/projects/risk-battle-outcomes/">Probability of Winning Battles in Risk</a></li><li><a href="/tag/project-euler/">Project Euler</a></li><li><a href="/projects/bazarbackdoor/">BazarBackdoor Tools</a></li></ul></li><li class="q t r"><span class="u">Reverse Engineering<svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-angle-down" xlink:href="/assets/svg/icons.svg#icon-angle-down"></use></svg></span><ul class="v"><li><a href="/tag/malware-analysis/">Malware Analysis</a></li><li><a href="/projects/solutions-to-crackmes/">Solutions to Crackmes</a></li><li><a href="/projects/solutions-to-practical-reverse-engineering/">Solutions to "Practical Reverse Engineering"</a></li></ul></li></ul><div class="f a8 a9"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-bars" xlink:href="/assets/svg/icons.svg#icon-bars"></use></svg></div></div></nav></header><div class="b8"><noscript>&lt;img src="/assets/img/header/ranbyus-640.jpeg" class="-minfy-post__title-image"/&gt;</noscript><img alt="cover image for post 'The DGA of Ranbyus'" class="lazyload b9" data-src="/assets/img/header/ranbyus-640.jpeg" data-srcset="/assets/img/header/ranbyus-640.webp 640w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMjMzIj48cGF0aCBmaWxsPSIjMjU1NDRjIiBkPSJNMCAwaDMwMHYyMzNIMHoiLz48ZyBmaWxsLW9wYWNpdHk9Ii41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNiAuNilzY2FsZSgxLjE3MTg4KSI+PGNpcmNsZSBjeD0iMTk4IiBjeT0iNjciIHI9IjI0OCIvPjxlbGxpcHNlIGN4PSIxNTIiIGN5PSIxMDciIGZpbGw9IiM1M2EyYTYiIHJ4PSIyMzIiIHJ5PSIxOSIvPjxjaXJjbGUgcj0iMSIgZmlsbD0iIzAwMDQwMSIgdHJhbnNmb3JtPSJtYXRyaXgoMTU4LjQwNTc3IDkuMjY1IC0zLjI3ODY5IDU2LjA1NjQxIDEyNC40IDM0KSIvPjxlbGxpcHNlIGN4PSIxMjIiIGN5PSIxODAiIHJ4PSIyNTUiIHJ5PSIzMyIvPjxwYXRoIGQ9Ik0xOTcgNzJoMjJ2NDVoLTIyeiIvPjxwYXRoIGZpbGw9IiM4YmZmZmYiIGQ9Ik0xMS40IDEyNS4xIDQ1IDk2bC40IDE3LjgtMzMuNi0xMy45eiIvPjxwYXRoIGZpbGw9IiM2OGM2YzYiIGQ9Ik0xMDAgODloMzN2MzhoLTMzeiIvPjxwYXRoIGZpbGw9IiMwZjJhMzEiIGQ9Ik0xMzcgMjdoNTJ2MTI5aC01MnoiLz48cGF0aCBmaWxsPSIjOGRmYmY2IiBkPSJtMTY0LjUgMTI3LjIgMTkuOC00MC43LTIwLjYgMjYuNi0yMS4yLTI0eiIvPjxwYXRoIGZpbGw9IiM5NGZmZmYiIGQ9Im05MSA4MyAxIDQxLTEwLTZ6Ii8+PHBhdGggZmlsbD0iIzgzZmZmZCIgZD0ibTU4LjkgMTM0LjUgNC4yLTMyLjUgMjYuMiAxOS45LTM0LjctMzYuNXoiLz48cGF0aCBmaWxsPSIjOTBmZmZmIiBkPSJtMTkxLjggODEuMyA3LjcgNDIuNyAyMS45IDQuMS0zMi4xLTE1LjZ6Ii8+PGVsbGlwc2UgY3g9IjExNiIgY3k9IjQ4IiBmaWxsPSIjM2Q5ZWI1IiByeD0iMjkiIHJ5PSI0Ii8+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgeD0iLS41IiB5PSItLjUiIHRyYW5zZm9ybT0ibWF0cml4KDI0Ljk5NjIgLjQzNjMxIC0uMTIyMTcgNi45OTg5MyAxMTkgMTAwKSIvPjxwYXRoIGZpbGw9IiNhMWZmZmYiIGQ9Ik0yMTkgODloOHYyOGgtOHoiLz48cGF0aCBmaWxsPSIjYjdmZmZmIiBkPSJNMjM1IDExOWgyMXY3aC0yMXoiLz48cGF0aCBkPSJtMjI3IDgzIDIyIDM1aC0yMXpNNDggNzhoN3Y1NmgtN3oiLz48cGF0aCBmaWxsPSIjYTVmZmZmIiBkPSJNMTcgOTBoMjJ2N0gxN3oiLz48cGF0aCBmaWxsPSIjMDAwOTA5IiBkPSJtNzIuNyAxMTEuNS04OC41IDk4LjkgMzcuNi05OC42IDEyMi42IDY3LjV6Ii8+PHBhdGggZD0iTTEwNyAxMTJoMjN2NmgtMjN6Ii8+PGVsbGlwc2UgY3k9IjkyIiBmaWxsPSIjMDAwNTAwIiByeD0iMTAiIHJ5PSIxOTgiLz48cGF0aCBmaWxsPSIjYTFmZmZmIiBkPSJNNDEgOTloNnYyOGgtNnoiLz48cGF0aCBmaWxsPSIjMDEwNTA2IiBkPSJtODQuNiAxMTIuMi45LTM2LjkgMTA1LjktMy41TDI3LjEgNDkuNHoiLz48cGF0aCBkPSJtMjMxIDE0MS02My0zMi0yIDE5eiIvPjxwYXRoIGZpbGw9IiMyNzczOGMiIGQ9Im0xOTkuOSAxNDMuNS00NCAxMy40LTMuOC0xMi40IDQ0LTEzLjR6Ii8+PHBhdGggZmlsbD0iI2EwZmZmZiIgZD0iTTI0MiAxMDRoMTR2N2gtMTR6Ii8+PHBhdGggZmlsbD0iIzhiZmZmZCIgZD0ibTE0NS43IDg4LjIgNS4zLS4zLjUgOC42LTYuNyAxMnoiLz48Y2lyY2xlIHI9IjEiIGZpbGw9IiMwMDBhMTAiIHRyYW5zZm9ybT0ibWF0cml4KC04LjY5NzE1IC04Ljc3NjAxIDE0LjM3Mzg3IC0xNC4yNDQ3IDE0My4zIDEyNy4xKSIvPjxwYXRoIGQ9Ik05MyA4MWg3djU4aC03eiIvPjwvZz48L3N2Zz4="></div><main class="y aa"><article class="z ae ac ba"><div class="bb"><h1 class="bc">The DGA of Ranbyus</h1></div><div class="bd"><ul class="i be"><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-calendar-o" xlink:href="/assets/svg/icons.svg#icon-calendar-o"></use></svg> <a href="https://bin.re/2015/05">May 22, 2015</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-book" xlink:href="/assets/svg/icons.svg#icon-book"></use></svg> <a href="/category/reverse-engineering">reverse engineering</a></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-tags" xlink:href="/assets/svg/icons.svg#icon-tags"></use></svg> <span class="bf"><a href="/tag/dga" class="bg">dga</a> <a href="/tag/malware-analysis" class="bg">malware analysis</a></span></li><li><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-comments-o" xlink:href="/assets/svg/icons.svg#icon-comments-o"></use></svg> <a href="#comments">2 comments</a></li></ul><div class="bh"><span class="bj">Table of Contents</span><ul class="i bk"><li><a href="#algorithm">Algorithm</a></li><li><a href="#callback-loop">Callback Loop</a></li><li><a href="#dga-parameters-and-seed">DGA Parameters and Seed</a></li><li><a href="#the-dga">The DGA</a></li><li><a href="#observed-seeds">Observed Seeds</a></li><li><a href="#summary">Summary</a></li><li><a href="#dga-characteristics">DGA Characteristics</a></li><li><a href="#decompiled-code">Decompiled Code</a></li></ul><div><span class="bj">DGArchive</span><p>The DGA in this blog post has been implemented by the <a href="https://dgarchive.caad.fkie.fraunhofer.de/" class="bm">DGArchive</a> project.</p></div><div><span class="bj">Malpedia</span><p>For more information about the malware in this blog post see the <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.ranbyus" class="bm">Malpedia entry on Ranbyus</a>.</p></div></div></div><div class="b6 bi"><p>Ranbyus is a trojan that steals banking information — among other personal data. End of April 2015 I first noticed samples of Ranbyus that use a Domain Generation Algorithm (DGA) to generate the domains for its command and control (C2) traffic:</p><pre><code>hcfoopojnuqxho.su 	
undrdsbhivryqn.tw 	
dkehliueofdued.net 	
mpuakxjqpscfpj.com 	
eelolbwmfmtkae.pw 	
noppsmyiijqujh.in 	
joxrsxwdybbgqb.me 	
(...)
</code></pre><p>In this post I show how the DGA works by reversing the following sample:</p><dl><dt>filename</dt><dd><code>_RANDOMNUM_6_11__vozvrat.exe</code></dd><dt>filetype</dt><dd>PE32 executable (GUI) Intel 80386, for MS Windows</dd><dt>md5</dt><dd>fa57f601402aab8168dea94c7c5f029f</dd><dt>sha256</dt><dd>dc4f3340ca8e623a5a77eb95411696fc25a7e6f5ef657ac9fd76eb4bc11c16b4</dd><dt>malwr</dt><dd><a href="https://malwr.com/analysis/NDY5NzFhNjUxMzA3NDExYjlhMzhjYzEyN2IyNDM5ZTQ/">link</a></dd></dl><p>I focused my efforts exclusively on the domain generation part of Ranbyus. Refer to the blog posts of Aleksandr Matrosov <a href="http://www.welivesecurity.com/2012/06/05/smartcard-vulnerabilities-in-modern-banking-malware/">here</a> and <a href="http://www.welivesecurity.com/2012/12/19/win32spy-ranbyus-modifying-java-code-in-rbs/">here</a> for an in-depth analysis of Ranbyus.</p><h2 id="algorithm">Algorithm</h2><p>This section shows the algorithm behind the domains of Ranbyus and its seeding and parametrization.</p><h3 id="callback-loop">Callback Loop</h3><p>The next image represents the part of the Ranbyus that tries to find a valid C2 target. It consists of an outer loop (<code>month_loop</code>) and an inner loop. The register <code>edi</code> holds the index of the outer loop. It runs from 0 down to -30. The number of iterations for the inner loop is specified by a parameter of the DGA (set to 40 in all analysed samples):</p><p><noscript>&lt;img src="assets/callback_loop.png" class=""/&gt;</noscript><img alt="Callback Loop" class="lazyload" data-src="assets/callback_loop.png" data-srcset="assets/callback_loop-1x.webp 723w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjMiIGhlaWdodD0iMTI0MiIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I05hTk5hTk5hTiI+PC9zdmc+" sizes="(max-width: 723px) 100vw, 723px"></p><p>The first act of the outer loop is to get the current time:</p><p><noscript>&lt;img src="assets/get_current_time.png" class=""/&gt;</noscript><img alt="Getting the Current Date" class="lazyload" data-src="assets/get_current_time.png" data-srcset="assets/get_current_time-1x.webp 498w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OTgiIGhlaWdodD0iNDYyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 498px) 100vw, 498px"></p><p>Ranbyus then subtracts days from the current date according to the index of the outer loop:</p><p><noscript>&lt;img src="assets/subtractd.png" class=""/&gt;</noscript><img alt="Subtract Days" class="lazyload" data-src="assets/subtractd.png" data-srcset="assets/subtractd-1x.webp 502w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDIiIGhlaWdodD0iNjA1IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 502px) 100vw, 502px"></p><p>The resulting date will be used to seed the DGA with a granularity of one day. In the first iteration, the DGA uses the current date. In the next iteration — when the index is -1 — yesterday’s date is used. This continues up to 30 days in the past if need be. So even though the DGA generates a fresh set of domains every day, it also checks the domains of past days. This gives the DGA the benefit of fast changing domains in case domains get blocked or sinkholed, while at the same time enabling older domains to be used for up to one month if they still work.</p><p>The inner loop generates the domains for the day with <code>the_dga</code> and makes the callback. In case of failure, Ranbyus sleeps for <code>wait_time</code> milliseconds (500 in my samples) and retries up to <code>nr_of_domains</code> (40) different domains.</p><h3 id="dga-parameters-and-seed">DGA Parameters and Seed</h3><p>Apart from the current date, the DGA is seeded with a hardcoded magic number:</p><p><noscript>&lt;img src="assets/hardcoded_seed.png" class=""/&gt;</noscript><img alt="Hardcoded Seed" class="lazyload" data-src="assets/hardcoded_seed.png" data-srcset="assets/hardcoded_seed-1x.webp 412w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MTIiIGhlaWdodD0iMzUiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNOYU5OYU5OYU4iPjwvc3ZnPg==" sizes="(max-width: 412px) 100vw, 412px"></p><p>The number of domains per day is hardcoded to 40:</p><p><noscript>&lt;img src="assets/hardcoded_nr_of_domains.png" class=""/&gt;</noscript><img alt="Hardcoded Number of Domains" class="lazyload" data-src="assets/hardcoded_nr_of_domains.png" data-srcset="assets/hardcoded_nr_of_domains-1x.webp 454w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTQiIGhlaWdodD0iNzUiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNOYU5OYU5OYU4iPjwvc3ZnPg==" sizes="(max-width: 454px) 100vw, 454px"></p><p>The wait time after a failed callback attempt is set to 500 ms:</p><p><noscript>&lt;img src="assets/hardcoded_sleep_time.png" class=""/&gt;</noscript><img alt="Hardcoded Sleep Time" class="lazyload" data-src="assets/hardcoded_sleep_time.png" data-srcset="assets/hardcoded_sleep_time-1x.webp 379w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNzkiIGhlaWdodD0iMzUiIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiNOYU5OYU5OYU4iPjwvc3ZnPg==" sizes="(max-width: 379px) 100vw, 379px"></p><p>Ranbyus also uses a hard-coded list of top level domains:</p><p><noscript>&lt;img src="assets/hardcoded_tlds.png" class=""/&gt;</noscript><img alt="Hardcoded Top Level Domains" class="lazyload" data-src="assets/hardcoded_tlds.png" data-srcset="assets/hardcoded_tlds-1x.webp 599w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1OTkiIGhlaWdodD0iMTM4IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 599px) 100vw, 599px"></p><p>The top level domains are: <em>.in</em>, <em>.me</em>, <em>.cc</em>, <em>.su</em>, <em>.tw</em>, <em>.net</em>, <em>.com</em>, <em>.pw</em>, and <em>.org</em>. The last domain <em>.org</em> is never used due to a bug of the DGA. The top level domains are tested one after another (except the last one), starting at a day-dependent offset:</p><p><noscript>&lt;img src="assets/start_index.png" class=""/&gt;</noscript><img alt="Starting Index" class="lazyload" data-src="assets/start_index.png" data-srcset="assets/start_index-1x.webp 400w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMTI0IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 400px) 100vw, 400px"></p><p>The error of subtracting 1 from the modulus is repeated also when picking the letters of the second level domain.</p><h3 id="the-dga">The DGA</h3><p>This is the disassembly of the DGA routine:</p><p><noscript>&lt;img src="assets/the_dga.png" class=""/&gt;</noscript><img alt="The DGA" class="lazyload" data-src="assets/the_dga.png" data-srcset="assets/the_dga-1x.webp 331w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMzEiIGhlaWdodD0iNjM0IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 331px) 100vw, 331px"></p><p>The subroutine generates domains in two independent parts:</p><ol><li>the top level domain is picked from the hardcoded list shown above</li><li>the second level domain is generated.</li></ol><p>The following disassembly shows how the top level domain is picked:</p><p><noscript>&lt;img src="assets/tld.png" class=""/&gt;</noscript><img alt="Top Level Domain" class="lazyload" data-src="assets/tld.png" data-srcset="assets/tld-1x.webp 395w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzOTUiIGhlaWdodD0iNTYwIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojTmFOTmFOTmFOIj48L3N2Zz4=" sizes="(max-width: 395px) 100vw, 395px"></p><p>Starting at the day dependent offset determined earlier, the algorithm picks the domains in a circular fashion, omitting the last domain because the DGA wrongly subtracts one from the modulus.</p><pre><code>[".in", ".me", ".cc", ".su", ".tw", ".net", ".com", ".pw", ".org"][offset % (9-1)]
offset++
</code></pre><p>The disassembly for the second level domain looks as follows. It generates 14 different letters based on the DGA’s seed, and the value of <code>day</code>, <code>month</code> and <code>year</code>. Note that these names are misleading: although theses values are initialized with the current or past dates, the values are modified by each call to the routine.</p><p><noscript>&lt;img src="assets/second_level_domain.png" class=""/&gt;</noscript><img alt="Second Level Domain" class="lazyload" data-src="assets/second_level_domain.png" data-srcset="assets/second_level_domain-1x.webp 388w" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzODgiIGhlaWdodD0iMTQ4NSIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6I05hTk5hTk5hTiI+PC9zdmc+" sizes="(max-width: 388px) 100vw, 388px"></p><p>This pseudo-code summarizes the algorithm:</p><pre><code>FOR i = 0 TO 13
    day = (day &gt;&gt; 15) ^ 16 * (day &amp; 0x1FFF ^ 4 * (seed ^ day))
    year = ((year &amp; 0xFFFFFFF0) &lt;&lt; 17) ^ ((year ^ (7 * year)) &gt;&gt; 11)
    month = 14 * (month &amp; 0xFFFFFFFE) ^ ((month ^ (4 * month)) &gt;&gt; 8)
    seed = (seed &gt;&gt; 6) ^ ((day + 8 * seed) &lt;&lt; 8) &amp; 0x3FFFF00
    int x = ((day ^ month ^ year) % 25) + 'a' 
    domain[i] = x;
</code></pre><p>The malware authors repeated their modulus error: like for the tld, the modulus needed to be increased by one. As it stands, ‘z’ is no reachable. Ranbyus shares this bug with the DGAs of <a href="https://bin.re/blog/the-dga-of-ramnit/">Ramnig</a> and <a href="https://bin.re/blog/the-dgas-of-necurs/">Necurs</a>.</p><p>Seed the end of this blog post for a C-implementation of the DGA.</p><h2 id="observed-seeds">Observed Seeds</h2><p>The following tables lists some of the samples from malwr.com that are Ranbyus with the described DGA. All samples use the same parametrization, only the seed varies.</p><table><thead><tr><th>md5</th><th>seed</th></tr></thead><tbody><tr><td>4b04f6baaf967e9c534e962c98496497</td><td>65BA0743</td></tr><tr><td>087b19ce441295207052a610d1435b03</td><td>65BA0743</td></tr><tr><td>28474761f28538a05453375635a53982</td><td>65BA0743</td></tr><tr><td>b309eab0277af32d7a344b8a8b91bd73</td><td>C5F128F3</td></tr><tr><td>4c7057ce783b2e4fb5d1662a5cb1312a</td><td>C5F128F3</td></tr><tr><td>b309eab0277af32d7a344b8a8b91bd73</td><td>C5F128F3</td></tr><tr><td>7cbc671bcb97122e0ec5b448f0251dc0</td><td>C5F128F3</td></tr><tr><td>437028f94ceea4cab0d302d9ac6973eb</td><td>C5F128F3</td></tr><tr><td>b309eab0277af32d7a344b8a8b91bd73</td><td>C5F128F3</td></tr><tr><td>6378b7af643e87c063f69ddfb498d852</td><td>B6354BC3</td></tr><tr><td>fa57f601402aab8168dea94c7c5f029f</td><td>B6354BC3</td></tr><tr><td>9f2c89ad17e9b6cf386028a8c9189264</td><td>0478620C</td></tr></tbody></table><h2 id="summary">Summary</h2><h3 id="dga-characteristics">DGA Characteristics</h3><p>The characteristics of Ranbyus’ DGA are:</p><table><thead><tr><th>property</th><th>value</th></tr></thead><tbody><tr><td>seed</td><td>magic number and current date</td></tr><tr><td>granularity</td><td>1 day, with a 31 day sliding window</td></tr><tr><td>domains per seed and day</td><td>40</td></tr><tr><td>domains per sliding window</td><td>1240</td></tr><tr><td>sequence</td><td>sequential</td></tr><tr><td>wait time between domains</td><td>500 ms</td></tr><tr><td>top level domains</td><td>.in, .me, .cc, .su, .tw, .net, .com, .pw</td></tr><tr><td>second level characters</td><td>lower case letters except ‘z’</td></tr><tr><td>second level domain length</td><td>14 letters</td></tr></tbody></table><h3 id="decompiled-code">Decompiled Code</h3><p>The following C code generates the domains for a given day and seed. In order to generate all domains that the malware can generate for any given seed and date, one would also need to run the code for all dates going 30 days in the past.</p><p><strong>Edit 23.5.2015:</strong> The following code had contained a bug that led to a wrong sequence of top level domains, thanks to Anthony Kasza for sharing that with me.</p><pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

char* dga(unsigned int day, unsigned int month, unsigned int year, 
        unsigned int seed, unsigned int nr) 
{
    char *tlds[] = {"in", "me", "cc", "su", "tw", "net", "com", "pw", "org"};
    char domain[15];
    int d;
    int tld_index = day;
    for(d = 0; d &lt; nr; d++)
    {
        unsigned int i;
        for(i = 0; i &lt; 14; i++)
        {
            day = (day &gt;&gt; 15) ^ 16 * (day &amp; 0x1FFF ^ 4 * (seed ^ day));
            year = ((year &amp; 0xFFFFFFF0) &lt;&lt; 17) ^ ((year ^ (7 * year)) &gt;&gt; 11);
            month = 14 * (month &amp; 0xFFFFFFFE) ^ ((month ^ (4 * month)) &gt;&gt; 8);
            seed = (seed &gt;&gt; 6) ^ ((day + 8 * seed) &lt;&lt; 8) &amp; 0x3FFFF00;
            int x = ((day ^ month ^ year) % 25) + 97; 
            domain[i] = x;
        }
        printf("%s.%s\n", domain, tlds[tld_index++ % 8]);
    }
}

main (int argc, char *argv[])
{
    if(argc != 5) {
        printf("Usage: dga &lt;day&gt; &lt;month&gt; &lt;year&gt; &lt;seed&gt;\n");
        printf("Example: dga 14 5 2015 b6354bc3\n"); 
        exit(0);
    }

    dga(atoi(argv[1]), atoi(argv[2]), atoi(argv[3]), 
            strtoul(argv[4], NULL, 16), 40);
}
</code></pre><h2 id="comments">Archived Comments</h2><div><p><i><strong>Note: </strong>I removed the Disqus integration in an effort to cut down on bloat. The following comments were retrieved with the export functionality of Disqus. If you have comments, please reach out to me by Twitter or email.</i></p></div><div class="bt"><div class="thread"><div class="comment"><span class="author">Sandor Nemes</span> <span class="date">Aug 26, 2015 07:42:01 UTC</span><div class="message"><p>In the C code the strtoul function should be used instead as strtol will limit the seed to 0x7fffffff.</p></div></div><div class="thread"><div class="comment"><a href="https://disqus.com/by/baderj/"><span class="author">Johannes Bader</span> </a><span class="date">Aug 26, 2015 09:36:08 UTC</span><div class="message"><p>Thanks, fixed it.</p></div></div></div></div></div></div></article></main><footer><div><div class="y"><div class="z ae aj"><div class="ag ak al am"><h3>Links</h3><ul class="i an"><li><a href="http://www.twitter.com/viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-twitter" xlink:href="/assets/svg/icons.svg#icon-twitter"></use></svg> Twitter</a></li><li><a href="http://www.github.com/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-github" xlink:href="/assets/svg/icons.svg#icon-github"></use></svg> GitHub</a></li><li><a href="mailto:hello@bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-envelope-o" xlink:href="/assets/svg/icons.svg#icon-envelope-o"></use></svg> Mail</a></li><li><a href="https://keybase.io/baderj" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-keybase" xlink:href="/assets/svg/icons.svg#icon-keybase"></use></svg> Keybase</a></li><li><a href="/feed.xml" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-feed" xlink:href="/assets/svg/icons.svg#icon-feed"></use></svg> RSS</a></li><li><a href="https://threatcat.ch" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-threatcat" xlink:href="/assets/svg/icons.svg#icon-threatcat"></use></svg> Threatcat.ch</a></li><li><a href="https://infosec.exchange/@viql" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-mastodon" xlink:href="/assets/svg/icons.svg#icon-mastodon"></use></svg> Mastodon</a></li><li><a href="https://rosti.bin.re" rel="me"><svg viewBox="0 0 35 32" class="g"><use href="/assets/svg/icons.svg#icon-rosti" xlink:href="/assets/svg/icons.svg#icon-rosti"></use></svg> Rösti</a></li></ul></div><div class="ag ak al am"><div><h3>Categories</h3><ul class="i"><li><a href="/category/reverse-engineering">reverse-engineering</a> <span class="ao">(81)</span></li><li><a href="/category/tutorial">tutorial</a> <span class="ao">(14)</span></li><li><a href="/category/project-euler">project-euler</a> <span class="ao">(13)</span></li><li><a href="/category/misc">misc</a> <span class="ao">(2)</span></li><li><a href="/category/visualization">visualization</a> <span class="ao">(2)</span></li></ul></div></div><div class="ag ak al am a7"><div><h3>Tags</h3><span class="ap"><a href="/tag/malware-analysis" class="aq">malware-analysis <span class="ao">(42)</span></a><a href="/tag/dga" class="aq">dga <span class="ao">(36)</span></a><a href="/tag/crackmes" class="aq">crackmes <span class="ao">(23)</span></a><a href="/tag/practical-reverse-engineering" class="aq">practical-reverse-engineering <span class="ao">(16)</span></a><a href="/tag/math" class="aq">math <span class="ao">(15)</span></a><a href="/tag/project-euler" class="aq">project-euler <span class="ao">(13)</span></a><a href="/tag/python" class="aq">python <span class="ao">(12)</span></a><a href="/tag/upatre" class="aq">upatre <span class="ao">(4)</span></a><a href="/tag/visualization" class="aq">visualization <span class="ao">(4)</span></a><a href="/tag/d3js" class="aq">d3js <span class="ao">(3)</span></a></span> <a href="/tag/" class="ar">show all</a></div></div><div class="ag ak al am as"><div class="at"><div><h3>Blog Archive</h3><span class="au"><a href="/2013">2013</a><span class="ao">(20)</span></span> <span class="au"><a href="/2014">2014</a><span class="ao">(46)</span></span> <span class="au"><a href="/2015">2015</a><span class="ao">(24)</span></span> <span class="au"><a href="/2016">2016</a><span class="ao">(6)</span></span> <span class="au"><a href="/2018">2018</a><span class="ao">(1)</span></span> <span class="au"><a href="/2019">2019</a><span class="ao">(2)</span></span> <span class="au"><a href="/2020">2020</a><span class="ao">(5)</span></span> <span class="au"><a href="/2021">2021</a><span class="ao">(3)</span></span> <span class="au"><a href="/2022">2022</a><span class="ao">(3)</span></span> <span class="au"><a href="/2023">2023</a><span class="ao">(2)</span></span></div></div></div></div></div><div class="y av"><div class="z"><div class="ag"><p>© 2012 - 2024 Johannes Bader, last updated March 27, 2024</p></div></div></div></div></footer></div></div></body></html>