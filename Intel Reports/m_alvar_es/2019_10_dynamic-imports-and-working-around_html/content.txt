<!DOCTYPE html>
<html class='v2' dir='ltr' lang='en-GB'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/3566091532-css_bundle_v2.css' rel='stylesheet' type='text/css'/>
<meta content='width=1100' name='viewport'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='https://m.alvar.es/favicon.ico' rel='icon' type='image/x-icon'/>
<link href='https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="# Malware Research Notes - Atom" href="https://m.alvar.es/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="# Malware Research Notes - RSS" href="https://m.alvar.es/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="# Malware Research Notes - Atom" href="https://www.blogger.com/feeds/2832371727794363441/posts/default" />

<link rel="alternate" type="application/atom+xml" title="# Malware Research Notes - Atom" href="https://m.alvar.es/feeds/4795907936393926768/comments/default" />
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<link href='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s640/Screenshot+2019-10-23+at+16.20.24.png' rel='image_src'/>
<meta content='https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html' property='og:url'/>
<meta content='Dynamic Imports and Working Around Indirect Calls - Smokeloader Study Case' property='og:title'/>
<meta content='When reversing malware it is common to find an injected payload loading references to external resources (DLL functions). This happens for t...' property='og:description'/>
<meta content='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/w1200-h630-p-k-no-nu/Screenshot+2019-10-23+at+16.20.24.png' property='og:image'/>
<title># Malware Research Notes: Dynamic Imports and Working Around Indirect Calls - Smokeloader Study Case</title>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Simple
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */
/* Content
----------------------------------------------- */
body {
font: normal normal 14px 'Times New Roman', Times, FreeSerif, serif;
color: #cccccc;
background: #292929 none repeat scroll top left;
padding: 0 40px 40px 40px;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
h2 {
font-size: 22px;
}
a:link {
text-decoration:none;
color: #dd7700;
}
a:visited {
text-decoration:none;
color: #cc6600;
}
a:hover {
text-decoration:underline;
color: #cc6600;
}
.body-fauxcolumn-outer .fauxcolumn-inner {
background: transparent none repeat scroll top left;
_background-image: none;
}
.body-fauxcolumn-outer .cap-top {
position: absolute;
z-index: 1;
height: 400px;
width: 100%;
}
.body-fauxcolumn-outer .cap-top .cap-left {
width: 100%;
background: transparent none repeat-x scroll top left;
_background-image: none;
}
.content-outer {
-moz-box-shadow: 0 0 40px rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 5px rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 10px #333333;
box-shadow: 0 0 40px rgba(0, 0, 0, .15);
margin-bottom: 1px;
}
.content-inner {
padding: 10px 10px;
}
.content-inner {
background-color: #333333;
}
/* Header
----------------------------------------------- */
.header-outer {
background: transparent none repeat-x scroll 0 -400px;
_background-image: none;
}
.Header h1 {
font: normal normal 60px 'Times New Roman', Times, FreeSerif, serif;
color: #ffffff;
text-shadow: -1px -1px 1px rgba(0, 0, 0, .2);
}
.Header h1 a {
color: #ffffff;
}
.Header .description {
font-size: 140%;
color: #aaaaaa;
}
.header-inner .Header .titlewrapper {
padding: 22px 30px;
}
.header-inner .Header .descriptionwrapper {
padding: 0 30px;
}
/* Tabs
----------------------------------------------- */
.tabs-inner .section:first-child {
border-top: 1px solid #404040;
}
.tabs-inner .section:first-child ul {
margin-top: -1px;
border-top: 1px solid #404040;
border-left: 0 solid #404040;
border-right: 0 solid #404040;
}
.tabs-inner .widget ul {
background: #222222 none repeat-x scroll 0 -800px;
_background-image: none;
border-bottom: 1px solid #404040;
margin-top: 0;
margin-left: -30px;
margin-right: -30px;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .6em 1em;
font: normal normal 14px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
color: #999999;
border-left: 1px solid #333333;
border-right: 0 solid #404040;
}
.tabs-inner .widget li:first-child a {
border-left: none;
}
.tabs-inner .widget li.selected a, .tabs-inner .widget li a:hover {
color: #ffffff;
background-color: #000000;
text-decoration: none;
}
/* Columns
----------------------------------------------- */
.main-outer {
border-top: 0 solid #404040;
}
.fauxcolumn-left-outer .fauxcolumn-inner {
border-right: 1px solid #404040;
}
.fauxcolumn-right-outer .fauxcolumn-inner {
border-left: 1px solid #404040;
}
/* Headings
----------------------------------------------- */
div.widget > h2,
div.widget h2.title {
margin: 0 0 1em 0;
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
color: #ffffff;
}
/* Widgets
----------------------------------------------- */
.widget .zippy {
color: #999999;
text-shadow: 2px 2px 1px rgba(0, 0, 0, .1);
}
.widget .popular-posts ul {
list-style: none;
}
/* Posts
----------------------------------------------- */
h2.date-header {
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
}
.date-header span {
background-color: transparent;
color: #cccccc;
padding: inherit;
letter-spacing: inherit;
margin: inherit;
}
.main-inner {
padding-top: 30px;
padding-bottom: 30px;
}
.main-inner .column-center-inner {
padding: 0 15px;
}
.main-inner .column-center-inner .section {
margin: 0 15px;
}
.post {
margin: 0 0 25px 0;
}
h3.post-title, .comments h4 {
font: normal normal 22px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
margin: .75em 0 0;
}
.post-body {
font-size: 110%;
line-height: 1.4;
position: relative;
}
.post-body img, .post-body .tr-caption-container, .Profile img, .Image img,
.BlogList .item-thumbnail img {
padding: 0;
background: #111111;
border: 1px solid #111111;
-moz-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
-webkit-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
}
.post-body img, .post-body .tr-caption-container {
padding: 1px;
}
.post-body .tr-caption-container {
color: #cccccc;
}
.post-body .tr-caption-container img {
padding: 0;
background: transparent;
border: none;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
box-shadow: 0 0 0 rgba(0, 0, 0, .1);
}
.post-header {
margin: 0 0 1.5em;
line-height: 1.6;
font-size: 90%;
}
.post-footer {
margin: 20px -2px 0;
padding: 5px 10px;
color: #888888;
background-color: #303030;
border-bottom: 1px solid #444444;
line-height: 1.6;
font-size: 90%;
}
#comments .comment-author {
padding-top: 1.5em;
border-top: 1px solid #404040;
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
#comments .avatar-image-container img {
border: 1px solid #111111;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #999999;
border-bottom: 1px solid #999999;
}
.comments .comment-thread.inline-thread {
background-color: #303030;
}
.comments .continue {
border-top: 2px solid #999999;
}
/* Accents
---------------------------------------------- */
.section-columns td.columns-cell {
border-left: 1px solid #404040;
}
.blog-pager {
background: transparent none no-repeat scroll top center;
}
.blog-pager-older-link, .home-link,
.blog-pager-newer-link {
background-color: #333333;
padding: 5px;
}
.footer-outer {
border-top: 0 dashed #bbbbbb;
}
/* Mobile
----------------------------------------------- */
body.mobile  {
background-size: auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
.mobile .body-fauxcolumn-outer .cap-top {
background-size: 100% auto;
}
.mobile .content-outer {
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
}
.mobile .tabs-inner .widget ul {
margin-left: 0;
margin-right: 0;
}
.mobile .post {
margin: 0;
}
.mobile .main-inner .column-center-inner .section {
margin: 0;
}
.mobile .date-header span {
padding: 0.1em 10px;
margin: 0 -10px;
}
.mobile h3.post-title {
margin: 0;
}
.mobile .blog-pager {
background: transparent none no-repeat scroll top center;
}
.mobile .footer-outer {
border-top: none;
}
.mobile .main-inner, .mobile .footer-inner {
background-color: #333333;
}
.mobile-index-contents {
color: #cccccc;
}
.mobile-link-button {
background-color: #dd7700;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile .tabs-inner .section:first-child {
border-top: none;
}
.mobile .tabs-inner .PageList .widget-content {
background-color: #000000;
color: #ffffff;
border-top: 1px solid #404040;
border-bottom: 1px solid #404040;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #404040;
}

--></style>
<style id='template-skin-1' type='text/css'><!--
body {
min-width: 1200px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1200px;
max-width: 1200px;
_width: 1200px;
}
.main-inner .columns {
padding-left: 0px;
padding-right: 210px;
}
.main-inner .fauxcolumn-center-outer {
left: 0px;
right: 210px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0px") -
parseInt("210px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0px;
}
.main-inner .fauxcolumn-right-outer {
width: 210px;
}
.main-inner .column-left-outer {
width: 0px;
right: 100%;
margin-left: -0px;
}
.main-inner .column-right-outer {
width: 210px;
margin-right: -210px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
body#layout div.add_widget {
padding: 8px;
}
body#layout div.add_widget a {
margin-left: 32px;
}
--></style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=2832371727794363441&amp;zx=769d96a4-bc47-4ff1-a530-898ac7c2afc0' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=2832371727794363441&amp;zx=769d96a4-bc47-4ff1-a530-898ac7c2afc0' rel='stylesheet'/></noscript>
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>

<script type="text/javascript" language="javascript">
  // Supply ads personalization default for EEA readers
  // See https://www.blogger.com/go/adspersonalization
  adsbygoogle = window.adsbygoogle || [];
  if (typeof adsbygoogle.requestNonPersonalizedAds === 'undefined') {
    adsbygoogle.requestNonPersonalizedAds = 1;
  }
</script>


</head>
<body class='loading variant-dark'>
<div class='navbar no-items section' id='navbar' name='Navbar'>
</div>
<div class='body-fauxcolumns'>
<div class='fauxcolumn-outer body-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content'>
<div class='content-fauxcolumns'>
<div class='fauxcolumn-outer content-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content-outer'>
<div class='content-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left content-fauxborder-left'>
<div class='fauxborder-right content-fauxborder-right'></div>
<div class='content-inner'>
<header>
<div class='header-outer'>
<div class='header-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left header-fauxborder-left'>
<div class='fauxborder-right header-fauxborder-right'></div>
<div class='region-inner header-inner'>
<div class='header section' id='header' name='Header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
<a href='https://m.alvar.es/'>
<a href="http://m.alvar.es/"># Malware Research Notes</a>
</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span>
</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class='header-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</header>
<div class='tabs-outer'>
<div class='tabs-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left tabs-fauxborder-left'>
<div class='fauxborder-right tabs-fauxborder-right'></div>
<div class='region-inner tabs-inner'>
<div class='tabs no-items section' id='crosscol' name='Cross-column'></div>
<div class='tabs no-items section' id='crosscol-overflow' name='Cross-Column 2'></div>
</div>
</div>
<div class='tabs-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='main-outer'>
<div class='main-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left main-fauxborder-left'>
<div class='fauxborder-right main-fauxborder-right'></div>
<div class='region-inner main-inner'>
<div class='columns fauxcolumns'>
<div class='fauxcolumn-outer fauxcolumn-center-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-left-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-right-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class='columns-inner'>
<div class='column-center-outer'>
<div class='column-center-inner'>
<div class='main section' id='main' name='Main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Thursday, 31 October 2019</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s640/Screenshot+2019-10-23+at+16.20.24.png' itemprop='image_url'/>
<meta content='2832371727794363441' itemprop='blogId'/>
<meta content='4795907936393926768' itemprop='postId'/>
<a name='4795907936393926768'></a>
<h3 class='post-title entry-title' itemprop='name'>
Dynamic Imports and Working Around Indirect Calls - Smokeloader Study Case
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-4795907936393926768' itemprop='description articleBody'>
<div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">When reversing malware it is common to find an injected payload loading references to external resources (DLL functions). This happens for two main reasons:</div><ol style="text-align: left;"><li style="text-align: justify;">The hosting process does not have all resources necessary to the execution of the injected payload;&nbsp;</li><li style="text-align: justify;">Making reversing engineering the malware trickier since the dumped segment will have all calls pointing to a meaningless address table.&nbsp;</li></ol><div><div style="text-align: justify;">This article explains how to revert this trick and get back <i>API</i> call names annotations in an <a href="https://www.hex-rays.com/products/ida/" target="_blank"><i>IDApro</i></a> database. A sample of&nbsp;<a href="http://security.neurolabs.club/2019/08/smokeloaders-hardcoded-domains-sneaky.html" style="font-style: italic;" target="_blank">Smokeloader</a>&nbsp;was used&nbsp;for illustrating the ideas described in this post.</div></div><div><br /></div><div>This article is divided in three main parts:</div><div><ol style="text-align: left;"><li>Explaining the observed technique;</li><li>How it works; and</li><li>How to circumventing it in order to facilitate reversing.&nbsp;</li></ol></div><div><div style="text-align: justify;">First of all, shout out to&nbsp;<i>Sergei Frankoff</i> from <a href="https://www.openanalysis.net/" target="_blank">Open Analysis</a>&nbsp;for this <a href="https://www.youtube.com/watch?v=hM2Zvsak3GM" target="_blank">amazing video tutorial</a> on this same topic which inspired me to write about my analyses. Regards also to <a href="https://twitter.com/peta909" target="_blank">Mark Lim</a> who also wrote a <a href="https://findingvulns.blogspot.com/2018/04/using-ida-pro-debugger-and-idapython.html" target="_blank">very interesting article</a> about labelling indirect calls in <i>2018</i>. His article uses <i>structures</i> instead of patching the code (which is also a good approach) but I think it lacks important details and I will try to cover these points in here.</div></div><div><br /></div><div>Examples presented in this article were extracted from the following <i>Smokeloader</i> sample:</div><div><br /></div><div>Filename:&nbsp; &nbsp;p0n36i2d.exe</div><div>MD5:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;a8cc396b6f5568e94f28ca3381c7f9df</div><div><div>SHA1:&nbsp; &nbsp; &nbsp; &nbsp;12948e36584e1677e80f78b8cc5c20576024c13f</div><div>SHA256:&nbsp; &nbsp;17b548f9c8077f8ba66b70d55c383f87f92676520e2749850e555abb4d5f80a5</div><div>Size:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;215.5 KB (220672 bytes)</div><div>Type:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PE32 executable for MS Windows (GUI) Intel 80386 32-bit</div></div><div><br /><div style="text-align: justify;">Explaining what is going on in the first stage (<i>packer</i>/<i>crypter</i>) is out of scope; this article focuses on characteristics found in the final payload. This sample injects the main payload in "<i>explorer.exe</i>" as it is possible to observe in&nbsp;<a href="https://app.any.run/tasks/c3ab622a-8c68-42c8-aeb7-bf88226983cc/" target="_blank">this AnyRun sandbox analysis</a>.</div><div style="text-align: justify;"><br /></div></div><div><div style="text-align: justify;"><i>Figure 01</i> shows how the code looks immediately after the execution control passes to the injected code.</div></div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s1600/Screenshot+2019-10-23+at+16.20.24.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="526" data-original-width="979" height="342" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s640/Screenshot+2019-10-23+at+16.20.24.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 01 - Smokeloader's final payload.</td></tr></tbody></table><div><div style="text-align: justify;">Three points were marked in this code snip (<span style="color: #93c47d;"><b>1</b></span>, <span style="color: #93c47d;"><b>2</b></span>&nbsp;and <span style="color: #93c47d;"><b>3</b></span>).&nbsp; The first point <span style="color: #93c47d;"><b>(1)</b></span> is the call to the main function (located at&nbsp;<i>0x002F1853</i>). This function expects to receive an address through <i>ECX</i> register. This address points to a data segment where all temporary structures will be stored.&nbsp;</div></div><div><br /><a name='more'></a><br /></div><div><div style="text-align: justify;">The third point <span style="color: #93c47d;"><b>(3)</b></span>&nbsp;is an indirect call to an address stored in register <i>ESI</i> plus offset&nbsp;<i>0xEAE</i>. The debugger was not able to resolve this address since the "memory segment" pointed by <i>ESI</i> is not set at this point of the execution (<i>Instruction Pointer</i> pointing to<i>&nbsp;0x002F1844</i>). <b><span style="color: white;">This pattern usually is an indicator that this code will dynamically resolve and import external resources to a specific address table</span></b> (in this case stored in what we called "<i>data segment</i>"). This is an interesting technique because this table can be moved around by changing the address stored in <i>ESI</i> as long as offsets are preserved. In this code <i>ESI</i> is set to "<i>0x002E0000</i>" which is the address of a <i>read-and-write</i> memory segment created during the first stage. <i>Figure 02</i>&nbsp;shows the region pointed by the offset <i>0xEAE</i>&nbsp;which is <i>empty</i>&nbsp;at this point of the execution.</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9fSywWYUclwjxGl7Sp5KujslGHp0kKmyMJBt7bQTAN1trK1CmEE0GWwVLNdYfSEvjTUUY4RpklY3HsG9jSyqj7g08YGTIm-ialA1WaMOMAHhR_em3oSBUUccaxUvQOqAajumJZDMp4po/s1600/Screenshot+2019-10-23+at+17.18.02.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="245" data-original-width="628" height="155" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9fSywWYUclwjxGl7Sp5KujslGHp0kKmyMJBt7bQTAN1trK1CmEE0GWwVLNdYfSEvjTUUY4RpklY3HsG9jSyqj7g08YGTIm-ialA1WaMOMAHhR_em3oSBUUccaxUvQOqAajumJZDMp4po/s400/Screenshot+2019-10-23+at+17.18.02.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 02 - Address pointed by the indirect call.</td></tr></tbody></table><div style="text-align: justify;"><span style="text-align: justify;">The second point </span><span style="color: #93c47d; text-align: justify;"><b>(2)</b></span><span style="text-align: justify;">&nbsp;marks a function call immediately before the indirect call </span><span style="color: #93c47d; text-align: justify;"><b>(3)</b></span><span style="text-align: justify;">.&nbsp; This is a strong indicator that the code for creating the address table must be somewhere inside this function</span><span style="text-align: justify;">. The address located in "</span><i style="text-align: justify;">002E0EAE"</i><span style="text-align: justify;">&nbsp;will be filled with pointers to the expected API function. <i>Figure 3</i> shows this same memory region after the "</span><i style="text-align: justify;">__load_libraries</i><span style="text-align: justify;">" function is executed.</span></div><div style="text-align: justify;"></div><br /><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEggH5idx2JxYxsdUNNfar-V9rrfvLmlae4ddLR3n_BtZcCXtvHCl_YWouqxJ4nXX05b8Q_gOcXuVfesrhpF3F_yi4RssbPv40dINURHKs6bdNAqdaM4H_lTN4X3Deq4tsbIRFTUGdt7kOM/s1600/Screenshot+2019-10-23+at+17.42.28.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="538" data-original-width="653" height="327" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEggH5idx2JxYxsdUNNfar-V9rrfvLmlae4ddLR3n_BtZcCXtvHCl_YWouqxJ4nXX05b8Q_gOcXuVfesrhpF3F_yi4RssbPv40dINURHKs6bdNAqdaM4H_lTN4X3Deq4tsbIRFTUGdt7kOM/s400/Screenshot+2019-10-23+at+17.42.28.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 03 - Address pointed by the indirect call is filled after the "__load_libraries" function is called</td></tr></tbody></table><div><div style="text-align: justify;"><i>x32dbg</i> has a memory dump visualisation mode called "A<i>ddress</i>" which will list every function pointed to each address loaded in the call table we just described.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-CbS2zM757S_L7xOXKbZaJnp070C_XkymaqsIfVbM_M0_4tOUruM5lW2C2_Gc5frCo2yDltuhRo800qdCXEKXR66bwZW_wSKeSxnV_egsyJLK0-BBEc5bEbYhQiyRs9G3TuEwuZnyPU4/s1600/Screenshot+2019-10-23+at+17.47.03.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="340" data-original-width="604" height="225" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-CbS2zM757S_L7xOXKbZaJnp070C_XkymaqsIfVbM_M0_4tOUruM5lW2C2_Gc5frCo2yDltuhRo800qdCXEKXR66bwZW_wSKeSxnV_egsyJLK0-BBEc5bEbYhQiyRs9G3TuEwuZnyPU4/s400/Screenshot+2019-10-23+at+17.47.03.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 04 - Resolved address in call table</td></tr></tbody></table><div><div style="text-align: justify;"><i>Figure 04</i> shows that the position pointed by the indirected call listed in point <span style="color: #38761d;">(3)</span>&nbsp;points to function "<i>sleep</i>" inside "<i>kernel32.dll</i>". Basically this call table is an <i>Array</i> of unsigned integers (<i>4 bytes</i>) containing an address pointing to an API call in each position.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><div><div style="text-align: justify;">The "<i>__load_library</i>" function is responsible for creating this "<i>call table</i>" so the focus of this article will move to understand how it works.<br /><br /></div><div style="text-align: justify;"><div style="text-align: center;"><span style="font-size: large;"><span style="color: white;">---&nbsp;</span><i style="color: white;"><b>End of part I</b></i><span style="color: white;"> ---</span></span></div><div style="text-align: center;"><span style="color: white;"><br /></span></div></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjq5Tz6UHNnAOKf1effEH7vooMDVPvC_oQ-MUY7Zh5ZvNJMy33U2H-9u_I-WMIhJgraUqDT216DtRZQxMxBxO6XM3OJ7zKpuupTOj9Ri-44m0iKzSxfVUa18zpcQ7luAteLEE6a4eUn90k/s1600/Screenshot+2019-10-23+at+20.35.09.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="684" data-original-width="299" height="320" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjq5Tz6UHNnAOKf1effEH7vooMDVPvC_oQ-MUY7Zh5ZvNJMy33U2H-9u_I-WMIhJgraUqDT216DtRZQxMxBxO6XM3OJ7zKpuupTOj9Ri-44m0iKzSxfVUa18zpcQ7luAteLEE6a4eUn90k/s320/Screenshot+2019-10-23+at+20.35.09.png" width="138" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 05 - "<i>__load_libraries</i>" zoomed out CFG representation.</td></tr></tbody></table><div><div style="text-align: justify;">Figure 05 shows an overview&nbsp;of&nbsp;the "<i>__load_library</i>" function created by <i>IDA</i>. This function is quite large and performs few connected steps which we need to go through in order to fully understanding its behaviour. This function can be divided in three main sections:</div></div><div><ol style="text-align: left;"><li style="text-align: justify;">Code responsible for finding the base addresses for core libraries;</li><li style="text-align: justify;">Code responsible for loading addresses for calls within code libraries;</li><li style="text-align: justify;">The last section is responsible for loading other libraries necessary for executing the malware.</li></ol><div style="text-align: justify;"><div><div style="text-align: justify;"><i>Figure 06</i>&nbsp;presents the first part of the "<i>__load_libraries</i>" function. In its preamble the code navigates through the&nbsp;<i>TEB</i>&nbsp;(<a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block" target="_blank"><i>Thread Environment Block</i></a>) and loads&nbsp;<i>4 bytes</i>&nbsp;from offset&nbsp;<i>0x30</i>&nbsp;into register&nbsp;<i>EAX</i>. This address contains the address of the <i>PEB</i> (<a href="https://en.wikipedia.org/wiki/Process_Environment_Block" target="_blank"><i>Process Environment Block</i></a>). Next step is to get the location for the "<i><a href="https://www.aldeid.com/wiki/PEB_LDR_DATA" target="_blank">PEB_LDR_DATA</a></i>" structure which is located in offset&nbsp;<i>0xC</i>. This structure contains a linked list containing information about all modules (<i>DLLs</i>) loaded by a specific process.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQTM3xH9up-gWWmc8kCmQbuUrJf99v1cmuPjRHryVBkWFm9tTrUbzyiQpcTGcD6mrK8P9sJZxo_aRGqNeodrUTMfZdTY3gJE1JjMVgD4AALLCh_MTt3RMY9sRaW9X1ClP1Jkfnrc9dM34/s1600/ida_function_part_001.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="1462" data-original-width="424" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQTM3xH9up-gWWmc8kCmQbuUrJf99v1cmuPjRHryVBkWFm9tTrUbzyiQpcTGcD6mrK8P9sJZxo_aRGqNeodrUTMfZdTY3gJE1JjMVgD4AALLCh_MTt3RMY9sRaW9X1ClP1Jkfnrc9dM34/s1600/ida_function_part_001.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 06 - first section of the "__load_libraries" function.</td></tr></tbody></table><div><div style="text-align: justify;">The code accesses the offset&nbsp;<i>0xC</i>&nbsp;in the "<i><a href="https://www.aldeid.com/wiki/PEB_LDR_DATA" target="_blank">PEB_LDR_DATA</a></i>" structure which contains the head element for the loaded modules in the order they were loaded by the process. Each element in this linked list is a combination of "<i><a href="https://www.aldeid.com/wiki/LDR_DATA_TABLE_ENTRY" target="_blank">_LDR_DATA_TABLE_ENTRY</a></i>" and "<a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-list_entry" target="_blank"><i>_LIST_ENTRY</i></a>" structures. This structure has an entry to the base name of the module in the offset <i>0x30</i>. Figure 07 summarises all this "structure maze" used in order to fetch loaded module names (e<i>xcusez-moi</i> for my paint brush skills :D).</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjlEylW4BMtXIPtQfuHzWFHWTzez71SU6g3aosfYT2baz0zH3Dvem0LiWz9_37rm4SlCJsHHg8R7_bT6InTIMEzbIyA0ZQsLIre_jBEX3Z3T8jOcGsyVx7mYIiGDZh6TjJxtgJQUsvvNSk/s1600/TEB_accessing.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="265" data-original-width="908" height="185" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjlEylW4BMtXIPtQfuHzWFHWTzez71SU6g3aosfYT2baz0zH3Dvem0LiWz9_37rm4SlCJsHHg8R7_bT6InTIMEzbIyA0ZQsLIre_jBEX3Z3T8jOcGsyVx7mYIiGDZh6TjJxtgJQUsvvNSk/s640/TEB_accessing.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 07 - Path through the process internal structures to get loaded DLL names and base addresses</td></tr></tbody></table><div><div style="text-align: justify;">The main loop, beginning at "<i>loc_2F189F</i>" (<i>Figure 06</i>), goes through all modules loaded by the "<i>explorer.exe"</i> process. This algorithm fetches the module name and calculates a hash out of it. The second smaller looping located at "<i>loc_2F18AB</i>" (<i>Figure 06</i>) is the part of the code responsible for calculating this hash. <i>Figure 08</i> shows the reversed code for this hashing algorithm.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjmF1LxVpgQr5O8-BuoZWibBHRZsg3l5RMWcVo39GsLNsO-NPCzviRTOqQuO4WJGFPI1l51Od5IRzLK-UdpHEBAgl-y7zbNbCOubSZL22c1EZgDydRJkxVAGgSxaw3yuQ71yLDIVbxCwk/s1600/Screenshot+2019-10-24+at+12.35.03.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="717" data-original-width="960" height="476" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjmF1LxVpgQr5O8-BuoZWibBHRZsg3l5RMWcVo39GsLNsO-NPCzviRTOqQuO4WJGFPI1l51Od5IRzLK-UdpHEBAgl-y7zbNbCOubSZL22c1EZgDydRJkxVAGgSxaw3yuQ71yLDIVbxCwk/s640/Screenshot+2019-10-24+at+12.35.03.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 08 - Reversed hashing algorithm used in the first part of the analysed code</td></tr></tbody></table><div><div style="text-align: justify;">Moving forward, after calculating a <i>hash</i> the algorithm does a XOR operation with a hardcoded value <i>0x25A56A90</i> and this value is compared with two hardcoded hashes: <i>0x4C5DACBC</i>&nbsp;(<b><i>kernel32.dll</i></b>)&nbsp;and <i>0x7FA40424 (<b>ntdll.dll</b>)</i>. The base addresses of each <i>DLL</i> are stored in two global variables located in the following addresses&nbsp;<i>[ESI+0x1036]</i> and <i>[ESI+0x103A]</i>.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><div><div style="text-align: justify;"><b>Bonus: these hardcoded hashes can be used for detecting this specific version of <i>Smokeloader</i>.&nbsp;</b></div></div><div><div style="text-align: justify;"><br /></div></div><div><div style="text-align: justify;">Summarising, this first part of the code is responsible by finding the base address of two core <i>libraries</i> in MS Windows ("<i>ntdll.dll</i>" and "<i>kernel32.dll</i>"). These addresses will be used for fetching resources necessary for loading all other libraries required by the malware.&nbsp;</div></div><div><div style="text-align: justify;"><br /><i>Figure 09</i> shows the second section of "<i>__load_libraries</i>". This figure shows the code with some functions names already figured out in order to make it more didactic.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhf7D2Dwa6zOdj7WAmme8kGsEomor0u1aPFFdag6O4NrznRju7gBZsXTQLfiOWtG_tRCOdb-T2dviLuDTGquQrafihxJ1GJu_8SbcwCSAhG31BjUq1pM8vF9-FBAG-abeOyvPZqKMeZyfM/s1600/Screenshot+2019-10-24+at+14.34.53.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="1171" data-original-width="406" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhf7D2Dwa6zOdj7WAmme8kGsEomor0u1aPFFdag6O4NrznRju7gBZsXTQLfiOWtG_tRCOdb-T2dviLuDTGquQrafihxJ1GJu_8SbcwCSAhG31BjUq1pM8vF9-FBAG-abeOyvPZqKMeZyfM/s1600/Screenshot+2019-10-24+at+14.34.53.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 09 - second section of the "__load_libraries" function.</td></tr></tbody></table><div><div style="text-align: justify;">The first two basic blocks checks if the function was able to find "<i>ntdll.dll</i>" and "<i>kernel32.dll</i>" base addresses. If these modules are available then the "<i>__load_procs_from_module</i>" function is invoked for filling the call table. This function receives <i>4</i> parameters and does not follow the standard C calling convention. Two parameters are passed&nbsp;through the stack and the other&nbsp;two through registers (<i>ECX</i> and <i>EDX</i>).&nbsp; This function expects a <i>DLL</i> base address in <i>EDX</i>, the data segment in <i>ECX</i>, an address to a list of <i>unsigned ints</i> (api calls hashes) and a destination address (where the calls addresses will be stored). The last two parameters are pushed in the stack.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><div><div style="text-align: justify;"><i>Figure 10</i> shows the <i>hardcoded</i> hashes passed as parameter to "<i>__load_procs_from_module</i>" function. This list will be used to determine which procedures will be loaded in the call table.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1fvZuqBs7-Avac1PI7tF0sVhTXtToB7FNmEoE1NKXFLVdNG6_cFf9W5bAp36j5kzli_-8TDxFfiJ71D8962nYmOocEsAdzqJVoZMTeAp282RngfTot2toBG_KA2r9q2cd_VQcJFsrRfo/s1600/Screenshot+2019-10-24+at+16.48.11.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="89" data-original-width="678" height="84" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1fvZuqBs7-Avac1PI7tF0sVhTXtToB7FNmEoE1NKXFLVdNG6_cFf9W5bAp36j5kzli_-8TDxFfiJ71D8962nYmOocEsAdzqJVoZMTeAp282RngfTot2toBG_KA2r9q2cd_VQcJFsrRfo/s640/Screenshot+2019-10-24+at+16.48.11.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 10 - Array of&nbsp;hashes of "ntdll.dll" function names</td></tr></tbody></table><div><div style="text-align: justify;">Next step is to take a look inside "<i>__load_procs_from_module</i>" function. <i>Figure 11</i> shows the code for this function. Parameters and functions were named to facilitate the understanding of this code.</div></div><div><div style="text-align: justify;"><br /></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPXeqzZFqZBi84lyAlNxS7ckRCzYSEhUU4Jz3EgK3GPO1wqMpSz_yhHn54qFB0r5wAGnRLBsas1Ar3MUpazSm7baF-IND9X_E1vfEEnFwlt9Mhdi1CW1-EJjl0WtkU-VgzIwW98_IV9Es/s1600/Screenshot+2019-10-24+at+23.36.38.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="1600" data-original-width="632" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhPXeqzZFqZBi84lyAlNxS7ckRCzYSEhUU4Jz3EgK3GPO1wqMpSz_yhHn54qFB0r5wAGnRLBsas1Ar3MUpazSm7baF-IND9X_E1vfEEnFwlt9Mhdi1CW1-EJjl0WtkU-VgzIwW98_IV9Es/s1600/Screenshot+2019-10-24+at+23.36.38.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 11 - Code for "<i>__load_procs_from_modules</i>" function</td></tr></tbody></table><div><div style="text-align: justify;">This function iterates over a list of <i>4 bytes</i> hashes received as parameter. Each element is <i>XORed</i> with a hardcoded value (<i>0x25A56A90)</i>&nbsp;and passed to the function "<i>__get_proc_address</i>"&nbsp;together with a base address of a library.&nbsp; This function iterates over all procedures names exported by a <i>DLL</i>, calculates a hash and compares it with the hash received as parameter. If it finds a match, "<i>__get_proc_address</i>" returns an address for the specific function.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Lets take a closer look inside "<i>__get_proc_address</i>" to figure out how it navigates through the loaded <i>DLL</i>. <i>Figure 12</i> shows a snip of the code for this function.</div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEilmRT8NsWHy3rq2sOo9I2W3m_bJ5IaJu2S0kGEWITascmo7sVb0B0GYaGXaIGu4Lb58acBdZswWJLXL7F82R1m0ka064nqJn8sE1w6ptY61nEOH-Ge0VVhHnFdBYfYuXCe-1UEJlbqNoA/s1600/Screenshot+2019-10-27+at+20.56.17.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="1142" data-original-width="583" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEilmRT8NsWHy3rq2sOo9I2W3m_bJ5IaJu2S0kGEWITascmo7sVb0B0GYaGXaIGu4Lb58acBdZswWJLXL7F82R1m0ka064nqJn8sE1w6ptY61nEOH-Ge0VVhHnFdBYfYuXCe-1UEJlbqNoA/s1600/Screenshot+2019-10-27+at+20.56.17.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 12 - Code for "<i>__get_proc_address</i>" function.</td></tr></tbody></table><div style="text-align: justify;">The preamble of the function fetches the address for the <i>PE</i> header by accessing offset <i>0x3C</i>&nbsp;in the DLL base address. Next step it fetches the relative virtual address (<i>RVA</i>) for the export directory at offset <i>0x78</i> of the <i>PE header</i>. From the Export Directory structure this function fetches the following fields: <i>NumberOfNames</i> (offset <i>0x18</i>), <i>AddressOfNames</i> (offset <i>0x20</i>) and <i>AddressOfNameOrdinals</i> (offset <i>0x24</i>). References for all these structures can be found in the <a href="https://github.com/corkami/pics/blob/master/binary/pe102/pe102.pdf" target="_blank">Corkami Windows Executable format overview</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">After loading information about the exports the code will iterates through the list of function names and calculates a <i>4 bytes</i> hash by calling the "<i>__hashing</i>" function (same algorithm described in <i>Figure 08</i>). If the output of the "<i>__hashing</i>" function matches the hardcoded hash then the ordinal for that function is saved and the address related to that ordinal is returned.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><i>Figure 13</i> shows a code in Python that reproduces the above mentioned comparison algorithm using hardcoded hashes extracted from memory (<i>Figure 10</i>) and <a href="https://www.geoffchappell.com/studies/windows/win32/ntdll/api/index.htm?tx=7" target="_blank">all function names exported by ntdll.dll</a>.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiiZSA9N9g-6uU9X6kiS_0rvEfWRzRy1QvNWab8-btH62Aanc43yd9sMMRtVz4h-Cd2thM8JCA-4hEb6eg3daDcl8fuDiu9pE2li_aYbRQh8NQ1kvgn5jkwEPgz58CnkOl2ywGmviMbz-g/s1600/Screenshot+2019-10-28+at+00.10.23.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="860" data-original-width="958" height="574" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiiZSA9N9g-6uU9X6kiS_0rvEfWRzRy1QvNWab8-btH62Aanc43yd9sMMRtVz4h-Cd2thM8JCA-4hEb6eg3daDcl8fuDiu9pE2li_aYbRQh8NQ1kvgn5jkwEPgz58CnkOl2ywGmviMbz-g/s640/Screenshot+2019-10-28+at+00.10.23.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 13 - Reversing outcome for code responsible by resolving "<i>ntdll.dll"</i> hardcoded hashes</td></tr></tbody></table><div style="text-align: justify;">This code produces the following output:</div><div style="text-align: justify;"><br /></div><div class="separator" style="clear: both; text-align: justify;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgn1ySHjaBiDERiX6EqQeEMyOLSRqONkNXE3AwgZ_RUH4d3Gjk3RgRrsnhgyFTxkmvWLMfWeStZX9zsevS6CSa8QCtrRJyU4UyDnx8XLF366xxa-xTSzavp8r-Xg_vC5Nso_gI20cWr-aQ/s1600/Screenshot+2019-10-28+at+00.13.04.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="433" data-original-width="533" height="323" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgn1ySHjaBiDERiX6EqQeEMyOLSRqONkNXE3AwgZ_RUH4d3Gjk3RgRrsnhgyFTxkmvWLMfWeStZX9zsevS6CSa8QCtrRJyU4UyDnx8XLF366xxa-xTSzavp8r-Xg_vC5Nso_gI20cWr-aQ/s400/Screenshot+2019-10-28+at+00.13.04.png" width="400" /></a></div><div style="text-align: justify;"><br />Finally, these addresses are used for filling the call table which will be referenced by indirect calls in the main payload. It is possible to confirm that what was described so far is true by observing the function addresses written in the data segment after executing the second section of "<i>__load_libraries</i>". <i>Figure 14</i> shows the part of the call table filled so far with the expected "<i>ntdll.dll"</i> calls.</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhcEZ4Bp5dU2hfpSe_wTKkqGrLhGo2s6XbV3D1me8sbe-FEiNpcGAo4va061lXpbx41KuN1rfzNpmI-4Q9TqMlqvxajU9rb5FsmV7cVGusWtKWHuzOw0_dgYr4Ne7KYGxRb5tOSPJ9qDU/s1600/Screenshot+2019-10-28+at+00.31.21.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="350" data-original-width="570" height="245" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhcEZ4Bp5dU2hfpSe_wTKkqGrLhGo2s6XbV3D1me8sbe-FEiNpcGAo4va061lXpbx41KuN1rfzNpmI-4Q9TqMlqvxajU9rb5FsmV7cVGusWtKWHuzOw0_dgYr4Ne7KYGxRb5tOSPJ9qDU/s400/Screenshot+2019-10-28+at+00.31.21.png" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 14 - Segment of Smokeloader's dynamically generated call table</td></tr></tbody></table><div style="text-align: justify;">The last segment of the "<i>__load_libraries</i>" function de-obfuscates the remain libraries names and load them by using the same resources used for loading "<i>ntdll"</i> and "<i>kernel32</i>". The libraries loaded by <i>Smokeloader</i> are: "<i>user32</i>", "<i>advapi32</i>", "<i>urlmon</i>", "<i>ole32</i>", "<i>winhttp</i>", "<i>ws2_32</i>", "<i>dnsapi</i>" and "<i>shell32</i>".</div></div><div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Now that the whole process of creating the <i>call table</i>&nbsp;used by the indirect calls is described, next step will get into fixing the memory containing the&nbsp;main payload by using&nbsp;<i>IDA Python</i>.</div></div><div style="text-align: center;"><br /><span style="font-size: large;"><b style="text-align: justify;"><b><span style="color: white;">---<i> End of part II</i> ---</span></b></b><b></b></span><br /><b><span style="font-size: large;"></span></b></div><div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">When the main payload of <i>Smokeloader</i> is imported into <i>IDApro</i> it is possible to see code containing indirect calls which uses a base address stored in a register plus an offset. <i>Figure 15</i> presents a snip of the main payload containing such indirect calls.</div><div style="text-align: justify;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqyVa2wLQah2H3-YNc_QR6C5x5vTszSALlu2NxpX8ClFehALwPWTh9l7ytVkMlVPHvRfaO4tA4AnLJZNqef1yJ7EDnUHTIemqKf04UzKQSEyuPwluGSrCgdgHjx26N4xUBRXGGyqBz0Vc/s1600/Screenshot+2019-10-29+at+13.19.48.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="477" data-original-width="548" height="554" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqyVa2wLQah2H3-YNc_QR6C5x5vTszSALlu2NxpX8ClFehALwPWTh9l7ytVkMlVPHvRfaO4tA4AnLJZNqef1yJ7EDnUHTIemqKf04UzKQSEyuPwluGSrCgdgHjx26N4xUBRXGGyqBz0Vc/s640/Screenshot+2019-10-29+at+13.19.48.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 15 - Indirect calls calling functions pointed at the dynamic generated calls table.</td></tr></tbody></table><div style="text-align: justify;">This characteristic makes the processing of reversing this code harder since the interaction with other resources in the Operating System is not clear as all external calls is not explicit. The goal in this part of the article is to patch these calls for pointing to addresses we going to map and label (using <i>IDA Python</i>).&nbsp; The code below implements the change we want.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><style type="text/css">  .gist {height:500px !important;}   .gist-file   .gist-data {max-height: 500px} </style> <script src="https://gist.github.com/mabj/677a67676bae03113d6695351b3b7052.js"></script><br /><div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div></div><div><div style="text-align: justify;">This code performs the following actions&nbsp;into our <i>IDB</i>:</div><ol style="text-align: left;"><li style="text-align: justify;">Reads a memory dump of the data segment of an executing <i>Smokeloader</i> binary (line <i>106</i>);</li><li style="text-align: justify;">Creates a <i>DATA</i> segment mapped into <i>0x00000000</i> (line <i>107</i>).</li><li style="text-align: justify;">Loads the dumped data segment from the running sample into this new segment (line <i>35</i>);</li><li style="text-align: justify;">Imports API names extracted from <i>x32dbg</i> to specific positions in the new data segment (line <i>112</i>);&nbsp;</li><li style="text-align: justify;">Patches all indirect call instructions (opcode&nbsp;<i>55 9X</i>) to direct call instructions&nbsp;(line <i>51</i>).</li></ol><div><div style="text-align: justify;"><i>Figure 16</i>&nbsp;shows the code listed after executing the script above. As we can see, all indirect calls were translated to direct calls to a labeled table located in the freshly created data segment starting at address&nbsp;<i>0x00000000</i>.<br /><br /></div></div></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: justify;"><tbody><tr><td style="text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgySjj1SntkDgTeNR2s37JT3xfgRwDSOYrX2jNBmwoRiQz5Cb0qB9bhvnORTD0ycpkPtpVYYY-uJAbkDGDQcSlwmiKiPhuD6ixwyE7c2tbs1oPjwTj_P29eP_BvlQD8ZpfR71o4Ktxm0-o/s1600/Screenshot+2019-10-29+at+13.25.30.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" data-original-height="466" data-original-width="528" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgySjj1SntkDgTeNR2s37JT3xfgRwDSOYrX2jNBmwoRiQz5Cb0qB9bhvnORTD0ycpkPtpVYYY-uJAbkDGDQcSlwmiKiPhuD6ixwyE7c2tbs1oPjwTj_P29eP_BvlQD8ZpfR71o4Ktxm0-o/s1600/Screenshot+2019-10-29+at+13.25.30.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Figure 16 - Patched code with calls containing meaningful labels.</td></tr></tbody></table><div><div style="text-align: justify;">Just heads up for preventing people against messing up research IDBs: for obvious reasons (different instruction sets) the script above <b>can not</b> be used for patching <i>64 bits</i> <i>Smokeloader</i>&nbsp;IDBs but it could be easily adapted to do the same task.&nbsp;</div></div><div><div style="text-align: justify;"><br /></div></div><div style="text-align: center;"><div style="text-align: justify;"><div style="text-align: center;"><b><span style="color: white; font-size: large;">---<i> End of part III</i> ---</span></b></div></div></div><div><div style="text-align: justify;"><br /></div><div style="text-align: center;"><div style="text-align: justify;">That's all folks!&nbsp;</div></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The ideas described in this article can be extended and used to analyse any other malware families dynamically importing libraries and using indirect calls. Another thing cool for experimenting in future would be write a script which loads <i>DLLs</i> and extracts labels statically by using the reversed "<i>__hashing</i>" function and native functionalities in <i>IDA</i> for <a href="https://github.com/nihilus/IDA-IDC-Scripts/blob/master/PE-scripts/pe_dlls.idc" target="_blank">mapping DLLs</a> in the process address space.&nbsp;</div><div style="text-align: justify;"><br /></div></div><div></div></div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html' itemprop='url'/>
<a class='timestamp-link' href='https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2019-10-31T16:43:00-07:00'>October 31, 2019</abbr></a>
</span>
<span class='post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-363379351'>
<a href='https://www.blogger.com/post-edit.g?blogID=2832371727794363441&postID=4795907936393926768&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=2832371727794363441&postID=4795907936393926768&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=2832371727794363441&postID=4795907936393926768&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=2832371727794363441&postID=4795907936393926768&target=twitter' target='_blank' title='Share to X'><span class='share-button-link-text'>Share to X</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=2832371727794363441&postID=4795907936393926768&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=2832371727794363441&postID=4795907936393926768&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
Labels:
<a href='https://m.alvar.es/search/label/imports' rel='tag'>imports</a>,
<a href='https://m.alvar.es/search/label/malware' rel='tag'>malware</a>,
<a href='https://m.alvar.es/search/label/Research' rel='tag'>Research</a>,
<a href='https://m.alvar.es/search/label/smokeloader' rel='tag'>smokeloader</a>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
<div class='comments' id='comments'>
<a name='comments'></a>
<h4>2 comments:</h4>
<div class='comments-content'>
<script async='async' src='' type='text/javascript'></script>
<script type='text/javascript'>
    (function() {
      var items = null;
      var msgs = null;
      var config = {};

// <![CDATA[
      var cursor = null;
      if (items && items.length > 0) {
        cursor = parseInt(items[items.length - 1].timestamp) + 1;
      }

      var bodyFromEntry = function(entry) {
        var text = (entry &&
                    ((entry.content && entry.content.$t) ||
                     (entry.summary && entry.summary.$t))) ||
            '';
        if (entry && entry.gd$extendedProperty) {
          for (var k in entry.gd$extendedProperty) {
            if (entry.gd$extendedProperty[k].name == 'blogger.contentRemoved') {
              return '<span class="deleted-comment">' + text + '</span>';
            }
          }
        }
        return text;
      }

      var parse = function(data) {
        cursor = null;
        var comments = [];
        if (data && data.feed && data.feed.entry) {
          for (var i = 0, entry; entry = data.feed.entry[i]; i++) {
            var comment = {};
            // comment ID, parsed out of the original id format
            var id = /blog-(\d+).post-(\d+)/.exec(entry.id.$t);
            comment.id = id ? id[2] : null;
            comment.body = bodyFromEntry(entry);
            comment.timestamp = Date.parse(entry.published.$t) + '';
            if (entry.author && entry.author.constructor === Array) {
              var auth = entry.author[0];
              if (auth) {
                comment.author = {
                  name: (auth.name ? auth.name.$t : undefined),
                  profileUrl: (auth.uri ? auth.uri.$t : undefined),
                  avatarUrl: (auth.gd$image ? auth.gd$image.src : undefined)
                };
              }
            }
            if (entry.link) {
              if (entry.link[2]) {
                comment.link = comment.permalink = entry.link[2].href;
              }
              if (entry.link[3]) {
                var pid = /.*comments\/default\/(\d+)\?.*/.exec(entry.link[3].href);
                if (pid && pid[1]) {
                  comment.parentId = pid[1];
                }
              }
            }
            comment.deleteclass = 'item-control blog-admin';
            if (entry.gd$extendedProperty) {
              for (var k in entry.gd$extendedProperty) {
                if (entry.gd$extendedProperty[k].name == 'blogger.itemClass') {
                  comment.deleteclass += ' ' + entry.gd$extendedProperty[k].value;
                } else if (entry.gd$extendedProperty[k].name == 'blogger.displayTime') {
                  comment.displayTime = entry.gd$extendedProperty[k].value;
                }
              }
            }
            comments.push(comment);
          }
        }
        return comments;
      };

      var paginator = function(callback) {
        if (hasMore()) {
          var url = config.feed + '?alt=json&v=2&orderby=published&reverse=false&max-results=50';
          if (cursor) {
            url += '&published-min=' + new Date(cursor).toISOString();
          }
          window.bloggercomments = function(data) {
            var parsed = parse(data);
            cursor = parsed.length < 50 ? null
                : parseInt(parsed[parsed.length - 1].timestamp) + 1
            callback(parsed);
            window.bloggercomments = null;
          }
          url += '&callback=bloggercomments';
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = url;
          document.getElementsByTagName('head')[0].appendChild(script);
        }
      };
      var hasMore = function() {
        return !!cursor;
      };
      var getMeta = function(key, comment) {
        if ('iswriter' == key) {
          var matches = !!comment.author
              && comment.author.name == config.authorName
              && comment.author.profileUrl == config.authorUrl;
          return matches ? 'true' : '';
        } else if ('deletelink' == key) {
          return config.baseUri + '/delete-comment.g?blogID='
               + config.blogId + '&postID=' + comment.id;
        } else if ('deleteclass' == key) {
          return comment.deleteclass;
        }
        return '';
      };

      var replybox = null;
      var replyUrlParts = null;
      var replyParent = undefined;

      var onReply = function(commentId, domId) {
        if (replybox == null) {
          // lazily cache replybox, and adjust to suit this style:
          replybox = document.getElementById('comment-editor');
          if (replybox != null) {
            replybox.height = '250px';
            replybox.style.display = 'block';
            replyUrlParts = replybox.src.split('#');
          }
        }
        if (replybox && (commentId !== replyParent)) {
          replybox.src = '';
          document.getElementById(domId).insertBefore(replybox, null);
          replybox.src = replyUrlParts[0]
              + (commentId ? '&parentID=' + commentId : '')
              + '#' + replyUrlParts[1];
          replyParent = commentId;
        }
      };

      var hash = (window.location.hash || '#').substring(1);
      var startThread, targetComment;
      if (/^comment-form_/.test(hash)) {
        startThread = hash.substring('comment-form_'.length);
      } else if (/^c[0-9]+$/.test(hash)) {
        targetComment = hash.substring(1);
      }

      // Configure commenting API:
      var configJso = {
        'maxDepth': config.maxThreadDepth
      };
      var provider = {
        'id': config.postId,
        'data': items,
        'loadNext': paginator,
        'hasMore': hasMore,
        'getMeta': getMeta,
        'onReply': onReply,
        'rendered': true,
        'initComment': targetComment,
        'initReplyThread': startThread,
        'config': configJso,
        'messages': msgs
      };

      var render = function() {
        if (window.goog && window.goog.comments) {
          var holder = document.getElementById('comment-holder');
          window.goog.comments.render(holder, provider);
        }
      };

      // render now, or queue to render when library loads:
      if (window.goog && window.goog.comments) {
        render();
      } else {
        window.goog = window.goog || {};
        window.goog.comments = window.goog.comments || {};
        window.goog.comments.loadQueue = window.goog.comments.loadQueue || [];
        window.goog.comments.loadQueue.push(render);
      }
    })();
// ]]>
  </script>
<div id='comment-holder'>
<div class="comment-thread toplevel-thread"><ol id="top-ra"><li class="comment" id="c7927118041050016729"><div class="avatar-image-container"><img src="//resources.blogblog.com/img/blank.gif" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user">Anonymous</cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html?showComment=1643081955317#c7927118041050016729">24 January 2022 at 19:39</a></span></div><p class="comment-content">Betway Review (2021) - Vntopbet.com<br>Betway is the best bookmaker <a href="https://thakasino.com/bet365/" rel="nofollow">bet365</a> for punters. The Betway platform provides punters <a href="https://stillcasino.com/gioco-digitale/" rel="nofollow">gioco digitale</a> the chance to bet on sports events, politics, and <a href="https://vntopbet.com/bk8/" rel="nofollow">bk8</a> much more.</p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="7927118041050016729">Reply</a><span class="item-control blog-admin blog-admin pid-16725144"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=2832371727794363441&amp;postID=7927118041050016729">Delete</a></span></span></div><div class="comment-replies"><div id="c7927118041050016729-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c7927118041050016729-ra" class="thread-chrome thread-expanded"><div></div><div id="c7927118041050016729-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="7927118041050016729">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c7927118041050016729-ce"></div></li><li class="comment" id="c4563555083042234068"><div class="avatar-image-container"><img src="//www.blogger.com/img/blogger_logo_round_35.png" alt=""/></div><div class="comment-block"><div class="comment-header"><cite class="user"><a href="https://www.blogger.com/profile/14914095687366207483" rel="nofollow">haglyzachry</a></cite><span class="icon user "></span><span class="datetime secondary-text"><a rel="nofollow" href="https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html?showComment=1646322905042#c4563555083042234068">3 March 2022 at 07:55</a></span></div><p class="comment-content">Wynn resort in Las Vegas to reopen after COVID-19 shutdown<br>Wynn <a href="https://drmcd.com/%ea%b3%a0%ec%96%91%ec%a3%bc%eb%b3%80-%ea%b0%80%ea%b9%8c%ec%9a%b4%ec%b6%9c%ec%9e%a5%eb%a7%88%ec%82%ac%ec%a7%80.html/" rel="nofollow">고양 출장마사지</a> Las Vegas <a href="https://drmcd.com/%ec%97%ac%ec%a3%bc%ec%b5%9c%ec%83%81%ec%9d%98-%ea%b4%80%eb%a6%ac%ec%b6%9c%ec%9e%a5%ec%95%88%eb%a7%88.html/" rel="nofollow">여주 출장샵</a> in Las Vegas will reopen its doors on Wednesday, <a href="https://drmcd.com/%ec%86%8d%ec%b4%88%ec%b6%9c%ec%9e%a5%eb%a7%88%ec%82%ac%ec%a7%80%ec%9d%b8%ea%b8%b0-%ec%88%9c%ec%9c%84.html/" rel="nofollow">속초 출장마사지</a> March 20. The reopening of <a href="https://drmcd.com/%ea%b5%ac%eb%a6%ac%ec%b5%9c%ea%b3%a0%ec%8b%9c%ec%84%a4%ec%b6%9c%ec%9e%a5%eb%a7%88%ec%82%ac%ec%a7%80.html/" rel="nofollow">구리 출장샵</a> its flagship property Wynn Las Vegas <a href="https://www.jtmhub.com/%eb%ac%b8%ea%b2%bd%ec%b6%9c%ec%9e%a5%ec%83%b5.html/" rel="nofollow">문경 출장안마</a></p><span class="comment-actions secondary-text"><a class="comment-reply" target="_self" data-comment-id="4563555083042234068">Reply</a><span class="item-control blog-admin blog-admin pid-685321459"><a target="_self" href="https://www.blogger.com/delete-comment.g?blogID=2832371727794363441&amp;postID=4563555083042234068">Delete</a></span></span></div><div class="comment-replies"><div id="c4563555083042234068-rt" class="comment-thread inline-thread hidden"><span class="thread-toggle thread-expanded"><span class="thread-arrow"></span><span class="thread-count"><a target="_self">Replies</a></span></span><ol id="c4563555083042234068-ra" class="thread-chrome thread-expanded"><div></div><div id="c4563555083042234068-continue" class="continue"><a class="comment-reply" target="_self" data-comment-id="4563555083042234068">Reply</a></div></ol></div></div><div class="comment-replybox-single" id="c4563555083042234068-ce"></div></li></ol><div id="top-continue" class="continue"><a class="comment-reply" target="_self">Add comment</a></div><div class="comment-replybox-thread" id="top-ce"></div><div class="loadmore hidden" data-post-id="4795907936393926768"><a target="_self">Load more...</a></div></div>
</div>
</div>
<p class='comment-footer'>
<div class='comment-form'>
<a name='comment-form'></a>
<p>
</p>
<a href='https://www.blogger.com/comment/frame/2832371727794363441?po=4795907936393926768&hl=en-GB' id='comment-editor-src'></a>
<iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410px' id='comment-editor' name='comment-editor' src='' width='100%'></iframe>
<script src='https://www.blogger.com/static/v1/jsbin/2315299244-comment_from_post_iframe.js' type='text/javascript'></script>
<script type='text/javascript'>
      BLOG_CMT_createIframe('https://www.blogger.com/rpc_relay.html');
    </script>
</div>
</p>
<div id='backlinks-container'>
<div id='Blog1_backlinks-container'>
</div>
</div>
</div>
</div>
<div class='inline-ad'>
<!--Can't find substitution for tag [adCode]-->
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-newer-link'>
<a class='blog-pager-newer-link' href='https://m.alvar.es/2019/12/inline-loop-detection-for-compressing.html' id='Blog1_blog-pager-newer-link' title='Newer Post'>Newer Post</a>
</span>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='https://m.alvar.es/2019/08/smokeloader-hardcoded-domains-sneaky.html' id='Blog1_blog-pager-older-link' title='Older Post'>Older Post</a>
</span>
<a class='home-link' href='https://m.alvar.es/'>Home</a>
</div>
<div class='clear'></div>
<div class='post-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='https://m.alvar.es/feeds/4795907936393926768/comments/default' target='_blank' type='application/atom+xml'>Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
</div>
<div class='column-left-outer'>
<div class='column-left-inner'>
<aside>
</aside>
</div>
</div>
<div class='column-right-outer'>
<div class='column-right-inner'>
<aside>
<div class='sidebar section' id='sidebar-right-1'><div class='widget BlogArchive' data-version='1' id='BlogArchive2'>
<h2>Blog Archive</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive2_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2020/'>
2020
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2020/06/'>
June
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2019/'>
2019
</a>
<span class='post-count' dir='ltr'>(3)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2019/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2019/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
<ul class='posts'>
<li><a href='https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html'>Dynamic Imports and Working Around Indirect Calls ...</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2019/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2015/'>
2015
</a>
<span class='post-count' dir='ltr'>(5)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2015/11/'>
November
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2015/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='https://m.alvar.es/2015/09/'>
September
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
</div>
</div></div>
</aside>
</div>
</div>
</div>
<div style='clear: both'></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class='main-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<footer>
<div class='footer-outer'>
<div class='footer-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left footer-fauxborder-left'>
<div class='fauxborder-right footer-fauxborder-right'></div>
<div class='region-inner footer-inner'>
<div class='foot no-items section' id='footer-1'></div>
<!-- outside of the include in order to lock Attribution widget -->
<div class='foot section' id='footer-3' name='Footer'><div class='widget Attribution' data-version='1' id='Attribution1'>
<div class='widget-content' style='text-align: center;'>
Simple theme. Powered by <a href='https://www.blogger.com' target='_blank'>Blogger</a>.
</div>
<div class='clear'></div>
</div></div>
</div>
</div>
<div class='footer-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class='content-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<script type='text/javascript'>
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>
<!--Voc\xea \xe9 respons\xe1vel por notificar os visitantes sobre os cookies usados e os dados coletados no seu blog. O Blogger disponibiliza uma notifica\xe7\xe3o padr\xe3o para usar no blog que voc\xea pode personalizar ou substituir pela sua pr\xf3pria notifica\xe7\xe3o. Veja mais detalhes em http://www.blogger.com/go/cookiechoices.-->
<script defer='' src='/js/cookienotice.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function(event) {
      window.cookieChoices && cookieChoices.showCookieConsentBar && cookieChoices.showCookieConsentBar(
          (window.cookieOptions && cookieOptions.msg) || 'Este site usa os cookies do Google para fornecer servi\xe7os e analisar o tr\xe1fego. Seu endere\xe7o IP e user agent s\xe3o compartilhados com o Google, al\xe9m das m\xe9tricas de seguran\xe7a e desempenho, para garantir a qualidade de servi\xe7o, gerar estat\xedsticas de uso e detectar e eliminar abusos.',
          (window.cookieOptions && cookieOptions.close) || 'Entendi',
          (window.cookieOptions && cookieOptions.learn) || 'Saiba mais',
          (window.cookieOptions && cookieOptions.link) || 'https://www.blogger.com/go/blogspot-cookies');
    });
  </script>

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/3704019819-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY5yV6fFJ6VgZLjo0Q9-SB2pRC9MUg:1734511473118';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d2832371727794363441','//m.alvar.es/2019/10/dynamic-imports-and-working-around.html','2832371727794363441');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '2832371727794363441', 'title': '\x3ca href\x3d\x22http://m.alvar.es/\x22\x3e# Malware Research Notes\x3c/a\x3e', 'url': 'https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html', 'canonicalUrl': 'https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html', 'homepageUrl': 'https://m.alvar.es/', 'searchUrl': 'https://m.alvar.es/search', 'canonicalHomepageUrl': 'https://m.alvar.es/', 'blogspotFaviconUrl': 'https://m.alvar.es/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': true, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en-GB', 'localeUnderscoreDelimited': 'en_gb', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22# Malware Research Notes - Atom\x22 href\x3d\x22https://m.alvar.es/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22# Malware Research Notes - RSS\x22 href\x3d\x22https://m.alvar.es/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22# Malware Research Notes - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/2832371727794363441/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22# Malware Research Notes - Atom\x22 href\x3d\x22https://m.alvar.es/feeds/4795907936393926768/comments/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'boqCommentIframeForm': true, 'loginRedirectParam': '', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/2dbf2ee4cef330c7', 'plusOneApiSrc': 'https://apis.google.com/js/platform.js', 'disableGComments': true, 'interstitialAccepted': false, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'X', 'key': 'twitter', 'shareMessage': 'Share to X', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en_GB\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'item', 'postId': '4795907936393926768', 'postImageThumbnailUrl': 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s72-c/Screenshot+2019-10-23+at+16.20.24.png', 'postImageUrl': 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s640/Screenshot+2019-10-23+at+16.20.24.png', 'pageName': 'Dynamic Imports and Working Around Indirect Calls - Smokeloader Study Case', 'pageTitle': '# Malware Research Notes: Dynamic Imports and Working Around Indirect Calls - Smokeloader Study Case'}}, {'name': 'features', 'data': {}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard', 'ok': 'Ok', 'postLink': 'Post link'}}, {'name': 'template', 'data': {'name': 'Simple', 'localizedName': 'Simple', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': false, 'variant': 'dark', 'variantId': 'dark'}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'Dynamic Imports and Working Around Indirect Calls - Smokeloader Study Case', 'description': 'When reversing malware it is common to find an injected payload loading references to external resources (DLL functions). This happens for t...', 'featuredImage': 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj20CZ-YWqz3RxxiCmVkOb_V0yZdsZHWr38TF8ysPiZMU1sgY9YdTRRl9oqDa4Y5duZjgYSGCyXEME60NvqERT7YCJgI_1gQYK4lO8OUjPaW8_hCEVFKiTtJbvpf0qbpVTgUhfSJVIB4r8/s640/Screenshot+2019-10-23+at+16.20.24.png', 'url': 'https://m.alvar.es/2019/10/dynamic-imports-and-working-around.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 4795907936393926768}}]);
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/126001200-lbx__en_gb.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/1964470060-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive2', 'sidebar-right-1', document.getElementById('BlogArchive2'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>
</body>
</html>