<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Bludit">

<!-- Dynamic title tag -->
<title>DarkRat - Hacking a malware control panel | fr3d.hk</title>

<!-- Dynamic description tag -->
<meta name="description" content="How I hacked a malware control panel and chained web vulnerabilities to do it.">

<!-- Include Favicon -->
<link rel="icon" href="https://fr3d.hk/blog/bl-themes/blogx/img/favicon.png" type="image/png">

<!-- Include Bootstrap CSS file bootstrap.css -->
<link rel="stylesheet" type="text/css" href="https://fr3d.hk/blog/bl-kernel/css/bootstrap.min.css?version=3.12.0">

<!-- Include CSS Styles from this theme -->
<link rel="stylesheet" type="text/css" href="https://fr3d.hk/blog/bl-themes/blogx/css/style.css?version=3.12.0">

<!-- Load Bludit Plugins: Site head -->
<link rel="canonical" href="https://fr3d.hk/blog/darkrat-hacking-a-malware-control-panel"/>

<!-- Open Graph -->
<meta property="og:locale" content="en, en_US, en_AU, en_CA, en_GB, en_IE, en_NZ">
<meta property="og:type" content="article">
<meta property="og:title" content="DarkRat - Hacking a malware control panel">
<meta property="og:description" content="How I hacked a malware control panel and chained web vulnerabilities to do it.">
<meta property="og:url" content="https://fr3d.hk/blog/darkrat-hacking-a-malware-control-panel">
<meta property="og:site_name" content="fr3d.hk">
<meta property="og:image" content="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/banner.png">

<!-- Robots plugin -->
<link rel="alternate" type="application/rss+xml" href="https://fr3d.hk/blog/rss.xml" title="RSS Feed">

<!-- Twitter Cards -->
<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="">
<meta property="twitter:title" content="DarkRat - Hacking a malware control panel">
<meta property="twitter:description" content="How I hacked a malware control panel and chained web vulnerabilities to do it.">
<meta property="twitter:image" content="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/banner.png">
<link href="/blog/bl-plugins/viewerjs/css/viewer.css" rel="stylesheet"></head>
<body>

	<!-- Load Bludit Plugins: Site Body Begin -->
	
	<!-- Navbar -->
	<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark text-uppercase">
	<div class="container">
		<a class="navbar-brand" href="https://fr3d.hk/blog/">
			<span class="text-white">fr3d.hk</span>
		</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarResponsive">
			<ul class="navbar-nav ml-auto">

				<!-- Static pages -->
				
				<!-- Social Networks -->
								<li class="nav-item">
					<a class="nav-link" href="https://twitter.com/fr3dhk" target="_blank">
						<img class="d-none d-sm-block nav-svg-icon" src="https://fr3d.hk/blog/bl-themes/blogx/img/twitter.svg" alt="Twitter" />
						<span class="d-inline d-sm-none">Twitter</span>
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<!-- Content -->
	<div class="container">
		<div class="row">

			<!-- Blog Posts -->
			<div class="col-md-9">
			<!-- Post -->
<div class="card my-5 border-0">

	<!-- Load Bludit Plugins: Page Begin -->
	<style>.seo-breadcrumbs {margin:0; padding:0.4rem 0;} .seo-breadcrumbs li {display:inline;padding:0.2rem 0 0.2rem 0.2rem ; font-size:14px; list-style:none; } .seo-breadcrumbs li a {} .seo-breadcrumbs li+li:before {padding: 0 4px 0 0; color: black; content: "\000BB";}</style><nav aria-label="breadcrumb"><ol itemscope itemtype="http://schema.org/BreadcrumbList" class="seo-breadcrumbs"><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">You are here: <a href="https://fr3d.hk/blog/" itemprop="item" ><span itemprop="name">fr3d.hk</span></a>
    <meta itemprop="position" content="1" /></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><a href="https://fr3d.hk/blog/category/malware">Malware</a><meta itemprop="position" content="2" /></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem"><span itemprop="name"><a href="https://fr3d.hk/blog/darkrat-hacking-a-malware-control-panel" itemprop="item">DarkRat - Hacking a malware control panel</a></span><meta itemprop="position" content="3" /></li></ol></nav>
	<!-- Cover image -->
	
	<div class="card-body p-0">
		<!-- Title -->
		<a class="text-dark" href="https://fr3d.hk/blog/darkrat-hacking-a-malware-control-panel">
			<h1 class="title">DarkRat - Hacking a malware control panel</h1>
		</a>

				<!-- Creation date -->
		<h6 class="card-subtitle mb-3 text-muted">December 23, 2019 - Reading time: 11 minutes</h6>
		
		<!-- Full content -->
		<p>In this post I will be showing you how I found vulnerabilities in the control panel of a new piece of malware and how I exploited these to be able to take it over. I will also be giving insight into chaining vulnerabilities.</p>
<p><!-- pagebreak --></p>
<div id="page_content">
<p>The malware we are talking about today is DarkRat. This nasty bit of code has recently popped up on the least underground hacking forum there is, HackForums. HackForums is a very accessible forum that shows just about anyone how to become a cybercriminal. It is full of very easy to use tools on all kinds of different subjects but today we will be concentrating on its malware &amp; marketplace sections. The developer of today's target is very active on this forum and you will find him posting in these two sections. The actor goes by the name "Dark Spider" and along with his main piece of malware (DarkRat) has created other pieces of malware including an exploit kit (CapeSand). Here is the banner of his profile on the site which I find quite ironic since he is a cyber criminal and someone that is aiding other cyber criminals.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/banner.png" alt=""></p>
<p>Here is a screenshot of his sales thread for DarkRat. </p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/thread.png" alt=""></p>
<p>The reason how I was able to get my hands on the source code of the control panel for this malware is that the developer was developing the bot and updating it on github publicly, after a friend of mine discovered it and shared it with me I was able to quickly clone the repository and back it up locally. Not long after this the developer discovered that the source code for all of his products had been discovered he proceeded to post this thread.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/announcement.png" alt=""></p>
<p>Obviously his products weren't for learning purposes but I'm happy he came to realize that what he was doing is wrong and has now stopped all sales. Onto the main topic of today!</p>
<p>If we look at the traffic that the malware sends to the control panel you will see a post parameter followed with what looks like gibberish to the untrained eye.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/traffic.png" alt=""></p>
<p>For those of you that have any experience with encoding you will notice that there is a trailing two equal signs after the gibberish, this is a sign of padding for base64. If we decode the gibberish with base64 we simply get more gibberish like so.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/decodedonce.png" alt=""></p>
<p>Hopefully you can notice from what I said in the previous paragraph that this is again base64. Decoding it again will give us what we are looking for.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/decodedtwice.png" alt=""></p>
<p>We can now see that the malware is sending an initial POST to the control panel, informing it of the specs and details of the computer it has just been run on. There are pieces of information that are base64 encoded within this already double decoded request but I won't concentrate on those as they are just names of what hardware and software the computer is using. So now that we know what the malware is sending to the control panel let's look at the panel itself.</p>
<p>This is what the DarkRat main panel looks like after setup.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/panel.png" alt=""></p>
<p>Tasks page</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/taskspanel.png" alt=""></p>
<p>Bots page</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/botspanel.png" alt=""></p>
<p>Settings page</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/55ec38fec50258b5f97b749d5a28bb8a/settingspanel.png" alt=""></p>
<p>So lets now take the POST request the malware sent to the panel and send it to my localhost and see what happens. I have recreated the post within a web security tool called burp. </p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/post.png" alt=""></p>
<p>And we get a successful update on the control panel.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/panelupdate.png" alt=""></p>
<p>So let's take a look at what is actually handling this request. Within the panel source code there is a file called bot handler, this handles the malware connecting to the control panel. This file checks if the bot (infected computer) is in the database and if not it then prepares to insert the computers details into the database. This is done using SQL statements in php but what the author forgets to do is to encode or remove special characters from what it inserts. This is exactly what we want as this will lead to XSS. XSS or cross site scripting is when you manage to inject html into a webpage through user submitted content. On the main page we see the names of the computers that have been infected. Here is what it looks like after I sent my request.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/computernames.png" alt=""></p>
<p>So what happens if we replace "USER-PC" with something like "&lt;script&gt;alert(1);&lt;/alert&gt;"? To quickly explain this I am inserting a script tag that will run the JavaScript between the tags, If you don't understand what I am talking about please read this: <a href="https://medium.com/@charithra/introduction-to-xss-e9eb90b4323d">Introduction to XSS</a> so now that you can see what I am doing let's actually put it into practice. </p>
<p>In the decoded request I replace "USER-PC" with "&lt;script&gt;alert(1);&lt;/alert&gt;" and then double base64 encode it and send it back to the panel. Refreshing the panel we get alerted by this.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/xssalert.png" alt=""></p>
<p>So now we can see that the XSS worked and this means that we can now insert whatever html/JavaScript we want into the main page for the malware operator to see. Obviously we don't actually want the malware operator to get any visual indication that we have hacked his control panel so after our payload we can insert a bit of text so that the original "USER-PC" still appears.</p>
<p>Now that we have XSS we need to chain it with something else so that we can take over the control panel. A useful web vulnerability we can use is CSRF or cross site request forgery. This is when you make the browser do something to emulate what a user would do. In this case we want the operator to add a new user to the control panel so that we can access it. To do this we need to send a POST request to the settings page that will then add the user to the panel. Here is the post that is sent when you try to add a new user to the control panel.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/userpost.png" alt=""></p>
<p>So now from this we can use a tool within burp to create a CSRF payload from this.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/csrfpoc.png" alt="" width="881" height="329"></p>
<p>What this is doing is automatically submitting a form to the settings panel that emulates what the control panel operator would be submitting if they were to add a new user to their panel. You can see on the right the values "guestuser" being set as the value for the user and password input fields. Now we want this form to automatically be submitted once viewed. The new html looks like this.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/finalpayload.png" alt=""></p>
<p>You can see the JavaScript at the end, this automatically submits the form upon visit. Due to the way the developer has configured the database I have only 100 characters that I can enter into the pc name column. This means that I cannot directly enter this piece of code into the site as it is well over the 100-character limit, so I have to display it differently. This can be done with an iframe. An iframe displays another webpage within a webpage which is perfect for our needs. We can use this iframe that has a style set so that it is invisible to the user. So if we save the html above as "payload.html" and host it at our domain of attacker.com then our new iframe payload will look like this.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/iframe.png" alt=""></p>
<p>So now that we have our final payload we can then append "USER-PC" to the end so that it displays something that the control panel operator expects to see for maximum stealth. We can now insert this into our payload, encode it twice and send it to the control panel. Once the operator views his control panel then he will be secretly adding a user to his control panel. I can then monitor requests to my domain &amp; host so that I know when this user has been added. Now that I have access I can remove all the infected computers by adding this command to the panel.</p>
<p><img src="https://fr3d.hk/blog/bl-content/uploads/pages/autosave-55ec38fec50258b5f97b749d5a28bb8a/uninstall.png" alt=""></p>
<p>And there we go! That brings this blog post to a close. I hope that you enjoyed the read and learnt something! Until next time, goodbye!</p>
</div>
	</div>

	<!-- Load Bludit Plugins: Page End -->
	
</div>
			</div>

			<!-- Right Sidebar -->
			<div class="col-md-3">
			<div class="plugin plugin-categories"><h2 class="plugin-label">Categories</h2><div class="plugin-content"><ul><li><a href="https://fr3d.hk/blog/category/general">General (2)</a></li><li><a href="https://fr3d.hk/blog/category/malware">Malware (9)</a></li><li><a href="https://fr3d.hk/blog/category/phishing">Phishing (1)</a></li></ul></div></div><div class="plugin plugin-pages"><h2 class="plugin-label">Links</h2><div class="plugin-content"><ul><li><a href="https://fr3d.hk/blog/rss.xml">RSS Feed</a></li></ul></div></div>			</div>

		</div>
	</div>

	<!-- Footer -->
	<footer class="footer bg-dark">
	<div class="container">
		<p class="m-0 text-center text-white text-uppercase">Copyright © 2021<span class="ml-5 text-warning">Powered by<img class="mini-logo" src="https://fr3d.hk/blog/bl-themes/blogx/img/favicon.png"/><a target="_blank" class="text-white" href="https://www.bludit.com">Bludit</a></span></p>
	</div>
</footer>
	<!-- Javascript -->
	<script src="https://fr3d.hk/blog/bl-kernel/js/jquery.min.js?version=3.12.0"></script>
<script src="https://fr3d.hk/blog/bl-kernel/js/bootstrap.bundle.min.js?version=3.12.0"></script>

	<!-- Load Bludit Plugins: Site Body End -->
	<script>var links = document.querySelectorAll( 'a' );  for (var i = 0, length = links.length; i < length; i++) {if (links[i].hostname != window.location.hostname) {links[i].target = '_blank';}}</script>

<script src="/blog/bl-plugins/viewerjs/js/viewer.js"></script>

</body>
</html>