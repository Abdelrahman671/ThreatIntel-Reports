<!doctype html>
<html lang="en">
<meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
	<style>img:is([sizes="auto" i], [sizes^="auto," i]) { contain-intrinsic-size: 3000px 1500px }</style>
	        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="profile" href="https://gmpg.org/xfn/11">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        
	<!-- This site is optimized with the Yoast SEO Premium plugin v24.5 (Yoast SEO v24.5) - https://yoast.com/wordpress/plugins/seo/ -->
	<title>The Hidden Bee infection chain, part 1: the stegano pack | Malwarebytes Labs</title>
	<meta name="description" content="Hidden Bee has a complex, multi-layered internal structure that is unusual among cybercrime toolkits. We look at its evolution over the last year." />
	<link rel="canonical" href="https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="The Hidden Bee infection chain, part 1: the stegano pack | Malwarebytes Labs" />
	<meta property="og:description" content="Hidden Bee has a complex, multi-layered internal structure that is unusual among cybercrime toolkits. We look at its evolution over the last year." />
	<meta property="og:url" content="https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack" />
	<meta property="og:site_name" content="Malwarebytes" />
	<meta property="article:publisher" content="https://www.facebook.com/Malwarebytes" />
	<meta property="article:published_time" content="2019-08-14T17:00:00+00:00" />
	<meta property="og:image" content="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg" />
	<meta name="author" content="hasherezade" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:title" content="The Hidden Bee infection chain, part 1: the stegano pack | Malwarebytes Labs" />
	<meta name="twitter:description" content="Hidden Bee has a complex, multi-layered internal structure that is unusual among cybercrime toolkits. We look at its evolution over the last year." />
	<meta name="twitter:image" content="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg" />
	<meta name="twitter:creator" content="@hasherezade" />
	<meta name="twitter:site" content="@malwarebytes" />
	<meta name="twitter:label1" content="Written by" />
	<meta name="twitter:data1" content="hasherezade" />
	<meta name="twitter:label2" content="Est. reading time" />
	<meta name="twitter:data2" content="17 minutes" />
	<script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#article","isPartOf":{"@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack"},"author":{"name":"hasherezade","@id":"https://www.malwarebytes.com/#/schema/person/a47a5d3fccd5d03449a4ff9fa55b7a12"},"headline":"The Hidden Bee infection chain, part 1: the stegano pack","datePublished":"2019-08-14T17:00:00+00:00","mainEntityOfPage":{"@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack"},"wordCount":3342,"commentCount":0,"publisher":{"@id":"https://www.malwarebytes.com/#organization"},"image":{"@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#primaryimage"},"thumbnailUrl":"https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg","keywords":["cryptominers","custom format","exploit kits","exploits","hasherezade","hidden bee","hiddenbee","infection chain","infection vector","malware modules","miner","miners","obfuscation","payloads","Steganography","Underminer","Underminer EK"],"articleSection":["News","Threats"],"inLanguage":"en","potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#respond"]}]},{"@type":"WebPage","@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack","url":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack","name":"The Hidden Bee infection chain, part 1: the stegano pack | Malwarebytes Labs","isPartOf":{"@id":"https://www.malwarebytes.com/#website"},"primaryImageOfPage":{"@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#primaryimage"},"image":{"@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#primaryimage"},"thumbnailUrl":"https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg","datePublished":"2019-08-14T17:00:00+00:00","description":"Hidden Bee has a complex, multi-layered internal structure that is unusual among cybercrime toolkits. We look at its evolution over the last year.","breadcrumb":{"@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#breadcrumb"},"inLanguage":"en","potentialAction":[{"@type":"ReadAction","target":["https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack"]}]},{"@type":"ImageObject","inLanguage":"en","@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#primaryimage","url":"https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg","contentUrl":"https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg","width":1000,"height":737,"caption":"The Hidden Bee infection chain, part 1: the stegano pack"},{"@type":"BreadcrumbList","@id":"https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https://www.malwarebytes.com/"},{"@type":"ListItem","position":2,"name":"The Hidden Bee infection chain, part 1: the stegano pack"}]},{"@type":"WebSite","@id":"https://www.malwarebytes.com/#website","url":"https://www.malwarebytes.com/","name":"Malwarebytes","description":"Cyber Security Software &amp; Anti-Malware","publisher":{"@id":"https://www.malwarebytes.com/#organization"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https://www.malwarebytes.com/?s={search_term_string}"},"query-input":{"@type":"PropertyValueSpecification","valueRequired":true,"valueName":"search_term_string"}}],"inLanguage":"en"},{"@type":"Organization","@id":"https://www.malwarebytes.com/#organization","name":"Malwarebytes","url":"https://www.malwarebytes.com/","logo":{"@type":"ImageObject","inLanguage":"en","@id":"https://www.malwarebytes.com/#/schema/logo/image/","url":"https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/11/Malwarebytes-logo.png","contentUrl":"https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/11/Malwarebytes-logo.png","width":1200,"height":675,"caption":"Malwarebytes"},"image":{"@id":"https://www.malwarebytes.com/#/schema/logo/image/"},"sameAs":["https://www.facebook.com/Malwarebytes","https://x.com/malwarebytes"]},{"@type":"Person","@id":"https://www.malwarebytes.com/#/schema/person/a47a5d3fccd5d03449a4ff9fa55b7a12","name":"hasherezade","image":{"@type":"ImageObject","inLanguage":"en","@id":"https://www.malwarebytes.com/#/schema/person/image/","url":"https://secure.gravatar.com/avatar/968ef5e76c149013991d9371fc5d37a5?s=96&d=mm&r=g","contentUrl":"https://secure.gravatar.com/avatar/968ef5e76c149013991d9371fc5d37a5?s=96&d=mm&r=g","caption":"hasherezade"},"description":"Unpacks malware with as much joy as a kid unpacking candies.","sameAs":["https://x.com/hasherezade"],"jobTitle":"Malware Intelligence Analyst","url":"https://www.malwarebytes.com/blog/authors/hasherezade"}]}</script>
	<meta name="googlebot" content="index, follow" />
	<!-- / Yoast SEO Premium plugin. -->


<link rel='dns-prefetch' href='//stats.wp.com' />
            <!-- Start VWO Async SmartCode -->
            <link rel="preconnect" href="https://dev.visualwebsiteoptimizer.com" />
            <script type='text/javascript' id='vwoCode'>
            window._vwo_code || (function() {
            var account_id=622914,
            version=2.1,
            settings_tolerance=5000,
            hide_element='body',
            hide_element_style = 'opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;transition:none !important;',
            /* DO NOT EDIT BELOW THIS LINE */
            f=false,w=window,d=document,v=d.querySelector('#vwoCode'),cK='_vwo_'+account_id+'_settings',cc={};try{var c=JSON.parse(localStorage.getItem('_vwo_'+account_id+'_config'));cc=c&&typeof c==='object'?c:{}}catch(e){}var stT=cc.stT==='session'?w.sessionStorage:w.localStorage;code={nonce:v&&v.nonce,use_existing_jquery:function(){return typeof use_existing_jquery!=='undefined'?use_existing_jquery:undefined},library_tolerance:function(){return typeof library_tolerance!=='undefined'?library_tolerance:undefined},settings_tolerance:function(){return cc.sT||settings_tolerance},hide_element_style:function(){return'{'+(cc.hES||hide_element_style)+'}'},hide_element:function(){if(performance.getEntriesByName('first-contentful-paint')[0]){return''}return typeof cc.hE==='string'?cc.hE:hide_element},getVersion:function(){return version},finish:function(e){if(!f){f=true;var t=d.getElementById('_vis_opt_path_hides');if(t)t.parentNode.removeChild(t);if(e)(new Image).src='https://dev.visualwebsiteoptimizer.com/ee.gif?a='+account_id+e}},finished:function(){return f},addScript:function(e){var t=d.createElement('script');t.type='text/javascript';if(e.src){t.src=e.src}else{t.text=e.text}v&&t.setAttribute('nonce',v.nonce);d.getElementsByTagName('head')[0].appendChild(t)},load:function(e,t){var n=this.getSettings(),i=d.createElement('script'),r=this;t=t||{};if(n){i.textContent=n;d.getElementsByTagName('head')[0].appendChild(i);if(!w.VWO||VWO.caE){stT.removeItem(cK);r.load(e)}}else{var o=new XMLHttpRequest;o.open('GET',e,true);o.withCredentials=!t.dSC;o.responseType=t.responseType||'text';o.onload=function(){if(t.onloadCb){return t.onloadCb(o,e)}if(o.status===200||o.status===304){_vwo_code.addScript({text:o.responseText})}else{_vwo_code.finish('&e=loading_failure:'+e)}};o.onerror=function(){if(t.onerrorCb){return t.onerrorCb(e)}_vwo_code.finish('&e=loading_failure:'+e)};o.send()}},getSettings:function(){try{var e=stT.getItem(cK);if(!e){return}e=JSON.parse(e);if(Date.now()>e.e){stT.removeItem(cK);return}return e.s}catch(e){return}},init:function(){if(d.URL.indexOf('__vwo_disable__')>-1)return;var e=this.settings_tolerance();w._vwo_settings_timer=setTimeout(function(){_vwo_code.finish();stT.removeItem(cK)},e);var t;if(this.hide_element()!=='body'){t=d.createElement('style');var n=this.hide_element(),i=n?n+this.hide_element_style():'',r=d.getElementsByTagName('head')[0];t.setAttribute('id','_vis_opt_path_hides');v&&t.setAttribute('nonce',v.nonce);t.setAttribute('type','text/css');if(t.styleSheet)t.styleSheet.cssText=i;else t.appendChild(d.createTextNode(i));r.appendChild(t)}else{t=d.getElementsByTagName('head')[0];var i=d.createElement('div');i.style.cssText='z-index: 2147483647 !important;position: fixed !important;left: 0 !important;top: 0 !important;width: 100% !important;height: 100% !important;background: white !important;';i.setAttribute('id','_vis_opt_path_hides');i.classList.add('_vis_hide_layer');t.parentNode.insertBefore(i,t.nextSibling)}var o=window._vis_opt_url||d.URL,s='https://dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(o)+'&vn='+version;if(w.location.search.indexOf('_vwo_xhr')!==-1){this.addScript({src:s})}else{this.load(s+'&x=true')}}};w._vwo_code=code;code.init();})();
            </script>
            <!-- End VWO Async SmartCode -->
            <link rel="pingback" href="https://www.malwarebytes.com/xmlrpc.php"><link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/RobotoSerif-Medium.a8a104b1.woff2" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/RobotoSerif-Medium.00ec4109.woff" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/RobotoSerif-light.725d86a1.woff2" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/RobotoSerif-light.bbcf9d54.woff" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/Roboto-Regular.b009a76a.woff2" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/Roboto-Regular.f1e2a767.woff" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/Roboto-Bold.227c9319.woff2" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/Roboto-Bold.77ecb942.woff" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/Roboto-Black.2e8becfc.woff2" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/fonts/Roboto-Black.f5677eb2.woff" as="font">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/images/shape-challenger-2.307bef30.png" as="image">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/images/ajax-loader.6f9ac78c.gif" as="image">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/images/app-play.5ed26b30.png" as="image">
<link rel="preload" href="/wp-content/themes/malwarebytes/assets/build/images/app-store.0d6e625d.png" as="image">
<style id='wp-block-library-inline-css'>
:root{--wp-admin-theme-color:#007cba;--wp-admin-theme-color--rgb:0,124,186;--wp-admin-theme-color-darker-10:#006ba1;--wp-admin-theme-color-darker-10--rgb:0,107,161;--wp-admin-theme-color-darker-20:#005a87;--wp-admin-theme-color-darker-20--rgb:0,90,135;--wp-admin-border-width-focus:2px;--wp-block-synced-color:#7a00df;--wp-block-synced-color--rgb:122,0,223;--wp-bound-block-color:var(--wp-block-synced-color)}@media (min-resolution:192dpi){:root{--wp-admin-border-width-focus:1.5px}}.wp-element-button{cursor:pointer}:root{--wp--preset--font-size--normal:16px;--wp--preset--font-size--huge:42px}:root .has-very-light-gray-background-color{background-color:#eee}:root .has-very-dark-gray-background-color{background-color:#313131}:root .has-very-light-gray-color{color:#eee}:root .has-very-dark-gray-color{color:#313131}:root .has-vivid-green-cyan-to-vivid-cyan-blue-gradient-background{background:linear-gradient(135deg,#00d084,#0693e3)}:root .has-purple-crush-gradient-background{background:linear-gradient(135deg,#34e2e4,#4721fb 50%,#ab1dfe)}:root .has-hazy-dawn-gradient-background{background:linear-gradient(135deg,#faaca8,#dad0ec)}:root .has-subdued-olive-gradient-background{background:linear-gradient(135deg,#fafae1,#67a671)}:root .has-atomic-cream-gradient-background{background:linear-gradient(135deg,#fdd79a,#004a59)}:root .has-nightshade-gradient-background{background:linear-gradient(135deg,#330968,#31cdcf)}:root .has-midnight-gradient-background{background:linear-gradient(135deg,#020381,#2874fc)}.has-regular-font-size{font-size:1em}.has-larger-font-size{font-size:2.625em}.has-normal-font-size{font-size:var(--wp--preset--font-size--normal)}.has-huge-font-size{font-size:var(--wp--preset--font-size--huge)}.has-text-align-center{text-align:center}.has-text-align-left{text-align:left}.has-text-align-right{text-align:right}#end-resizable-editor-section{display:none}.aligncenter{clear:both}.items-justified-left{justify-content:flex-start}.items-justified-center{justify-content:center}.items-justified-right{justify-content:flex-end}.items-justified-space-between{justify-content:space-between}.screen-reader-text{border:0;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px;word-wrap:normal!important}.screen-reader-text:focus{background-color:#ddd;clip:auto!important;clip-path:none;color:#444;display:block;font-size:1em;height:auto;left:5px;line-height:normal;padding:15px 23px 14px;text-decoration:none;top:5px;width:auto;z-index:100000}html :where(.has-border-color){border-style:solid}html :where([style*=border-top-color]){border-top-style:solid}html :where([style*=border-right-color]){border-right-style:solid}html :where([style*=border-bottom-color]){border-bottom-style:solid}html :where([style*=border-left-color]){border-left-style:solid}html :where([style*=border-width]){border-style:solid}html :where([style*=border-top-width]){border-top-style:solid}html :where([style*=border-right-width]){border-right-style:solid}html :where([style*=border-bottom-width]){border-bottom-style:solid}html :where([style*=border-left-width]){border-left-style:solid}html :where(img[class*=wp-image-]){height:auto;max-width:100%}:where(figure){margin:0 0 1em}html :where(.is-position-sticky){--wp-admin--admin-bar--position-offset:var(--wp-admin--admin-bar--height,0px)}@media screen and (max-width:600px){html :where(.is-position-sticky){--wp-admin--admin-bar--position-offset:0px}}
</style>
<style id='wp-block-heading-inline-css'>
h1.has-background,h2.has-background,h3.has-background,h4.has-background,h5.has-background,h6.has-background{padding:1.25em 2.375em}h1.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h1.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h2.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h2.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h3.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h3.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h4.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h4.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h5.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h5.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]),h6.has-text-align-left[style*=writing-mode]:where([style*=vertical-lr]),h6.has-text-align-right[style*=writing-mode]:where([style*=vertical-rl]){rotate:180deg}
</style>
<style id='wp-block-image-inline-css'>
.wp-block-image a{display:inline-block}.wp-block-image img{box-sizing:border-box;height:auto;max-width:100%;vertical-align:bottom}@media (prefers-reduced-motion:no-preference){.wp-block-image img.hide{visibility:hidden}.wp-block-image img.show{animation:show-content-image .4s}}.wp-block-image[style*=border-radius] img,.wp-block-image[style*=border-radius]>a{border-radius:inherit}.wp-block-image.has-custom-border img{box-sizing:border-box}.wp-block-image.aligncenter{text-align:center}.wp-block-image.alignfull a,.wp-block-image.alignwide a{width:100%}.wp-block-image.alignfull img,.wp-block-image.alignwide img{height:auto;width:100%}.wp-block-image .aligncenter,.wp-block-image .alignleft,.wp-block-image .alignright,.wp-block-image.aligncenter,.wp-block-image.alignleft,.wp-block-image.alignright{display:table}.wp-block-image .aligncenter>figcaption,.wp-block-image .alignleft>figcaption,.wp-block-image .alignright>figcaption,.wp-block-image.aligncenter>figcaption,.wp-block-image.alignleft>figcaption,.wp-block-image.alignright>figcaption{caption-side:bottom;display:table-caption}.wp-block-image .alignleft{float:left;margin:.5em 1em .5em 0}.wp-block-image .alignright{float:right;margin:.5em 0 .5em 1em}.wp-block-image .aligncenter{margin-left:auto;margin-right:auto}.wp-block-image :where(figcaption){margin-bottom:1em;margin-top:.5em}.wp-block-image.is-style-circle-mask img{border-radius:9999px}@supports ((-webkit-mask-image:none) or (mask-image:none)) or (-webkit-mask-image:none){.wp-block-image.is-style-circle-mask img{border-radius:0;-webkit-mask-image:url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg>');mask-image:url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50"/></svg>');mask-mode:alpha;-webkit-mask-position:center;mask-position:center;-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-size:contain;mask-size:contain}}:root :where(.wp-block-image.is-style-rounded img,.wp-block-image .is-style-rounded img){border-radius:9999px}.wp-block-image figure{margin:0}.wp-lightbox-container{display:flex;flex-direction:column;position:relative}.wp-lightbox-container img{cursor:zoom-in}.wp-lightbox-container img:hover+button{opacity:1}.wp-lightbox-container button{align-items:center;-webkit-backdrop-filter:blur(16px) saturate(180%);backdrop-filter:blur(16px) saturate(180%);background-color:#5a5a5a40;border:none;border-radius:4px;cursor:zoom-in;display:flex;height:20px;justify-content:center;opacity:0;padding:0;position:absolute;right:16px;text-align:center;top:16px;transition:opacity .2s ease;width:20px;z-index:100}.wp-lightbox-container button:focus-visible{outline:3px auto #5a5a5a40;outline:3px auto -webkit-focus-ring-color;outline-offset:3px}.wp-lightbox-container button:hover{cursor:pointer;opacity:1}.wp-lightbox-container button:focus{opacity:1}.wp-lightbox-container button:focus,.wp-lightbox-container button:hover,.wp-lightbox-container button:not(:hover):not(:active):not(.has-background){background-color:#5a5a5a40;border:none}.wp-lightbox-overlay{box-sizing:border-box;cursor:zoom-out;height:100vh;left:0;overflow:hidden;position:fixed;top:0;visibility:hidden;width:100%;z-index:100000}.wp-lightbox-overlay .close-button{align-items:center;cursor:pointer;display:flex;justify-content:center;min-height:40px;min-width:40px;padding:0;position:absolute;right:calc(env(safe-area-inset-right) + 16px);top:calc(env(safe-area-inset-top) + 16px);z-index:5000000}.wp-lightbox-overlay .close-button:focus,.wp-lightbox-overlay .close-button:hover,.wp-lightbox-overlay .close-button:not(:hover):not(:active):not(.has-background){background:none;border:none}.wp-lightbox-overlay .lightbox-image-container{height:var(--wp--lightbox-container-height);left:50%;overflow:hidden;position:absolute;top:50%;transform:translate(-50%,-50%);transform-origin:top left;width:var(--wp--lightbox-container-width);z-index:9999999999}.wp-lightbox-overlay .wp-block-image{align-items:center;box-sizing:border-box;display:flex;height:100%;justify-content:center;margin:0;position:relative;transform-origin:0 0;width:100%;z-index:3000000}.wp-lightbox-overlay .wp-block-image img{height:var(--wp--lightbox-image-height);min-height:var(--wp--lightbox-image-height);min-width:var(--wp--lightbox-image-width);width:var(--wp--lightbox-image-width)}.wp-lightbox-overlay .wp-block-image figcaption{display:none}.wp-lightbox-overlay button{background:none;border:none}.wp-lightbox-overlay .scrim{background-color:#fff;height:100%;opacity:.9;position:absolute;width:100%;z-index:2000000}.wp-lightbox-overlay.active{animation:turn-on-visibility .25s both;visibility:visible}.wp-lightbox-overlay.active img{animation:turn-on-visibility .35s both}.wp-lightbox-overlay.show-closing-animation:not(.active){animation:turn-off-visibility .35s both}.wp-lightbox-overlay.show-closing-animation:not(.active) img{animation:turn-off-visibility .25s both}@media (prefers-reduced-motion:no-preference){.wp-lightbox-overlay.zoom.active{animation:none;opacity:1;visibility:visible}.wp-lightbox-overlay.zoom.active .lightbox-image-container{animation:lightbox-zoom-in .4s}.wp-lightbox-overlay.zoom.active .lightbox-image-container img{animation:none}.wp-lightbox-overlay.zoom.active .scrim{animation:turn-on-visibility .4s forwards}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active){animation:none}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active) .lightbox-image-container{animation:lightbox-zoom-out .4s}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active) .lightbox-image-container img{animation:none}.wp-lightbox-overlay.zoom.show-closing-animation:not(.active) .scrim{animation:turn-off-visibility .4s forwards}}@keyframes show-content-image{0%{visibility:hidden}99%{visibility:hidden}to{visibility:visible}}@keyframes turn-on-visibility{0%{opacity:0}to{opacity:1}}@keyframes turn-off-visibility{0%{opacity:1;visibility:visible}99%{opacity:0;visibility:visible}to{opacity:0;visibility:hidden}}@keyframes lightbox-zoom-in{0%{transform:translate(calc((-100vw + var(--wp--lightbox-scrollbar-width))/2 + var(--wp--lightbox-initial-left-position)),calc(-50vh + var(--wp--lightbox-initial-top-position))) scale(var(--wp--lightbox-scale))}to{transform:translate(-50%,-50%) scale(1)}}@keyframes lightbox-zoom-out{0%{transform:translate(-50%,-50%) scale(1);visibility:visible}99%{visibility:visible}to{transform:translate(calc((-100vw + var(--wp--lightbox-scrollbar-width))/2 + var(--wp--lightbox-initial-left-position)),calc(-50vh + var(--wp--lightbox-initial-top-position))) scale(var(--wp--lightbox-scale));visibility:hidden}}
</style>
<style id='wp-block-image-theme-inline-css'>
:root :where(.wp-block-image figcaption){color:#555;font-size:13px;text-align:center}.is-dark-theme :root :where(.wp-block-image figcaption){color:#ffffffa6}.wp-block-image{margin:0 0 1em}
</style>
<style id='wp-block-list-inline-css'>
ol,ul{box-sizing:border-box}:root :where(.wp-block-list.has-background){padding:1.25em 2.375em}
</style>
<style id='wp-block-code-inline-css'>
.wp-block-code{box-sizing:border-box}.wp-block-code code{display:block;font-family:inherit;overflow-wrap:break-word;white-space:pre-wrap}
</style>
<style id='wp-block-code-theme-inline-css'>
.wp-block-code{border:1px solid #ccc;border-radius:4px;font-family:Menlo,Consolas,monaco,monospace;padding:.8em 1em}
</style>
<style id='wp-block-paragraph-inline-css'>
.is-small-text{font-size:.875em}.is-regular-text{font-size:1em}.is-large-text{font-size:2.25em}.is-larger-text{font-size:3em}.has-drop-cap:not(:focus):first-letter{float:left;font-size:8.4em;font-style:normal;font-weight:100;line-height:.68;margin:.05em .1em 0 0;text-transform:uppercase}body.rtl .has-drop-cap:not(:focus):first-letter{float:none;margin-left:.1em}p.has-drop-cap.has-background{overflow:hidden}:root :where(p.has-background){padding:1.25em 2.375em}:where(p.has-text-color:not(.has-link-color)) a{color:inherit}p.has-text-align-left[style*="writing-mode:vertical-lr"],p.has-text-align-right[style*="writing-mode:vertical-rl"]{rotate:180deg}
</style>
<style id='wp-block-preformatted-inline-css'>
.wp-block-preformatted{box-sizing:border-box;white-space:pre-wrap}:where(.wp-block-preformatted.has-background){padding:1.25em 2.375em}
</style>
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href='https://www.malwarebytes.com/_static/??-eJyFjMEKwzAMQ39oqSkM2svYt2SZawyuY2qXsL9f6C47FKqTkPQEzVKpGqgBJjuxOhDWyBthsFIzsP0lXKD4X5N+4bCyDr24wclNQ5Ia8GaPA162PkjdXRHZDDw+gg6KLS2S6WCe62Oc7uM8T11fzZNE+Q==' type='text/css' media='all' />
<noscript><link rel='stylesheet' href='https://www.malwarebytes.com/_static/??-eJyFjMEKwzAMQ39oqSkM2svYt2SZawyuY2qXsL9f6C47FKqTkPQEzVKpGqgBJjuxOhDWyBthsFIzsP0lXKD4X5N+4bCyDr24wclNQ5Ia8GaPA162PkjdXRHZDDw+gg6KLS2S6WCe62Oc7uM8T11fzZNE+Q=='>
</noscript><style id='custom-flag-handle-inline-css'>
.weglot-flags.flag-0.en>a:before,.weglot-flags.flag-0.en>span:before {background-image: url(https://cdn.weglot.com/flags/rectangle_mat/us.svg); }.weglot-flags.flag-1.en>a:before,.weglot-flags.flag-1.en>span:before {background-image: url(https://cdn.weglot.com/flags/shiny/us.svg); }.weglot-flags.flag-2.en>a:before,.weglot-flags.flag-2.en>span:before {background-image: url(https://cdn.weglot.com/flags/square/us.svg); }.weglot-flags.flag-3.en>a:before,.weglot-flags.flag-3.en>span:before {background-image: url(https://cdn.weglot.com/flags/circle/us.svg); }
</style>
<link rel='stylesheet' id='base-fonts-style-css' href='https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/base-fonts.css?ver=1741887777' media='all' />
<link rel='stylesheet' id='base-blog-style-css' href='https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/base-blog.css?ver=1741887777' media='all' />
<link rel='stylesheet' id='base-css-css' href='https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/base.css?ver=1.0' media='all' />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href='https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/library/css/font-awesome.min.css?m=1741887777g' type='text/css' media='all' />
<noscript><link rel='stylesheet' href='https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/library/css/font-awesome.min.css?m=1741887777g'>
</noscript><style id='kadence-blocks-global-variables-inline-css'>
:root {--global-kb-font-size-sm:clamp(0.8rem, 0.73rem + 0.217vw, 0.9rem);--global-kb-font-size-md:clamp(1.1rem, 0.995rem + 0.326vw, 1.25rem);--global-kb-font-size-lg:clamp(1.75rem, 1.576rem + 0.543vw, 2rem);--global-kb-font-size-xl:clamp(2.25rem, 1.728rem + 1.63vw, 3rem);--global-kb-font-size-xxl:clamp(2.5rem, 1.456rem + 3.26vw, 4rem);--global-kb-font-size-xxxl:clamp(2.75rem, 0.489rem + 7.065vw, 6rem);}:root {--global-palette1: #3182CE;--global-palette2: #2B6CB0;--global-palette3: #1A202C;--global-palette4: #2D3748;--global-palette5: #4A5568;--global-palette6: #718096;--global-palette7: #EDF2F7;--global-palette8: #F7FAFC;--global-palette9: #ffffff;}
</style>
<script type="text/javascript" src="https://www.malwarebytes.com/wp-content/plugins/weglot/dist/front-js.js?m=1741887777g" ></script><link rel="https://api.w.org/" href="https://www.malwarebytes.com/wp-json/" /><link rel="alternate" title="JSON" type="application/json" href="https://www.malwarebytes.com/wp-json/wp/v2/posts/74941" /><link rel='shortlink' href='https://www.malwarebytes.com/?p=74941' />
<link rel="alternate" title="oEmbed (JSON)" type="application/json+oembed" href="https://www.malwarebytes.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.malwarebytes.com%2Fblog%2Fnews%2F2019%2F08%2Fthe-hidden-bee-infection-chain-part-1-the-stegano-pack" />
<link rel="alternate" title="oEmbed (XML)" type="text/xml+oembed" href="https://www.malwarebytes.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.malwarebytes.com%2Fblog%2Fnews%2F2019%2F08%2Fthe-hidden-bee-infection-chain-part-1-the-stegano-pack&#038;format=xml" />
	<style>img#wpstats{display:none}</style>
		
<script type="application/json" id="weglot-data">{"website":"https:\/\/www.malwarebytes.com","uid":"d49bb2be6f","project_slug":"figs","language_from":"en","language_from_custom_flag":"us","language_from_custom_name":null,"excluded_paths":[{"type":"CONTAIN","value":"\/accessibility","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/accessibility"},{"type":"CONTAIN","value":"\/beta","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/beta"},{"type":"CONTAIN","value":"\/blog","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/blog"},{"type":"CONTAIN","value":"\/academy","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/academy"},{"type":"CONTAIN","value":"\/copyright","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/copyright"},{"type":"CONTAIN","value":"\/eula","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/eula"},{"type":"CONTAIN","value":"\/gdpr-commitment","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/gdpr\\-commitment"},{"type":"CONTAIN","value":"\/impressum","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":["es","fr","it","nl","pl","ru","br"],"regex":"\/impressum"},{"type":"CONTAIN","value":"\/jp","language_button_displayed":true,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/jp"},{"type":"CONTAIN","value":"\/legal","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/legal"},{"type":"CONTAIN","value":"\/lp\/sem","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/lp\/sem"},{"type":"CONTAIN","value":"\/secure","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/secure"},{"type":"CONTAIN","value":"\/tos","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"\/tos"},{"type":"CONTAIN","value":"yandex_2591bba93ba202da.html","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"yandex_2591bba93ba202da\\.html"},{"type":"START_WITH","value":"\/robots.txt","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/robots\\.txt"},{"type":"START_WITH","value":"\/cybersecurity\/business","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/cybersecurity\/business"},{"type":"START_WITH","value":"\/business","language_button_displayed":false,"exclusion_behavior":"NOT_TRANSLATED","excluded_languages":[],"regex":"^\/business"},{"type":"START_WITH","value":"\/resources","language_button_displayed":false,"exclusion_behavior":"NOT_TRANSLATED","excluded_languages":[],"regex":"^\/resources"},{"type":"END_WITH","value":"\/privacy\/ccpa","language_button_displayed":false,"exclusion_behavior":"NOT_TRANSLATED","excluded_languages":[],"regex":"\/privacy\/ccpa$"},{"type":"MATCH_REGEX","value":"^\\\/digital-footprint\\\/?$","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\\\/digital-footprint\\\/?$"},{"type":"START_WITH","value":"\/jobs","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/jobs"},{"type":"START_WITH","value":"\/press","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/press"},{"type":"START_WITH","value":"\/techbench\/licensing","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/techbench\/licensing"},{"type":"START_WITH","value":"\/author","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/author"},{"type":"START_WITH","value":"\/pdf","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/pdf"},{"type":"START_WITH","value":"\/api","language_button_displayed":false,"exclusion_behavior":"NOT_TRANSLATED","excluded_languages":[],"regex":"^\/api"},{"type":"START_WITH","value":"\/support\/thirdpartynotices","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/support\/thirdpartynotices"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/posts","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/posts"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/categories","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/categories"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/detection-type","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/detection\\-type"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/taxonomies","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/taxonomies"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/threat-type","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/threat\\-type"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/pages","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/pages"},{"type":"START_WITH","value":"\/personal-data-remover","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/personal\\-data\\-remover"},{"type":"START_WITH","value":"\/wp-json\/oembed\/1.0\/embed","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/oembed\/1\\.0\/embed"},{"type":"START_WITH","value":"\/glossary","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/glossary"},{"type":"START_WITH","value":"\/resource","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/resource"},{"type":"START_WITH","value":"\/page\/","language_button_displayed":false,"exclusion_behavior":"NOT_TRANSLATED","excluded_languages":[],"regex":"^\/page\/"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/detections\/","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/detections\/"},{"type":"START_WITH","value":"\/search\/","language_button_displayed":false,"exclusion_behavior":"NOT_TRANSLATED","excluded_languages":[],"regex":"^\/search\/"},{"type":"IS_EXACTLY","value":"\/privacy\/data-subject-access-request-form","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/privacy\/data\\-subject\\-access\\-request\\-form$"},{"type":"IS_EXACTLY","value":"\/privacy\/ccpa","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/privacy\/ccpa$"},{"type":"IS_EXACTLY","value":"\/privacy\/policy-for-browser-guard","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/privacy\/policy\\-for\\-browser\\-guard$"},{"type":"START_WITH","value":"\/wp-json\/wp\/v2\/glossary","language_button_displayed":false,"exclusion_behavior":"REDIRECT","excluded_languages":[],"regex":"^\/wp\\-json\/wp\/v2\/glossary"}],"excluded_blocks":[{"value":".mwb-product-info_product-price","description":"Product Pricing"},{"value":".mwb-product-info_product-price_purchase-price","description":"Product Purchase Price"},{"value":".mwb-product-info_product-price_list-price","description":"Product List Price"},{"value":"span[data-component=\"mwb-product-info_product-price\"]","description":"variables"}],"custom_settings":{"button_style":{"is_dropdown":true,"with_flags":true,"flag_type":"rectangle_mat","with_name":true,"full_name":true,"custom_css":""},"wp_user_version":"4.2.9","translate_email":false,"translate_search":false,"translate_amp":false,"switchers":[{"templates":{"name":"default","hash":"2235a3ca93d6ea941d131f6fcb4f5ed7fd2f4ec8"},"location":[],"style":{"with_flags":true,"flag_type":"rectangle_mat","with_name":true,"full_name":true,"is_dropdown":true}}]},"pending_translation_enabled":false,"curl_ssl_check_enabled":true,"custom_css":null,"languages":[{"language_to":"de","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"es","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"fr","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"it","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"nl","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"pl","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"pt","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"br","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null},{"language_to":"ru","custom_code":null,"custom_name":null,"custom_local_name":null,"provider":null,"enabled":true,"automatic_translation_enabled":true,"deleted_at":null,"connect_host_destination":null,"custom_flag":null}],"organization_slug":"w-85925e1a76","current_language":"en","switcher_links":{"en":"https:\/\/www.malwarebytes.com\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=true","de":"https:\/\/www.malwarebytes.com\/de\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","es":"https:\/\/www.malwarebytes.com\/es\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","fr":"https:\/\/www.malwarebytes.com\/fr\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","it":"https:\/\/www.malwarebytes.com\/it\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","nl":"https:\/\/www.malwarebytes.com\/nl\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","pl":"https:\/\/www.malwarebytes.com\/pl\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","pt":"https:\/\/www.malwarebytes.com\/pt\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","br":"https:\/\/www.malwarebytes.com\/pt-br\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false","ru":"https:\/\/www.malwarebytes.com\/ru\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack?wg-choose-original=false"},"original_path":"\/blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack"}</script><link rel="icon" href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/01/malwarebytes-favicon-apple-touch-icon.png?w=32" sizes="32x32" />
<link rel="icon" href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/01/malwarebytes-favicon-apple-touch-icon.png?w=180" sizes="192x192" />
<link rel="apple-touch-icon" href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/01/malwarebytes-favicon-apple-touch-icon.png?w=180" />
<meta name="msapplication-TileImage" content="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/01/malwarebytes-favicon-apple-touch-icon.png?w=180" />
		<style id="wp-custom-css">
			@media (min-width: 1150px) {
	.site-header.mb-header-pricing .site-header__nav ul.primary-menu > li:not(:nth-child(3)) .megamenu-wrap {
  	transform: translate(-42%, -200%);
	}
	.site-header.mb-header-pricing .site-header__nav ul.primary-menu > li:not(:nth-child(3)).active .megamenu-wrap {
  	transform: translate(-42%, 0);
	}
}		</style>
		        <meta name="facebook-domain-verification" content="cmdpjevu8l4zya3vzr1p6f00v21uty" />
        <!-- GTM -->
        <script type="text/javascript">(function (w, d, s, l, i) {
                w[l] = w[l] || []; w[l].push({
                    'gtm.start':
                        new Date().getTime(), event: 'gtm.js'
                }); var f = d.getElementsByTagName(s)[0],
                    j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src = '//www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
            })(window, document, 'script', 'dataLayer', 'GTM-MKSKW3');
        </script>
        <!-- End GTM -->
                <script>
            (function () {
                let plausibleDataDomain = 'dev-www.malwarebytes.com';
                if (location.href.indexOf('https://www.malwarebytes.com') === 0 || location.href.indexOf('https://malwarebytes.go-vip.net') === 0) {
                    plausibleDataDomain = 'w.malwarebytes.com,malwarebytes.com';
                } else if (location.href.indexOf('https://preprod-www.malwarebytes.com') === 0) {
                    plausibleDataDomain = 'staging-www.malwarebytes.com';
                }
                let script = document.createElement('script');
                script.defer = true;
                script.src = 'https://plausible.io/js/script.js';
                script.dataset.domain = plausibleDataDomain;
                document.head.appendChild(script);
            })();
        </script>
        
<body class="post-template-default single single-post postid-74941 single-format-standard wp-custom-logo">
<div id="page" class="site">
	<a class="skip-link screen-reader-text" href="#primary">Skip to content</a>

	<header id="masthead" class="site-header mb-header-blog">
		<div class="container">
			<div class="site-header__top">
				<!-- Search -->
						<div class="site-header-searchbox">
						<button class="searchbox-nav" aria-label="Search in MalwareBytes">Search</button>
			<div class="search-modal">
				<label>Search Malwarebytes.com</label>
				<div class="custom-search-form">
					<form role="search" method="get" class="search-form" action="https://www.malwarebytes.com/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Type to search..." value="" name="s" />
	</label>
	<input type="submit" class="search-submit" value="Search" />
</form>
				</div>
			</div>
		</div>
						<!-- Search -->
				<ul id="secondary-menu" class="secondary-menu u-flex-center"><li id="menu-item-2914" class="signin-items menu-item menu-item-type-custom menu-item-object-custom menu-item-2914"><a href="https://my.malwarebytes.com/en/login" id="cta-en-us-utilbar-my_malwarebytes_com_en_login-click">Sign In</a></li>
</ul>			</div>
			<div class="site-header__bottom u-flex-columns">
				<div class="site-header__branding u-flex-column u-flex-col-lg-3 u-flex-col-9">
					<a href="https://www.malwarebytes.com/blog" rel="home" id="cta-navbar-company-logo-en-blog">
						<svg width="183" height="24" viewBox="0 0 183 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.225 20.116c.072 0 .072 0 0 0 .215 0 .286-.148.286-.296s-.071-.222-.214-.296h-.215c-2.717-.592-4.863-3.106-4.863-6.064A6.55 6.55 0 0 1 5.22 9.984c.072-.148.287-.222.43-.074l4.362 4.585c.071.074.143.074.214.074.072 0 .143 0 .215-.074l4.434-4.511c.143-.148.286-.148.429 0 .643.961 1 2.145 1 3.476a6.351 6.351 0 0 1-1.5 4.141s-.072.074-.072.148v.074c0 .148.143.222.214.222 0 0 .072 0 .143-.074 5.793-2.588 5.578-8.505 5.578-8.505 0-3.402-1.573-6.508-4.005-8.43-.143-.075-.286-.075-.357 0l-5.793 5.99c-.143.148-.286.148-.357 0l-5.793-5.99c-.071-.075-.286-.149-.357 0C1.573 2.957 0 6.063 0 9.465c0 5.547 4.076 10.058 9.225 10.65Z" fill="#0D3ECC"/><path d="m160.975 18.045-5.292-13.238-5.292 13.312h1.431l1.001-2.662h3.432l-2.789-1.701 2.217-5.62 2.861 7.543h-2.503l5.006 2.366h-.072Z" fill="#3D3D3D"/><path d="M90.32 5.99 90.25.222c0-.148-.144-.222-.287-.222L88.39.222c-.143 0-.215.148-.215.222v17.083c0 .148.072.222.143.222 1.36.296 3.075.444 4.148.444 4.505 0 5.149-2.219 5.149-4.66V9.097c0-2.588-1.144-3.92-3.504-3.92-1.573-.073-3.004.445-3.79.814Zm5.364 2.959v4.659c0 1.7-.5 2.81-3.003 2.81-.859 0-1.645-.074-2.432-.148h-.071V7.913c.715-.37 2.216-.961 3.36-.961 1.502 0 2.146.591 2.146 1.997Zm4.648-3.55h-1.501c-.143 0-.286.148-.215.296l3.79 12.054c0 .074.143.148.215.148h.429c.143 0 .286.148.215.296l-1.502 4.511c-.072.148.071.296.214.296h1.431c.071 0 .143-.074.214-.148l1.645-4.881L109.2 5.695c.072-.148-.071-.296-.214-.296h-1.502c-.072 0-.143.074-.215.148l-3.146 10.205c-.072.222-.358.222-.429 0l-3.147-10.205c0-.074-.143-.148-.215-.148Zm18.665 4.437v3.772c0 3.106 1.502 4.585 4.792 4.585 1.43 0 2.932-.222 4.076-.666.143 0 .143-.148.143-.296l-.215-1.183c0-.148-.143-.222-.286-.148-1.358.37-2.503.518-3.575.518-2.503 0-2.932-.961-2.932-2.81v-.888c0-.148.071-.222.214-.222h6.865c.143 0 .215-.074.215-.221V9.91c0-3.18-1.502-4.733-4.505-4.733-3.147-.074-4.792 1.553-4.792 4.659ZM121 9.614c0-1.923.858-2.81 2.717-2.81s2.646.813 2.646 2.81v.888c0 .147-.071.221-.214.221h-4.935c-.143 0-.214-.074-.214-.221v-.888Zm13.158 1.183c-2.074-.517-2.145-.813-2.145-2.218 0-1.183.286-1.627 2.074-1.627.858 0 2.073.148 3.075.296.143 0 .286-.074.286-.222l.143-1.257c0-.148-.072-.222-.143-.222-.93-.222-2.074-.37-3.218-.37-3.004 0-4.148.887-4.148 3.328 0 2.588.286 3.254 3.289 3.993 2.432.592 2.575.74 2.575 2.145 0 1.331-.286 1.775-2.289 1.775-.929 0-2.216-.148-3.218-.444-.143 0-.286.074-.286.148l-.214 1.183c0 .148.071.222.143.296 1.001.37 2.503.592 3.647.592 3.504 0 4.148-1.183 4.148-3.624 0-2.662-.429-2.958-3.719-3.772ZM41.692 17.75 39.547 5.546c0-.148.071-.296.214-.296h2.432c.143 0 .214.074.214.148l1.287 7.321c0 .222.358.296.43 0l2.145-7.395c0-.074.143-.148.214-.148h2.86c.072 0 .144.074.215.148l2.074 7.395a.222.222 0 0 0 .43 0L53.348 5.4c0-.148.143-.148.214-.148h2.432c.143 0 .214.148.214.296L54.063 17.75c0 .148-.143.148-.215.148H50.63c-.071 0-.143-.074-.214-.148l-2.36-8.135a.222.222 0 0 0-.43 0l-2.36 8.135c0 .074-.142.148-.214.148h-3.218c0 .074-.143 0-.143-.148Zm-3.504-2.146c-1.073 0-1.43-.517-1.43-1.922V.96c0-.148-.143-.221-.286-.221l-2.575.37c-.143 0-.214.147-.214.221v12.721c0 2.885 1.716 4.142 3.933 4.142.214 0 1.072 0 1.43-.074.143 0 .215-.148.215-.222V15.9c0-.148-.143-.222-.215-.222-.286-.074-.643-.074-.858-.074ZM75.16 8.061c-1.073.518-1.93 1.035-3.004 1.701-.071 0-.143.148-.143.222v7.765c0 .148-.071.222-.214.222h-2.646c-.143 0-.215-.074-.215-.222V5.99c0-.148.072-.221.143-.221l2.217-.37c.143 0 .215.074.286.148l.143.813c0 .148.215.222.358.148.644-.444 1.788-1.11 2.646-1.405.143-.074.286.074.286.222l.286 2.44c0 .148 0 .222-.143.296Zm40.691 8.357c-1.216 0-1.287-.592-1.287-1.48V7.323c0-.148.071-.222.214-.222h2.861c.143 0 .214-.074.214-.222l.143-1.257c0-.148-.071-.296-.214-.296h-3.004c-.143 0-.214-.074-.214-.222V2.219c0-.148-.144-.222-.287-.222l-1.573.222c-.143 0-.214.148-.214.222v2.736c0 .148-.072.222-.215.222h-1.716c-.143 0-.215.074-.215.222v1.257c0 .148.072.222.215.222h1.716c.143 0 .215.074.215.222v7.987c0 1.996.858 2.81 3.003 2.81.501 0 .93-.074 1.43-.148.143 0 .143-.148.143-.222v-1.183c0-.148-.143-.222-.286-.222-.286.074-.572.074-.929.074ZM84.028 5.473c-.644-.296-1.502-.444-2.503-.444-1.145 0-2.146.222-2.86.592-1.646.813-2.218 2.514-2.218 4.363v3.328c0 2.958 1.287 4.807 4.935 4.88h.858c1.001 0 2.002-.147 3.003-.295.143 0 .215-.148.215-.296v-.148l-.286-1.7c-.93.073-1.716.147-2.646.147-2.217 0-2.932-.665-2.932-2.07v-1.036h6.579c.143 0 .215-.074.215-.222v-2.514c-.072-1.997-.573-3.772-2.36-4.585Zm-.43 5.029c0 .147-.071.221-.214.221h-3.862V9.614c0-1.183.5-1.997 2.003-1.997h.5c1.144.148 1.573.962 1.573 1.997v.888Zm-57.71-5.399c-1.073 0-2.217.074-3.218.222-.143 0-.215.148-.143.296l.286 1.922c0 .148.143.222.214.222 1.001-.148 1.645-.148 2.646-.148 2.217 0 2.932.666 2.932 2.071v.814c0 .147-.071.221-.214.221h-2.86c-2.504 0-3.934 1.332-3.934 3.698 0 2.219 1.645 3.772 4.076 3.772 1.573 0 2.146-.222 2.646-.74.143-.148.358 0 .358.148v.148c0 .148.071.222.214.222h2.432c.143 0 .214-.074.214-.222V9.69c0-3.107-2.074-4.586-5.65-4.586Zm2.646 8.135c0 1.553-1.073 2.662-2.646 2.662-1.288 0-1.931-.517-1.931-1.553 0-1.109.643-1.553 1.93-1.553h2.432c.143 0 .215.074.215.222v.222Zm32.681-8.135c-1.073 0-2.217.074-3.218.222-.143 0-.215.148-.143.296l.286 1.922c0 .148.143.222.214.222C59.356 7.617 60 7.617 61 7.617c2.217 0 2.932.666 2.932 2.071v.814c0 .147-.071.221-.214.221h-2.86c-2.504 0-3.934 1.332-3.934 3.698 0 2.219 1.645 3.772 4.076 3.772 1.574 0 2.146-.222 2.646-.74.143-.148.358 0 .358.148v.148c0 .148.072.222.215.222h2.503c.143 0 .214-.074.214-.222V9.69c0-3.107-2.145-4.586-5.721-4.586Zm2.646 8.135c0 1.553-1.073 2.662-2.646 2.662-1.287 0-1.93-.517-1.93-1.553 0-1.109.643-1.553 1.93-1.553h2.431c.143 0 .215.074.215.222v.222Z" fill="#0D3ECC"/><path d="M177.352 18.119c-1.574 0-3.29-.37-4.935-1.035l.358-1.332c1.502.518 3.146.888 4.505.888 1.931 0 3.075-.814 3.075-1.923 0-.961-.572-1.479-3.361-2.588-3.146-1.184-4.219-2.071-4.219-3.994 0-2.07 1.645-2.958 4.577-2.958 1.287 0 3.075.222 4.291.665l-.287 1.332c-1.215-.296-2.646-.518-3.933-.518-2.145 0-3.003.37-3.003 1.48 0 1.182.786 1.626 3.647 2.735 3.146 1.258 3.933 1.997 3.933 3.772.072 2.07-1.788 3.476-4.648 3.476Zm-27.676-.074h-5.363c-.715 0-1.144-.296-1.359-.518-.429-.517-.429-1.109-.429-1.33V5.102h1.287v11.241c0 .074 0 .222.072.296.071.074.286.148.357.148h5.364l.071 1.257Zm21.812-3.624c0-1.553-.715-2.81-2.217-3.402.929-.517 1.645-1.479 1.645-2.81 0-1.923-1.431-3.032-3.934-3.032h-5.005v11.019c0 .148 0 .814.429 1.331.214.296.643.518 1.358.518h3.79c2.718-.074 3.934-1.7 3.934-3.624Zm-8.153-7.987h3.647c1.788 0 2.646.592 2.646 1.923s-.858 2.219-2.503 2.219h-3.79V6.434Zm4.863 10.28h-4.434c-.143 0-.286 0-.357-.148-.072-.074-.072-.296-.072-.296v-4.437h4.219c1.788 0 2.646 1.11 2.575 2.514-.072 1.258-.715 2.145-1.931 2.367Z" fill="#3D3D3D"/></svg>
					</a>
				</div>
				<div class="site-header__bottom-right u-flex-column u-flex-col-lg-9 u-flex-col-3">
					<button class="menu-toggle" aria-label="Menu" aria-controls="primary-menu" aria-expanded="false">
						<span class="menu-toggle-bar menu-toggle-bar1"></span>
						<span class="menu-toggle-bar menu-toggle-bar2"></span>
						<span class="menu-toggle-bar menu-toggle-bar3"></span>
					</button>
					<div class="site-header__nav">
						<nav id="site-navigation" class="main-navigation">
							<ul id="primary-menu" class="primary-menu u-flex-center"><li id="menu-item-2906" class="personal-menu-class menu-item menu-item-type-custom menu-item-object-custom menu-item-2906 menu-item-has-megamenu"><a href="#" id="cta-en-us-navbar-personal-click">Personal</a><div class="megamenu-wrap">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-1 wp-block-columns-is-layout-flex" style="padding-bottom:0">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:31%">
<p>&lt; Products</p>



<div class="wp-block-group alignfull is-vertical is-content-justification-stretch is-layout-flex wp-container-core-group-is-layout-1 wp-block-group-is-layout-flex">
<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-4ed3bf9a-9621-4f6d-8aba-9a5850ee5951"><div class="menu-links__item"><div class="menu-links__title" style="color:#0d3ecc"><strong>Device Protection &amp; Antivirus</strong></div><ul><li><a id="cta-en-us-navbar-personal-malwarebytes-premium-click" href="https://www.malwarebytes.com/premium">Premium Security Antivirus</a></li><li><a href="https://www.malwarebytes.com/mobile">Mobile Security for Android &amp; iOS</a></li></ul></div></div>
</div>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:31%">
<div class="wp-block-group alignfull is-vertical is-content-justification-stretch is-layout-flex wp-container-core-group-is-layout-2 wp-block-group-is-layout-flex">
<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-4ed3bf9a-9621-4f6d-8aba-9a5850ee5951"><div class="menu-links__item"><div class="menu-links__title" style="color:#0d3ecc"><strong>Identity Protection</strong></div><ul><li><a id="cta-en-us-navbar-_identity_theft_protection-click" href="https://www.malwarebytes.com/identity-theft-protection">Identity Theft Protection</a></li><li><a id="cta-en-us-navbar-personal-data-remover-click" href="https://www.malwarebytes.com/personal-data-remover">Personal Data Remover</a></li><li><a id="cta-en-us-navbar-digital-footprint-scanner-click" href="https://www.malwarebytes.com/digital-footprint">Digital Footprint Scanner</a></li></ul></div><div class="menu-links__item"><div class="menu-links__title" style="color:#0d3ecc"><strong>Privacy Protection</strong></div><ul><li><a id="cta-en-us-navbar-_vpn-click" href="https://www.malwarebytes.com/vpn" data-type="link" data-id="https://www.malwarebytes.com/vpn">Privacy VPN</a></li><li><a id="cta-en-us-navbar-_browserguard-click" href="https://www.malwarebytes.com/browserguard">Browser Guard</a></li><li><a id="cta-en-us-navbar-_adwcleaner-click" href="https://www.malwarebytes.com/adwcleaner">AdwCleaner</a></li></ul></div></div>
</div>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:31%">
<div class="wp-block-group alignfull flex-direction-row is-vertical is-content-justification-stretch is-layout-flex wp-container-core-group-is-layout-3 wp-block-group-is-layout-flex">
<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-d24ba127-7e50-44f9-8919-360f85d19902" style="background-color:#ffffff"><div class="menu-links__item"><p class="menu-links__desc" style="color:#135e96"><span data-fontsize="18" class="qubely-custom-font" style="font-size: 18px;"><span data="#191919" class="qubely-text-has-color" style="color: #191919;">Have a current computer infection?</span></span></p><div class="menu-links__cta" style="color:#135e96"><a id="cta-en-us-navbar-clean-your-device-now-click" href="https://www.malwarebytes.com/solutions/virus-scanner" data-type="link" data-id="https://www.malwarebytes.com/solutions/virus-scanner"><strong>Free Virus Scan</strong></a></div></div><div class="menu-links__item"><p class="menu-links__desc" style="color:#135e96"><span data="#191919" class="qubely-text-has-color" style="color: #191919;"><span data-fontsize="18" class="qubely-custom-font" style="font-size: 18px;">Try our antivirus with a free, full-featured 14-day trial</span></span></p><div class="menu-links__cta" style="color:#135e96"><a id="cta-en-us-navbar-download-now-click" href="https://www.malwarebytes.com/getprotection"><strong>Free Antivirus</strong></a></div></div><div class="menu-links__item"><p class="menu-links__desc" style="color:#135e96"><span data="#191919" class="qubely-text-has-color" style="color: #191919;"><span data-fontsize="18" class="qubely-custom-font" style="font-size: 18px;">Find the right cyberprotection for you</span></span></p><div class="menu-links__cta" style="color:#135e96"><a id="cta-en-us-navbar-see-our-plans-click" href="https://www.malwarebytes.com/pricing"><strong>Compare plans and pricing</strong></a></div></div></div>
</div>
</div>
</div>
</div></li>
<li id="menu-item-2907" class="business-menu-class menu-item menu-item-type-custom menu-item-object-custom menu-item-2907 menu-item-has-megamenu"><a href="#" id="cta-en-us-navbar-business-click">Business</a><div class="megamenu-wrap">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-2 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:25%"></div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:35%">
<p>&lt; Business</p>



<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-f01e317a-5669-417c-ae3d-5bae36e32f8c"><div class="menu-links__item"><div class="menu-links__title" style="color:#0D3ECC"><strong><a id="cta-en-us-navbar-business-teams-click" href="https://www.malwarebytes.com/teams">Teams</a></strong></div><div class="menu-links__subtitle">Protect small &amp; home offices &#8211; no IT expertise needed</div></div><div class="menu-links__item"><div class="menu-links__title" style="color:#0D3ECC"><strong><a href="https://www.threatdown.com/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cta-mb-nav-threatdown">ThreatDown</a></strong></div><div class="menu-links__subtitle">Award-winning endpoint security for small and medium businesses</div></div></div>
</div>
</div>
</div></li>
<li id="menu-item-2908" class="pricing-menu-class menu-item menu-item-type-custom menu-item-object-custom menu-item-2908 menu-item-has-megamenu"><a href="#" id="cta-en-us-navbar-pricing-click">Pricing</a><div class="megamenu-wrap">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-3 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<p>&lt; Pricing</p>



<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-8b91929a-d4ec-4127-b3f4-08b5703b82f6"><div class="menu-links__item"><div class="menu-links__title"><a id="cta-en-us-navbar-pricing-personal-pricing-click" href="https://www.malwarebytes.com/pricing" data-type="page" data-id="3844">Personalpricing</a></div><p class="menu-links__desc">Protect your personal devices and data</p></div><div class="menu-links__item"><div class="menu-links__title"><a id="cta-en-us-navbar-pricing-small-office-home-office-pricing-click" href="https://www.malwarebytes.com/pricing/teams" data-type="link" data-id="https://www.malwarebytes.com/pricing/teams">Smallor home office pricing</a></div><p class="menu-links__desc">Protect your team&#8217;s devices and data &#8211; no IT skills needed</p></div><div class="menu-links__item"><div class="menu-links__title"><a id="cta-en-us-navbar-pricing-business-pricing-click" href="https://www.threatdown.com/pricing/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cat-en-us-navbar-pricing-business-pricing-click" data-type="page" data-id="124">Corporate pricing</a></div><p class="menu-links__desc">Explore award-winning endpoint security for your business</p></div></div>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>
</div>
</div></li>
<li id="menu-item-2909" class="partners-menu-class menu-item menu-item-type-custom menu-item-object-custom menu-item-2909 menu-item-has-megamenu"><a href="#" id="cta-en-us-navbar-partners-click">Partners</a><div class="megamenu-wrap">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-4 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow"></div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:30%">
<p>&lt; Partners</p>



<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-e13d480b-8377-4493-b67e-2fa03815fbb5"><div class="menu-links__item"><div class="menu-links__title"><br><a id="cta-navbar-partners-explore-partnerships-en-test" href="https://www.malwarebytes.com/partners">Malwarebytes</a></div><ul><li><a id="cta-navbar-partners-affiliate-partner-en-test" href="https://www.malwarebytes.com/affiliates" data-type="link" data-id="https://www.malwarebytes.com/affiliates">Affiliate partner</a></li><li><a id="cta-navbar-partners-computer-repair-en-test" href="https://www.malwarebytes.com/techbench">Computer repair</a><br></li></ul></div><div class="menu-links__item"><div class="menu-links__title"><a id="cta-navbar-partners-explore-threatdown-en-test" href="https://www.threatdown.com/partner-program/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cta-navbar-partners-explore-partnerships-en-test" target="_blank" rel="noreferrer noopener">ThreatDown: Malwarebytes for Business</a></div><ul><li><a id="cta-navbar-partners-solution-providers-en-test" href="https://www.threatdown.com/partner-program/partner-reseller/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cta-navbar-partners-solution-providers-en-test" target="_blank" rel="noreferrer noopener">Resellers</a></li><li><a id="cta-navbar-partners-managed-service-providers-en-test" href="https://www.threatdown.com/partner-program/msp/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cta-navbar-partners-managed-service-providers-en-test" data-type="page" data-id="3311" target="_blank" rel="noreferrer noopener">Managed Service Providers (MSP/ISS)</a></li></ul></div></div>
</div>



<div class="wp-block-column has-white-background-color has-background is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:34%"></div>
</div>
</div></li>
<li id="menu-item-2910" class="resources-menu-class menu-item menu-item-type-custom menu-item-object-custom menu-item-2910 menu-item-has-megamenu"><a href="#" id="cta-en-us-navbar-resources-click">Resources</a><div class="megamenu-wrap">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-5 wp-block-columns-is-layout-flex" style="padding-right:var(--wp--preset--spacing--80);padding-left:0">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:33.33%"></div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:34.48%">
<p>&lt; Resources</p>



<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-d6a9ae27-5550-4478-b20f-6394817e1ef7"><div class="menu-links__item"><div class="menu-links__title"><a id="cta-en-us-navbar-_resources-learn-cybcersecurity-click" href="https://www.malwarebytes.com/blog" data-type="link" data-id="https://www.malwarebytes.com/blog"><img decoding="async" class="wp-image-151872" style="width: NaNpx;" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/07/mwb-labs-159px.svg" alt="Malwarebytes Labs"></a></div><ul><li><a id="cta-en-us-navbar-_antivirus-click" href="https://www.malwarebytes.com/glossary">Security terms glossary</a></li><li><a id="cta-en-us-navbar-_malware-click" href="https://www.malwarebytes.com/blog/threats">Threat Center</a></li><li><a href="https://www.malwarebytes.com/blog">Cybersecurity News</a></li></ul></div><div class="menu-links__item"><ul><li><a id="cta-en-us-navbar-_glossary-click" href="https://www.malwarebytes.com/company">About Malwarebytes</a></li><li><a id="cta-en-us-navbar-_blog_threats-click" href="https://www.malwarebytes.com/press/">Press</a></li><li><a href="https://www.malwarebytes.com/jobs">Careers</a></li></ul></div></div>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:32.19%">
<p></p>



<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-0a8428cf-74da-4b5d-a0ed-6cf810a8b368"><div class="menu-links__item"><div class="menu-links__title"><a id="cta-en-us-navbar-_resources-business-click" href="https://www.malwarebytes.com/cybersecurity">Cybersecurity Resource Center</a></div><ul><li><a id="cta-en-us-navbar-_resources-click" href="https://www.malwarebytes.com/cybersecurity/basics/antivirus">Antivirus</a></li><li><a href="https://www.malwarebytes.com/malware">Malware</a></li><li><a id="cta-en-us-navbar-_resources_casestudies-click" href="https://www.malwarebytes.com/ransomware">Ransomware</a></li><li><a href="https://www.malwarebytes.com/phishing">Phishing</a></li><li><a href="https://www.malwarebytes.com/cybersecurity">See all articles</a></li></ul></div></div>
</div>
</div>
</div></li>
<li id="menu-item-2911" class="support-menu-class menu-item menu-item-type-custom menu-item-object-custom menu-item-2911 menu-item-has-megamenu"><a href="#" id="cta-en-us-navbar-support-click">Support</a><div class="megamenu-wrap">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-6 wp-block-columns-is-layout-flex">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:30%"></div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:30%"></div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow" style="flex-basis:35%">
<p>&lt; Support</p>



<div class="wp-block-malware-bytes-menu-links menu-links layout-1 has-item-border" id="menu-links-8b91929a-d4ec-4127-b3f4-08b5703b82f6"><div class="menu-links__item"><div class="menu-links__title"><a id="cta-navbar-support-personal-click" href="https://support.malwarebytes.com/hc/en-us" data-type="page" data-id="3844">Malwarebytes Personal Support</a></div><p class="menu-links__desc">Malwarebytes and Teams Customers</p></div><div class="menu-links__item"><div class="menu-links__title"><a id="cta-navbar-support-Threatdown-business-click" href="https://support.threatdown.com/hc/en-us/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cta-navbar-support-Threatdown-business-click" data-type="page" data-id="406">ThreatDown Business Support</a></div><p class="menu-links__desc">Nebula and Oneview Customers</p></div><div class="menu-links__item"><div class="menu-links__title"><a id="cta-navbar-support-community-forums-click" href="https://forums.malwarebytes.com/" data-type="page" data-id="124">Community Forums</a></div></div></div>
</div>
</div>
</div></li>
</ul>						</nav><!-- #site-navigation -->
						<div class="site-header__actions">
							<a href="#" id="cta-navbar-freedownload-main-en-test" class="mb-free-download-btn btn-main btn-primary-yellow u-text-transform-upper" aria-label="Free Download">Free Download</a>
						</div>
													<ul id="secondary-menu-mob" class="secondary-menu u-flex-direction-column u-display-none@min-1150"></ul>
													<!-- Search HTML Mobile -->
								<div class="site-header-searchbox">
						<button class="searchbox-nav-mobile" aria-label="Search in MalwareBytes">Search</button>
						<button class="searchbox-nav" aria-label="Search in MalwareBytes">Search</button>
			<div class="search-modal">
				<label>Search Malwarebytes.com</label>
				<div class="custom-search-form">
					<form role="search" method="get" class="search-form" action="https://www.malwarebytes.com/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Type to search..." value="" name="s" />
	</label>
	<input type="submit" class="search-submit" value="Search" />
</form>
				</div>
			</div>
		</div>
								<!-- Search -->
					</div>
				</div>
			</div>
		</div>
	</header><!-- #masthead -->

	<main id="primary" class="site-main has-default-container blog-page">
				<div class="wp-block-malware-bytes-inner-header">
			<div class="labs-sub-nav">
				<div class="container">
					<div class="labs-sub-nav__row">
						<div class="labs-sub-nav__colum left">
							<form role="search" method="get" class="search-form" action="https://www.malwarebytes.com/blog/">
								<div class="labs-sub-nav__searchbar-wrap">
									<input class="labs-sub-nav__search-input" type="text" name="s" placeholder="Search Labs">
									<button class="labs-sub-nav__search-button" id="cta-labs-rightrail-search-submit-en" aria-label="Search in Malwarebytes">
										<svg xmlns="http://www.w3.org/2000/svg" width="35px" height="35px" viewBox="0 0 24 24" fill="none">
											<g clip-path="url(#clip0_15_152)">
											<rect width="24" height="24" fill="none"></rect>
											<circle cx="10.5" cy="10.5" r="6.5" stroke="#0d3ecc" stroke-linejoin="round"></circle>
											<path d="M19.6464 20.3536C19.8417 20.5488 20.1583 20.5488 20.3536 20.3536C20.5488 20.1583 20.5488 19.8417 20.3536 19.6464L19.6464 20.3536ZM20.3536 19.6464L15.3536 14.6464L14.6464 15.3536L19.6464 20.3536L20.3536 19.6464Z" fill="#0d3ecc"></path>
											</g>
											<defs>
											<clipPath id="clip0_15_152">
												<rect width="24" height="24" fill="#0d3ecc"></rect>
											</clipPath>
											</defs>
										</svg>
									</button>
								</div>
							</form>
						</div>
						<div class="labs-sub-nav__colum right">							
							<div class="subscribe-rss-wrp">
																	<a class="subscribe-btn" href="https://www.malwarebytes.com/newsletter?email=&#038;source=labs" aria-label="Subscribe To Malwarebytes">SUBSCRIBE</a>
																									<a href="https://www.malwarebytes.com/blog/feed/index.xml" target="_blank" aria-label="Feed Link">
										<svg xmlns="http://www.w3.org/2000/svg" fill="#337ab7" width="25px" height="25px" viewBox="0 0 32 32" version="1.1">
											<title>rss</title>
											<path d="M9.565 26.319c0-2.161-1.752-3.913-3.912-3.913s-3.913 1.752-3.913 3.913c0 2.161 1.752 3.913 3.913 3.913s3.912-1.752 3.912-3.913zM20.651 30.231h-5.543c0-7.383-5.985-13.368-13.368-13.368v-5.543c10.444 0 18.911 8.467 18.911 18.911v0zM24.563 30.231c0-12.605-10.218-22.823-22.823-22.823v-5.706c15.756 0 28.529 12.773 28.529 28.529h-5.706z"></path>
										</svg>
									</a>
															</div>							
							<div class="social-wrp">
																	<a class="facebook-icon" href="https://www.facebook.com/Malwarebytes/" aria-label="Facebook Link" target="_blank">
									<svg fill="#4a4a4a" width="30px" height="30px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M21.95 5.005l-3.306-.004c-3.206 0-5.277 2.124-5.277 5.415v2.495H10.05v4.515h3.317l-.004 9.575h4.641l.004-9.575h3.806l-.003-4.514h-3.803v-2.117c0-1.018.241-1.533 1.566-1.533l2.366-.001.01-4.256z"/></svg>
									</a>
																									<a class="twitter-icon" href="https://twitter.com/malwarebytes" aria-label="Twitter Link" target="_blank">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 31.143 25.261">
										<path id="Path_36" data-name="Path 36" d="M47.862,27.261c11.765,0,18.167-9.689,18.167-18.167V8.229a14.064,14.064,0,0,0,3.114-3.287A14.363,14.363,0,0,1,65.51,5.979a6.732,6.732,0,0,0,2.768-3.46A15.87,15.87,0,0,1,64.3,4.076,6.179,6.179,0,0,0,59.627,2a6.5,6.5,0,0,0-6.4,6.4A3.373,3.373,0,0,0,53.4,9.786,17.888,17.888,0,0,1,40.249,3.038a6.626,6.626,0,0,0-.865,3.287,6.874,6.874,0,0,0,2.768,5.364,5.833,5.833,0,0,1-2.941-.865h0A6.323,6.323,0,0,0,44.4,17.053a5.334,5.334,0,0,1-1.73.173,2.944,2.944,0,0,1-1.211-.173,6.555,6.555,0,0,0,6.056,4.5,13.063,13.063,0,0,1-7.959,2.768A4.79,4.79,0,0,1,38,24.146a16.331,16.331,0,0,0,9.862,3.114" transform="translate(-38 -2)" fill="#4a4a4a" fill-rule="evenodd"/>
										</svg>
									</a>
																									<a class="linkedin-icon" href="https://www.linkedin.com/company/malwarebytes" aria-label="LinkedIn Link" target="_blank">
									<svg fill="#4a4a4a"  version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  width="20px"
										height="20px" viewBox="0 0 512 512" xml:space="preserve">
										<g id="7935ec95c421cee6d86eb22ecd125aef">
										<path style="display: inline; fill-rule: evenodd; clip-rule: evenodd;" d="M116.504,500.219V170.654H6.975v329.564H116.504
												L116.504,500.219z M61.751,125.674c38.183,0,61.968-25.328,61.968-56.953c-0.722-32.328-23.785-56.941-61.252-56.941
												C24.994,11.781,0.5,36.394,0.5,68.722c0,31.625,23.772,56.953,60.53,56.953H61.751L61.751,125.674z M177.124,500.219
												c0,0,1.437-298.643,0-329.564H286.67v47.794h-0.727c14.404-22.49,40.354-55.533,99.44-55.533
												c72.085,0,126.116,47.103,126.116,148.333v188.971H401.971V323.912c0-44.301-15.848-74.531-55.497-74.531
												c-30.254,0-48.284,20.38-56.202,40.08c-2.897,7.012-3.602,16.861-3.602,26.711v184.047H177.124L177.124,500.219z">
										</path>
										</g>
										</svg>
									</a>
															</div>
						</div>
					</div>
				</div>
			</div>
		</div>
				<div class="container">
			<div class="u-flex-columns">
				<div class="u-flex-column u-flex-col-lg-8">
					
<article id="post-74941" class="post-74941 post type-post status-publish format-standard has-post-thumbnail hentry category-news category-threats tag-cryptominers tag-custom-format tag-exploit-kits tag-exploits tag-hasherezade tag-hidden-bee tag-hiddenbee tag-infection-chain tag-infection-vector tag-malware-modules tag-miner tag-miners tag-obfuscation tag-payloads tag-steganography tag-underminer tag-underminer-ek">
	<div class="malwarebytes-post-article u-margin-t50 u-margin-b50 u-margin-t50@max-767 u-margin-b50@max-767 u-bg-white">

		
			<div class="post-thumbnail">
				<img width="1000" height="737" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg?w=1000" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="The Hidden Bee infection chain, part 1: the stegano pack" decoding="async" fetchpriority="high" srcset="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg 1000w, https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg?resize=300,221 300w, https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/shutterstock_1341482126.jpg?resize=768,566 768w" sizes="(max-width: 1000px) 100vw, 1000px" />			</div><!-- .post-thumbnail -->

		
		<header class="entry-header blog-head">			
							<div class="blog-list__category">
											<a href="https://www.malwarebytes.com/blog/category/news">News</a>
						 | 						<a href="https://www.malwarebytes.com/blog/category/threats">Threats</a>
										</div>
				<h1 class="entry-title u-margin-b10">The Hidden Bee infection chain, part 1: the stegano pack</h1>				<div class="entry-meta">
					<span class="posted-on">Posted: August 15, 2019</span>
					<span class="byline"> by <span class="author vcard"><a class="url fn n" href="https://www.malwarebytes.com/blog/authors/hasherezade">hasherezade</a></span></span>				</div><!-- .entry-meta -->
					</header><!-- .entry-header -->

		<div class="entry-content">
			<p>About a year ago, <a rel="noreferrer noopener" aria-label="we described Hidden Bee miner delivered by the Underminer Exploit Kit (opens in a new tab)" href="/blog/threat-analysis/2018/07/hidden-bee-miner-delivered-via-improved-drive-by-download-toolkit/" target="_blank">we described the Hidden Bee miner delivered by the Underminer Exploit Kit</a>. </p>    <p>Hidden Bee has a complex and multi-layered internal structure that is unusual among cybercrime toolkits, making it an interesting phenomenon on the threat landscape. That&#8217;s why we&#8217;re dedicating a series of posts to exploring particular elements and updates made during one year of its evolution. </p>    <p>Recently, we decided to revisit this interesting miner, <a rel="noreferrer noopener" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">describing its loader</a> that starts the infection from a single malicious executable. This post will present an alternative loader that is deployed when the infection starts from the Underminer Exploit Kit. It is analogous to the loader we described in the following posts from 2018: [<a rel="noreferrer noopener" href="/blog/threat-analysis/2018/07/hidden-bee-miner-delivered-via-improved-drive-by-download-toolkit/" target="_blank">1</a>] and [<a rel="noreferrer noopener" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">2</a>]. </p>    <h3 class="wp-block-heading" id="mce_22">The dropped payloads: an overview</h3>    <p>The first time we spotted Hidden Bee, it started the infection from a flash exploit. It downloaded and injected two elements with WASM extensions that in reality were executable modules in a custom format. We described them in detail <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">here</a>. </p>    <figure class="wp-block-image aligncenter size-full is-resized"><img decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/queried_urls_.png" class="wp-image-39999" alt="" width="780" height="58"/></figure>     <p>Those elements were the initial loaders, responsible for initiating <a rel="noreferrer noopener" aria-label="the infection chain, that at the end resulted in installing the miner (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">the infection chain that at the end installed the miner</a>.</p>    <p>Nowadays, those elements have changed. If we take a look at the elements dropped by the same EK today, we will no longer find those WASM extensions. Instead, we encounter various multimedia files: a WAV (alternatively two WAVs), a JPEG, and a PNG. </p>    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure>    <p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p>    <h3 class="wp-block-heading" id="mce_22">The !rcx package</h3>    <p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p>    <p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p>    <p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p>    <p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure>     <p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure>     <p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p>    <p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure>     <p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure>     <p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p>    <p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p>    <p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure>     <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure>     <p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure>     <p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and </p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre>. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.    <h3 class="wp-block-heading">Even more hidden</h3>    <p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p>    <p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p>    <p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p>                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure>    <p>Detection of any of the features suggesting a VM results in termination of the component.</p>    <h4 class="wp-block-heading">Downloading new modules</h4>    <p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure>     <p>The raw TCP socket created to communicate using the SLTP protocol:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure>     <p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure>    <p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p>    <p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure>     <p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure>     <p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure>     <p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure>     <h3 class="wp-block-heading" id="mce_36">Inside core.sdb</h3>    <p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p>    <p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p>    <h4 class="wp-block-heading" id="mce_50">Execution flow</h4>    <ol class="wp-block-list"><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <pre class="wp-block-code"><code>DbgBreakPoint</code></pre>, <pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre></li><li>If the module was run with the flag==1:<ol class="wp-block-list"><li>Connects to the first address:  <pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre></li><li>Sets an environment variable <pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol></li><li>If the module was run with the flag!=1:<ol class="wp-block-list"><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre>. This time, appends the victim&#8217;s fingerprint to the URL. Format: <pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre></li><li>Runs the downloaded next stage module.</li></ol></li></ol>    <h4 class="wp-block-heading">Defensive checks</h4>    <p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (</p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre>).    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure>     <p>The blacklist contains popular debuggers and sniffers:</p>    <p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p>    <p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p>    <p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure>     <p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure>     <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure>     <p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure>     <p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure>     <p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure>     <p>Checking the BIOS versions typical for virtual environments:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure>    <h4 class="wp-block-heading" id="mce_43">Obfuscation used</h4>    <p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure>     <p>The decoding algorithm is simple, based on XOR:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure>     <h3 class="wp-block-heading">Inside the images downloader</h3>    <p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p>    <p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p>    <p>First, we can see that the URLs are retrieved from their Base64 form:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure>     <p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p>   <pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre>   <p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p>    <h4 class="wp-block-heading">Decoding the JPG</h4>    <p>After the payload is retrieved, the JPG header is validated.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure>     <p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure>     <p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure>     <p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure>     <p>The !rcx package has a simple header:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure>     <h4 class="wp-block-heading">Decoding the PNG</h4>    <p>Retrieving the content from the PNG is more complex.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure>     <p>First, after downloading, the PNG header is checked:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure>     <p>The function decoding the PNG has the following flow:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure>    <p>The configuration file (config.cfg) contains the URL to another WAV file. </p>    <p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure>     <h4 class="wp-block-heading" id="mce_55">The shellcode: downloading the second WAV</h4>    <p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p>    <p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure>     <p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure>     <p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure>     <h4 class="wp-block-heading" id="mce_27">The second WAV: an executable in proprietary format</h4>    <p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure>     <p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure>     <p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p>    <p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure>     <p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure>     <p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure>     <p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p>    <p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p>    <h3 class="wp-block-heading">The modules with the custom format</h3>    <p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p>    <p>There are changes in the header, as well as improvements in the implementation.</p>    <h4 class="wp-block-heading">Changes in the custom format</h4>    <p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p>    <p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure>     <p>Summing up, we can visualize the new format in the following way:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png"><img loading="lazy" decoding="async" class="wp-image-39745" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png" alt="" width="795" height="412"></a></figure>    <h4 class="wp-block-heading" id="mce_29">The first WAV: a Flash exploit</h4>    <p>The decoded WAV contains a package with two elements embedded: a Flash file (movies.swf) and the configuration file (config.cfg). The decrypted data starts from the magic DWORD 0xCAFEBABE, which we noticed in the code of the previous SWF.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/maybe_decoded.png" class="wp-image-39835" alt="" width="626" height="264"/></figure>     <p>The Flash file (movies.swf) contains an embedded exploit. In the analyzed case, the exploit used is <a rel="noreferrer noopener" aria-label="CVE-2015-5122  (opens in a new tab)" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5122" target="_blank">CVE-2015-5122</a>, however, a different exploit may be used on a different machine:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/exploit_flash.png" class="wp-image-39836" alt="" width="270" height="225"/></figure>     <p>The payload (shellcode) is stored in form of an array (binary version available here: <a rel="noreferrer noopener" aria-label="9aec11ff93b9df14f060f78fbb1b47a2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>):</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":798,"height":260,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The configuration file (config.cfg) contains the URL to another WAV file. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":471,"height":401,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_55">The shellcode: downloading the second WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":700,"height":362,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":428,"height":319,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":701,"height":384,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_27">The second WAV: an executable in proprietary format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":456,"height":216,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":451,"height":152,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":521,"height":295,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":600,"height":446,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":524,"height":321,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>The modules with the custom format</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>There are changes in the header, as well as improvements in the implementation.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Changes in the custom format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":324,"height":382,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Summing up, we can visualize the new format in the following way:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png"><img loading="lazy" decoding="async" class="wp-image-39742" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png" alt="" width="1033" height="367"></a></figure>    <p>Looking at the decompiled code, we see some interesting constants. For example, &#8211;889275714 in hex is 0xCAFEBABE. As we found during <a rel="noreferrer noopener" aria-label="analysis of other Hidden Bee's elements (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">analysis of other Hidden Bee elements</a>, this DWORD was used by the same authors before as a magic number identifying one of the custom formats.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/cafebabe.png" class="wp-image-39743" alt="" width="448" height="570"/></figure>     <p>Internally, there are references to a function from another module: E_ENCRYPT_process_bytes(). Inside this function, we see calls suggesting that the <a rel="noreferrer noopener" aria-label="Rabbit Cipher (opens in a new tab)" href="https://en.wikipedia.org/wiki/Rabbit_(cipher)" target="_blank">Rabbit Cipher</a> has been used:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/rabbit_cipher.png" class="wp-image-39746" alt="" width="466" height="460"/></figure>     <p>Rabbit uses a 128-bit key (the same length as the MD5 hash that was mentioned before) and a 64-bit initialization vector. (In different runs, a different encryption algorithm may be selected.)</p>    <p>After the decoding process is complete, the revealed content is loaded:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":795,"height":412,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png"><img loading="lazy" decoding="async" class="wp-image-39745" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png" alt="" width="795" height="412"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_29">The first WAV: a Flash exploit</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The decoded WAV contains a package with two elements embedded: a Flash file (movies.swf) and the configuration file (config.cfg). The decrypted data starts from the magic DWORD 0xCAFEBABE, which we noticed in the code of the previous SWF.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":264,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/maybe_decoded.png" class="wp-image-39835" alt="" width="626" height="264"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file (movies.swf) contains an embedded exploit. In the analyzed case, the exploit used is <a rel="noreferrer noopener" aria-label="CVE-2015-5122  (opens in a new tab)" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5122" target="_blank">CVE-2015-5122</a>, however, a different exploit may be used on a different machine:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":270,"height":225,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/exploit_flash.png" class="wp-image-39836" alt="" width="270" height="225"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The payload (shellcode) is stored in form of an array (binary version available here: <a rel="noreferrer noopener" aria-label="9aec11ff93b9df14f060f78fbb1b47a2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":798,"height":260,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The configuration file (config.cfg) contains the URL to another WAV file. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":471,"height":401,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_55">The shellcode: downloading the second WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":700,"height":362,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":428,"height":319,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":701,"height":384,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_27">The second WAV: an executable in proprietary format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":456,"height":216,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":451,"height":152,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":521,"height":295,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":600,"height":446,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":524,"height":321,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>The modules with the custom format</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>There are changes in the header, as well as improvements in the implementation.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Changes in the custom format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":324,"height":382,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Summing up, we can visualize the new format in the following way:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png"><img loading="lazy" decoding="async" class="wp-image-39841" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png" alt="" width="863" height="94"></a></figure>    <p>The algorithms used to encrypt the content of the first WAV may vary and sometimes the algorithm is supplied as one of the parameters. After the content is fetched, the data from the WAV files is decoded using one of the available algorithms:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_read_content.png" class="wp-image-39843" alt="" width="605" height="121"/></figure>     <p>We can see that the expected content is a Flash file that is then loaded:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/run_new_clip.png" class="wp-image-39844" alt="" width="644" height="104"/></figure>     <h4 class="wp-block-heading">The &#8220;decode&#8221; function</h4>    <p>The function &#8220;decode&#8221; is imported from the package &#8220;com.google&#8221;:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode.png" class="wp-image-39741" alt="" width="475" height="54"/></figure>     <p>The full decompiled code is available <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://gist.github.com/malwarezone/3aea44e1d4c66821f92b1092461fb815" target="_blank">here</a>.</p>    <p>When we look inside, we see that the code is slightly obfuscated:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":1033,"height":367,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png"><img loading="lazy" decoding="async" class="wp-image-39742" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png" alt="" width="1033" height="367"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Looking at the decompiled code, we see some interesting constants. For example, &#8211;889275714 in hex is 0xCAFEBABE. As we found during <a rel="noreferrer noopener" aria-label="analysis of other Hidden Bee's elements (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">analysis of other Hidden Bee elements</a>, this DWORD was used by the same authors before as a magic number identifying one of the custom formats.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":448,"height":570,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/cafebabe.png" class="wp-image-39743" alt="" width="448" height="570"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Internally, there are references to a function from another module: E_ENCRYPT_process_bytes(). Inside this function, we see calls suggesting that the <a rel="noreferrer noopener" aria-label="Rabbit Cipher (opens in a new tab)" href="https://en.wikipedia.org/wiki/Rabbit_(cipher)" target="_blank">Rabbit Cipher</a> has been used:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":466,"height":460,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/rabbit_cipher.png" class="wp-image-39746" alt="" width="466" height="460"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Rabbit uses a 128-bit key (the same length as the MD5 hash that was mentioned before) and a 64-bit initialization vector. (In different runs, a different encryption algorithm may be selected.)</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>After the decoding process is complete, the revealed content is loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":795,"height":412,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png"><img loading="lazy" decoding="async" class="wp-image-39745" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png" alt="" width="795" height="412"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_29">The first WAV: a Flash exploit</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The decoded WAV contains a package with two elements embedded: a Flash file (movies.swf) and the configuration file (config.cfg). The decrypted data starts from the magic DWORD 0xCAFEBABE, which we noticed in the code of the previous SWF.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":264,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/maybe_decoded.png" class="wp-image-39835" alt="" width="626" height="264"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file (movies.swf) contains an embedded exploit. In the analyzed case, the exploit used is <a rel="noreferrer noopener" aria-label="CVE-2015-5122  (opens in a new tab)" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5122" target="_blank">CVE-2015-5122</a>, however, a different exploit may be used on a different machine:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":270,"height":225,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/exploit_flash.png" class="wp-image-39836" alt="" width="270" height="225"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The payload (shellcode) is stored in form of an array (binary version available here: <a rel="noreferrer noopener" aria-label="9aec11ff93b9df14f060f78fbb1b47a2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":798,"height":260,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The configuration file (config.cfg) contains the URL to another WAV file. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":471,"height":401,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_55">The shellcode: downloading the second WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":700,"height":362,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":428,"height":319,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":701,"height":384,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_27">The second WAV: an executable in proprietary format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":456,"height":216,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":451,"height":152,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":521,"height":295,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":600,"height":446,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":524,"height":321,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>The modules with the custom format</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>There are changes in the header, as well as improvements in the implementation.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Changes in the custom format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":324,"height":382,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Summing up, we can visualize the new format in the following way:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/salt_passed.png"><img loading="lazy" decoding="async" class="wp-image-38764" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/salt_passed.png" alt="" width="886" height="298"></a></figure>    <h4 class="wp-block-heading" id="mce_22">Alternative case: two WAV files</h4>    <p>Sometimes, rather than embedding the WAV containing the Flash exploit, authors use another model of delivering it. They store the URL to the WAV, and then they retrieve the file.</p>    <p>In the below example, we can see how this model is applied to Hidden Bee. The salt, along with the WAV URL, are both stored in the Javascript embedded in the HTML:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio_res.png" class="wp-image-39839" alt="" width="731" height="331"/></figure>     <p>The Flash file first loads it and then decodes as the next step:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio_load.png" class="wp-image-39840" alt="" width="595" height="387"/></figure>     <p>Looking at the traffic capture, we can see that in this case, not one, but <em>two</em> WAV files are downloaded:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":863,"height":94,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png"><img loading="lazy" decoding="async" class="wp-image-39841" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png" alt="" width="863" height="94"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The algorithms used to encrypt the content of the first WAV may vary and sometimes the algorithm is supplied as one of the parameters. After the content is fetched, the data from the WAV files is decoded using one of the available algorithms:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":605,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_read_content.png" class="wp-image-39843" alt="" width="605" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that the expected content is a Flash file that is then loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":644,"height":104,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/run_new_clip.png" class="wp-image-39844" alt="" width="644" height="104"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>The &#8220;decode&#8221; function</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The function &#8220;decode&#8221; is imported from the package &#8220;com.google&#8221;:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":475,"height":54,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode.png" class="wp-image-39741" alt="" width="475" height="54"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The full decompiled code is available <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://gist.github.com/malwarezone/3aea44e1d4c66821f92b1092461fb815" target="_blank">here</a>.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>When we look inside, we see that the code is slightly obfuscated:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1033,"height":367,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png"><img loading="lazy" decoding="async" class="wp-image-39742" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png" alt="" width="1033" height="367"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Looking at the decompiled code, we see some interesting constants. For example, &#8211;889275714 in hex is 0xCAFEBABE. As we found during <a rel="noreferrer noopener" aria-label="analysis of other Hidden Bee's elements (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">analysis of other Hidden Bee elements</a>, this DWORD was used by the same authors before as a magic number identifying one of the custom formats.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":448,"height":570,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/cafebabe.png" class="wp-image-39743" alt="" width="448" height="570"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Internally, there are references to a function from another module: E_ENCRYPT_process_bytes(). Inside this function, we see calls suggesting that the <a rel="noreferrer noopener" aria-label="Rabbit Cipher (opens in a new tab)" href="https://en.wikipedia.org/wiki/Rabbit_(cipher)" target="_blank">Rabbit Cipher</a> has been used:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":466,"height":460,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/rabbit_cipher.png" class="wp-image-39746" alt="" width="466" height="460"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Rabbit uses a 128-bit key (the same length as the MD5 hash that was mentioned before) and a 64-bit initialization vector. (In different runs, a different encryption algorithm may be selected.)</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>After the decoding process is complete, the revealed content is loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":795,"height":412,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png"><img loading="lazy" decoding="async" class="wp-image-39745" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png" alt="" width="795" height="412"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_29">The first WAV: a Flash exploit</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The decoded WAV contains a package with two elements embedded: a Flash file (movies.swf) and the configuration file (config.cfg). The decrypted data starts from the magic DWORD 0xCAFEBABE, which we noticed in the code of the previous SWF.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":264,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/maybe_decoded.png" class="wp-image-39835" alt="" width="626" height="264"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file (movies.swf) contains an embedded exploit. In the analyzed case, the exploit used is <a rel="noreferrer noopener" aria-label="CVE-2015-5122  (opens in a new tab)" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5122" target="_blank">CVE-2015-5122</a>, however, a different exploit may be used on a different machine:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":270,"height":225,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/exploit_flash.png" class="wp-image-39836" alt="" width="270" height="225"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The payload (shellcode) is stored in form of an array (binary version available here: <a rel="noreferrer noopener" aria-label="9aec11ff93b9df14f060f78fbb1b47a2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":798,"height":260,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The configuration file (config.cfg) contains the URL to another WAV file. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":471,"height":401,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_55">The shellcode: downloading the second WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":700,"height":362,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":428,"height":319,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":701,"height":384,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_27">The second WAV: an executable in proprietary format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":456,"height":216,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":451,"height":152,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":521,"height":295,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":600,"height":446,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":524,"height":321,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>The modules with the custom format</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>There are changes in the header, as well as improvements in the implementation.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Changes in the custom format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":324,"height":382,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Summing up, we can visualize the new format in the following way:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/dropped_payloads2.png"><img loading="lazy" decoding="async" class="wp-image-38761" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/dropped_payloads2.png" alt="" width="959" height="122"></a></figure>    <p>We will start our journey of Hidden Bee analysis by looking at these files. Then, we will move to see the code responsible for processing them in order to reveal their hidden purpose.</p>    <p>The roadmap of the full described package:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/steganopack_diag.png" class="wp-image-40119" alt="" width="641" height="803"/></figure>     <h4 class="wp-block-heading" id="mce_48">The downloaded WAV</h4>    <p>The WAV file sounds like grey noise, and we suspect that it is meant to hide some binary belonging to the malware. </p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/wav_visualization.png" class="wp-image-39768" alt="" width="830" height="151"/></figure>     <p>The data is unreadable, probably encrypted or obfuscated:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/wav_bgn.png" class="wp-image-38748" alt="" width="626" height="197"/></figure>     <p>We also found a repeating pattern inside, which looks like an encrypted padding. The size of the chunk is 8 bytes.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/wav_pattern-2.png" class="wp-image-38751" alt="" width="609" height="97"/></figure>     <p>This time, using the repeating pattern as an XOR key didn&#8217;t help in getting a readable result, so probably some more complex block cipher was used.</p>    <h4 class="wp-block-heading">The JPG</h4>    <p>Below is a sample JPG, downloaded from the URL in the format: <code>/views/[unique_string].jpg</code></p>    <p>In contrast to the WAV content, the JPG always looks like a valid image. (Interestingly, all the JPGs we observed have a consistent theme of manga-styled girls.) However, if we take a closer look at the image, we can see that some data is appended at the end.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/malware_girl.png" class="wp-image-38726" alt="" width="533" height="467"/></figure>     <p>Let&#8217;s analyze the JPG and try to extract the payload. </p>    <p>First, I opened the image in a hexeditor (i.e. HxD). The size of the full image is 156,005 bytes. The last 118,762 bytes belong to the malware. So, we need remove the first 37,243 bytes (156,005-118,762=37,243) in order to get the payload.</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/payload_jpg.png" class="wp-image-38728" alt="" width="633" height="183"/></figure>     <p>The payload does not look like a valid code, so it is probably obfuscated. Let&#8217;s try the easiest option first and see if there are any candidates for the XOR key. We can see that the payload has padding at the end:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/payload_padding.png" class="wp-image-38729" alt="" width="627" height="129"/></figure>     <p>Let&#8217;s try to apply the repeating character (in the given example it is 0xE5) as an XOR key. This is the result (<a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=1953032199142ea8c5872107da8f2297" target="_blank">1953032199142ea8c5872107da8f2297</a>):</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_package.png" class="wp-image-38730" alt="" width="626" height="245"/></figure>     <p>Repeating the experiment on various payloads, we can see that the result always start from the keyword <code>!rcx</code>. As we know from analyzing <a rel="noreferrer noopener" aria-label="other elements of Hidden Bee (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">other elements of Hidden Bee</a>, the authors of this malware decided to use various custom formats named after <a rel="noreferrer noopener" aria-label="64 bit Intel registers (opens in a new tab)" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x64-architecture" target="_blank">64-bit Intel registers</a>. We also encountered packages starting from </p><pre class="wp-block-code"><code>!rbx</code></pre>  and <code>!rsi</code> at different layers. So, this is the first element in the chain that uses this convention.    <p>When we load the <code>!rcx</code> module into IDA, we can confirm that it contains valid code. More detailed explanation about the </p><pre class="wp-block-code"><code>!rcx</code></pre>  format will be given later on in this article.    <h4 class="wp-block-heading" id="mce_79">The PNG</h4>    <p>Let&#8217;s have a look at a sample PNG, download from the &#8220;captcha.png&#8221; (URL format: <code></code>):</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/captcha_png.png" class="wp-image-38763" alt="" width="429" height="238"/></figure>     <p>Although it is a PNG in a valid format, it looks like noise. It probably represents bytes of some encrypted data. An attempt of converting PNG to raw bytes didn&#8217;t give any readable results. We need to analyze the code in order to discover what it hides.</p>    <h3 class="wp-block-heading" id="mce_73">Code analysis: the initial SWF file </h3>    <p>The initial SWF file is embedded on the website and responsible for serving the exploit. If we look inside it, we will not find anything malicious at first. However, among the binary data we can find another suspicious WAV as an audio asset:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/assets.png" class="wp-image-38752" alt="" width="395" height="197"/></figure>     <p>The beginning of the file:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/audio_in_swf.png" class="wp-image-38753" alt="" width="743" height="128"/></figure>     <p>This SWF file also contains a decoder for it:</p>    <figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/decide_wav.png" class="wp-image-38754" alt="" width="614" height="548"/></figure>     <p>The function &#8220;decode&#8221; takes four parameters. The first of them is the byte array containing the WAV asset: That is the content to be decoded. The second argument is an MD5 (the &#8220;setup&#8221; function is an MD5 implementation) made of concatenation of the AppId and the AppToken: That is probably the encryption key. The third parameter is a salt (probably the initialization vector of the crypto).</p>    <p>The salt is fetched from the HTML page, where the Flash component is embedded:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":886,"height":298,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/salt_passed.png"><img loading="lazy" decoding="async" class="wp-image-38764" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/salt_passed.png" alt="" width="886" height="298"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_22">Alternative case: two WAV files</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Sometimes, rather than embedding the WAV containing the Flash exploit, authors use another model of delivering it. They store the URL to the WAV, and then they retrieve the file.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>In the below example, we can see how this model is applied to Hidden Bee. The salt, along with the WAV URL, are both stored in the Javascript embedded in the HTML:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":731,"height":331,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio_res.png" class="wp-image-39839" alt="" width="731" height="331"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file first loads it and then decodes as the next step:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":595,"height":387,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio_load.png" class="wp-image-39840" alt="" width="595" height="387"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Looking at the traffic capture, we can see that in this case, not one, but <em>two</em> WAV files are downloaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":863,"height":94,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png"><img loading="lazy" decoding="async" class="wp-image-39841" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png" alt="" width="863" height="94"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The algorithms used to encrypt the content of the first WAV may vary and sometimes the algorithm is supplied as one of the parameters. After the content is fetched, the data from the WAV files is decoded using one of the available algorithms:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":605,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_read_content.png" class="wp-image-39843" alt="" width="605" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that the expected content is a Flash file that is then loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":644,"height":104,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/run_new_clip.png" class="wp-image-39844" alt="" width="644" height="104"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>The &#8220;decode&#8221; function</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The function &#8220;decode&#8221; is imported from the package &#8220;com.google&#8221;:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":475,"height":54,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode.png" class="wp-image-39741" alt="" width="475" height="54"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The full decompiled code is available <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://gist.github.com/malwarezone/3aea44e1d4c66821f92b1092461fb815" target="_blank">here</a>.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>When we look inside, we see that the code is slightly obfuscated:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1033,"height":367,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png"><img loading="lazy" decoding="async" class="wp-image-39742" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png" alt="" width="1033" height="367"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Looking at the decompiled code, we see some interesting constants. For example, &#8211;889275714 in hex is 0xCAFEBABE. As we found during <a rel="noreferrer noopener" aria-label="analysis of other Hidden Bee's elements (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">analysis of other Hidden Bee elements</a>, this DWORD was used by the same authors before as a magic number identifying one of the custom formats.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":448,"height":570,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/cafebabe.png" class="wp-image-39743" alt="" width="448" height="570"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Internally, there are references to a function from another module: E_ENCRYPT_process_bytes(). Inside this function, we see calls suggesting that the <a rel="noreferrer noopener" aria-label="Rabbit Cipher (opens in a new tab)" href="https://en.wikipedia.org/wiki/Rabbit_(cipher)" target="_blank">Rabbit Cipher</a> has been used:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":466,"height":460,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/rabbit_cipher.png" class="wp-image-39746" alt="" width="466" height="460"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Rabbit uses a 128-bit key (the same length as the MD5 hash that was mentioned before) and a 64-bit initialization vector. (In different runs, a different encryption algorithm may be selected.)</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>After the decoding process is complete, the revealed content is loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":795,"height":412,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png"><img loading="lazy" decoding="async" class="wp-image-39745" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png" alt="" width="795" height="412"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_29">The first WAV: a Flash exploit</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The decoded WAV contains a package with two elements embedded: a Flash file (movies.swf) and the configuration file (config.cfg). The decrypted data starts from the magic DWORD 0xCAFEBABE, which we noticed in the code of the previous SWF.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":264,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/maybe_decoded.png" class="wp-image-39835" alt="" width="626" height="264"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file (movies.swf) contains an embedded exploit. In the analyzed case, the exploit used is <a rel="noreferrer noopener" aria-label="CVE-2015-5122  (opens in a new tab)" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5122" target="_blank">CVE-2015-5122</a>, however, a different exploit may be used on a different machine:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":270,"height":225,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/exploit_flash.png" class="wp-image-39836" alt="" width="270" height="225"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The payload (shellcode) is stored in form of an array (binary version available here: <a rel="noreferrer noopener" aria-label="9aec11ff93b9df14f060f78fbb1b47a2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":798,"height":260,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The configuration file (config.cfg) contains the URL to another WAV file. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":471,"height":401,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_55">The shellcode: downloading the second WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":700,"height":362,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":428,"height":319,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":701,"height":384,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_27">The second WAV: an executable in proprietary format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":456,"height":216,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":451,"height":152,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":521,"height":295,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":600,"height":446,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":524,"height":321,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>The modules with the custom format</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>There are changes in the header, as well as improvements in the implementation.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Changes in the custom format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":324,"height":382,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Summing up, we can visualize the new format in the following way:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
    <figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_png.png"><img loading="lazy" decoding="async" class="wp-image-39866" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_png.png" alt="" width="780" height="194"></a></figure>    <p>The WAV files are downloaded by iexplore.exe, the browser where the exploit is run. In contrast, the images are downloaded at later stages of infection. For example, the JPG is always downloaded from the dllhost.exe process. The PNG is often downloaded from yet another process.</p>    <p>In some runs, we observed the PNG to be downloaded instead of the JPG:</p>   <!-- wp:image --> <!-- wp:image {"align":"center","width":959,"height":122,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/dropped_payloads2.png"><img loading="lazy" decoding="async" class="wp-image-38761" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/dropped_payloads2.png" alt="" width="959" height="122"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>We will start our journey of Hidden Bee analysis by looking at these files. Then, we will move to see the code responsible for processing them in order to reveal their hidden purpose.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The roadmap of the full described package:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":641,"height":803,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/steganopack_diag.png" class="wp-image-40119" alt="" width="641" height="803"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_48">The downloaded WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The WAV file sounds like grey noise, and we suspect that it is meant to hide some binary belonging to the malware. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":830,"height":151,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/wav_visualization.png" class="wp-image-39768" alt="" width="830" height="151"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The data is unreadable, probably encrypted or obfuscated:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":197,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/wav_bgn.png" class="wp-image-38748" alt="" width="626" height="197"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We also found a repeating pattern inside, which looks like an encrypted padding. The size of the chunk is 8 bytes.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":97,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/wav_pattern-2.png" class="wp-image-38751" alt="" width="609" height="97"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This time, using the repeating pattern as an XOR key didn&#8217;t help in getting a readable result, so probably some more complex block cipher was used.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>The JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Below is a sample JPG, downloaded from the URL in the format: <code>/views/[unique_string].jpg</code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>In contrast to the WAV content, the JPG always looks like a valid image. (Interestingly, all the JPGs we observed have a consistent theme of manga-styled girls.) However, if we take a closer look at the image, we can see that some data is appended at the end.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":533,"height":467,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/malware_girl.png" class="wp-image-38726" alt="" width="533" height="467"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Let&#8217;s analyze the JPG and try to extract the payload. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, I opened the image in a hexeditor (i.e. HxD). The size of the full image is 156,005 bytes. The last 118,762 bytes belong to the malware. So, we need remove the first 37,243 bytes (156,005-118,762=37,243) in order to get the payload.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":633,"height":183,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/payload_jpg.png" class="wp-image-38728" alt="" width="633" height="183"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The payload does not look like a valid code, so it is probably obfuscated. Let&#8217;s try the easiest option first and see if there are any candidates for the XOR key. We can see that the payload has padding at the end:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":627,"height":129,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/payload_padding.png" class="wp-image-38729" alt="" width="627" height="129"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Let&#8217;s try to apply the repeating character (in the given example it is 0xE5) as an XOR key. This is the result (<a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=1953032199142ea8c5872107da8f2297" target="_blank">1953032199142ea8c5872107da8f2297</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_package.png" class="wp-image-38730" alt="" width="626" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Repeating the experiment on various payloads, we can see that the result always start from the keyword <code>!rcx</code>. As we know from analyzing <a rel="noreferrer noopener" aria-label="other elements of Hidden Bee (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">other elements of Hidden Bee</a>, the authors of this malware decided to use various custom formats named after <a rel="noreferrer noopener" aria-label="64 bit Intel registers (opens in a new tab)" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x64-architecture" target="_blank">64-bit Intel registers</a>. We also encountered packages starting from <!-- wp:code --></p><pre class="wp-block-code"><code>!rbx</code></pre><!-- /wp:code -->  and <code>!rsi</code> at different layers. So, this is the first element in the chain that uses this convention.<!-- /wp:paragraph -->    <!-- wp:paragraph --><p>When we load the <code>!rcx</code> module into IDA, we can confirm that it contains valid code. More detailed explanation about the <!-- wp:code --></p><pre class="wp-block-code"><code>!rcx</code></pre><!-- /wp:code -->  format will be given later on in this article.<!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_79">The PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s have a look at a sample PNG, download from the &#8220;captcha.png&#8221; (URL format: <code></code>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":429,"height":238,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/captcha_png.png" class="wp-image-38763" alt="" width="429" height="238"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Although it is a PNG in a valid format, it looks like noise. It probably represents bytes of some encrypted data. An attempt of converting PNG to raw bytes didn&#8217;t give any readable results. We need to analyze the code in order to discover what it hides.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_73">Code analysis: the initial SWF file </h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The initial SWF file is embedded on the website and responsible for serving the exploit. If we look inside it, we will not find anything malicious at first. However, among the binary data we can find another suspicious WAV as an audio asset:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":395,"height":197,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/assets.png" class="wp-image-38752" alt="" width="395" height="197"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The beginning of the file:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":743,"height":128,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/audio_in_swf.png" class="wp-image-38753" alt="" width="743" height="128"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This SWF file also contains a decoder for it:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":548,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/decide_wav.png" class="wp-image-38754" alt="" width="614" height="548"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function &#8220;decode&#8221; takes four parameters. The first of them is the byte array containing the WAV asset: That is the content to be decoded. The second argument is an MD5 (the &#8220;setup&#8221; function is an MD5 implementation) made of concatenation of the AppId and the AppToken: That is probably the encryption key. The third parameter is a salt (probably the initialization vector of the crypto).</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The salt is fetched from the HTML page, where the Flash component is embedded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":886,"height":298,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/salt_passed.png"><img loading="lazy" decoding="async" class="wp-image-38764" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/salt_passed.png" alt="" width="886" height="298"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_22">Alternative case: two WAV files</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Sometimes, rather than embedding the WAV containing the Flash exploit, authors use another model of delivering it. They store the URL to the WAV, and then they retrieve the file.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>In the below example, we can see how this model is applied to Hidden Bee. The salt, along with the WAV URL, are both stored in the Javascript embedded in the HTML:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":731,"height":331,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio_res.png" class="wp-image-39839" alt="" width="731" height="331"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file first loads it and then decodes as the next step:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":595,"height":387,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio_load.png" class="wp-image-39840" alt="" width="595" height="387"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Looking at the traffic capture, we can see that in this case, not one, but <em>two</em> WAV files are downloaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":863,"height":94,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png"><img loading="lazy" decoding="async" class="wp-image-39841" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/external_audio1.png" alt="" width="863" height="94"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The algorithms used to encrypt the content of the first WAV may vary and sometimes the algorithm is supplied as one of the parameters. After the content is fetched, the data from the WAV files is decoded using one of the available algorithms:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":605,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_read_content.png" class="wp-image-39843" alt="" width="605" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that the expected content is a Flash file that is then loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":644,"height":104,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/run_new_clip.png" class="wp-image-39844" alt="" width="644" height="104"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>The &#8220;decode&#8221; function</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The function &#8220;decode&#8221; is imported from the package &#8220;com.google&#8221;:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":475,"height":54,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode.png" class="wp-image-39741" alt="" width="475" height="54"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The full decompiled code is available <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://gist.github.com/malwarezone/3aea44e1d4c66821f92b1092461fb815" target="_blank">here</a>.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>When we look inside, we see that the code is slightly obfuscated:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1033,"height":367,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png"><img loading="lazy" decoding="async" class="wp-image-39742" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/google_decode_obf.png" alt="" width="1033" height="367"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Looking at the decompiled code, we see some interesting constants. For example, &#8211;889275714 in hex is 0xCAFEBABE. As we found during <a rel="noreferrer noopener" aria-label="analysis of other Hidden Bee's elements (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">analysis of other Hidden Bee elements</a>, this DWORD was used by the same authors before as a magic number identifying one of the custom formats.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":448,"height":570,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/cafebabe.png" class="wp-image-39743" alt="" width="448" height="570"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Internally, there are references to a function from another module: E_ENCRYPT_process_bytes(). Inside this function, we see calls suggesting that the <a rel="noreferrer noopener" aria-label="Rabbit Cipher (opens in a new tab)" href="https://en.wikipedia.org/wiki/Rabbit_(cipher)" target="_blank">Rabbit Cipher</a> has been used:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":466,"height":460,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/rabbit_cipher.png" class="wp-image-39746" alt="" width="466" height="460"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Rabbit uses a 128-bit key (the same length as the MD5 hash that was mentioned before) and a 64-bit initialization vector. (In different runs, a different encryption algorithm may be selected.)</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>After the decoding process is complete, the revealed content is loaded:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":795,"height":412,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png"><img loading="lazy" decoding="async" class="wp-image-39745" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/07/load_on_complete.png" alt="" width="795" height="412"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_29">The first WAV: a Flash exploit</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The decoded WAV contains a package with two elements embedded: a Flash file (movies.swf) and the configuration file (config.cfg). The decrypted data starts from the magic DWORD 0xCAFEBABE, which we noticed in the code of the previous SWF.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":626,"height":264,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/maybe_decoded.png" class="wp-image-39835" alt="" width="626" height="264"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The Flash file (movies.swf) contains an embedded exploit. In the analyzed case, the exploit used is <a rel="noreferrer noopener" aria-label="CVE-2015-5122  (opens in a new tab)" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-5122" target="_blank">CVE-2015-5122</a>, however, a different exploit may be used on a different machine:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":270,"height":225,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/exploit_flash.png" class="wp-image-39836" alt="" width="270" height="225"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The payload (shellcode) is stored in form of an array (binary version available here: <a rel="noreferrer noopener" aria-label="9aec11ff93b9df14f060f78fbb1b47a2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":798,"height":260,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png"><img loading="lazy" decoding="async" class="wp-image-39837" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/payload32.png" alt="" width="798" height="260"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The configuration file (config.cfg) contains the URL to another WAV file. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The payload is padded with NOP (0x90) bytes, and the parameters, including the configuration, are filled there before the payload runs.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":471,"height":401,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/params_filled-1.png" class="wp-image-40013" alt="" width="471" height="401"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_55">The shellcode: downloading the second WAV</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The second WAV, in contrast to the first one, is always downloaded and never embedded. It is retrieved by the &#8220;PayloadWin32&#8221; shellcode (<a rel="noreferrer noopener" href="https://malshare.com/sample.php?action=detail&amp;hash=9aec11ff93b9df14f060f78fbb1b47a2" target="_blank">9aec11ff93b9df14f060f78fbb1b47a2</a>), deployed after the successful exploitation.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Looking inside this shellcode, we find the function that is responsible for downloading and decrypting another WAV. The shellcode uses parameters that were filled by the previous layer. This buffer contains the URL that will be queried and the key that will be used for decryption of the payload. It loads functions from wininet.dll using their checksums. After the initialization steps, it queries the supplied URL. The expected result is a buffer with a header typical for WAV files.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":700,"height":362,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/download_wav.png" class="wp-image-39979" alt="" width="700" height="362"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>As we already suspected, the data of the WAV (starting from the offset 0x2C) contains the encrypted content. Indeed, blocks that are 8 bytes long are decrypted in a loop:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":428,"height":319,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypting_loop.png" class="wp-image-39980" alt="" width="428" height="319"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After the decryption is complete, the next module will be revealed. It is interesting to take a look at the expected header of the payload to learn which format is used for the output element. This time, the decoded data is supposed to start with the following magic numbers: 0x01, 0x04, &#8230;, 0x10.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":701,"height":384,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_and_call_payload.png" class="wp-image-39981" alt="" width="701" height="384"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_27">The second WAV: an executable in proprietary format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>On the illustration below, we can see how the data of the WAV looks after being decrypted (<a rel="noreferrer noopener" aria-label="9b37c9ec19a53007d450b9b9c8febbe2 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=9b37c9ec19a53007d450b9b9c8febbe2" target="_blank">9b37c9ec19a53007d450b9b9c8febbe2</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":456,"height":216,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_riff_stage2.png" class="wp-image-39889" alt="" width="456" height="216"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This is an executable component that is loaded into Internet Explorer. After it decodes the imports, it starts to look much more familiar:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":451,"height":152,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/riff_after_decode.png" class="wp-image-39890" alt="" width="451" height="152"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>We can see that it follows an analogical structure to the one described in last year&#8217;s article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This module is first executed within Internet Explorer. Then, it creates another process (dllhost.exe) in a suspended state:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":521,"height":295,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/create_process_from_payl.png" class="wp-image-39892" alt="" width="521" height="295"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It injects its original copy there (<a rel="noreferrer noopener" aria-label="769a05f0eddd6ef2ebdd13618b244758 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=769a05f0eddd6ef2ebdd13618b244758" target="_blank">769a05f0eddd6ef2ebdd13618b244758</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":600,"height":446,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/encoded_version_injected.png" class="wp-image-39894" alt="" width="600" height="446"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then it redirects execution to its loading function. Below, we can see the Entry Point of the implanted module within dllhost.exe.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":524,"height":321,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/implanted_module_ep.png" class="wp-image-39893" alt="" width="524" height="321"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>A detailed analysis of the execution flow of this module and its format will be given later in the article.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>At this point, it is important to note that the dllhost.exe is the module that further downloads the aforementioned images.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>The modules with the custom format</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>The module with the custom format is analogous to the one <a rel="noreferrer noopener" aria-label="described before (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/" target="_blank">described before</a>. However, we can see that it has significantly evolved. </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>There are changes in the header, as well as improvements in the implementation.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Changes in the custom format</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The new header is similar to the <a rel="noreferrer noopener" aria-label=" previous one (opens in a new tab)" href="/blog/threat-analysis/2018/08/reversing-malware-in-a-custom-format-hidden-bee-elements/#" target="_blank">previous one</a>. The few details that have changed are: the magic number at the beginning (from 0x1000<strong>03</strong>01 to 0x1000<strong>04</strong>01), and the format in which the DLLs are stored (the length of a DLL name has been added). That&#8217;s why we will refer to this format as &#8220;0x10000401 format.&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another change is that now the names of the DLLs are obfuscated by a simple XOR with 1 byte character. They are deobfuscated just before being loaded.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":324,"height":382,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/loading_func_by_name.png" class="wp-image-39899" alt="" width="324" height="382"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Summing up, we can visualize the new format in the following way:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":804,"height":597,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png"><img loading="lazy" decoding="async" class="wp-image-39901" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/new_hdr-2.png" alt="" width="804" height="597"></a></figure> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4 id="mce_43">Obfuscation used</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>This time, authors decide to obfuscate all the strings used inside the module. Now all the strings are decoded just before use.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":335,"height":121,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_use.png" class="wp-image-39868" alt="" width="335" height="121"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The decoding algorithm is simple, based on XOR:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":364,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_memory.png" class="wp-image-39929" alt="" width="403" height="364"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3>Inside the images downloader</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>Let&#8217;s look inside the first module in the 0x10000401 format that we encountered. This module is an initial stage, and its role is to download and unpack the other components. One such component is in a CAB format (that&#8217;s why we can see the Cabinet.dll among the imported DLLs). </p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of this module is similar to the first &#8220;WASM&#8221; mentioned in our post a year ago. However, the current version is not only better protected, but also comes with some improvements. This time the downloaded content is hidden in the images. So, analyzing this element can help us to understand how the used stenography works.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>First, we can see that the URLs are retrieved from their Base64 form:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":577,"height":125,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decoding_urls.png" class="wp-image-39871" alt="" width="577" height="125"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>This string decodes to a list containing URLs of the PNG and JPG files that are going to be downloaded. For each sample, this set is unique. None of the  URLs can be reused: the server gives a response only once. An example of a URL set:</p><!-- /wp:paragraph -->   <!-- wp:preformatted --><pre class="wp-block-preformatted">http://38.75.137.9:9088/pubs/wiki.php?id=937a4eadd6f5a94b3738a58dcc79ca13 http://38.75.137.9:9088/images/captcha.png?mod=attachment&amp;u=357e27e8af72925144ec1db2421d0cc5&amp;lt http://38.75.137.9:9088/views/q5ul78uv4b4q8bg8d95canrsns.jpg </pre><!-- /wp:preformatted -->   <!-- wp:paragraph --><p>So, we can confirm that this module is the one responsible for downloading and processing the observed images. Indeed, inside we can find the functions responsible for their decoding.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Decoding the JPG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>After the payload is retrieved, the JPG header is validated.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":403,"height":257,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_jpg_hdr.png" class="wp-image-39874" alt="" width="403" height="257"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Then, the payload is decoded by simply using an XOR with the last byte. The decoded content is expected to start from the !rcx magic ID.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":317,"height":350,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/xor_decoded.png" class="wp-image-39875" alt="" width="317" height="350"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>After decoding the content, the hash of the !rcx module is validated with the help of SHA256 hash. The valid hash is stored in the module&#8217;s header and compared with the calculated hash of the file content.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":268,"height":503,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/validate_sha265_hash.png" class="wp-image-39876" alt="" width="268" height="503"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>If the validation passed, the shellcode stored in the !rcx module is loaded. More details about the execution flow will be given later.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":327,"height":343,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_shellc.png" class="wp-image-39877" alt="" width="327" height="343"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The !rcx package has a simple header:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":744,"height":283,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rcx_package.png" class="wp-image-39878" alt="" width="744" height="283"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":4} --><h4>Decoding the PNG</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>Retrieving the content from the PNG is more complex.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":82,"height":82,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/captcha-1.png" class="wp-image-39905" alt="" width="82" height="82"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>First, after downloading, the PNG header is checked:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":249,"height":245,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_the_png.png" class="wp-image-39879" alt="" width="249" height="245"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The function decoding the PNG has the following flow:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":776,"height":649,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png"><img loading="lazy" decoding="async" class="wp-image-39971" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_load_coresdb.png" alt="" width="776" height="649"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>It converts the PNG into byte content and decrypts it with the help of <a rel="noreferrer noopener" aria-label=" (opens in a new tab)" href="https://en.wikipedia.org/wiki/ARIA_(cipher)" target="_blank">ARIA cipher</a>. The result should be a CAB format. The unpacked CAB is supposed to contain a module &#8220;bin/i386/core.sdb&#8221; that also occurred in our previous encounters with Hidden Bee.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The authors are careful not to reuse URLs as well as encryption keys. That&#8217;s why the Aria key is different for every unique payload. It is stored just after the end of the 0x10000401 module :</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":609,"height":65,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/aria_key_appended.png" class="wp-image-40015" alt="" width="609" height="65"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>During the module&#8217;s loading, the key is rewritten into another memory area, from which it is used to decrypt the downloaded module.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":630,"height":456,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/copy_the_key.png" class="wp-image-40017" alt="" width="630" height="456"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The CAB file retrieved from the PNG is available here: <a rel="noreferrer noopener" aria-label="001bdc26b2845dcf839f67a8760c6839 (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=001bdc26b2845dcf839f67a8760c6839" target="_blank">001bdc26b2845dcf839f67a8760c6839</a></p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":491,"height":109,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/inside_the_cab.png" class="wp-image-39903" alt="" width="491" height="109"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It contains core.sdb (<a rel="noreferrer noopener" aria-label="d1a2fdc79c154b120a0e52c46a73478d (opens in a new tab)" href="https://malshare.com/sample.php?action=detail&amp;hash=d1a2fdc79c154b120a0e52c46a73478d" target="_blank">d1a2fdc79c154b120a0e52c46a73478d</a>). That is a second module in Hidden Bee&#8217;s custom format.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":724,"height":266,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/core_sdb_hdr.png" class="wp-image-39904" alt="" width="724" height="266"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:heading {"level":3} --><h3 id="mce_36">Inside core.sdb</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This module (retrieved from the PNG) is a second downloader component in the 0x10000401 format. This time, it uses a custom TCP-based protocol, referenced by the authors as SLTP. (This protocol was also used by the analogical component seen one year ago). The embedded links:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 sltp://bbs.favcom.space:1108/setup.bin?id=999 </code></p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4 id="mce_50">Execution flow</h4><!-- /wp:heading -->    <!-- wp:list {"ordered":true} --><ol><li>Checks for blacklisted processes. If any are detected, exits.</li><li>Removes functions: <!-- wp:code --><pre class="wp-block-code"><code>DbgBreakPoint</code></pre><!-- /wp:code -->, <!-- wp:code --><pre class="wp-block-code"><code>DbgUserBreakPoint</code></pre><!-- /wp:code --> by overwriting their beginning with the RET instruction.</li><li>Checks if the malware is already installed. If yes, exits.</li><li>Creates an installation mutex <!-- wp:code --><pre class="wp-block-code"><code>{71BB7F1C-D700-4487-B9C6-6DD9863DFE91}-ins.</code></pre><!-- /wp:code --></li><li>If the module was run with the flag==1:<!-- wp:list {"ordered":true} --><ol><li>Connects to the first address:  <!-- wp:code --><pre class="wp-block-code"><code>sltp://dns.howtocom.site:1108/minimal.bin?id=998 </code></pre><!-- /wp:code --></li><li>Sets an environment variable <!-- wp:code --><pre class="wp-block-code"><code>INSTALL_SOURCE</code></pre><!-- /wp:code --> to the value given as an argument.</li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li><li>If the module was run with the flag!=1:<!-- wp:list {"ordered":true} --><ol><li>Performs checks against VM. If detected, exits.</li><li>Connects to the second address: <!-- wp:code --><pre class="wp-block-code"><code>sltp://bbs.favcom.space:1108/setup.bin?id=999</code></pre><!-- /wp:code -->. This time, appends the victim&#8217;s fingerprint to the URL. Format: <!-- wp:code --><pre class="wp-block-code"><code><URL>&amp;sid=<INSTALL_SID>&amp;sz=<unique machine ID: 16 bytes hex>&amp;os=<Windows version number>&amp;ar=<architecture></code></pre><!-- /wp:code --></li><li>Runs the downloaded next stage module.</li></ol><!-- /wp:list --></li></ol><!-- /wp:list -->    <!-- wp:heading {"level":4} --><h4>Defensive checks</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>At this stage, many anti-analysis checks are deployed. First, there are checks to detect if any of the blacklisted processes are running. The enumeration of the processes is implemented using a low-level function: <code>NtQuerySystemInformation</code> with a parameter 5 (<!-- wp:code --></p><pre class="wp-block-code"><code>SystemProcessInformation</code></pre><!-- /wp:code -->).<!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":714,"height":486,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/search_blacklisted.png" class="wp-image-39908" alt="" width="714" height="486"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The blacklist contains popular debuggers and sniffers:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>&#8220;devenv.exe&#8221; , &#8220;wireshark.exe&#8221;,  &#8220;vmacthlp.exe&#8221;, &#8220;procmon.exe&#8221;, &#8220;ollydbg.exe&#8221;, &#8220;idag.exe&#8221;,  &#8220;ImmunityDebugger.exe&#8221;,  &#8220;windbg.exe&#8221;<br> &#8220;EHSniffer.exe&#8221;,  &#8220;iris.exe&#8221;,  &#8220;procexp.exe&#8221;,  &#8220;filemon.exe&#8221;,  &#8220;fiddler.exe&#8221;</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The names of the processes are obfuscated, so they are not visible on the strings list. If any of those processes are detected, the execution of the module terminates.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Another function deploys a set of anti-VM checks. The anti-VM checks include:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":297,"height":169,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sets1.png" class="wp-image-39967" alt="" width="297" height="169"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>CPUID with EAX=40000000 (<a rel="noreferrer noopener" aria-label="a  check for Hypervisor's Brand (opens in a new tab)" href="https://rayanfam.com/topics/defeating-malware-anti-vm-techniques-cpuid-based-instructions/" target="_blank">a check for Hypervisor&#8217;s Brand</a>):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":391,"height":66,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_check1.png" class="wp-image-39933" alt="" width="391" height="66"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":272,"height":107,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/cpuid_2.png" class="wp-image-39934" alt="" width="272" height="107"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The VMWAre I/O Port (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://handlers.sans.org/tliston/ThwartingVMDetection_Liston_Skoudis.pdf" target="_blank">here</a>]):</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":405,"height":106,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vmware_in-1.png" class="wp-image-39931" alt="" width="405" height="106"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>VPCEXT instruction (more details [<a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="https://shasaurabh.blogspot.com/2017/07/virtual-machine-detection-techniques.html" target="_blank">here</a>])</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":394,"height":93,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/vpcext_based.png" class="wp-image-39932" alt="" width="394" height="93"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking <a rel="noreferrer noopener" aria-label="the list of common VM vendors (opens in a new tab)" href="https://wiki.osdev.org/CPUID" target="_blank">the list of common VM vendors</a>:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":511,"height":482,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_vm2-1.png" class="wp-image-39968" alt="" width="511" height="482"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Checking the BIOS versions typical for virtual environments:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":1067,"height":590,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png"><img loading="lazy" decoding="async" class="wp-image-39969" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_reg_keys.png" alt="" width="1067" height="590"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>Detection of any of the features suggesting a VM results in termination of the component.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":4} --><h4>Downloading new modules</h4><!-- /wp:heading -->    <!-- wp:paragraph --><p>The next elements of HiddenBee are downloaded over the custom &#8220;STLP&#8221; protocol. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":310,"height":132,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/check_sltp_protocol.png" class="wp-image-40034" alt="" width="310" height="132"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The raw TCP socket created to communicate using the SLTP protocol:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":791,"height":664,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/sltp_socket-1.png" class="wp-image-40037" alt="" width="791" height="664"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The communication is encrypted. We can see that the expected output is a shellcode that is loaded and executed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":813,"height":648,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><a href="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png"><img decoding="async" class="wp-image-39970" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/load_new_module-1.png" alt="" width="813" height="648"></a></figure> <!-- /wp:image -->   <!-- wp:paragraph --><p>The way in which it is loaded reminds me of the elements we described recently in &#8220;<a rel="noreferrer noopener" aria-label="Hidden Bee - let's go down the rabbit hole (opens in a new tab)" href="/blog/threat-analysis/2019/05/hidden-bee-lets-go-down-the-rabbit-hole/" target="_blank">Hidden Bee: Let&#8217;s go down the rabbit hole</a>&#8220;. The current module loads a list of functions that will be passed to the next module. It is a minimalistic, custom version of Import Table. It also passes the memory with the downloaded filesystem to be used for further loading of components.</p><!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3 id="mce_22">The !rcx package</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>This element retrieves the custom filesystem used by this malware. As we know from previous analysis, Hidden Bee uses its own, custom filesystems that are mounted in the memory of the malware and passed to its components. This filesystem is important for the execution flow because it contains many other components that are supposed to be installed on the attacked system in order to continue the infection.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>As mentioned before, unpacking the JPG gave us an !rcx package. After this package is downloaded, and its SHA256 checksum is validated, it is repackaged. First, at the end of the !rcx package, the list of URLs (JPG, PNG) from the previous module is copied. Then, the ARIA key is copied. The size of the module and its SHA256 hash are updated. Then, the execution is redirected to the first stage shellcode fetched from the !rcx.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>This shellcode was the one that we saw at first, after decoding the !rcx package from the JPG. Yet, looking at this part, we do not see anything malicious. The elements that are more important are well protected and revealed at the next execution stages.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The shellcode from the !rcx package is executed in two stages. The first one unpacks and prepares the second. First, it loads its own imports using hardcoded names of libraries.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":302,"height":244,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/hardcoded_names-1.png" class="wp-image-39974" alt="" width="302" height="244"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>The checksums of the functions that are going to be used are stored in the module and compared with the names calculated by the function: </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":424,"height":292,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/checksum_algo.png" class="wp-image-39972" alt="" width="424" height="292"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>It uses the functions from kernel32.dll: GetProcessHeap, VirtualAlloc, VirtualFree, and from ntdll.dll: RtlAllocateHeap, RtlFreeHeap, NtQueryInformationProcess.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The repackaged !rcx module is supposed to be supplied as one of the arguments at the Entry Point of the first shellcode. It is most important because the second stage shellcode will be unpacked from the supplied !rcx package.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":323,"height":114,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/05/rcx_arg-1.png" class="wp-image-38759" alt="" width="323" height="114"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p> A new memory area is allocated, and the second stage shellcode is unpacked there.</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":856,"height":559,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decode_and_call_next.png" class="wp-image-39976" alt="" width="856" height="559"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>Inside the second shellcode, we see strings referencing further components of the Hidden Bee malware:</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p><code> /bin/i386/preload /bin/i386/coredll.bin </code></p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The role of the second stage is unpacking another part from the !rcx: an !rdx package. </p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":614,"height":470,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_func.png" class="wp-image-40022" alt="" width="614" height="470"/></figure> <!-- /wp:image --> <!-- /wp:image -->  <!-- wp:image --> <!-- wp:image {"align":"center","width":309,"height":89,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/rdx_check.png" class="wp-image-39975" alt="" width="309" height="89"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>From our previous experience, we know that the !rdx package is a custom filesystem containing modules. Indeed, after the decryption is complete, the custom filesystem is revealed:</p><!-- /wp:paragraph -->   <!-- wp:image --> <!-- wp:image {"align":"center","width":478,"height":723,"sizeSlug":"full","linkDestination":"none","className":"is-resized"} --><figure class="wp-block-image aligncenter size-full is-resized"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2019/08/decrypt_rdx_filesystem.png" class="wp-image-40019" alt="" width="478" height="723"/></figure> <!-- /wp:image --> <!-- /wp:image -->   <!-- wp:paragraph --><p>So the part that was hidden in the JPG is, in reality, a package that decrypts the custom filesystem and deploys the next stage modules: <code>/bin/i386/preload</code> and <!-- wp:code --></p><pre class="wp-block-code"><code>/bin/i386/coredll.bin</code></pre><!-- /wp:code -->. This filesystem has even more elements that are loaded at later stages of the infection. Their full functionality will be described in the next article in our series.<!-- /wp:paragraph -->    <!-- wp:heading {"level":3} --><h3>Even more hidden</h3><!-- /wp:heading -->    <!-- wp:paragraph --><p>From the beginning, Hidden Bee malware has been well designed and innovative. Looking at one year of its evolution, we can be sure that the authors are serious about making it even more stealthy&mdash;and they don&#8217;t stop improving it.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>Although the initial dropper uses components analogous to ones observed in the past, revealing their encrypted content now takes many more steps and much more patience. The additional difficulty in the analysis is introduced by the fact that the URLs and encryption keys are never reused, and work only for a single session.</p><!-- /wp:paragraph -->    <!-- wp:paragraph --><p>The team behind this malware is skilled and determined. We expect that the Hidden Bee malware won&#8217;t be going extinct anytime soon.</p><!-- /wp:paragraph -->                        
		</div><!-- .entry-content -->
	</div>
</article><!-- #post-74941 -->
						<div class="share-section">
							<p><strong>SHARE THIS ARTICLE</strong></p>
							<a class="socicon-facebook" target="_blank" href="http://www.facebook.com/sharer.php?u=https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack" aria-label="Share this post on Facebook">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="-5 0 20 20" version="1.1">
								<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
									<g transform="translate(-385.000000, -7399.000000)" fill="#414042">
									<g transform="translate(56.000000, 160.000000)">
										<path d="M335.821282,7259 L335.821282,7250 L338.553693,7250 L339,7246 L335.821282,7246 L335.821282,7244.052 C335.821282,7243.022 335.847593,7242 337.286884,7242 L338.744689,7242 L338.744689,7239.14 C338.744689,7239.097 337.492497,7239 336.225687,7239 C333.580004,7239 331.923407,7240.657 331.923407,7243.7 L331.923407,7246 L329,7246 L329,7250 L331.923407,7250 L331.923407,7259 L335.821282,7259 Z" id="facebook-[#176]">
								</path>
								</g>
								</g>
								</g>
							</svg>
							</a>
							<a class="socicon-twitter" target="_blank" href="https://twitter.com/intent/tweet?text=The+Hidden+Bee+infection+chain%2C+part+1%3A+the+stegano+pack+https%3A%2F%2Fwww.malwarebytes.com%2Fblog%2Fnews%2F2019%2F08%2Fthe-hidden-bee-infection-chain-part-1-the-stegano-pack&amp;via=Malwarebytes" aria-label="Share this post on Twitter">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 -2 20 20" version="1.1">
								<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
									<g transform="translate(-60.000000, -7521.000000)" fill="#414042">
									<g transform="translate(56.000000, 160.000000)">
										<path d="M10.29,7377 C17.837,7377 21.965,7370.84365 21.965,7365.50546 C21.965,7365.33021 21.965,7365.15595 21.953,7364.98267 C22.756,7364.41163 23.449,7363.70276 24,7362.8915 C23.252,7363.21837 22.457,7363.433 21.644,7363.52751 C22.5,7363.02244 23.141,7362.2289 23.448,7361.2926 C22.642,7361.76321 21.761,7362.095 20.842,7362.27321 C19.288,7360.64674 16.689,7360.56798 15.036,7362.09796 C13.971,7363.08447 13.518,7364.55538 13.849,7365.95835 C10.55,7365.79492 7.476,7364.261 5.392,7361.73762 C4.303,7363.58363 4.86,7365.94457 6.663,7367.12996 C6.01,7367.11125 5.371,7366.93797 4.8,7366.62489 L4.8,7366.67608 C4.801,7368.5989 6.178,7370.2549 8.092,7370.63591 C7.488,7370.79836 6.854,7370.82199 6.24,7370.70483 C6.777,7372.35099 8.318,7373.47829 10.073,7373.51078 C8.62,7374.63513 6.825,7375.24554 4.977,7375.24358 C4.651,7375.24259 4.325,7375.22388 4,7375.18549 C5.877,7376.37088 8.06,7377 10.29,7376.99705" id="twitter-[#154]">
								</path></g></g></g>
							</svg>
							</a>
							<a class="socicon-linkedin" target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack&amp;summary=&amp;source=" aria-label="Share this post on LinkedIn">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#414042" version="1.1" width="24px" height="24px" viewBox="0 0 512 512" xml:space="preserve">
								<g>
								<path style="display: inline; fill-rule: evenodd; clip-rule: evenodd;" d="M116.504,500.219V170.654H6.975v329.564H116.504   L116.504,500.219z M61.751,125.674c38.183,0,61.968-25.328,61.968-56.953c-0.722-32.328-23.785-56.941-61.252-56.941   C24.994,11.781,0.5,36.394,0.5,68.722c0,31.625,23.772,56.953,60.53,56.953H61.751L61.751,125.674z M177.124,500.219   c0,0,1.437-298.643,0-329.564H286.67v47.794h-0.727c14.404-22.49,40.354-55.533,99.44-55.533   c72.085,0,126.116,47.103,126.116,148.333v188.971H401.971V323.912c0-44.301-15.848-74.531-55.497-74.531   c-30.254,0-48.284,20.38-56.202,40.08c-2.897,7.012-3.602,16.861-3.602,26.711v184.047H177.124L177.124,500.219z">
								</path>
								</g>
								</svg>
							</a>
						</div>
						<div id="disqus_thread"></div>
													<div class="related-articles-wrap">
								<h4>RELATED ARTICLES</h4>
								<div class="related-articles-main">
																				<div class="related-article">
												<div class="large-card">
													<div class="thumb">
														<a href="https://www.malwarebytes.com/blog/news/2025/03/dont-let-your-kids-on-roblox-if-youre-worried-says-roblox-ceo">
															<img width="150" height="150" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/02/Roblox.png?w=150&amp;h=150&amp;crop=1" class="attachment-thumbnail size-thumbnail wp-post-image" alt="Roblox logo" loading="lazy" />														</a>
													</div>
													<div class="blog-info">
																													<div class="blog-list__category">
																																	<a href="https://www.malwarebytes.com/blog/category/news">News</a>
																	 | 																	<a href="https://www.malwarebytes.com/blog/category/personal">Personal</a>
																																</div>
																													<h2><a href="https://www.malwarebytes.com/blog/news/2025/03/dont-let-your-kids-on-roblox-if-youre-worried-says-roblox-ceo">Don&#8217;t let your kids on Roblox if you&#8217;re not comfortable, says Roblox CEO</a></h2>
													</div>
													</div>
													<p class="blog-excerpt">March 13, 2025 - To parents worried about their children&#039;s presence on Roblox, the CEO said don&#039;t let your kids be on Roblox.</p>
													<div class="blog-action">
														<a class="continue-read" href="https://www.malwarebytes.com/blog/news/2025/03/dont-let-your-kids-on-roblox-if-youre-worried-says-roblox-ceo">CONTINUE READING</a>
														<a class="num-comments" href="https://www.malwarebytes.com/blog/news/2025/03/dont-let-your-kids-on-roblox-if-youre-worried-says-roblox-ceo#disqus_thread" data-disqus-identifier="154519"> 0 Comments</a>
													</div>
											</div>
																						<div class="related-article">
												<div class="large-card">
													<div class="thumb">
														<a href="https://www.malwarebytes.com/blog/news/2025/03/update-your-iphone-now-apple-patches-vulnerability-used-in-extremely-sophisticated-attacks">
															<img width="150" height="150" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2024/01/apple.png?w=150&amp;h=150&amp;crop=1" class="attachment-thumbnail size-thumbnail wp-post-image" alt="patched Apple" loading="lazy" />														</a>
													</div>
													<div class="blog-info">
																													<div class="blog-list__category">
																																	<a href="https://www.malwarebytes.com/blog/category/apple">Apple</a>
																	 | 																	<a href="https://www.malwarebytes.com/blog/category/news">News</a>
																																</div>
																													<h2><a href="https://www.malwarebytes.com/blog/news/2025/03/update-your-iphone-now-apple-patches-vulnerability-used-in-extremely-sophisticated-attacks">Update your iPhone now: Apple patches vulnerability used in extremely sophisticated attacks</a></h2>
													</div>
													</div>
													<p class="blog-excerpt">March 12, 2025 - Apple has patched a vulnerability in iOS and iPadOS that was under active exploitation in extremely sophisticated attacks.</p>
													<div class="blog-action">
														<a class="continue-read" href="https://www.malwarebytes.com/blog/news/2025/03/update-your-iphone-now-apple-patches-vulnerability-used-in-extremely-sophisticated-attacks">CONTINUE READING</a>
														<a class="num-comments" href="https://www.malwarebytes.com/blog/news/2025/03/update-your-iphone-now-apple-patches-vulnerability-used-in-extremely-sophisticated-attacks#disqus_thread" data-disqus-identifier="153446"> 0 Comments</a>
													</div>
											</div>
																						<div class="related-article">
												<div class="large-card">
													<div class="thumb">
														<a href="https://www.malwarebytes.com/blog/personal/2025/03/the-dark-side-of-sports-betting-how-mirror-sites-help-gambling-scams-thrive">
															<img width="150" height="150" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/03/basketball.png?w=150&amp;h=150&amp;crop=1" class="attachment-thumbnail size-thumbnail wp-post-image" alt="Half a basketball on a dark background" loading="lazy" />														</a>
													</div>
													<div class="blog-info">
																													<div class="blog-list__category">
																																	<a href="https://www.malwarebytes.com/blog/category/personal">Personal</a>
																																</div>
																													<h2><a href="https://www.malwarebytes.com/blog/personal/2025/03/the-dark-side-of-sports-betting-how-mirror-sites-help-gambling-scams-thrive">The dark side of sports betting: How mirror sites help gambling scams thrive</a></h2>
													</div>
													</div>
													<p class="blog-excerpt">March 12, 2025 - Sports betting is a multi-billion-dollar industry, but behind the flashing lights and promises of easy money lies a hidden underworld of deception.</p>
													<div class="blog-action">
														<a class="continue-read" href="https://www.malwarebytes.com/blog/personal/2025/03/the-dark-side-of-sports-betting-how-mirror-sites-help-gambling-scams-thrive">CONTINUE READING</a>
														<a class="num-comments" href="https://www.malwarebytes.com/blog/personal/2025/03/the-dark-side-of-sports-betting-how-mirror-sites-help-gambling-scams-thrive#disqus_thread" data-disqus-identifier="152459"> 0 Comments</a>
													</div>
											</div>
																						<div class="related-article">
												<div class="large-card">
													<div class="thumb">
														<a href="https://www.malwarebytes.com/blog/news/2025/03/android-devices-track-you-before-you-even-sign-in">
															<img width="150" height="150" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2025/03/android_figure_on_keyboard.png?w=150&amp;h=150&amp;crop=1" class="attachment-thumbnail size-thumbnail wp-post-image" alt="Android figurine on keyboard" loading="lazy" />														</a>
													</div>
													<div class="blog-info">
																													<div class="blog-list__category">
																																	<a href="https://www.malwarebytes.com/blog/category/android">Android</a>
																	 | 																	<a href="https://www.malwarebytes.com/blog/category/news">News</a>
																	 | 																	<a href="https://www.malwarebytes.com/blog/category/privacy">Privacy</a>
																																</div>
																													<h2><a href="https://www.malwarebytes.com/blog/news/2025/03/android-devices-track-you-before-you-even-sign-in">Android devices track you before you even sign in</a></h2>
													</div>
													</div>
													<p class="blog-excerpt">March 12, 2025 - Google spies on Android device users, starting from even before they have logged in to their Google account.</p>
													<div class="blog-action">
														<a class="continue-read" href="https://www.malwarebytes.com/blog/news/2025/03/android-devices-track-you-before-you-even-sign-in">CONTINUE READING</a>
														<a class="num-comments" href="https://www.malwarebytes.com/blog/news/2025/03/android-devices-track-you-before-you-even-sign-in#disqus_thread" data-disqus-identifier="152606"> 0 Comments</a>
													</div>
											</div>
																						<div class="related-article">
												<div class="large-card">
													<div class="thumb">
														<a href="https://www.malwarebytes.com/blog/podcast/2025/03/how-ads-weirdly-know-your-screen-brightness-headphone-jack-use-and-location-with-tim-shott-lock-and-code-s06e05">
															<img width="150" height="150" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/12/LockAndCodeCrownpeakApproved.jpg?w=150&amp;h=150&amp;crop=1" class="attachment-thumbnail size-thumbnail wp-post-image" alt="The Lock and Code logo, which includes the Malwarebytes Labs insignia ensconced in a pair of headphones" loading="lazy" />														</a>
													</div>
													<div class="blog-info">
																													<div class="blog-list__category">
																																	<a href="https://www.malwarebytes.com/blog/category/podcast">Podcast</a>
																																</div>
																													<h2><a href="https://www.malwarebytes.com/blog/podcast/2025/03/how-ads-weirdly-know-your-screen-brightness-headphone-jack-use-and-location-with-tim-shott-lock-and-code-s06e05">How ads weirdly know your screen brightness, headphone jack use, and location, with Tim Shott (Lock and Code S06E05)</a></h2>
													</div>
													</div>
													<p class="blog-excerpt">March 10, 2025 - This week on the Lock and Code podcast, we speak with Tim Shott about his attempt to find his location data following a major data breach.</p>
													<div class="blog-action">
														<a class="continue-read" href="https://www.malwarebytes.com/blog/podcast/2025/03/how-ads-weirdly-know-your-screen-brightness-headphone-jack-use-and-location-with-tim-shott-lock-and-code-s06e05">CONTINUE READING</a>
														<a class="num-comments" href="https://www.malwarebytes.com/blog/podcast/2025/03/how-ads-weirdly-know-your-screen-brightness-headphone-jack-use-and-location-with-tim-shott-lock-and-code-s06e05#disqus_thread" data-disqus-identifier="152364"> 0 Comments</a>
													</div>
											</div>
																			</div>								
							</div>
											</div>
				<div class="u-flex-column u-flex-col-lg-4">
					<div class="malwarebytes-sidebar u-margin-t50@max-767 u-margin-t50 u-margin-b20">
						<div id="right-rail">
														<div class="author-card blog-author">
								<div class="heading">
									<p>ABOUT THE AUTHOR</p>
								</div>
								<div class="card-inner">
									<div class="author-img">
										<a class="author-img" href="https://www.malwarebytes.com/blog/authors/hasherezade">
																							<img alt="hasherezade" src="https://secure.gravatar.com/userimage/34895611/56a7488edd8201874201d462661b7263?size=400" srcset="https://secure.gravatar.com/userimage/34895611/56a7488edd8201874201d462661b7263?size=400" class="avatar avatar-150 photo" height="150" width="150" loading="lazy">
																					</a>
									</div>
									<div class="content">
										<p class="details">
											<span class="name"><a href="https://www.malwarebytes.com/blog/authors/hasherezade">hasherezade</a></span>
																							<a class="social socicon-twitter" target="_blank" href="https://twitter.com/hasherezade">
													<img src="https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/src/images/twitter-blue.svg" alt="twitter-icon">
												</a>
																						</p>							
																					<span class="title">Malware Intelligence Analyst</span>
																						<p class="desc">Unpacks malware with as much joy as a kid unpacking candies.</p>
																				</div>
								</div>
							</div>							
						</div>
					</div>
				</div>
			</div>
		</div>
		
<div class="wp-block-group alignfull labs-links-block has-background has-global-padding is-layout-constrained wp-container-core-group-is-layout-4 wp-block-group-is-layout-constrained" style="border-style:none;border-width:0px;background-color:#f7fbff;padding-top:var(--wp--preset--spacing--60);padding-right:var(--wp--preset--spacing--70);padding-bottom:var(--wp--preset--spacing--60);padding-left:var(--wp--preset--spacing--70)">
<div class="wp-block-columns is-layout-flex wp-container-core-columns-is-layout-7 wp-block-columns-is-layout-flex" style="margin-top:0;margin-bottom:0;padding-top:0;padding-right:0;padding-bottom:0;padding-left:0">
<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image aligncenter size-large"><a href="https://www.malwarebytes.com/blog/authors"><img loading="lazy" decoding="async" width="58" height="58" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/Screenshot-2023-08-24-at-6.14.19-PM.png?w=58" alt="Contributors icon" class="wp-image-11363"/></a></figure>



<p class="has-text-align-center"><a href="https://www.malwarebytes.com/blog/authors">Contributors</a></p>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image aligncenter size-large"><a href="https://www.malwarebytes.com/blog/threats"><img loading="lazy" decoding="async" width="56" height="57" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/Screenshot-2023-08-24-at-6.14.55-PM.png?w=56" alt="Threat Center icon" class="wp-image-11362"/></a></figure>



<p class="has-text-align-center"><a href="https://www.malwarebytes.com/blog/threats">Threat Center</a></p>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image aligncenter size-large"><a href="https://www.malwarebytes.com/blog/podcast"><img loading="lazy" decoding="async" width="56" height="57" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/Screenshot-2023-08-24-at-6.15.19-PM.png?w=56" alt="Podcasts icon" class="wp-image-11361"/></a></figure>



<p class="has-text-align-center"><a href="https://www.malwarebytes.com/blog/category/podcast">Podcast</a></p>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image aligncenter size-large"><a href="https://www.malwarebytes.com/glossary"><img loading="lazy" decoding="async" width="56" height="57" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/Screenshot-2023-08-24-at-6.15.36-PM.png?w=56" alt="Glossary icon" class="wp-image-11360"/></a></figure>



<p class="has-text-align-center"><a href="https://www.malwarebytes.com/glossary">Glossary</a></p>
</div>



<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
<figure class="wp-block-image aligncenter size-large"><a href="https://www.malwarebytes.com/blog/tech-support-scams"><img loading="lazy" decoding="async" width="56" height="57" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/Screenshot-2023-08-24-at-6.15.51-PM.png?w=56" alt="Scams icon" class="wp-image-11359"/></a></figure>



<p class="has-text-align-center"><a href="https://www.malwarebytes.com/blog/news/2016/05/tech-support-scams">Scams</a></p>
</div>
</div>
</div>
	</main><!-- #main -->
		<script>
		var disqus_config = function () {			
			this.page.url = 'https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack';
			this.page.identifier = '230350';
		};

		(function() {
			var d = document, s = d.createElement('script');			
			s.src = 'https://malwarebytesunpacked.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
		})();
	</script>

<span id="kadence-conversion-end-of-content"></span>
	<footer id="colophon" class="site-footer">
		
		<div class="site-footer__top">
			<div class="container">

								<div class="site-footer__info">
											<a class="footer-logo" href="https://www.malwarebytes.com/" rel="home" id="cta-navbar-footer-company-logo-en">
							<img width="1240" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/07/footer-logo-1.svg" class="attachment-full size-full" alt="MalwareBytes-Footer-Logo" width="150" height="46" decoding="async" loading="lazy" />						</a>
										<p class="site-footer__description">
					Cyberprotection for every one.					</p>
				</div>
				
				<div class="site-footer__row u-flex-columns">
											<div class="u-flex-column u-flex-col-lg-2 u-flex-col-sm-6">
							
<p style="font-style:normal;font-weight:500">COMPUTER SECURITY</p>
<div class="menu-footer-computer-security-container"><ul id="menu-footer-computer-security" class="menu"><li id="menu-item-119904" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119904"><a href="https://www.malwarebytes.com/rootkit" id="cta-mb-footer-rootkit-scanner">Rootkit Scanner</a></li>
<li id="menu-item-119905" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119905"><a href="https://www.malwarebytes.com/solutions/trojan-scanner" id="cta-mb-footer-trojan-scanner">Trojan Scanner</a></li>
<li id="menu-item-119906" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119906"><a href="https://www.malwarebytes.com/solutions/free-antivirus" id="cta-mb-footer-free-antivirus">Free Antivirus</a></li>
<li id="menu-item-119907" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119907"><a href="https://www.malwarebytes.com/solutions/virus-scanner" id="cta-mb-footer-virus-scan">Free Virus Scan</a></li>
<li id="menu-item-119908" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119908"><a href="https://www.malwarebytes.com/premium" id="cta-mb-footer-premium-protection">Premium protection</a></li>
</ul></div>
<p style="font-style:normal;font-weight:500">MOBILE SECURITY</p>

<div class="wp-block-group has-global-padding is-layout-constrained wp-block-group-is-layout-constrained" style="padding-bottom:var(--wp--preset--spacing--40)"><div class="widget widget_nav_menu"><div class="menu-footer-android-security-container"><ul id="menu-footer-android-security" class="menu"><li id="menu-item-119910" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119910"><a href="https://www.malwarebytes.com/android-antivirus" id="cta-mb-footer-android-security">Antivirus for Android</a></li>
</ul></div></div>


<figure class="wp-block-image size-large"><a href="https://go.onelink.me/app/516cebeb"><img loading="lazy" decoding="async" width="135" height="40" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/google_play_store_button.png?w=135" alt="google play store" class="wp-image-6309"/></a></figure>
</div>

<div class="wp-block-group has-global-padding is-layout-constrained wp-block-group-is-layout-constrained"><div class="widget widget_nav_menu"><div class="menu-footer-ios-security-container"><ul id="menu-footer-ios-security" class="menu"><li id="menu-item-119913" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119913"><a href="https://www.malwarebytes.com/ios" id="cta-mb-footer-ios-security">iOS Security and Spam Blocker</a></li>
</ul></div></div>


<figure class="wp-block-image size-large"><a href="https://apps.apple.com/US/app/id1327105431?mt=8"><img loading="lazy" decoding="async" width="120" height="40" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/08/apple_app_store_button_dark.png?w=120" alt="apple store icon" class="wp-image-6313"/></a></figure>
</div>
						</div>
																<div class="u-flex-column u-flex-col-lg-2 u-flex-col-sm-6">
							
<p style="font-style:normal;font-weight:500">PRIVACY PROTECTION</p>
<div class="menu-footer-privacy-protection-container"><ul id="menu-footer-privacy-protection" class="menu"><li id="menu-item-124415" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-124415"><a href="https://www.malwarebytes.com/vpn" id="cta-mb-footer-privacy-vpn">Privacy VPN (Virtual Private Network)</a></li>
<li id="menu-item-120239" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120239"><a href="https://www.malwarebytes.com/digital-footprint" id="cta-mb-footer-digital-footprint-scan">Digital Footprint Scan</a></li>
<li id="menu-item-119923" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119923"><a href="https://www.malwarebytes.com/solutions/dark-web-monitoring" id="cta-mb-footer-dark-web-monitoring">Dark Web Monitoring</a></li>
<li id="menu-item-119924" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119924"><a href="https://www.malwarebytes.com/adwcleaner" id="cta-mb-footer-adware-removal-adwcleaner">Adware Removal</a></li>
<li id="menu-item-119925" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-119925"><a href="https://www.malwarebytes.com/browserguard" id="cta-mb-footer-adblocker-browserguard">Ad Blocker</a></li>
</ul></div>
<p style="font-style:normal;font-weight:500">IDENTITY PROTECTION</p>
<div class="menu-footer-identity-protection-container"><ul id="menu-footer-identity-protection" class="menu"><li id="menu-item-120211" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120211"><a href="https://www.malwarebytes.com/identity-theft-protection" id="cta-mb-footer-identity-monitoring-alerts">Identity Monitoring &#038; Alerts</a></li>
<li id="menu-item-120212" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120212"><a href="https://www.malwarebytes.com/identity-theft-protection" id="cta-mb-footer-credit-monitoring-reporting">Credit Monitoring &#038; Reporting</a></li>
<li id="menu-item-120213" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120213"><a href="https://www.malwarebytes.com/identity-theft-protection" id="cta-mb-footer-identity-recovery-resolution">Identity Recovery &#038; Resolution</a></li>
<li id="menu-item-120214" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120214"><a href="https://www.malwarebytes.com/identity-theft-protection" id="cta-mb-footer-identity-theft-insurance">ID Theft Insurance</a></li>
<li id="menu-item-120215" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120215"><a href="https://www.malwarebytes.com/personal-data-remover" id="cta-mb-footer-personal-data-remover-pdr">Personal Data Remover</a></li>
</ul></div>						</div>
																<div class="u-flex-column u-flex-col-lg-2 u-flex-col-sm-6">
							
<p style="font-style:normal;font-weight:500">LEARN ABOUT CYBERSECURITY</p>
<div class="menu-footer-learn-about-cybersecurity-container"><ul id="menu-footer-learn-about-cybersecurity" class="menu"><li id="menu-item-120251" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120251"><a href="https://www.malwarebytes.com/blog">Blog</a></li>
<li id="menu-item-120244" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120244"><a href="https://www.malwarebytes.com/social-engineering">Social Engineering</a></li>
<li id="menu-item-120220" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120220"><a href="https://www.malwarebytes.com/phishing">Phishing</a></li>
<li id="menu-item-120221" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120221"><a href="https://www.malwarebytes.com/solutions/ransomware-protection">Ransomware</a></li>
<li id="menu-item-120246" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120246"><a href="https://www.malwarebytes.com/malware">Malware</a></li>
<li id="menu-item-120222" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120222"><a href="https://www.malwarebytes.com/cybersecurity/basics/antivirus">Antivirus</a></li>
<li id="menu-item-120223" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120223"><a href="https://www.malwarebytes.com/what-is-vpn">What is a VPN?</a></li>
<li id="menu-item-120224" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120224"><a href="https://www.malwarebytes.com/doxxing">Doxxing</a></li>
</ul></div>
<p style="font-style:normal;font-weight:500">PARTNER WITH MALWAREBYTES</p>
<div class="menu-footer-partner-with-mb-container"><ul id="menu-footer-partner-with-mb" class="menu"><li id="menu-item-120226" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120226"><a href="https://www.malwarebytes.com/techbench" id="cta-mb-footer-computer-repair-techbench">Computer Repair</a></li>
<li id="menu-item-120227" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120227"><a href="https://www.malwarebytes.com/affiliates" id="cta-mb-footer-affiliates">Affiliates</a></li>
</ul></div>
<p style="font-style:normal;font-weight:500">ADDRESS</p>

<p class="address-text address-global">One Albert Quay<br>2nd Floor<br>Cork T12 X8N6<br>Ireland</p>

<p class="address-text address-usa-ca hidden">2445 Augustine Drive<br>Suite 550<br>Santa Clara, CA<br>USA, 95054</p>
						</div>
																<div class="site-footer__col u-flex-column u-flex-col-lg-2 u-flex-col-sm-6">
							
<p style="font-style:normal;font-weight:500">ABOUT MALWAREBYTES</p>
<div class="menu-footer-about-mb-container"><ul id="menu-footer-about-mb" class="menu"><li id="menu-item-120230" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120230"><a href="https://www.malwarebytes.com/jobs" id="cta-mb-footer-careers">Careers</a></li>
<li id="menu-item-120231" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120231"><a href="https://www.malwarebytes.com/press/" id="cta-mb-footer-press">News and Press</a></li>
<li id="menu-item-120232" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-120232"><a href="https://www.malwarebytes.com/secure" id="cta-mb-footer-vulnerability-discolsure">Vulnerability Disclosure</a></li>
<li id="menu-item-120233" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120233"><a href="https://forums.malwarebytes.com/forum/122-false-positives" id="cta-mb-footer-false-positive">Report a False Positive</a></li>
<li id="menu-item-120234" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120234"><a href="https://forums.malwarebytes.com/" id="cta-mb-footer-forums">Forums</a></li>
</ul></div>
<p style="font-style:normal;font-weight:500">GET HELP</p>
<div class="menu-footer-get-help-container"><ul id="menu-footer-get-help" class="menu"><li id="menu-item-120236" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120236"><a href="https://support.malwarebytes.com/hc/en-us">Help Center</a></li>
<li id="menu-item-120237" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120237"><a href="https://my.malwarebytes.com">Sign in to MyAccount</a></li>
</ul></div>
<div class="wp-block-group has-background has-global-padding is-layout-constrained wp-container-core-group-is-layout-8 wp-block-group-is-layout-constrained" style="background-color:#ffffff12;padding-top:var(--wp--preset--spacing--20);padding-right:var(--wp--preset--spacing--20);padding-bottom:var(--wp--preset--spacing--20);padding-left:var(--wp--preset--spacing--20)">
<figure class="wp-block-image size-large"><a href="https://www.threatdown.com/?utm_campaign=mwb-referral&amp;utm_source=malwarebytes.com&amp;utm_medium=referral&amp;utm_content=cta-mb-footer-threatdown-logo"><img loading="lazy" decoding="async" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/11/ThreatDown_Horizontal_Reverse-2-2.svg?w=1024" width="156" height="37" alt="Threatdown powered by Malwarebytes logo" class="wp-image-98222"/></a></figure>


<div class="widget widget_nav_menu"><div class="menu-footer-threatdown-container"><ul id="menu-footer-threatdown" class="menu"><li id="menu-item-120248" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120248"><a href="https://www.threatdown.com/?utm_campaign=mwb-referral&#038;utm_source=malwarebytes.com&#038;utm_medium=referral&#038;utm_content=cta-mb-footer-threatdown-endpoint-solution" id="cta-mb-footer-threatdown-endpoint-security-solution">Business Endpoint Security Solutions</a></li>
<li id="menu-item-120249" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-120249"><a href="https://www.threatdown.com/partner-program/msp/?utm_campaign=mwb-referral&#038;utm_source=malwarebytes.com&#038;utm_medium=referral&#038;utm_content=cta-en-us-footer-partner-msp" id="https://www.threatdown.com/partner-program/msp/">Managed Service Provider (MSP) Program</a></li>
</ul></div></div></div>
						</div>
										<div class="site-footer__connect u-flex-column u-flex-col-lg-4">
													<ul class="site-footer__social-icons u-flex-center">
																		<li>
											<a href="https://twitter.com/malwarebytes" id="cta-footer-social-twitter-en" class="social socicon-twitter" target="_blank" rel="noopener">
												<img width="1240" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2024/01/x-logo.svg?w=1240" class="attachment-social-icon-image size-social-icon-image" alt="Twitter icon" width="30" height="20" decoding="async" loading="lazy" />												<span class="screen-reader-text">Twitter</span>
											</a>
										</li>
																			<li>
											<a href="https://www.facebook.com/Malwarebytes" id="cta-footer-social-facebook-en" class="social socicon-facebook" target="_blank" rel="noopener">
												<img width="1240" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/07/icon-facebook.svg?w=1240" class="attachment-social-icon-image size-social-icon-image" alt="Icon facebook" width="30" height="20" decoding="async" loading="lazy" />												<span class="screen-reader-text">Facebook</span>
											</a>
										</li>
																			<li>
											<a href="https://www.linkedin.com/company/malwarebytes" id="cta-footer-social-linkedin-en" class="social socicon-linkedin" target="_blank" rel="noopener">
												<img width="1240" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/07/icon-linkedin.svg?w=1240" class="attachment-social-icon-image size-social-icon-image" alt="Icon Linkedin" width="30" height="20" decoding="async" loading="lazy" />												<span class="screen-reader-text">LinkedIn</span>
											</a>
										</li>
																			<li>
											<a href="https://www.youtube.com/user/Malwarebytes" id="cta-footer-social-youtube-en" class="social socicon-youtube" target="_blank" rel="noopener">
												<img width="1240" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/07/icon-youtube.svg?w=1240" class="attachment-social-icon-image size-social-icon-image" alt="Icon youtube" width="30" height="20" decoding="async" loading="lazy" />												<span class="screen-reader-text">Youtube</span>
											</a>
										</li>
																			<li>
											<a href="https://www.instagram.com/malwarebytesofficial" id="cta-footer-social-instagram-en" class="social socicon-instagram-v2" target="_blank" rel="noopener">
												<img width="1240" src="https://www.malwarebytes.com/wp-content/uploads/sites/2/2023/07/icon-instagram.svg?w=1240" class="attachment-social-icon-image size-social-icon-image" alt="Icon instagram" width="30" height="20" decoding="async" loading="lazy" />												<span class="screen-reader-text">Instagram</span>
											</a>
										</li>
																</ul>
													<div class="site-footer__newsletter">
															<h2>Cybersecurity info you cant live without</h2>
																						<p>Want to stay informed on the latest news in cybersecurity? Sign up for our newsletter and learn how to protect your computer from threats.</p>
															<form action="https://www.malwarebytes.com/newsletter/" class="newsletter-form">
								<div class="newsletter-form__inline">
									<label>Email Address</label>
									<input type="email" name="email" id="cta-footer-newsletter-input-email-en" placeholder="Email Address" required class="newsletter-form__email">
									<input type="hidden" class="newsletter-form__pageurl" value="https://www.malwarebytes.com/blog/news/2019/08/the-hidden-bee-infection-chain-part-1-the-stegano-pack">
									<input name="source" type="hidden" value="">
									<input type="submit" value="Sign Up" class="newsletter-form__btn" id="cta-footer-newsletter-subscribe-email-en">
								</div>
								<div class="newsletter-form__validate hidden">
									<span></span>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="site-footer__bottom">
			<div class="container">
				<div class="u-flex-columns">
					<!--Weglot 4.3.1--><aside data-wg-notranslate="" class="country-selector weglot-dropdown close_outside_click closed weglot-shortcode wg-" tabindex="0" aria-expanded="false" aria-label="Language selected: English"><ul role="none"></ul></aside>
					<div class="u-flex-column u-flex-col-lg-9 site-footer__bottom-right">
						<ul id="menu-footer-bottom-menu" class="footer-bottom-menu u-flex-center"><li id="menu-item-2936" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2936"><a href="https://www.malwarebytes.com/legal" id="cta-en-us-footernavigation-legal-_legal-click">Legal</a></li>
<li id="menu-item-2937" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2937"><a href="https://www.malwarebytes.com/legal/privacy-policy" id="cta-en-us-footernavigation-legal-_legal_privacy_policy-click">Privacy</a></li>
<li id="menu-item-2940" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2940"><a href="https://www.malwarebytes.com/tos" id="cta-en-us-footernavigation-legal-_tos-click">Terms of Service</a></li>
<li id="menu-item-2938" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2938"><a href="https://www.malwarebytes.com/accessibility" id="cta-en-us-footernavigation-legal-_accessibility-click">Accessibility</a></li>
<li id="menu-item-116900" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-116900"><a href="https://www.malwarebytes.com/impressum">Imprint</a></li>
</ul>						<p class="site-footer__copyright">
						 2025 All Rights Reserved						</p>
					</div>
				</div>
			</div>
		</div>
	</footer><!-- #colophon -->
</div><!-- #page -->
	<script id="dsq-count-scr" src="https://malwarebytesunpacked.disqus.com/count.js" async></script>
				<script>
				(function(){let request = new XMLHttpRequest();
					let url = 'ht' + 'tps:' + '//' + 'api.weglot.com/' + 'pageviews?api_key=' + 'wg_ab7feeaf115f3476db3eec82a65b414c4';
					let data = JSON.stringify({
							url: location.protocol + '//' + location.host + location.pathname,
							language: document.getElementsByTagName('html')[0].getAttribute('lang'),
							browser_language: (navigator.language || navigator.userLanguage)
						}
					);
					request.open('POST', url, true);
					request.send(data);
				})();
			</script>
				<script>!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){function e(){t.media=a}var a=t.media||"all";t.addEventListener?t.addEventListener("load",e):t.attachEvent&&t.attachEvent("onload",e),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(e,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);</script>
		<script type='text/javascript' id='rocket-browser-checker-js-after'>"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var MdBrowserCompatibilityChecker=function(){function MdBrowserCompatibilityChecker(options){_classCallCheck(this,MdBrowserCompatibilityChecker),this.passiveSupported=!1,this._checkPassiveOption(this),this.options=!!this.passiveSupported&&options}return _createClass(MdBrowserCompatibilityChecker,[{key:"_checkPassiveOption",value:function(self){try{var options={get passive(){return!(self.passiveSupported=!0)}};window.addEventListener("test",null,options),window.removeEventListener("test",null,options)}catch(err){self.passiveSupported=!1}}},{key:"initRequestIdleCallback",value:function(){!1 in window&&(window.requestIdleCallback=function(cb){var start=Date.now();return setTimeout(function(){cb({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-start))}})},1)}),!1 in window&&(window.cancelIdleCallback=function(id){return clearTimeout(id)})}},{key:"isDataSaverModeOn",value:function(){return"connection"in navigator&&!0===navigator.connection.saveData}},{key:"supportsLinkPrefetch",value:function(){var elem=document.createElement("link");return elem.relList&&elem.relList.supports&&elem.relList.supports("prefetch")&&window.IntersectionObserver&&"isIntersecting"in IntersectionObserverEntry.prototype}},{key:"isSlowConnection",value:function(){return"connection"in navigator&&"effectiveType"in navigator.connection&&("2g"===navigator.connection.effectiveType||"slow-2g"===navigator.connection.effectiveType)}}]),MdBrowserCompatibilityChecker}();</script>
		<script type="text/javascript" id="rocket-delay-js-js-after">(function() {"use strict";var e=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var t=function(){function r(e,t){n(this,r),this.attrName="data-mdlazyloadscript",this.browser=t,this.options=this.browser.options,this.triggerEvents=e,this.userEventListener=this.triggerListener.bind(this)}return e(r,[{key:"init",value:function(){this._addEventListener(this)}},{key:"reset",value:function(){this._removeEventListener(this)}},{key:"_addEventListener",value:function(t){this.triggerEvents.forEach(function(e){return window.addEventListener(e,t.userEventListener,t.options)})}},{key:"_removeEventListener",value:function(t){this.triggerEvents.forEach(function(e){return window.removeEventListener(e,t.userEventListener,t.options)})}},{key:"_loadScriptSrc",value:function(){var r=this,e=document.querySelectorAll("script["+this.attrName+"]");0!==e.length&&Array.prototype.slice.call(e).forEach(function(e){var t=e.getAttribute(r.attrName);e.setAttribute("src",t),e.removeAttribute(r.attrName)}),this.reset()}},{key:"triggerListener",value:function(){this._loadScriptSrc(),this._removeEventListener(this)}}],[{key:"run",value:function(){MdBrowserCompatibilityChecker&&new r(["keydown","mouseover","touchmove","touchstart"],new MdBrowserCompatibilityChecker({passive:!0})).init()}}]),r}();t.run();}());</script>
				<script>
		document.addEventListener("DOMContentLoaded",function(){let lazyFrames=document.querySelectorAll("iframe[data-src]");if("IntersectionObserver" in window){let lazyFrameObserver=new IntersectionObserver(function(entries,observer){entries.forEach(function(entry){if(entry.isIntersecting){let lazyFrame=entry.target;lazyFrame.src=lazyFrame.dataset.src;lazyFrameObserver.unobserve(lazyFrame)}})});lazyFrames.forEach(function(lazyFrame){lazyFrameObserver.observe(lazyFrame)})}else{lazyFrames.forEach(function(lazyFrame){lazyFrame.src=lazyFrame.dataset.src})}})
		</script>
		<style id='malware-bytes-menu-links-style-inline-css'>
.menu-links .menu-links__title,.menu-links h2{color:#0d3ecc;font-size:18px;line-height:26px;font-weight:500;margin-top:0;word-wrap:normal;word-break:normal}.menu-links .menu-links__title a,.menu-links h2 a{text-decoration:none}.menu-links .menu-links__subtitle,.menu-links h3{font-size:16px;line-height:20px;color:#082882;margin:0 0 10px;font-weight:500;letter-spacing:.2px}.menu-links ul{margin:0;padding:0;list-style-type:none}.menu-links ul li{font-weight:400;font-size:15.75px;color:#191919;margin:15px 0}.menu-links ul li img{vertical-align:middle;margin:0 3px}.menu-links ul li a{color:#191919}.menu-links ul li a:hover{color:#0d3ecc;font-weight:600;letter-spacing:-0.25px}.menu-links .menu-links__desc{margin:0 0 5px;font-size:15.25px;line-height:20px;color:#082882}.menu-links .menu-links__desc a{text-decoration:none}.menu-links .menu-links__desc img{vertical-align:middle;margin:0 3px}.menu-links.layout-2 .menu-links__desc a{font-weight:500}.menu-links .menu-links__cta a{padding-right:44px;color:#0d3ecc;font-weight:500;font-size:18px;transition:.25s ease-in-out;background:rgba(0,0,0,0) url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDQwIDE2IiBmaWxsPSIjMGQzZWNjIj4KICAgIDxwYXRoCiAgICAgICAgZD0iTTM3LjE5MDE4MjMsNi42NTMxMjEwMyBMMi42MTEzOTgwOSw2LjUyMTIzMjM2IEw4LjIzMzM4OTc2LDEuMjIyNDY4MzMgQzguNTMwMTk2NjQsMC45NDI5NTk4MzYgOC41MzAxOTY2NCwwLjQ4OTMxNTMyNSA4LjIzMzM4OTc2LDAuMjA5ODA2ODI3IEM3LjkzNjU4Mjg3LC0wLjA2OTkzNTYwOSA3LjQ1NTc1NzE0LC0wLjA2OTkzNTYwOSA3LjE1ODk1NTMyLDAuMjA5ODA2ODI3IEwwLjMyMjU5MDE5MSw2LjY1MzEyMTAzIEMwLjEyNzkzMzgyNyw2Ljc4Mjc5NDQ1IDAsNi45OTU1NzMyNCAwLDcuMjM3MzY5OTQgQzAsNy4yNDEwNDEzNCAwLjAwMTA4NDAxMzI3LDcuMjQ0NDUwMTUgMC4wMDExNDQ3OTkwNiw3LjI0ODEyMTU1IEMwLjAwMTA1MzYyMDM3LDcuMjU1OTYwODcgMC4wMDM0MDQwMDQyOCw3LjI2MzM2MDk2IDAuMDAzNjE2NzU0NTQsNy4yNzEyMDAyOCBDMC4wMDcxNDIzMzA0LDcuMzQxMjI0MjEgMC4wMjE2MDkzNDg2LDcuNDA4MDM5ODQgMC4wNDQ5NTEwOTIyLDcuNDcxMzg5MzggQzAuMDU4NjQ4MTU3LDcuNTExNjAyODkgMC4wNzgzNDI3NTMyLDcuNTQ3ODgyNDIgMC4wOTk3Njk3NDQ0LDcuNTg1NzYxMzIgQzAuMTE4OTY3OTIzLDcuNjE3OTMwMjIgMC4xNDAyNDI5NSw3LjY0ODM4MDM5IDAuMTY0MjYzNDY4LDcuNjc3MjU5ODMgQzAuMTg1NjYwMDY3LDcuNzA0MDk1ODkgMC4xOTY2NjIyOTUsNy43MzU1OTY0IDAuMjIyNjAyNjMxLDcuNzYwMDE2NjkgTDcuMjA5MTU5MzEsMTQuMzQ0ODkyMiBDNy4zNTc1NjI3NiwxNC40ODQ3NjM0IDcuNTUxOTcwOTEsMTQuNTU0Njk2NiA3Ljc0NjM3OTA3LDE0LjU1NDY5NjYgQzcuOTQwNzg3MjIsMTQuNTU0Njk2NiA4LjEzNTE5NTM4LDE0LjQ4NDc2MzQgOC4yODM1OTg4MiwxNC4zNDQ4OTIyIEM4LjU4MDQwNTcsMTQuMDY1MTQ5OCA4LjU4MDQwNTcsMTMuNjExOTY4MyA4LjI4MzU5ODgyLDEzLjMzMjIzMDcgTDIuNTc2NzcwNDUsNy45NTM1MDc1MiBMMzcuMTkwMTgyMyw3Ljk1MzUwNzUyIEMzNy42MDk2NjUsNy45NTM1MDc1MiAzOCw3LjY3Mjk0NzQ5IDM4LDcuMjc3MzQ4MzIgQzM4LDYuODgxNzQ5MTQgMzcuNjA5NjY1LDYuNjUzMTIxMDMgMzcuMTkwMTgyMyw2LjY1MzEyMTAzIFoiCiAgICAgICAgaWQ9IlBhdGgxIiBzdHJva2Utd2lkdGg9IjAuNSIgZmlsbC1ydWxlPSJub256ZXJvIgogICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE5LjAwMDAwMCwgNy4yNzczNDgpIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwLjAwMDAwMCwgLTcuMjc3MzQ4KSI+CiAgICA8L3BhdGg+Cjwvc3ZnPg==) right 6px center no-repeat;background-size:30px;text-decoration:none}.menu-links .menu-links__cta a:hover{background-position:right 0 center}.menu-links.has-item-border .menu-links__item:not(:first-child){margin:10px 0 0;padding:10px 0 0;border-top:1px solid #d3d9e9}.menu-links.has-item-border .menu-links__item .menu-links__title+.menu-links__cta{margin-top:32px}.menu-links.layout-1.has-item-border .menu-links__item:not(:first-child){margin:20px 0 0;padding:20px 0 0}.menu-links.layout-2.has-item-border .menu-links__item:not(:first-child){margin:20px 0 0;padding:20px 0 0}.menu-links.layout-3 .menu-links__item:not(:first-child){margin:20px 0 0;padding:20px 0 0}.menu-links.layout-3.has-item-border .menu-links__item:not(:first-child){margin:25px 0 0;padding:25px 0 0}.menu-links.with-svg .menu-links__item{margin:20px 0 0;padding:20px 0 20px;border-top:1px solid #d3d9e9}.menu-links.with-svg .menu-links__desc a{font-weight:500}.menu-links.with-svg .menu-links__desc a svg{vertical-align:middle;margin:0 3px}@media (max-width: 1149px){.menu-links .menu-links__title,.menu-links h2{font-size:18px}}

</style>
<style id='wp-block-group-inline-css'>
.wp-block-group{box-sizing:border-box}:where(.wp-block-group.wp-block-group-is-layout-constrained){position:relative}
</style>
<style id='wp-block-group-theme-inline-css'>
:where(.wp-block-group.has-background){padding:1.25em 2.375em}
</style>
<style id='wp-block-columns-inline-css'>
.wp-block-columns{align-items:normal!important;box-sizing:border-box;display:flex;flex-wrap:wrap!important}@media (min-width:782px){.wp-block-columns{flex-wrap:nowrap!important}}.wp-block-columns.are-vertically-aligned-top{align-items:flex-start}.wp-block-columns.are-vertically-aligned-center{align-items:center}.wp-block-columns.are-vertically-aligned-bottom{align-items:flex-end}@media (max-width:781px){.wp-block-columns:not(.is-not-stacked-on-mobile)>.wp-block-column{flex-basis:100%!important}}@media (min-width:782px){.wp-block-columns:not(.is-not-stacked-on-mobile)>.wp-block-column{flex-basis:0;flex-grow:1}.wp-block-columns:not(.is-not-stacked-on-mobile)>.wp-block-column[style*=flex-basis]{flex-grow:0}}.wp-block-columns.is-not-stacked-on-mobile{flex-wrap:nowrap!important}.wp-block-columns.is-not-stacked-on-mobile>.wp-block-column{flex-basis:0;flex-grow:1}.wp-block-columns.is-not-stacked-on-mobile>.wp-block-column[style*=flex-basis]{flex-grow:0}:where(.wp-block-columns){margin-bottom:1.75em}:where(.wp-block-columns.has-background){padding:1.25em 2.375em}.wp-block-column{flex-grow:1;min-width:0;overflow-wrap:break-word;word-break:break-word}.wp-block-column.is-vertically-aligned-top{align-self:flex-start}.wp-block-column.is-vertically-aligned-center{align-self:center}.wp-block-column.is-vertically-aligned-bottom{align-self:flex-end}.wp-block-column.is-vertically-aligned-stretch{align-self:stretch}.wp-block-column.is-vertically-aligned-bottom,.wp-block-column.is-vertically-aligned-center,.wp-block-column.is-vertically-aligned-top{width:100%}
</style>
<style id='malware-bytes-inner-header-style-inline-css'>
.labs-sub-nav{padding:15px 0;background-color:#f1f8ff}.labs-sub-nav__row{display:flex;justify-content:space-between}.labs-sub-nav__colum.left{width:50%}.labs-sub-nav__colum.left .search-form{background-color:rgba(0,0,0,0)}.labs-sub-nav__colum.right{display:flex;flex-wrap:wrap;align-items:center}.labs-sub-nav__colum.right .subscribe-rss-wrp{display:flex;padding:0 12px;align-items:center}.labs-sub-nav__colum.right .subscribe-rss-wrp .subscribe-btn{border-radius:4px;background-color:#0d3ecc;color:#fff;height:50px;display:inline-block;padding:14px;font-weight:500;text-decoration:none;margin-right:15px}.labs-sub-nav__colum.right .subscribe-rss-wrp a{display:inline-block}.labs-sub-nav__colum.right .social-wrp{display:flex;padding:0 12px;gap:20px;align-items:center}.labs-sub-nav__colum.right .social-wrp a{display:block}.labs-sub-nav__searchbar-wrap{position:relative;width:100%;background-color:rgba(0,0,0,0)}.labs-sub-nav__search-input[type=text]{border:none;background-color:#fff;height:48px;width:100%;padding-left:20px;padding-right:62px;font-weight:700;max-width:277px}.labs-sub-nav__search-button{position:absolute;right:20px;top:0px;margin:0;border:none;cursor:pointer;border-radius:26px;background-color:rgba(0,0,0,0);width:75px;display:flex;justify-content:center;align-items:center;height:48px}@media (min-width: 992px){.labs-sub-nav__colum.left{width:33.3333333333%}}@media (max-width: 1149px){.labs-sub-nav{margin-top:30px}}@media (max-width: 767px){.labs-sub-nav{margin-bottom:30px}.labs-sub-nav__row{flex-wrap:wrap}.labs-sub-nav__colum.left{width:100%;margin-bottom:10px}.labs-sub-nav__colum.right .subscribe-rss-wrp{padding:0}.labs-sub-nav__colum.right .social-wrp{gap:15px}.labs-sub-nav__search-input[type=text]{max-width:100%}.labs-sub-nav__search-button{right:10px}}

</style>
<style id='global-styles-inline-css'>
:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--color--blue: #0D3ECC;--wp--preset--color--navy-blue: #1C284C;--wp--preset--color--secondary-black: #191919;--wp--preset--color--dark-blue: #082882;--wp--preset--color--sky-blue: #009DEB;--wp--preset--color--baby-blue: #8DCFFD;--wp--preset--color--yellow: #EFC148;--wp--preset--color--pink: #E74488;--wp--preset--color--ruby: #A02A5C;--wp--preset--color--charcoal: #3D3D3D;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:root { --wp--style--global--content-size: 1200px;--wp--style--global--wide-size: 1200px; }:where(body) { margin: 0; }.wp-site-blocks { padding-top: var(--wp--style--root--padding-top); padding-bottom: var(--wp--style--root--padding-bottom); }.has-global-padding { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding > .alignfull { margin-right: calc(var(--wp--style--root--padding-right) * -1); margin-left: calc(var(--wp--style--root--padding-left) * -1); }.has-global-padding :where(:not(.alignfull.is-layout-flow) > .has-global-padding:not(.wp-block-block, .alignfull)) { padding-right: 0; padding-left: 0; }.has-global-padding :where(:not(.alignfull.is-layout-flow) > .has-global-padding:not(.wp-block-block, .alignfull)) > .alignfull { margin-left: 0; margin-right: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.wp-site-blocks) > * { margin-block-start: 24px; margin-block-end: 0; }:where(.wp-site-blocks) > :first-child { margin-block-start: 0; }:where(.wp-site-blocks) > :last-child { margin-block-end: 0; }:root { --wp--style--block-gap: 24px; }:root :where(.is-layout-flow) > :first-child{margin-block-start: 0;}:root :where(.is-layout-flow) > :last-child{margin-block-end: 0;}:root :where(.is-layout-flow) > *{margin-block-start: 24px;margin-block-end: 0;}:root :where(.is-layout-constrained) > :first-child{margin-block-start: 0;}:root :where(.is-layout-constrained) > :last-child{margin-block-end: 0;}:root :where(.is-layout-constrained) > *{margin-block-start: 24px;margin-block-end: 0;}:root :where(.is-layout-flex){gap: 24px;}:root :where(.is-layout-grid){gap: 24px;}.is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}.is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}.is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}.is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}.is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}.is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}.is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}.is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}body{--wp--style--root--padding-top: 0px;--wp--style--root--padding-right: 0px;--wp--style--root--padding-bottom: 0px;--wp--style--root--padding-left: 0px;}a:where(:not(.wp-element-button)){text-decoration: underline;}:root :where(.wp-element-button, .wp-block-button__link){background-color: #32373c;border-width: 0;color: #fff;font-family: inherit;font-size: inherit;line-height: inherit;padding: calc(0.667em + 2px) calc(1.333em + 2px);text-decoration: none;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-blue-color{color: var(--wp--preset--color--blue) !important;}.has-navy-blue-color{color: var(--wp--preset--color--navy-blue) !important;}.has-secondary-black-color{color: var(--wp--preset--color--secondary-black) !important;}.has-dark-blue-color{color: var(--wp--preset--color--dark-blue) !important;}.has-sky-blue-color{color: var(--wp--preset--color--sky-blue) !important;}.has-baby-blue-color{color: var(--wp--preset--color--baby-blue) !important;}.has-yellow-color{color: var(--wp--preset--color--yellow) !important;}.has-pink-color{color: var(--wp--preset--color--pink) !important;}.has-ruby-color{color: var(--wp--preset--color--ruby) !important;}.has-charcoal-color{color: var(--wp--preset--color--charcoal) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-blue-background-color{background-color: var(--wp--preset--color--blue) !important;}.has-navy-blue-background-color{background-color: var(--wp--preset--color--navy-blue) !important;}.has-secondary-black-background-color{background-color: var(--wp--preset--color--secondary-black) !important;}.has-dark-blue-background-color{background-color: var(--wp--preset--color--dark-blue) !important;}.has-sky-blue-background-color{background-color: var(--wp--preset--color--sky-blue) !important;}.has-baby-blue-background-color{background-color: var(--wp--preset--color--baby-blue) !important;}.has-yellow-background-color{background-color: var(--wp--preset--color--yellow) !important;}.has-pink-background-color{background-color: var(--wp--preset--color--pink) !important;}.has-ruby-background-color{background-color: var(--wp--preset--color--ruby) !important;}.has-charcoal-background-color{background-color: var(--wp--preset--color--charcoal) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-blue-border-color{border-color: var(--wp--preset--color--blue) !important;}.has-navy-blue-border-color{border-color: var(--wp--preset--color--navy-blue) !important;}.has-secondary-black-border-color{border-color: var(--wp--preset--color--secondary-black) !important;}.has-dark-blue-border-color{border-color: var(--wp--preset--color--dark-blue) !important;}.has-sky-blue-border-color{border-color: var(--wp--preset--color--sky-blue) !important;}.has-baby-blue-border-color{border-color: var(--wp--preset--color--baby-blue) !important;}.has-yellow-border-color{border-color: var(--wp--preset--color--yellow) !important;}.has-pink-border-color{border-color: var(--wp--preset--color--pink) !important;}.has-ruby-border-color{border-color: var(--wp--preset--color--ruby) !important;}.has-charcoal-border-color{border-color: var(--wp--preset--color--charcoal) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
</style>
<style id='core-block-supports-inline-css'>
.wp-container-core-group-is-layout-1{flex-direction:column;align-items:stretch;}.wp-container-core-group-is-layout-2{flex-direction:column;align-items:stretch;}.wp-container-core-group-is-layout-3{flex-direction:column;align-items:stretch;}.wp-container-core-columns-is-layout-1{flex-wrap:nowrap;}.wp-container-core-columns-is-layout-2{flex-wrap:nowrap;}.wp-container-core-columns-is-layout-3{flex-wrap:nowrap;}.wp-container-core-columns-is-layout-4{flex-wrap:nowrap;}.wp-container-core-columns-is-layout-5{flex-wrap:nowrap;}.wp-container-core-columns-is-layout-6{flex-wrap:nowrap;}.wp-container-core-columns-is-layout-7{flex-wrap:nowrap;}.wp-container-core-group-is-layout-4 > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width:900px;margin-left:auto !important;margin-right:auto !important;}.wp-container-core-group-is-layout-4 > .alignwide{max-width:900px;}.wp-container-core-group-is-layout-4 .alignfull{max-width:none;}.wp-container-core-group-is-layout-4 > .alignfull{margin-right:calc(var(--wp--preset--spacing--70) * -1);margin-left:calc(var(--wp--preset--spacing--70) * -1);}
</style>
<script src="https://www.malwarebytes.com/wp-includes/js/jquery/jquery.min.js?ver=1.0" id="jquery-js"></script>
<script id="geot-js-js-extra">
var geot = {"ajax_url":"https:\/\/www.malwarebytes.com\/wp-admin\/admin-ajax.php","ajax":"","pid":"74941","is_archive":"","is_search":"","is_singular":"1","is_front_page":"","is_category":"","is_page":"","is_single":"1","disable_remove_on_singular":"","is_builder":"","has_geo_posts":"1","dropdown_search":"","dropdown_redirect":"","elementor_popup":"1","hide_class":"","hide_override_class":"","remove_class":"","remove_override_class":"","disable_console":"","geoloc_enable":"by_ip","geoloc_force":"","geoloc_fail":"Geolocation is not supported by this browser","geot_cookies_duration":"999"};
</script>
<script id="main-js-js-extra">
var siteConfig = {"ajaxUrl":"https:\/\/www.malwarebytes.com\/wp-admin\/admin-ajax.php","ajax_nonce":"4c077d077d","pwnedAPI":"https:\/\/www.malwarebytes.com\/wp-json\/wp\/v2\/api\/aws\/have-i-been-pwned\/","eventAPI":"https:\/\/www.malwarebytes.com\/wp-json\/wp\/v2\/api\/analytics\/event\/","newsletterAPI":"https:\/\/www.malwarebytes.com\/wp-json\/wp\/v2\/api\/iterable\/newsletter\/","newsletterSuccess":"https:\/\/www.malwarebytes.com\/en\/thank_you\/","newsletterError":"https:\/\/www.malwarebytes.com\/en\/newsletter_error\/","homeURL":"https:\/\/www.malwarebytes.com","request":"blog\/news\/2019\/08\/the-hidden-bee-infection-chain-part-1-the-stegano-pack"};
var global_variables = {"when":"7\/3\/2023 2:14:31 PM","site":{"language":"en","country":"us","origin":"https:\/\/www.malwarebytes.com","phoneNumbers":{"US":{"view":"+1-800-520-2796","call":"18005202796"},"GB":{"view":"+44 (800) 368-8486","call":"448003688486"},"FR":{"view":"+33 (800) 909-009","call":"33800909009"},"ES":{"view":"+34 (900) 823-509","call":"34900823509"},"DE":{"view":"+49 (800) 723-4800","call":"498007234800"},"IT":{"view":"+39 (800) 972-511","call":"39800972511"},"SG":{"view":"+65 6813-2150","call":"6568132150"},"AU":{"view":"1800-745-824","call":"1800745824"},"NZ":{"view":"0800-446-541","call":"0800446541"}},"endpoints":{"carts":{"lira":"https:\/\/ecom.malwarebytes.com","onepay":"https:\/\/buy.malwarebytes.com"}},"downloadLinks":{"vpn":{"mac":"https:\/\/downloads.malwarebytes.com\/file\/mbprivacy-mac","windows":"https:\/\/downloads.malwarebytes.com\/file\/mbprivacy-online","ios":"https:\/\/apps.apple.com\/us\/app\/malwarebytes-privacy-vpn\/id1504101226","android":"https:\/\/play.google.com\/store\/apps\/details?id=org.malwarebytes.harpocrates"},"free":{"mac":"https:\/\/www.malwarebytes.com\/mac-download","windows":"https:\/\/www.malwarebytes.com\/mwb-download\/thankyou","ios":"https:\/\/apps.apple.com\/US\/app\/id1327105431?mt=8","android":"https:\/\/play.google.com\/store\/apps\/details?id=org.malwarebytes.antimalware"}},"apiHostname":"https:\/\/www-api.malwarebytes.com","liraCartLinkEndpoint":"https:\/\/ecom.malwarebytes.com"}};
</script>
<script type="text/javascript" src="https://www.malwarebytes.com/_static/??-eJyVjMEOwjAMQ3+ILZqEtF0Q39KWqKRKs2pJVcHXE8EFccM3+9mG0aa0i6EYNO6ZRCHjbuHIaCR5NGg9MiUoX2D6ZHPRE/xzUElAkTEZPXF29/tgd6zovcAjHBgf5iaooinETnxz8h5d62VZz8u2ra7yAlmcSeQ="  defer></script><script defer src="https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/main-vwo-personalization-threatdown.js?ver=1.4" id="vwo-personalization-threatdown-js"></script>
<script type="text/javascript" src="https://www.malwarebytes.com/_static/??-eJyVjFEKg0AMBS9UG4SC/pSeJa6vNrqbyCYi7em7V/D9PZgZOvcumQY0KD4ocCqcT66YvtEOuyOcvCZanZCsFNQEOkKyhDQimW2C++o3utTaUd2Us/w4xLShdUOILl3isrMs6hei0yF5pncFutlOzcZzs1/l2Q+PfhyHtvUPM5xZUg=="  defer></script><script defer src="https://stats.wp.com/e-202511.js" id="jetpack-stats-js" data-wp-strategy="defer"></script>
<script id="jetpack-stats-js-after">
_stq = window._stq || [];
_stq.push([ "view", JSON.parse("{\"v\":\"ext\",\"blog\":\"227197325\",\"post\":\"74941\",\"tz\":\"-7\",\"srv\":\"www.malwarebytes.com\",\"hp\":\"vip\",\"j\":\"1:14.3\"}") ]);
_stq.push([ "clickTrackerInit", "227197325", "74941" ]);
</script>
		<script type="text/javascript" id="flying-scripts">const loadScriptsTimer = setTimeout(loadScripts,5* 1000
			)
			;const userInteractionEvents = ["mouseover", "keydown", "touchstart", "touchmove", "wheel"];
			userInteractionEvents.forEach(function (event) {
				window.addEventListener(event, triggerScriptLoader, {passive: !0})
			});

			function triggerScriptLoader() {
				loadScripts();
				clearTimeout(loadScriptsTimer);
				userInteractionEvents.forEach(function (event) {
					window.removeEventListener(event, triggerScriptLoader, {passive: !0})
				})
			}

			function loadScripts() {
				document.querySelectorAll("script[data-type='lazy']").forEach(function (elem) {
					elem.setAttribute("src", elem.getAttribute("data-src"))
				})
			}</script>
		<!--Weglot 4.3.1--><aside data-wg-notranslate="" class="country-selector weglot-dropdown close_outside_click closed weglot-default wg-" tabindex="0" aria-expanded="false" aria-label="Language selected: English"><ul role="none"></ul></aside> </body>
</html>
