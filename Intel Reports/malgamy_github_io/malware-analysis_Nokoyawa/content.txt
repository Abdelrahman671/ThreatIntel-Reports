<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Detect Nokoyawa ransomware With YARA Rule. - MalGamy</title>
<meta name="description" content="How to write Yara rule for Nokoyawa ransomware  ">


  <meta name="author" content="Gameel Ali">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="MalGamy">
<meta property="og:title" content="Detect Nokoyawa ransomware With YARA Rule.">
<meta property="og:url" content="https://malgamy.github.io/malware-analysis/Nokoyawa/">


  <meta property="og:description" content="How to write Yara rule for Nokoyawa ransomware  ">







  <meta property="article:published_time" content="2022-12-21T00:00:00+00:00">





  

  


<link rel="canonical" href="https://malgamy.github.io/malware-analysis/Nokoyawa/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Gameel Ali",
      "url": "https://malgamy.github.io/"
    
  }
</script>


  <meta name="google-site-verification" content="J3MnMF94zaZhTUoNtUiRt9cKsr7hiMyTxEdAvQ3GfmY" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="MalGamy Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/img/cover.jpg" alt=""></a>
        
        <a class="site-title" href="/">
          MalGamy
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#revese-enginnering">Revese Enginnering</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#ctf-writeups">CTF Writeups</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#tutorials">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/img/cover.jpg" alt="Gameel Ali" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Gameel Ali</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware analysis &amp; Reverse engineering</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="gameelaa29@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
            <li><a href="https://twitter.com/GameelA63457659" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/gameel-ali-8041161bb/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/MalGamy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Detect Nokoyawa ransomware With YARA Rule.">
    <meta itemprop="description" content="How to write Yara rule for Nokoyawa ransomware">
    <meta itemprop="datePublished" content="2022-12-21T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Detect Nokoyawa ransomware With YARA Rule.
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              

            </nav>
          </aside>
        
        <h4 id="how-to-write-yara-rule-for-nokoyawa-ransomware">How to write Yara rule for Nokoyawa ransomware</h4>

<ul>
  <li>In the frist, we will work with 3 files that shared by
<a href="https://www.zscaler.com/blogs/security-research/nokoyawa-ransomware-rust-or-bust">zscaler</a></li>
</ul>

<h4 id="introduction">Introduction</h4>

<p>Nokoyawa is a ransomware family that targets 64-bit Windows systems. It
was first identified in February 2022 and is known for its use of double
extortion tactics, which involve exfiltrating sensitive data from
targeted organizations before encrypting files and demanding a ransom
payment. The initial version of Nokoyawa was written in C programming
language and used Elliptic Curve Cryptography (ECC) with SECT233R1 and
Salsa20 for file encryption. In September 2022, a revised version of
Nokoyawa was released, which was rewritten in Rust programming language
and utilized ECC with Curve25519 and Salsa20 for file encryption. This
new version, known as Nokoyama 2.0, includes a configuration parameter
that can be passed via the command-line, providing threat actors with
greater flexibility at runtime.</p>

<h4 id="iocs">IOCs</h4>

<ul>
  <li><a href="https://www.virustotal.com/gui/file/7095beafff5837070a89407c1bf3c6acf8221ed786e0697f6c578d4c3de0efd6">7095beafff5837070a89407c1bf3c6acf8221ed786e0697f6c578d4c3de0efd6</a></li>
  <li><a href="https://www.virustotal.com/gui/file/47c00ac29bbaee921496ef957adaf5f8b031121ef0607937b003b6ab2a895a12">47c00ac29bbaee921496ef957adaf5f8b031121ef0607937b003b6ab2a895a12</a></li>
  <li><a href="https://www.virustotal.com/gui/file/259f9ec10642442667a40bf78f03af2fc6d653443cce7062636eb750331657c4">259f9ec10642442667a40bf78f03af2fc6d653443cce7062636eb750331657c4</a></li>
</ul>

<h4 id="loading-sample-with-ida-pro">Loading sample with IDA pro</h4>

<p>I manually write Yara rules by using IDA Pro to load samples and examine
their strings for unique characteristics relevant to a specific family.
From this analysis, I can use the identified strings to craft effective
Yara rules.</p>

<h5 id="strings-with-ida">Strings with IDA</h5>

<p><img src="https://user-images.githubusercontent.com/74544712/208954332-9d4f9356-59d1-4476-b042-46928d80f4cc.PNG" alt="yara" /></p>

<ul>
  <li>“deps\noko.pdb”</li>
  <li>“How to run:”</li>
  <li>”–config <base64 encoded="" config=""> (to start full encryption)"</base64></li>
  <li>”–config <base64 encoded="" config=""> --file <filePath>"</filePath></base64></li>
  <li>“CIS lang detected! Stop working”</li>
  <li>“config isn’t configurated to load hidden drives”</li>
  <li>“ENCRYPT_NETWORKYour config isn’t configurated to encrypt network
shares”</li>
  <li>“Your config isn’t configurated to delete shadow copies”</li>
  <li>“Successfully deleted shadow copies”</li>
</ul>

<p>By analyzing strings of malware, we can extract relevant strings and use
VirusTotal (if you have a premium account) to test them individually in
order to select appropriate conditions for our rules</p>

<p>We can detect that the file “deps\noko.pdb” will be present in all
samples because it is a member of the family of pdb files.</p>

<p><img src="https://user-images.githubusercontent.com/74544712/208955279-174a42c3-7b44-45c4-ad09-12c6da6be785.PNG" alt="yara1" /></p>

<ul>
  <li>PDB stands for “Program Database,” and it is a file format used by
Microsoft Visual Studio to store debugging information about a
program. It contains information about the program’s code, data, and
resources, as well as details about the program’s execution. PDB
files are typically used by developers to debug their programs and
fix errors. They can also be used by other tools, such as debugger
programs, to analyze the code and execution of a program. PDB files
are often associated with the .exe file of a program, and they are
typically stored in a separate directory or folder.</li>
  <li>We can use the PDB as a condition for detecting the presence of the
Nokoyawa family in a sample. If the Yara scan identifies PDB in the
sample, it will be identified as belonging to the Nokoyawa family.</li>
</ul>

<p>After testing each string individually, we discovered that the first
four strings were present in three samples, while the remaining strings
were present in only one sample. Based on this information, we can
conclude that the first three strings are except to the PDB string, and
can therefore be used to detect the presence of the three samples.
Therefore, our condition will be as follows: <code class="language-plaintext highlighter-rouge">uint16(0) == 0x5A4D and
($pdb or 3 of ($s*))</code></p>

<h4 id="our-yara-rule"><a href="https://github.com/MalGamy/YARA_Rules/blob/main/Nokoyawa.yara">Our YARA rule</a></h4>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">rule</span> <span class="nt">Nokoyawa_ransomware</span><span class="o">:</span> <span class="nt">Nokoyawa</span>
<span class="p">{</span>
    <span class="py">meta</span><span class="p">:</span>
    <span class="n">description</span> <span class="err">=</span> <span class="s1">"Detect_Nokoyawa_ransomware"</span>
    <span class="n">author</span> <span class="err">=</span> <span class="s1">"@malgamy12"</span>
    <span class="n">date</span> <span class="err">=</span> <span class="s1">"20/12/2022"</span>
    <span class="n">license</span> <span class="err">=</span> <span class="s1">"DRL 1.1"</span>
        <span class="n">hash</span> <span class="err">=</span> <span class="s1">"7095beafff5837070a89407c1bf3c6acf8221ed786e0697f6c578d4c3de0efd6"</span>
        <span class="n">hash</span> <span class="err">=</span> <span class="s1">"47c00ac29bbaee921496ef957adaf5f8b031121ef0607937b003b6ab2a895a12"</span>
        <span class="n">hash</span> <span class="err">=</span> <span class="s1">"259f9ec10642442667a40bf78f03af2fc6d653443cce7062636eb750331657c4"</span>
  
                
    <span class="n">strings</span><span class="p">:</span>
        
        <span class="err">$</span><span class="n">pdb</span> <span class="err">=</span> <span class="s1">"deps\\noko.pdb"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s1</span> <span class="err">=</span> <span class="s1">"How to run:"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s2</span> <span class="err">=</span> <span class="s1">"--config &lt;base64 encoded config&gt; (to start full encryption)"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s3</span> <span class="err">=</span> <span class="s1">"--config &lt;base64 encoded config&gt; --file &lt;filePath&gt;"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s4</span> <span class="err">=</span> <span class="s1">"CIS lang detected! Stop working"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s5</span> <span class="err">=</span> <span class="s1">"config isn't configurated to load hidden drives"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s6</span> <span class="err">=</span> <span class="s1">"ENCRYPT_NETWORKYour config isn't configurated to encrypt network shares"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s7</span> <span class="err">=</span> <span class="s1">"Your config isn't configurated to delete shadow copies"</span> <span class="n">ascii</span>
        <span class="err">$</span><span class="n">s8</span> <span class="err">=</span> <span class="s1">"Successfully deleted shadow copies from"</span> <span class="n">ascii</span>
        
    <span class="n">condition</span><span class="p">:</span>
        <span class="n">uint16</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="err">==</span> <span class="m">0</span><span class="n">x5A4D</span> <span class="n">and</span> <span class="p">(</span><span class="err">$</span><span class="n">pdb</span> <span class="n">or</span> <span class="m">3</span> <span class="n">of</span> <span class="p">(</span><span class="err">$</span><span class="n">s</span><span class="err">*</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="testing">Testing</h4>

<p><img src="https://user-images.githubusercontent.com/74544712/208954747-089149c0-57f9-46df-9bba-d88ea4b60728.PNG" alt="yara2" /></p>

<p>As depicted in the preceding figure, it appears that our condition is
functioning as intended. After conducting testing, we can confidently
assert that our rules are effective on our sample set.</p>

<h4 id="hunting"><a href="https://www.hybrid-analysis.com/yara-search">Hunting</a></h4>

<p><img src="https://user-images.githubusercontent.com/74544712/208954817-b7ac3e9c-7018-4850-8ad1-6b79664712a3.PNG" alt="yara3" /></p>

<p>From the previous figure, we can see the results of our rules</p>

<p><img src="https://user-images.githubusercontent.com/74544712/208954973-bd9eb1cb-8101-405a-8cd5-dcdd7ef7475f.PNG" alt="yara4" /></p>

<p>Thanks a lot for reading. You can find me into the following links</p>

<ul>
  <li><a href="https://twitter.com/MalGamy12">Twitter</a></li>
  <li><a href="https://www.linkedin.com/in/gameel-ali-8041161bb/">Linkedin</a></li>
  <li><a href="https://www.youtube.com/channel/UCdhYL47wLxxKOyaRsk4Moaw">Youtube</a></li>
  <li><a href="https://github.com/MalGamy">Github</a></li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware-Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-12-21T00:00:00+00:00">December 21, 2022</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/malware-analysis/YARA_Surtr_Ransomware/" class="pagination--pager" title="Detect Surtr Ransomware With YARA Rule.
">Previous</a>
    
    
      <a href="/malware-analysis/The-Approach-of-TA413-for-Tibetan-Targets/" class="pagination--pager" title="The Approach of TA413 for Tibetan Targets
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Gameel Ali. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-165194559-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>









  </body>
</html>
